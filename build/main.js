//     Underscore.js 1.4.4
//     http://underscorejs.org
//     (c) 2009-2013 Jeremy Ashkenas, DocumentCloud Inc.
//     Underscore may be freely distributed under the MIT license.

//     (c) 2010-2013 Jeremy Ashkenas, DocumentCloud Inc.
//     Backbone may be freely distributed under the MIT license.
//     For all details and documentation:
//     http://backbonejs.org

/**
 * @license RequireJS text 2.0.3 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */

/*
	Redactor v9.1.8
	Updated: Nov 20, 2013

	http://imperavi.com/redactor/

	Copyright (c) 2009-2013, Imperavi LLC.
	License: http://imperavi.com/redactor/license/

	Usage: $('#content').redactor();
*/

(function(){var e=this,t=e._,n={},r=Array.prototype,i=Object.prototype,s=Function.prototype,o=r.push,u=r.slice,a=r.concat,f=i.toString,l=i.hasOwnProperty,c=r.forEach,h=r.map,p=r.reduce,d=r.reduceRight,v=r.filter,m=r.every,g=r.some,y=r.indexOf,b=r.lastIndexOf,w=Array.isArray,E=Object.keys,S=s.bind,x=function(e){return e instanceof x?e:this instanceof x?(this._wrapped=e,void 0):new x(e)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=x),exports._=x):e._=x,x.VERSION="1.4.4";var T=x.each=x.forEach=function(e,t,r){if(null!=e)if(c&&e.forEach===c)e.forEach(t,r);else if(e.length===+e.length){for(var i=0,s=e.length;s>i;i++)if(t.call(r,e[i],i,e)===n)return}else for(var o in e)if(x.has(e,o)&&t.call(r,e[o],o,e)===n)return};x.map=x.collect=function(e,t,n){var r=[];return null==e?r:h&&e.map===h?e.map(t,n):(T(e,function(e,i,s){r[r.length]=t.call(n,e,i,s)}),r)};var N="Reduce of empty array with no initial value";x.reduce=x.foldl=x.inject=function(e,t,n,r){var i=arguments.length>2;if(null==e&&(e=[]),p&&e.reduce===p)return r&&(t=x.bind(t,r)),i?e.reduce(t,n):e.reduce(t);if(T(e,function(e,s,o){i?n=t.call(r,n,e,s,o):(n=e,i=!0)}),!i)throw new TypeError(N);return n},x.reduceRight=x.foldr=function(e,t,n,r){var i=arguments.length>2;if(null==e&&(e=[]),d&&e.reduceRight===d)return r&&(t=x.bind(t,r)),i?e.reduceRight(t,n):e.reduceRight(t);var s=e.length;if(s!==+s){var o=x.keys(e);s=o.length}if(T(e,function(u,a,f){a=o?o[--s]:--s,i?n=t.call(r,n,e[a],a,f):(n=e[a],i=!0)}),!i)throw new TypeError(N);return n},x.find=x.detect=function(e,t,n){var r;return C(e,function(e,i,s){return t.call(n,e,i,s)?(r=e,!0):void 0}),r},x.filter=x.select=function(e,t,n){var r=[];return null==e?r:v&&e.filter===v?e.filter(t,n):(T(e,function(e,i,s){t.call(n,e,i,s)&&(r[r.length]=e)}),r)},x.reject=function(e,t,n){return x.filter(e,function(e,r,i){return!t.call(n,e,r,i)},n)},x.every=x.all=function(e,t,r){t||(t=x.identity);var i=!0;return null==e?i:m&&e.every===m?e.every(t,r):(T(e,function(e,s,o){return(i=i&&t.call(r,e,s,o))?void 0:n}),!!i)};var C=x.some=x.any=function(e,t,r){t||(t=x.identity);var i=!1;return null==e?i:g&&e.some===g?e.some(t,r):(T(e,function(e,s,o){return i||(i=t.call(r,e,s,o))?n:void 0}),!!i)};x.contains=x.include=function(e,t){return null==e?!1:y&&e.indexOf===y?e.indexOf(t)!=-1:C(e,function(e){return e===t})},x.invoke=function(e,t){var n=u.call(arguments,2),r=x.isFunction(t);return x.map(e,function(e){return(r?t:e[t]).apply(e,n)})},x.pluck=function(e,t){return x.map(e,function(e){return e[t]})},x.where=function(e,t,n){return x.isEmpty(t)?n?null:[]:x[n?"find":"filter"](e,function(e){for(var n in t)if(t[n]!==e[n])return!1;return!0})},x.findWhere=function(e,t){return x.where(e,t,!0)},x.max=function(e,t,n){if(!t&&x.isArray(e)&&e[0]===+e[0]&&65535>e.length)return Math.max.apply(Math,e);if(!t&&x.isEmpty(e))return-1/0;var r={computed:-1/0,value:-1/0};return T(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o>=r.computed&&(r={value:e,computed:o})}),r.value},x.min=function(e,t,n){if(!t&&x.isArray(e)&&e[0]===+e[0]&&65535>e.length)return Math.min.apply(Math,e);if(!t&&x.isEmpty(e))return 1/0;var r={computed:1/0,value:1/0};return T(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;r.computed>o&&(r={value:e,computed:o})}),r.value},x.shuffle=function(e){var t,n=0,r=[];return T(e,function(e){t=x.random(n++),r[n-1]=r[t],r[t]=e}),r};var k=function(e){return x.isFunction(e)?e:function(t){return t[e]}};x.sortBy=function(e,t,n){var r=k(t);return x.pluck(x.map(e,function(e,t,i){return{value:e,index:t,criteria:r.call(n,e,t,i)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;if(n!==r){if(n>r||n===void 0)return 1;if(r>n||r===void 0)return-1}return e.index<t.index?-1:1}),"value")};var L=function(e,t,n,r){var i={},s=k(t||x.identity);return T(e,function(t,o){var u=s.call(n,t,o,e);r(i,u,t)}),i};x.groupBy=function(e,t,n){return L(e,t,n,function(e,t,n){(x.has(e,t)?e[t]:e[t]=[]).push(n)})},x.countBy=function(e,t,n){return L(e,t,n,function(e,t){x.has(e,t)||(e[t]=0),e[t]++})},x.sortedIndex=function(e,t,n,r){n=null==n?x.identity:k(n);for(var i=n.call(r,t),s=0,o=e.length;o>s;){var u=s+o>>>1;i>n.call(r,e[u])?s=u+1:o=u}return s},x.toArray=function(e){return e?x.isArray(e)?u.call(e):e.length===+e.length?x.map(e,x.identity):x.values(e):[]},x.size=function(e){return null==e?0:e.length===+e.length?e.length:x.keys(e).length},x.first=x.head=x.take=function(e,t,n){return null==e?void 0:null==t||n?e[0]:u.call(e,0,t)},x.initial=function(e,t,n){return u.call(e,0,e.length-(null==t||n?1:t))},x.last=function(e,t,n){return null==e?void 0:null==t||n?e[e.length-1]:u.call(e,Math.max(e.length-t,0))},x.rest=x.tail=x.drop=function(e,t,n){return u.call(e,null==t||n?1:t)},x.compact=function(e){return x.filter(e,x.identity)};var A=function(e,t,n){return T(e,function(e){x.isArray(e)?t?o.apply(n,e):A(e,t,n):n.push(e)}),n};x.flatten=function(e,t){return A(e,t,[])},x.without=function(e){return x.difference(e,u.call(arguments,1))},x.uniq=x.unique=function(e,t,n,r){x.isFunction(t)&&(r=n,n=t,t=!1);var i=n?x.map(e,n,r):e,s=[],o=[];return T(i,function(n,r){(t?r&&o[o.length-1]===n:x.contains(o,n))||(o.push(n),s.push(e[r]))}),s},x.union=function(){return x.uniq(a.apply(r,arguments))},x.intersection=function(e){var t=u.call(arguments,1);return x.filter(x.uniq(e),function(e){return x.every(t,function(t){return x.indexOf(t,e)>=0})})},x.difference=function(e){var t=a.apply(r,u.call(arguments,1));return x.filter(e,function(e){return!x.contains(t,e)})},x.zip=function(){for(var e=u.call(arguments),t=x.max(x.pluck(e,"length")),n=Array(t),r=0;t>r;r++)n[r]=x.pluck(e,""+r);return n},x.object=function(e,t){if(null==e)return{};for(var n={},r=0,i=e.length;i>r;r++)t?n[e[r]]=t[r]:n[e[r][0]]=e[r][1];return n},x.indexOf=function(e,t,n){if(null==e)return-1;var r=0,i=e.length;if(n){if("number"!=typeof n)return r=x.sortedIndex(e,t),e[r]===t?r:-1;r=0>n?Math.max(0,i+n):n}if(y&&e.indexOf===y)return e.indexOf(t,n);for(;i>r;r++)if(e[r]===t)return r;return-1},x.lastIndexOf=function(e,t,n){if(null==e)return-1;var r=null!=n;if(b&&e.lastIndexOf===b)return r?e.lastIndexOf(t,n):e.lastIndexOf(t);for(var i=r?n:e.length;i--;)if(e[i]===t)return i;return-1},x.range=function(e,t,n){1>=arguments.length&&(t=e||0,e=0),n=arguments[2]||1;for(var r=Math.max(Math.ceil((t-e)/n),0),i=0,s=Array(r);r>i;)s[i++]=e,e+=n;return s},x.bind=function(e,t){if(e.bind===S&&S)return S.apply(e,u.call(arguments,1));var n=u.call(arguments,2);return function(){return e.apply(t,n.concat(u.call(arguments)))}},x.partial=function(e){var t=u.call(arguments,1);return function(){return e.apply(this,t.concat(u.call(arguments)))}},x.bindAll=function(e){var t=u.call(arguments,1);return 0===t.length&&(t=x.functions(e)),T(t,function(t){e[t]=x.bind(e[t],e)}),e},x.memoize=function(e,t){var n={};return t||(t=x.identity),function(){var r=t.apply(this,arguments);return x.has(n,r)?n[r]:n[r]=e.apply(this,arguments)}},x.delay=function(e,t){var n=u.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},x.defer=function(e){return x.delay.apply(x,[e,1].concat(u.call(arguments,1)))},x.throttle=function(e,t){var n,r,i,s,o=0,u=function(){o=new Date,i=null,s=e.apply(n,r)};return function(){var a=new Date,f=t-(a-o);return n=this,r=arguments,0>=f?(clearTimeout(i),i=null,o=a,s=e.apply(n,r)):i||(i=setTimeout(u,f)),s}},x.debounce=function(e,t,n){var r,i;return function(){var s=this,o=arguments,u=function(){r=null,n||(i=e.apply(s,o))},a=n&&!r;return clearTimeout(r),r=setTimeout(u,t),a&&(i=e.apply(s,o)),i}},x.once=function(e){var t,n=!1;return function(){return n?t:(n=!0,t=e.apply(this,arguments),e=null,t)}},x.wrap=function(e,t){return function(){var n=[e];return o.apply(n,arguments),t.apply(this,n)}},x.compose=function(){var e=arguments;return function(){for(var t=arguments,n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},x.after=function(e,t){return 0>=e?t():function(){return 1>--e?t.apply(this,arguments):void 0}},x.keys=E||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var n in e)x.has(e,n)&&(t[t.length]=n);return t},x.values=function(e){var t=[];for(var n in e)x.has(e,n)&&t.push(e[n]);return t},x.pairs=function(e){var t=[];for(var n in e)x.has(e,n)&&t.push([n,e[n]]);return t},x.invert=function(e){var t={};for(var n in e)x.has(e,n)&&(t[e[n]]=n);return t},x.functions=x.methods=function(e){var t=[];for(var n in e)x.isFunction(e[n])&&t.push(n);return t.sort()},x.extend=function(e){return T(u.call(arguments,1),function(t){if(t)for(var n in t)e[n]=t[n]}),e},x.pick=function(e){var t={},n=a.apply(r,u.call(arguments,1));return T(n,function(n){n in e&&(t[n]=e[n])}),t},x.omit=function(e){var t={},n=a.apply(r,u.call(arguments,1));for(var i in e)x.contains(n,i)||(t[i]=e[i]);return t},x.defaults=function(e){return T(u.call(arguments,1),function(t){if(t)for(var n in t)null==e[n]&&(e[n]=t[n])}),e},x.clone=function(e){return x.isObject(e)?x.isArray(e)?e.slice():x.extend({},e):e},x.tap=function(e,t){return t(e),e};var O=function(e,t,n,r){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return e===t;e instanceof x&&(e=e._wrapped),t instanceof x&&(t=t._wrapped);var i=f.call(e);if(i!=f.call(t))return!1;switch(i){case"[object String]":return e==t+"";case"[object Number]":return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if("object"!=typeof e||"object"!=typeof t)return!1;for(var s=n.length;s--;)if(n[s]==e)return r[s]==t;n.push(e),r.push(t);var o=0,u=!0;if("[object Array]"==i){if(o=e.length,u=o==t.length)for(;o--&&(u=O(e[o],t[o],n,r)););}else{var a=e.constructor,l=t.constructor;if(a!==l&&!(x.isFunction(a)&&a instanceof a&&x.isFunction(l)&&l instanceof l))return!1;for(var c in e)if(x.has(e,c)&&(o++,!(u=x.has(t,c)&&O(e[c],t[c],n,r))))break;if(u){for(c in t)if(x.has(t,c)&&!(o--))break;u=!o}}return n.pop(),r.pop(),u};x.isEqual=function(e,t){return O(e,t,[],[])},x.isEmpty=function(e){if(null==e)return!0;if(x.isArray(e)||x.isString(e))return 0===e.length;for(var t in e)if(x.has(e,t))return!1;return!0},x.isElement=function(e){return!!e&&1===e.nodeType},x.isArray=w||function(e){return"[object Array]"==f.call(e)},x.isObject=function(e){return e===Object(e)},T(["Arguments","Function","String","Number","Date","RegExp"],function(e){x["is"+e]=function(t){return f.call(t)=="[object "+e+"]"}}),x.isArguments(arguments)||(x.isArguments=function(e){return!!e&&!!x.has(e,"callee")}),"function"!=typeof /./&&(x.isFunction=function(e){return"function"==typeof e}),x.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},x.isNaN=function(e){return x.isNumber(e)&&e!=+e},x.isBoolean=function(e){return e===!0||e===!1||"[object Boolean]"==f.call(e)},x.isNull=function(e){return null===e},x.isUndefined=function(e){return e===void 0},x.has=function(e,t){return l.call(e,t)},x.noConflict=function(){return e._=t,this},x.identity=function(e){return e},x.times=function(e,t,n){for(var r=Array(e),i=0;e>i;i++)r[i]=t.call(n,i);return r},x.random=function(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))};var M={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};M.unescape=x.invert(M.escape);var _={escape:RegExp("["+x.keys(M.escape).join("")+"]","g"),unescape:RegExp("("+x.keys(M.unescape).join("|")+")","g")};x.each(["escape","unescape"],function(e){x[e]=function(t){return null==t?"":(""+t).replace(_[e],function(t){return M[e][t]})}}),x.result=function(e,t){if(null==e)return null;var n=e[t];return x.isFunction(n)?n.call(e):n},x.mixin=function(e){T(x.functions(e),function(t){var n=x[t]=e[t];x.prototype[t]=function(){var e=[this._wrapped];return o.apply(e,arguments),j.call(this,n.apply(x,e))}})};var D=0;x.uniqueId=function(e){var t=++D+"";return e?e+t:t},x.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var P=/(.)^/,H={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},B=/\\|'|\r|\n|\t|\u2028|\u2029/g;x.template=function(e,t,n){var r;n=x.defaults({},n,x.templateSettings);var i=RegExp([(n.escape||P).source,(n.interpolate||P).source,(n.evaluate||P).source].join("|")+"|$","g"),s=0,o="__p+='";e.replace(i,function(t,n,r,i,u){return o+=e.slice(s,u).replace(B,function(e){return"\\"+H[e]}),n&&(o+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'"),r&&(o+="'+\n((__t=("+r+"))==null?'':__t)+\n'"),i&&(o+="';\n"+i+"\n__p+='"),s=u+t.length,t}),o+="';\n",n.variable||(o="with(obj||{}){\n"+o+"}\n"),o="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+o+"return __p;\n";try{r=Function(n.variable||"obj","_",o)}catch(u){throw u.source=o,u}if(t)return r(t,x);var a=function(e){return r.call(this,e,x)};return a.source="function("+(n.variable||"obj")+"){\n"+o+"}",a},x.chain=function(e){return x(e).chain()};var j=function(e){return this._chain?x(e).chain():e};x.mixin(x),T(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=r[e];x.prototype[e]=function(){var n=this._wrapped;return t.apply(n,arguments),"shift"!=e&&"splice"!=e||0!==n.length||delete n[0],j.call(this,n)}}),T(["concat","join","slice"],function(e){var t=r[e];x.prototype[e]=function(){return j.call(this,t.apply(this._wrapped,arguments))}}),x.extend(x.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}).call(this),define("underscore",function(e){return function(){var t,n;return t||e._}}(this)),function(){var e=this,t=e.Backbone,n=[],r=n.push,i=n.slice,s=n.splice,o;typeof exports!="undefined"?o=exports:o=e.Backbone={},o.VERSION="1.0.0";var u=e._;!u&&typeof require!="undefined"&&(u=require("underscore")),o.$=e.jQuery||e.Zepto||e.ender||e.$,o.noConflict=function(){return e.Backbone=t,this},o.emulateHTTP=!1,o.emulateJSON=!1;var a=o.Events={on:function(e,t,n){if(!l(this,"on",e,[t,n])||!t)return this;this._events||(this._events={});var r=this._events[e]||(this._events[e]=[]);return r.push({callback:t,context:n,ctx:n||this}),this},once:function(e,t,n){if(!l(this,"once",e,[t,n])||!t)return this;var r=this,i=u.once(function(){r.off(e,i),t.apply(this,arguments)});return i._callback=t,this.on(e,i,n)},off:function(e,t,n){var r,i,s,o,a,f,c,h;if(!this._events||!l(this,"off",e,[t,n]))return this;if(!e&&!t&&!n)return this._events={},this;o=e?[e]:u.keys(this._events);for(a=0,f=o.length;a<f;a++){e=o[a];if(s=this._events[e]){this._events[e]=r=[];if(t||n)for(c=0,h=s.length;c<h;c++)i=s[c],(t&&t!==i.callback&&t!==i.callback._callback||n&&n!==i.context)&&r.push(i);r.length||delete this._events[e]}}return this},trigger:function(e){if(!this._events)return this;var t=i.call(arguments,1);if(!l(this,"trigger",e,t))return this;var n=this._events[e],r=this._events.all;return n&&c(n,t),r&&c(r,arguments),this},stopListening:function(e,t,n){var r=this._listeners;if(!r)return this;var i=!t&&!n;typeof t=="object"&&(n=this),e&&((r={})[e._listenerId]=e);for(var s in r)r[s].off(t,n,this),i&&delete this._listeners[s];return this}},f=/\s+/,l=function(e,t,n,r){if(!n)return!0;if(typeof n=="object"){for(var i in n)e[t].apply(e,[i,n[i]].concat(r));return!1}if(f.test(n)){var s=n.split(f);for(var o=0,u=s.length;o<u;o++)e[t].apply(e,[s[o]].concat(r));return!1}return!0},c=function(e,t){var n,r=-1,i=e.length,s=t[0],o=t[1],u=t[2];switch(t.length){case 0:while(++r<i)(n=e[r]).callback.call(n.ctx);return;case 1:while(++r<i)(n=e[r]).callback.call(n.ctx,s);return;case 2:while(++r<i)(n=e[r]).callback.call(n.ctx,s,o);return;case 3:while(++r<i)(n=e[r]).callback.call(n.ctx,s,o,u);return;default:while(++r<i)(n=e[r]).callback.apply(n.ctx,t)}},h={listenTo:"on",listenToOnce:"once"};u.each(h,function(e,t){a[t]=function(t,n,r){var i=this._listeners||(this._listeners={}),s=t._listenerId||(t._listenerId=u.uniqueId("l"));return i[s]=t,typeof n=="object"&&(r=this),t[e](n,r,this),this}}),a.bind=a.on,a.unbind=a.off,u.extend(o,a);var p=o.Model=function(e,t){var n,r=e||{};t||(t={}),this.cid=u.uniqueId("c"),this.attributes={},u.extend(this,u.pick(t,d)),t.parse&&(r=this.parse(r,t)||{});if(n=u.result(this,"defaults"))r=u.defaults({},r,n);this.set(r,t),this.changed={},this.initialize.apply(this,arguments)},d=["url","urlRoot","collection"];u.extend(p.prototype,a,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(e){return u.clone(this.attributes)},sync:function(){return o.sync.apply(this,arguments)},get:function(e){return this.attributes[e]},escape:function(e){return u.escape(this.get(e))},has:function(e){return this.get(e)!=null},set:function(e,t,n){var r,i,s,o,a,f,l,c;if(e==null)return this;typeof e=="object"?(i=e,n=t):(i={})[e]=t,n||(n={});if(!this._validate(i,n))return!1;s=n.unset,a=n.silent,o=[],f=this._changing,this._changing=!0,f||(this._previousAttributes=u.clone(this.attributes),this.changed={}),c=this.attributes,l=this._previousAttributes,this.idAttribute in i&&(this.id=i[this.idAttribute]);for(r in i)t=i[r],u.isEqual(c[r],t)||o.push(r),u.isEqual(l[r],t)?delete this.changed[r]:this.changed[r]=t,s?delete c[r]:c[r]=t;if(!a){o.length&&(this._pending=!0);for(var h=0,p=o.length;h<p;h++)this.trigger("change:"+o[h],this,c[o[h]],n)}if(f)return this;if(!a)while(this._pending)this._pending=!1,this.trigger("change",this,n);return this._pending=!1,this._changing=!1,this},unset:function(e,t){return this.set(e,void 0,u.extend({},t,{unset:!0}))},clear:function(e){var t={};for(var n in this.attributes)t[n]=void 0;return this.set(t,u.extend({},e,{unset:!0}))},hasChanged:function(e){return e==null?!u.isEmpty(this.changed):u.has(this.changed,e)},changedAttributes:function(e){if(!e)return this.hasChanged()?u.clone(this.changed):!1;var t,n=!1,r=this._changing?this._previousAttributes:this.attributes;for(var i in e){if(u.isEqual(r[i],t=e[i]))continue;(n||(n={}))[i]=t}return n},previous:function(e){return e==null||!this._previousAttributes?null:this._previousAttributes[e]},previousAttributes:function(){return u.clone(this._previousAttributes)},fetch:function(e){e=e?u.clone(e):{},e.parse===void 0&&(e.parse=!0);var t=this,n=e.success;return e.success=function(r){if(!t.set(t.parse(r,e),e))return!1;n&&n(t,r,e),t.trigger("sync",t,r,e)},j(this,e),this.sync("read",this,e)},save:function(e,t,n){var r,i,s,o=this.attributes;e==null||typeof e=="object"?(r=e,n=t):(r={})[e]=t;if(r&&(!n||!n.wait)&&!this.set(r,n))return!1;n=u.extend({validate:!0},n);if(!this._validate(r,n))return!1;r&&n.wait&&(this.attributes=u.extend({},o,r)),n.parse===void 0&&(n.parse=!0);var a=this,f=n.success;return n.success=function(e){a.attributes=o;var t=a.parse(e,n);n.wait&&(t=u.extend(r||{},t));if(u.isObject(t)&&!a.set(t,n))return!1;f&&f(a,e,n),a.trigger("sync",a,e,n)},j(this,n),i=this.isNew()?"create":n.patch?"patch":"update",i==="patch"&&(n.attrs=r),s=this.sync(i,this,n),r&&n.wait&&(this.attributes=o),s},destroy:function(e){e=e?u.clone(e):{};var t=this,n=e.success,r=function(){t.trigger("destroy",t,t.collection,e)};e.success=function(i){(e.wait||t.isNew())&&r(),n&&n(t,i,e),t.isNew()||t.trigger("sync",t,i,e)};if(this.isNew())return e.success(),!1;j(this,e);var i=this.sync("delete",this,e);return e.wait||r(),i},url:function(){var e=u.result(this,"urlRoot")||u.result(this.collection,"url")||B();return this.isNew()?e:e+(e.charAt(e.length-1)==="/"?"":"/")+encodeURIComponent(this.id)},parse:function(e,t){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},isValid:function(e){return this._validate({},u.extend(e||{},{validate:!0}))},_validate:function(e,t){if(!t.validate||!this.validate)return!0;e=u.extend({},this.attributes,e);var n=this.validationError=this.validate(e,t)||null;return n?(this.trigger("invalid",this,n,u.extend(t||{},{validationError:n})),!1):!0}});var v=["keys","values","pairs","invert","pick","omit"];u.each(v,function(e){p.prototype[e]=function(){var t=i.call(arguments);return t.unshift(this.attributes),u[e].apply(u,t)}});var m=o.Collection=function(e,t){t||(t={}),t.url&&(this.url=t.url),t.model&&(this.model=t.model),t.comparator!==void 0&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,u.extend({silent:!0},t))},g={add:!0,remove:!0,merge:!0},y={add:!0,merge:!1,remove:!1};u.extend(m.prototype,a,{model:p,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},sync:function(){return o.sync.apply(this,arguments)},add:function(e,t){return this.set(e,u.defaults(t||{},y))},remove:function(e,t){e=u.isArray(e)?e.slice():[e],t||(t={});var n,r,i,s;for(n=0,r=e.length;n<r;n++){s=this.get(e[n]);if(!s)continue;delete this._byId[s.id],delete this._byId[s.cid],i=this.indexOf(s),this.models.splice(i,1),this.length--,t.silent||(t.index=i,s.trigger("remove",s,this,t)),this._removeReference(s)}return this},set:function(e,t){t=u.defaults(t||{},g),t.parse&&(e=this.parse(e,t)),u.isArray(e)||(e=e?[e]:[]);var n,i,o,a,f,l,c=t.at,h=this.comparator&&c==null&&t.sort!==!1,p=u.isString(this.comparator)?this.comparator:null,d=[],v=[],m={};for(n=0,i=e.length;n<i;n++){if(!(o=this._prepareModel(e[n],t)))continue;(f=this.get(o))?(t.remove&&(m[f.cid]=!0),t.merge&&(f.set(o.attributes,t),h&&!l&&f.hasChanged(p)&&(l=!0))):t.add&&(d.push(o),o.on("all",this._onModelEvent,this),this._byId[o.cid]=o,o.id!=null&&(this._byId[o.id]=o))}if(t.remove){for(n=0,i=this.length;n<i;++n)m[(o=this.models[n]).cid]||v.push(o);v.length&&this.remove(v,t)}d.length&&(h&&(l=!0),this.length+=d.length,c!=null?s.apply(this.models,[c,0].concat(d)):r.apply(this.models,d)),l&&this.sort({silent:!0});if(t.silent)return this;for(n=0,i=d.length;n<i;n++)(o=d[n]).trigger("add",o,this,t);return l&&this.trigger("sort",this,t),this},reset:function(e,t){t||(t={});for(var n=0,r=this.models.length;n<r;n++)this._removeReference(this.models[n]);return t.previousModels=this.models,this._reset(),this.add(e,u.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),this},push:function(e,t){return e=this._prepareModel(e,t),this.add(e,u.extend({at:this.length},t)),e},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e),t},unshift:function(e,t){return e=this._prepareModel(e,t),this.add(e,u.extend({at:0},t)),e},shift:function(e){var t=this.at(0);return this.remove(t,e),t},slice:function(e,t){return this.models.slice(e,t)},get:function(e){return e==null?void 0:this._byId[e.id!=null?e.id:e.cid||e]},at:function(e){return this.models[e]},where:function(e,t){return u.isEmpty(e)?t?void 0:[]:this[t?"find":"filter"](function(t){for(var n in e)if(e[n]!==t.get(n))return!1;return!0})},findWhere:function(e){return this.where(e,!0)},sort:function(e){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return e||(e={}),u.isString(this.comparator)||this.comparator.length===1?this.models=this.sortBy(this.comparator,this):this.models.sort(u.bind(this.comparator,this)),e.silent||this.trigger("sort",this,e),this},sortedIndex:function(e,t,n){t||(t=this.comparator);var r=u.isFunction(t)?t:function(e){return e.get(t)};return u.sortedIndex(this.models,e,r,n)},pluck:function(e){return u.invoke(this.models,"get",e)},fetch:function(e){e=e?u.clone(e):{},e.parse===void 0&&(e.parse=!0);var t=e.success,n=this;return e.success=function(r){var i=e.reset?"reset":"set";n[i](r,e),t&&t(n,r,e),n.trigger("sync",n,r,e)},j(this,e),this.sync("read",this,e)},create:function(e,t){t=t?u.clone(t):{};if(!(e=this._prepareModel(e,t)))return!1;t.wait||this.add(e,t);var n=this,r=t.success;return t.success=function(i){t.wait&&n.add(e,t),r&&r(e,i,t)},e.save(null,t),e},parse:function(e,t){return e},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(e,t){if(e instanceof p)return e.collection||(e.collection=this),e;t||(t={}),t.collection=this;var n=new this.model(e,t);return n._validate(e,t)?n:(this.trigger("invalid",this,e,t),!1)},_removeReference:function(e){this===e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,n,r){if((e==="add"||e==="remove")&&n!==this)return;e==="destroy"&&this.remove(t,r),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],t.id!=null&&(this._byId[t.id]=t)),this.trigger.apply(this,arguments)}});var b=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"];u.each(b,function(e){m.prototype[e]=function(){var t=i.call(arguments);return t.unshift(this.models),u[e].apply(u,t)}});var w=["groupBy","countBy","sortBy"];u.each(w,function(e){m.prototype[e]=function(t,n){var r=u.isFunction(t)?t:function(e){return e.get(t)};return u[e](this.models,r,n)}});var E=o.View=function(e){this.cid=u.uniqueId("view"),this._configure(e||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},S=/^(\S+)\s*(.*)$/,x=["model","collection","el","id","attributes","className","tagName","events"];u.extend(E.prototype,a,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(e,t){return this.$el&&this.undelegateEvents(),this.$el=e instanceof o.$?e:o.$(e),this.el=this.$el[0],t!==!1&&this.delegateEvents(),this},delegateEvents:function(e){if(!e&&!(e=u.result(this,"events")))return this;this.undelegateEvents();for(var t in e){var n=e[t];u.isFunction(n)||(n=this[e[t]]);if(!n)continue;var r=t.match(S),i=r[1],s=r[2];n=u.bind(n,this),i+=".delegateEvents"+this.cid,s===""?this.$el.on(i,n):this.$el.on(i,s,n)}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_configure:function(e){this.options&&(e=u.extend({},u.result(this,"options"),e)),u.extend(this,u.pick(e,x)),this.options=e},_ensureElement:function(){if(!this.el){var e=u.extend({},u.result(this,"attributes"));this.id&&(e.id=u.result(this,"id")),this.className&&(e["class"]=u.result(this,"className"));var t=o.$("<"+u.result(this,"tagName")+">").attr(e);this.setElement(t,!1)}else this.setElement(u.result(this,"el"),!1)}}),o.sync=function(e,t,n){var r=T[e];u.defaults(n||(n={}),{emulateHTTP:o.emulateHTTP,emulateJSON:o.emulateJSON});var i={type:r,dataType:"json"};n.url||(i.url=u.result(t,"url")||B()),n.data==null&&t&&(e==="create"||e==="update"||e==="patch")&&(i.contentType="application/json",i.data=JSON.stringify(n.attrs||t.toJSON(n))),n.emulateJSON&&(i.contentType="application/x-www-form-urlencoded",i.data=i.data?{model:i.data}:{});if(n.emulateHTTP&&(r==="PUT"||r==="DELETE"||r==="PATCH")){i.type="POST",n.emulateJSON&&(i.data._method=r);var s=n.beforeSend;n.beforeSend=function(e){e.setRequestHeader("X-HTTP-Method-Override",r);if(s)return s.apply(this,arguments)}}i.type!=="GET"&&!n.emulateJSON&&(i.processData=!1),i.type==="PATCH"&&window.ActiveXObject&&(!window.external||!window.external.msActiveXFilteringEnabled)&&(i.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var a=n.xhr=o.ajax(u.extend(i,n));return t.trigger("request",t,a,n),a};var T={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};o.ajax=function(){return o.$.ajax.apply(o.$,arguments)};var N=o.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},C=/\((.*?)\)/g,k=/(\(\?)?:\w+/g,L=/\*\w+/g,A=/[\-{}\[\]+?.,\\\^$|#\s]/g;u.extend(N.prototype,a,{initialize:function(){},route:function(e,t,n){u.isRegExp(e)||(e=this._routeToRegExp(e)),u.isFunction(t)&&(n=t,t=""),n||(n=this[t]);var r=this;return o.history.route(e,function(i){var s=r._extractParameters(e,i);n&&n.apply(r,s),r.trigger.apply(r,["route:"+t].concat(s)),r.trigger("route",t,s),o.history.trigger("route",r,t,s)}),this},navigate:function(e,t){return o.history.navigate(e,t),this},_bindRoutes:function(){if(!this.routes)return;this.routes=u.result(this,"routes");var e,t=u.keys(this.routes);while((e=t.pop())!=null)this.route(e,this.routes[e])},_routeToRegExp:function(e){return e=e.replace(A,"\\$&").replace(C,"(?:$1)?").replace(k,function(e,t){return t?e:"([^/]+)"}).replace(L,"(.*?)"),new RegExp("^"+e+"$")},_extractParameters:function(e,t){var n=e.exec(t).slice(1);return u.map(n,function(e){return e?decodeURIComponent(e):null})}});var O=o.History=function(){this.handlers=[],u.bindAll(this,"checkUrl"),typeof window!="undefined"&&(this.location=window.location,this.history=window.history)},M=/^[#\/]|\s+$/g,_=/^\/+|\/+$/g,D=/msie [\w.]+/,P=/\/$/;O.started=!1,u.extend(O.prototype,a,{interval:50,getHash:function(e){var t=(e||this).location.href.match(/#(.*)$/);return t?t[1]:""},getFragment:function(e,t){if(e==null)if(this._hasPushState||!this._wantsHashChange||t){e=this.location.pathname;var n=this.root.replace(P,"");e.indexOf(n)||(e=e.substr(n.length))}else e=this.getHash();return e.replace(M,"")},start:function(e){if(O.started)throw new Error("Backbone.history has already been started");O.started=!0,this.options=u.extend({},{root:"/"},this.options,e),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var t=this.getFragment(),n=document.documentMode,r=D.exec(navigator.userAgent.toLowerCase())&&(!n||n<=7);this.root=("/"+this.root+"/").replace(_,"/"),r&&this._wantsHashChange&&(this.iframe=o.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(t)),this._hasPushState?o.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!r?o.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=t;var i=this.location,s=i.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!s)return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0;this._wantsPushState&&this._hasPushState&&s&&i.hash&&(this.fragment=this.getHash().replace(M,""),this.history.replaceState({},document.title,this.root+this.fragment+i.search));if(!this.options.silent)return this.loadUrl()},stop:function(){o.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),O.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(e){var t=this.getFragment();t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe)));if(t===this.fragment)return!1;this.iframe&&this.navigate(t),this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(e){var t=this.fragment=this.getFragment(e),n=u.any(this.handlers,function(e){if(e.route.test(t))return e.callback(t),!0});return n},navigate:function(e,t){if(!O.started)return!1;if(!t||t===!0)t={trigger:t};e=this.getFragment(e||"");if(this.fragment===e)return;this.fragment=e;var n=this.root+e;if(this._hasPushState)this.history[t.replace?"replaceState":"pushState"]({},document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);this._updateHash(this.location,e,t.replace),this.iframe&&e!==this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,e,t.replace))}t.trigger&&this.loadUrl(e)},_updateHash:function(e,t,n){if(n){var r=e.href.replace(/(javascript:|#).*$/,"");e.replace(r+"#"+t)}else e.hash="#"+t}}),o.history=new O;var H=function(e,t){var n=this,r;e&&u.has(e,"constructor")?r=e.constructor:r=function(){return n.apply(this,arguments)},u.extend(r,n,t);var i=function(){this.constructor=r};return i.prototype=n.prototype,r.prototype=new i,e&&u.extend(r.prototype,e),r.__super__=n.prototype,r};p.extend=m.extend=N.extend=E.extend=O.extend=H;var B=function(){throw new Error('A "url" property or function must be specified')},j=function(e,t){var n=t.error;t.error=function(r){n&&n(e,r,t),e.trigger("error",e,r,t)}}}.call(this),define("backbone",["underscore"],function(e){return function(){var t,n;return t||e.Backbone}}(this)),define("models",["backbone"],function(e){Upfront.Events=_.isEmpty(Upfront.Events)?_.extend(Upfront.Events,e.Events):Upfront.Events;var t="alpha",n={},r=e.Model.extend({defaults:{name:"",value:""},idAttribute:"name"}),s=e.Collection.extend({model:r}),o=e.Model.extend({defaults:{name:"",element_id:"",properties:new s},initialize:function(){var e=arguments;e&&e[0]&&e[0].properties?(e[0].properties=e[0].properties instanceof s?e[0].properties:new s(e[0].properties),this.set("properties",e[0].properties)):this.set("properties",new s([])),this.init&&this.init()},get_view_class:function(){return Upfront.Views.ObjectView},get_property_by_name:function(e){var t=this.get("properties").where({name:e});return t.length?t[0]:!1},get_property_value_by_name:function(e){var t=this.get_property_by_name(e);return t&&t.get?t.get("value"):!1},has_property:function(e){return!!this.get_property_value_by_name(e)},has_property_value:function(e,t){return t==this.get_property_value_by_name(e)},add_property:function(e,t,n){n||(n=!1),this.get("properties").add(new Upfront.Models.Property({name:e,value:t}),{silent:n})},set_property:function(e,t,n){if(!e)return!1;n||(n=!1);var r=this.get_property_by_name(e);if(!r||!r.set)return this.add_property(e,t,n);r.set({value:t},{silent:n})},init_property:function(e,t){this.has_property(e)||this.add_property(e,t)},init_properties:function(e){var t=this;_(e).each(function(e,n){t.init_property(n,e)})},get_content:function(){return this.get_property_value_by_name("content")},set_content:function(e,t){var n=this.get_property_by_name("content"),t=typeof t!="undefined"?t:{};return n?n.set("value",e,t):this.get("properties").add(new Upfront.Models.Property({name:"content",value:e}))},get_element_id:function(){return this.get_property_value_by_name("element_id")},get_wrapper_id:function(){return this.get_property_value_by_name("wrapper_id")},replace_class:function(e){var t=this.get_property_by_name("class"),n=t?t.get("value"):!1;if(t&&n){var i=e.split(" "),s=n;for(var o=0;o<i.length;o++){var u=i[o].replace(/-?\d+/,"-?\\d+"),a=new RegExp(u);s.match(a)?s=s.replace(a,i[o]):s+=" "+i[o]}return t.set("value",s)}return t||this.get("properties").add(new r({name:"class",value:e})),!1},add_class:function(e){var t=new RegExp(e),n=this.get_property_by_name("class"),i=n?n.get("value"):!1;return n&&!i.match(t)?n.set("value",i+" "+e):(n||this.get("properties").add(new r({name:"class",value:e})),!1)},remove_class:function(e){var t=new RegExp(e),n=this.get_property_by_name("class"),r=n?n.get("value"):!1;return n&&r.match(t)?n.set("value",r.replace(t,"")):!1},is_visible:function(){return this.get_property_value_by_name("visibility")},add_to:function(e,t,n){var r=this,i=[],s=!1,n=_.isObject(n)?n:{};e.each(function(e,n){n==t&&(i.push(r),s=!0),i.push(e)}),s?(e.reset(i,{silent:!0}),e.trigger("add",this,e,_.extend(n,{index:t}))):e.add(this,_.extend(n,{index:t}))}}),u=e.Collection.extend({model:o,initialize:function(e){var t=[];if(!e||!e.length)return!1;_(e).each(function(e){var n=e.properties?_(e.properties).where({name:"type"}):e.get("properties").where({name:"type"}),r=n.length?n[0].value:"ObjectModel",i=Upfront.Models[r]?new Upfront.Models[r](e):!1;Upfront.Models[r]&&i&&t.push(i)}),this.reset(t)},get_by_element_id:function(e){var t=!1;return this.each(function(n){n.get_element_id()==e&&(t=n)}),t}}),a=o.extend({defaults:{name:"",objects:new s,properties:new u},initialize:function(){var e=arguments;e&&e[0]&&e[0].objects&&(e[0].objects=e[0].objects instanceof u?e[0].objects:new u(e[0].objects),this.set("objects",e[0].objects)),e&&e[0]&&e[0].properties?(e[0].properties=e[0].properties instanceof s?e[0].properties:new s(e[0].properties),this.set("properties",e[0].properties)):this.set("properties",new s([])),this.init&&this.init()}}),f=e.Collection.extend({model:a,get_by_element_id:function(e){var t=!1;return this.each(function(n){n.get_element_id()==e&&(t=n)}),t}}),c=o.extend({defaults:function(){return{name:"",properties:new s,wrappers:new d,modules:new f}},initialize:function(){var e=arguments;e&&e[0]&&e[0].modules&&(e[0].modules=e[0].modules instanceof f?e[0].modules:new f(e[0].modules),this.set("modules",e[0].modules)),e&&e[0]&&e[0].wrappers&&(e[0].wrappers=e[0].wrappers instanceof d?e[0].wrappers:new d(e[0].wrappers),this.set("wrappers",e[0].wrappers)),e&&e[0]&&e[0].properties?(e[0].properties=e[0].properties instanceof s?e[0].properties:new s(e[0].properties),this.set("properties",e[0].properties)):this.set("properties",new s([]))},is_main:function(){var e=this.get("container"),t=this.get("name");return!e||e==t},get_sub_regions:function(){if(!this.collection)return!1;var e=this.collection,t=e.indexOf(this),n=e.size()-1,r=this.get("container")||this.get("name"),i=[],s=left=right=bottom=!1;return t>0&&(left=e.at(t-1),left.get("sub")!="top"?t>1&&(s=e.at(t-2)):(s=left,left=!1)),t<n-1&&(right=e.at(t+1),right.get("sub")!="bottom"?t<n-2&&(bottom=e.at(t+2)):(bottom=right,right=!1)),{top:s&&s.get("container")==r&&s.get("sub")=="top"?s:!1,left:left&&left.get("container")==r?left:!1,right:right&&right.get("container")==r?right:!1,bottom:bottom&&bottom.get("container")==r&&bottom.get("sub")=="bottom"?bottom:!1}},get_sub_region:function(e){return this.get_sub_regions()[e]},has_sub_region:function(){return _.find(this.get_sub_regions(),function(e){return e!==!1})},get_side_region:function(e){return this.get_sub_region(e?"right":"left")},has_side_region:function(){var e=this.get_sub_regions();return e.left||e.right}}),h=e.Collection.extend({model:c,get_by_name:function(e){var t=!1,e=e.toLowerCase();return this.each(function(n){n.get("name").toLowerCase()==e&&(t=n)}),t},at_container:function(e){var t=0;return this.find(function(n){if(n.is_main()){if(t==e)return!0;t++}return!1})},index_container:function(e){var t=this.filter(function(e){return e.is_main()}),n=t.indexOf(e);return n}}),p=o.extend({defaults:{name:"",properties:new s},initialize:function(){var e=arguments;e&&e[0]&&e[0].properties&&(e[0].properties=e[0].properties instanceof s?e[0].properties:new s(e[0].properties),this.set("properties",e[0].properties))}}),d=e.Collection.extend({model:p,get_by_wrapper_id:function(e){var t=!1;return this.each(function(n){n.get_wrapper_id()==e&&(t=n)}),t}}),v=e.Model.extend({defaults:{name:"",properties:new s,regions:new h,wrappers:new d},initialize:function(){var e=arguments;e&&e[0]&&e[0].regions&&(e[0].regions=e[0].regions instanceof h?e[0].regions:new h(e[0].regions),this.set("regions",e[0].regions)),e&&e[0]&&e[0].properties&&(e[0].properties=e[0].properties instanceof s?e[0].properties:new s(e[0].properties),this.set("properties",e[0].properties)),e&&e[0]&&e[0].wrappers&&(e[0].wrappers=e[0].wrappers instanceof d?e[0].wrappers:new d(e[0].wrappers),this.set("wrappers",e[0].wrappers))},get_current_state:function(){return Upfront.Util.model_to_json(this.get("regions"))},has_undo_states:function(){return!!Upfront.Util.Transient.length("undo")},has_redo_states:function(){return!!Upfront.Util.Transient.length("redo")},store_undo_state:function(){Upfront.Util.Transient.push("undo",this.get_current_state())},restore_undo_state:function(){if(!this.has_undo_states())return!1;this.restore_state_from_stack("undo")},restore_redo_state:function(){if(!this.has_redo_states())return!1;this.restore_state_from_stack("redo")},restore_state_from_stack:function(e){var t="undo"==e?"redo":"undo",n=Upfront.Util.Transient.pop(e);if(!n)return Upfront.Util.log("Invalid "+e+" state"),!1;Upfront.Util.Transient.push(t,this.get_current_state()),this.get("regions").reset(n)}}),m=e.Model.extend({initialize:function(){var t=arguments,n=t[0]||{};this.taxonomy=n.taxonomy?new e.Model(n.taxonomy):e.Model({}),this.all_terms=n.all_terms?new e.Collection(n.all_terms):new e.Collection([]),this.post_terms=n.post_terms?new e.Collection(n.post_terms):new e.Collection([])}}),g=e.Model.extend({action:"upfront-wp-model",fetchAttributes:[],saveAttributes:[],fetch:function(e){var t=this;return postdata={action:"fetch_"+this.modelName,id:this.id},_.each(this.fetchAttributes,function(e){postdata[e]=t[e]}),postdata=_.extend(postdata,e),this.post(postdata).done(function(e){t.set(e.data)})},save:function(){var e=this,t=this.toJSON();return _.each(this.saveAttributes,function(n){t[n]=e[n]}),t.action="save_"+this.modelName,this.post(t).done(function(t){e.changed={}})},post:function(e){return e=_.isObject(e)?_.clone(e):{},e.model_action=e.action,e.action=this.action,Upfront.Util.post(e)},get:function(e){var t=this.attributes[e];return _.isString(t)&&t.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/)?new Date(t):this.attributes[e]},set:function(t,n,r){var i=n,s={};if(_.isObject(t)){for(var o in t){var u=t[o];n instanceof Date?s[o]=Upfront.Util.format_date(u,!0,!0).replace(/\//g,"-"):s[o]=u}e.Model.prototype.set.call(this,s,r)}else n instanceof Date&&(i=Upfront.Util.format_date(n,!0,!0).replace(/\//g,"-")),e.Model.prototype.set.call(this,t,i,r);return this}}),y=e.Collection.extend({action:"upfront-wp-model",fetchAttributes:[],saveAttributes:[],changedModels:[],addedModels:[],removedModels:[],isNew:!0,parentAttribute:!1,childrenAttribute:!1,orphans:{},orderby:!1,order:"desc",pagination:{pages:1,pageSize:10,currentPage:1,totalElements:0,loaded:{}},lastFetchOptions:{},fetch:function(e){var t=this,n={action:"fetch_"+this.collectionName,id:this.id};return this.orderby&&(n.orderby=this.orderby,n.order=this.order),_.each(this.fetchAttributes,function(e){n[e]=t[e]}),n=this.checkPostFlush(_.extend(n,e)),this.changedModels=[],this.addedModels=[],this.removedModels=[],this.off("change",this.updateChanged,this),this.on("change",this.updateChanged,this),this.off("add",this.updateAdded,this),this.on("add",this.updateAdded,this),this.off("remove",this.updateRemoved,this),this.on("remove",this.updateRemoved,this),this.isNew=!1,this.post(n).done(function(e){if(e.data.pagination){var r=e.data.pagination,i=[];n.flush||t.pagination.totalElements!=r.total?(t.pagination={totalElements:r.total,pageSize:r.page_size,pages:Math.ceil(r.total/r.page_size),currentPage:r.page,loaded:n.flush?{}:t.pagination.loaded},t.pagination.loaded[r.page]=!0,_.each(e.data.results,function(e){var n=new t.model(e);n.belongsToPage=r.page,i.push(n)}),t.reset(i)):(t.pagination.currentPage=r.page,t.pagination.loaded[r.page]=!0,_.each(e.data.results,function(e){var n=new t.model(e);n.belongsToPage=r.page,t.add(n,{silent:!0,merge:!0})}),t.trigger("reset",t))}else t.reset(e.data.results)})},post:function(e){return e=_.isObject(e)?_.clone(e):{},e.model_action=e.action,e.action=this.action,Upfront.Util.post(e)},save:function(){var e=this,t={all:this.toJSON(),added:[],changed:[],removed:[],action:"save_"+this.collectionName};return this.isNew?t.added=t.all:this.each(function(n){e.addedModels.indexOf(n.id)!=-1&&t.added.push(n.toJSON()),e.changedModels.indexOf(n.id)!=-1&&t.changed.push(n.toJSON()),e.removedModels.indexOf(n.id)!=-1&&t.removed.push(n.toJSON())}),this.isNew=!1,_.each(this.saveAttributes,function(n){t[n]=e[n]}),this.post(t).done(function(t){e.reset(t.data),e.addedModels=[],e.changedModels=[],e.removedModels=[]})},updateChanged:function(e){var t=e.id,n=_.indexOf(this.addedModels,t);n!=-1?this.addedModels[n]=t:_.contains(this.changedModels,t)||this.changedModels.push(t)},updateAdded:function(e){var t=e.id,n=_.indexOf(this.removedModels,t);n!=-1?(this.removedModels.splice(n,1),this.changedModels.push(t)):_.contains(this.addedModels,t)||this.addedModels.push(t)},updateRemoved:function(e){var t=e.id,n=_.indexOf(this.addedModels,t),r=_.indexOf(this.changedModels,t);n!=-1?this.addedModels.splice(n,1):_.contains(this.removedModels,t)||this.removedModels.push(t),r!=-1&&this.changedModels.splice(r,1)},add:function(t,n){if(!this.parentAttribute||!this.childrenAttribute)return e.Collection.prototype.add.call(this,t,n);var r=this;if(!_.isArray(t)){var i=0,s=t;if(this.model&&s instanceof this.model)i=s.get(this.parentAttribute);else{if(!_.isObject(s))return e.Collection.prototype.add.call(this,s,n);i=s[this.parentAttribute],this.model&&(s=new this.model(t))}this.orphans[s.id]?(s[this.childrenAttribute]?s[this.childrenAttribute].add(this.orphans[s.id],n):s[this.childrenAttribute]=new this.constructor(this.orphans[s.id],n),delete this.orphans[s.id]):s[this.childrenAttribute]||(s[this.childrenAttribute]=new this.constructor([],n));if(i){var o=this.get(i);if(o)o[this.childrenAttribute].add(s,n);else{var u=this.orphans[i];u?u.push(s):this.orphans[i]=[s]}}return e.Collection.prototype.add.call(this,s,n)}_.each(t,function(e){r.add(e,n)})},remove:function(t,n){if(!this.parentAttribute||!this.childrenAttribute)return e.Collection.prototype.remove.call(this,t,n);var r=this;t=_.isArray(t)?t.slice():[t];for(i=0,l=t.length;i<l;i++){var s=this.get(t[i]);s&&s[this.childrenAttribute].each(function(e){r.remove(e,n)})}return e.Collection.prototype.remove.call(this,t,n)},getPage:function(e){var t=this;return this.filter(function(t){return t.belongsToPage==e})},fetchPage:function(e,t){t||(t={});if(!t.flush&&this.pagination.loaded[e]){this.pagination.currentPage=e;var n=this.getPage(e),r=[];return _.each(n,function(e){r.push(e.toJSON())}),this.pagination.currentPage=e,jQuery.Deferred().resolve({results:r})}return this.fetch(_.extend({page:e,limit:this.pagination.pageSize},t))},reSort:function(e,t){var n=t=="asc"?"asc":"desc";return this.orderby=e,this.order=n,this.fetch({page:0,sort:e,direction:n})},checkPostFlush:function(e){var t=this,n=!1,r=_.clone(e);return e.flush?(delete r.flush,this.lastFetchOptions=r,e):(_.each(e,function(e,r){["limit","page"].indexOf(r)==-1&&(n=n||t.lastFetchOptions[r]!=e)}),n?(t.lastFetchOptions=_.clone(e),r.flush=!0):r=_.extend(this.lastFetchOptions,r),r)}}),b=g.extend({modelName:"post",defaults:{ID:0,post_author:0,post_date:new Date,post_date_gmt:new Date,post_content:"",post_title:"",post_excerpt:"",post_status:"",comment_status:"",ping_status:"",post_password:"",post_name:"",to_ping:[],pinged:[],post_modified:new Date,post_modified_gmt:new Date,post_content_filtered:"",post_parent:0,guid:"",menu_order:0,post_type:"post",post_mime_type:"",comment_count:0,permalink:""},saveAttributes:["sticky"],author:!1,comments:!1,parent:!1,terms:!1,meta:!1,initialize:function(e,t){var n=this;e&&(e.id&&this.set(this.idAttribute,e.id),e.author&&(this.author=new Upfront.Models.User(e.author)),e.meta&&(this.meta=new Upfront.Collections.MetaList(e.meta,{objectId:this.id,metaType:"post"})))},getVisibility:function(){return this.get("post_status")=="private"?"private":this.get("post_password")?"password":this.sticky?"sticky":"public"},setVisibility:function(e){this.sticky=0,e=="password"?this.set("post_status","publish"):(this.set("post_password",""),e=="private"?this.set("post_status","private"):e=="sticky"?this.sticky=1:e=="public"&&this.set("post_status","publish"))},fetch:function(e){var t=this;return g.prototype.fetch.call(this,e).done(function(e){e.data.author&&(t.author=new Upfront.Models.User(e.data.author)),e.data.meta&&(t.meta=new Upfront.Collections.MetaList(e.data.meta,{objectId:t.id,metaType:"post"})),t.sticky=e.data.sticky})},idAttribute:"ID",fetch_comments:function(e){var t=this;return e=_.isObject(e)?e:{},this.comments=new Upfront.Collections.CommentList([],{postId:this.id}),this.comments.fetch()},fetch_parent:function(){if(!this.get("post_parent"))return!1;var e=this,t={action:"fetch_post",id:this.get("post_parent")};return this.post(t).done(function(t){e.parent=new b(t.data)})},fetch_author:function(){console.log("Fetch author not yet implemented.")},fetch_terms:function(e){return e?this.post({taxonomy:e,post_id:this.get("ID"),action:"get_terms"}):!1},fetch_meta:function(){return this.meta=new Upfront.Collection.MetaList([],{objectId:this.id,metaType:"post"}),this.meta.fetch()}}),w=y.extend({collectionName:"post_list",model:b,parentAttribute:"post_parent",childrenAttribute:"children",postId:!1,postType:"post",withMeta:!1,withAuthor:!1,fetchAttributes:["postId","postType","withMeta","withAuthor"],initialize:function(e,t){t&&(t.postId&&(this.postId=t.postId),t.postType&&(this.postType=t.postType),t.withMeta&&(this.withMeta=t.withMeta),t.withAuthor&&(this.withAuthor=t.withAuthor))}});return Comment=g.extend({modelName:"comment",defaults:{comment_ID:0,comment_post_id:0,comment_author:"",comment_author_email:"",comment_author_url:"",comment_author_IP:"0.0.0.0",comment_date:new Date,comment_date_gmt:new Date,comment_content:"",comment_karma:"",comment_agent:"",comment_type:"",comment_approved:"0",comment_parent:0,user_id:0},idAttribute:"comment_ID",initialize:function(e){e&&e.id&&this.set(this.idAttribute,e.id)},trash:function(e){return e?this.set("comment_approved","trash"):!e&&this.get("comment_approved")=="trash"&&this.set("comment_approved","0"),this},spam:function(e){return e?this.set("comment_approved","spam"):!e&&this.get("comment_approved")=="spam"&&this.set("comment_approved","0"),this},approve:function(e){return e?this.set("comment_approved","1"):!e&&this.get("comment_approved")=="1"&&this.set("comment_approved","0"),this},isTrash:function(){return this.get("comment_approved")=="trash"},isApproved:function(){return this.get("comment_approved")=="1"},isSpam:function(){return this.get("comment_approved")=="spam"}}),CommentList=y.extend({model:Comment,collectionName:"comment_list",postId:!1,fetchAttributes:["postId","commentType"],parentAttribute:"comment_parent",childrenAttribute:"replies",commentType:"comment",initialize:function(e,t){t.postId&&(this.postId=t.postId)},save:function(){console.error("CommentList save: Use single comment save instead.")}}),Meta=e.Model.extend({defaults:{meta_key:"",meta_value:""},idAttribute:"meta_key"}),MetaList=y.extend({model:Meta,collectionName:"meta_list",metaType:"post",objectId:0,fetchAttributes:["objectId","metaType"],saveAttributes:["objectId","metaType"],initialize:function(e,t){var n=[];t.objectId&&(this.objectId=t.objectId),t.metaType&&(this.metaType=t.metaType)},getValue:function(e){var t=this.get(e);return t?t.get("meta_value"):undefined},setValue:function(e,t){var n=this.get(e);return n?(n.set("meta_value",t),n):!1}}),Term=g.extend({modelName:"term",defaults:{term_id:0,name:"",slug:"",term_group:"",term_taxonomy_id:0,taxonomy:"",description:"",parent:"",count:0},idAttribute:"term_id",taxonomy:!1,fetchAttributes:["taxonomy"],saveAttributes:["taxonomy"],initialize:function(e,t){e&&e.taxonomy&&(this.taxonomy=e.taxonomy)},save:function(e){var t=this;return g.prototype.save.call(this,e).done(function(e){t.set("term_id",e.data.term_id)})}}),TermList=y.extend({collectionName:"term_list",model:Term,taxonomy:!1,taxonomyObject:!1,postId:!1,fetchAttributes:["taxonomy","postId"],saveAttributes:["taxonomy","postId"],parentAttribute:"parent",childrenAttribute:"children",initialize:function(e,t){t&&(t.taxonomy&&(this.taxonomy=t.taxonomy),t.postId&&(this.postId=t.postId))},fetch:function(e){var t=this;return y.prototype.fetch.call(this,e).done(function(e){t.taxonomyObject=e.data.taxonomy})}}),User=g.extend({modelName:"user",defaults:{ID:0,caps:[],cap_key:"",roles:[],allcaps:[],data:{}},idAttribute:"ID"}),Posts=e.Model.extend({initialize:function(){var t=arguments,n=t[0]||{};this.posts=n.posts?new e.Collection(n.posts):new e.Collection([]),this.pagination=n.pagination?new e.Model(n.pagination):new e.Model([])}}),Pages=Posts.extend({}),Comments=e.Model.extend({initialize:function(){var t=arguments,n=t[0]||{};this.comments=n.comments?new e.Collection(n.comments):new e.Collection([]),this.pagination=n.pagination?new e.Model(n.pagination):new e.Model([])}}),_omega="omega",{Models:{Property:r,ObjectModel:o,Module:a,Region:c,Wrapper:p,Layout:v,Taxonomy:m,Post:b,Posts:Posts,Pages:Pages,Comment:Comment,Comments:Comments,Meta:Meta,Term:Term,User:User},Collections:{Properties:s,Objects:u,Modules:f,Regions:h,Wrappers:d,CommentList:CommentList,MetaList:MetaList,PostList:w,TermList:TermList}}}),define("text",["module"],function(e){var t,n,r=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],i=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,s=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,o=typeof location!="undefined"&&location.href,u=o&&location.protocol&&location.protocol.replace(/\:/,""),a=o&&location.hostname,f=o&&(location.port||undefined),l=[],c=e.config&&e.config()||{};t={version:"2.0.3",strip:function(e){if(e){e=e.replace(i,"");var t=e.match(s);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:c.createXhr||function(){var e,t,n;if(typeof XMLHttpRequest!="undefined")return new XMLHttpRequest;if(typeof ActiveXObject!="undefined")for(t=0;t<3;t+=1){n=r[t];try{e=new ActiveXObject(n)}catch(i){}if(e){r=[n];break}}return e},parseName:function(e){var t=!1,n=e.indexOf("."),r=e.substring(0,n),i=e.substring(n+1,e.length);return n=i.indexOf("!"),n!==-1&&(t=i.substring(n+1,i.length),t=t==="strip",i=i.substring(0,n)),{moduleName:r,ext:i,strip:t}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,n,r,i){var s,o,u,a=t.xdRegExp.exec(e);return a?(s=a[2],o=a[3],o=o.split(":"),u=o[1],o=o[0],(!s||s===n)&&(!o||o.toLowerCase()===r.toLowerCase())&&(!u&&!o||u===i)):!0},finishLoad:function(e,n,r,i){r=n?t.strip(r):r,c.isBuild&&(l[e]=r),i(r)},load:function(e,n,r,i){if(i.isBuild&&!i.inlineText){r();return}c.isBuild=i.isBuild;var s=t.parseName(e),l=s.moduleName+"."+s.ext,h=n.toUrl(l),p=c.useXhr||t.useXhr;!o||p(h,u,a,f)?t.get(h,function(n){t.finishLoad(e,s.strip,n,r)},function(e){r.error&&r.error(e)}):n([l],function(e){t.finishLoad(s.moduleName+"."+s.ext,s.strip,e,r)})},write:function(e,n,r,i){if(l.hasOwnProperty(n)){var s=t.jsEscape(l[n]);r.asModule(e+"!"+n,"define(function () { return '"+s+"';});\n")}},writeFile:function(e,n,r,i,s){var o=t.parseName(n),u=o.moduleName+"."+o.ext,a=r.toUrl(o.moduleName+"."+o.ext)+".js";t.load(u,r,function(n){var r=function(e){return i(a,e)};r.asModule=function(e,t){return i.asModule(e,a,t)},t.write(e,u,r,s)},s)}};if(c.env==="node"||!c.env&&typeof process!="undefined"&&process.versions&&!!process.versions.node)n=require.nodeRequire("fs"),t.get=function(e,t){var r=n.readFileSync(e,"utf8");r.indexOf("")===0&&(r=r.substring(1)),t(r)};else if(c.env==="xhr"||!c.env&&t.createXhr())t.get=function(e,n,r){var i=t.createXhr();i.open("GET",e,!0),c.onXhr&&c.onXhr(i,e),i.onreadystatechange=function(t){var s,o;i.readyState===4&&(s=i.status,s>399&&s<600?(o=new Error(e+" HTTP status: "+s),o.xhr=i,r(o)):n(i.responseText))},i.send(null)};else if(c.env==="rhino"||!c.env&&typeof Packages!="undefined"&&typeof java!="undefined")t.get=function(e,t){var n,r,i="utf-8",s=new java.io.File(e),o=java.lang.System.getProperty("line.separator"),u=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(s),i)),a="";try{n=new java.lang.StringBuffer,r=u.readLine(),r&&r.length()&&r.charAt(0)===65279&&(r=r.substring(1)),n.append(r);while((r=u.readLine())!==null)n.append(o),n.append(r);a=String(n.toString())}finally{u.close()}t(a)};return t}),define("text!upfront/templates/object.html",[],function(){return'<div class="upfront-editable_entity upfront-object {{properties.class}}" id="{{properties.element_id}}" {[ if (height > 0){ ]}style="min-height: {{height}}px;"{[ } ]}>\r\n	<b class="upfront-entity_meta">\r\n		{[ if (parseInt(properties.has_settings, 10)) { ]} <a href="#" class="upfront-icon-button upfront-icon-button-setting upfront-entity-settings_trigger"></a> {[ } ]}\r\n		<!--<a href="#" class="upfront-icon-button upfront-icon-button-delete upfront-entity-delete_trigger"></a>-->\r\n	</b>\r\n	{[ if (buttons){ ]}\r\n	<b class="upfront-entity_meta upfront-entity_meta_extra">{{buttons}}</b>\r\n	{[ } ]}\r\n	<div class="upfront-object-content">\r\n		{{content}}\r\n	</div>\r\n</div>'}),define("text!upfront/templates/module.html",[],function(){return'<div class="upfront-editable_entity upfront-module {{properties.class}}" id="{{properties.element_id}}" {[ if (height > 0){ ]}style="min-height: {{height}}px;"{[ } ]} data-row="{{properties.row}}">\r\n	<b class="upfront-entity_meta">\r\n		{{name}} \r\n		{[ if (parseInt(properties.has_settings, 10)) { ]} <a href="#" class="upfront-icon-button upfront-icon-button-setting upfront-entity-settings_trigger"></a> {[ } ]}\r\n		{[ if (!properties.sticky) { ]} <a href="#" class="upfront-icon-button upfront-icon-button-delete upfront-entity-delete_trigger"></a> {[ } ]}\r\n	</b>\r\n	<div class="upfront-objects_container"></div>\r\n</div>'}),define("text!upfront/templates/region_container.html",[],function(){return'<div class="upfront-grid-layout">\r\n	<div class="upfront-grid-layout-gutter">\r\n		<div class="upfront-grid-layout-gutter-left"></div>\r\n		<div class="upfront-grid-layout-gutter-right"></div>\r\n	</div>\r\n</div>\r\n'}),define("text!upfront/templates/layout.html",[],function(){return'<section class="upfront-layout">\r\n\r\n</section>'}),function(e){define("views",["text!upfront/templates/object.html","text!upfront/templates/module.html","text!upfront/templates/region_container.html","text!upfront/templates/layout.html"],function(){var t=["text!upfront/templates/object.html","text!upfront/templates/module.html","text!upfront/templates/region_container.html","text!upfront/templates/layout.html"],n=arguments,r={};_(t).each(function(e,t){r[e.replace(/text!upfront\/templates\//,"").replace(/\.html/,"")]=n[t]});var i=_.clone(Backbone.Events),s={dispatcher:i},o={activate_condition:function(){return!1}},u={activate_condition:function(){var e=this.parent_module_view,t=e&&e.model?e.model:!1;return t?!!t.get("name").length:!0}},a={anchor:{is_target:!0,is_trigger:!1}},f=Backbone.View.extend(_.extend({},s,{initialize:function(){this.listenTo(this.model,"change",this.render),this.init&&this.init()},_get_full_size:function(e,t,n){var r=e.width(),i=e.height();if(!n){if(Math.round(i/r*100)/100>t){var s=i/t;return[s,i,(r-s)/2,0]}var o=r*t;return[r,o,0,(i-o)/2]}if(Math.round(i/r*100)/100<t){var s=i/t;return[s,i,(r-s)/2,0]}var o=r*t;return[r,o,0,(i-o)/2]},update_background:function(){var t=this.model.get_property_value_by_name("background_type"),n=this.model.get_property_value_by_name("background_color"),r=this.model.get_property_value_by_name("background_image"),i=parseFloat(this.model.get_property_value_by_name("background_image_ratio")),s=this.model.get_property_value_by_name("background_repeat"),o=this.model.get_property_value_by_name("background_position"),u=this.model.get_property_value_by_name("background_style"),a=this.$el.outerWidth(),f=this.$el.outerHeight(),l=this.$el.children(".upfront-region-bg-overlay");if(!t||t=="color"||t=="image"){n?this.$el.css("background-color",n):this.$el.css("background-color","");if(t!="color"&&r){this.$el.css("background-image","url('"+r+"')");if(u=="full"){var c=this._get_full_size(this.$el,i,!1);this.$el.css({backgroundSize:c[0]+"px "+c[1]+"px",backgroundRepeat:"no-repeat",backgroundPosition:"50% 50%"})}else this.$el.css({backgroundSize:"auto auto",backgroundRepeat:s,backgroundPosition:o})}else this.$el.css({backgroundImage:"none",backgroundSize:"",backgroundRepeat:"",backgroundPosition:""});l.length&&l.hide()}else{l.length?l.show():(l=e('<div class="upfront-region-bg-overlay" />'),this.$el.append(l));var h=l.find(".upfront-region-bg-"+t);h.length?h.show():(h=e('<div class="upfront-region-bg upfront-region-bg-'+t+'" />'),l.append(h)),l.find(".upfront-region-bg").not(h).hide(),this.$el.css({backgroundColor:"",backgroundImage:"none",backgroundSize:"",backgroundRepeat:"",backgroundPosition:""}),t=="map"?this.update_background_map(h,l):t=="slider"?this.update_background_slider(h,l):t=="video"&&this.update_background_video(h,l)}Upfront.Events.trigger("entity:background:update",this,this.model)},postpone_map_init:function(t,n){var r=this;e(document).one("upfront-google_maps-loaded",function(){r.update_background_map(t,n)})},update_background_map:function(e,t){try{if(!window.google.maps.Map)return this.postpone_map_init(e,t)}catch(n){return this.postpone_map_init(e,t)}var r=this.model.get_property_value_by_name("background_map_center"),i=this.model.get_property_value_by_name("background_map_zoom"),s=this.model.get_property_value_by_name("background_map_style"),o=this.model.get_property_value_by_name("background_map_styles"),u=this.model.get_property_value_by_name("background_map_controls"),a={center:new google.maps.LatLng(r[0],r[1]),zoom:parseInt(i),mapTypeId:google.maps.MapTypeId[s],panControl:u.indexOf("pan")>=0,zoomControl:u.indexOf("zoom")>=0,mapTypeControl:u.indexOf("map_type")>=0,scaleControl:u.indexOf("scale")>=0,streetViewControl:u.indexOf("street_view")>=0,overviewMapControl:u.indexOf("overview_map")>=0,scrollwheel:!1,styles:o};this.bg_map?(e.show(),this.bg_map.setOptions(a)):this.bg_map=new google.maps.Map(e.get(0),a)},update_background_slider:function(t,n){var r=this,i=this.model.get_property_value_by_name("background_slider_images"),s=this.model.get_property_value_by_name("background_slider_rotate"),o=this.model.get_property_value_by_name("background_slider_rotate_time"),u=this.model.get_property_value_by_name("background_slider_control"),a=this.model.get_property_value_by_name("background_slider_transition");i&&(s?(t.attr("data-slider-auto",1),t.attr("data-slider-interval",o*1e3)):t.attr("data-slider-auto",0),t.attr("data-slider-show-control",u),t.attr("data-slider-effect",a),this.slide_images!=i?Upfront.Views.Editor.ImageEditor.getImageData(i).done(function(n){var s=n.data.images;_.each(i,function(n){var r=s[n],i=e('<div class="upfront-default-slider-item" />');i.append('<img src="'+r.full[0]+'" />'),t.append(i)}),r.slide_images=i,t.trigger("refresh")}):t.trigger("refresh"))},update_background_video:function(t,n){var r=this,i=this.model.get_property_value_by_name("background_color"),s=this.model.get_property_value_by_name("background_video"),o=this.model.get_property_value_by_name("background_video_embed"),u=this.model.get_property_value_by_name("background_video_width"),a=this.model.get_property_value_by_name("background_video_height"),f=this.model.get_property_value_by_name("background_video_style")||"crop",l,c;f=="inside"&&i?this.$el.css("background-color",i):this.$el.css("background-color","");if(s&&o&&(this._prev_video&&this._prev_video!=s||!this._prev_video)){l=a/u,c=e(o),c.css("position","absolute").appendTo(t);if(f=="crop"||f=="inside"){var h=this._get_full_size(t,l,f=="inside");c.css({width:h[0],height:h[1],left:h[2],top:h[3]})}else f=="full"&&c.css({width:t.width(),height:t.height(),left:0,top:0});this._prev_video=s}else!s||!o?this.remove_background():this.refresh_background()},refresh_background:function(){var e=this.model.get_property_value_by_name("background_type"),t=this.model.get_property_value_by_name("background_color"),n=this.model.get_property_value_by_name("background_image");if(e=="map"&&this.bg_map)google.maps.event.trigger(this.bg_map,"resize");else if(e=="slider")this.$el.find(".upfront-region-bg-"+e).trigger("refresh");else if(e=="video"){var r=this.model.get_property_value_by_name("background_video"),i=this.model.get_property_value_by_name("background_video_embed"),s=this.model.get_property_value_by_name("background_video_width"),o=this.model.get_property_value_by_name("background_video_height"),u=this.model.get_property_value_by_name("background_video_style")||"crop",a,f=this.$el.find(".upfront-region-bg-"+e),l=f.children("iframe");if(r&&i){a=o/s;if(u=="crop"||u=="inside"){var c=this._get_full_size(f,a,u=="inside");l.css({width:c[0],height:c[1],left:c[2],top:c[3]})}else u=="full"&&l.css({width:f.width(),height:f.height(),left:0,top:0})}}else if((!e||e=="image")&&n){var u=this.model.get_property_value_by_name("background_style"),a=this.model.get_property_value_by_name("background_image_ratio"),s=this.$el.outerWidth(),o=this.$el.outerHeight();if(u=="full"){var c=this._get_full_size(this.$el,a,!1);this.$el.css({backgroundSize:c[0]+"px "+c[1]+"px",backgroundRepeat:"no-repeat",backgroundPosition:"50% 50%"})}}},remove_background:function(){var e=this.$el.find(".upfront-region-bg-overlay");e.length&&e.hide(),this.$el.css({backgroundColor:"",backgroundImage:"none",backgroundSize:"",backgroundRepeat:"",backgroundPosition:""})}})),l=f.extend({resort_bound_collection:function(){this.$el.trigger("resort",[this])},get_settings:function(){return""},on_click:function(){this.activate(),Upfront.Events.trigger("entity:contextmenu:deactivate",this)},deactivate:function(){this.$el.removeClass("upfront-active_entity"),this.check_deactivated(),this.trigger("upfront:entity:deactivate",this)},activate:function(){var e=this,t=Upfront.data.currentEntity;if(this.activate_condition&&!this.activate_condition())return!1;if(t&&t!=this){if(Upfront.data.currentEntity.$el.closest(e.$el).length)return;Upfront.data.currentEntity.trigger("deactivated"),Upfront.data.currentEntity.$el.removeClass("upfront-active_entity")}this instanceof ObjectView&&(Upfront.data.currentEntity=this),this.trigger("activated",this),this.$el.addClass("upfront-active_entity")},on_meta_click:function(){},on_delete_click:function(){return this.$el.trigger("upfront:entity:remove",[this]),!1},on_context_menu:function(e){e.preventDefault(),e.stopPropagation(),this.event=e,Upfront.Events.trigger("entity:contextmenu:activate",this)},on_settings_click:function(e){e.preventDefault(),Upfront.Events.trigger("entity:settings:activate",this)},check_deactivated:function(){Upfront.data.currentEntity==this&&(Upfront.data.currentEntity=!1)}}),c=l.extend({events:{click:"on_click",dblclick:"on_edit"},on_edit:function(){var e=this.$el.find("[contenteditable]");return e.length>0?e[0].focus():Upfront.Events.trigger("entity:settings:activate",this),!1}}),h=Backbone.View.extend(_.extend({},s,{initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"add",this.render),this.listenTo(this.model,"remove",this.render),this.init&&this.init()}})),p=h.extend({events:{resort:"on_resort_collection","upfront:entity:remove":"on_entity_remove"},on_resort_collection:function(){var t=[],n=this.model;return this.$el.find(".upfront-editable_entity").each(function(){var r=e(this).attr("id"),i=n.get_by_element_id(r);i&&t.push(i)}),this.model.reset(t),!1},on_entity_remove:function(e,t){t.remove(),this.model.remove(t.model)},on_activate:function(e){this.model.active_entity=e.model,Upfront.Events.trigger("entity:activated",e,e.model),this.trigger("activated")},deactivate:function(e){e==this.model.active_entity&&(this.model.active_entity=!1),Upfront.Events.trigger("entity:deactivated",e),this.trigger("deactivated")}}),d=Backbone.View.extend({tagName:"li",initialize:function(){this.label=this.options.get_label,this.action=this.options.action,typeof this.options.in_context=="function"&&(this.in_context=this.options.in_context)},render:function(){var e=this;this.$el.empty(),this.$el.append(this.label),this.$el.bind("click",function(){e.action(this.for_view),Upfront.Events.trigger("entity:contextmenu:deactivate",this)})},remove:function(){this.parent_view=!1,this.for_view=!1,Backbone.View.prototype.remove.call(this)},in_context:function(){return!0}}),v=Backbone.View.extend({tagName:"ul",initialize:function(){this.for_view=this.options.for_view},render:function(){var e=this;this.$el.empty(),this.menuitems.each(function(t){t.menulist||(t.menulist=e),t.for_view=e.for_view;if(!t.in_context())return;t.render(),t.parent_view=e,e.$el.append(t.el)})},remove:function(){this.menuitems&&this.menuitems.each(function(e){e.remove()}),this.for_view=!1,this.parent_view=!1,this.options=!1,Backbone.View.prototype.remove.call(this)}}),m=v.extend({initialize:function(){this.menuitems=_([new Upfront.Views.ContextMenuItem({get_label:function(){return"Save"},action:function(){var e=new Upfront.Views.Editor.Command_SaveLayout;e.on_click()}}),new Upfront.Views.ContextMenuItem({get_label:function(){return"Undo"},action:function(e){var t=new Upfront.Views.Editor.Command_Undo({model:Upfront.Application.layout});t.on_click()}}),new Upfront.Views.ContextMenuItem({get_label:function(){return Upfront.Application.get_gridstate()?"Hide Grid":"Show Grid"},action:function(){var e=new Upfront.Views.Editor.Command_ToggleGrid;e.on_click()}}),new Upfront.Views.ContextMenuItem({get_label:function(){return"Clone"},in_context:function(){return this.for_view instanceof Upfront.Views.ObjectView},action:function(){var e=this.for_view.parent_module_view,t=e.model,n=e.region.get("modules"),r=e.region.get("wrappers"),i=r.get_by_wrapper_id(t.get_property_value_by_name("wrapper_id")),s=Upfront.Util.model_to_json(t),o=new Upfront.Models.Module(s),u=Upfront.Util.get_unique_id("wrapper"),a=Upfront.Util.model_to_json(i),f=new Upfront.Models.Wrapper(a),l=n.indexOf(t),c=[];f.set_property("wrapper_id",u),o.set_property("wrapper_id",u),o.set_property("element_id",Upfront.Util.get_unique_id("module")),o.get("objects").each(function(e){e.set_property("element_id",Upfront.Util.get_unique_id("object"))}),r.add(f),o.add_to(n,l+1)}})])}}),g=Backbone.View.extend({initialize:function(){this.for_view=this.options.for_view,this.menulists=_([])},render:function(){var e=this;this.$el.empty().show(),this.menulists.each(function(t){t.for_view=e.for_view,t.render(),t.parent_view=e,e.$el.append(t.el)});var t=new m;t.for_view=e.for_view,t.render(),t.parent_view=e,e.$el.append(t.el),this.$el.css({position:"absolute","z-index":1e7}).offset({top:e.for_view.event.pageY,left:e.for_view.event.pageX}).addClass("uf-context-menu")},remove:function(){this.menulists&&this.menulists.each(function(e){e.remove()}),Backbone.View.prototype.remove.call(this),e("#contextmenu").length||e("body").append('<div id="contextmenu">')}});return ObjectView=c.extend({events:{"click .upfront-object > .upfront-entity_meta > a.upfront-entity-settings_trigger":"on_settings_click","click .upfront-object > .upfront-entity_meta > a.upfront-entity-delete_trigger":"on_delete_click","click .upfront-object > .upfront-entity_meta":"on_meta_click",click:"on_click",dblclick:"on_edit",contextmenu:"on_context_menu"},initialize:function(){this.listenTo(this.model.get("properties"),"change",this.render),this.listenTo(this.model.get("properties"),"add",this.render),this.listenTo(this.model.get("properties"),"remove",this.render),this.listenTo(Upfront.Events,"entity:resize_start",this.close_settings),this.listenTo(Upfront.Events,"entity:drag_start",this.close_settings),this.listenTo(Upfront.Events,"upfront:element:edit:start",this.on_element_edit_start),this.listenTo(Upfront.Events,"upfront:element:edit:stop",this.on_element_edit_stop),this.listenTo(Upfront.Events,"layout:after_render",this.on_after_layout_render),this.init&&this.init()},close_settings:function(){Upfront.Events.trigger("entity:settings:deactivate")},render:function(){var e={},t=e.row?e.row*Upfront.Settings.LayoutEditor.Grid.baseline:0,n=this.get_buttons?this.get_buttons():"",i=this.get_content_markup?this.get_content_markup():"",s,o;this.model.get("properties").each(function(t){e[t.get("name")]=t.get("value")}),e.theme_style&&(e.class+=" "+e.theme_style),s=_.extend(this.model.toJSON(),{properties:e,buttons:n,content:i,height:t}),o=_.template(r.object,s),Upfront.Events.trigger("entity:object:before_render",this,this.model),this.parent_module_view&&(this.stopListening(this._previous_parent_module_view||this.parent_module_view,"entity:resize"),this.listenTo(this.parent_module_view,"entity:resize",this.on_element_resize),this.stopListening(this._previous_parent_module_view||this.parent_module_view,"entity:drop"),this.listenTo(this.parent_module_view,"entity:drop",this.on_element_drop)),this.$el.html(o),typeof this.subview!="undefined"&&this.subview.setElement(this.$(".upfront-object-content")).render(),Upfront.Events.trigger("entity:object:after_render",this,this.model),this.on_render&&this.on_render()},on_element_edit_start:function(e,t){e=="write"&&this.parent_module_view&&this.parent_module_view.disable()},on_element_edit_stop:function(e,t){this.parent_module_view&&this.parent_module_view.enable&&this.parent_module_view.enable()},on_element_resize:function(e){},on_element_drop:function(e){},on_after_layout_render:function(){},get_element_size:function(e){var t=Upfront.Behaviors.GridEditor,e=typeof e=="undefined"?!0:e;t.start(this.parent_module_view,this.parent_module_view.model);var n=t.get_position(this.parent_module_view.$el.find(".upfront-module"));return{col:n.col,row:e?n.row:this.model.get_property_value_by_name("row")}},get_element_columns:function(){return this.get_element_size().col},get_element_rows:function(){return this.get_element_size().row},get_element_size_px:function(e){var t=Upfront.Behaviors.GridEditor,e=typeof e=="undefined"?!0:e,n=this.get_element_size(e);return{col:n.col*t.col_size,row:n.row*t.baseline}},get_element_columns_px:function(){return this.get_element_size_px().col},get_element_rows_px:function(){return this.get_element_size_px().row},get_element_max_size:function(e){var t=Upfront.Behaviors.GridEditor,n=this.parent_module_view.$el.find(".upfront-module"),r=this.$el.closest(".upfront-region");return t.start(this.parent_module_view,this.parent_module_view.model),t.get_max_size(t.get_el(n),t.els,t.get_region(r),e)},get_element_max_columns:function(e){return this.get_element_max_size(e).col},get_element_max_rows:function(e){return this.get_element_max_size(e).row},get_element_max_size_px:function(e){var t=Upfront.Behaviors.GridEditor,n=this.get_element_max_size(e);return{col:n.col*t.col_size,row:n.row*t.baseline}},get_element_max_columns_px:function(e){return this.get_element_max_size_px(e).col},get_element_max_rows_px:function(e){return this.get_element_max_size_px(e).row},set_element_size:function(e,t,n,r){return Upfront.Behaviors.GridEditor.resize(this.parent_module_view,this.parent_module_view.model,e,t,n,r)},cleanup:function(){},remove:function(){this.cleanup(),this.parent_view=!1,this.parent_module_view=!1,Backbone.View.prototype.remove.call(this)}}),Objects=p.extend({attributes:{"class":"upfront-editable_entities_container"},render:function(){var e=this.$el,t=this;e.html(""),typeof Upfront.data.object_views=="undefined"&&(Upfront.data.object_views={}),this.model.each(function(n){var r=n.get("properties").where({name:"view_class"}),i=r.length?r[0].get("value"):"ObjectView",s=Upfront.Views[i]?Upfront.data.object_views[n.cid]||new Upfront.Views[i]({model:n}):!1;s&&(s.parent_view=t,s._previous_parent_module_view=s.parent_module_view,s.parent_module_view=t.parent_view,s.render(),e.append(s.el),Upfront.data.object_views[n.cid]?s.delegateEvents():(t.listenTo(s,"upfront:entity:activate",t.on_activate),t.listenTo(s.model,"remove",t.deactivate),Upfront.data.object_views[n.cid]=s))})},remove:function(){this.model&&this.model.each(function(e){var t=Upfront.data.object_views[e.cid];t&&(t.remove(),delete Upfront.data.object_views[e.cid])}),this.parent_view=!1,Backbone.View.prototype.remove.call(this),this.model&&(this.model.reset([],{silent:!0}),this.model=!1)}}),Module=l.extend({events:{"click .upfront-module > .upfront-entity_meta > a.upfront-entity-settings_trigger":"on_settings_click","click .upfront-module > .upfront-entity_meta > a.upfront-entity-delete_trigger":"on_delete_click","click .upfront-module > .upfront-entity_meta":"on_meta_click",click:"on_click"},initialize:function(){var e=this.update||this.render;this.listenTo(this.model.get("properties"),"change",e),this.listenTo(this.model.get("properties"),"add",e),this.listenTo(this.model.get("properties"),"remove",e),this.on("on_layout",this.render_object,this),this.on("region:updated",this.on_region_update,this)},render:function(){var e={},t=this.model.get("properties").each(function(t){e[t.get("name")]=t.get("value")}),n=e.row?e.row*Upfront.Settings.LayoutEditor.Grid.baseline:0,i=_.extend(this.model.toJSON(),{properties:e,height:n}),s=_.template(r.module,i);Upfront.Events.trigger("entity:module:before_render",this,this.model),this.$el.html(s),this.model.get("shadow")?this.$el.find(".upfront-editable_entity:first").attr("data-shadow",this.model.get("shadow")):this.render_object(),this.$el.is(".upfront-active_entity")&&this.$el.trigger("upfront-editable_entity-selected",[this.model,this]),Upfront.Events.trigger("entity:module:after_render",this,this.model)},update:function(e,t){var n=e._previousAttributes.value,r=e.get("value"),i=this.$el.find(".upfront-editable_entity:first"),s=Upfront.Settings.LayoutEditor.Grid;if(e.id=="row"){var o=r*s.baseline;i.css("min-height",o).attr("data-row",r)}else if(e.id=="class"){var u=i.attr("class");_.each([s.class,s.left_margin_class,s.top_margin_class,s.bottom_margin_class,s.right_margin_class],function(e){var t=new RegExp("\\b"+e+"(\\d+)"),n=r.match(t);n&&n[1]&&Upfront.Behaviors.GridEditor.update_class(i,e,n[1])})}},render_object:function(){var e=this._objects_view||new Objects({model:this.model.get("objects")});e.parent_view=this,e.render(),this.$(".upfront-objects_container").append(e.el),this._objects_view?this._objects_view.delegateEvents():this._objects_view=e},disable:function(){this.$el.find(".upfront-editable_entity:first").addClass("upfront-module-disabled")},enable:function(){this.$el.find(".upfront-editable_entity:first").removeClass("upfront-module-disabled")},on_resize:function(e){},on_drop:function(e){},on_region_update:function(){this._objects_view&&this._objects_view.model.each(function(e){e.trigger("region:updated")})},remove:function(){this._objects_view&&this._objects_view.remove(),Backbone.View.prototype.remove.call(this)}}),Modules=p.extend({attributes:{"class":"upfront-editable_entities_container"},init:function(){this.stopListening(this.model,"add",this.render),this.listenTo(this.model,"add",this.on_add),this.stopListening(this.model,"remove",this.render),this.listenTo(this.model,"remove",this.on_remove),this.listenTo(this.model,"reset",this.on_reset)},on_entity_remove:function(e,t){Upfront.Events.trigger("entity:removed:before");var n=t.model.get_wrapper_id(),r=this;if(n){var i=this.region_view.model.get("wrappers"),s=i.get_by_wrapper_id(n),o=0;s&&(this.model.each(function(e){e.get_wrapper_id()==n&&o++}),o==1&&(Upfront.Behaviors.GridEditor.normalize_module_remove(t,t.model,this.model,s,i),i.remove(s)))}t.remove(),this.model.remove(t.model),Upfront.Events.trigger("entity:removed:after")},render:function(){this.$el.html("");var e=this.$el,t=this;this.current_wrapper_id=this.current_wrapper_el=null,typeof Upfront.data.module_views=="undefined"&&(Upfront.data.module_views={}),typeof Upfront.data.wrapper_views=="undefined"&&(Upfront.data.wrapper_views={}),this.model.each(function(e){t.render_module(e)})},render_module:function(t,n){var r=this.$el,i=n&&typeof n.index!="undefined"?n.index-1:-2,s=t.get("properties").where({name:"view_class"}),o=s.length?s[0].get("value"):"Module",u=Upfront.Views[o]?Upfront.data.module_views[t.cid]||new Upfront.Views[o]({model:t}):!1,a=this.region_view.model.get("wrappers"),f=t.get_wrapper_id(),l=a&&f?a.get_by_wrapper_id(f):!1,c,h;u&&(u.region_view=this.region_view,u.region=this.region_view.model,l?(this.current_wrapper_id==f?h=this.current_wrapper_el:(c=Upfront.data.wrapper_views[l.cid]||new Upfront.Views.Wrapper({model:l}),c.render(),h=c.el),this.current_wrapper_id=f,this.current_wrapper_el=h,u.render(),e(h).append(u.el),c&&(i===-2?r.append(h):i===-1?r.prepend(h):r.find(".upfront-module").eq(i).closest(".upfront-wrapper").after(h),Upfront.data.wrapper_views[l.cid]||(Upfront.data.wrapper_views[l.cid]=c))):(u.render(),i===-2?r.append(u.el):i===-1?r.prepend(u.el):r.find(".upfront-module").eq(i).parent().after(u.el)),Upfront.data.module_views[t.cid]?u.delegateEvents():(this.listenTo(u,"upfront:entity:activate",this.on_activate),this.listenTo(u.model,"remove",this.deactivate),Upfront.data.module_views[t.cid]=u))},on_add:function(e,t,n){this.current_wrapper_id=this.current_wrapper_el=null,this.render_module(e,n)},on_remove:function(e){var t=Upfront.data.module_views[e.cid];if(!t)return;t.unbind(),t.remove(),delete Upfront.data.module_views[e.cid]},on_reset:function(e,t){var n=this;t&&t.call_render&&_.each(t.call_render,function(t){var r=e.indexOf(t);n.render_module(t,{index:r})})},remove:function(){var e=this;this.model.each(function(t){e.on_remove(t)}),Backbone.View.prototype.remove.call(this),this.model.reset([],{silent:!0}),this.model=!1}}),RegionContainer=f.extend({events:{"click .upfront-region-edit-trigger":"trigger_edit","click .upfront-region-finish-edit":"close_edit",contextmenu:"on_context_menu",mouseover:"update_pos"},attributes:function(){var e=this.model.get("container")||this.model.get("name"),t=[];return t.push("upfront-region-container"),t.push("upfront-region-container-"+e.toLowerCase().replace(/ /,"-")),t.push("upfront-region-container-"+this._get_region_type()),this.model.collection.active_region==this.model&&t.push("upfront-region-container-active"),{"class":t.join(" ")}},_get_region_type:function(){return this.model.get("type")||(this.model.get("clip")?"clip":"wide")},_get_previous_region_type:function(){return this.model.previous("type")||(this.model.previous("clip")?"clip":"wide")},remove_context_menu:function(t){if(!this.context_menu_view)return!1;e(Upfront.Settings.LayoutEditor.Selectors.contextmenu).html("").hide(),this.context_menu_view=!1},on_context_menu:function(t){t.preventDefault(),this.event=t;if(this.context_menu_view)return this.context_menu_view.render();var n=new this.ContextMenu({model:this.model,el:e(Upfront.Settings.LayoutEditor.Selectors.contextmenu)});n.for_view=this,this.context_menu_view=n,n.render()},init:function(){var t=this,n=Upfront.Views.ContextMenuList.extend({initialize:function(){this.menuitems=_([new Upfront.Views.ContextMenuItem({get_label:function(){var t=e(Upfront.Settings.LayoutEditor.Selectors.main);return t.hasClass("upfront-region-editing")?"Finish Editing":"Edit Background"},action:function(){var n=e(Upfront.Settings.LayoutEditor.Selectors.main);n.hasClass("upfront-region-editing")?t.close_edit():t.trigger_edit(t.event)}})])}});this.ContextMenu=Upfront.Views.ContextMenu.extend({initialize:function(){this.menulists=_([new n])}});var r=Upfront.Settings.LayoutEditor.Grid;this.listenTo(this.model.get("properties"),"change",this.update),this.listenTo(this.model.get("properties"),"add",this.update),this.listenTo(this.model.get("properties"),"remove",this.update),this.sub_model=[],this.available_col=r.size,this.listenTo(Upfront.Events,"entity:region:activated",this.update_pos),this.listenTo(Upfront.Events,"entity:region:activated",this.update_overlay),this.listenTo(Upfront.Events,"entity:region:deactivated",this.close_edit),e(window).on("scroll",this,this.on_scroll),this.listenTo(Upfront.Events,"layout:render",this.fix_height),this.listenTo(Upfront.Events,"entity:resize_stop",this.fix_height),this.listenTo(Upfront.Events,"entity:region:resize_stop",this.fix_height),this.listenTo(Upfront.Events,"entity:region_container:resize_stop",this.fix_height),this.listenTo(Upfront.Events,"entity:region_container:resize_stop",this.update_overlay),this.listenTo(Upfront.Events,"entity:drag_stop",this.fix_height),this.listenTo(Upfront.Events,"entity:drag:drop_change",this.refresh_background),this.listenTo(Upfront.Events,"entity:region:added",this.fix_height),this.listenTo(Upfront.Events,"entity:region:removed",this.fix_height),this.listenTo(Upfront.Events,"entity:region:removed",this.close_edit),this.listenTo(Upfront.Events,"entity:contextmenu:deactivate",this.remove_context_menu)},render:function(){var t=this._get_region_type(),n=_.template(r.region_container,this.model.toJSON()),i=e('<div class="upfront-region-edit-trigger tooltip tooltip-left upfront-ui" data-tooltip="Change Background"><i class="upfront-icon upfront-icon-region-edit"></i></div>'),s=e('<div class="upfront-region-finish-edit upfront-ui"><i class="upfront-field-icon upfront-field-icon-tick"></i> Finish editing background</div>');Upfront.Events.trigger("entity:region_container:before_render",this,this.model),this.$el.html(n),this.$layout=this.$el.find(".upfront-grid-layout"),i.appendTo(this.$el),s.appendTo(this.$el),this.update(),this.$el.append('<div class="upfront-region-active-overlay" />'),Upfront.Events.trigger("entity:region_container:after_render",this,this.model)},update:function(){var e=this.model.get_property_value_by_name("expand_lock"),t=this._get_region_type(),n=this._get_previous_region_type();t!="clip"?this.update_background():this.remove_background(),this.$el.removeClass("upfront-region-container-"+n),this.$el.addClass("upfront-region-container-"+t),n!=t&&(this.fix_height(),this.update_overlay())},trigger_edit:function(t){if(Upfront.Application.get_current()!=Upfront.Settings.Application.MODE.LAYOUT)return!1;var n=e(Upfront.Settings.LayoutEditor.Selectors.main);n.addClass("upfront-region-editing"),this.update_overlay(),Upfront.Events.trigger("command:region:edit_toggle",!0),this.trigger("activate_region",this),this.listenTo(Upfront.Events,"command:newpage:start",this.close_edit),this.listenTo(Upfront.Events,"command:newpost:start",this.close_edit)},close_edit:function(){var t=e(Upfront.Settings.LayoutEditor.Selectors.main);t.removeClass("upfront-region-editing"),this.$el.siblings(".upfront-region-editing-overlay").remove(),Upfront.Events.trigger("command:region:edit_toggle",!1),Upfront.Events.off("command:newpage:start",this.close_edit,this),Upfront.Events.off("command:newpost:start",this.close_edit,this)},update_overlay:function(){var t=e(Upfront.Settings.LayoutEditor.Selectors.main),n=this.$el.position(),r=e('<div class="upfront-region-editing-overlay" />'),i=e('<div class="upfront-region-editing-overlay" />');if(!t.hasClass("upfront-region-editing"))return;if(this.parent_view.model.active_region!=this.model)return;this.$el.siblings(".upfront-region-editing-overlay").remove(),this.$el.before(r),r.css({bottom:"auto",height:n.top}),this.$el.after(i),i.css({top:n.top+this.$el.height()})},add_sub_model:function(e){this.sub_model.push(e)},on_scroll:function(e){var t=e.data;t.update_pos()},on_region_render:function(e){},on_region_update:function(e){var t=Upfront.Settings.LayoutEditor.Grid,n=t.size;_.each(this.sub_model,function(e){n-=e.get_property_value_by_name("col")}),this.available_col!=n&&(this.trigger("region_resize",n),this.available_col=n),this.fix_height(),this.update_overlay()},on_region_changed:function(){this.fix_height()},fix_height:function(){var t=this.$el.find(".upfront-region"),n=this.model.get_property_value_by_name("row"),r=this._get_region_type()=="full",i=n?n*Upfront.Settings.LayoutEditor.Grid.baseline:0,s=0,o=[];t.css({minHeight:"",height:"",maxHeight:""}),r?(s=e(window).height(),t.each(function(){e(this).closest(".upfront-region-sub-container").length&&(i>0&&e(this).css("min-height",i),s-=e(this).outerHeight(),o.push(this))}),t.each(function(){_.indexOf(o,this)===-1&&e(this).css({minHeight:s,height:s,maxHeight:s})})):(t.each(function(){i>0&&e(this).css("min-height",i);var t=e(this).outerHeight();s=t>s?t:s}),s=s>i?s:i,t.css("min-height",s)),this.refresh_background()},update_pos:function(){var t=e(Upfront.Settings.LayoutEditor.Selectors.main),n=this.$el.offset(),r=n.top,i=r+this.$el.outerHeight(),s=e(document).scrollTop(),o=s+e(window).height(),u=t.offset().top,a=this.$el.find(".upfront-region-edit-trigger"),f=a.offset();s>r-u&&s<i-u?a.css("position")!="fixed"&&a.css({position:"fixed",top:u,left:f.left,right:"auto"}):a.css({position:"",top:"",left:"",right:""});if(t.hasClass("upfront-region-editing")&&this.$el.hasClass("upfront-region-container-active")){var l=this.$el.find(".upfront-region-finish-edit"),c=l.offset();i+l.outerHeight()>o&&r<o?l.css("position")!="fixed"&&l.css({position:"fixed",bottom:0,left:c.left,right:"auto"}):l.css({position:"",bottom:"",left:"",right:""})}},remove:function(){e(window).off("scroll",this,this.on_scroll),this.context_menu_view&&this.context_menu_view.remove(),this.parent_view=!1,this.event=!1,Backbone.View.prototype.remove.call(this)}}),RegionSubContainer=f.extend({attributes:function(){var e=this.model.get("container")||this.model.get("name"),t=[];return t.push("upfront-region-sub-container"),t.push("upfront-region-sub-container-"+e.toLowerCase().replace(/ /,"-")),{"class":t.join(" ")}},init:function(){this.listenTo(this.model.get("properties"),"change",this.update),this.listenTo(this.model.get("properties"),"add",this.update),this.listenTo(this.model.get("properties"),"remove",this.update),this.listenTo(Upfront.Events,"layout:after_render",this.refresh_background),this.listenTo(Upfront.Events,"entity:resize_stop",this.refresh_background),this.listenTo(Upfront.Events,"entity:region:resize_stop",this.refresh_background),this.listenTo(Upfront.Events,"entity:region_container:resize_stop",this.refresh_background),this.listenTo(Upfront.Events,"entity:drag_stop",this.refresh_background),this.listenTo(Upfront.Events,"entity:drag:drop_change",this.refresh_background)},_get_region_type:function(){return this.model.get("type")||(this.model.get("clip")?"clip":"wide")},render:function(){var e=_.template(r.region_container,this.model.toJSON());this.$el.html(e),this.$layout=this.$el.find(".upfront-grid-layout"),this.update()},update:function(){var e=this.parent_view.get_container_view(this.model);e&&e._get_region_type()=="full"?(this.update_background(),this.$el.show()):this.$el.hide()},remove:function(){this.event=!1,Backbone.View.prototype.remove.call(this)}}),Region=f.extend({events:{mouseover:"on_mouse_over",click:"on_click"},attributes:function(){var e=Upfront.Settings.LayoutEditor.Grid,t=this.model.get("name"),n=[];return this.col||(this.col=this.model.get_property_value_by_name("col")||e.size),n.push("upfront-region"),n.push("upfront-region-"+t.toLowerCase().replace(/ /,"-")),n.push(e.class+this.col),this.model.get("type")=="clip"&&n.push("upfront-region-clip"),this.model.collection.active_region==this.model&&n.push("upfront-region-active"),{"class":n.join(" ")}},init:function(){var e=this.model.get("container"),t=this.model.get("name");this.listenTo(this.dispatcher,"plural:propagate_activation",this.on_mouse_up),this.listenTo(this.model.get("properties"),"change",this.update),this.listenTo(this.model.get("properties"),"add",this.update),this.listenTo(this.model.get("properties"),"remove",this.update),this.listenTo(this.model.get("modules"),"change",this.on_module_update),this.listenTo(this.model.get("modules"),"add",this.on_module_update),this.listenTo(this.model.get("modules"),"remove",this.on_module_update),this.listenTo(Upfront.Events,"layout:after_render",this.refresh_background),this.listenTo(Upfront.Events,"entity:resize_stop",this.refresh_background),this.listenTo(Upfront.Events,"entity:region:resize_stop",this.refresh_background),this.listenTo(Upfront.Events,"entity:region_container:resize_stop",this.refresh_background),this.listenTo(Upfront.Events,"entity:drag_stop",this.refresh_background),this.listenTo(Upfront.Events,"entity:drag:drop_change",this.refresh_background)},on_click:function(e){},on_mouse_up:function(){this.trigger("activate_region",this)},on_mouse_over:function(){var e=this.parent_view.get_container_view(this.model);e&&e.$el.hasClass("upfront-region-container-active")&&this.trigger("activate_region",this)},_is_clipped:function(){var e=this.model.get("type"),t=this.model.get("sub");return e=="clip"||!e&&this.model.get("clip")||!this.model.is_main()&&(!t||t!="top"&&t!="bottom")},render:function(){var e=this.model.get("container"),t=this.model.get("name");Upfront.Events.trigger("entity:region:before_render",this,this.model),this.$el.html('<div class="upfront-debug-info"/>'),this.$el.data("name",t),this.$el.attr("data-title",this.model.get("title")),this.$el.append('<div class="upfront-region-title">'+this.model.get("title")+"</div>"),this.update();if(!this.model.is_main()){var n=this.model.collection.indexOf(this.model),r=this.model.get("sub"),i=this.model.collection.at(n+1),s=i&&(i.get("name")==e||i.get("container")==e);this.$el.addClass("upfront-region-side "+("upfront-region-side-"+(r?r:s?"left":"right")))}var o=this._modules_view||new Modules({model:this.model.get("modules")});o.region_view=this,o.render(),this.$el.append(o.el),this.region_panels=new Upfront.Views.Editor.RegionPanels({model:this.model}),this.region_panels.render(),this.$el.append(this.region_panels.el),Upfront.Events.trigger("entity:region:after_render",this,this.model),this.trigger("region_render",this),this._modules_view?this._modules_view.delegateEvents():this._modules_view=o},update:function(){var e=this.model.get("container"),t=this.model.get("name"),n=this.model.get_property_value_by_name("col"),r=this.model.get_property_value_by_name("row"),i=r?r*Upfront.Settings.LayoutEditor.Grid.baseline:0,s=this.model.get_property_value_by_name("expand_lock");n&&n!=this.col&&this.region_resize(n),i>0?this.$el.css("min-height",i+"px"):this.$el.css("min-height",""),s?this.$el.addClass("upfront-region-expand-lock"):this.$el.removeClass("upfront-region-expand-lock"),this._is_clipped()?this.update_background():this.remove_background(),this.trigger("region_update",this)},region_resize:function(e){this.col=e,this.$el.attr("class",this.attributes().class)},on_module_update:function(){this.trigger("region_changed",this)},remove:function(){this._modules_view&&this._modules_view.remove();var e=this.model.get("wrappers");e&&e.each(function(e){var t=Upfront.data.wrapper_views[e.cid];t&&(t.remove(),delete Upfront.data.wrapper_views[e.cid])}),this.parent_view=!1,Backbone.View.prototype.remove.call(this),this.model.get("wrappers").reset([],{silent:!0}),this.model=!1}}),Regions=h.extend({allow_edit:!1,init:function(){this.stopListening(this.model,"add",this.render),this.listenTo(this.model,"add",this.on_add),this.stopListening(this.model,"remove",this.render),this.listenTo(this.model,"remove",this.on_remove),this.listenTo(this.model,"reset",this.on_reset),this.listenTo(Upfront.Events,"command:region:edit_toggle",this.on_edit_toggle),this.listenTo(Upfront.Events,"entity:region:resize_start",this.pause_edit),this.listenTo(Upfront.Events,"entity:region:resize_stop",this.resume_edit),this.listenTo(Upfront.Events,"entity:region:deactivated",this.deactivate_region)},render:function(){this.$el.html("");var e=this;typeof this.container_views=="undefined"&&(this.container_views={}),typeof this.sub_container_views=="undefined"&&(this.sub_container_views={}),typeof Upfront.data.region_views=="undefined"&&(Upfront.data.region_views={}),this.model.each(function(t){e.render_container(t)}),this.model.each(function(t,n){e.render_region(t)})},render_container:function(e,t){var n=e.get("container"),r=e.get("name");if(e.is_main()){var i=this.container_views[e.cid]||new RegionContainer({model:e});i.parent_view=this,i.render(),this.listenTo(i,"activate_region",this.activate_region_container),t>=0?this.$el.find(".upfront-region").eq(t).closest(".upfront-region-container").before(i.el):this.$el.append(i.el),this.container_views[e.cid]?i.delegateEvents():this.container_views[e.cid]=i}},render_region:function(e,t){var n=Upfront.data.region_views[e.cid]||new Region({model:e}),r=this.get_container_view(e),t=t?t:e.get("sub"),i;Upfront.data.region_views[e.cid]?(n.render(),n.delegateEvents()):(n.parent_view=this,r.listenTo(n,"region_render",r.on_region_render),r.listenTo(n,"region_update",r.on_region_update),r.listenTo(n,"region_changed",r.on_region_changed),!e.get("container")||e.get("container")==e.get("name")?n.listenTo(r,"region_resize",n.region_resize):r.add_sub_model(e),n.render(),this.listenTo(n,"activate_region",this.activate_region),Upfront.data.region_views[e.cid]=n);if(!t||t=="left")r.$layout.prepend(n.el);else if(t=="right")r.$layout.append(n.el);else if(t=="top"||t=="bottom")i=this.sub_container_views[e.cid]||new RegionSubContainer({model:e}),i.parent_view=this,i.listenTo(r.model.get("properties"),"change",i.update),i.render(),i.$layout.append(n.el),t=="top"?r.$layout.before(i.el):r.$layout.after(i.el),this.sub_container_views[e.cid]?i.delegateEvents():this.sub_container_views[e.cid]=i;e.get("default")&&n.trigger("activate_region",n)},get_container_view:function(e){return _.find(this.container_views,function(t){var n=t.model.get("container")||t.model.get("name");if(e.get("container")==n||e.get("name")==n)return!0})},activate_region:function(t){if(!this.allow_edit)return;var n=t.model||t,r=this.get_container_view(n);if(this.model.active_region==n)return;this.model.active_region=n;if(t.$el){e(".upfront-region-active").removeClass("upfront-region-active"),t.$el.addClass("upfront-region-active");var r=this.get_container_view(t.model);r&&(e(".upfront-region-container-active").removeClass("upfront-region-container-active"),r.$el.addClass("upfront-region-container-active")),Upfront.Events.trigger("entity:region:activated",t)}},deactivate_region:function(){if(!this.allow_edit||!this.model.active_region)return;e(".upfront-region-active").removeClass("upfront-region-active"),e(".upfront-region-container-active").removeClass("upfront-region-container-active"),this.model.active_region=null},activate_region_container:function(e){var t=Upfront.data.region_views[e.model.cid];t&&t.trigger("activate_region",t)},pause_edit:function(){this.allow_edit=!1},resume_edit:function(){this.allow_edit=!0},on_edit_toggle:function(e){this.allow_edit=e},on_add:function(e,t,n){var r=this.get_container_view(e),i=typeof n.index!="undefined"?n.index:-1,s=n.sub?n.sub:!1;r?this.render_region(e,s):(this.render_container(e,i),this.render_region(e)),Upfront.Events.trigger("entity:region:added",this,this.model)},on_remove:function(e){var t=Upfront.data.region_views[e.cid];if(!t)return;var n=this.get_container_view(e);delete Upfront.data.region_views[e.cid],t.region_panels.unbind(),t.region_panels.remove(),t.unbind(),t.remove();if(n)if(n.sub_model.length==0)delete this.container_views[n.model.cid],n.unbind(),n.remove();else{var r=Upfront.data.region_views[n.model.cid];_.each(n.sub_model,function(t,r){if(t==e)n.sub_model.splice(r,1);else{var i=Upfront.data.region_views[t.cid];i&&i.update()}}),r&&r.update()}Upfront.Events.trigger("entity:region:removed",this,this.model)},remove:function(){var e=this;this.model.each(function(t){e.on_remove(t)}),Backbone.View.prototype.remove.call(this),this.container_views=!1,this.model.reset([],{silent:!0}),this.model=!1,this.options=!1}}),Wrapper=f.extend({attributes:function(){var e="upfront-wrapper",t=this.model.get_property_value_by_name("class");return{"class":e+" "+t,id:this.model.get_wrapper_id()}},init:function(){this.listenTo(this.model.get("properties"),"change",this.update),this.listenTo(this.model,"remove",this.on_remove)},update:function(){this.$el.attr("class",this.attributes().class)},render:function(){},on_remove:function(){this.unbind(),this.remove()}}),Layout=h.extend({tpl:_.template(r.layout),events:{click:"on_click"},initialize:function(){this.render()},render:function(){this.$el.html(this.tpl(this.model.toJSON())),this.local_view||(this.local_view=new Regions({model:this.model.get("regions")})),this.local_view.render(),this.$("section").append(this.local_view.el),Upfront.Events.trigger("layout:after_render")},on_click:function(t){var n=document.getSelection?document.getSelection():document.selection;if(n&&n.type=="Range")return;var r=Upfront.data.currentEntity;!e(t.target).closest(".upfront-entity_meta").length&&!e(t.target).closest("#upfront-csseditor").length&&Upfront.Events.trigger("entity:settings:deactivate"),Upfront.Events.trigger("entity:contextmenu:deactivate"),r&&(e(t.target).closest(r.el).length||(r.trigger("deactivated"),r.$el.removeClass("upfront-active_entity"),Upfront.Events.trigger("entity:deactivated"),Upfront.data.currentEntity=!1)),(!e(t.target).closest(".upfront-region-container-active").length||!e(t.target).closest(".upfront-inline-panels"))&&Upfront.Events.trigger("entity:region:deactivated")},remove:function(){this.local_view&&this.local_view.remove(),this.local_view=null,Backbone.View.prototype.remove.call(this),this.model=!1,this.options=!1}}),{Views:{ObjectView:ObjectView,Module:Module,Wrapper:Wrapper,Layout:Layout,ContextMenu:g,ContextMenuList:v,ContextMenuItem:d},Mixins:{FixedObject:o,FixedObjectInAnonymousModule:u,Anchorable:a}}})}(jQuery),define("text!upfront/templates/property.html",[],function(){return'<dt class="upfront-property">{{name}}</dt>\r\n<dd class="upfront-property">\r\n	{{value}}\r\n	<div class="upfront-property-actions">\r\n		<a href="#" class="upfront-property-change">Edit</a>\r\n		<a href="#" class="upfront-property-remove">Remove</a>\r\n	</div>\r\n</dd>'}),define("text!upfront/templates/properties.html",[],function(){return'<h3>{{name}}</h3>\r\n\r\n<dl class="upfront-properties_collection">\r\n</dl>\r\n\r\n<button type="button" id="add-property">Add new</button>\r\n\r\n<div id="upfront-new_property" style="display:none">\r\n	<input type="text" id="upfront-new_property-name" placeholder="name" />\r\n	<input type="text" id="upfront-new_property-value" placeholder="value" />\r\n	<button type="button" id="done-adding-property">Add</button>\r\n</div>'}),define("text!upfront/templates/property_edit.html",[],function(){return'<input type="text" id="upfront-new_property-name" placeholder="name" value="{{name}}" />\r\n<input type="text" id="upfront-new_property-value" placeholder="value" value="{{value}}" />\r\n<button type="button" class="upfront-property-save">Save</button>'}),define("text!upfront/templates/overlay_grid.html",[],function(){return'<div class="upfront-overlay-grid upfront-overlay-grid-{{style}}">\r\n	{[ _(columns).times(function(i){ var c = i+1; ]}<div class="c1 t1 m1 upfront-grid-border">{{c}}</div>{[ }) ]}\r\n</div>\r\n'}),define("text!upfront/templates/edit_background_area.html",[],function(){return'<div class="command-edit-label">Edit background areas</div>\r\n<div class="command-edit-switcher">\r\n	<span class="switch switch-off">Off</span>\r\n	<span class="switch switch-on">On</span>\r\n	<span class="knob"></span>\r\n</div>'}),define("text!upfront/templates/sidebar_settings_lock_area.html",[],function(){return'<div class="panel-setting-item">\r\n	<div class="region-lock-switch upfront-icon upfront-icon-unlock {{lock_class}}">Click here to lock header and footer areas in place.</div>\r\n</div>\r\n<div class="panel-setting-dialog panel-setting-dialog-info">When unlocked, header and footer area will allow you to place elements inside them.</div>'}),define("text!upfront/templates/sidebar_settings_background.html",[],function(){return'<div class="panel-setting-item">\r\n	<div class="panel-setting-sub-label">Background:</div>\r\n	<div class="panel-setting-background clearfix">\r\n		<input type="text" id="region-bg-color" name="color" />\r\n		<a href="#" id="region-bg-image-upload" class="panel-setting-button upfront-icon upfront-icon-edit thickbox">Upload Image</a>\r\n		<a href="#" id="region-bg-image-edit" class="panel-setting-button upfront-icon upfront-icon-edit" style="display: none;">Edit Image</a>\r\n	</div>\r\n	<div class="panel-setting-background-more">\r\n		<div class="background-image-wrap"></div>\r\n		<div class="panel-setting-sub-label">Background Image Position:</div>\r\n		<div class="panel-setting-background-position">\r\n			<div class="background-position-select">\r\n				<span class="position-select-wrap"><input type="radio" class="position-select" name="position" value="left top" /></span>\r\n				<span class="position-select-wrap"><input type="radio" class="position-select" name="position" value="center top" /></span>\r\n				<span class="position-select-wrap"><input type="radio" class="position-select" name="position" value="right top" /></span>\r\n				<span class="position-select-wrap"><input type="radio" class="position-select" name="position" value="left center" /></span>\r\n				<span class="position-select-wrap"><input type="radio" class="position-select" name="position" value="center" /></span>\r\n				<span class="position-select-wrap"><input type="radio" class="position-select" name="position" value="right center" /></span>\r\n				<span class="position-select-wrap"><input type="radio" class="position-select" name="position" value="left bottom" /></span>\r\n				<span class="position-select-wrap"><input type="radio" class="position-select" name="position" value="center bottom" /></span>\r\n				<span class="position-select-wrap"><input type="radio" class="position-select" name="position" value="right bottom" /></span>\r\n			</div>\r\n			<div class="or-round">or</div>\r\n			<div class="background-tile-select">\r\n				<label class="tile-select-wrap"><input type="checkbox" class="upfront-field-checkbox tile-select" name="tile" value="repeat-x" />Tile Horizontally</label>\r\n				<label class="tile-select-wrap"><input type="checkbox" class="upfront-field-checkbox tile-select" name="tile" value="repeat-y" />Tile Vertically</label>\r\n				<label class="tile-select-wrap"><input type="checkbox" class="upfront-field-checkbox tile-select" name="tile" value="fill" />Fill the Space</label>\r\n			</div>\r\n		</div>\r\n	</div>\r\n</div>'}),define("text!upfront/templates/popup.html",[],function(){return'<div>\r\n<!--\r\n	Wrap everything in a div to convert this file\'s content in a jquery element\r\n	so it is possible to use $.find.\r\n-->\r\n<script type="text/template" id="upfront-post-list-tpl">\r\n<div id="upfront-list">\r\n	<div id="upfront-list-meta" class="upfront-list_item clearfix">\r\n		<div class="upfront-list_item-component upfront-date upfront-header {{ orderby == \'post_date\' ? \'active ordered-\' + order : \'\' }}" data-sortby="post_date">Date <i class="icon-caret-down"></i><i class="icon-caret-up"></i></div>\r\n		<div class="upfront-list_item-component upfront-title upfront-header {{ orderby == \'post_title\' ? \'active ordered-\' + order : \'\' }}"  data-sortby="post_title">Post Title <i class="icon-caret-down"></i><i class="icon-caret-up"></i></div>\r\n		<div class="upfront-list_item-component upfront-author upfront-header {{ orderby == \'post_author\' ? \'active ordered-\' + order : \'\' }}" data-sortby="post_author">Author <i class="icon-caret-down"></i><i class="icon-caret-up"></i></div>\r\n	</div>\r\n	<div class="upfront-list-items upfront-scroll-panel">\r\n	{[ if(!posts.length){ ]}\r\n		<p class="upfront-no-results">No posts found</p>\r\n	{[ } else { ]}\r\n	{[ _.each(posts, function (post, idx){ ]}\r\n		<div class="upfront-list_item-post upfront-list_item clearfix" data-post_id="{{ post.get("ID") }}">\r\n			<div class="upfront-list_item-component upfront-date">{{ Upfront.Util.format_date(post.get("post_date")) }}</div>\r\n			<div class="upfront-list_item-component upfront-title upfront-list_item-main">{{ post.get("post_title") }}</div>\r\n			<div class="upfront-list_item-component upfront-author">{{ post.author.get(\'data\').display_name }}</div>\r\n		</div>\r\n	{[ }); } ]}\r\n	</div>\r\n</div>\r\n</script>\r\n\r\n<script type="text/template" type="text/template" id="upfront-post-single-tpl">\r\n<div id="upfront-list-page" style="display:none">\r\n	<div id="upfront-list-page-path">\r\n		<a href="#" class="upfront-path-back">Posts</a> &nbsp;&raquo;&nbsp;\r\n		<a href="#" class="last">{{ post.get(\'post_title\') }}</a>\r\n	</div>\r\n	<div id="upfront-list-page-preview">\r\n		<div id="upfront-page_preview-wrapper">\r\n			<div id="upfront-page_preview-featured_image" class="upfront-page_preview-item">\r\n				<h4>Featured Image: </h4>\r\n				<div class="upfront-thumbnailinfo">Loading...</div>\r\n				<img src="{{post.featuredImage }}" style="{{post.featuredImage ? \'\' : \'display:none\'}}" />\r\n			<div class="upfront-page_preview-edit_feature"><a href="#">Edit <i class="icon-pencil"></i></a></div>\r\n			</div>\r\n			<div class="upfront-page_preview-bottom" id="upfront-page_preview-edit">\r\n				<button type="button"><i class="icon-pencil"></i> Edit post</button>\r\n			</div>\r\n		</div>\r\n	</div>\r\n	<div id="upfront-list-page-tree" class="upfront-scroll-panel">\r\n		<div class="upfront-post_content-wrapper">\r\n			<div class="upfront-post_content">\r\n				<h3>{{ post.get(\'post_title\') }}</h3>\r\n				{{ post.get(\'post_content\') }}\r\n			</div>\r\n		</div>\r\n	</div>\r\n</div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-page-list-tpl">\r\n<div id="upfront-list-page" class="bordered-bottom clearfix">\r\n	<div id="upfront-list-page-path"></div>\r\n	<div id="upfront-list-page-preview">\r\n		<div id="upfront-page_preview-wrapper">\r\n			<h4>Please select Page</h4>\r\n		</div>\r\n	</div>\r\n	<div id="upfront-list-page-tree" class="upfront-list-items upfront-scroll-panel">\r\n	{[ _.each(pages, function (page){ ]}\r\n		{{ pageItemTemplate({page: page, pageItemTemplate: pageItemTemplate}) }}\r\n	{[ }); ]}\r\n	</div>\r\n</div>\r\n</script>\r\n\r\n<script type="text/template"  id="upfront-page-list-item-tpl">\r\n	<div class="upfront-list-page_item {{ page.children.length ? \'has_children closed\' : \'\' }}" id="upfront-list-page_item-{{ page.get("ID") }}" data-post_id="{{ page.get("ID") }}">\r\n		{[if(page.children.length){ ]}\r\n		<i class="icon-caret-right"></i>\r\n		<i class="icon-caret-down"></i>\r\n		{[ } ]}\r\n		{{ page.get("post_title") }}\r\n		{[if(page.children.length){ page.children.each(function(child, idx) { ]}\r\n			{{ pageItemTemplate({page: child, pageItemTemplate: pageItemTemplate}) }}\r\n		{[ })}; ]}\r\n	</div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-page-preview-tpl">\r\n	<div id="upfront-page_preview-wrapper" class="upfront-scroll-panel">\r\n		<div id="upfront-page_preview-featured_image" class="upfront-page_preview-item">\r\n			<h4>Featured Image: </h4>\r\n			<div class="upfront-thumbnailinfo" style="{{page.thumbnail ? \'display:none\' : \'\'}}">Loading...</div>\r\n			<img src="{{page.thumbnail }}" style="{{page.thumbnail ? \'\' : \'display:none\'}}" />\r\n			<div class="upfront-page_preview-edit_feature"><a href="#">Edit <i class="icon-pencil"></i></a></div>\r\n		</div>\r\n		<div id="upfront-page_preview-template" class="upfront-page_preview-item">\r\n			<h4>Template: </h4>\r\n			<select id="upfront-page_template-select">\r\n				<option value="0">Default</option>\r\n				{[ _.each(allTemplates, function(tpl, name){ var selected = tpl == template ? \'selected="selected"\' : ""; ]}\r\n				<option value="{{tpl}}" {{selected}}>{{name}}</option>\r\n				{[ }) ]}\r\n			</select>\r\n		</div>\r\n		<div id="upfront-page_preview-edit">\r\n			<button type="button"><i class="icon-pencil"></i> Edit page</button>\r\n		</div>\r\n	</div>\r\n</script>\r\n\r\n<script type="text/template"  id="upfront-comments-tpl">\r\n<div id="upfront-list" class="upfront-list-comments clearfix bordered-bottom">\r\n	{[ if(!comments.length){ ]}\r\n		<p class="upfront-no-results">This post or page has no comments.</p>\r\n	{[ } else { ]}\r\n	<div id="upfront-list-meta" class="upfront-list_item">\r\n		<div class="upfront-list_item-component upfront-comment_author upfront-header {{ orderby == \'comment_author\' ? \'active ordered-\' + order : \'\' }}" data-sortby="comment_author">Author <i class="icon-caret-down"></i><i class="icon-caret-up"></i></div>\r\n		<div class="upfront-list_item-component upfront-date upfront-header {{ orderby == \'comment_date\' ? \'active ordered-\' + order : \'\' }}" data-sortby="comment_date">Date <i class="icon-caret-down"></i><i class="icon-caret-up"></i></div>\r\n		<div class="upfront-list_item-component upfront-comment_content upfront-header {{ orderby == \'comment_content\' ? \'active ordered-\' + order : \'\' }}" data-sortby="comment_content">Comment <i class="icon-caret-down"></i><i class="icon-caret-up"></i></div>\r\n	</div>\r\n	<div class="upfront-list-items upfront-list-comment-items upfront-scroll-panel">\r\n\r\n		{[ _.each(comments, function(comment){ ]}\r\n		<div class="upfront-list_item-comment upfront-list_item clearfix" id="upfront-list_item-comment-{{ comment.get("comment_ID") }}" data-comment_id="{{ comment.get("comment_ID") }}">\r\n				{{ commentTpl({comment:comment, excerptLength: excerptLength}) }}\r\n		</div>\r\n		{[ }) ]}\r\n	</div>\r\n	{[ } ]}\r\n</div>\r\n</script>\r\n\r\n<script type="text/template"  id="upfront-comment-single-tpl">\r\n	{[ var excerpt = jQuery(\'<div></div>\').html(comment.get(\'comment_content\')).text(); ]}\r\n		<div class="upfront-comment-approved">\r\n			{[ if(comment.get("comment_approved") === \'0\'){ ]}\r\n			<i class="upfront-comments-approve icon-circle-blank" data-comment_id="{{ comment.get("comment_ID") }}"></i>\r\n			{[ } ]}\r\n		</div>\r\n		<div class="upfront-list_item-component upfront-comment_author">\r\n			<img src="{{ Upfront.Util.get_avatar(comment) }}" title="{{comment.get("comment_author")}}" class="avatar" /> {{comment.get("comment_author")}}</div>\r\n		<div class="upfront-list_item-component upfront-date">{{ Upfront.Util.format_date(comment.get("comment_date")) }}</div>\r\n		<div class="upfront-list_item-component upfront-comment_content upfront-comment_excerpt upfront-list_item-main upfront-post_content">{{ excerpt.length > excerptLength ? excerpt.substring(0, excerptLength) + \' [...]\' : excerpt }}</div>\r\n		<div class="upfront-list_item-component upfront-comment_content upfront-comment_content-full-wrapper upfront-list_item-main upfront-post_content  upfront-scroll-panel">\r\n			<div class="upfront-comment_content-full upfront-comment_togglable">{{ comment.get("comment_content") }}</div>\r\n			<div class="upfront-comment_edit upfront-comment_togglable" data-comment_id="{{ comment.get(\'comment_ID\') }}">\r\n				<textarea class="comment-edit-box" class="edit" rows="16">{{ comment.get("comment_content") }}</textarea>\r\n				<button type="button" class="comment-edit-ok">OK</button>\r\n				<button type="button" class="comment-edit-cancel">Cancel</button>\r\n			</div>\r\n			<div class="upfront-comment_reply upfront-comment_togglable" data-comment_id="{{ comment.get(\'comment_ID\') }}">\r\n				<textarea class="comment-edit-box" class="edit" rows="16" placeholder="Reply here..."></textarea>\r\n				<button type="button" class="comment-reply-ok">OK</button>\r\n				<button type="button" class="comment-reply-cancel">Cancel</button>\r\n			</div>\r\n		</div>\r\n		<div class="upfront-comment_actions-wrapper">\r\n			{[ if(comment.get("comment_approved") !== \'trash\'){ ]}\r\n			<a href="#reply" class="reply"><i class="icon-reply"></i> Reply</a>\r\n			{[ } ]}\r\n			<a href="#edit" class="edit"><i class="icon-pencil"></i> Edit</a>\r\n			{[ if(comment.get("comment_approved") === \'0\'){ ]}\r\n			<a href="#approve" class="approve"><i class="icon-ok"></i> Approve</a>\r\n			{[ } else if(comment.get("comment_approved") === \'1\'){ ]}\r\n			<a href="#unapprove" class="unapprove"><i class="icon-circle-blank"></i> Unapprove</a>\r\n			{[ } if(comment.get("comment_approved") === \'spam\'){ ]}\r\n			<a href="#unspam" class="unspam"><i class="icon-comment-alt"></i> Unspam</a>\r\n			{[ } else if(comment.get("comment_approved") !== \'trash\') { ]}\r\n			<a href="#spam" class="spam"><i class="icon-ban-circle"></i> Spam</a>\r\n			{[ } if(comment.get("comment_approved") === \'trash\'){ ]}\r\n			<a href="#unthrash" class="unthrash"><i class="icon-comment"></i> Untrash</a>\r\n			{[ } else { ]}\r\n			<a href="#thrash" class="thrash"><i class="icon-remove"></i> Trash</a>\r\n			{[ } ]}\r\n		</div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-slug-tpl">\r\n<div class="upfront-slug_editor">\r\n	<div class="upfront-slug_editor-title">Edit the <b>URL</b> for this post</div>\r\n	<p class="upfront-slug_editor-info">By default, your URL is determined by a post\'s or page\'s title. You can change it here.<br/>It is a good idea to keep them short and memorable.</p>\r\n	<p class="upfront-slug_editor-url">\r\n		{{ rootURL }}\r\n		<input type="text" id="upfront-post_slug" value	="{{ slug }}" />\r\n		<button id="upfront-post_slug-send" value="OK"><i class="icon-ok"></i> OK</button>\r\n	</p>\r\n</div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-term-list-tpl">\r\n<div id="upfront-taxonomy-list" class="upfront-scroll-panel">\r\n	{[ _.each(allTerms.where({\'parent\': \'0\'}), function(term, idx){ ]}\r\n	{{ termTemplate({term: term, termTemplate: termTemplate, termId: term.get(\'term_id\'), postTerms: postTerms}) }}\r\n	{[ }); ]}\r\n</div>\r\n<div id="upfront-taxonomy-add">\r\n	<input type="text" id="upfront-new_term" placeholder="Enter {{ labels.singular_name}}" />\r\n	<select id="upfront-taxonomy-parents">\r\n		<option value="0">-- Parent Category --</option>\r\n		{[ allTerms.each(function(term, idx) { ]}\r\n		<option value="{{ term.get(\'term_id\') }}">{{ term.get(\'name\') }}</option>\r\n		{[ }) ]}\r\n	</select>\r\n	<button id="upfront-add_term"><i class="icon-plus"></i> Add {{ labels.singular_name }}</button>\r\n</div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-term-single-tpl">\r\n	<div class="upfront-taxonomy_item" id="upfront-term_item-{{ termId }}">\r\n		<label for="upfront-taxonomy-{{ term.taxonomy }}-{{ termId }}">\r\n			<input type="checkbox" id="upfront-taxonomy-{{ term.taxonomy }}-{{ termId }}" value="{{ termId }}" {{ postTerms.get(termId) ? \'checked="checked"\' : \'\' }} /> {{ term.get(\'name\') }}\r\n		</label>\r\n		{[ term.children.each(function(child, idx){ ]}\r\n		{{ termTemplate({term: child, termTemplate: termTemplate, termId: child.get(\'term_id\'), postTerms: postTerms}) }}\r\n		{[ }) ]}\r\n	</div>\r\n</script>\r\n\r\n\r\n\r\n<script type="text/template" id="upfront-flat-term-list-tpl">\r\n<div id="upfront-taxonomy-list" class="clearfix">\r\n	<div class="upfront-taxonomy-list-panel upfront-scroll-panel" id="upfront-taxonomy-list-current">\r\n		<div class="upfront-taxonomy-list-title">{{ labels.name }} applied to this post</div>\r\n		{[ _.each(currentTerms, function(term, idx){ ]}\r\n		{{ termTemplate({ term: term }) }}\r\n		{[ }); ]}\r\n	</div>\r\n	<div class="upfront-taxonomy-list-panel" id="upfront-taxonomy-list-all">\r\n		<div class="upfront-scroll-panel upfront-inner-scroll-panel">\r\n			<div class="upfront-taxonomy-list-title">Previously used {{ labels.name }}</div>\r\n			{[ _.each(otherTerms, function(term, idx){ ]}\r\n			{{ termTemplate({ term: term }) }}\r\n			{[ }); ]}\r\n		</div>\r\n	</div>\r\n</div>\r\n<div id="upfront-taxonomy-add">\r\n	<input type="text" id="upfront-new_term" placeholder="Enter {{ labels.singular_name}}" />\r\n	<button id="upfront-add_term"><i class="icon-plus"></i> Add {{ labels.singular_name }}</button>\r\n</div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-term-flat-single-tpl">\r\n	<div class="upfront-taxonomy_item upfront-taxonomy_item-flat" id="upfront-term_item-{{ term.get(\'term_id\') }}" data-term_id="{{ term.get(\'term_id\') }}">\r\n		<i class="icon-plus"></i>\r\n		<i class="icon-remove-circle"></i>\r\n		{{ term.get(\'name\') }}\r\n	</div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-pagination-tpl">\r\n<div id="upfront-entity_list-pagination" data-total="{{ pages }}" data-page_size="{{pageSize}}">\r\n	{[ if(pages > 1) { ]}\r\n	<div class="upfront-pagination_item upfront-pagination_item-skip upfront-pagination_item-prev">\r\n		<i class="icon-angle-left"></i>\r\n	</div>\r\n\r\n	{[ _.each(_.range(pages), function(i){ ]}\r\n	<div class="upfront-pagination_item upfront-pagination_page-item {{ i == currentPage ? \'current\' : \'\' }}" data-page_idx="{{ i }}">{{ i + 1}}</div>\r\n	{[ }) ]}\r\n\r\n	<div class="upfront-pagination_item upfront-pagination_item-skip upfront-pagination_item-next">\r\n		<i class="icon-angle-right"></i>\r\n	</div>\r\n	{[ } ]}\r\n</div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-tabs-tpl">\r\n<ul class="upfront-tabs">\r\n	{[ _.each(tabs, function(tab){ ]}\r\n	<li data-type="{{tab.id}}" class="{{ tab.id == active ? \'active\' : \'\' }}">{{tab.text}}</li>\r\n	{[ }); ]}\r\n</ul>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-search-tpl">\r\n	<div class="search_container clearfix">\r\n		<div id="upfront-search_action" class="search upfront-icon upfront-icon-popup-search"></div>\r\n		<div id="upfront-search_container" style="display:{{ query ? \'block\' : \'none\' }}">\r\n			<input type="text" id="upfront-list-search_input" value="{{ query ? query : \'\' }}" />\r\n		</div>\r\n	</div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-notifier-tpl">\r\n	<div id="upfront-notifier">\r\n   		<div id="upfront-notice"></div>\r\n	</div>\r\n</script>\r\n\r\n<script type="text/template" id="selector-post_type-tpl">\r\n{[if(postTypes.length > 1){ ]}\r\n<div id="upfront-selector-post_type">\r\n	Select a post type:\r\n	<div class="upfront-field-select">\r\n		<div class="upfront-field-select-value">{{postTypes[0].label}}</div>\r\n		<ul class="upfront-field-select-options">\r\n		{[ _.each(postTypes, function(type){ ]}\r\n			<li class="upfront-field-select-option upfront-selector-option" rel="{{ type.name }}">\r\n				{{ type.label }}\r\n			</li>\r\n		{[ }); ]}\r\n		</ul>\r\n	</div>\r\n</div>\r\n{[ } ]}\r\n<div id="upfront-selector-posts" class="upfront-scroll-panel">\r\n\r\n</div>\r\n</script>\r\n<script type="text/template" id="selector-post-tpl">\r\n<table id="upfront-list" class="upfront-list-items">\r\n{[ _.each(posts, function(post){ ]}\r\n<tr class="upfront-selector-post upfront-list_item" rel="{{post.id}}">\r\n	<td class="upfront-selector-post-checked upfront-list_item-component"></td>\r\n	<td class="upfront-selector-post-title upfront-list_item-component upfront-list_item-main">{{post.get(\'post_title\')}}</td>\r\n	<td class="upfront-selector-post-date upfront-list_item-component">{{ Upfront.Util.format_date(post.get(\'post_date\'), false) }}</td>\r\n</tr>\r\n{[ }) ]}\r\n</table>\r\n</script>\r\n\r\n\r\n<script type="text/template" id="datepicker-tpl">\r\n<div class="upfront-date_picker upfront-ui">\r\n	<div class="upfront-bar-datepicker">\r\n	</div>\r\n	<div class="upfront-time_picker">\r\n		Time:\r\n		<select class="ueditor-hours-select">\r\n			{[ _.each(hours, function(h){ ]}\r\n			<option value="{{h}}" selected="{{h == currentHour ? \'selected\' : \'\'}}">{{h}}</option>\r\n			{[ }); ]}\r\n		</select>:\r\n		<select class="ueditor-minutes-select">\r\n			{[ _.each(minutes, function(m){ ]}\r\n			<option value="{{m}}" selected="{{m == currentMinute ? \'selected\' : \'\'}}">{{m}}</option>\r\n			{[ }); ]}\r\n		</select>\r\n	</div>\r\n	<div class="ueditor-datepicker-buttons">\r\n		<a class="ueditor-action-pickercancel">Cancel</a>\r\n		<a class="ueditor-action-pickerok button small-button">Ok</a>\r\n	</div>\r\n</div>\r\n</script>\r\n\r\n<script type="text/template" id="microselect-tpl">\r\n		<div class="ueditor-select-options">\r\n			{[ _.each(options, function(option){ ]}\r\n				<a class="ueditor-select-option ueditor-action-status" data-id="{{option.value}}">{{option.name}}</a>\r\n			{[ }); ]}\r\n		</div>\r\n		<input type="text" class="ueditor-select-focus">\r\n</script>\r\n\r\n<script id="csseditor-tpl" type="text/template">\r\n	<div class="upfront-css-resizable">\r\n		<div class="upfront-css-top ui-resizable-handle ui-resizable-n">\r\n			<span class="upfront-css-type">{{ elementType }} Element</span>\r\n			<a class="upfront-css-image" href="#">Link theme image</a>\r\n			<input class="upfront-css-color" type="text">\r\n			<a class="upfront-css-close" href="#">close</a>\r\n		</div>\r\n		<div class="upfront-css-body">\r\n			<div class="upfront-css-ace"></div>\r\n			<div class="upfront-css-sidebar">\r\n				<div class="upfront-css-selectors">\r\n					<p>Available element selectors:</p>\r\n					{[ _.each(selectors, function(data, s){ ]}\r\n					<span class="upfront-css-selector" title="{{ data.info }}" data-selector="{{ s }}">{{data.label}}</span>\r\n					{[ }); ]}\r\n					{{ _.size(selectors) ? \'\' : \'No selectors available for the \' + elementType.toLowerCase() + \' element.\'}}\r\n				</div>\r\n				<div class="upfront-css-save-form">\r\n					<p>Style name</p>\r\n					<input type="text" class="upfront-css-save-name" value="{{ name }}"><button class="upfront-css-save-ok">Save</button>\r\n				</div>\r\n			</div>\r\n		</div>\r\n	</div>\r\n</script>\r\n\r\n\r\n<!-- end of the wrap div -->\r\n</div>'}),define("text!upfront/templates/region_edit_panel.html",[],function(){return'<div>\r\n<!-- \r\n	Wrap everything in a div to convert this file\'s content in a jquery element \r\n	so it is possible to use $.find.\r\n-->\r\n<script type="text/template" id="upfront-region-bg-setting">\r\n	<div class="upfront-region-bg-setting-region-type">\r\n		<div class="upfront-region-bg-setting-label">Area Type</div>\r\n	</div>\r\n	<div class="upfront-region-bg-setting-region-nav">\r\n		<div class="upfront-region-bg-setting-label">Include area for navigation</div>\r\n	</div>\r\n	<div class="upfront-region-bg-setting-type">\r\n		<div class="upfront-region-bg-setting-label">Background Type</div>\r\n	</div>\r\n	<div class="upfront-region-bg-setting-tab upfront-region-bg-setting-tab-color"></div>\r\n	<div class="upfront-region-bg-setting-tab upfront-region-bg-setting-tab-image"></div>\r\n	<div class="upfront-region-bg-setting-tab upfront-region-bg-setting-tab-slider"></div>\r\n	<div class="upfront-region-bg-setting-tab upfront-region-bg-setting-tab-map"></div>\r\n	<div class="upfront-region-bg-setting-tab upfront-region-bg-setting-tab-video"></div>\r\n	<div class="upfront-region-bg-setting-footer clearfix">\r\n		<div class="upfront-region-bg-setting-auto-resize"></div>\r\n		<div class="upfront-region-bg-setting-change-image">\r\n			<i class="upfront-field-icon upfront-region-field-icon upfront-region-field-icon-bg-image-change"></i> Use different image\r\n		</div>\r\n	</div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-region-bg-setting-tab">\r\n	<div class="upfront-region-bg-setting-tab-primary"></div>\r\n	<div class="upfront-region-bg-setting-tab-secondary"></div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-region-bg-setting-tab-color">\r\n	<div class="upfront-region-bg-setting-tab-primary">\r\n		<div class="upfront-region-bg-setting-label">Pick Color</div>\r\n	</div>\r\n	<div class="upfront-region-bg-setting-tab-secondary"></div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-region-bg-setting-tab-image">\r\n	<div class="upfront-region-bg-setting-tab-primary">\r\n		<div class="upfront-region-bg-setting-label">Image Variation</div>\r\n	</div>\r\n	<div class="upfront-region-bg-setting-tab-secondary"></div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-region-bg-setting-tab-slider">\r\n	<div class="upfront-region-bg-setting-tab-primary">\r\n		<div class="upfront-region-bg-setting-label">Slider Transition</div>\r\n	</div>\r\n	<div class="upfront-region-bg-setting-tab-secondary"></div>\r\n</script>\r\n\r\n\r\n<script type="text/template" id="upfront-region-bg-setting-tab-video">\r\n	<div class="upfront-region-bg-setting-tab-primary">\r\n		<div class="upfront-region-bg-setting-label">&nbsp;</div>\r\n	</div>\r\n	<div class="upfront-region-bg-setting-tab-secondary"></div>\r\n</script>\r\n\r\n</div>'}),function(e){define("editor_views",["text!upfront/templates/property.html","text!upfront/templates/properties.html","text!upfront/templates/property_edit.html","text!upfront/templates/overlay_grid.html","text!upfront/templates/edit_background_area.html","text!upfront/templates/sidebar_settings_lock_area.html","text!upfront/templates/sidebar_settings_background.html","text!upfront/templates/popup.html","text!upfront/templates/region_edit_panel.html"],function(){var t=["text!upfront/templates/property.html","text!upfront/templates/properties.html","text!upfront/templates/property_edit.html","text!upfront/templates/overlay_grid.html","text!upfront/templates/edit_background_area.html","text!upfront/templates/sidebar_settings_lock_area.html","text!upfront/templates/sidebar_settings_background.html","text!upfront/templates/popup.html","text!upfront/templates/region_edit_panel.html"],n=arguments,r={};_(t).each(function(e,t){e.match(/text!/)&&(r[e.replace(/text!upfront\/templates\//,"").replace(/\.html/,"")]=n[t])}),console.log("refresh"),Upfront.Events.on("data:ready",function(){Upfront.data.tpls=r});var i={stop_scroll_propagation:function(t){t.on("DOMMouseScroll mousewheel",function(t){var n=e(this),r=this.scrollTop,i=this.scrollHeight,s=n.outerHeight(),o=t.originalEvent.wheelDelta,u=o>0,a=i>s;if(!a)return;t.stopPropagation();var f=function(){return t.preventDefault(),t.returnValue=!1,!1};if(!u&&-o>i-s-r)return n.scrollTop(i),f();if(u&&o>r)return n.scrollTop(0),f()})}},s=Backbone.View.extend({events:{"click .upfront-property-change":"show_edit_property_partial","click .upfront-property-save":"save_property","click .upfront-property-remove":"remove_property"},render:function(){var e=_.template(r.property,this.model.toJSON());this.$el.html(e)},remove_property:function(){this.model.destroy()},save_property:function(){var e=this.$("#upfront-new_property-name").val(),t=this.$("#upfront-new_property-value").val();this.model.set({name:e,value:t}),this.render()},show_edit_property_partial:function(){var e=_.template(r.property_edit,this.model.toJSON());this.$el.html(e)}}),o=Backbone.View.extend({events:{"click #add-property":"show_new_property_partial","click #done-adding-property":"add_new_property"},initialize:function(){this.listenTo(this.model.get("properties"),"change",this.render),this.listenTo(this.model.get("properties"),"add",this.render),this.listenTo(this.model.get("properties"),"remove",this.render)},render:function(){var e=_.template(r.properties,this.model.toJSON()),t=this;this.$el.html(e),this.model.get("properties").each(function(e){var n=new s({model:e});n.render(),t.$el.find("dl").append(n.el)})},show_new_property_partial:function(){this.$("#add-property").hide(),this.$("#upfront-new_property").slideDown()},add_new_property:function(){var e=this.$("#upfront-new_property-name").val(),t=this.$("#upfront-new_property-value").val();this.model.get("properties").add(new Upfront.Models.Property({name:e,value:t})),this.$("#upfront-new_property").slideUp().find("input").val("").end(),this.$("#add-property").show()}}),u=Backbone.View.extend({tagName:"li",events:{click:"on_click"},on_click:function(){this.render()},add_module:function(e){var t=this.model.get("regions").active_region;if(!t)return Upfront.Util.log("select a region");Upfront.Events.trigger("entity:module:before_added",e,t);var n=this.model.get("wrappers"),r=Upfront.Util.get_unique_id("wrapper"),i=new Upfront.Models.Wrapper({name:"",properties:[{name:"wrapper_id",value:r},{name:"class",value:"c22 clr"}]});e.set_property("wrapper_id",r),n.add(i),t.get("modules").add(e),Upfront.Events.trigger("entity:module:added",e,t)}}),a=u.extend({className:"command-logo",render:function(){Upfront.Application.get_current()==Upfront.Settings.Application.MODE.LAYOUT?this.$el.html('<div class="upfront-logo"></div>'):this.$el.html('<div class="upfront-logo upfront-logo-small"></div>')},on_click:function(){window.location.href=Upfront.mainData.site}}),f=u.extend({className:"command-exit upfront-icon upfront-icon-exit",render:function(){},on_click:function(){window.location.href=Upfront.mainData.admin}}),l=u.extend({className:"command-new-post",postView:!1,postType:"post",setMode:!1,initialize:function(){this.setMode=Upfront.Application.MODE.CONTENT},render:function(){Upfront.Events.trigger("command:newpost:start",!0),this.$el.addClass("upfront-icon upfront-icon-post"),Upfront.Application.get_current()==Upfront.Settings.Application.MODE.LAYOUT?this.$el.removeClass("tooltip-inline tooltip-bottom").html("New post"):this.$el.addClass("tooltip-inline tooltip-bottom").html('<span class="tooltip-content">New post</span>')},on_click:function(t){t.preventDefault();if(Upfront.Settings.LayoutEditor.newpostType==this.postType)return Upfront.Views.Editor.notify("You are already creating a new "+this.postType+".","warning");return Upfront.Application.navigate("/create_new/post",{trigger:!0});var n,r},on_post_loaded:function(e){this.postView||(this.postView=e,e.editPost(e.post),Upfront.data.currentEntity=e,Upfront.Events.off("elements:this_post:loaded",this.on_post_loaded,this),Upfront.Events.on("upfront:application:contenteditor:render",this.select_title,this))},select_title:function(){var t=this.postView.$(".post_title input").focus();t.val(t.val()),e("#upfront-loading").remove(),Upfront.Events.off("upfront:application:contenteditor:render",this.select_title,this)}}),c=l.extend({className:"command-new-page",postType:"page",initialize:function(){this.setMode=Upfront.Application.MODE.LAYOUT},render:function(){Upfront.Events.trigger("command:newpage:start",!0),this.$el.addClass("upfront-icon upfront-icon-page"),Upfront.Application.get_current()==Upfront.Settings.Application.MODE.LAYOUT?this.$el.removeClass("tooltip-inline tooltip-bottom").html("New page"):this.$el.addClass("tooltip-inline tooltip-bottom").html('<span class="tooltip-content">New page</span>')},on_click:function(e){e.preventDefault(),Upfront.Application.navigate("/create_new/page",{trigger:!0})}}),h=u.extend({className:"command-save",render:function(){this.$el.addClass("upfront-icon upfront-icon-save"),this.$el.html("Save")},on_click:function(){_upfront_post_data.layout.specificity&&_upfront_post_data.layout.item?Upfront.Events.trigger("command:layout:save_as"):Upfront.Events.trigger("command:layout:save")}}),p=u.extend({render:function(){this.$el.html("Save As...")},on_click:function(){Upfront.Events.trigger("command:layout:save_as")}}),d=u.extend({className:"command-preview",can_preview:!1,render:function(){this.$el.addClass("upfront-icon upfront-icon-save"),this.preview_built(),Upfront.Events.on("preview:build:start",this.building_preview,this),Upfront.Events.on("preview:build:stop",this.preview_built,this)},on_click:function(){this.can_preview&&Upfront.Events.trigger("command:layout:preview")},building_preview:function(){this.$el.html("Building..."),this.can_preview=!1},preview_built:function(){this.$el.html("Preview"),this.can_preview=!0}}),v=u.extend({render:function(){this.$el.html("Alternate layout")},on_click:function(){Upfront.Events.trigger("command:layout:load",2)}}),m=u.extend({className:"command-undo",initialize:function(){Upfront.Events.on("entity:activated",this.activate,this),Upfront.Events.on("entity:deactivated",this.deactivate,this),Upfront.Events.on("command:redo",this.render,this),this.deactivate()},render:function(){this.$el.addClass("upfront-icon upfront-icon-undo"),this.$el.html("Undo"),this.model.has_undo_states()?this.activate():this.deactivate()},activate:function(){this.$el.css("opacity",1)},deactivate:function(){this.$el.css("opacity",.5)},on_click:function(){var t=this,n=new Upfront.Views.Editor.Loading({loading:"Undoing...",done:"Thank you for waiting",fixed:!0});n.render(),e("body").append(n.$el),n.done(function(){setTimeout(function(){t.model.restore_undo_state(),Upfront.Events.trigger("command:undo"),t.render()},100)})}}),g=u.extend({className:"command-redo",initialize:function(){Upfront.Events.on("entity:activated",this.activate,this),Upfront.Events.on("entity:deactivated",this.deactivate,this),Upfront.Events.on("command:undo",this.render,this),this.deactivate()},render:function(){this.$el.addClass("upfront-icon upfront-icon-redo"),this.$el.html("Redo"),this.model.has_redo_states()?this.activate():this.deactivate()},activate:function(){this.$el.css("opacity",1)},deactivate:function(){this.$el.css("opacity",.5)},on_click:function(){var t=this,n=new Upfront.Views.Editor.Loading({loading:"Redoing...",done:"Thank you for waiting",fixed:!0});n.render(),e("body").append(n.$el),n.done(function(){setTimeout(function(){t.model.restore_redo_state(),Upfront.Events.trigger("command:redo"),t.render()},100)})}}),y=u.extend({render:function(){this.$el.html("Export history")},on_click:function(){alert("Check console output"),console.log({undo:Upfront.Util.Transient.get_all("undo"),redo:Upfront.Util.Transient.get_all("redo")})}}),b=u.extend({render:function(){if(!this.model.merge.length)return!1;this.$el.html("Merge selected")},on_click:function(){var t=this.model.merge,n=this.model.get("regions").active_region,r=n.get("modules"),i=[];_(t).each(function(e){e.get("objects").each(function(e){i.push(e)}),r.remove(e)});var s=Upfront.Util.get_unique_id("module"),o=new Upfront.Models.Module({name:"Merged module",properties:[{name:"element_id",value:s},{name:"class",value:"c22"}],objects:i});this.add_module(o),e("#"+s).trigger("click"),this.remove(),this.trigger("upfront:command:remove",this),Upfront.Events.trigger("command:merge")}}),w=u.extend({initialize:function(){Upfront.Events.on("entity:activated",this.activate,this),Upfront.Events.on("entity:deactivated",this.deactivate,this),this.deactivate()},render:function(){this.$el.html("Delete")},on_click:function(){var e=this.model.get("regions").active_region,t=e.get("modules"),n=t.active_entity;if(n)return this.delete_module(e,n);t.each(function(e){var t=e.get("objects"),n=t.active_entity;n&&t.remove(n)})},activate:function(){this.$el.css("text-decoration","none")},deactivate:function(){this.$el.css("text-decoration","line-through")},delete_module:function(e,t){var n=e.get("modules");n.remove(t)}}),E=u.extend({initialize:function(){Upfront.Events.on("command:merge",this.on_click,this)},render:function(){this.$el.html("Select mode "+(this._selecting?"on":"off"))},on_click:function(){this._selecting?Upfront.Events.trigger("command:deselect"):Upfront.Events.trigger("command:select"),this._selecting=!this._selecting,this.render()}}),S=u.extend({render:function(){this.$el.html("Toggle grid")},on_click:function(){e(".upfront-overlay-grid").size()||this.create_grid(),this.toggle_grid()},create_grid:function(){this.update_grid()},toggle_grid:function(){Upfront.Application.get_gridstate()?this.hide_grid():this.show_grid()},show_grid:function(){var t=e(Upfront.Settings.LayoutEditor.Selectors.main);t.addClass("show-debug"),e(".upfront-overlay-grid").addClass("upfront-overlay-grid-show"),Upfront.Application.set_gridstate(!0)},hide_grid:function(){var t=e(Upfront.Settings.LayoutEditor.Selectors.main);t.removeClass("show-debug"),e(".upfront-overlay-grid").removeClass("upfront-overlay-grid-show"),Upfront.Application.set_gridstate(!1)},update_grid:function(t){var n=e(Upfront.Settings.LayoutEditor.Selectors.main),i=Upfront.Settings.LayoutEditor.Grid.size,s=Upfront.Settings.LayoutEditor.Grid.class,o=_.template(r.overlay_grid,{columns:i,size_class:s,style:"simple"});e(".upfront-overlay-grid").remove(),e(".upfront-grid-layout").prepend(o),!Upfront.Application.get_gridstate()||this.show_grid()},attach_event:function(){var e=this;Upfront.Application.LayoutEditor.layout_sizes.sizes.each(function(t){t.bind("upfront:layout_size:change_size",e.update_grid,e)})}}),x=u.extend({render:function(){this.$el.html("<span title='destroy the layout and clear everything up'>Reset everything</span>")},on_click:function(){var e=Upfront.Util.model_to_json(this.model);Upfront.Util.post({action:"upfront_reset_layout",data:e}).success(function(){Upfront.Util.log("layout reset"),window.location.reload()}).error(function(){Upfront.Util.log("error resetting layout")})}}),T=u.extend({enabled:!0,initialize:function(){Upfront.Events.on("upfront:element:edit:start",this.disable_toggle,this),Upfront.Events.on("upfront:element:edit:stop",this.enable_toggle,this)},render:function(){this.$el.html(_.template("<span title='toggle editing mode'>Current mode: {{mode}}</span>",{mode:Upfront.Application.get_current()}))},on_click:function(){if(!this.enabled)return!1;var e=Upfront.Application.mode&&Upfront.Application.mode.current&&Upfront.Application.mode.current===Upfront.Application.MODE.LAYOUT?Upfront.Application.MODE.CONTENT:Upfront.Application.MODE.LAYOUT;Upfront.Application.start(e)},disable_toggle:function(){this.$el.css("opacity",.5),this.enabled=!1},enable_toggle:function(){this.$el.css("opacity",1),this.enabled=!0}}),N=T.extend({className:"command-toggle-mode upfront-icon",current_mode:!1,render:function(){this.current_mode&&this.$el.removeClass("command-toggle-mode-"+this.current_mode+" upfront-icon-collapse upfront-icon-expand"),this.current_mode=Upfront.Application.get_current();var e=this.current_mode==Upfront.Application.MODE.LAYOUT?"upfront-icon-collapse":"upfront-icon-expand";this.$el.addClass("command-toggle-mode-"+this.current_mode+" "+e)}}),C=u.extend({className:"command-edit-background-area",events:{"click .switch":"on_switch"},initialize:function(){Upfront.Events.on("command:newpage:start",this.switchOff,this),Upfront.Events.on("command:newpost:start",this.switchOff,this)},render:function(){var e=_.template(r.edit_background_area,{});this.$el.html(e)},on_switch:function(){var t=e(Upfront.Settings.LayoutEditor.Selectors.main);this.$el.find(".switch-on").hasClass("active")?this.switchOff():(this.$el.find(".switch-off").removeClass("active"),this.$el.find(".switch-on").addClass("active"),t.addClass("upfront-region-editing"),Upfront.Events.trigger("command:region:edit_toggle",!0))},switchOff:function(){var t=e(Upfront.Settings.LayoutEditor.Selectors.main);this.$el.find(".switch-off").addClass("active"),this.$el.find(".switch-on").removeClass("active"),t.removeClass("upfront-region-editing"),Upfront.Events.trigger("command:region:edit_toggle",!1)}}),k=Backbone.View.extend({tagName:"ul",initialize:function(){this.commands=_([new c({model:this.model}),new l({model:this.model}),new h({model:this.model}),new p({model:this.model}),new m({model:this.model}),new g({model:this.model}),new w({model:this.model}),new E({model:this.model}),new S({model:this.model}),new x({model:this.model})]),Upfront.Settings.Debug.transients&&this.commands.push(new y({model:this.model}))},render:function(){this.$el.find("li").remove(),this.commands.each(this.add_command,this)},add_command:function(e){e.remove(),e.render(),this.$el.append(e.el),e.bind("upfront:command:remove",this.remove_command,this),e.delegateEvents()},remove_command:function(e){var t=this.commands.reject(function(t){return t.remove(),t.cid==e.cid});this.commands=_(t),this.render()}}),L=Backbone.View.extend(_.extend({},i,{tagName:"li",className:"sidebar-panel",events:{"click .sidebar-panel-title":"on_click"},get_title:function(){},render:function(){this.$el.html('<h3 class="sidebar-panel-title">'+this.get_title()+"</h3>"),this.$el.append('<div class="sidebar-panel-content" />'),this.stop_scroll_propagation(this.$el.find(".sidebar-panel-content")),this.on_render&&this.on_render()},on_click:function(){e(".sidebar-panel").not(this.$el).removeClass("expanded"),this.$el.addClass("expanded")}})),A=L.extend({className:"sidebar-panel upfront-panel-post_panel",initialize:function(){},get_title:function(){return"Pages / Posts"},on_render:function(){var e=this;this.$el.find(".sidebar-panel-title").addClass("upfront-icon upfront-icon-panel-post"),this.commands&&this.commands.each(function(t){t.render(),e.$el.find(".sidebar-panel-content").append(t.$el)})},show:function(){this.$el.show()},hide:function(){this.$el.hide()}}),O=Backbone.View.extend({tagName:"span",className:"draggable-element upfront-no-select",shadow_id:"",draggable:!0,priority:1e4,add_module:function(e){var t=this.model.get("regions").get_by_name("shadow");this.shadow_id=Upfront.Util.get_unique_id("shadow"),e.set({shadow:this.shadow_id},{silent:!0}),t.get("modules").add(e)}}),M=L.extend({className:"sidebar-panel sidebar-panel-elements",initialize:function(){this.elements=_([]),Upfront.Events.on("command:layout:save",this.on_save,this),Upfront.Events.on("command:layout:save_as",this.on_save,this),Upfront.Events.on("command:layout:preview",this.on_preview,this),Upfront.Events.on("command:layout:save_success",this.on_save_after,this),Upfront.Events.on("command:layout:save_error",this.on_save_after,this),Upfront.Events.on("entity:drag_stop",this.reset_modules,this),Upfront.Events.on("layout:render",this.apply_state_binding,this)},get_title:function(){return"Draggable Elements"},on_save:function(){var e=this.model.get("regions");this._shadow_region=e.get_by_name("shadow"),e.remove(this._shadow_region,{silent:!0})},on_preview:function(){return this.on_save()},apply_state_binding:function(){Upfront.Events.on("command:undo",this.reset_modules,this),Upfront.Events.on("command:redo",this.reset_modules,this)},on_render:function(){this.$el.addClass("expanded"),this.$el.find(".sidebar-panel-title").addClass("upfront-icon upfront-icon-panel-elements"),this.elements.each(this.render_element,this),this.reset_modules()},on_save_after:function(){var e=this.model.get("regions");this._shadow_region?e.add(this._shadow_region,{silent:!0}):this.reset_modules()},reset_modules:function(){var e=this.model.get("regions"),t=e?e.get_by_name("shadow"):!1;if(!e)return!1;t||(t=new Upfront.Models.Region({name:"shadow",container:"shadow",title:"Shadow Region"}),this.model.get("regions").add(t));if(t.get("modules").length!=this.elements.size()){var n=t.get("modules");this.elements.each(function(e){var t=!1;n.forEach(function(n){n.get("shadow")==e.shadow_id&&(t=!0)}),t||e.add_element()},this)}},render_element:function(t){if(!t.draggable)return;var n=e(Upfront.Settings.LayoutEditor.Selectors.main),r=this;t.remove(),t.render(),this.$el.find(".sidebar-panel-content").append(t.el),t.$el.on("mousedown",function(n){var r=e(Upfront.Settings.LayoutEditor.Selectors.main),i=e("[data-shadow="+t.shadow_id+"]"),s=r.offset(),o=i.position(),u=i.offset(),a=t.$el.offset(),f=i.outerHeight(),l=i.outerWidth(),c=t.$el.clone(),h=t.$el.outerHeight(),p=t.$el.outerWidth(),d=e('<div id="element-drag-wrapper" class="upfront-ui" />'),v=e(".upfront-grid-layout-gutter-left:first, .upfront-grid-layout-gutter-right:first");i.css({position:"absolute",top:n.pageY-(u.top-o.top)-f/2+h/2,left:n.pageX-(u.left-o.left)-l/2+p/2,visibility:"hidden",zIndex:-1}).trigger(n).one("dragstart",function(n,r){t.$el.addClass("element-drag-active"),e("body").append(d),c.appendTo(d),c.addClass("element-dragging"),c.css({position:"absolute",top:n.pageY-h/2,left:n.pageX-p/2,zIndex:999})}).on("drag",function(t,n){var r=!1;v.each(function(){if(r)return;var n=e(this).offset(),i=e(this).width();t.pageX>=s.left&&t.pageX>=n.left+10&&t.pageX<=n.left+i-10&&(r=!0)}),r?c.addClass("element-dragging-no-drop"):c.removeClass("element-dragging-no-drop"),c.css({top:t.pageY-h/2,left:t.pageX-p/2})}).one("dragstop",function(e,n){t.$el.removeClass("element-drag-active"),c.remove(),d.remove()})})}}),D=Backbone.View.extend({tagName:"div",className:"panel-setting upfront-no-select",render:function(){this.on_render&&this.on_render()}}),P=Backbone.View.extend({tagName:"div",className:"panel-section",initialize:function(){this.settings=_([])},get_title:function(){},render:function(){var e=this;this.$el.html('<h4 class="panel-section-title">'+this.get_title()+"</h4>"),this.$el.append('<div class="panel-section-content" />'),this.settings.each(function(t){t.render(),t.delegateEvents(),e.$el.find(".panel-section-content").append(t.el)}),this.on_render&&this.on_render()}}),H=P.extend({initialize:function(){this.settings=_([])},get_title:function(){return"Structure"},on_render:function(){}}),B=L.extend({initialize:function(){this.sections=_([new H({model:this.model})])},get_title:function(){return"Settings"},on_render:function(){var e=this;this.$el.find(".sidebar-panel-title").addClass("upfront-icon upfront-icon-panel-settings"),this.sections.each(function(t){t.render(),e.$el.find(".sidebar-panel-content").append(t.el)})}}),j=Backbone.View.extend({tagName:"ul",className:"sidebar-panels",initialize:function(){this.panels={posts:new A({model:this.model}),elements:new M({model:this.model})}},render:function(){var e=this;_.each(this.panels,function(t,n){t.render(),e.$el.append(t.el)})}}),F=k.extend({className:"sidebar-commands sidebar-commands-primary",initialize:function(){this.commands=_([new l({model:this.model}),new c({model:this.model}),new X({model:this.model})]),Upfront.Settings.Application.MODE.ALLOW.indexOf(Upfront.Settings.Application.MODE.LAYOUT)!=-1&&this.commands.push(new N({model:this.model}))}}),I=k.extend({className:"sidebar-commands sidebar-commands-additional",initialize:function(){this.commands=_([])},render:function(){}}),q=k.extend({className:"sidebar-commands sidebar-commands-control",initialize:function(){this.commands=_([new m({model:this.model}),new g({model:this.model}),new S({model:this.model})]),Upfront.Settings.Application.NO_SAVE?this.commands.push(new d({model:this.model})):this.commands.push(new h({model:this.model})),Upfront.Settings.Debug.dev&&(this.commands.push(new S({model:this.model})),Upfront.Settings.Application.NO_SAVE||this.commands.push(new x({model:this.model})),this.commands.push(new T({model:this.model})))}}),R=k.extend({className:"sidebar-commands sidebar-commands-header",initialize:function(){this.commands=_([new a({model:this.model})]),Upfront.Settings.Application.NO_SAVE||this.commands.push(new f({model:this.model}))}}),U=Backbone.View.extend({className:"sidebar-profile",render:function(){var e=Upfront.data.currentUser;if(!e)return;var t=e.get("data"),n=e.get("roles");this.$el.html(_.template('<div class="sidebar-profile-avatar"><img src="http://www.gravatar.com/avatar/{{gravatar}}?s=26" /></div><div class="sidebar-profile-detail"><span class="sidebar-profile-name">{{name}}</span><span class="sidebar-profile-role">{{role}}</span></div><div class="sidebar-profile-edit"><a class="upfront-icon upfront-icon-edit" href="{{edit_url}}">edit profile</a></div>',{gravatar:t.gravatar,name:t.display_name,role:n[0],edit_url:Upfront.Settings.admin_url+"profile.php"}))}}),z=Backbone.View.extend({tagName:"div",visible:1,events:{"click #sidebar-ui-toggler-handle":"toggleSidebar"},initialize:function(){this.sidebar_profile=new U({model:this.model}),this.sidebar_commands={header:new R({model:this.model}),primary:new F({model:this.model}),additional:new I({model:this.model}),control:new q({model:this.model})},this.sidebar_panels=new j({model:this.model}),this.fetch_current_user(),Upfront.Application.get_current()==Upfront.Settings.Application.MODE.LAYOUT&&(Upfront.Events.on("upfront:element:edit:start",this.preventUsage,this),Upfront.Events.on("upfront:element:edit:stop",this.allowUsage,this)),Upfront.Events.on("application:mode:after_switch",this.render,this)},preventUsage:function(t){var n="Not available when<br>editing text.";t==="media-upload"&&(n="Not available when<br>uploading media."),t==="write"&&(this.writingIsOn=!0,n="Please publish your content<br>before modifying the layout."),e("#preventUsageOverlay span").html(n),e("#preventUsageOverlay").show()},allowUsage:function(t){if(this.writingIsOn&&t!=="write"){this.preventUsage("write");return}this.writingIsOn=!1,e("#preventUsageOverlay").hide()},render:function(){var t=e('<div id="sidebar-ui-wrapper" class="upfront-ui"></div>');this.sidebar_commands.header.render(),t.append(this.sidebar_commands.header.el),this.sidebar_profile.render(),t.append(this.sidebar_profile.el),this.sidebar_commands.primary.render(),t.append(this.sidebar_commands.primary.el),this.sidebar_commands.additional.render(),t.append(this.sidebar_commands.additional.el),Upfront.Application.get_current()==Upfront.Settings.Application.MODE.LAYOUT?(this.sidebar_panels.render(),t.append(this.sidebar_panels.el),this.sidebar_commands.control.render(),t.append(this.sidebar_commands.control.el),t.append('<div id="preventUsageOverlay"><span></span></div>'),this.$el.html(t)):this.$el.html(t)},get_panel:function(e){return this.sidebar_panels.panels[e]?this.sidebar_panels.panels[e]:!1},get_commands:function(e){return this.sidebar_commands[e]?this.sidebar_commands[e]:!1},to_content_editor:function(){console.log("to_content_editor got called")},from_content_editor:function(){console.log("from_content_editor got called")},handle_post_change:function(e){},fetch_current_user:function(){var e=Upfront.data.currentUser;e||(e=new Upfront.Models.User,Upfront.data.loading.currentUser=e.fetch().done(function(){Upfront.data.currentUser=e}))},addCollapsibleEvents:function(){var t=this;this.$el.append('<div id="sidebar-ui-toggler"><div id="sidebar-ui-toggler-handle" class="sidebar-ui-hide"></div></div>'),e("body").on("mousemove",function(n){t.visible*300+100>n.pageX?t.collapsibleHint||(e("#sidebar-ui-toggler").fadeIn(),t.collapsibleHint=!0):t.collapsibleHint&&(e("#sidebar-ui-toggler").fadeOut(),t.collapsibleHint=!1)}),this.resizeCollapseHandle(),e(window).on("resize",function(){t.resizeCollapseHandle()})},resizeCollapseHandle:function(){var t=e(window).height();this.$("#sidebar-ui-toggler").height(t)},toggleSidebar:function(){this.visible?(e("#sidebar-ui").stop().animate({width:"0px"},300,function(){e("#sidebar-ui").addClass("collapsed")}),e("#page").animate({"margin-left":"0px"},300),this.$("#sidebar-ui-toggler-handle").removeClass().addClass("sidebar-ui-show"),this.visible=0):(e("#sidebar-ui").removeClass("collapsed").stop().animate({width:"300px"},300),e("#page").animate({"margin-left":"300px"},300),this.$("#sidebar-ui-toggler-handle").removeClass().addClass("sidebar-ui-hide"),this.visible=1)}}),W=u.extend({tagName:"div",className:"upfront-sidebar-content_editor-sidebar_command",post:!1,initialize:function(){this.setPost(),Upfront.Events.on("data:current_post:change",this.setPost,this)},setPost:function(){var e=Upfront.data.currentPost;if(!e)this.post=new Upfront.Models.Post({post_type:"post",id:"0"});else if(!this.post||this.post.id!=e.id)this.post=Upfront.data.currentPost,this.onPostChange&&this.onPostChange();return this}}),X=W.extend({tagName:"li",className:"command-popup-list",$popup:{},views:{},currentPanel:!1,render:function(){this.$el.addClass("upfront-entity_list upfront-icon upfront-icon-browse"),Upfront.Application.get_current()==Upfront.Settings.Application.MODE.LAYOUT?this.$el.html("Browse Posts / Pages / Comments"):this.$el.html("Posts / Pages")},on_click:function(){var t=this,n=Upfront.Popup.open(function(n,r,i){var s=e(this);s.empty().append('<p class="upfront-popup-placeholder">No such thing as <q>too many drinks</q>.</p>'),t.$popup={top:r,content:s,bottom:i}});t.$popup.top.html('<ul class="upfront-tabs"><li data-type="posts" class="active">Posts</li><li data-type="pages">Pages</li><li data-type="comments">Comments</li></ul>'+t.$popup.top.html()).find(".upfront-tabs li").on("click",function(){t.dispatch_panel_creation(this)}),t.dispatch_panel_creation(),n.done(function(){Upfront.Events.off("upfront:posts:sort"),Upfront.Events.off("upfront:posts:post:expand"),Upfront.Events.off("upfront:pages:sort"),Upfront.Events.off("upfront:comments:sort")})},dispatch_panel_creation:function(t){var n=this,r=t?e(t):n.$popup.top.find(".upfront-tabs li.active"),i=r.attr("data-type"),s=i.charAt(0).toUpperCase()+i.slice(1).toLowerCase(),o=t||{},u=!1,a=this.post.id,f={};n.$popup.top.find(".upfront-tabs li").removeClass("active"),r.addClass("active"),this.currentPanel=i;if(n.views[i])if(i!="comments"||Upfront.data.currentPost&&Upfront.data.currentPost.id&&n.views[i].view.collection.postId==Upfront.data.currentPost.id)return this.render_panel(n.views[i]);if(i=="posts")u=new Upfront.Collections.PostList([],{postType:"post"}),u.orderby="post_date",f={filterContent:!0,withAuthor:!0};else if(i=="pages")u=new Upfront.Collections.PostList([],{postType:"page"}),f={limit:-1};else{var l=Upfront.data.currentPost&&Upfront.data.currentPost.id?Upfront.data.currentPost.id:_upfront_post_data.post_id;u=new Upfront.Collections.CommentList([],{postId:l}),u.orderby="comment_date"}return u.fetch(f).done(function(e){switch(i){case"posts":u.on("reset sort",n.render_panel,n),views={view:new G({collection:u,$popup:n.$popup}),search:new V({collection:u}),pagination:new J({collection:u})},n.views.posts=views;break;case"pages":u.on("reset sort",n.render_panel,n),views={view:new Y({collection:u,$popup:n.$popup}),search:new V({collection:u})},n.views.pages=views;break;case"comments":u.on("reset sort",n.render_panel,n),views={view:new Z({collection:u,$popup:n.$popup}),search:new V({collection:u}),pagination:new J({collection:u})},n.views.comments=views}n.render_panel()}),!1},render_panel:function(){var e=this,t=this.views[this.currentPanel];t.view.render(),e.$popup.content.html(t.view.$el),t.view.setElement(t.view.$el),e.$popup.bottom.empty(),t.pagination&&(t.pagination.render(),e.$popup.bottom.html(t.pagination.$el),t.pagination.setElement(t.pagination.$el)),t.search.render(),e.$popup.bottom.append(t.search.$el),t.search.setElement(t.search.$el)}}),V=Backbone.View.extend({id:"upfront-entity_list-search",searchTpl:_.template(e(r.popup).find("#upfront-search-tpl").html()),events:{"click #upfront-search_action":"dispatch_search_click","keydown #upfront-list-search_input":"dispatch_search_enter"},render:function(){var e=this.collection.lastFetchOptions?this.collection.lastFetchOptions.search:!1;this.$el.html(this.searchTpl({query:e}))},dispatch_search_click:function(t){return e("#upfront-search_container").is(":visible")?this.handle_search_request(t):this.handle_search_reveal(t)},dispatch_search_enter:function(e){if(e.which==13)return this.handle_search_request(e)},handle_search_request:function(t){t.preventDefault();var n=e("#upfront-search_container input").val();this.collection.fetch({search:n})},handle_search_reveal:function(){e("#upfront-search_container").show()}}),J=Backbone.View.extend({paginationTpl:_.template(e(r.popup).find("#upfront-pagination-tpl").html()),events:{"click .upfront-pagination_page-item":"handle_pagination_request","click .upfront-pagination_item-next":"handle_next","click .upfront-pagination_item-prev":"handle_prev"},render:function(){this.$el.html(this.paginationTpl(this.collection.pagination))},handle_pagination_request:function(t,n){var r=this,i=this.collection.pagination,n=n?n:parseInt(e(t.target).attr("data-page_idx"),10)||0;this.collection.fetchPage(n).done(function(e){r.collection.trigger("reset")})},handle_next:function(e){var t=this.collection.pagination,n=t.currentPage==t.pages-1?!1:t.currentPage+1;n&&this.handle_pagination_request(e,n)},handle_prev:function(e){var t=this.collection.pagination,n=t.currentPage==0?!1:t.currentPage-1;n!==!1&&this.handle_pagination_request(e,n)}}),K=Backbone.View.extend({className:"upfront-taxonomy-hierarchical",events:{"click #upfront-add_term":"handle_new_term","keydown #upfront-add_term":"handle_enter_new_term","change .upfront-taxonomy_item":"handle_terms_update","keydown #upfront-new_term":"handle_enter_new_term"},termListTpl:_.template(e(r.popup).find("#upfront-term-list-tpl").html()),termSingleTpl:_.template(e(r.popup).find("#upfront-term-single-tpl").html()),updateTimer:!1,allTerms:!1,initialize:function(e){},render:function(){this.$el.html(this.termListTpl({allTerms:this.allTerms,postTerms:this.collection,termTemplate:this.termSingleTpl,labels:this.collection.taxonomyObject.labels}))},handle_new_term:function(){var t=this,n=this.$el.find("#upfront-new_term").val(),r,i;if(!n)return!1;e("#upfront-taxonomy-parents").length&&(r=e("#upfront-taxonomy-parents").val()),i=new Upfront.Models.Term({taxonomy:this.collection.taxonomy,name:n,parent:r}),i.save().done(function(e){t.allTerms.add(i),t.collection.add(i).save(),t.render()})},handle_terms_update:function(t){var n=this,r=e(t.target),i=r.val();r.is(":checked")?this.collection.add(this.allTerms.get(i)):this.collection.remove(this.allTerms.get(i)),clearTimeout(this.updateTimer),this.updateTimer=setTimeout(function(){n.collection.save()},2e3)},handle_enter_new_term:function(e){e.which==13&&this.handle_new_term(e)}}),Q=Backbone.View.extend({className:"upfront-taxonomy-flat",termListTpl:_.template(e(r.popup).find("#upfront-flat-term-list-tpl").html()),termSingleTpl:_.template(e(r.popup).find("#upfront-term-flat-single-tpl").html()),changed:!1,updateTimer:!1,events:{"click #upfront-add_term":"handle_new_term","click .upfront-taxonomy_item-flat":"handle_term_click","keydown #upfront-add_term":"handle_enter_new_term","keydown #upfront-new_term":"handle_enter_new_term"},initialize:function(e){this.collection.on("add remove",this.render,this)},render:function(){var e=this,t=[],n=[];this.allTerms.each(function(r,i){r.children=[],e.collection.get(r.get("term_id"))?t.push(r):n.push(r)}),this.$el.html(this.termListTpl({currentTerms:t,otherTerms:n,termTemplate:this.termSingleTpl,labels:this.collection.taxonomyObject.labels}))},handle_term_click:function(t){var n=this,r=e(t.currentTarget),i=r.attr("data-term_id");r.parent().attr("id")=="upfront-taxonomy-list-current"?this.collection.remove(i):this.collection.add(this.allTerms.get(i)),clearTimeout(this.updateTimer),this.updateTimer=setTimeout(function(){n.collection.save()},2e3)},handle_new_term:function(e){var t=this,n=this.$el.find("#upfront-new_term").val(),r;e.preventDefault();if(!n)return!1;r=new Upfront.Models.Term({taxonomy:this.collection.taxonomy,name:n}),r.save().done(function(e){t.allTerms.add(r),t.collection.add(r).save()})},handle_enter_new_term:function(e){e.which==13&&this.handle_new_term(e)}}),G=Backbone.View.extend({className:"upfront-entity_list-posts bordered-bottom",postListTpl:_.template(e(r.popup).find("#upfront-post-list-tpl").html()),postSingleTpl:_.template(e(r.popup).find("#upfront-post-single-tpl").html()),paginationTpl:_.template(e(r.popup).find("#upfront-pagination-tpl").html()),events:{"click #upfront-list-meta .upfront-list_item-component":"handle_sort_request","click .upfront-list_item-post":"handle_post_reveal","click #upfront-list-page-path a.upfront-path-back":"handle_return_to_posts"},initialize:function(e){this.collection.on("change reset",this.render,this)},render:function(){this.$el.empty().append(this.postListTpl({posts:this.collection.getPage(this.collection.pagination.currentPage),orderby:this.collection.orderby,order:this.collection.order}))},handle_sort_request:function(t){var n=e(t.target),r=n.attr("data-sortby"),i=this.collection.order;r&&(r==this.collection.orderby&&(i=i=="desc"?"asc":"desc"),this.collection.reSort(r,i))},handle_post_reveal:function(t){var n=this,r=e(t.currentTarget).attr("data-post_id");t.preventDefault(),n.$("#upfront-list").after(n.postSingleTpl({post:n.collection.get(r)})),n.expand_post(n.collection.get(r))},expand_post:function(t){var n=this;t.featuredImage||this.collection.post({action:"get_post_extra",postId:t.id,thumbnail:!0,thumbnailSize:"medium"}).done(function(e){e.data.thumbnail&&e.data.postId==t.id?(n.$("#upfront-page_preview-featured_image img").attr("src",e.data.thumbnail[0]).show(),n.$(".upfront-thumbnailinfo").hide(),t.featuredImage=e.data.thumbnail[0]):(n.$(".upfront-thumbnailinfo").text("No Image"),n.$(".upfront-page_preview-edit_feature a").html('<i class="icon-plus"></i> Add'))}),e("#upfront-list-page").show("slide",{direction:"right"},"fast"),this.$el.find("#upfront-list").hide(),e("#upfront-page_preview-edit button").one("click",function(){var e="/edit/post/"+t.id;Upfront.Popup.close(),Upfront.Application.navigate(e,{trigger:!0})}),this.bottomContent=e("#upfront-popup-bottom").html(),e("#upfront-popup-bottom").html(e('<a href="#" id="upfront-back_to_posts">&laquo; Back to posts</a>').on("click",function(e){n.handle_return_to_posts()}))},handle_return_to_posts:function(){var t=this;this.$el.find("#upfront-list").show("slide",{direction:"left"},function(){t.collection.trigger("reset")}),e("#upfront-list-page").hide()}}),Y=Backbone.View.extend({events:{"click .upfront-list-page_item":"handle_page_activate","click .upfront-page-path-item":"handle_page_activate","change #upfront-page_template-select":"template_change"},currentPage:!1,pageListTpl:_.template(e(r.popup).find("#upfront-page-list-tpl").html()),pageListItemTpl:_.template(e(r.popup).find("#upfront-page-list-item-tpl").html()),pagePreviewTpl:_.template(e(r.popup).find("#upfront-page-preview-tpl").html()),allTemplates:[],render:function(){var e=this.collection.where({post_parent:0});this.$el.html(this.pageListTpl({pages:e,pageItemTemplate:this.pageListItemTpl}))},renderPreview:function(e){var t=this.$el.find("#upfront-list-page-preview");t.html(this.pagePreviewTpl({page:e,template:e.template?e.template:"Default",allTemplates:this.allTemplates?this.allTemplates:[]})),this.$el.find("#upfront-page_preview-edit button").one("click",function(){var t="/edit/page/"+e.get("ID");Upfront.Popup.close(),Upfront.Application.navigate(t,{trigger:!0})})},handle_page_activate:function(t){var n=this.collection.get(e(t.target).attr("data-post_id"));t.preventDefault(),t.stopPropagation(),this.$(".upfront-list-page_item").removeClass("active"),this.$("#upfront-list-page_item-"+n.id).addClass("active").toggleClass("closed"),this.update_path(n),this.update_page_preview(n),this.currentPage=n},update_path:function(e){var t=e,n=[{id:e.get("ID"),title:e.get("post_title")}],r=this.$el.find("#upfront-list-page-path"),i="";while(t.get("post_parent"))t=this.collection.get(t.get("post_parent")),n.unshift({id:t.get("ID"),title:t.get("post_title")});_.each(n,function(t){i&&(i+="&nbsp;&nbsp;"),t.id==e.id?i+='<span class="upfront-page-path-current last">'+t.title+"</span>":i+='<a href="#" class="upfront-page-path-item" data-post_id="'+t.id+'">'+t.title+"</a>"}),r.html(i)},update_page_preview:function(e){var t=this,n=!e.thumbnail||!t.allTemplates||!e.template,r=n?{thumbnail:!e.thumbnail,thumbnailSize:"medium",allTemplates:!t.allTemplates,template:!e.template,action:"get_post_extra",postId:e.get("ID")}:{};n&&this.collection.post(r).done(function(n){n.data.thumbnail&&n.data.postId==e.get("ID")?(t.$("#upfront-page_preview-featured_image img").attr("src",n.data.thumbnail[0]).show(),t.$(".upfront-thumbnailinfo").hide(),e.thumbnail=n.data.thumbnail[0]):(t.$(".upfront-thumbnailinfo").text("No Image"),t.$(".upfront-page_preview-edit_feature a").html('<i class="icon-plus"></i> Add')),n.data.allTemplates&&(t.allTemplates=n.data.allTemplates),n.data.template&&(e.template=n.data.template,t.renderPreview(e))}),this.renderPreview(e)},template_change:function(t){var n=this,r=e(t.target),i=r.val();this.currentPage.post({action:"update_page_template",postId:this.currentPage.get("ID"),template:i}).done(function(e){n.currentPage.get("ID")==e.data.postId&&(n.currentPage.template=e.data.template)})}}),Z=Backbone.View.extend({events:{"click #upfront-list-meta .upfront-list_item-component":"handle_sort_request","mouseenter .upfront-list_item-comment":"start_reveal_counter","mouseleave .upfront-list_item-comment":"stop_reveal_counter","click .upfront-list_item-comment":"toggle_full_post","click .upfront-comments-approve":"handle_approval_request","click .upfront-comment_actions-wrapper a":"handle_action_bar_request","click .comment-edit-ok":"edit_comment","click .comment-reply-ok":"reply_to_comment","click .comment-reply-cancel":"cancel_edit","click .comment-reply-cancel":"cancel_edit","click .comment-edit-box":"stop_propagation"},excerptLength:60,commentsTpl:_.template(e(r.popup).find("#upfront-comments-tpl").html()),commentTpl:_.template(e(r.popup).find("#upfront-comment-single-tpl").html()),initialize:function(e){this.collection.on("change",this.renderComment,this),this.collection.on("add",this.addComment,this)},render:function(){var e=this.collection.postId==0?[]:this.collection.getPage(this.collection.pagination.currentPage);this.$el.html(this.commentsTpl({comments:e,excerptLength:45,commentTpl:this.commentTpl,orderby:this.collection.orderby,order:this.collection.order}))},renderComment:function(e){this.$("#upfront-list_item-comment-"+e.get("comment_ID")).html(this.commentTpl({comment:e,excerptLength:60}))},addComment:function(t){var n=t.get("comment_parent"),r=t.get("comment_ID"),i=e('<div class="upfront-list_item-comment upfront-list_item clearfix expanded" id="upfront-list_item-comment-'+r+'" data-comment_id="'+r+'">'+this.commentTpl({comment:t,excerptLength:this.excerptLength})+"</div>").hide();this.$("div.upfront-list_item-comment").removeClass("expanded"),this._currently_working=!1,n?this.$("#upfront-list_item-comment-"+n).after(i):this.$("div.upfront-list-comment-items").append(i),i.slideDown()},handle_sort_request:function(t){var n=e(t.target),r=n.attr("data-sortby"),i=this.collection.order;r&&(r==this.collection.orderby&&(i=i=="desc"?"asc":"desc"),this.collection.reSort(r,i))},start_reveal_counter:function(t){var n=this;if(e(t.target).is(".upfront-comment-approved")||e(t.target).parents(".upfront-comment-approved").length)return!1;if(this._currently_working)return!1;clearTimeout(n._reveal_counter),n._reveal_counter=setTimeout(function(){n.reveal_comment(t)},500)},reveal_comment:function(t){this.$(".upfront-list-comments .upfront-list_item").removeClass("expanded"),e(t.currentTarget).addClass("expanded"),clearTimeout(this._reveal_counter)},revert_comment:function(t){e(t.currentTarget).removeClass("expanded"),clearTimeout(this._reveal_counter)},toggle_full_post:function(t){e(t.currentTarget).toggleClass("expanded")},stop_reveal_counter:function(e){if(this._currently_working)return!1;this.revert_comment(e)},handle_approval_request:function(t,n){var n=n?n:this.collection.get(e(t.target).attr("data-comment_id"));this.$("#upfront-list_item-comment-"+n.id+" i.upfront-comments-approve").animate({"font-size":"1px",opacity:0},400,"swing",function(){n.approve(!0).save()})},handle_action_bar_request:function(t){var n=this,r=e(t.currentTarget),i=this.collection.get(r.parents(".upfront-list_item-comment").attr("data-comment_id"));return r.is(".edit")?this._edit_comment(i):r.is(".reply")?this._reply_to_comment(i):r.is(".approve")?this.handle_approval_request(!1,i):r.is(".unapprove")?i.approve(!1).save():r.is(".thrash")?i.trash(!0).save():r.is(".unthrash")?i.trash(!1).save():r.is(".spam")?i.spam(!0).save():r.is(".unspam")&&i.spam(!1).save(),!1},edit_comment:function(t){var n=e(t.target).parent(),r=this.collection.get(n.attr("data-comment_id"));r.set("comment_content",n.find("textarea").attr("disabled",!0).val()).save()},reply_to_comment:function(t){var n=this,r=e(t.target).parent(),i=this.collection.get(r.attr("data-comment_id")),s=this.$("#upfront-list_item-comment-"+i.get("comment_ID")),o=r.find("textarea").val(),u=Upfront.data.currentUser;if(o){var a=new Upfront.Models.Comment({comment_author:u.get("data").display_name,comment_post_ID:this.collection.postId,comment_parent:i.get("comment_ID"),comment_content:o,comment_approved:"1",user_id:u.get("ID")}),f=(new Date).getTime();s.find("textarea").attr("disabled",!0),a.save().done(function(e){n.renderComment(i),a.set("comment_ID",e.data.comment_ID),n.collection.add(a),n.$("#upfront-list_item-comment-"+e.data.comment_ID).hide().slideDown()})}},cancel_edit:function(t){var n=e(t.target).parent(),r=this.collection.get(n.attr("data-comment_id"));this.renderComment(r)},stop_propagation:function(e){e.stopPropagation()},_edit_comment:function(e){var t=this.$("#upfront-list_item-comment-"+e.get("comment_ID"));t.find(".upfront-comment_togglable").hide(),t.find(".upfront-comment_edit").show(),this._currently_working=!0},_reply_to_comment:function(e){var t=this.$("#upfront-list_item-comment-"+e.get("comment_ID"));t.find(".upfront-comment_togglable").show(),t.find(".upfront-comment_edit").hide(),this._currently_working=!0}}),et=Backbone.View.extend({tagName:"li",events:{click:"on_click"},on_click:function(){this.trigger("upfront:layout_size:change_size",this.get_size_class()),this.$el.parent().find(".active").removeClass("active"),this.$el.addClass("active")}}),tt=et.extend({render:function(){this.$el.html("<i class='icon-desktop'></i> Desktop")},get_size_class:function(){return"desktop"}}),nt=et.extend({render:function(){this.$el.html("<i class='icon-tablet'></i> Tablet")},get_size_class:function(){return"tablet"}}),rt=et.extend({render:function(){this.$el.html("<i class='icon-mobile-phone'></i> Mobile")},get_size_class:function(){return"mobile"}}),it=Backbone.View.extend({tagName:"ul",initialize:function(){this.sizes=_([new tt({model:this.model}),new nt({model:this.model}),new rt({model:this.model})])},render:function(){var e=this;e.$el.find("li").remove(),e.$el.html("<nav><ul /></nav>"),e.sizes.each(function(t){t.render(),t.bind("upfront:layout_size:change_size",e.change_size,e),e.$el.find("nav ul").append(t.el)}),this.sizes.first().$el.trigger("click")},change_size:function(t){var n=e(Upfront.Settings.LayoutEditor.Selectors.main);this.sizes.each(function(e){n.removeClass(e.get_size_class())}),n.addClass(t),Upfront.Settings.LayoutEditor.Grid.size=Upfront.Settings.LayoutEditor.Grid.breakpoint_columns[t],Upfront.Settings.LayoutEditor.Grid.baseline=Upfront.Settings.LayoutEditor.Grid.baseline,Upfront.Settings.LayoutEditor.Grid.class=Upfront.Settings.LayoutEditor.Grid.size_classes[t],Upfront.Settings.LayoutEditor.Grid.left_margin_class=Upfront.Settings.LayoutEditor.Grid.margin_left_classes[t],Upfront.Settings.LayoutEditor.Grid.right_margin_class=Upfront.Settings.LayoutEditor.Grid.margin_right_classes[t],Upfront.Settings.LayoutEditor.Grid.top_margin_class=Upfront.Settings.LayoutEditor.Grid.margin_top_classes[t],Upfront.Settings.LayoutEditor.Grid.bottom_margin_class=Upfront.Settings.LayoutEditor.Grid.margin_bottom_classes[t]}}),st={get_icon_html:function(e,t){if(!e)return"";if(e.match(/^https?:\/\//)){var n={src:e,alt:"","class":"upfront-field-icon-img"};return"<img "+this.get_field_attr_html(n)+" />"}var r=["upfront-field-icon"];return t?(r.push(t),r.push(t+"-"+e)):r.push("upfront-field-icon-"+e),'<i class="'+r.join(" ")+'"></i>'}},ot=Backbone.View.extend({className:"upfront-field-wrap",initialize:function(){this.multiple=typeof this.options.multiple!="undefined"?this.options.multiple:typeof this.multiple!="undefined"?this.multiple:!1,this.label=typeof this.options.label!="undefined"?this.options.label:"",this.default_value=typeof this.options.default_value!="undefined"?this.options.default_value:this.multiple?[]:"",this.options.property?(this.property=this.model.get_property_by_name(this.options.property),this.property===!1&&(this.model.init_property(this.options.property,this.default_value),this.property=this.model.get_property_by_name(this.options.property))):this.property=!1,this.name=this.options.name?this.options.name:this.cid,this.selected_state=this.selected_state?this.selected_state:"",this.init&&this.init(),this.options.change&&this.on("changed",this.options.change,this)},get_name:function(){return this.property?this.property.get("name"):this.name},get_saved_value:function(){if(this.property)return this.property.get("value");if(this.model){var e=this.model.get(this.name);return e?e:this.default_value}return this.default_value},get_value:function(){var t=this.get_field();return!this.multiple||t.size()==1&&t.is("select")?t.val():_.map(t,function(t){return e(t).val()})},get_field_id:function(){return this.cid+"-"+this.get_name()},get_field_name:function(){return this.get_name()},get_field:function(){return this.$el.find("[name="+this.get_field_name()+"]"+(this.selected_state?":"+this.selected_state:""))},get_label_html:function(){var e={"for":this.get_field_id(),"class":"upfront-field-label "+(this.options.label_style=="inline"?"upfront-field-label-inline":"upfront-field-label-block")};return"<label "+this.get_field_attr_html(e)+">"+this.label+"</label>"},get_field_attr_html:function(e){return _.map(e,function(e,t){return t+'="'+e+'"'}).join(" ")}}),ut=ot.extend({className:"upfront-field-wrap upfront-field-wrap-text",render:function(){this.$el.html(""),this.options.compact||this.$el.append(this.get_label_html()),this.$el.append(this.get_field_html());var t=this;this.get_field().keyup(function(){e(this).val()==""?(e(this).addClass("upfront-field-empty"),t.options.compact&&t.$el.removeClass("tooltip")):e(this).hasClass("upfront-field-empty")&&(e(this).removeClass("upfront-field-empty"),t.options.compact&&t.$el.addClass("tooltip"))}).trigger("keyup").change(function(){t.trigger("changed")}),this.trigger("rendered")},get_field_html:function(){var e={type:"text","class":"upfront-field upfront-field-text",id:this.get_field_id(),name:this.get_field_name(),value:this.get_saved_value()};return this.options.compact?(e.placeholder=this.label,this.$el.attr("data-tooltip",this.label)):this.options.placeholder&&(e.placeholder=this.options.placeholder),"<input "+this.get_field_attr_html(e)+" />"}}),at=ot.extend({className:"upfront-field-wrap upfront-field-wrap-button",render:function(){this.$el.html(""),this.options.compact||this.$el.append(this.get_label_html()),this.$el.append(this.get_field_html());var e=this;this.trigger("rendered")},get_field_html:function(){var e={type:"button","class":"upfront-field upfront-field-button",id:this.get_field_id(),name:this.get_field_name(),value:this.label};return this.options.compact?(e.placeholder=this.label,this.$el.attr("data-tooltip",this.label)):this.options.placeholder&&(e.value=this.options.placeholder),"<input "+this.get_field_attr_html(e)+" />"}}),ft=ut.extend({get_field_html:function(){var e={type:"email","class":"upfront-field upfront-field-text upfront-field-email",id:this.get_field_id(),name:this.get_field_name(),value:this.get_saved_value()};return this.options.compact?(e.placeholder=this.label,this.$el.attr("data-tooltip",this.label)):this.options.placeholder&&(e.placeholder=this.options.placeholder),"<input "+this.get_field_attr_html(e)+" />"}}),lt=ut.extend({className:"upfront-field-wrap upfront-field-wrap-text upfront-field-wrap-textarea",get_field_html:function(){var e={cols:"40",rows:"5","class":"upfront-field upfront-field-text upfront-field-textarea",id:this.get_field_id(),name:this.get_field_name()};return this.options.compact?(e.placeholder=this.label,this.$el.attr("data-tooltip",this.label)):this.options.placeholder&&(e.placeholder=this.options.placeholder),"<textarea "+this.get_field_attr_html(e)+">"+this.get_saved_value()+"</textarea>"}}),ct=ut.extend({className:"upfront-field-wrap upfront-field-wrap-number",get_field_html:function(){var e={type:"number","class":"upfront-field upfront-field-number",id:this.get_field_id(),name:this.get_field_name(),value:this.get_saved_value(),min:this.options.min,max:this.options.max,step:this.options.step};return" <input "+this.get_field_attr_html(e)+" /> "+(this.options.suffix?this.options.suffix:"")}}),ht=ut.extend(_.extend({},st,{className:"upfront-field-wrap upfront-field-wrap-slider",initialize:function(){ht.__super__.initialize.apply(this,arguments);var e=this,t={range:this.getOption("range","min"),min:this.getOption("min",0),max:this.getOption("max",0),step:this.getOption("step",1),orientation:this.getOption("orientation","horizontal"),value:this.get_saved_value()};this.value=this.get_saved_value(),typeof this.value=="undefined"&&(this.value=t.min),this.options.callbacks&&_.extend(t,this.options.callbacks),t.slide=function(t,n){var r=n.value;e.value=r,e.$("input").val(e.value).trigger("change"),e.options.valueTextFilter&&(r=e.options.valueTextFilter(r)),e.$(".upfront-field-slider-value").text(r),e.options.callbacks&&e.options.callbacks.slide&&e.options.callbacks.slide(t,n)},this.on("rendered",function(){var n=e.$("#"+e.get_field_id());t.orientation=="vertical"&&n.addClass("upfront-field-slider-vertical"),n.slider(t)})},get_field_html:function(){var e='<input type="hidden" name="'+this.get_field_name()+'" value="'+this.value+'">',t=this.value;return this.options.info&&(e+='<div class="upfront-field-info">'+this.options.info+"</div>"),e+='<div class="upfront-field upfront-field-slider" id="'+this.get_field_id()+'"></div>',this.options.valueTextFilter&&(t=this.options.valueTextFilter(t)),e+='<div class="upfront-field-slider-value"> '+t+"</div>",e},getOption:function(e,t){return this.options[e]?this.options[e]:t}})),pt=ut.extend({className:"upfront-field-wrap upfront-field-wrap-hidden",get_field_html:function(){var e={type:"hidden",id:this.get_field_id(),name:this.get_field_name(),"class":"upfront-field upfront-field-hidden",value:this.get_saved_value()};return" <input "+this.get_field_attr_html(e)+" /> "}}),dt=ut.extend({className:"upfront-field-wrap upfront-field-wrap-color sp-cf",spectrumDefaults:{clickoutFiresChange:!0,chooseText:"OK",showPalette:!0,showSelectionPalette:!0,showAlpha:!0,showPalette:!0,palette:["fff","000","f00"],maxSelectionSize:10,preferredFormat:"hex",showInput:!0,allowEmpty:!0},initialize:function(){var t=this,n=typeof this.options.spectrum=="object"?_.extend({},this.spectrumDefaults,this.options.spectrum):this.spectrumDefaults;n.move=function(n){var r=n.toHexString();e(".sp-dragger").css({"border-top-color":r,"border-right-color":r}),t.options.spectrum&&t.options.spectrum.move&&t.options.spectrum.move(n)},n.show=function(n){var r=n.toHexString();e(".sp-dragger").css({"border-color":r}),t.options.spectrum&&t.options.spectrum.show&&t.options.spectrum.show(n)},dt.__super__.initialize.apply(this,arguments),this.on("rendered",function(){t.$("input[name="+t.get_field_name()+"]").spectrum(n)})},get_field_html:function(){var e={type:"text","class":"upfront-field upfront-field-color",id:this.get_field_id(),name:this.get_field_name(),value:this.get_saved_value()};return" <input "+this.get_field_attr_html(e)+" /> "+(this.options.suffix?this.options.suffix:"")}}),vt=ot.extend(_.extend({},st,{get_values_html:function(){return _.map(this.options.values,this.get_value_html,this).join("")}})),mt=vt.extend(_.extend({},i,{selected_state:"checked",className:"upfront-field-wrap upfront-field-wrap-select",render:function(){var t=this,n=this.options.select_label?this.options.select_label:"";this.$el.html(""),this.label&&this.$el.append(this.get_label_html()),this.$el.append(this.get_field_html()),this.multiple||(this.$el.on("click",".upfront-field-select-value",function(n){n.stopPropagation();if(t.options.disabled)return;e(".upfront-field-select-expanded").removeClass("upfront-field-select-expanded"),t.$el.find(".upfront-field-select").addClass("upfront-field-select-expanded")}),this.$el.on("click",".upfront-field-select-option label",function(n){n.stopPropagation();if(e(this).closest(".upfront-field-select-option").hasClass("upfront-field-select-option-disabled"))return;t.$el.find(".upfront-field-select").removeClass("upfront-field-select-expanded")}),this.$el.on("mouseup",".upfront-field-select",function(e){e.stopPropagation()}),e("body").on("mouseup",function(){t.$el.find(".upfront-field-select").removeClass("upfront-field-select-expanded")})),this.$el.on("change",".upfront-field-select-option input",function(){var r=t.$el.find(".upfront-field-select-value"),i=t.$el.find(".upfront-field-select-option input:checked");if(i.size()==1&&!this.multiple){var s=i.closest(".upfront-field-select-option"),o=s.text(),u=s.find(".upfront-field-icon").clone();r.html(""),u&&r.append(u),r.append("<span>"+o+"</span>")}else{var a=[];i.each(function(){a.push(e(this).closest(".upfront-field-select-option").text())}),r.text(i.size()==0?n:a.join(", "))}t.$el.find(".upfront-field-select-option").each(function(){e(this).find("input:checked").size()>0?e(this).addClass("upfront-field-select-option-selected"):e(this).removeClass("upfront-field-select-option-selected")}),t.trigger("changed")}),this.stop_scroll_propagation(this.$el.find(".upfront-field-select-options")),!this.multiple&&!this.get_saved_value()&&this.$el.find(".upfront-field-select-option:eq(0) input").prop("checked",!0),this.$el.find(".upfront-field-select-option:eq(0) input").trigger("change"),this.options.width&&this.$el.find(".upfront-field-select").css("width",this.options.width),this.trigger("rendered")},get_field_html:function(){var e={"class":"upfront-field-select upfront-no-select",id:this.get_field_id()};return e.class+=" upfront-field-select-"+(this.options.multiple?"multiple":"single"),this.options.disabled&&(e.class+=" upfront-field-select-disabled"),this.options.style=="zebra"&&(e.class+=" upfront-field-select-zebra"),"<div "+this.get_field_attr_html(e)+'><div class="upfront-field-select-value"></div><ul class="upfront-field-select-options">'+this.get_values_html()+"</ul></div>"},get_value_html:function(e,t){var n=this.get_field_id()+"-"+t,r={type:this.multiple?"checkbox":"radio",id:n,name:this.get_field_name(),"class":"upfront-field-"+(this.multiple?"checkbox":"radio"),value:e.value},i=this.get_saved_value(),s="upfront-field-select-option";e.disabled&&(r.disabled="disabled",s+=" upfront-field-select-option-disabled");var o=this.options.icon_class?this.options.icon_class:null;this.multiple&&_.contains(i,e.value)?r.checked="checked":!this.multiple&&i==e.value&&(r.checked="checked"),r.checked&&(s+=" upfront-field-select-option-selected"),s+=" upfront-field-select-option-"+(t%2==0?"odd":"even");var u="<input "+this.get_field_attr_html(r)+" />";return'<li class="'+s+'">'+'<label for="'+n+'">'+this.get_icon_html(e.icon,o)+'<span class="upfront-field-label-text">'+e.label+"</span></label>"+u+"</li>"}})),gt=vt.extend({selected_state:"checked",render:function(){var t=this;this.$el.html(""),this.label&&this.$el.append(this.get_label_html()),this.$el.append(this.get_field_html()),this.$el.on("change",".upfront-field-multiple input",function(){t.$el.find(".upfront-field-multiple").each(function(){e(this).find("input:checked").size()>0?e(this).addClass("upfront-field-multiple-selected"):e(this).removeClass("upfront-field-multiple-selected")}),t.trigger("changed")}),this.trigger("rendered")},get_field_html:function(){return this.get_values_html()},get_value_html:function(e,t){var n=this.get_field_id()+"-"+t,r="upfront-field-multiple",i={type:this.type,id:n,name:this.get_field_name(),value:e.value,"class":"upfront-field-"+this.type},s=this.get_saved_value(),o=this.options.icon_class?this.options.icon_class:null;return this.options.layout&&(r+=" upfront-field-multiple-"+this.options.layout),e.disabled&&(i.disabled="disabled",r+=" upfront-field-multiple-disabled"),this.multiple&&_.contains(s,e.value)?i.checked="checked":!this.multiple&&s==e.value&&(i.checked="checked"),i.checked&&(r+=" upfront-field-multiple-selected"),'<span class="'+r+'"><input '+this.get_field_attr_html(i)+" />"+'<label for="'+n+'">'+this.get_icon_html(e.icon,o)+'<span class="upfront-field-label-text">'+e.label+"</span></label></span>"}}),yt=gt.extend({className:"upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-radios",type:"radio"}),bt=gt.extend({className:"upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-checkboxes",type:"checkbox",multiple:!0}),wt=ot.extend(_.extend({},i,{events:{"click .upfront-suggest-add":"add_list","focus .upfront-field-text-suggest":"reveal_suggest","keyup .upfront-field-text-suggest":"update_suggest"},multiple:!0,selected_state:"checked",added_list:[],checked_list:[],suggest_list:[],render:function(){var t=this;this.$el.html(""),this.label&&this.$el.append(this.get_label_html()),this.$el.append('<div class="upfront-suggest-wrap" />');var n=this.$el.find(".upfront-suggest-wrap");n.append(this.get_field_html()),n.append('<div class="upfront-suggest-list-wrap upfront-no-select" />'),this.checked_list=this.get_saved_value();var r=this.$el.find(".upfront-suggest-list-wrap");r.append('<ul class="upfront-suggest-lists">'+this.get_suggest_list_html()+"</ul>"),r.append('<div class="upfront-suggest-add-wrap"><span class="upfront-suggest-add-value"></span><span class="upfront-suggest-add">Add New</span></div>'),this.stop_scroll_propagation(this.$el.find(".upfront-suggest-lists")),this.$el.on("change",".upfront-suggest-list input",function(){var n=e(this).val();!e(this).is(":checked")&&_.contains(t.checked_list,n)?t.checked_list=_.without(t.checked_list,n):t.checked_list.push(n),t.trigger("changed")}),this.$el.on("click",function(e){e.stopPropagation()}),e("#settings").on("click",".upfront-settings_panel",function(){t.$el.find(".upfront-suggest-list-wrap").removeClass("upfront-suggest-list-wrap-expanded")}),this.trigger("rendered")},reveal_suggest:function(){this.$el.find(".upfront-suggest-list-wrap").addClass("upfront-suggest-list-wrap-expanded"),this.update_suggest()},update_suggest:function(){var e=this.get_field_input_value();this.$el.find(".upfront-suggest-lists").html(this.get_suggest_list_html()),e?(this.$el.find(".upfront-suggest-add-wrap").show(),this.$el.find(".upfront-suggest-add-value").text(e),this.$el.find(".upfront-suggest-add").toggle(!_.contains(this.suggest_list,e))):this.$el.find(".upfront-suggest-add-wrap").hide()},get_field_html:function(){var e={type:"text","class":"upfront-field upfront-field-text upfront-field-text-suggest",id:this.get_field_id()};return this.options.placeholder&&(e.placeholder=this.options.placeholder),"<input "+this.get_field_attr_html(e)+" />"},get_suggest_list_html:function(){var e=this.get_field_input_value(),t=e?new RegExp("("+e+")","ig"):!1,n=this.get_suggest_list(t),r=this;return _.map(n,function(e,n){var i=r.get_field_id()+"-"+n,s={type:"checkbox",id:i,name:r.get_field_name(),value:e,"class":"upfront-field-checkbox"};_.contains(r.checked_list,e)&&(s.checked="checked");var o=t?e.replace(t,'<span class="upfront-suggest-match">$1</span>'):e;return'<li class="upfront-suggest-list"><input '+r.get_field_attr_html(s)+' /><label for="'+i+'">'+o+"</label></li>"}).join("")},get_suggest_list:function(e){var t=[];return _.each([this.options.source,this.added_list,this.get_saved_value()],function(n,r){_.each(n,function(n){(r!=2||!_.contains(t,n))&&(e&&n.match(e)||!e)&&t.push(n)})}),this.suggest_list=t,t},get_field_input_value:function(){return this.$el.find("#"+this.get_field_id()).val()},empty_field_input_value:function(){return this.$el.find("#"+this.get_field_id()).val("")},add_list:function(e){var t=this.get_field_input_value();this.added_list.push(t),this.checked_list.push(t),this.empty_field_input_value(),this.update_suggest()}})),Et=Backbone.View.extend({group:!0,get_name:function(){if(this.fields.length==1)return this.fields[0].get_name();if(this.fields.length>1)return this.fields.map(function(e){return e.get_name()})},get_value:function(){if(this.fields.length==1)return this.fields[0].get_value();if(this.fields.length>1)return this.fields.map(function(e){return e.get_value()})},get_title:function(){return this.options.title?this.options.title:""},initialize:function(e){var t=this;this.fields=e.fields?_(e.fields):_([]),this.group=typeof e.group!="undefined"?e.group:!0,this.on("panel:set",function(){t.fields.each(function(e){e.panel=t.panel,e.trigger("panel:set")})})},render:function(){this.group?this.$el.append('<div class="upfront-settings-item"><div class="upfront-settings-item-title">'+this.get_title()+"</div>"+'<div class="upfront-settings-item-content"></div>'+"</div>"):this.$el.append('<div class="upfront-settings-item-content"></div>'),$content=this.$el.find(".upfront-settings-item-content"),this.fields.each(function(e){e.render(),$content.append(e.el)}),this.trigger("rendered")},save_fields:function(){var e=_([]);this.fields.each(function(t,n,r){if(t.property){var i=t.get_value(),s=t.get_saved_value();!t.multiple&&i!=s?e.push(t):t.multiple&&(i.length!=s.length||_.difference(i,s).length!=0)&&e.push(t)}}),e.each(function(e,t,n){e.property.set({value:e.get_value()},{silent:!0})}),e.size()>0&&(this.panel.is_changed=!0)},wrap:function(e){if(!e)return!1;var t=e.title||"",n=e.markup||e;this.$el.append('<div id="usetting-'+this.get_name()+'" class="upfront-settings-item">'+'<div class="upfront-settings-item-title">'+t+"</div>"+'<div class="upfront-settings-item-content">'+n+"</div>"+"</div>")},remove:function(){this.fields&&this.fields.each(function(e){e.remove()}),Backbone.View.prototype.remove.call(this)}}),St=Backbone.View.extend(_.extend({},st,{className:"upfront-settings-item-tab-wrap",radio:!1,is_default:!1,events:{"click .upfront-settings-item-tab":"reveal"},initialize:function(e){this.settings=e.settings?_(e.settings):_([]),this.radio=typeof e.radio!="undefined"?e.radio:this.radio,this.is_default=typeof e.is_default!="undefined"?e.is_default:this.is_default},get_title:function(){return this.options.title?this.options.title:""},get_icon:function(){return this.options.icon?this.options.icon:""},get_property:function(){return this.options.property?this.options.property:""},get_value:function(){return this.options.value?this.options.value:""},get_property_model:function(){var e=this.get_property();return e?this.model.get_property_by_name(e):!1},get_property_value:function(){var e=this.get_property_model();return e?e.get("value"):""},render:function(){var t=this;this.$el.html(""),this.$el.append('<div class="upfront-settings-item-tab" />'),this.$el.append('<div class="upfront-settings-item-tab-content" />');var n=this.$el.find(".upfront-settings-item-tab"),r=this.$el.find(".upfront-settings-item-tab-content");if(this.radio){var i=this.get_property_model();i||this.is_default&&this.model.init_property(this.get_property(),this.get_value());var s=this.cid+"-"+this.get_property(),o=e('<label for="'+s+'" />'),u=this.get_property_value()==this.get_value();o.append(this.get_icon_html(this.get_icon())),o.append('<span class="upfront-settings-item-tab-radio-text">'+this.get_title()+"</span>"),n.append(o),n.append('<input type="radio" id="'+s+'" class="upfront-field-radio" name="'+this.get_property()+'" value="'+this.get_value()+'" '+(u?'checked="checked"':"")+" />"),this.$el.addClass("upfront-settings-item-tab-radio")}else n.text(this.get_title());this.settings.each(function(e){e.panel=t.panel,e.render(),r.append(e.el)}),this.listenTo(this.panel,"rendered",this.panel_rendered),this.trigger("rendered")},conceal:function(){this.$el.removeClass("upfront-settings-item-tab-active")},reveal:function(){this.panel.settings.invoke("conceal"),this.$el.addClass("upfront-settings-item-tab-active"),this.radio&&this.$el.find(".upfront-settings-item-tab input").prop("checked",!0).trigger("change")},panel_rendered:function(){this.radio&&this.get_property_value()==this.get_value()&&this.reveal()},save_fields:function(){this.settings.invoke("save_fields");if(this.radio&&this.$el.find(".upfront-settings-item-tab input:checked").size()>0){var e=this.get_property_model();e?e.set({value:this.get_value()},{silent:!0}):this.model.init_property(this.get_property(),this.get_value()),this.get_property_value()!=this.get_value()&&(this.panel.is_changed=!0)}},remove:function(){this.settings&&this.settings.each(function(e){e.remove()}),Backbone.View.prototype.remove.call(this)}})),xt=Backbone.View.extend(_.extend({},i,{className:"upfront-settings_panel_wrap",events:{"click .upfront-save_settings":"on_save","click .upfront-cancel_settings":"on_cancel","click .upfront-settings_label":"on_toggle"},get_title:function(){return this.options.title?this.options.title:""},get_label:function(){return this.options.label?this.options.label:""},initialize:function(e){var t=this;this.settings=e.settings?_(e.settings):_([]),this.settings.each(function(e){e.panel=t,e.trigger("panel:set")}),this.tabbed=typeof e.tabbed!="undefined"?e.tabbed:this.tabbed},tabbed:!1,is_changed:!1,render:function(){this.$el.empty(),this.$el.append('<div class="upfront-settings_label" />'),this.$el.append('<div class="upfront-settings_panel" ><div class="upfront-settings_panel_scroll" /></div>');var t=this.$el.find(".upfront-settings_label"),n=this.$el.find(".upfront-settings_panel"),r=this.$el.find(".upfront-settings_panel_scroll"),i=this;t.append(this.get_label()),this.settings.each(function(e){e.panel||(e.panel=i),e.render(),r.append(e.el)}),this.options.min_height&&r.css("min-height",this.options.min_height);if(this.tabbed){var s=this.settings.first();s.radio||s.reveal(),r.append('<div class="upfront-settings-tab-height" />')}this.stop_scroll_propagation(r),n.append("<div class='upfront-settings-button_panel'><button type='button' class='upfront-save_settings'><i class='icon-ok'></i> Save</button></div>"),this.$el.fadeIn("fast",function(){var t=e(this).parent().offset().top+e(this).parent().height(),n=jQuery(window).height();t+60>n+jQuery("body").scrollTop()&&jQuery("body").animate({scrollTop:t-n+60},"slow")}),this.trigger("rendered")},conceal:function(){this.$el.find(".upfront-settings_panel").hide(),this.$el.find(".upfront-settings_label").removeClass("active"),this.trigger("concealed")},reveal:function(){this.$el.find(".upfront-settings_label").addClass("active"),this.$el.find(".upfront-settings_panel").show();if(this.tabbed){var t=0;this.$el.find(".upfront-settings-item-tab-content").each(function(){var n=e(this).outerHeight(!0);t=n>t?n:t}),this.$el.find(".upfront-settings-tab-height").css("height",t)}this.trigger("revealed")},show:function(){this.$el.show()},hide:function(){this.$el.hide()},is_active:function(){return this.$el.find(".upfront-settings_panel").is(":visible")},on_toggle:function(){this.trigger("upfront:settings:panel:toggle",this),this.show()},start_loading:function(e,t){this.loading=new Upfront.Views.Editor.Loading({loading:e,done:t}),this.loading.render(),this.$el.find(".upfront-settings_panel").append(this.loading.$el)},end_loading:function(e){this.loading?this.loading.done(e):e()},on_save:function(){var e=!1;this.parent_view.panels.each(function(t){t.save_settings(),t.is_changed&&(e=!0,t.is_changed=!1)}),e&&this.parent_view.model.get("properties").trigger("change"),this.trigger("upfront:settings:panel:saved",this),Upfront.Events.trigger("entity:settings:deactivate")},save_settings:function(){if(!this.settings)return!1;var e=this;this.settings.each(function(t){if((t.fields||t.settings).size()>0)t.save_fields();else{var n=e.model.get_property_value_by_name(t.get_name());n!=t.get_value()&&e.model.set_property(t.get_name(),t.get_value())}})},on_cancel:function(){this.trigger("upfront:settings:panel:close",this)},remove:function(){this.settings&&this.settings.each(function(e){e.remove()}),this.$el.off(),Backbone.View.prototype.remove.call(this)}})),Tt=Backbone.View.extend({get_title:function(){return"Settings"},render:function(){var t=this,n=t.for_view.$el.find(".upfront-editable_entity"),r=n.offset(),i=n.outerWidth(),s=r.left+i,o=t.for_view.$el.find(".upfront-entity-settings_trigger"),u=o.offset(),a=u.left+o.outerWidth(),f=e(Upfront.Settings.LayoutEditor.Selectors.main),l=f.offset(),c=l.left+f.outerWidth();t.$el.empty().show().html('<div class="upfront-settings_title">'+this.get_title()+"</div>"),this.add_common_items(),t.panels.each(function(e){e.render(),t.listenTo(e,"upfront:settings:panel:toggle",t.toggle_panel),t.listenTo(e,"upfront:settings:panel:close",t.close_panel),t.listenTo(e,"upfront:settings:panel:refresh",t.refresh_panel),e.parent_view=t,t.$el.append(e.el)}),this.toggle_panel(this.panels.first());var h=this.panels.first().$el.find(".upfront-settings_label").outerWidth(),p=this.panels.first().$el.find(".upfront-settings_panel").outerWidth();this.$el.css({position:"absolute","z-index":1e7}).offset({top:r.top,left:r.left+i-(s+h+p>c?h+p+(s-u.left)+5:0)}).addClass("upfront-ui"),this.trigger("open")},add_common_items:function(){var e=this.panels.first();e.settings.push(new Ct({model:this.model,title:" Element Styles:"}));if(this.options.anchor&&this.options.anchor.is_target){var t=new At({model:this.for_view.model});e.settings.push(t),this.listenTo(t,"anchor:item:updated",function(){this.toggle_panel(e)})}},set_title:function(e){if(!e||!e.length)return!1;this.$el.find(".upfront-settings_title").html(e)},toggle_panel:function(e){this.panels.invoke("conceal"),e.$el.find(".upfront-settings_panel").css("height",""),e.show(),e.reveal(),this.set_title(e.get_title());var t=0;this.panels.each(function(e){t+=e.$el.find(".upfront-settings_label").outerHeight()});var n=e.$el.find(".upfront-settings_panel").outerHeight()-1;n>=t?this.$el.css("height",n):(e.$el.find(".upfront-settings_panel").css("height",t),this.$el.css("height",t))},refresh_panel:function(e){e.is_active()&&this.toggle_panel(e)},close_panel:function(e){this.panels.invoke("conceal"),this.panels.invoke("show"),this.set_title(this.get_title())},remove:function(){this.panels&&this.panels.each(function(e){e.remove()}),Backbone.View.prototype.remove.call(this)}}),Nt=ot.extend({className:"upfront-field-complex_field-boolean_toggleable_text",tpl:'<input type="checkbox" /> <label>{{element_label}}</label> <div class="upfront-embedded_toggleable" style="display:none">{{field}}<div class="upfront-embedded_toggleable-notice">Please, use ID that contains letters only, eg. <b>myProductSlider</b><br />No spaces or special characters.</div></div>',initialize:function(){this.options.field=new ut(this.options),ot.prototype.initialize.call(this)},render:function(){var e=this;this.$el.empty(),this.$el.append(this.get_field_html()),this.$el.on("click",":checkbox",function(t){t.stopPropagation(),e.field_toggle.apply(e)}),this.model.get_property_value_by_name(this.options.field.get_name())&&(this.$el.find(":checkbox").attr("checked",!0),this.check_value(),this.field_toggle()),this.$el.on("keyup",'[name="'+this.options.field.get_name()+'"]',function(t){t.stopPropagation(),e.check_value.apply(e)}),setTimeout(function(){e.trigger("anchor:updated")},50)},field_toggle:function(){this.$el.find(":checkbox").is(":checked")?this.$el.find(".upfront-embedded_toggleable").show():this.$el.find(".upfront-embedded_toggleable").hide(),this.trigger("anchor:updated")},check_value:function(){var e=this.$el.find('[name="'+this.options.field.get_name()+'"]'),t=this.$el.find(".upfront-embedded_toggleable"),n=e.length&&e.val?e.val():"";t.removeClass("error").removeClass("ok"),n.length&&!n.match(/^[a-zA-Z]+$/)?t.addClass("error"):n.length&&t.addClass("ok")},get_field_html:function(){this.options.field.render();var e=this.options.field.$el;return _.template(this.tpl,_.extend({},this.options,{field:e.html()}))},get_value:function(){var e={},t=this.$el.find(":checkbox"),n=this.$el.find('[name="'+this.options.field.get_name()+'"]'),r=n.val().replace(/[^a-zA-Z]/g,"");return t.is(":checked")&&r?r:!1}}),Ct=Et.extend({className:"upfront-settings-css",events:{"click a.upfront-css-edit":"openEditor","click .upfront-css-new>a":"openNewEditor","change input[name=theme_style]":"stylesChanged"},initialize:function(e){Et.prototype.initialize.call(this,e);if(!Upfront.Application.cssEditor)return!1;var t=Upfront.Application.cssEditor.elementTypes[this.model.get_property_value_by_name("type")],n=[{label:"Default",value:""}],r=new RegExp("^"+t.id+"-");Upfront.data.styles[t.id]&&_.each(Upfront.data.styles[t.id],function(e){n.push({label:e.replace(r,""),value:e})}),this.fields=_([new kt({model:this.model,property:"theme_style",values:n})])},stylesChanged:function(e){var t=this.$("input[name=theme_style]:checked").val(),n=this.$(".upfront-css-new-text");this.model.set_property("theme_style",t)},openEditor:function(e){e.preventDefault(),Upfront.Application.cssEditor.init({model:this.model,name:this.fields._wrapped[0].get_value()}),Upfront.Events.trigger("entity:settings:deactivate")},openNewEditor:function(e){e.preventDefault(),Upfront.Application.cssEditor.init({model:this.model,name:""}),this.model.set_property("theme_style",""),Upfront.Events.trigger("entity:settings:deactivate")}}),kt=mt.extend({render:function(){mt.prototype.render.call(this);var e="add new style";return this.$el.append('<a href="#" title="Edit style" class="upfront-css-edit"></a><p class="upfront-css-new"><a href="#"><span class="codeicon">&lt;/&gt;</span> <span class="upfront-css-new-text">'+e+"</span></a></p>"),this},remove:function(){ot.prototype.remove.call(this)}}),Lt=Backbone.View.extend({className:"upfront-ui",id:"upfront-csseditor",tpl:_.template(e(r.popup).find("#csseditor-tpl").html()),prepareAce:!1,ace:!1,events:{"click .upfront-css-save-ok":"save","click .upfront-css-close":"close","click .upfront-css-image":"openImagePicker","click .upfront-css-selector":"addSelector","click .upfront-css-type":"scrollToElement","click .upfront-css-delete":"deleteStyle","mouseenter .upfront-css-selector":"hiliteElement","mouseleave .upfront-css-selector":"unhiliteElement","keyup .upfront-css-save-name":"checkDeleteToggle"},elementTypes:{UaccordionModel:{label:"Accordion",id:"uaccordion"},UcommentModel:{label:"Comments",id:"ucomment"},UcontactModel:{label:"Contact Form",id:"ucontact"},UgalleryModel:{label:"Gallery",id:"ugallery"},UimageModel:{label:"Image",id:"uimage"},LoginModel:{label:"Login",id:"ulogin"},LikeBox:{label:"Like Box",id:"ulikebox"},MapModel:{label:"Map",id:"umap"},UnewnavigationModel:{label:"Navigation",id:"unavigation"},UpostsModel:{label:"Posts",id:"uposts"},UsearchModel:{label:"Search",id:"usearch"},USliderModel:{label:"Slider",id:"uslider"},SocialMediaModel:{label:"Social",id:"usocial"},UtabsModel:{label:"Tabs",id:"utabs"},ThisPageModel:{label:"Page",id:"upage"},ThisPostModel:{label:"Post",id:"upost"},UwidgetModel:{label:"Widget",id:"uwidget"},UyoutubeModel:{label:"YoutTube",id:"utube"},PlainTxtModel:{label:"Text",id:"plaintext"}},initialize:function(){e("#"+this.id).length||e("body").append(this.el)},init:function(t){this.$style&&this.close(),this.model=t.model;var n=this,r=e.Deferred(),i=n.model.get_property_value_by_name("type"),s=this.elementTypes[i];this.selector=t.name||"",this.selector?this.name=this.selector.replace(new RegExp("^"+s.id+"-"),""):this.name="",this.elementType=s||{label:"Unknown",id:"unknown"},this.selectors=this.elementSelectors[i]||{},console.log("Ace starting"),this.prepareAce=r.promise(),require(["//cdnjs.cloudflare.com/ajax/libs/ace/1.1.01/ace.js"],function(){r.resolve()}),this.resizeHandler=this.resizeHandler||function(){n.$el.width(e(window).width()-e("#sidebar-ui").width()-1)},e(window).on("resize",this.resizeHandler),this.element_id=this.model.get_property_value_by_name("element_id"),e("#"+this.element_id+"-styles").length?this.$style=e("#"+this.element_id+"-style"):(this.$style=e('<style id="'+this.element_id+'-style"></style'),e("body").append(this.$style)),this.render(),this.startResizable()},close:function(t){t&&t.preventDefault(),e(window).off("resize",this.resizeHandler),this.$style.remove(),this.$style=!1,this.editor&&this.editor.destroy(),this.$el.hide()},render:function(){var t=this;e("#"+this.id).length||e("#page").append(this.$el),this.$el.html(this.tpl({name:this.name,elementType:this.elementType.label,selectors:this.selectors})),this.resizeHandler(".");var n=this.$el.height()-this.$(".upfront-css-top").outerHeight();this.$(".upfront-css-body").height(n),this.prepareAce.done(function(){t.startAce()}),this.prepareSpectrum(),this.checkDeleteToggle(this.name),this.$el.show()},startAce:function(){var t=this,n=ace.edit(this.$(".upfront-css-ace")[0]),r=n.getSession();r.setUseWorker(!1),n.setShowPrintMargin(!1),r.setMode("ace/mode/css"),n.setTheme("ace/theme/monokai"),n.on("change",function(e){t.timer&&clearTimeout(t.timer),t.timer=setTimeout(function(){t.updateStyles(n.getValue())},1e3)});if(this.name){var i=new RegExp(".upfront-object."+this.selector+"s*","g"),s=e("#upfront-style-"+this.selector).html().replace(i,"");n.setValue(e.trim(s),-1)}n.renderer.scrollBar.width=5,n.renderer.scroller.style.right="5px",n.focus(),this.editor=n},prepareSpectrum:function(){var t=this;t.$(".upfront-css-color").spectrum({showAlpha:!0,showPalette:!0,palette:["fff","000","0f0"],maxSelectionSize:9,localStorageKey:"spectrum.recent_bgs",preferredFormat:"hex",chooseText:"Ok",showInput:!0,allowEmpty:!0,show:function(){spectrum=e(".sp-container:visible")},change:function(e){var n=e.alpha<1?e.toRgbString():e.toHexString();t.editor.insert(n),t.editor.focus()},move:function(e){var t=e.toRgbString();spectrum.find(".sp-dragger").css("border-top-color",t),spectrum.parent().find(".sp-dragger").css("border-right-color",t)}})},startResizable:function(){var e=this,t=e.$(".upfront-css-body"),n=e.$(".upfront-css-top").outerHeight(),r=e.$(".upfront-css-selectors"),i=e.$(".upfront-css-save-form"),s=function(s,o){var u=o?o.size.height-n:e.$(".upfront-css-resizable").height()-n;t.height(u),e.editor&&e.editor.resize(),r.height(u-i.outerHeight())};s(),this.$(".upfront-css-resizable").resizable({handles:{n:".upfront-css-top"},resize:s,minHeight:200,delay:100})},scrollToElement:function(){var t=e("#"+this.element_id);if(!t.length)return;var n=t.offset().top-50;e(document).scrollTop(n>0?n:0),this.blink(t,4)},blink:function(e,t){var n=this;e.css("outline","3px solid #3ea"),setTimeout(function(){e.css("outline","none"),t--,t>0&&setTimeout(function(){n.blink(e,t-1)},100)},100)},hiliteElement:function(t){var n=e(t.target).data("selector");if(!n.length)return;var r=e("#"+this.element_id).parent();r.find(n).addClass("upfront-css-hilite")},unhiliteElement:function(t){var n=e(t.target).data("selector");if(!n.length)return;var r=e("#"+this.element_id).parent();r.find(n).removeClass("upfront-css-hilite")},remove:function(){Backbone.View.prototype.remove.call(this),e(window).off("resize",this.resizeHandler)},updateStyles:function(t){this.$style.parent().length||e("body").append(this.$style),this.$style.html(this.stylesAddSelector(t,"#"+this.element_id))},stylesAddSelector:function(t,n){var r=t.split("}"),i="\n\n"+n+" ",s;return r=_.map(r,function(t){return e.trim(t)}),r.pop(),i+r.join("\n}"+i)+"\n}"},save:function(t){t.preventDefault();var n=this,r=e.trim(this.$(".upfront-css-save-name").val()),i=e.trim(this.editor.getValue());if(!r)return Pt.addMessage("You need to set a name for the style.","error");if(!i)return Pt.addMessage("The slylesheet is empty.","error");var s={name:r,styles:i,action:"upfront_save_styles",elementType:this.elementType.id};Upfront.Util.post(s).success(function(t){var r=t.data,i=n.elementType.id,s=i+"-"+r.name,o=e("#upfront-style-"+s);return o.length||(o=e('<style id="upfront-style-'+s+'"></style>'),e("body").append(o)),o.html(n.stylesAddSelector(r.styles,".upfront-object."+s)),Upfront.data.styles[i]||(Upfront.data.styles[i]=[]),Upfront.data.styles[i].indexOf(s)==-1&&Upfront.data.styles[i].push(s),n.model.set_property("theme_style",i+"-"+r.name),n.checkDeleteToggle(r.name),Pt.addMessage("Styles saved as "+r.name)}).error(function(e){return Pt.addMessage("There was an error.")})},checkDeleteToggle:function(t){this.deleteToggle||(this.deleteToggle=e('<a href="#" class="upfront-css-delete">Delete this style</a>'));var n=_.isString(t)?t:t.target.value,r=this.elementType.id,i=Upfront.data.styles[r],s=i&&i.indexOf(r+"-"+n)!=-1,o=this.deleteToggle.parent().length;s&&!o?this.$(".upfront-css-save-form").append(this.deleteToggle):!s&&o&&this.deleteToggle.detach()},deleteStyle:function(t){t.preventDefault();var n=this,r=this.elementType.id,i=r+"-"+this.$(".upfront-css-save-name").val();if(!confirm('If you delete the "'+i+'" style, all the elements with it will get unstyled. Are you sure?'))return;var s={elementType:r,styleName:i,action:"upfront_delete_styles"};Upfront.Util.post(s).done(function(){var t=Upfront.data.styles[r].indexOf(i);Pt.addMessage('The style "'+i+'" was deleted.'),n.$(".upfront-css-save-name").val(""),n.editor.setValue(""),t!=-1&&Upfront.data.styles[r].splice(t,1),e("#upfront-style-"+i).remove(),n.model.get_property_value_by_name("theme_style")==i&&n.model.set_property("theme_style",""),n.deleteToggle.detach()})},fetchThemeStyles:function(t){var n={action:"upfront_theme_styles",separately:t},r=e.Deferred();return Upfront.Util.post(n).success(function(e){r.resolve(e.data.styles)}),r.promise()},createSelectors:function(e){var t=this,n={};_.each(e,function(e){var t=new e.Model,r=new e.View({model:t}),i=t.get_property_value_by_name("type");n[i]=r.cssSelectors||{}}),t.elementSelectors=n},openImagePicker:function(){var e=this;Upfront.Media.Manager.open({themeImages:!0}).done(function(t,n){Upfront.Events.trigger("upfront:element:edit:stop");if(!n)return;var r=n.models[0].get("original_url").replace(document.location.origin,"");e.editor.insert('url("'+r+'")'),e.editor.focus()})},addSelector:function(t){var n=e(t.target).data("selector");this.editor.insert(n),this.editor.focus()}}),At=Et.extend({className:"upfront-settings-item-anchor",group:!1,initialize:function(){Et.prototype.initialize.call(this,this.options);var e=new Nt({element_label:"Make this element an anchor",model:this.model,property:"anchor"});e.on("anchor:updated",function(){this.trigger("anchor:item:updated")},this),this.fields=_([e])}}),Ot=Et.extend({initialize:function(){var e=[],t=this.get_anchors();_(t).each(function(t){e.push({label:t,value:t})}),this.options.fields=_([new mt({model:this.model,property:"anchor_target",values:e})]),Et.prototype.initialize.call(this,this.options)},get_anchors:function(){var e=Upfront.Application.layout.get("regions"),t=[""];return e.each(function(e){e.get("modules").each(function(e){e.get("objects").each(function(e){var n=e.get_property_value_by_name("anchor");n&&n.length&&t.push(n)})})}),t},get_values:function(){return this.fields._wrapped[0].get_value()}}),Mt=Ot.extend({initialize:function(){Ot.prototype.initialize.call(this,this.options),this.options.fields.push(new ut({model:this.model,property:"anchor_label",label:"Label"}))},get_values:function(){return{anchor:this.fields._wrapped[0].get_value(),label:this.fields._wrapped[1].get_value()}}}),_t=mt.extend({initialize:function(){mt.prototype.initialize.call(this),this.options.values=this.get_anchors()},get_anchors:function(){var e=Ot.prototype.get_anchors.call(this),t=[];return _(e).each(function(e){t.push({label:e,value:e})}),t}}),Dt=Backbone.View.extend({notices:new Backbone.Collection([]),elId:"upfront-notice",timer:!1,timeoutTime:5e3,$notice:!1,tpl:_.template(e(r.popup).find("#upfront-notifier-tpl").html()),initialize:function(t){this.notices.on("add",this.messageAdded,this),this.notices.on("remove",this.messageRemoved,this),e("body").append(this.tpl({})),this.setElement(e("#"+this.elId))},addMessage:function(e,t){var n={message:e?e:"No message",type:t?t:"info"};this.notices.add(n)},show:function(e){var t=this;this.setMessage(e),this.$el.addClass("notify open").removeClass("out"),this.timer=setTimeout(function(){t.notices.remove(e)},this.timeoutTime)},replace:function(e){var t=this;this.setMessage(e),this.timer=setTimeout(function(){t.notices.remove(e)},this.timeoutTime),this.$el.removeClass("notify").addClass("shake"),setTimeout(function(){t.$el.removeClass("shake")},this.timeoutTime/2)},setMessage:function(e){this.$el.removeClass("info warning error").addClass(e.get("type")).html(e.get("message"))},close:function(){this.$el.addClass("out"),this.$el.removeClass("notify shake open")},messageAdded:function(e){this.$el.hasClass("notify")||this.show(e)},messageRemoved:function(e){this.notices.length?this.replace(this.notices.at(0)):this.close()}}),Pt=new Dt,Ht=J.extend({className:"upfront-selector-navigation",handle_pagination_request:function(t,n){var r=this,i=this.collection.pagination,n=n?n:parseInt(e(t.target).attr("data-page_idx"),10)||0;this.options.pageSelection(n)}}),Bt=Backbone.View.extend({postTypeTpl:_.template(e(r.popup).find("#selector-post_type-tpl").html()),postListTpl:_.template(e(r.popup).find("#selector-post-tpl").html()),postType:"post",posts:[],pagination:!1,selected:!1,deferred:!1,popup:!1,defaultOptions:{title:"Select a content to link",postTypes:[{name:"post",label:"Posts"},{name:"pages",label:"Pages"}]},events:{"click .upfront-field-select-value":"openTypesSelector","click .upfront-field-select-option":"selectType","click .upfront-selector-post":"selectPost","click .use":"postOk","click #upfront-search_action":"search","keyup .search_container>input":"inputSearch"},open:function(t){var n=this;return bindEvents=!1,t=_.extend({},this.defaultOptions,t),!e("#upfront-popup").length&&this.$el.attr("id")!="upfront-popup"&&(bindEvents=!0),this.popup=Upfront.Popup.open(function(){}),this.deferred=e.Deferred(),this.posts=new Upfront.Collections.PostList([],{postType:t.postTypes[0].name}),this.posts.pagination.pageSize=20,this.pagination=new Ht({collection:this.posts,pageSelection:function(e){n.fetch({page:e})}}),this.setElement(e("#upfront-popup")),this.$("#upfront-popup-top").html('<h3 class="upfront-selector-title">'+t.title+"</h3>"),this.$("#upfront-popup-content").html(this.postTypeTpl(t)),this.fetch({}),this.$("#upfront-popup-bottom").html('<div class="use_selection_container inactive"><a href="#use" class="use">Ok</a></div><div class="search_container clearfix"><input type="text" placeholder="Search" value=""><div class="search upfront-icon upfront-icon-popup-search" id="upfront-search_action"></div></div>').append(this.pagination.$el),this.deferred.promise()},openTypesSelector:function(){var e=this.$(".upfront-field-select");e.hasClass("open")?e.removeClass("open"):e.addClass("open")},selectType:function(t){var n=e(t.target).attr("rel");n!=this.posts.postType&&(this.$(".upfront-field-select-value").text(e(t.target).text()),this.$(".upfront-field-select").removeClass("open"),this.fetch({postType:n}))},selectPost:function(t){var n=e(t.currentTarget);this.$(".upfront-selector-post.selected").removeClass("selected"),this.selected=e(t.currentTarget).addClass("selected").attr("rel"),this.$(".use_selection_container").removeClass("inactive")},postOk:function(e){e.preventDefault();if(!this.selected)return;return Upfront.Popup.close(),this.deferred.resolve(this.posts.get(this.selected))},fetch:function(e){var t=this,n=new Upfront.Views.Editor.Loading({loading:"Loading...",done:"Thank you for waiting",fixed:!1});this.$(".use_selection_container").addClass("inactive"),this.selected=!1,n.render(),this.$("#upfront-selector-posts").append(n.$el),e.postType&&e.postType!=this.posts.postType&&(e.flush=!0,this.posts.postType=e.postType);var r=e.page;r||(r=0),this.posts.fetchPage(r,e).done(function(e){n.done(),t.$("#upfront-selector-posts").find("table").remove(),t.$("#upfront-selector-posts").append(t.postListTpl({posts:t.posts.getPage(r)})),t.pagination.render()})},search:function(e){e.preventDefault();var t=this.$(".search_container input").val();t?this.fetch({search:t,flush:!0}):this.$(".search_container input").focus()},inputSearch:function(e){e.which==13&&this.search(e)}}),jt=Backbone.View.extend({className:"upfront-loading",is_done:!1,done_callback:[],done_timeout:!1,initialize:function(){},render:function(){var e=this;this.options.fixed&&this.$el.addClass("upfront-loading-fixed"),this.$el.html('<div class="upfront-loading-ani" />'),this.options.loading&&this.$el.append('<p class="upfront-loading-text">'+this.options.loading+"</p>"),this.$el.find(".upfront-loading-ani").on("animationend webkitAnimationEnd MSAnimationEnd oAnimationEnd",function(){var t=e.$el.hasClass("upfront-loading-repeat")?"repeat":e.$el.hasClass("upfront-loading-done")?"done":"start";if(t=="start")if(e.is_done){var n=e.done_text||e.options.done;e.$el.addClass("upfront-loading-done"),e.$el.find(".upfront-loading-text").text(n)}else e.$el.addClass("upfront-loading-repeat");else t=="repeat"?e.$el.removeClass("upfront-loading-repeat"):t=="done"&&(e.remove(),clearTimeout(e.done_timeout),e.done_callback&&_(e.done_callback).each(function(t){t&&t.call&&t.call(e)}))})},on_finish:function(e){this.done_callback.push(e)},done:function(e,t){var n=this;this.is_done=!0,this.done_timeout=setTimeout(function(){n&&(n.remove(),_(n.done_callback).each(function(e){e&&e.call&&e.call(n)}))},6e3),e&&e.call(n),this.done_text=t},cancel:function(e,t){this.remove(),e&&e()}}),Ft=Backbone.View.extend({className:"upfront-inline-panel-item",width:40,height:40,render_icon:function(){var e=typeof this.icon=="function"?this.icon():this.icon;if(!e)return;var t=e.split(" "),n=[],r=this.$el.find(".upfront-icon");_.each(t,function(e){n.push("upfront-icon-region-"+e)}),r.length?r.attr("class","upfront-icon "+n.join(" ")):this.$el.append('<i class="upfront-icon '+n.join(" ")+'" />')},render_label:function(){var e=typeof this.label=="function"?this.label():this.label;if(!e)return;var t=this.$el.find(".upfront-inline-panel-item-label");t.length?t.html(e):this.$el.append('<span class="upfront-inline-panel-item-label">'+e+"</span>")},render_tooltip:function(){var e=typeof this.tooltip=="function"?this.tooltip():this.tooltip;if(!e)return;var t=typeof this.tooltip_pos=="function"?this.tooltip_pos():this.tooltip_pos?this.tooltip_pos:"bottom",n=this.$el.find(".tooltip-content");this.$el.removeClass("tooltip-top tooltip-bottom tooltip-left tooltip-right"),this.$el.addClass("tooltip-inline tooltip-"+t),n.length?n.html(e):this.$el.prepend('<span class="tooltip-content">'+e+"</span>")},render:function(){this.render_icon(),this.render_label(),this.render_tooltip(),this.$el.css({width:this.width,height:this.height}),typeof this.on_render=="function"&&this.on_render()},open_modal:function(t,n){var r=this,i=this.$el.closest(".upfront-region-container"),s=i.find("#upfront-inline-modal-"+this.cid),o;return this.modal_deferred=e.Deferred(),s.length?(o=s.find(".upfront-inline-modal-content"),s.show(),t.apply(this,[o,s])):(s=e('<div class="upfront-inline-modal upfront-ui upfront-no-select" id="upfront-inline-modal-'+this.cid+'" />'),$wrap=e('<div class="upfront-inline-modal-wrap" />'),o=e('<div class="upfront-inline-modal-content" />'),$wrap.append(o),s.append($wrap),i.append(s),t.apply(this,[o,s]),n&&($wrap.append('<button type="button" class="upfront-inline-modal-save">Ok</button>'),s.on("click",function(){r.close_modal(!1)}),s.on("click",".upfront-inline-modal-content",function(e){e.stopPropagation()}),s.on("click",".upfront-inline-modal-save",function(){r.close_modal(!0)})),this.listenTo(Upfront.Events,"entity:region:deactivated",function(){this.close_modal(!1)})),this.update_modal_pos(),e(window).on("scroll",this,this.on_scroll),this.trigger("modal:open"),this.modal_deferred.promise()},close_modal:function(t){var n=this.$el.closest(".upfront-region-container"),r=n.find("#upfront-inline-modal-"+this.cid);r.hide(),e(window).off("scroll",this.on_scroll),this.trigger("modal:close"),t?this.modal_deferred.resolve(this):this.modal_deferred.reject(this)},on_scroll:function(e){var t=e.data;t.update_modal_pos()},update_modal_pos:function(){var t=e(Upfront.Settings.LayoutEditor.Selectors.main),n=this.$el.closest(".upfront-region-container"),r=n.find("#upfront-inline-modal-"+this.cid);if(!r.length||r.css("display")=="none")return;var i=n.offset(),s=i.top,o=s+n.outerHeight(),u=e(document).scrollTop(),a=u+e(window).height(),f=t.offset().top,l=r.offset(),c=l.left+r.width();u>s-f?r.css("position")!="fixed"&&r.css({position:"fixed",top:f,left:l.left,right:e(window).width()-c}):r.css({position:"",top:"",left:"",right:""})},remove:function(){this.panel_view=!1}}),It=Ft.extend({events:{"click >.upfront-icon":"toggle_subitem"},initialize:function(){this.sub_items={},this.listenTo(Upfront.Events,"entity:region:activated",this.on_region_change)},get_selected_item:function(){},get_default_item:function(){},get_selected_icon:function(e){return e+"-active"},set_selected_item:function(e){},select_item:function(e){this.set_selected_item(e),this.render()},render:function(){var t=this,n=this.get_selected_item()||this.get_default_item(),r=e('<div class="upfront-inline-panel-subitem" />');this.$el.html(""),this.icon=this.get_selected_icon(n),this.render_icon(),this.render_tooltip(),_.each(this.sub_items,function(e,i){e.panel_view=t.panel_view,e.parent_view=t,e.render(),e.delegateEvents(),n!=i&&r.append(e.el)}),r.append(this.sub_items[n].el),this.$el.append(r)},toggle_subitem:function(){this.$el.hasClass("upfront-inline-panel-subitem-active")?this.close_subitem():this.open_subitem()},open_subitem:function(){this.$el.addClass("upfront-inline-panel-subitem-active"),this.$el.removeClass("upfront-inline-panel-subitem-inactive")},close_subitem:function(){this.$el.addClass("upfront-inline-panel-subitem-inactive"),this.$el.removeClass("upfront-inline-panel-subitem-active")},on_region_change:function(e){e.model!=this.model&&this.close_subitem()},remove:function(){this.sub_items&&_.each(this.sub_items,function(e){e.remove()}),this.panel_view=!1,Backbone.View.prototype.remove.call(this)}}),qt=Ft.extend({initialize:function(){this.on("modal:open",this.on_modal_open,this),this.on("modal:close",this.on_modal_close,this)},on_modal_open:function(){Upfront.Events.trigger("command:region:edit_toggle",!1)},on_modal_close:function(){Upfront.Events.trigger("command:region:edit_toggle",!0)}}),Rt=qt.extend({events:{"click .upfront-icon":"open_bg_setting"},className:"upfront-inline-panel-item upfront-region-panel-item-bg",icon:function(){return this._active?"bg-setting-active":"bg-setting"},tooltip:"Change Background",_active:!1,open_bg_setting:function(){var e=this.model.get_property_value_by_name("background_type");e||this.model.get_property_value_by_name("background_image")&&this.model.set_property("background_type","image"),this._active=!0,this.render_icon(),this.open_modal(this.render_modal,!0).always(this.on_close_modal).fail(this.notify)},render_modal:function(t,n){var i=this,s=this.model.collection,o=e(r.region_edit_panel),u=o.find("#upfront-region-bg-setting").html(),a=s.indexOf(this.model),f=s.index_container(this.model),l=new yt({model:this.model,property:"type",default_value:"wide",layout:"horizontal-inline",values:[{label:"Full Screen",value:"full",disabled:f>0},{label:"100% wide",value:"wide"},{label:"Contained",value:"clip"}],change:function(){var e=this.get_value();this.model.set({type:e},{silent:!0}),this.property.set({value:e}),e=="full"?d.show():d.hide()}}),c=new yt({model:this.model,property:"nav_region",default_value:"",layout:"horizontal-inline",values:[{label:"No nav",value:""},{label:"Bottom nav",value:"bottom"},{label:"Full screen, top",value:"top"}],change:function(){var e=this.get_value(),t=i.model.get_sub_regions(),n=!1,r=!1,o=!1;a=s.indexOf(i.model);if(e=="")t.top?s.remove(t.top):t.bottom&&s.remove(t.bottom);else{e=="bottom"?t.top?(r=Upfront.Util.model_to_json(t.top),o=new Upfront.Models.Region(r),s.remove(t.top),o.set({sub:e},{silent:!0}),o.add_to(s,a,{sub:e})):t.bottom||(n=t.right?a+2:a+1):t.bottom?(r=Upfront.Util.model_to_json(t.bottom),o=new Upfront.Models.Region(r),s.remove(t.bottom),o.set({sub:e},{silent:!0}),o.add_to(s,a,{sub:e})):t.top||(n=t.left?a-1:a);if(n!==!1){var u=i.model.get("name")+"_nav",f=i.model.get("title")+" Nav",l=new Upfront.Models.Region(_.extend(_.clone(Upfront.data.region_default_args),{name:u,title:f,container:i.model.get("name"),sub:e}));l.add_to(s,n,{sub:e})}}this.property.set({value:e})}}),h=new mt({model:this.model,property:"background_type",default_value:"color",icon_class:"upfront-region-field-icon",values:[{label:"Solid color",value:"color",icon:"color"},{label:"Image",value:"image",icon:"image"},{label:"Image slider",value:"slider",icon:"slider"},{label:"Map",value:"map",icon:"map"},{label:"Video",value:"video",icon:"video"}],change:function(){var e=this.get_value();t.find(".upfront-region-bg-setting-tab").not(".upfront-region-bg-setting-tab-"+e).hide(),t.find(".upfront-region-bg-setting-tab-"+e).show(),i.render_modal_tab(e,t.find(".upfront-region-bg-setting-tab-"+e),t),this.property.set({value:e})}}),p,d;n.closest(".upfront-region-container").find(".upfront-region-finish-edit").css("display","none"),t.html(u),n.addClass("upfront-region-modal-bg"),p=t.find(".upfront-region-bg-setting-region-type"),d=t.find(".upfront-region-bg-setting-region-nav"),this.model.is_main()?(l.render(),p.append(l.$el),c.render(),d.append(c.$el)):(p.hide(),d.hide()),h.render(),t.find(".upfront-region-bg-setting-type").append(h.$el),t.find(".upfront-region-bg-setting-change-image").on("click",function(e){e.preventDefault(),e.stopPropagation(),i.upload_image()}),t.find(".upfront-region-bg-setting-auto-resize").on("click",function(t){t.preventDefault(),t.stopPropagation(),i.trigger_expand_lock(e(this))}),this.render_expand_lock(t.find(".upfront-region-bg-setting-auto-resize")),l.trigger("changed"),h.trigger("changed")},on_close_modal:function(e){e.$el.closest(".upfront-region-container").find(".upfront-region-finish-edit").css("display",""),e._active=!1,e.render_icon()},notify:function(){Upfront.Views.Editor.notify("Background settings have been updated")},render_modal_tab:function(e,t,n){var r=n.find(".upfront-region-bg-setting-change-image");r.hide();switch(e){case"color":this.render_modal_tab_color(t);break;case"image":r.show(),this.render_modal_tab_image(t);break;case"slider":this.render_modal_tab_slider(t);break;case"map":this.render_modal_tab_map(t);break;case"video":this.render_modal_tab_video(t)}},_render_tab_template:function(t,n,i,s){var o=e(r.region_edit_panel),u=e("<div>"+o.find(s?"#upfront-region-bg-setting-tab-"+s:"#upfront-region-bg-setting-tab").html()+"</div>");u.find(".upfront-region-bg-setting-tab-primary").append(n),i&&u.find(".upfront-region-bg-setting-tab-secondary").append(i),t.append(u)},render_modal_tab_color:function(e){var t=this,n=new dt({model:this.model,property:"background_color",default_value:"#ffffff",spectrum:{move:function(e){t.preview_color(e)},change:function(e){t.update_color(e)},hide:function(e){t.reset_color()}}});this._default_color=this.model.get_property_value_by_name("background_color"),n.render(),e.html(""),this._render_tab_template(e,n.$el,"","color")},preview_color:function(e){var t=e.toRgb(),n="rgba("+t.r+","+t.g+","+t.b+","+e.alpha+")";this.model.set_property("background_color",n)},update_color:function(e){var t=this.panel_view.panels_view;this.preview_color(e),this._default_color=this.model.get_property_value_by_name("background_color")},reset_color:function(){var e=this.panel_view.panels_view;this.model.set_property("background_color",this._default_color)},render_modal_tab_image:function(t){var n=this,r=this.model.get_property_value_by_name("background_image"),i=e('<div class="upfront-region-bg-image-style"></div>'),s=e('<div class="upfront-region-bg-image-tile" />'),o=e('<div class="upfront-region-bg-image-fixed clearfix" />'),u=e('<div class="upfront-region-bg-image-fixed-pos"><div class="upfront-region-bg-setting-label-alt">Image Position:</div></div>'),a=e('<div class="upfront-region-bg-image-fixed-pos-num" />'),f=e('<div class="upfront-region-bg-image-fixed-color"><div class="upfront-region-bg-setting-label-alt">Background Color:</div></div>');r||this.upload_image();var l={default_value:50,min:0,max:100,step:1},c={bg_style:new mt({model:this.model,property:"background_style",default_value:"full",icon_class:"upfront-region-field-icon",values:[{label:"Full Width",value:"full",icon:"bg-image-full"},{label:"Tiled / Pattern",value:"tile",icon:"bg-image-tile"},{label:"Fixed Position",value:"fixed",icon:"bg-image-fixed"}],change:function(){var e=this.get_value();e=="tile"?(s.show(),o.hide()):e=="fixed"?(o.show(),s.hide()):(o.hide(),s.hide()),n._bg_style=e,n.update_image()}}),bg_tile:new bt({model:this.model,layout:"horizontal-inline",default_value:["y","x"],values:[{label:"Tile Vertically",value:"y"},{label:"Tile Horizontally",value:"x"}],change:function(){var e=this.get_value();n._bg_tile=e,n.update_image()}}),bg_color:new dt({model:this.model,property:"background_color",default_value:"#ffffff",spectrum:{move:function(e){n.preview_color(e)},change:function(e){n.update_color(e)},hide:function(e){n.reset_color()}}}),bg_position_y:new ht(_.extend({model:this.model,orientation:"vertical",property:"background_position_y",range:!1,change:function(){var e=this.get_value();c.bg_position_y_num.get_field().val(e),n._bg_position_y=e,this.property.set({value:e}),n.update_image()}},l)),bg_position_x:new ht(_.extend({model:this.model,property:"background_position_x",range:!1,change:function(){var e=this.get_value();c.bg_position_x_num.get_field().val(e),n._bg_position_x=e,this.property.set({value:e}),n.update_image()}},l)),bg_position_y_num:new ct(_.extend({model:this.model,label:"Y:",label_style:"inline",suffix:"%",change:function(){var e=this.get_value(),t=c.bg_position_y;t.$el.find("#"+t.get_field_id()).slider("value",e),t.get_field().val(e),t.trigger("changed")}},l)),bg_position_x_num:new ct(_.extend({model:this.model,label:"X:",label_style:"inline",suffix:"%",change:function(){var e=this.get_value(),t=c.bg_position_x;t.$el.find("#"+t.get_field_id()).slider("value",e),t.get_field().val(e),t.trigger("changed")}},l))};t.html(""),_.each(c,function(e){e.render()}),i.append(c.bg_style.$el),s.append(c.bg_tile.$el),a.append(c.bg_position_y_num.$el),a.append(c.bg_position_x_num.$el),u.append(a),u.append(c.bg_position_y.$el),u.append(c.bg_position_x.$el),f.append(c.bg_color.$el),o.append(u),o.append(f),this._render_tab_template(t,i,[s,o],"image"),this._bg_style=c.bg_style.get_value(),this._bg_tile=c.bg_tile.get_value(),this._bg_position_y=c.bg_position_y.get_value(),c.bg_position_y.trigger("changed"),this._bg_position_x=c.bg_position_x.get_value(),c.bg_position_x.trigger("changed"),c.bg_style.trigger("changed")},upload_image:function(){var t=this;Upfront.Views.Editor.ImageSelector.open().done(function(n){var r={},i;_.each(n,function(e,t){r=e,i=t}),e("<img>").attr("src",r.full[0]).load(function(){Upfront.Views.Editor.ImageSelector.close(),t.model.set_property("background_image",r.full[0]),t.model.set_property("background_image_ratio",Math.round(r.full[2]/r.full[1]*100)/100)})})},update_image:function(){var e=this._bg_style,t=this._bg_tile,n=_.contains(t,"y"),r=_.contains(t,"x"),i=this._bg_position_y,s=this._bg_position_x;e=="full"?this.model.set_property("background_style","full"):e=="tile"?(this.model.set_property("background_style","tile"),r&&n?this.model.set_property("background_repeat","repeat"):n?this.model.set_property("background_repeat","repeat-y"):r?this.model.set_property("background_repeat","repeat-x"):this.model.set_property("background_repeat","no-repeat")):e=="fixed"&&(this.model.set_property("background_style","fixed"),this.model.set_property("background_repeat","no-repeat"),this.model.set_property("background_position",s+"% "+i+"%"))},render_modal_tab_slider:function(t){var n=this,r=this.model.get_property_value_by_name("background_slider_images"),i=e('<div class="upfront-region-bg-slider-rotate clearfix" />'),s=e('<div class="upfront-region-bg-slider-transition upfront-settings-item"><div class="upfront-settings-item-title" /><div class="upfront-settings-item-content" /></div>'),o=s.find(".upfront-settings-item-title"),u=s.find(".upfront-settings-item-content"),a=e('<div class="upfront-region-bg-slider-slides upfront-settings-item"><div class="upfront-settings-item-title" /><div class="upfront-settings-item-content upfront-no-select clearfix" /></div>'),f=a.find(".upfront-settings-item-title"),l=a.find(".upfront-settings-item-content"),c=function(){var e=this.get_value();this.property.set({value:e})};r||Upfront.Views.Editor.ImageSelector.open({multiple:!0}).done(function(e){var t=[];_.each(e,function(e,n){t.push(n)}),n.model.set_property("background_slider_images",t),n.update_slider_slides(l),Upfront.Views.Editor.ImageSelector.close()});var h={rotate:new bt({model:this.model,property:"background_slider_rotate",default_value:!0,layout:"horizontal-inline",multiple:!1,values:[{label:"Rotate automatically every ",value:!0}],change:function(){var e=this.get_value();this.property.set({value:e?!0:!1})}}),rotate_time:new ct({model:this.model,property:"background_slider_rotate_time",default_value:5,min:1,max:60,step:1,suffix:"sec",change:c}),control:new yt({model:this.model,property:"background_slider_control",default_value:"always",layout:"horizontal-inline",values:[{label:"Always show slider controls",value:"always"},{label:"Show controls on hover",value:"hover"}],change:c}),transition:new mt({model:this.model,property:"background_slider_transition",default_value:"crossfade",icon_class:"upfront-region-field-icon",values:[{label:"Slide Down",value:"slide-down",icon:"bg-slider-slide-down"},{label:"Slide Up",value:"slide-up",icon:"bg-slider-slide-up"},{label:"Slide Left",value:"slide-left",icon:"bg-slider-slide-left"},{label:"Slide Right",value:"slide-right",icon:"bg-slider-slide-right"},{label:"Crossfade",value:"crossfade",icon:"bg-slider-crossfade"}],change:c})};t.html(""),_.each(h,function(e){e.render()}),i.append(h.rotate.$el),i.append(h.rotate_time.$el),f.text("Slides Order:"),this._render_tab_template(t,h.transition.$el,[i,h.control.$el,a],"slider"),n.update_slider_slides(l),l.on("click",".upfront-region-bg-slider-add-image",function(e){e.preventDefault(),e.stopPropagation(),Upfront.Views.Editor.ImageSelector.open({multiple:!0}).done(function(e){var t=_.clone(n.model.get_property_value_by_name("background_slider_images")||[]);_.each(e,function(e,n){t.push(n)}),n.model.set_property("background_slider_images",t),Upfront.Views.Editor.ImageSelector.close(),n.update_slider_slides(l)})}),l.on("click",".upfront-region-bg-slider-delete-image",function(t){t.preventDefault(),t.stopPropagation();var r=e(this).closest(".upfront-region-bg-slider-image"),i=r.data("image-id"),s=n.model.get_property_value_by_name("background_slider_images");s=_.without(s,i),n.model.set_property("background_slider_images",s),r.remove()})},update_slider_slides:function(t){var n=this,r=n.model.get_property_value_by_name("background_slider_images"),i=e('<div class="upfront-region-bg-slider-add-image upfront-icon upfront-icon-region-add-slide">Add Slide</div>');t.html(""),r?Upfront.Views.Editor.ImageEditor.getImageData(r).done(function(s){var o=s.data.images;_.each(r,function(n){var r=o[n],i=e('<div class="upfront-region-bg-slider-image" />');i.data("image-id",n),i.css({background:'url("'+r.thumbnail[0]+'") no-repeat 50% 50%',backgroundSize:"100% auto"}),i.append('<span href="#" class="upfront-region-bg-slider-delete-image">&times;</span>'),t.append(i)}),t.hasClass("ui-sortable")?t.sortable("refresh"):t.sortable({items:">  .upfront-region-bg-slider-image",update:function(){var r=[];t.find(".upfront-region-bg-slider-image").each(function(){var t=e(this).data("image-id");t&&r.push(t)}),n.model.set_property("background_slider_images",r)}}),t.append(i)}):t.append(i)},render_modal_tab_map:function(t){var n=this,r=this.model.get_property_value_by_name("background_map_center"),i=e('<div class="upfront-region-bg-map-location clearfix" />'),s=e('<div class="upfront-region-bg-map-style-control clearfix" />'),o=function(){var e=this.get_value();this.property.set({value:e})};r||(this.model.init_property("background_map_center",[10.72225,106.730762]),this.model.init_property("background_map_zoom",10),this.model.init_property("background_map_style","ROADMAP"),this.model.init_property("background_map_controls","")),this.once("modal:close",function(){n.geocode_location()});var u={location:new ut({model:this.model,label:"Location:",property:"background_map_location",placeholder:"e.g 123 Nice St",change:function(){var e=this.get_value();this.property.set({value:e},{silent:!0}),n._location=e,n._location_changed=!0}}),zoom:new ht({model:this.model,label:"Zoom:",property:"background_map_zoom",default_value:8,min:1,max:19,step:1,change:o}),style:new mt({model:this.model,label:"Map Style:",property:"background_map_style",values:[{label:"Roadmap",value:"ROADMAP"},{label:"Satellite",value:"SATELLITE"},{label:"Hybrid",value:"HYBRID"},{label:"Terrain",value:"TERRAIN"}],change:o}),controls:new mt({model:this.model,label:"Controls:",property:"background_map_controls",multiple:!0,default_value:["pan"],values:[{label:"Pan",value:"pan"},{label:"Zoom",value:"zoom"},{label:"Map Type",value:"map_type"},{label:"Scale",value:"scale"},{label:"Street View",value:"street_view"},{label:"Overview Map",value:"overview_map"}],change:o})};_.each(u,function(e){e.render()}),t.html(""),this._location=u.location.get_value(),i.append(u.location.$el),i.append('<i class="upfront-field-icon upfront-field-icon-refresh-2 upfront-refresh-map" />'),i.on("click",".upfront-refresh-map",function(){n.geocode_location()}),s.append(u.style.$el),s.append(u.controls.$el),this._render_tab_template(t,"",[i,u.zoom.$el,s])},geocode_location:function(){if(this._geocoding==1||!this._location_changed)return;var e=this,t=this._location,n=new google.maps.Geocoder;this._geocoding=!0,n.geocode({address:t},function(t,n){if(n!=google.maps.GeocoderStatus.OK)return!1;var r=t[0].geometry.location;e.model.set_property("background_map_center",[r.lat(),r.lng()]),e._geocoding=!1,e._location_changed=!1})},render_modal_tab_video:function(t){var n=this,r='<div class="upfront-region-bg-setting-label"></div>',i=e(r).text("Video background behavior"),s=e(r).text("Video URL"),o={mute:new bt({model:this.model,property:"background_video_mute",default_value:!0,layout:"horizontal-inline",multiple:!1,values:[{label:"Mute video on play?",value:!0}],change:function(){var e=this.get_value();this.property.set({value:e?!0:!1})}}),video:new ut({model:this.model,property:"background_video",default_value:"",placeholder:"Video URL (YouTube, Vimeo or Wistia)",change:function(){var e=this.get_value();e&&(n.model.set_property("background_video_embed",""),n.get_video_embed(e).done(function(e){console.log(e);if(!e.data||!e.data.width||!e.data.height)return;n.model.set_property("background_video_width",e.data.width),n.model.set_property("background_video_height",e.data.height),n.model.set_property("background_video_embed",e.data.html)})),this.property.set({value:e})}}),style:new yt({model:this.model,property:"background_video_style",layout:"horizontal-inline",default_value:["crop"],values:[{label:"Scale & crop",value:"crop"},{label:"No crop embed",value:"full"},{label:"No crop + bg color",value:"inside"}],change:function(){var e=this.get_value();e=="inside"?o.color.$el.show():o.color.$el.hide(),this.property.set({value:e})}}),color:new dt({model:this.model,label:"Area BG Color:",label_style:"inline",property:"background_color",default_value:"#ffffff",spectrum:{move:function(e){n.preview_color(e)},change:function(e){n.update_color(e)},hide:function(e){n.reset_color()}}})};t.html(""),_.each(o,function(e){e.render()}),this._render_tab_template(t,"",[i,o.style.$el,o.color.$el,s,o.video.$el],"video"),o.style.trigger("changed")},get_video_embed:function(e){return Upfront.Util.post({action:"upfront-media-get_embed_raw",media:e})},render_expand_lock:function(t){var n=this.model.get_property_value_by_name("expand_lock"),r=e('<i class="upfront-field-icon upfront-region-field-icon" />'),i=e("<span />");n?(r.addClass("upfront-region-field-icon-expand-lock"),i.addClass("auto-resize-off").text("OFF")):(r.addClass("upfront-region-field-icon-expand-unlock"),i.addClass("auto-resize-on").text("ON")),t.html(""),t.append(r),t.append("<span>Auto-resize is </span>"),t.append(i)},trigger_expand_lock:function(e){var t=this.model.get_property_value_by_name("expand_lock");this.model.set_property("expand_lock",!t),this.render_expand_lock(e)}}),Ut=Ft.extend({events:{"click .upfront-icon":"toggle_lock"},className:"upfront-inline-panel-item upfront-region-panel-item-expand-lock",icon:function(){var e=this.model.get_property_value_by_name("expand_lock");return e?"expand-lock":"expand-unlock"},tooltip:function(){var e=this.model.get_property_value_by_name("expand_lock"),t='<span class="'+(e?"expand-lock-active":"expand-lock-inactive")+'">'+(e?"OFF":"ON")+"</span>";return"Auto-expand to fit <br />elements as they <br />are added "+t},toggle_lock:function(){var e=this.model.get_property_value_by_name("expand_lock");this.model.set_property("expand_lock",!e),this.render_icon(),this.render_tooltip()}}),zt=Ft.extend({events:{"click .upfront-icon":"add_region"},className:"upfront-inline-panel-item upfront-region-panel-item-add-region",icon:function(){var e=this.options.to;return"add add-"+e},tooltip:function(){var e=this.options.to;switch(e){case"bottom":var t="below";break;case"left":var t="before";break;case"right":var t="after";break;default:var t="above"}return"Insert new region "+t},tooltip_pos:function(){var e=this.options.to;switch(e){case"bottom":var t="top";break;case"left":var t="right";break;case"right":var t="left";break;default:var t="bottom"}return t},initialize:function(){this.options.to||(this.options.to="top")},add_region:function(){var e=this.options.to,t=this.model.collection,n=t.size()-1,r=t.indexOf(this.model),i=r>0?t.at(r-1):!1,s=r<n-1?t.at(r+1):!1,o=e=="top"||e=="bottom",u=e=="top"||e=="left",a=o?"Region "+n:this.model.get("name")+" "+e.charAt(0).toUpperCase()+e.slice(1),f=a.toLowerCase().replace(/\s/,"-"),l=new Upfront.Models.Region(_.extend(_.clone(Upfront.data.region_default_args),{name:f,container:o?f:this.model.get("name"),title:a}));l.set_property("row",20),o?e=="top"&&i&&i.get("container")&&i.get("container")!=i.get("name")?r--:e=="bottom"&&s&&s.get("container")&&s.get("container")!=s.get("name")&&r++:l.set_property("col",5),l.get("clip")?(Upfront.Events.once("entity:region:before_render",this.before_animation,this),Upfront.Events.once("entity:region:after_render",this.run_animation,this)):(Upfront.Events.once("entity:region_container:before_render",this.before_animation,this),Upfront.Events.once("entity:region_container:after_render",this.run_animation,this)),l.add_to(t,u?r:r+1,{sub:u?"left":"right"})},before_animation:function(e,t){Upfront.Events.trigger("command:region:edit_toggle",!1)},run_animation:function(t,n){function o(){var e=Upfront.Settings.LayoutEditor.Grid.baseline,n=t.$el.outerHeight();t.$el.removeClass(i),Upfront.Events.trigger("command:region:edit_toggle",!0),t.trigger("activate_region",t)}var r=this.options.to,i="upfront-add-region-ani upfront-add-region-ani-"+r,s=setTimeout(o,2e3);t.$el.addClass(i),(r=="top"||r=="bottom")&&t.$el.one("animationstart webkitAnimationStart MSAnimationStart oAnimationStart",function(){var t=e(this).hasClass("upfront-region-container")?e(this):e(this).closest(".upfront-region-container"),n=t.offset(),i=e(document).scrollTop(),s=!1;r=="top"&&n.top<i?s=n.top-50:r=="bottom"&&(s=e(document).height()-e(window).height()),s!==!1&&e("html,body").animate({scrollTop:s},200)}),t.$el.one("animationend webkitAnimationEnd MSAnimationEnd oAnimationEnd",function(){o(),clearTimeout(s)})}}),Wt=Ft.extend({events:{"click .upfront-icon":"delete_region"},className:"upfront-inline-panel-item upfront-region-panel-item-delete-region",icon:"delete",tooltip:"Delete this section",delete_region:function(){confirm("Are you sure you want to delete this section?")&&this.model.collection.remove(this.model)}}),Xt=Backbone.View.extend({className:"upfront-inline-panel upfront-no-select",position_v:"top",position_h:"center",initialize:function(){this.items=_([])},render:function(){var e=this,t=typeof this.items=="function"?this.items():this.items,n=["upfront-inline-panel-"+this.position_v,"upfront-inline-panel-"+this.position_v+"-"+this.position_h],r=0,i=0;this.$el.html(""),t.each(function(t){t.panel_view=e,t.render(),t.delegateEvents(),e.$el.append(t.el),e.position_v=="center"?(r=t.width>r?t.width:r,i+=t.height):(r+=t.width,i=t.height>i?t.height:i)}),this.$el.attr("class",this.className+" "+n.join(" ")),this.$el.css({width:r,height:i})},remove:function(){var e=typeof this.items=="function"?this.items():this.items;e&&e.each(function(e){e.remove()}),Backbone.View.prototype.remove.call(this)}}),Vt=Xt.extend({initialize:function(){this.items=_([])},render:function(){var e=this,t=typeof this.items=="function"?this.items():this.items,n=["upfront-inline-panel-"+this.position_v,"upfront-inline-panel-"+this.position_v+"-"+this.position_h],r=0,i=0;this.$el.html(""),t.each(function(t){t.panel_view=e,t.render(),t.delegateEvents(),e.$el.append(t.el),e.position_v=="center"?i+=t.$el.height():r+=t.$el.width()}),this.$el.attr("class",this.className+" "+n.join(" "))},remove:function(){var e=typeof this.items=="function"?this.items():this.items;e&&e.each(function(e){e.remove()}),Backbone.View.prototype.remove.call(this)}}),$t=Xt.extend({className:"upfront-inline-panel upfront-region-panel-edit upfront-no-select",initialize:function(){this.bg=new Rt({model:this.model}),this.model.is_main()&&(this.add_region=new zt({model:this.model,to:"top"})),this.delete_region=new Wt({model:this.model})},items:function(){var e=_([]),t=this.model.get_property_value_by_name("background_type"),n=this.model.get("sub");return e.push(this.bg),this.add_region&&t!="full"&&e.push(this.add_region),this.model.is_main()?!this.model.has_side_region()&&!this.model.get("default")&&this.model.get("scope")!="global"&&e.push(this.delete_region):n!="top"&&n!="bottom"&&e.push(this.delete_region),e}}),Jt=Xt.extend({initialize:function(){this.options.to||(this.options.to="bottom");var e=this.options.to;this.items=_([new zt({model:this.model,to:e})]);if(e=="bottom")this.position_v="bottom";else if(e=="left"||e=="right")this.position_v="center",this.position_h=e},items:function(){return _([this.add_region])}}),Kt=Xt.extend({position_h:"right",initialize:function(){this.items=_([new Wt({model:this.model})])}}),Qt=Backbone.View.extend({className:"upfront-inline-panels upfront-ui",initialize:function(){this.panels=_([])},render:function(){var t=this,n=typeof this.panels=="function"?this.panels():this.panels,r=e('<div class="upfront-inline-panels-wrap" />');this.$el.html(""),n.each(function(e){if(!e)return;e.panels_view=t,e.render(),e.delegateEvents(),r.append(e.el)}),this.$el.append(r),typeof this.on_render=="function"&&this.on_render()},on_active:function(){e(".upfront-inline-panels-active").removeClass("upfront-inline-panels-active"),this.$el.addClass("upfront-inline-panels-active")},remove:function(){var e=typeof this.panels=="function"?this.panels():this.panels;e&&e.each(function(e){e.remove()}),Backbone.View.prototype.remove.call(this)}}),Gt=Qt.extend({initialize:function(){var t=this.model.get("container"),n=this.model.get("name");this.listenTo(this.model.collection,"add",this.render),this.listenTo(this.model.collection,"remove",this.render),this.listenTo(Upfront.Events,"entity:region:activated",this.on_region_active),this.listenTo(Upfront.Events,"command:region:edit_toggle",this.update_pos),e(window).on("scroll",this,this.on_scroll),this.edit_panel=new $t({model:this.model}),this.delete_panel=new Kt({model:this.model}),this.add_panel_bottom=new Jt({model:this.model,to:"bottom"}),this.model.is_main()&&this.model.get("allow_sidebar")&&(this.add_panel_left=new Jt({model:this.model,to:"left"}),this.add_panel_right=new Jt({model:this.model,to:"right"}))},panels:function(){var e=_([]),t=this.model.collection||new Backbone.Collection([]),n=this.model.get("container")||this.model.get("name"),r=t.indexOf(this.model),i=t.size()-1;e.push(this.edit_panel),r==i-1&&e.push(this.add_panel_bottom);if(this.model.is_main()){var s=this.model.get_sub_regions();this.model.get("allow_sidebar")&&(s.left===!1&&e.push(this.add_panel_left),s.right===!1&&e.push(this.add_panel_right))}return this._panels=e,e},on_scroll:function(e){var t=e.data;t.update_pos()},on_region_active:function(e){if(e.model!=this.model)return;this.on_active(),this.update_pos()},update_pos:function(){var t=e(Upfront.Settings.LayoutEditor.Selectors.main),n=this.$el.closest(".upfront-region");if(!t.hasClass("upfront-region-editing")||!n.hasClass("upfront-region-active"))return;var r=n.offset(),i=r.top,s=i+n.outerHeight(),o=e(document).scrollTop(),u=o+e(window).height(),a=t.offset().top;this._panels.each(function(t){var f=t.$el.offset();if(t.position_v=="top"&&o>i-a&&o<s-a)t.$el.css("position")!="fixed"&&t.$el.css({position:"fixed",top:a,left:f.left,right:"auto"});else if(t.position_v=="bottom"&&s>u&&i<u)t.$el.css("position")!="fixed"&&t.$el.css({position:"fixed",bottom:0,left:f.left,right:"auto"});else if(t.position_v=="center"&&(o>i-a||s>u)){var l=o>i-a?a:i-o,c=s>u?0:u-s,h=t.position_h=="left"?f.left:"auto",p=t.position_h=="right"?e(window).width()-(r.left+n.width()):"auto";t.$el.css("position")!="fixed"?t.$el.css({position:"fixed",top:l,bottom:c,left:h,right:p}):t.$el.css({top:l,bottom:c})}else t.$el.css({position:"",top:"",bottom:"",left:"",right:""})})},remove:function(){this.edit_panel.remove(),this.delete_panel.remove(),this.add_panel_bottom.remove(),this.edit_panel=!1,this.delete_panel=!1,this.add_panel_bottom=!1,this.model.is_main()&&this.model.get("allow_sidebar")&&(this.add_panel_left.remove(),this.add_panel_right.remove(),this.add_panel_left=!1,this.add_panel_right=!1),e(window).off("scroll",this,this.on_scroll),Backbone.View.prototype.remove.call(this)}});return{Editor:{Property:s,Properties:o,Commands:k,Command:u,Command_SaveLayout:h,Command_Undo:m,Command_ToggleGrid:S,Command_Merge:b,Layouts:it,Settings:{Settings:Tt,Panel:xt,Item:Et,ItemTabbed:St,Anchor:{Trigger:Ot,LabeledTrigger:Mt}},Field:{Field:ot,Text:ut,Button:at,Email:ft,Textarea:lt,Color:dt,Multiple_Suggest:wt,Number:ct,Slider:ht,Select:mt,Radios:yt,Checkboxes:bt,Hidden:pt,Anchor:_t},Sidebar:{Sidebar:z,Panel:L,Element:O},notify:function(e,t){Pt.addMessage(e,t)},Loading:jt,PostSelector:new Bt,InlinePanels:{Panels:Qt,Panel:Xt,ItemMulti:It,Item:Ft},RegionPanels:Gt,CSSEditor:Lt}}})}(jQuery),function(e){var t={create_mergeable:function(){e(".ui-selectable").each(function(){e(this).selectable("destroy")});var t=this,n=[],r=t.layout.get("regions").active_region,i=r?r.get("modules"):!1;i&&e(".upfront-region").selectable({filter:".upfront-module",stop:function(){if(e(".ui-selected").length<2)return!1;e(".ui-selected").each(function(){var t=e(this),r=t.attr("id"),s=i.get_by_element_id(r);s&&s.get&&!s.get("name")?n.push(s):t.removeClass("ui-selected")}),e(".upfront-active_entity").removeClass("upfront-active_entity"),e(".ui-selected").removeClass("ui-selected").addClass("upfront-active_entity");if(!n.length)return!1;t.command_view.commands.push(new Upfront.Views.Editor.Command_Merge({model:_.extend({},t.layout,{merge:n})})),t.command_view.render()}})},destroy_mergeable:function(){e(".ui-selectable").each(function(){e(this).selectable("destroy")})},create_undo:function(){this.layout.store_undo_state()},apply_history_change:function(){var e=Upfront.Application.layout.get("regions"),t=e?e.get_by_name("shadow"):!1;e&&t&&(e.remove(t),t=!1),Upfront.Application.layout_view.render()},save_dialog:function(t,n){e("body").append("<div id='upfront-save-dialog-background' />"),e("body").append("<div id='upfront-save-dialog' />");var r=e("#upfront-save-dialog"),i=e("#upfront-save-dialog-background"),s=Upfront.Application.LayoutEditor.layout.get("current_layout"),o="";i.width(e(window).width()).height(e(document).height()),o+="<p>Do you wish to save layout just for this post or apply it to all posts?</p>",e.each(_upfront_post_data.layout,function(e,t){if(e=="type")return;o+='<span class="upfront-save-button" data-save-as="'+t+'">'+Upfront.Settings.LayoutEditor.Specificity[e]+"</span>"}),r.html(o),e("#upfront-save-dialog").on("click",".upfront-save-button",function(){var s=e(this).attr("data-save-as");return i.remove(),r.remove(),t.apply(n,[s]),!1}),e("#upfront-save-dialog-background").on("click",function(){return i.remove(),r.remove(),!1})}},n={main:{$el:null,top:0,left:0,right:0},grid_layout:{top:0,left:0,right:0},containment:{$el:null,top:0,left:0,right:0,col:0,grid:{top:0,left:0,right:0}},min_col:1,max_row:0,compare_col:3,compare_row:5,timeout:0,_t:null,col_size:0,baseline:0,grid:null,els:[],wraps:[],regions:[],drops:[],drop:null,el_selector:".upfront-module",_id:0,show_debug_element:!1,resizing:!1,_new_id:function(){var e=Upfront.Behaviors.GridEditor;return e._id++,e._id},get_grid:function(e,t){var n=Upfront.Behaviors.GridEditor,r=Math.round((e-n.grid_layout.left)/n.col_size)+1,i=Math.round((t-n.grid_layout.top)/n.baseline)+1;return{x:r,y:i}},get_position:function(t){var n=Upfront.Behaviors.GridEditor,r=e(t),i=r.outerWidth(),s=r.outerHeight(),o=r.offset().top,u=r.offset().left,a=r.outerWidth(!0),f=r.outerHeight(!0),l=o-parseFloat(r.css("margin-top")),c=u-parseFloat(r.css("margin-left")),h=n.get_grid(u,o),p=n.get_grid(c,l),d=Math.round(i/n.col_size),v=Math.round(a/n.col_size),m=Math.round(s/n.baseline),g=Math.round(f/n.baseline),y=r.closest(".upfront-region"),b=y.data("name");return{$el:r,_id:n._new_id(),position:{top:o,left:u,bottom:o+s,right:u+i},outer_position:{top:Math.round(l),left:Math.round(c),bottom:Math.round(l+f),right:Math.round(c+a)},width:i,height:s,center:{y:Math.round(o+s/2),x:Math.round(u+i/2)},col:d,row:m,grid:{top:h.y,left:h.x,right:h.x+d-1,bottom:h.y+m-1},outer_grid:{top:p.y,left:p.x,right:p.x+v-1,bottom:p.y+g-1},grid_center:{y:h.y+m/2-1,x:h.x+d/2-1},region:b}},init_margin:function(t){var n=Upfront.Behaviors.GridEditor,r=e(t),i=n.get_class_num(r,n.grid.left_margin_class),s=n.get_class_num(r,n.grid.right_margin_class),o=n.get_class_num(r,n.grid.top_margin_class),u=n.get_class_num(r,n.grid.bottom_margin_class);r.data("margin",{original:{left:i,right:s,top:o,bottom:u},current:{left:i,right:s,top:o,bottom:u}})},get_affected_els:function(e,t,n,r){var i={top:[],left:[],bottom:[],right:[]},s=e.outer_grid;Array.isArray(n)?n.push(e):n=[e],r=r?!0:!1,_.each(_.reject(t,function(e){var t=_.find(n,function(t){return t.$el.get(0)==e.$el.get(0)});return t?!0:!1}),function(t){if(e.region!=t.region)return;if(t.outer_grid.top>=s.top&&t.outer_grid.top<s.bottom||t.outer_grid.bottom>=s.top&&t.outer_grid.bottom<=s.bottom||s.top>=t.outer_grid.top&&s.top<t.outer_grid.bottom||s.bottom>=t.outer_grid.top&&s.bottom<=t.outer_grid.bottom)s.left>t.outer_grid.right&&i.left.push(t),s.right<t.outer_grid.left&&i.right.push(t);s.top>t.outer_grid.bottom&&i.top.push(t),s.bottom<t.outer_grid.top&&i.bottom.push(t)});if(r){var o=_.max(i.left,function(e){return e.outer_grid.right});i.left=_.filter(i.left,function(e){return e.outer_grid.right==o.outer_grid.right});var u=_.min(i.right,function(e){return e.outer_grid.left});i.right=_.filter(i.right,function(e){return e.outer_grid.left==u.outer_grid.left});var a=_.max(i.top,function(e){return e.outer_grid.top});i.top=_.filter(i.top,function(e){return e.outer_grid.top==a.outer_grid.top});var f=_.min(i.bottom,function(e){return e.outer_grid.top});i.bottom=_.filter(i.bottom,function(e){return e.outer_grid.top==f.outer_grid.top})}return i},get_affected_wrapper_els:function(e,t,n,r){var i=Upfront.Behaviors.GridEditor,s=i.get_affected_els(e,t,n,r),o={top:_.flatten(_.map(s.top,function(e){var t=_.reject(i.get_wrap_els(e),function(e){return n?_.find(n,function(t){return t.$el.get(0)==e.$el.get(0)}):!1}),r=i.get_wrap_el_max(e,n,!0);return _.filter(t,function(e){return e.outer_grid.bottom==r.outer_grid.bottom})})),bottom:_.flatten(_.map(s.bottom,function(e){var t=_.reject(i.get_wrap_els(e),function(e){return n?_.find(n,function(t){return t.$el.get(0)==e.$el.get(0)}):!1}),r=i.get_wrap_el_min(e,n,!0);return _.filter(t,function(e){return e.outer_grid.top==r.outer_grid.top})})),left:_.flatten(_.map(s.left,function(e){var t=_.reject(i.get_wrap_els(e),function(e){return n?_.find(n,function(t){return t.$el.get(0)==e.$el.get(0)}):!1}),r=i.get_wrap_el_max(e,n,!1);return _.filter(t,function(e){return e.outer_grid.right==r.outer_grid.right})})),right:_.flatten(_.map(s.right,function(e){var t=_.reject(i.get_wrap_els(e),function(e){return n?_.find(n,function(t){return t.$el.get(0)==e.$el.get(0)}):!1}),r=i.get_wrap_el_min(e,n,!1);return _.filter(t,function(e){return e.outer_grid.left==r.outer_grid.left})}))};return o},get_move_limit:function(e,t){var n=[t.grid.left,t.grid.right];return _.each(e.left,function(e){e.grid.right>n[0]&&(n[0]=e.grid.right+1)}),_.each(e.right,function(e){e.grid.left<n[1]&&(n[1]=e.grid.left-1)}),n},get_max_size:function(e,t,n,r){var i=Upfront.Behaviors.GridEditor,s=i.get_class_num(e.$el,i.grid.class),r=/all|nw|se/.test(r)?r:"all",o=e.$el.data("margin"),u=i.get_affected_els(e,t,[],!0),a=i.get_move_limit(u,i.containment),f=r=="nw"?s+e.grid.left-a[0]:r=="se"?s+a[1]-e.grid.right:a[1]-a[0]+1,l=n.$el.hasClass("upfront-region-expand-lock"),c=u.bottom.length?_.min(u.bottom,function(e){return e.grid.top}):!1,h=c?c.grid.top-e.grid.top:n.grid.bottom-e.grid.top,p=r=="nw"?o.original.top+e.row:r=="se"?h:h+o.original.top;return{col:f,row:l||r=="nw"?p:!1}},get_wrap_els:function(t){var n=Upfront.Behaviors.GridEditor,r=t.$el.find(n.el_selector);return _.map(r,function(t){var t=n.get_el(e(t));return _.find(n.els,function(e){return e._id==t._id})})},get_wrap_el_min:function(e,t,n){var r=Upfront.Behaviors.GridEditor,i=r.get_wrap_els(e),s=_.min(_.reject(i,function(e){return t?_.find(t,function(t){return t.$el.get(0)==e.$el.get(0)}):!1}),function(e){return n?e.grid.top:e.grid.left});return _.isObject(s)?s:!1},get_wrap_el_max:function(e,t,n){var r=Upfront.Behaviors.GridEditor,i=r.get_wrap_els(e),s=_.max(_.reject(i,function(e){return t?_.find(t,function(t){return t.$el.get(0)==e.$el.get(0)}):!1}),function(e){return n?e.grid.bottom:e.grid.right});return _.isObject(s)?s:!1},get_el:function(e){var t=Upfront.Behaviors.GridEditor;return _.find(t.els,function(t){return e.get(0)==t.$el.get(0)})},get_wrap:function(e){var t=Upfront.Behaviors.GridEditor;return _.find(t.wraps,function(t){return e.get(0)==t.$el.get(0)})},get_region:function(e){var t=Upfront.Behaviors.GridEditor;return _.find(t.regions,function(t){return e.get(0)==t.$el.get(0)})},get_drop:function(e){var t=Upfront.Behaviors.GridEditor;return _.find(t.drops,function(t){return e.get(0)==t.$el.get(0)})},get_class_num:function(e,t){var n=_.isString(e)?e:e.attr("class"),r=new RegExp("\\b"+t+"(\\d+)"),i=n.match(r);return i&&i[1]?parseInt(i[1]):0},get_el_model:function(e){var t=Upfront.Application.LayoutEditor,n=Upfront.Behaviors.GridEditor,r=t.layout.get("regions"),i;return r.find(function(t){var n=t.get("modules"),r=n.get_by_element_id(e.attr("id"));return r?(i=r,!0):(n.find(function(t){var n=t.get("objects").get_by_element_id(e.attr("id"));return n?(i=n,!0):!1}),i?!0:!1)}),i?i:!1},update_class:function(e,t,n){var r=new RegExp("\\b"+t+"\\d+");e.hasClass(t+n)||(e.attr("class").match(r)?e.attr("class",e.attr("class").replace(r,t+n)):e.addClass(t+n))},update_margin_classes:function(e){this.time_start("fn update_margin_classes");var t=e.data("margin"),n=Upfront.Behaviors.GridEditor;t.current!=t.original&&(n.update_class(e,n.grid.left_margin_class,t.current.left),n.update_class(e,n.grid.right_margin_class,t.current.right),n.update_class(e,n.grid.top_margin_class,t.current.top),n.update_class(e,n.grid.bottom_margin_class,t.current.bottom)),this.time_end("fn update_margin_classes")},update_model_classes:function(e,t){this.time_start("fn update_model_classes");var n=this.get_el_model(e);n&&n.replace_class(t.join(" ")),this.time_end("fn update_model_classes")},update_model_margin_classes:function(t,n){var r=Upfront.Behaviors.GridEditor;t.each(function(){var t=e(this),i=t.data("margin"),s;i&&(i.original.left!=i.current.left||i.original.top!=i.current.top||i.original.bottom!=i.current.bottom||i.original.right!=i.current.right)&&(s=[r.grid.left_margin_class+i.current.left,r.grid.right_margin_class+i.current.right,r.grid.top_margin_class+i.current.top,r.grid.bottom_margin_class+i.current.bottom],n&&(s=_.union(s,n)),r.update_model_classes(t,s))})},adjust_els_right:function(e,t,n){this.time_start("fn adjust_els_right");var r=Upfront.Behaviors.GridEditor;_.each(e,function(e){var i=e.$el.data("margin"),s=e.grid.left>t?e.grid.left-t-1:i.current.left;i.current.left!=s&&(i.current.left=s,n&&r.update_margin_classes(e.$el),e.$el.data("margin",i))}),this.time_end("fn adjust_els_right")},adjust_affected_right:function(e,t,n,r,i){this.time_start("fn adjust_affected_right");var s=Upfront.Behaviors.GridEditor,o=s.get_wrap_el_max(e,n),u=o?r&&r>o.grid.right?r:o.grid.right:r?r:e.grid.left-1;s.adjust_els_right(t,u,i),r+1==s.containment.grid.left&&s.get_wrap_els(e).length==0&&e.$el.nextAll(".upfront-wrapper:eq(0)").data("clear","clear"),this.time_end("fn adjust_affected_right")},adjust_els_bottom:function(e,t,n){this.time_start("fn adjust_els_bottom");var r=Upfront.Behaviors.GridEditor;_.each(e,function(e){var i=e.$el.data("margin"),s=e.grid.top>t?e.grid.top-t-1:i.current.top;i.current.top!=s&&(i.current.top=s,n&&r.update_margin_classes(e.$el),e.$el.data("margin",i))}),this.time_end("fn adjust_els_bottom")},adjust_affected_bottom:function(e,t,n,r,i){this.time_start("fn adjust_affected_bottom");var s=Upfront.Behaviors.GridEditor,o=s.get_wrap_el_max(e,n,!0),u=o?r&&r>o.grid.bottom?r:o.grid.bottom:r?r:e.grid.bottom-1;s.adjust_els_bottom(t,u,i),this.time_end("fn adjust_affected_bottom")},normalize:function(t,n){var r=Upfront.Application.LayoutEditor,i=Upfront.Behaviors.GridEditor,s=r.layout.get("regions"),o=[];_.each(n,function(t){var r=t.$el.find(".upfront-module");r.size()>1&&r.each(function(){var t=i.get_el(e(this)),r=i.get_affected_els(t,n,[],!0);if(r.left.length==0&&r.right.length==0){var u=i.get_el_model(t.$el),a=Upfront.data.module_views[u.cid],f=s.get_by_name(t.region),l=f.get("wrappers"),c=Upfront.Util.get_unique_id("wrapper");wrap_model=new Upfront.Models.Wrapper({name:"",properties:[{name:"wrapper_id",value:c},{name:"class",value:i.grid.class+(t.grid.left+t.col-1)}]}),wrap_view=new Upfront.Views.Wrapper({model:wrap_model}),l.add(wrap_model),wrap_model.add_class("clr"),wrap_view.render(),t.$el.closest(".upfront-wrapper").after(wrap_view.$el),wrap_view.$el.append(a.$el),u.set_property("wrapper_id",c,!0),u.replace_class(i.grid.left_margin_class+(t.grid.left-1)),Upfront.data.wrapper_views[wrap_model.cid]=wrap_view,i.init_margin(a.$el.find(".upfront-editable_entity:first").get(0)),o.push(t.region)}})}),_.each(_.uniq(o),function(e){var t=s.get_by_name(e);i.update_wrappers(t)}),_.each(n,function(e){e.outer_grid.left==1&&!e.$el.hasClass("clr")&&e.$el.addClass("clr")})},init:function(){var t=Upfront.Application.LayoutEditor,n=Upfront.Behaviors.GridEditor,r=e(Upfront.Settings.LayoutEditor.Selectors.main),i=r.offset(),s=r.find(".upfront-layout"),o=s.find(".upfront-grid-layout").eq(0);n.baseline=Upfront.Settings.LayoutEditor.Grid.baseline,n.grid=Upfront.Settings.LayoutEditor.Grid,n.col_size=o.outerWidth()/n.grid.size,n.max_row=Math.floor(e(window).height()*.5/n.baseline),n.main={$el:r,top:i.top,bottom:i.top+r.outerHeight(),left:i.left,right:i.left+r.outerWidth()};var u=15;e(document).on("scroll",function(e){if(n.resizing===!1||n.resizing==window.scrollY)return;window.scrollY>n.resizing?n.resizing+=u:n.resizing-=u,window.scrollTo(window.scrollX,n.resizing)})},start:function(e,t,n){this.time_start("fn start");var r=Upfront.Application.LayoutEditor,i=Upfront.Behaviors.GridEditor,s=i.main.$el.offset(),o=i.main.$el.find(".upfront-layout"),u=o.find(".upfront-grid-layout").eq(0),a=u.offset(),f=e.$el.find(".upfront-editable_entity").eq(0).is(".upfront-object"),l=n||e.$el.parents(".upfront-editable_entities_container").eq(0),c=l.offset();i.col_size=u.outerWidth()/i.grid.size,i.el_selector=f?".upfront-object":".upfront-module",i.main.top=s.top,i.main.bottom=s.top+i.main.$el.outerHeight(),i.main.left=s.left,i.main.right=s.left+i.main.$el.outerWidth(),i.grid_layout={top:a.top,bottom:a.top+u.outerHeight(),left:a.left,right:a.left+u.outerWidth()};var h=l.outerWidth(),p=l.outerHeight(),d=Math.round(h/i.col_size),v=Math.round(p/i.baseline),m=i.get_grid(c.left,c.top);i.containment={$el:l,top:c.top,bottom:c.top+p,left:c.left,right:c.left+h,col:d,grid:{top:m.y,bottom:m.y+v-1,left:m.x,right:m.x+d-1}},i.update_position_data(),this.time_end("fn start")},update_position_data:function(){this.time_start("fn update_position_data");var e=Upfront.Application.LayoutEditor,t=Upfront.Behaviors.GridEditor,n=t.main.$el.find(".upfront-layout"),r=t.el_selector==".upfront-object",i=r?t.containment.$el.find(".upfront-object"):n.find(".upfront-module"),s=n.find(".upfront-wrapper"),o=n.find(".upfront-region").not(".upfront-region-locked");t.els=_.map(i,t.get_position),i.each(function(){t.init_margin(this)}),t.wraps=_.map(s,t.get_position),t.regions=_.map(o,t.get_position),this.time_end("fn update_position_data")},create_drop_point:function(t,n){console.log("Drop point"),this.time_start("fn create_drop_point");var r=Upfront.Application.LayoutEditor,i=Upfront.Behaviors.GridEditor,s=t.$el.data("margin"),o=t.col,u=t.$el.hasClass("upfront-image_module")?1:o>i.min_col?i.min_col:o,a=t.row>i.max_row?i.max_row:t.row;i.drops=[],_.each(i.regions,function(r){var s=r.$el.find(".upfront-editable_entities_container:first"),o=r.$el.data("name"),f=s.find("> .upfront-wrapper"),l=r.$el.hasClass("upfront-region-expand-lock"),c=r.grid.top,h=function(e,n){return!l||l&&n-e+1>=t.row};f.each(function(s){var o=e(this),a=i.get_wrap(o),l=a.grid.left==r.grid.left,p=n&&a._id==n._id,d=o.find(".upfront-module").size()==1,v=p&&d,m=f[s-1]?f.eq(s-1):!1,g=m?i.get_wrap(m):!1,y=g&&g.grid.left==r.grid.left,b=g&&n&&g._id==n._id,w=b&&m.find(".upfront-module").size()==1,E=f[s+1]?f.eq(s+1):!1,S=E?i.get_wrap(E):!1,x=S&&S.grid.left==r.grid.left,T=S&&n&&S._id==n._id,N=T&&E.find(".upfront-module").size()==1,C=o.nextAll(".upfront-wrapper.clr:first"),k=C.size()>0?i.get_wrap(C):!1,L=i.get_wrap_el_min(a),A=S?i.get_wrap_el_min(S,!1,!0):!1,O=S?i.get_wrap_el_min(S):!1,M=k?i.get_wrap_el_min(k,!1,!0):!1;if(a.col>=u&&(S&&!x&&!v&&(E.find(".upfront-module").size()>1||!T)||g&&!l&&!v&&(m.find(".upfront-module").size()>1||!b)||S&&g&&!x&&!l)){var _=a.grid.top;$els=o.find(".upfront-module"),$els.each(function(n){if(e(this).get(0)==t.$el.get(0))return;var s=e(this),o=i.get_el(s),u=o.outer_grid.top==a.grid.top?a.grid.top:_,f=o.grid_center.y,l=$els[n-1]?$els.eq(n-1):!1,c=l?i.get_el(l):!1,h=c&&c._id==t._id;i.drops.push({_id:i._new_id(),top:u,bottom:f,left:a.grid.left,right:a.grid.right,priority:{top:h?c.outer_grid.top:o.outer_grid.top,bottom:o.grid.top-1,left:a.grid.left,right:a.grid.right,index:5},priority_index:5,type:"inside",insert:["before",s],region:r,is_me:h,is_clear:!1,is_use:!1,is_switch:!1}),_=f+1});if(x)var D=S.grid.top-1;else if(k)var D=M.grid.top-1;else var D=r.grid.bottom;var P=$els.last(),H=P.size()>0?i.get_el(P):!1,B=H&&H._id==t._id;i.drops.push({_id:i._new_id(),top:_,bottom:D,left:a.grid.left,right:a.grid.right,priority:{top:B?H.outer_grid.top:a.grid.bottom,bottom:D,left:a.grid.left,right:a.grid.right,index:5},priority_index:5,type:"inside",insert:["append",a.$el],region:r,is_me:B,is_clear:!1,is_use:!1,is_switch:!1})}if(l&&(!p||!!S&&!x)){var j=a.grid.top==r.grid.top?r.grid.top:c,F=i.get_wrap_el_min(a,!1,!0),I=F.grid_center.y,q=y&&b,R=q?g.grid.top:a.grid.top;h(R,F.grid.top-1)&&(i.drops.push({_id:i._new_id(),top:j,bottom:I,left:r.grid.left,right:r.grid.right,priority:{top:R,bottom:F.grid.top-1,left:r.grid.left,right:r.grid.right,index:10},priority_index:10,type:"full",insert:["before",a.$el],region:r,is_me:q,is_clear:!0,is_use:!1,is_switch:!1}),c=I+1)}if((!S||x)&&(!p&&r.grid.right-a.grid.right>=u||v&&!l||w&&!l&&d)){var U=w&&!l&&d,I=A?A.grid.top-1:r.grid.bottom;h(a.grid.top,I)&&i.drops.push({_id:i._new_id(),top:a.grid.top,bottom:I,left:p?a.grid.left:U?L.grid.left:a.grid.right+1,right:r.grid.right,priority:null,priority_index:8,type:"side-after",insert:["after",a.$el],region:r,is_me:p,is_clear:!1,is_use:!1,is_switch:U})}if(L.grid.left-a.grid.left>=u&&(!b||l)&&!p||v&&S&&!x||N&&!x&&d){var U=N&&!x&&d,z=L.grid.left-1,I=M?M.grid.top-1:r.grid.bottom;h(a.grid.top,I)&&i.drops.push({_id:i._new_id(),top:a.grid.top,bottom:I,left:a.grid.left,right:p?O.grid.left-1:U?a.grid.right:z,priority:{top:a.grid.top,bottom:I,left:a.grid.left,right:p?O.grid.left-1:L.grid.left-1,index:3},priority_index:7,type:"side-before",insert:["before",a.$el],region:r,is_me:p,is_clear:l,is_use:!1,is_switch:U})}});if(f.size()>0){var p=i.get_wrap(f.last()),d=p&&p.grid.left==r.grid.left,v=n&&d&&p._id==n._id,m=r.grid.bottom-c>a?r.grid.bottom:c+a,g=_.max(i.wraps,function(e){return e.region!=o?0:e.grid.bottom}),y=v?p.grid.top:g.grid.bottom;h(y,m)&&i.drops.push({_id:i._new_id(),top:c,bottom:m,left:r.grid.left,right:r.grid.right,priority:{top:y,bottom:m,left:r.grid.left,right:r.grid.right},priority_index:10,type:"full",insert:["append",s],region:r,is_me:v,is_clear:!0,is_use:!1,is_switch:!1})}else{var m=r.grid.bottom-r.grid.top>a?r.grid.bottom:r.grid.top+a;h(r.grid.top,m)&&i.drops.push({_id:i._new_id(),top:r.grid.top,bottom:m,left:r.grid.left,right:r.grid.right,priority:null,priority_index:10,type:"full",insert:["append",s],region:r,is_me:o=="shadow"&&t.region==o,is_clear:!0,is_use:!1,is_switch:!1})}}),this.time_end("fn create_drop_point")},update_wrappers:function(t){this.time_start("fn update_wrappers");var n=Upfront.Application.LayoutEditor,r=Upfront.Behaviors.GridEditor,i=e(Upfront.Settings.LayoutEditor.Selectors.main),s=i.find(".upfront-layout"),o=t.get("wrappers");s.find(".upfront-wrapper").each(function(){var t=e(this),n=t.attr("id"),i=o.get_by_wrapper_id(n),s=t.data("clear");if(t.children().size()==0){i&&o.remove(i);return}if(t.hasClass("upfront-wrapper-preview"))return;if(!i)return;var u=_.map(t.children(),function(t){var n=e(t).find(">.upfront-editable_entity:first");return{$el:n,col:r.get_class_num(n,r.grid.class),margin:n.data("margin")}}),a=_.max(u,function(e){return e.col+e.margin.current.left+e.margin.current.right}),f=a.col+a.margin.current.left+a.margin.current.right;r.update_class(t,r.grid.class,f),i.replace_class(r.grid.class+f),s&&s=="clear"||!s&&t.hasClass("clr")?i.add_class("clr"):i.remove_class("clr"),t.stop().css({position:"",left:"",right:""})}),o.each(function(t){e("#"+t.get_wrapper_id()).size()==0&&o.remove(t)}),this.time_end("fn update_wrappers")},create_resizable:function(t,n){var r=this,i=Upfront.Behaviors.GridEditor,s=t.$el.find(".upfront-editable_entity:first"),o=e(Upfront.Settings.LayoutEditor.Selectors.main),u=o.find(".upfront-layout"),a,f,l;if(n.get_property_value_by_name("disable_resize")===1)return!1;if(s.hasClass("ui-resizable"))return s.resizable("option","disabled",!1),!1;s.append('<span class="upfront-icon-control upfront-icon-control-resize-nw upfront-resize-handle-nw ui-resizable-handle ui-resizable-nw"></span>'),s.append('<span class="upfront-icon-control upfront-icon-control-resize-se upfront-resize-handle-se ui-resizable-handle ui-resizable-se"></span>'),s.resizable({containment:"document",autoHide:!0,delay:50,handles:{nw:".upfront-resize-handle-nw",se:".upfront-resize-handle-se"},start:function(r,o){i.start(t,n),i.resizing=window.scrollY;var u=i.get_class_num(s,i.grid.class),c=i.grid.class+u,h=i.get_el(s),p=s.data("margin"),d=e(this).data("ui-resizable");l=d.axis?d.axis:"se",c+=" "+i.grid.top_margin_class+p.original.top,c+=" "+i.grid.bottom_margin_class+p.original.bottom,c+=" "+i.grid.left_margin_class+p.original.left,c+=" "+i.grid.right_margin_class+p.original.right,f=e('<div class="upfront-resize-placeholder"></div>'),f.addClass(c).css("height",o.originalSize.height).insertBefore(s),a=e('<div class="upfront-resize" style="height:'+h.height+'px;"></div>'),a.css({height:h.height,width:h.width,minWidth:h.width,maxWidth:h.width,position:"absolute"}),l=="nw"?a.css({bottom:e("body").height()-h.position.bottom+i.baseline,right:e("body").width()-h.position.right}):a.css({top:h.position.top,left:h.position.left}),e("body").append(a),_.each(i.els,function(e,t){i.els[t]=i.get_position(e.$el)}),_.each(i.wraps,function(e,t){i.wraps[t]=i.get_position(e.$el)}),i.normalize(i.els,i.wraps),i.update_position_data();var v=s.position(),m={left:v.left+p.original.left*i.col_size,top:v.top+p.original.top*i.baseline};s.css({marginLeft:0,marginTop:0,left:m.left,top:m.top,minHeight:""}),d.originalPosition.left=m.left,d.originalPosition.top=m.top,d._updateCache({left:m.left,top:m.top}),Upfront.Events.trigger("entity:resize_start",t,t.model)},resize:function(t,n){var r=s.closest(".upfront-wrapper"),o=s.closest(".upfront-region"),u=i.get_class_num(s,i.grid.class),c=i.get_el(s),h=i.get_wrap(r),p=i.get_region(o),d=o.hasClass("upfront-region-expand-lock"),v=h?i.get_affected_wrapper_els(h,i.wraps,[],!0):i.get_affected_els(c,i.els,[],!0),m=i.get_move_limit(v,i.containment),g=u+(l=="nw"?c.grid.left-m[0]:m[1]-c.grid.right),y=v.bottom.length?_.min(v.bottom,function(e){return e.grid.top}):!1,b=y?y.grid.top-c.grid.top:p.grid.bottom-c.grid.top,w=Math.ceil(n.size.width/i.col_size),E=w>g?Math.round(g*i.col_size):n.size.width,S=(n.size.height>15?n.size.height:0)||n.originalSize.height,x=Math.ceil(S/i.baseline),T=w>g?g:w,N=d&&x>b&&b>0?b:x;Math.abs(e(window).height()-t.clientY)<50&&(S+=i.baseline*10,e(window).scrollTop(e(window).scrollTop()+i.baseline*10)),s.css({height:S,width:E,minWidth:E,maxWidth:E}),s.data("resize-col",T),s.data("resize-row",N),a.css({height:N*i.baseline,width:T*i.col_size,minWidth:T*i.col_size,maxWidth:T*i.col_size}),!d&&l!="nw"&&f.css("height",N*i.baseline)},stop:function(e,o){Upfront.Events.trigger("entity:pre_resize_stop",t,t.model,o);var c=s.closest(".upfront-wrapper"),h=s.closest(".upfront-region"),p=i.get_el(s),d=s.data("margin"),v=i.get_wrap(c),m=h.hasClass("upfront-region-expand-lock"),g=v?i.get_affected_wrapper_els(v,i.wraps,[],!0):i.get_affected_els(p,i.els,[],!0),y=i.get_move_limit(g,i.containment),b=Math.ceil(o.originalSize.width/i.col_size),w=Math.ceil(o.originalSize.height/i.baseline),E=s.data("resize-col"),S=s.data("resize-row"),x=r.layout.get("regions"),T=x.get_by_name(h.data("name"));i.resizing=!1,f.remove(),a.remove(),i.update_class(s,i.grid.class,E),l=="nw"?(d.current.left=d.original.left-(E-b),d.current.top=d.original.top-(S-w),s.data("margin",d),i.update_margin_classes(s)):l=="se"&&v&&(i.adjust_affected_right(v,g.right,[p],p.grid.left+E-1,!0),m&&i.adjust_affected_bottom(v,g.bottom,[p],p.grid.top+S-1,!0)),i.update_wrappers(T),s.css({width:"",minWidth:"",maxWidth:"",height:"",position:"",top:"",left:"",marginLeft:"",marginTop:""}),n.set_property("row",S);var N=n.get("objects");N&&N.length==1&&N.each(function(e){e.set_property("row",S-2)}),l=="nw"?n.replace_class([i.grid.class+E,i.grid.left_margin_class+d.current.left,i.grid.right_margin_class+d.current.right,i.grid.top_margin_class+d.current.top,i.grid.bottom_margin_class+d.current.bottom].join(" ")):(n.replace_class(i.grid.class+E),i.update_model_margin_classes(u.find(".upfront-module").not(s))),t.trigger("entity:resize",{row:S,col:E},t,t.model),Upfront.Events.trigger("entity:resize_stop",t,t.model,o),Upfront.Events.trigger("entity:resized",t,t.model)}})},toggle_resizables:function(t){e(".upfront-editable_entity.ui-resizable").resizable("option","disabled",!t)},resize:function(t,n,r,i,s,o){var u=Upfront.Application.LayoutEditor,a=Upfront.Behaviors.GridEditor,s=/all|nw|se/.test(s)?s:"all",f=e(Upfront.Settings.LayoutEditor.Selectors.main),l=f.find(".upfront-layout");a.start(t,n);var c=t.$el.find(".upfront-editable_entity:first"),h=c.find(".upfront-editable_entity"),p=c.closest(".upfront-wrapper"),d=c.closest(".upfront-region"),v=c.data("margin"),m=a.get_el(c),g=a.get_wrap(p),y=a.get_region(d),b=d.hasClass("upfront-region-expand-lock"),w=g?a.get_affected_wrapper_els(g,a.wraps,[],!0):a.get_affected_els(m,a.els,[],!0),E=a.get_max_size(m,a.els,y,s),S=u.layout.get("regions"),x,r=r?r>E.col?E.col:r:m.col,i=i?E.row&&i>E.row?E.row:i:m.row;if(r<1||i<1)return!1;if(!o){c.css("min-height",""),h.css("min-height","");var T=Math.ceil(c.outerHeight()/a.baseline);i=i>T?i:T,c.css("min-height",i*a.baseline),h.css("min-height",(i-2)*a.baseline)}S.each(function(e){e.get("modules")==n.collection&&(x=e)}),a.normalize(a.els,a.wraps),a.update_position_data();if(s=="nw")v.current.left=v.original.left-(r-m.col),v.current.top=v.original.top-(i-m.row),c.data("margin",v),a.update_margin_classes(c);else if(s=="se"&&g)a.adjust_affected_right(g,w.right,[m],m.grid.left+r-1,!0),b&&a.adjust_affected_bottom(g,w.bottom,[m],m.grid.top+i-1,!0);else if(s=="all"){var N=a.get_max_size(m,a.els,y,"se"),C=r>N.col?N.col:r,k=N.row?i>N.row?N.row:i:!1;g&&(a.adjust_affected_right(g,w.right,[m],m.grid.left+C-1,!0),b&&k&&a.adjust_affected_bottom(g,w.bottom,[m],m.grid.top+k-1,!0)),v.current.left=v.original.left-(r-C),k&&(v.current.top=v.original.top-(i-k)),c.data("margin",v),a.update_margin_classes(c)}a.update_class(c,a.grid.class,r),a.update_wrappers(x),n.set_property("row",i);var L=n.get("objects");return L&&L.length==1&&L.each(function(e){e.set_property("row",i-2)}),s!="se"?n.replace_class([a.grid.class+r,a.grid.left_margin_class+v.current.left,a.grid.right_margin_class+v.current.right,a.grid.top_margin_class+v.current.top,a.grid.bottom_margin_class+v.current.bottom].join(" ")):(n.replace_class(a.grid.class+r),a.update_model_margin_classes(l.find(".upfront-module").not(c))),t.trigger("entity:resize",{row:i,col:r},t,t.model),Upfront.Events.trigger("entity:resized",t,t.model),!0},create_draggable:function(t,n){function h(n){i.time_start("fn select_drop");if(n.is_use)return;var r=typeof i.drop=="object"&&!n.is_me?!0:!1;_.each(i.drops,function(e){e.is_use=e._id==n._id}),i.drop=n,i.show_debug_element&&(e(".upfront-drop-view-current").removeClass("upfront-drop-view-current"),e("#drop-view-"+n._id).addClass("upfront-drop-view-current")),e(".upfront-drop").removeClass("upfront-drop-use").animate({height:0},300,function(){e(this).remove()}),_.each(i.drops,function(e){e.is_switch&&e.insert[1].animate({left:0},300)});var o=e('<div class="upfront-drop upfront-drop-use"></div>'),u=i.get_el(s),a=function(){Upfront.Events.trigger("entity:drag:drop_change",t,t.model)};switch(n.insert[0]){case"before":o.insertBefore(n.type=="inside"?n.insert[1].parent():n.insert[1]);break;case"after":o.insertAfter(n.type=="inside"?n.insert[1].parent():n.insert[1]);break;case"append":n.insert[1].append(o)}(n.type=="full"||n.type=="inside"||n.type=="side-after"&&!n.is_switch)&&!n.is_me&&n.priority&&n.priority.bottom-n.priority.top+1<u.row?o.css("width",(n.right-n.left+1)*i.col_size).css("max-height",i.max_row*i.baseline).animate({height:u.height},300,"swing",a):n.type=="side-before"&&n.is_switch?n.insert[1].animate({left:u.width},300,"swing",a):n.type=="side-after"&&n.is_switch?n.insert[1].animate({left:u.width*-1},300,"swing",a):r&&a(),i.time_end("fn select_drop")}var r=this,i=Upfront.Behaviors.GridEditor,s=t.$el.find(".upfront-editable_entity:first"),o=e(Upfront.Settings.LayoutEditor.Selectors.main),u=o.find(".upfront-layout"),a,f,l,c=!1;if(n.get_property_value_by_name("disable_drag")===1)return!1;if(s.hasClass("ui-draggable"))return s.draggable("option","disabled",!1),!1;s.draggable({revert:!0,revertDuration:0,zIndex:100,helper:"clone",delay:300,appendTo:o,start:function(r,a){i.time_start("drag start"),o.addClass("upfront-dragging"),i.start(t,n),i.normalize(i.els,i.wraps),i.update_position_data();var f=e(".ui-draggable-dragging"),l=s.closest(".upfront-wrapper"),c=s.closest(".upfront-region"),p=i.get_el(s),d=i.get_wrap(l),v=s.offset();c.css("min-height",c.css("height")),s.css("visibility","hidden"),f.css("max-width",p.width),f.css("height",p.height),f.css("max-height",i.max_row*i.baseline),f.css("margin-left",s.css("margin-left")),i.create_drop_point(p,d),l.css("min-height","1px"),e(".upfront-drop-me").css("height",(p.outer_grid.bottom-p.outer_grid.top)*i.baseline),u.append('<div id="upfront-drop-preview" style="top:'+v.top+"px; left: "+v.left+'px;"></div>'),i.show_debug_element&&(_.each(i.els,function(e){e.$el.find(".upfront-debug-info").size()||e.$el.find(".upfront-editable_entity:first").append('<div class="upfront-debug-info"></div>'),e.$el.find(".upfront-debug-info").text("grid: ("+e.grid.left+","+e.grid.right+"),("+e.grid.top+","+e.grid.bottom+") | outer: ("+e.outer_grid.left+","+e.outer_grid.right+"),("+e.outer_grid.top+","+e.outer_grid.bottom+") | center: "+e.grid_center.x+","+e.grid_center.y)}),_.each(i.drops,function(t){var n=e('<div class="upfront-drop-view"><div class="upfront-drop-priority-view"></div><span class="upfront-drop-view-pos"></span></div>');n.addClass("upfront-drop-view-"+t.type),t.is_me&&n.addClass("upfront-drop-view-me"),n.attr("id","drop-view-"+t._id),n.css({top:(t.top-1)*i.baseline,left:(t.left-1)*i.col_size+(i.grid_layout.left-i.main.left),width:(t.right-t.left+1)*i.col_size,height:(t.bottom-t.top+1)*i.baseline}),t.priority&&n.find(".upfront-drop-priority-view").css({top:(t.priority.top-t.top)*i.baseline,left:(t.priority.left-t.left)*i.col_size,width:(t.priority.right-t.priority.left+1)*i.col_size,height:(t.priority.bottom-t.priority.top+1)*i.baseline}),n.find(".upfront-drop-view-pos").text("("+t.left+","+t.right+")"+"("+t.top+","+t.bottom+")"),u.append(n)}),u.append('<div id="upfront-compare-area"></div>'),f.find(".upfront-debug-info").size()||f.append('<div class="upfront-debug-info"></div>')),h(_.find(i.drops,function(e){return e.is_me})),c.addClass("upfront-region-drag-active"),i.time_end("drag start"),i.time_start("drag start - trigger"),Upfront.Events.trigger("entity:drag_start",t,t.model),i.time_end("drag start")},drag:function(t,n){function F(){var t=e(".upfront-region-container:not(.upfront-region-container-shadow):last"),n=_.map(i.regions,function(e){var n,r,i,s,o,u=e.$el.closest(".upfront-region-container").get(0)==t.get(0)?999999:e.grid.bottom,o=q({top:e.grid.top,bottom:u,left:e.grid.left,right:e.grid.right});return e.$el.hasClass("upfront-region-drag-active")&&(o*=1.2),{area:o,region:e}}),r=_.max(n,function(e){return e.area});v=r.area>0?r.region:i.get_region(s.closest(".upfront-region")),i.show_debug_element&&_.each(n,function(e){e.region.$el.find(">.upfront-debug-info").text(e.area)}),v.$el.hasClass("upfront-region-drag-active")||(e(".upfront-region-drag-active").removeClass("upfront-region-drag-active"),v.$el.addClass("upfront-region-drag-active"))}function I(){var e=_.map(i.drops,function(e){if(e.region._id!=v._id)return!1;var t=q(e);return{area:t,drop:e}}).filter(function(e){return e!==!1?!0:!1}),t=_.max(e,function(e){return e.area});if(t.area>0)var n=_.filter(e,function(e){return e.area==t.area}),r=_.sortBy(n,function(e,t,n){var r=e.drop.priority?q(e.drop.priority):0;return r*2>e.area?e.drop.priority.index:e.drop.priority_index}),s=_.first(r).drop;else var s=_.find(i.drops,function(e){return e.is_me});h(s),R()}function q(e){var t,n,r,s,o;return H>=e.left&&H<=e.right?r=H:H<e.left&&(r=e.left),B>=e.left&&B<=e.right?s=B:B>e.right&&(s=e.right),P>=e.top&&P<=e.bottom?t=P:P<e.top&&(t=e.top),j>=e.top&&j<=e.bottom?n=j:j>e.bottom&&(n=e.bottom),t&&n&&r&&s&&M.x>0&&M.x<=i.grid.size?o=(s-r+1)*(n-t+1):o=0,o}function R(){var t=i.drop.priority?i.drop.priority.top-i.drop.top:0,n=i.drop.region.$el.hasClass("upfront-region-expand-lock"),r=i.drop.priority?i.drop.priority.bottom-i.drop.priority.top+1:i.drop.bottom-i.drop.top+1;a=k>i.drop.top+t?k-i.drop.top-t:0,f=C>i.drop.left?C-i.drop.left:0,l=i.drop.priority&&!i.drop.is_switch?i.drop.priority.right-i.drop.priority.left+1:i.drop.right-i.drop.left+1,c=!1,l<=D&&i.drop.priority&&!i.drop.is_switch?f=i.drop.priority.left+f+l-1<i.drop.priority.right?f:i.drop.priority.right-l-i.drop.priority.left+1:(l=l<=D?l:D,f=i.drop.left+f+l-1<i.drop.right?f:i.drop.right-l-i.drop.left+1),n&&a+u.row>r&&(a=r-u.row),r>=a+u.row&&(c=!0),e("#upfront-drop-preview").css({top:(i.drop.top+t+a-1)*i.baseline,left:(i.drop.left+f-1)*i.col_size+(i.grid_layout.left-i.main.left),width:l*i.col_size,height:m}),i.show_debug_element&&e("#upfront-compare-area").css({top:(P-1)*i.baseline,left:(H-1)*i.col_size+(i.grid_layout.left-i.main.left),width:(B-H+1)*i.col_size,height:(j-P+1)*i.baseline}).text("("+H+","+B+") "+"("+P+","+j+")")}var r=e(".ui-draggable-dragging"),o=s.closest(".upfront-wrapper"),u=i.get_el(s),p=i.get_wrap(o),d=!s.closest(".upfront-region").hasClass("upfront-region-drag-active"),v,m=r.outerHeight(),g=r.outerWidth(),y=r.offset(),b=y.left,w=y.top,E=w+m,S=b+g,x=b+g/2,T=w+m/2,N=i.get_grid(b,w),C=N.x,k=N.y,L=i.get_grid(S,E),A=L.x-1,O=L.y-1,M=i.get_grid(t.pageX,t.pageY),D=i.get_class_num(s,i.grid.class),P=M.y-i.compare_row/2,P=P<k?k:P,H=M.x-i.compare_col/2,H=H<C?C:H,B=H+i.compare_col-1,B=B>A?A:B,j=P+i.compare_row-1,j=j>O?O:j,j=j>P+i.max_row?P+i.max_row:j;clearTimeout(i._t),i._t=setTimeout(function(){F(),D=D>v.col?v.col:D,I()},i.timeout),R(),i.show_debug_element&&r.find(".upfront-debug-info").text("grid: "+M.x+","+M.y+" | current: ("+C+","+k+"),("+A+","+O+") | margin size: "+a+"/"+f)},stop:function(h,p){function T(){i.time_start("fn update_margin");var e=s.data("margin"),t=m?i.get_affected_wrapper_els(m,i.wraps,[],!0):i.get_affected_els(v,i.els,[],!0),n=i.get_move_limit(t,i.containment),r=(i.drop.priority?i.drop.priority.top:i.drop.top)+a+v.row-1,o=!1;if(i.drop.is_me)e.current.left!=f&&(e.current.left=f,o=!0),e.current.top=a,s.data("margin",e),o&&m&&i.adjust_affected_right(m,t.right,[v],n[0]+l+f-1),c&&m&&i.adjust_affected_bottom(m,t.bottom,[v],r);else{_.each(i.wraps,function(e){e.$el.data("clear",e.$el.hasClass("clr")?"clear":"none")}),m&&!i.drop.is_switch&&i.adjust_affected_right(m,t.right,[v],m.grid.left-1),e.current.left=f,e.current.top=a,e.current.right=0,e.current.bottom=0;if(i.drop.type=="side-before"){var u=i.drop.insert[1];if(u.size()>0){var h=i.get_wrap(u),p=_.filter(i.get_wrap_els(h),function(e){return v.$el.get(0)!=e.$el.get(0)&&e.outer_grid.left==h.grid.left}),d=i.get_wrap_el_min(h),g=i.get_affected_wrapper_els(h,i.wraps,[],!0);if(!u.hasClass("clr")||i.drop.is_clear)i.adjust_els_right(p,h.grid.left+l+f-1),u.data("clear","none");i.drop.is_switch&&(i.adjust_els_right(p,h.grid.left+f-1),u.css("left","")),c&&i.adjust_affected_bottom(h,g.bottom,[v],r>h.outer_grid.bottom?r:h.outer_grid.bottom)}}else if(i.drop.type=="side-after"){var b=i.drop.insert[1];if(b.size()>0){var w=i.get_wrap(b),p=_.filter(i.get_wrap_els(w),function(e){return v.$el.get(0)!=e.$el.get(0)&&e.outer_grid.left==w.grid.left}),E=i.get_affected_wrapper_els(w,i.wraps,[],!0);i.drop.is_switch&&(i.adjust_els_right(p,w.grid.left-(v.grid.left-v.outer_grid.left)-1),b.css("left","")),c&&i.adjust_affected_bottom(w,E.bottom,[v],r>w.outer_grid.bottom?r:w.outer_grid.bottom)}}else if(i.drop.type=="inside"){var S=y.closest(".upfront-wrapper"),x=i.get_wrap(S),T=x?i.get_affected_wrapper_els(x,i.wraps,m&&i.get_wrap_els(m).length==1?[m,v]:[v],!0):!1;x&&i.adjust_affected_right(x,T.right,[v],i.drop.left+l+f-1);if(c&&i.drop.insert[0]=="before"){var N=i.drop.insert[1],C=i.get_el(N);i.adjust_els_bottom([C],r)}}else if(i.drop.type=="full"&&i.drop.insert[0]=="before"){var u=i.drop.insert[1],h=i.get_wrap(u),p=_.filter(i.get_wrap_els(h),function(e){return v.$el.get(0)!=e.$el.get(0)&&e.outer_grid.top==h.grid.top});c&&i.adjust_els_bottom(p,r)}s.data("margin",e)}i.time_end("fn update_margin")}function N(){i.time_start("fn drop_update"),e(".upfront-drop").remove(),e(".upfront-drop-view").remove(),e("#upfront-drop-preview").remove(),e("#upfront-compare-area").remove(),i.update_class(s,i.grid.class,l),(b?i.containment.$el.find(".upfront-object"):u.find(".upfront-module")).each(function(){i.update_margin_classes(e(this))}),i.update_wrappers(region),s.css({position:"",top:"",left:"","z-index":"",visibility:"visible"}),i.update_model_margin_classes((b?i.containment.$el.find(".upfront-object"):u.find(".upfront-module")).not(s)),i.update_model_margin_classes(s,[i.grid.class+l]),S&&n.set_property("wrapper_id",S,!0);if(!move_region)t.resort_bound_collection();else{var r=region.get("modules"),c=[];n.collection.remove(n,{silent:!0}),n.get("shadow")&&(t.trigger("on_layout"),n.unset("shadow",{silent:!0})),s.removeAttr("data-shadow"),e(".upfront-region-drag-active").find(".upfront-module").each(function(){var t=e(this).attr("id"),i=r.get_by_element_id(t);!i&&t==s.attr("id")?c.push(n):i&&c.push(i)}),r.reset(c)}s=t.$el.find(".upfront-editable_entity:first"),s.one("animationend webkitAnimationEnd MSAnimationEnd oAnimationEnd",function(){e(this).removeClass("upfront-dropped"),Upfront.Events.trigger("entity:drag_animate_stop",t,t.model)}).addClass("upfront-dropped"),e(".upfront-region-drag-active .upfront-module").css("max-height",""),e(".upfront-region-drag-active").removeClass("upfront-region-drag-active"),d.css("min-height",""),o.removeClass("upfront-dragging"),Upfront.Events.trigger("entity:drag_stop",t,t.model),move_region&&(t.region=region,t.trigger("region:updated")),t.trigger("entity:drop",{col:l,left:f,top:a},t,t.model),t.trigger("entity:self:drag_stop"),i.time_end("fn drop_update")}i.time_start("drag stop");var d=s.closest(".upfront-wrapper"),v=i.get_el(s),m=i.get_wrap(d),g=i.get_class_num(s,i.grid.class),y=e(".upfront-drop-use"),b=t.$el.find(".upfront-editable_entity:first").is(".upfront-object"),w=!1,E=r.layout.get("regions");region=E.get_by_name(e(".upfront-region-drag-active").data("name")),wrappers=region.get("wrappers"),move_region=v.region!=region.get("name"),region_el=i.get_region(e(".upfront-region-drag-active")),clearTimeout(i._t);if(i.drop.is_me)T(),N();else{w=!0;if(i.drop.type!="inside"){var S=Upfront.Util.get_unique_id("wrapper");wrap_model=new Upfront.Models.Wrapper({name:"",properties:[{name:"wrapper_id",value:S},{name:"class",value:i.grid.class+l}]}),wrap_view=new Upfront.Views.Wrapper({model:wrap_model}),wrappers.add(wrap_model),(i.drop.type=="full"||i.drop.is_clear)&&wrap_model.add_class("clr"),wrap_view.render(),wrap_view.$el.append(t.$el),i.drop.type=="side-before"&&i.drop.is_clear&&y.nextAll(".upfront-wrapper").eq(0).removeClass("clr"),y.before(wrap_view.$el),Upfront.data.wrapper_views[wrap_model.cid]=wrap_view}else{var x=y.closest(".upfront-wrapper"),S=x.attr("id");y.before(t.$el)}d.children(":not(.upfront-drop)").size()==0&&(m&&m.grid.left==region_el.grid.left&&d.nextAll(".upfront-wrapper").eq(0).addClass("clr"),d.remove()),T(),N()}i.drop=null,i.time_end("drag stop")}})},toggle_draggables:function(t){e(".upfront-editable_entity.ui-draggable").draggable("option","disabled",!t)},refresh_draggables:function(){var t=this,n=Upfront.Behaviors.GridEditor,r=e(Upfront.Settings.LayoutEditor.Selectors.main),i=r.find(".upfront-layout");i.find(".ui-draggable").each(function(){var t=e(this).outerHeight()>60?60:e(this).outerHeight()/2;e(this).draggable("option","cursorAt",{top:t})})},normalize_module_remove:function(e,t,n,r,i){var s=Upfront.Application.LayoutEditor,o=Upfront.Behaviors.GridEditor,u=n.indexOf(t),a=n.at(u-1),f=n.at(u+1),l,c,h,p,d,v,m;if(!f&&!a)return!1;var g=t.get_property_value_by_name("class"),y=r.get_property_value_by_name("class"),b=o.get_class_num(y,o.grid.class),w=0,E=!1,S=!1,x=!1,T=[],N=[];f&&(l=f.get_property_value_by_name("class"),c=o.get_class_num(l,o.grid.left_margin_class),d=i.get_by_wrapper_id(f.get_wrapper_id()),v=d.get_property_value_by_name("class"),m=o.get_class_num(v,o.grid.class),v.match(/clr/g)||(d.replace_class(o.grid.class+(m+b)+(y.match(/clr/g)?" clr":"")),x=!0,S=!0)),a&&(h=i.get_by_wrapper_id(a.get_wrapper_id()),p=h.get_property_value_by_name("class"),p.match(/clr/g)&&!S&&(E=!0));while(n.at(w)){var C=n.at(w),k=C.get_property_value_by_name("class"),L=o.get_class_num(k,o.grid.left_margin_class);if(h&&C.get_wrapper_id()==h.get_wrapper_id()){T.push(C),w++;continue}if(d&&C.get_wrapper_id()==d.get_wrapper_id()){N.push(C),w++;continue}if(w>u){var A=i.get_by_wrapper_id(C.get_wrapper_id()),O=A.get_property_value_by_name("class");O.match(/clr/g)||(S=!1);break}w++}x&&_.each(N,function(e,t){var n=e.get_property_value_by_name("class"),r=o.get_class_num(n,o.grid.left_margin_class);e.replace_class(o.grid.left_margin_class+(r+b))});if(E||S){var M=!1;_.each(E?T:N,function(e,t){var n=e.get_property_value_by_name("class"),r=o.get_class_num(n,o.grid.left_margin_class),s=o.get_class_num(n,o.grid.class),u=Upfront.data.module_views[e.cid],a=i.get_by_wrapper_id(e.get_wrapper_id()),f=Upfront.data.wrapper_views[a.cid],l=M?Upfront.data.wrapper_views[M.cid]:f;if(t>0){var c=Upfront.Util.get_unique_id("wrapper");wrap_model=new Upfront.Models.Wrapper({name:"",properties:[{name:"wrapper_id",value:c},{name:"class",value:o.grid.class+(r+s)+" clr"}]}),wrap_view=new Upfront.Views.Wrapper({model:wrap_model}),i.add(wrap_model),wrap_view.render(),wrap_view.$el.append(u.$el),l.$el.after(wrap_view.$el),Upfront.data.wrapper_views[wrap_model.cid]=wrap_view,e.set_property("wrapper_id",c,!0),M=wrap_model}})}},create_region_resizable:function(t,n){if(!n.get("container")||n.get("container")==n.get("name"))return;var r=this,i=Upfront.Behaviors.GridEditor,s=t.$el,o=e(Upfront.Settings.LayoutEditor.Selectors.main),u=o.find(".upfront-layout"),a=n.collection,f=a.indexOf(n),l=a.size()-1,c=f<l-1?a.at(f+1):!1,h=!1,p=n.get("container");c!==!1&&(c.get("container")==p||c.get("name")==p)&&(h=!0),s.resizable({containment:"document",handles:h?"e":"w",helper:"region-resizable-helper",disabled:!0,zIndex:9999999,start:function(n,r){var o=i.get_class_num(s,i.grid.class);i.resizing=window.scrollY,i.col_size=e(".upfront-grid-layout:first").outerWidth()/i.grid.size,e(this).resizable("option","minWidth",i.col_size*3),e(this).resizable("option","maxWidth",i.col_size*10),Upfront.Events.trigger("entity:region:resize_start",t,t.model)},resize:function(e,t){var n=t.helper,r=i.get_class_num(s,i.grid.class),o=s.prev(".upfront-region").size()>0?i.get_class_num(s.prev(".upfront-region"),i.grid.class):0,u=s.next(".upfront-region").size()>0?i.get_class_num(s.next(".upfront-region"),i.grid.class):0,a=r+(u>o?u:o),f=Math.abs(Math.ceil(t.size.width/i.col_size)),l=f>a?Math.round(a*i.col_size):t.size.width,c=f>a?a:f;n.css({height:t.originalSize.height,width:l,minWidth:l,maxWidth:l}),s.data("resize-col",c)},stop:function(e,r){var o=s.data("resize-col");i.resizing=!1,s.css({width:"",minWidth:"",maxWidth:"",height:"",position:"",top:"",left:""}),n.set_property("col",o),Upfront.Events.trigger("entity:region:resize_stop",t,t.model)}})},create_region_container_resizable:function(t,n){var r=this,i=Upfront.Behaviors.GridEditor,s=t.$el,o=e(Upfront.Settings.LayoutEditor.Selectors.main),u=o.find(".upfront-layout");if(s.hasClass("ui-resizable"))return!1;s.append('<div class="upfront-icon-control-region upfront-icon-control-region-resize upfront-region-resize-handle ui-resizable-handle ui-resizable-s"></div>'),s.resizable({containment:"document",handles:{s:".upfront-region-resize-handle"},helper:"region-resizable-helper",disabled:!0,zIndex:9999999,start:function(e,n){Upfront.Events.trigger("entity:region_container:resize_start",t,t.model),Upfront.Events.trigger("command:region:edit_toggle",!1),i.resizing=window.scrollY},resize:function(t,n){var r=n.helper,o=(n.size.height>15?n.size.height:0)||n.originalSize.height,u=Math.ceil(o/i.baseline);Math.abs(e(window).height()-t.clientY)<50&&(o+=i.baseline*10,e(window).scrollTop(e(window).scrollTop()+i.baseline*10)),r.css({width:"100%",height:o}),s.data("resize-row",u)},stop:function(e,r){var o=s.data("resize-row");s.css({width:"",minHeight:"",height:"",maxHeight:"",position:"",top:"",left:""}),n.set_property("row",o),Upfront.Events.trigger("entity:region_container:resize_stop",t,t.model),Upfront.Events.trigger("command:region:edit_toggle",!0),i.resizing=!1}})},toggle_region_resizable:function(t){e(".upfront-region, .upfront-region-container").each(function(){if(!e(this).hasClass("ui-resizable"))return;e(this).resizable("option","disabled",!t)})},time_start:function(e){this.show_debug_element&&console.time(e)},time_end:function(e){this.show_debug_element&&console.timeEnd(e)},set_timeout:function(e){this.timeout=e},set_compare_size:function(e,t){this.compare_col=e,this.compare_row=t},toggle_debug:function(){this.show_debug_element=!this.show_debug_element,this.show_debug_element?this.render_debug():this.delete_debug()},render_debug:function(){var t=this,n=e('<div id="behavior-debug" class="upfront-inline-modal"></div>'),r=e('<div class="upfront-inline-modal-wrap"></div>'),i=new Upfront.Views.Editor.Field.Number({name:"delay",label:"Delay before drag:",label_style:"inline",min:0,max:2e3,step:1,default_value:300,change:function(){e(".upfront-module.ui-draggable").draggable("option","delay",this.get_value())}}),s=new Upfront.Views.Editor.Field.Number({name:"timeout",label:"Delay before changing position:",label_style:"inline",min:0,max:2e3,step:1,default_value:66,change:function(){t.timeout=parseInt(this.get_value())}}),o=new Upfront.Views.Editor.Field.Checkboxes({name:"debug",multiple:!1,default_value:!0,values:[{label:"Show debugging info/outline",value:!0}],change:function(){t.show_debug_element=this.get_value()?!0:!1}}),u=e('<a href="#" class="upfront-close-debug">Close</a>');i.render(),r.append(i.$el),s.render(),r.append(s.$el),o.render(),r.append(o.$el),r.append(u),n.append(r),e("body").append(n),n.css({top:"auto",left:"auto",bottom:0,right:0,position:"fixed"}),r.css({width:360,top:0,padding:"10px"}),u.on("click",function(){t.show_debug_element=!1,t.delete_debug()})},delete_debug:function(){e("#behavior-debug").remove()}};define("behaviors",{Behaviors:{LayoutEditor:t,GridEditor:n}})}(jQuery),function(e,t){typeof exports=="object"&&e.require?module.exports=t(require("underscore"),require("backbone")):typeof define=="function"&&define.amd?define("scripts/backbone-query-parameters/backbone-query-parameters",["underscore","backbone"],function(n,r){return t(n||e._,r||e.Backbone)}):t(_,Backbone)}(this,function(e,t){function c(n,r){function s(e){return String(e).replace(i,encodeURIComponent(i))}var i=t.Router.arrayValueSplit;if(!n)return"";r=r||"";var o=[];return e.each(n,function(t,n){n=r+n;if(e.isString(t)||e.isNumber(t)||e.isBoolean(t)||e.isDate(t))t!=null&&o.push(n+"="+s(encodeURIComponent(t)));else if(e.isArray(t)){var u="";for(var a=0;a<t.length;a++){var f=t[a];f!=null&&(u+=i+s(f))}u&&o.push(n+"="+u)}else{var l=c(t,n+".");l&&o.push(l)}}),o.join("&")}function h(e){try{return decodeURIComponent(e.replace(/\+/g," "))}catch(t){return e}}function p(t,n){var r=t.split("&");e.each(r,function(e){var t=e.split("=");n(t.shift(),t.join("="))})}var n=/^\?(.*)/,r=/\((.*?)\)/g,i=/(\(\?)?:\w+/g,s=/\*\w+/g,o=/[\-{}\[\]+?.,\\\^$|#\s]/g,u=/^([^\?]*)/,a=/[\:\*]([^\:\?\/]+)/g,f=/^[#\/]|\s+$/g,l=/\/$/;t.Router.arrayValueSplit="|",e.extend(t.History.prototype,{getFragment:function(e,t){if(e==null)if(this._hasPushState||!this._wantsHashChange||t){e=this.location.pathname;var n=this.root.replace(l,""),r=this.location.search;e.indexOf(n)||(e=e.substr(n.length)),r&&this._hasPushState&&(e+=r)}else e=this.getHash();return e.replace(f,"")},getQueryParameters:function(t,r){t=this.getFragment(t,r);var i=t.replace(u,""),s=i.match(n);if(s){i=s[1];var o={};return p(i,function(t,n){n=h(n),o[t]?e.isString(o[t])?o[t]=[o[t],n]:o[t].push(n):o[t]=n}),o}return{}}}),e.extend(t.Router.prototype,{initialize:function(e){this.encodedSplatParts=e&&e.encodedSplatParts},_routeToRegExp:function(t){var n=s.exec(t)||{index:-1},u=i.exec(t)||{index:-1},f=t.match(a)||[];t=t.replace(o,"\\$&").replace(r,"(?:$1)?").replace(i,function(e,t){return t?e:"([^\\/\\?]+)"}).replace(s,"([^??]*?)"),t+="(\\?.*)?";var l=new RegExp("^"+t+"$");return n.index>=0&&(u>=0?l.splatMatch=n.index-u.index:l.splatMatch=-1),l.paramNames=e.map(f,function(e){return e.substring(1)}),l.namedParameters=this.namedParameters,l},_extractParameters:function(r,i){var s=r.exec(i).slice(1),o={};s.length>0&&e.isUndefined(s[s.length-1])&&s.splice(s.length-1,1);var u=s.length&&s[s.length-1]&&s[s.length-1].match(n);if(u){var a=u[1],f={};if(a){var l=this;p(a,function(e,t){l._setParamValue(e,t,f)})}s[s.length-1]=f,e.extend(o,f)}var c=s.length;if(r.splatMatch&&this.encodedSplatParts){if(r.splatMatch<0)return s;c-=1}for(var d=0;d<c;d++)e.isString(s[d])&&(s[d]=h(s[d]),r.paramNames&&r.paramNames.length>=d-1&&(o[r.paramNames[d]]=s[d]));return t.Router.namedParameters||r.namedParameters?[o]:s},_setParamValue:function(e,t,n){e=e.replace("[]",""),e=e.replace("%5B%5D","");var r=e.split("."),i=n;for(var s=0;s<r.length;s++){var o=r[s];s===r.length-1?i[o]=this._decodeParamValue(t,i[o]):i=i[o]=i[o]||{}}},_decodeParamValue:function(n,r){var i=t.Router.arrayValueSplit;if(i&&n.indexOf(i)>=0){var s=n.split(i);for(var o=s.length-1;o>=0;o--)s[o]?s[o]=h(s[o]):s.splice(o,1);return s}return n=h(n),r?e.isArray(r)?(r.push(n),r):[r,n]:n},toFragment:function(t,n){return n&&(e.isString(n)||(n=c(n)),n&&(t+="?"+n)),t}})}),function(e){define("upfront/objects/loading",[],function(){var e=Upfront.Models.ObjectModel.extend({init:function(){this.init_property("type","LoadingModel"),this.init_property("view_class","LoadingView"),this.init_property("element_id",Upfront.Util.get_unique_id("please_wait")),this.init_property("content","Please, wait..."),this.init_property("class","c22")}}),t=Upfront.Views.ObjectView.extend({model:e,get_content_markup:function(){return'<img src="'+Upfront.Settings.root_url+'/img/loading.gif" /> '+"<i>"+this.model.get_content()+"</i>"+""}});Upfront.Models.LoadingModel=e,Upfront.Views.LoadingView=t})}(jQuery),define("text!upfront/templates/objects/image/image.html",[],function(){return'<img src="{{src}}" {[ if (alternative_text) { ]} alt="{{alternative_text}}" {[ } ]} {[ if (image_title) { ]} title="{{image_title}}" {[ } ]} />\r\n\r\n\r\n'}),function(e){define("upfront/objects/image",[],function(){var t=Upfront.Models.ObjectModel.extend({init:function(){this.init_property("type","ImageModel"),this.init_property("view_class","ImageView"),this.init_property("element_id",Upfront.Util.get_unique_id("image-object")),this.init_property("class","c22"),this.init_property("has_settings",1)}}),n=Upfront.Views.ObjectView.extend(_.extend({},{model:t,get_buttons:function(){return'<a href="#" class="upfront-icon-button upfront-icon-button-crop"></a>'},get_content_markup:function(){var e=this;require(["text!upfront/templates/objects/image/image.html"],function(t){var n={src:e.model.get_content(),image_title:e.model.get_property_value_by_name("image_title"),alternative_text:e.model.get_property_value_by_name("alternative_text"),when_clicked:e.model.get_property_value_by_name("when_clicked"),image_link:e.model.get_property_value_by_name("image_link"),include_image_caption:e.model.get_property_value_by_name("include_image_caption"),image_caption:e.model.get_property_value_by_name("image_caption"),caption_position:e.model.get_property_value_by_name("caption_position"),caption_alignment:e.model.get_property_value_by_name("caption_alignment"),caption_trigger:e.model.get_property_value_by_name("caption_trigger")},r="";r=_.template(t,n),e.$el.find(".upfront-object-content").html(r)})}})),r=Upfront.Views.Editor.Sidebar.Element.extend({draggable:!1,render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-image"),this.$el.html("Image (old)")},add_element:function(){var e=new t({name:"",properties:[{name:"content",value:"http://wpsalad.com/wp-content/uploads/2012/11/wpmudev.png"}]}),n=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c6 upfront-image_module"},{name:"has_settings",value:0}],objects:[e]});this.add_module(n)}}),i=Upfront.Views.Editor.Settings.Settings.extend({initialize:function(){this.panels=_([new s({model:this.model}),new o({model:this.model})])},get_title:function(){return"Image settings"}}),s=Upfront.Views.Editor.Settings.Panel.extend({initialize:function(){var t=function(){this.settings.invoke("render")};this.settings=_([new a({model:this.model,name:"image_title",label:"Image Title",value:this.model.get_property_value_by_name("image_title")}),new a({model:this.model,name:"alternative_text",label:"Alternative text",value:this.model.get_property_value_by_name("alternative_text")}),new l({model:this.model,name:"include_image_caption",label:"Include image caption",value:this.model.get_property_value_by_name("include_image_caption"),events:{"click #include_image_caption":"do"},"do":function(){var t=this.$el.find("#include_image_caption").is(":checked")?"yes":"no";t=="yes"?(e("#field_image_caption").show(),e("#field_caption_position").show(),e("#field_caption_position").parent().show(),e("#field_caption_trigger").show(),e("#field_caption_alignment").show()):(e("#field_image_caption").hide(),e("#field_caption_position").hide(),e("#field_caption_trigger").hide(),e("#field_caption_alignment").hide())}}),new f({model:this.model,name:"image_caption",label:"Image Caption",value:this.model.get_property_value_by_name("image_caption"),trigger_name:"include_image_caption",trigger_value:"yes"})])},get_label:function(){return"Description"},get_title:function(){return!1}}),o=Upfront.Views.Editor.Settings.Panel.extend({initialize:function(){var t=function(){this.settings.invoke("render")};this.model.on("doit",t,this),this.settings=_([new c({model:this.model,title:"When Clicked",name:"when_clicked",label:"when_clicked",value:this.model.get_property_value_by_name("when_clicked")?this.model.get_property_value_by_name("when_clicked"):!1,options:[{name:"when_clicked",value:"do_nothing",label:"do nothing",icon:"","default":"true"},{name:"when_clicked",value:"open_link",label:"open link",icon:"","default":"false"},{name:"when_clicked",value:"show_larger_image",label:"show larger image",icon:"","default":"false"}],events:{"click input:radio[name=when_clicked]":"do"},"do":function(){var t=this.$el.find("input:radio[name=when_clicked]:checked").val();t=="open_link"?e("#field_image_link").show():e("#field_image_link").hide()}}),new a({model:this.model,name:"image_link",label:"Image link",value:this.model.get_property_value_by_name("image_link")}),new c({model:this.model,name:"caption_position",title:"Caption Settings",label:"caption_position",value:this.model.get_property_value_by_name("caption_position")?this.model.get_property_value_by_name("caption_position"):!1,options:[{name:"caption_position",value:"below_image",label:"below image",icon:'<i class="icon-th-large"></i>',"default":"true"},{name:"caption_position",value:"over_image",label:"over image",icon:'<i class="icon-th-large"></i>'}]}),new c({model:this.model,name:"caption_trigger",label:"caption_trigger",value:this.model.get_property_value_by_name("caption_trigger")?this.model.get_property_value_by_name("caption_trigger"):!1,options:[{name:"caption_trigger",value:"always_show",label:"Always show",icon:'<i class="icon-th-large"></i>',"default":"true"},{name:"caption_trigger",value:"hover_show",label:"Show on hover",icon:'<i class="icon-th-large"></i>',"default":"false"}]}),new c({model:this.model,name:"caption_alignment",label:"caption_alignment",value:this.model.get_property_value_by_name("caption_alignment")?this.model.get_property_value_by_name("caption_alignment"):!1,options:[{name:"caption_alignment",value:"top",label:"Top",icon:'<i class="icon-th-large"></i>',"default":"true"},{name:"caption_alignment",value:"bottom",label:"Bottom",icon:'<i class="icon-th-large"></i>',"default":"false"},{name:"caption_alignment",value:"fill",label:"Fill",icon:'<i class="icon-th-large"></i>',"default":"false"}]})])},get_label:function(){return"Behavior"},get_title:function(){return!1}}),u=Upfront.Views.Editor.Settings.Item.extend({initialize:function(e){this.title=e.title?e.title:!1,this.name=e.name,this.label=e.label?e.label:!1,this.value=e.value,this.icon=e.icon?e.icon:!1,this.type=e.type?e.type:!1,this.options=e.options?e.options:!1,this.events=e.events?e.events:"",this.do=e.do},render:function(){this.$el.empty();if(this.trigger_name&&this.model.get_property_value_by_name(this.trigger_name)!=this.trigger_value)return!1;this.title?this.wrap({title:this.title,markup:this.get_markup()}):this.$el.append('<div class="upfront-settings-item"><div class="'+this.name+'-field">'+this.get_markup()+"</div></div>")},get_name:function(){return this.name},get_value:function(){return this.$el.find('[name="'+this.name+'"]').val()}}),a=u.extend({get_markup:function(){var e=this.model.get_property_value_by_name(this.name)||this.value;e=e||"";var t={label:this.label,name:this.name,value:e},n='<div id="field_{{name}}">{[ if (label) { ]}<label for="{{name}}">{{label}}</label> {[ } ]}<input type="text" name="{{name}}" value="{{value}}" /></div>',r=_.template(n,t);return r}}),f=u.extend({get_markup:function(){var e=this.model.get_property_value_by_name(this.name)||this.value;e=e||"";var t={label:this.label,name:this.name,value:e,icon:this.icon},n='<div id="field_{{name}}">{[ if (label) { ]}<label for="{{name}}">{{label}}</label> {[ } ]}<textarea name="{{name}}">{{value}}</textarea></div>',r=_.template(n,t);return r}}),l=u.extend({get_markup:function(){var e=this.model.get_property_value_by_name(this.name)?this.model.get_property_value_by_name(this.name):"no";e=e||"";var t={label:this.label,name:this.name,value:"yes",checked:e=="yes"?"checked":""},n='<div id="field_{{name}}"><input id="{{name}}" type="checkbox" name="{{name}}" value="1" {{checked}} />{[ if (label) { ]}<label for="{{name}}">{{label}}</label> {[ } ]}</div>',r=_.template(n,t);return r},get_value:function(){var e=this.$el.find('input[name="'+this.name+'"]').is(":checked")?"yes":"no";return e}}),c=u.extend({get_markup:function(){var e=this.model.get_property_value_by_name(this.name),t='<div id="field_'+this.name+'">',n='<input type="radio" name="{{name}}" id="{{name}}" value="{{value}}" {[ if(typeof selected != "undefined" && selected) { ]} checked  {[ } ]}> <span class="radio-button-label">{{icon}} {[ if (label) { ]}<label for="{{name}}">{{label}}</label> {[ } ]}</span>';return _.each(this.options,function(r){!this.value&&r.default=="true"?r.selected=!0:e==r.value&&(r.selected=!0),t+=_.template(n,r)}),t+="</div>",t},get_name:function(){return this.name},get_value:function(){var e=this.$el.find("input:radio[name="+this.name+"]:checked").val();return e!=""?e:""}});Upfront.Application.LayoutEditor.add_object("Image",{Model:t,View:n,Element:r,Settings:i}),Upfront.Models.ImageModel=t,Upfront.Views.ImageView=n})}(jQuery),define("text!upfront/templates/objects/plain_text/plain_text.html",[],function(){return"{[ if(background_color || border) { ]}<div class='plaintxt_padding' style='background-color: {{background_color}}; border: {{border}};'> {[ } ]}\r\n{{content}}\r\n{[ if(background_color || border) { ]}</div> {[ } ]}\r\n\r\n"}),function(e){define("upfront/objects/plain_text",["text!upfront/templates/objects/plain_text/plain_text.html"],function(t){var n=Upfront.Models.ObjectModel.extend({init:function(){this.init_property("type","PlainTxtModel"),this.init_property("view_class","PlainTxtView"),this.init_property("element_id",Upfront.Util.get_unique_id("text-object")),this.init_property("class","c22 upfront-plain_txt"),this.init_property("has_settings",1)}}),r=Upfront.Views.ObjectView.extend({className:"upfront-plain_txt",cssSelectors:{".upfront-plain_txt":{label:"Text container",info:"The layer that contains all the text of the element."}},initialize:function(){this.constructor.__super__.initialize.apply(this,arguments),this.model instanceof n||(this.model=new n({properties:this.model.get("properties")})),this.on("deactivated",function(){Upfront.Events.trigger("upfront:element:edit:stop")},this)},get_content_markup:function(){var n=this.model.get_content();e(n).hasClass("plaintxt_padding")&&(n=e(n).html()),e(n).find("div.plaintxt_padding");var r={content:n,background_color:this.model.get_property_value_by_name("background_color"),border:this.model.get_property_value_by_name("border")},i="";return i=_.template(t,r),i+(!this.is_edited()||e.trim(n)==""?'<div class="upfront-quick-swap"><p>Double click to edit text</p></div>':"")},is_edited:function(){var e=this.model.get_property_value_by_name("is_edited");return e?!0:!1},on_render:function(){var t=this,n=!1;this.$el.find(".upfront-object-content").addClass("upfront-plain_txt").ueditor({linebreaks:!1,autostart:!1}).on("start",function(){var n=e(this).find(".upfront-quick-swap");n.length&&n.remove(),t.model.set_property("is_edited",!0,!0),Upfront.Events.trigger("upfront:element:edit:start","text")}).on("stop",function(){Upfront.Events.trigger("upfront:element:edit:stop")}).on("syncAfter",function(){t.model.set_content(e(this).html(),{silent:!0})})}}),i=Upfront.Views.Editor.Sidebar.Element.extend({priority:10,render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-text"),this.$el.html("Text")},add_element:function(){var e=new n({name:"",properties:[{name:"content",value:"<p>My awesome stub content goes here</p>"}]}),t=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c11"},{name:"row",value:"5"},{name:"has_settings",value:0}],objects:[e]});this.add_module(t)}}),s=Upfront.Views.Editor.Settings.Panel.extend({className:"plaintxt-settings-panel",initialize:function(){var e,t=this;e=function(){this.settings.invoke("render")},_.bindAll(this,"onBgColor","onBorderColor"),this.settings=_([new Upfront.Views.Editor.Settings.Item({model:this.model,title:"Textbox Appearance",fields:[new Upfront.Views.Editor.Field.Checkboxes({className:"inline-checkboxes plaintext-settings bg-color-enabled",model:this.model,property:"bg_color_enabled",label:"",values:[{label:"Background Color:",value:"yes"}]}),new Upfront.Views.Editor.Field.Color({className:"upfront-field-wrap upfront-field-wrap-color sp-cf  plaintext-settings inline-color",model:this.model,property:"bg_color",label:"",spectrum:{preferredFormat:"hex",change:this.onBgColor,move:this.onBgColor}}),new Upfront.Views.Editor.Field.Checkboxes({className:"inline-checkboxes plaintext-settings border-enabled",model:this.model,property:"border_enabled",label:"",values:[{label:"Border",value:"yes"}]}),new Upfront.Views.Editor.Field.Number({className:"inline-number plaintext-settings",model:this.model,min:1,property:"border_width",label:"",default_value:"1",values:[{label:"",value:"1"}]}),new Upfront.Views.Editor.Field.Color({className:"upfront-field-wrap upfront-field-wrap-color sp-cf  plaintext-settings inline-color",model:this.model,property:"border_color",label:"",spectrum:{preferredFormat:"hex",change:this.onBorderColor,move:this.onBorderColor}}),new Upfront.Views.Editor.Field.Radios({className:"inline-radios  plaintext-settings",model:this.model,property:"border_style",label:"",default_value:"solid",values:[{label:"Solid",value:"solid"},{label:"Dashed",value:"dashed"},{label:"Dotted",value:"dotted"}]})]})]),this.$el.on("change","input[name=bg_color_enabled]",function(e){t.onBgColorEnabled(e)}),this.$el.on("change","input[name=border_enabled]",function(e){t.onBorderEnabled(e)}),this.$el.on("change","input[name=border_style]",function(e){t.onBorderStyle(e)}),this.$el.on("change","input[name=border_width]",function(e){t.onBorderWidth(e)})},onBgColorEnabled:function(t){this.property("bg_color_enabled",e(t.currentTarget).prop("checked"),!1),this.processBg()},onBgColor:function(e){this.property("bg_color",e.toRgbString(),!1),this.processBg()},onBorderEnabled:function(t){this.property("border_enabled",e(t.currentTarget).prop("checked"),!1),this.processBorder()},onBorderWidth:function(t){this.property("border_width",e(t.currentTarget).val(),!1),this.processBorder()},onBorderColor:function(e){this.property("border_color",e.toRgbString(),!1),this.processBorder()},onBorderStyle:function(t){this.property("border_style",e(t.currentTarget).val(),!1),this.processBorder()},processBg:function(){this.property("bg_color_enabled")?this.property("background_color",this.property("bg_color"),!1):this.property("background_color","",!1)},processBorder:function(){this.property("border_enabled")?this.property("border",this.property("border_width")+"px "+this.property("border_color")+" "+this.property("border_style"),!1):this.property("border","",!1)},property:function(e,t,n){return typeof t!="undefined"?(typeof n=="undefined"&&(n=!0),this.model.set_property(e,t,n)):this.model.get_property_value_by_name(e)},get_label:function(){return"Appearance"},render:function(){this.constructor.__super__.render.apply(this,arguments);var t=this;this.property("bg_color_enabled")===!0?this.$el.find(".bg-color-enabled input").attr("checked",!0):this.$el.find(".bg-color-enabled input").removeAttr("checked"),this.property("border_enabled")===!0?this.$el.find(".border-enabled input").attr("checked",!0):this.$el.find(".border-enabled input").removeAttr("checked"),this.$el.find(".border-enabled input").prop("checked")||t.$el.find(".upfront-field-number").prop("disabled",!0),this.$el.find(".border-enabled input").bind("change",function(){e(this).prop("checked")?t.$el.find(".upfront-field-number").prop("disabled",!1):t.$el.find(".upfront-field-number").prop("disabled",!0)}),this.$el.find(".upfront-settings_label").remove(),this.$el.find(".upfront-settings_panel").css("left",0)}}),o=Upfront.Views.Editor.Settings.Settings.extend({initialize:function(){this.panels=_([new s({model:this.model})])},get_title:function(){return"Textbox Appearance"}}),u=Upfront.Views.ContextMenuList.extend({initialize:function(){var t=this;this.menuitems=_([new Upfront.Views.ContextMenuItem({get_label:function(){return"Edit Text"},action:function(){var n=t.for_view.$el.find("div.upfront-object-content").data("ueditor");t.for_view.$el.find("div.upfront-object-content").data("redactor")||(n.start(),e(document).on("click",function(t){if(!n.options.autostart&&n.redactor){var r=e(t.target);!n.disableStop&&!r.closest("li").length&&!r.closest(".redactor_air").length&&!r.closest(".ueditable").length&&n.stop()}}))}})])}}),a=Upfront.Views.ContextMenu.extend({initialize:function(){this.menulists=_([new u])}});Upfront.Application.LayoutEditor.add_object("PlainTxt",{Model:n,View:r,Element:i,Settings:o,ContextMenu:a}),Upfront.Models.PlainTxtModel=n,Upfront.Views.PlainTxtView=r})}(jQuery),function(){define("objects",["upfront/objects/loading","upfront/objects/image","upfront/objects/plain_text"],function(){if(!Upfront||!Upfront.Application.LayoutEditor||!Upfront.Application.LayoutEditor.add_object)return Upfront.Util.log("Unable to add object"),!1})}(),function(e,t){define("media",[],function(){var t={FULL:"full",to_size:function(e){return e.width+"x"+e.height}},n=Backbone.Collection.extend({}),r=Backbone.Collection.extend({model:i,initialize:function(){Upfront.Events.on("media_manager:media:labels_loaded",this.global_labels_loaded,this)},get_shared_labels:function(){var e=a.get("label"),t=[],n=[],r={};return this.each(function(e){r[e.get("ID")]=e.get("labels")||[]}),t=_.intersection.apply(this,_(r).values()),e.each(function(e){t.indexOf(e.get("value"))>=0&&n.push(e)}),n},get_additional_sizes:function(){var e=this.invoke("get","additional_sizes"),n=[];return _(e).each(function(e,r){var i=[];r||(n=_(e).map(function(e){return t.to_size(e)})),_(e).each(function(e){i.push(t.to_size(e))}),n=_.intersection(n,i)}),n.push(t.FULL),n},is_used_label:function(e){return _(this.get_shared_labels()).invoke("get","value").indexOf(e.get("value"))>=0},update_label_state:function(e){return this.is_used_label(e)?this.disassociate_label(e):this.associate_label(e)},associate_label:function(e){this._update_label("",e)},disassociate_label:function(e){Upfront.Util.log("disassocisting labels"),this._update_label("dis",e)},_update_label:function(e,t){e=e||"";var n=this,r=t.get("value"),i={action:"upfront-media-"+e+"associate_label",term:r,post_ids:this.invoke("get","ID")};Upfront.Util.post(i).success(function(e){n.each(function(t){var n=e.data[t.get("ID")];n&&t.set({labels:n},{silent:!0})}),n.trigger("change")})},add_new_label:function(e){var t=this,n={action:"upfront-media-add_label",term:e,post_ids:this.invoke("get","ID")};Upfront.Util.post(n).success(function(e){t.each(function(t){var n=e.data[t.get("ID")];n&&t.set({labels:n},{silent:!0})}),Upfront.Events.trigger("media_manager:media:labels_updated"),t.trigger("change")})},delete_media_items:function(){var e=this,t={action:"upfront-media-remove_item",post_ids:this.invoke("get","ID")};Upfront.Util.post(t).success(function(t){e.reset([]),Upfront.Events.trigger("media_manager:media:list",a)})},global_labels_loaded:function(){this.trigger("change")}}),i=Backbone.Model.extend({defaults:{thumbnail:"<img src='http://cdn5.iconfinder.com/data/icons/app-tab-bar-icons-for-iphone/60/Flickr_social_circle_square_social_media_icontexto_gray_button.png' />"}}),s=Backbone.Collection.extend({model:k}),o=Backbone.Model.extend({}),u=Backbone.Model.extend({labels_cache:!1,default_media_types:["images","videos","audios"],allowed_media_types:[],showing_titles:!0,initialize:function(){this.to_defaults(),Upfront.Events.on("media_manager:media:filters_updated",this.update_active_filters,this),Upfront.Events.on("media_manager:media:labels_updated",this.reload_labels,this),Upfront.Events.on("media_manager:media:toggle_titles",this.toggle_titles,this)},to_defaults:function(){var e=new s([]),t=this.allowed_media_types.indexOf("images")>=0;this.allowed_media_types.length||(this.allowed_media_types=this.default_media_types),t&&e.add(new o({filter:"Images",value:"images",state:!0}),{silent:!0}),this.allowed_media_types.indexOf("videos")>=0&&e.add(new o({filter:"Videos",value:"videos",state:!t}),{silent:!0}),this.allowed_media_types.indexOf("audios")>=0&&e.add(new o({filter:"Audios",value:"audios",state:!t}),{silent:!0}),this.set("type",e,{silent:!0}),this.set("recent",new s([new o({filter:"5",value:5,state:!1}),new o({filter:"10",value:10,state:!1}),new o({filter:"20",value:20,state:!1}),new o({filter:"40",value:40,state:!1}),new o({filter:"100",value:100,state:!1})]),{silent:!0}),this.set("order",new s([new o({filter:"Newest",value:"date_desc",state:!0}),new o({filter:"Oldest",value:"date_asc",state:!1}),new o({filter:"A>Z",value:"title_asc",state:!1}),new o({filter:"Z>A",value:"title_desc",state:!1})]),{silent:!0}),this.set({search:new s([])},{silent:!0}),this.themeImages=!1,this.set_labels_to_defaults()},toggle_titles:function(){this.showing_titles=!this.showing_titles},set_labels_to_defaults:function(){if(this.labels_cache){var e=[];_(this.labels_cache).each(function(t){e.push(new o({filter:t.name,value:t.term_id,state:!1}))}),this.set("label",new s(e),{silent:!0}),Upfront.Events.trigger("media_manager:media:labels_loaded")}else this.reload_labels()},reload_labels:function(){var e=this;Upfront.Util.post({action:"upfront-media-get_labels"}).success(function(t){var n=[];t.data&&(e.labels_cache=t.data,e.set_labels_to_defaults())})},update_active_filters:function(e,t){if(!e||!this.get(e))this.to_defaults(),Upfront.Events.trigger("media_manager:media:filters_reset");else{var n=t&&t.get?t.get(e).toArray():t,r=this.get(e);_(n).each(function(e){if(e.get("state")){var t=r.where({filter:e.get("filter")});t.length&&t[0].set({state:e.get("state")},{silent:!0})}})}Upfront.Events.trigger("media_manager:media:list",this)},to_request_json:function(){var e={},t=this;return _(this.attributes).each(function(n,r){var i=t.get(r).where({state:!0});e[r]=_(i).invoke("get","value")}),e},to_list:function(){var e={},t=this;return _(this.attributes).each(function(n,r){var i=t.get(r).where({state:!0});e[r]=_(i).invoke("get","filter")}),e}}),a=new u,f=Backbone.View.extend({className:"upfront-media-controls",is_search_active:!1,initialize:function(){Upfront.Events.on("media:item:selection_changed",this.switch_controls,this),Upfront.Events.on("media:search:requested",this.switch_to_search,this)},render:function(){this.render_filters()},render_filters:function(){var e=this.is_search_active?new m:new g;e.render(),this.$el.empty().append(e.$el),this.is_search_active?this.$el.removeClass("upfront-media-controls-search-selected").addClass("upfront-media-controls-search"):this.$el.removeClass("upfront-media-controls-search")},render_media:function(e){var t=new p({model:new r(e)});t.render(),this.$el.empty();if(this.is_search_active){var n=new m;n.render(),this.$el.append(n.$el),this.$el.removeClass("upfront-media-controls-search").addClass("upfront-media-controls-search-selected")}else this.$el.removeClass("upfront-media-controls-search-selected");this.$el.append(t.$el)},switch_controls:function(e){var t=e.where({selected:!0});t.length?this.render_media(t):this.render_filters()},switch_to_search:function(e){this.is_search_active=e&&e.get("state"),this.render_filters()}}),l=Backbone.View.extend({className:"upfront-media-aux_controls",initialize:function(){Upfront.Events.on("media:item:selection_changed",this.switch_controls,this)},render:function(){this.render_selection()},render_selection:function(){var e=new c({model:this.model});e.render(),this.$el.empty().append(e.$el),this.$el.removeClass("upfront-media-aux_controls-has-select")},render_delete:function(e){var t=new h({model:new r(e)});t.render(),this.render_selection(),this.$el.append(t.$el),this.$el.addClass("upfront-media-aux_controls-has-select")},switch_controls:function(e){var t=e.where({selected:!0});t.length?this.render_delete(t):this.render_selection()}}),c=Backbone.View.extend({className:"select_control_container",events:{"click a.none":"select_none","click a.all":"select_all"},render:function(){this.$el.empty().append('Select <a href="#all" class="all">All</a>&nbsp;|&nbsp;<a href="#none" class="none">None</a>')},select_none:function(e){e.preventDefault(),e.stopPropagation(),this.model.each(function(e){e.set({selected:!1},{silent:!0})}),this.model.trigger("change"),Upfront.Events.trigger("media:item:selection_changed",this.model)},select_all:function(e){e.preventDefault(),e.stopPropagation();var t=[];this.model.each(function(e){e.set({selected:!0},{silent:!0}),t.push(e)}),this.model.trigger("change"),Upfront.Events.trigger("media:item:selection_changed",this.model)}}),h=Backbone.View.extend({className:"delete_control_container",events:{click:"delete_selection"},render:function(){this.$el.empty().append('<a href="#delete">Delete</a>')},delete_selection:function(e){e.preventDefault(),e.stopPropagation();var t=!1;this.model.each(function(e){e.get("parent")&&(t=!0)}),(!t||t&&confirm("The selected media file is already in use. Are you sure?"))&&this.model.delete_media_items()}}),p=Backbone.View.extend({className:"upfront-item-control",templates:{caption:_.template('<label class="upfront-field-label upfront-field-label-block">{{title}}</label>'),shared_label:_.template('<a href="#remove" class="upfront-icon upfront-icon-media-label-delete" data-idx="{{value}}">{{filter}}</a>'),additional_size:_.template('<option value="{{size}}">{{size}}</option>')},events:{"click .existing_labels a":"drop_label"},initialize:function(){this.model.on("change",this.render,this)},render:function(){this.$el.empty().append('<div class="change_title" />').append('<div class="add_labels" />').append('<div class="existing_labels" />').append('<div class="additional_sizes" />'),this.render_title(),this.render_labels_adding(),this.render_shared_labels(),this.render_additional_sizes()},render_title:function(){var e=this,t=this.$el.find(".change_title");t.empty(),this.model.length>1?t.append('<span class="selected_length">'+this.model.length+" files selected</span>"):(this.title_field=new Upfront.Views.Editor.Field.Text({model:this.model.at(0),label:"Media Title",name:"post_title",change:function(){e.change_title()}}),this.title_field.render(),t.append(this.title_field.$el))},render_labels_adding:function(){var e=this,t=this.$el.find(".add_labels"),n=new d({model:this.model});t.empty().append(this.templates.caption({title:"Add Label(s)"})),n.render(),t.append(n.$el)},render_shared_labels:function(){var e=this,t=this.$el.find(".existing_labels"),n=this.model.get_shared_labels(),r=n.length>1?"Current Label(s)":"";t.empty().append(this.templates.caption({title:r})),_(n).each(function(n){t.append(e.templates.shared_label(n.toJSON()))})},render_additional_sizes:function(){var e=this,n=this.$el.find(".additional_sizes"),r=this.model.get_additional_sizes(),i="Additional sizes",s=[];n.empty();if(!r.length)return!1;_(r).each(function(e){s.push({label:e,value:e})}),this.size_field=new Upfront.Views.Editor.Field.Select({model:this.model.at(0),label:i,name:"selected_size",width:"100%",values:s,default_value:t.FULL,change:function(){e.select_size()}}),this.size_field.render(),n.append(this.size_field.$el),this.size_field.$el.on("click",function(e){e.stopPropagation()})},select_size:function(e){var n=this.size_field.get_value()||t.FULL;this.model.each(function(e){e.set({selected_size:n},{silent:!0})})},change_title:function(e){var t=this.model.at(0);t.set({post_title:this.title_field.get_value()});var n=this,r={action:"upfront-media-update_media_item",data:t.toJSON()};Upfront.Util.post(r).done(function(){t.trigger("change")}),t.trigger("appearance:update")},drop_label:function(t){t.preventDefault(),t.stopPropagation();var n=e(t.target),r=n.attr("data-idx"),i=this.model.get_shared_labels(),s=_(i).invoke("get","value").indexOf(r),o=s>=0&&i[s]?i[s]:!1;o&&this.model.update_label_state(o)}}),d=Backbone.View.extend({className:"upfront-additive_multiselection",selection:"",events:{"click :text":"stop_prop","keyup .search_labels :text":"update_selection","click .add_labels a":"add_new_labels"},stop_prop:function(e){e.stopPropagation()},render:function(){this.$el.empty().append('<div class="search_labels" />').append('<div class="labels_list"><ul></ul></div>').append('<div class="add_labels" />'),this.render_search(),this.render_labels(),this.render_addition()},render_search:function(){var e=this.$el.find(".search_labels");e.empty().append('<input type="text" class="upfront-field upfront-field-text" value="'+this.selection+'"/>')},render_labels:function(){var e=this,t=this.$el.find(".labels_list ul"),n=a.get("label"),r=this.model.get_shared_labels(),i=!1;t.empty(),n.each(function(n){var s=new v({model:n});s.shared=r,s.media_items=e.model,s.selection=e.selection,s.render(),s.$el.find("input").size()>0&&(i=!0,t.append(s.$el))}),i?t.removeClass("empty"):t.addClass("empty")},render_addition:function(){var e=this.$el.find(".add_labels");e.empty(),this.selection?e.append('<b class="add_value">'+this.selection+'</b> <a class="add_link" href="#add">+Add</a>').removeClass("empty"):e.addClass("empty")},update_selection:function(e){e.preventDefault(),e.stopPropagation();var t=this.$el.find(".search_labels :text"),n=t.val();this.selection=n,this.render_labels(),this.render_addition()},add_new_labels:function(e){e.preventDefault(),e.stopPropagation();var t=this.$el.find(".search_labels :text"),n=t.val();this.model.add_new_label(n)}}),v=Backbone.View.extend({tagName:"li",events:{click:"toggle_label_assignment"},render:function(){var e=this,t=this.media_items.is_used_label(this.model),n=_.template('<input type="checkbox" id="{{id}}" class="upfront-field-checkbox" value="{{value}}" checked />'),r=_.template('<input type="checkbox" id="{{id}}" class="upfront-field-checkbox" value="{{value}}" />'),i=_.template('<label for="{{id}}">{{name}}</label>'),s=this.model.get("filter"),o=this.selection?new RegExp("^("+this.selection+")","i"):!1,u=this.model.toJSON();this.$el.empty();if(!s.match(o))return!1;u.id=this.cid,u.name=s.replace(o,'<span class="selection">$1</span>'),this.$el.append(i(u)).append((t?n:r)(u))},toggle_label_assignment:function(e){e.preventDefault(),e.stopPropagation(),this.media_items.update_label_state(this.model)}}),m=Backbone.View.extend({className:"upfront-search_filter-control",events:{"click a":"clear_search"},render:function(){var e=a.get("search").first(),t=e.toJSON();console.log(a),t.total=a.get("search").length,this.$el.empty().append(_.template('Showing {{total}} results for <b class="search-text">{{value}}</b> <a href="#clear" class="clear_search">Clear search</a>',t))},clear_search:function(e){e.preventDefault(),e.stopPropagation();var t=new o({filter:!1,value:!1,state:!1});a.set({search:new s([t])}),Upfront.Events.trigger("media_manager:media:list",a),Upfront.Events.trigger("media:search:requested",t)}}),g=Backbone.View.extend({className:"upfront-filter-control",events:{click:"stop_prop","change #media_manager-show_titles":"toggle_titles"},stop_prop:function(e){e.stopPropagation()},initialize:function(){this.filter_selection=new b,this.filters_selected=new y({model:a})},render:function(){this.filter_selection.render(),this.filters_selected.render(),this.$el.empty().append(this.filter_selection.$el).append(this.filters_selected.$el)},toggle_titles:function(e){e.stopPropagation(),Upfront.Events.trigger("media_manager:media:toggle_titles")}}),y=Backbone.View.extend({className:"upfront-filter_selected-control",events:{"click a.filter":"drop_filter","click a.all_filters":"drop_all"},initialize:function(){Upfront.Events.on("media_manager:media:list",this.set_filters,this)},render:function(){this.$el.empty();var e=this,t=_.template(' <a href="#" class="filter upfront-icon upfront-icon-media-label-delete" data-type="{{type}}" data-filter="{{filter}}">{{filter}}</a>');this.$el.append('<label class="upfront-field-label upfront-field-label-block">Active filters</label>'),_(this.model.to_list()).each(function(n,r){_(n).each(function(n){e.$el.append(t({filter:n,type:r}))})}),this.$el.append(" <a href='#' class='all_filters'>Clear</a>")},set_filters:function(e){this.model=e,this.render()},drop_filter:function(t){t.preventDefault(),t.stopPropagation();var n=e(t.target),r=this.model,i=n.attr("data-type"),s=n.attr("data-filter");if(i&&r.get(i)){var o=r.get(i).where({filter:s});o&&o.length&&_(o).invoke("set",{state:!1},{silent:!0})}else _(this.model.attributes).each(function(e,t){var n=r.get(t).where({filter:s});n.length&&(i=t,_(n).invoke("set",{state:!1},{silent:!0}))});Upfront.Events.trigger("media_manager:media:filters_updated",i,this.model)},drop_all:function(e){e.preventDefault(),e.stopPropagation(),Upfront.Events.trigger("media_manager:media:filters_updated",!1,!1)}}),b=Backbone.View.extend({className:"upfront-filter_selection-control clearfix",events:{},initialize:function(){this.controls=_([new L,new A,new O,new M,new D])},render:function(){var e=this,t=_.template("<li style='display:none'><a href='#' data-idx='{{idx}}'>{{name}}</a></li>"),n=[];this.controls.each(function(e,t){n.push({label:e.get_name(),value:t})}),this.$el.empty(),this.$el.append('<div class="upfront-filter_control" />'),this.$control=this.$el.find("div.upfront-filter_control"),this.control_field=new Upfront.Views.Editor.Field.Select({label:"Filter",name:"filter-selection",width:"100%",values:n,change:function(){e.select_control(this.get_value())}}),this.control_field.render(),this.$el.prepend(this.control_field.$el),Upfront.Events.on("media_manager:media:filters_updated")},select_control:function(e){var t=this.controls.toArray()[e];return t.render(),this.$control.empty().append(t.$el),!1}}),w=Backbone.View.extend({tagName:"ul",get_name:function(){return this.filter_name},initialize_model:function(){this.model=a.get(this.filter_type),this.model.on("change",this.apply_changes,this)},render:function(){var e=this;this.$el.empty(),this.model.each(function(t){if(e.allowed_values&&e.allowed_values.indexOf(t.get("value"))<0)return!1;var n=new x({model:t});n.render(),e.$el.append(n.$el)})},apply_changes:function(){var e={},t=[];e=this.model.where({state:!0}),Upfront.Events.trigger("media_manager:media:filters_updated",this.filter_type,e)},update_selection:function(){var e=a.get(this.filter_type);return e?this.model.each(function(t){var n=e.where({filter:t.get("filter"),state:!0});t.set({state:!!n.length})}):this.model.invoke("set",{state:!1}),this.render(),!1}}),E=w.extend({tagName:"div",className:"upfront-additive_multiselection",events:{click:"stop_prop","keyup :text.filter":"show_matching_labels"},stop_prop:function(e){e.stopPropagation()},render:function(){var e=this,t=this.selection||"";this.$el.empty().append('<input type="text" class="filter upfront-field upfront-field-text" value="'+t+'" />').append('<div class="labels_list"><ul></ul></div>'),this.render_items()},render_items:function(){var e=this,t=this.$el.find("div.labels_list ul");t.empty(),this.model.each(function(n){if(e.allowed_values&&e.allowed_values.indexOf(n.get("value"))<0)return!1;var r=new N({model:n});r.selection=e.selection,r.render(),t.append(r.$el)})},show_matching_labels:function(e){var t=this.$el.find(":text.filter"),n=t.val();this.selection=n,this.render_items()}}),S=w.extend({render:function(){var e=this;this.$el.empty(),this.model.each(function(t){if(e.allowed_values&&e.allowed_values.indexOf(t.get("value"))<0)return!1;var n=new T({model:t});n.render(),e.$el.append(n.$el),n.on("model:unique_state:change",e.change_state,e)})},change_state:function(e){this.model.each(function(t){t.get("value")!=e.get("value")&&t.set({state:!1},{silent:!0})}),e.set({state:!0},{silent:!0}),this.apply_changes(),this.render()}}),x=Backbone.View.extend({tagName:"li",events:{click:"on_click"},initialize:function(){this.model.on("change",this.render,this)},render:function(){var e=this.model.get("filter");this.model.get("state")&&(e="<b>"+e+"</b>"),this.$el.empty().append(e)},on_click:function(e){e.preventDefault(),e.stopPropagation(),this.model.set({state:!this.model.get("state")})}}),T=x.extend({on_click:function(e){e.preventDefault(),e.stopPropagation(),this.model.set({state:!this.model.get("state")},{silent:!0}),this.trigger("model:unique_state:change",this.model)}}),N=x.extend({render:function(){var e=_.template('<input type="checkbox" for="{{id}}" class="upfront-field-checkbox" name="{{filter}}" value="{{value}}" checked />'),t=_.template('<input type="checkbox" for="{{id}}" class="upfront-field-checkbox" name="{{filter}}" value="{{value}}" />'),n=_.template('<label for="{{id}}">{{name}}</label>'),r=this.model.get("filter"),i=this.selection?new RegExp("^("+this.selection+")","i"):!1,s=this.model.toJSON();this.$el.empty();if(i&&!r.match(i))return!1;s.id=this.cid,s.name=r.replace(i,'<span class="selection">$1</span>'),this.$el.append(n(s)).append((this.model.get("state")?e:t)(s))}}),C=Backbone.View.extend({render:function(){var e=this;this.$el.empty(),this.model.each(function(t){var n=new k({model:t});n.render(),e.$el.append(n.$el)})}}),k=Backbone.View.extend({render:function(){this.$el.empty().append(this.model.get("filter"))}}),L=w.extend({initialize:function(){this.filter_name="Media type",this.filter_type="type",this.initialize_model(),Upfront.Events.on("media_manager:media:filters_updated",this.update_selection,this),Upfront.Events.on("media_manager:media:filters_reset",this.initialize_model,this)}}),A=S.extend({allowed_values:["date_asc","date_desc"],initialize:function(){this.filter_name="Date",this.filter_type="order",this.initialize_model(),Upfront.Events.on("media_manager:media:filters_updated",this.update_selection,this),Upfront.Events.on("media_manager:media:filters_reset",this.initialize_model,this)}}),O=S.extend({allowed_values:["title_desc","title_asc"],initialize:function(){this.filter_name="File Name",this.filter_type="order",this.initialize_model(),Upfront.Events.on("media_manager:media:filters_updated",this.update_selection,this),Upfront.Events.on("media_manager:media:filters_reset",this.initialize_model,this)}}),M=S.extend({initialize:function(){this.filter_name="Recent",this.filter_type="recent",this.initialize_model(),Upfront.Events.on("media_manager:media:filters_updated",this.update_selection,this),Upfront.Events.on("media_manager:media:filters_reset",this.initialize_model,this)}}),D=E.extend({initialize:function(){this.filter_name="Labels",this.filter_type="label",this.initialize_model(),Upfront.Events.on("media_manager:media:filters_updated",this.update_selection,this),Upfront.Events.on("media_manager:media:filters_reset",this.initialize_model,this),Upfront.Events.on("media_manager:media:labels_loaded",this.reinitialize_model,this)},reinitialize_model:function(){this.initialize_model(),this.render()}}),P=Backbone.View.extend({events:{"click .library":"switch_to_library","click .embed":"switch_to_embed"},template:_.template('<ul class="upfront-tabs upfront-media_manager-tabs"> <li class="library">Library</li> <li class="embed">Embed</li> </ul>'),render:function(){this.$el.empty().append(this.template({})),this.$el.addClass("clearfix"),this.switch_to_library()},switch_to_library:function(e){this.$el.find("li").removeClass("active").filter(".library").addClass("active"),e&&(e.preventDefault(),e.stopPropagation(),this.trigger("media_manager:switcher:to_library"))},switch_to_embed:function(e){e.preventDefault(),e.stopPropagation(),this.$el.find("li").removeClass("active").filter(".embed").addClass("active"),this.trigger("media_manager:switcher:to_embed")}}),H=Backbone.View.extend({initialize:function(e){e=_.extend({type:"PostImage",multiple_selection:!0},e);var t=e.type,n=e.multiple_selection,r=e.button_text;this.popup_data=e.data,a.to_defaults(),this.switcher_view=new P({el:this.popup_data.$top}),this.command_view=new B({el:this.popup_data.$bottom,button_text:r,ck_insert:e.ck_insert}),this.library_view=new X(e.collection),this.embed_view=new R({}),this.library_view.multiple_selection=n,e.themeImages&&(a.themeImages=!0,this.library_view.multiple_selection=!1),Upfront.Events.on("media_manager:media:list",this.switch_media_type,this)},render:function(){this.switcher_view.render(),this.switcher_view.on("media_manager:switcher:to_library",this.render_library,this),this.switcher_view.on("media_manager:switcher:to_embed",this.render_embed,this),this.command_view.render(),this.command_view.on("media_manager:switcher:to_upload",this.render_upload,this),this.render_library()},render_library:function(){this.load(),this.embed_view.model.clear({silent:!0}),this.library_view.render(),this.library_view.$el.css({height:this.popup_data.height-88}),this.$el.empty().append(this.library_view.$el)},render_embed:function(){this.embed_view.model.clear({silent:!0}),this.embed_view.render(),this.embed_view.$el.css({"max-height":this.popup_data.height,"overflow-y":"scroll"}),this.$el.empty().append(this.embed_view.$el)},render_upload:function(){this.library_view.$el.is(":visible")||this.render_library();var t=this,n=new i({progress:0}),r=a.themeImages?_upfront_media_upload+"-theme-image":_upfront_media_upload;this.$el.append('<input id="fileupload" type="file" style="display:none" name="media" data-url="'+r+'">'),e("#fileupload").fileupload({dataType:"json",add:function(e,r){var i=r.files[0],s=i.name||"tmp";n.set({post_title:s}),t.library_view.media_collection.add(n,{at:0}),r.submit(),n.on("upload:abort",function(){r.abort(),n.get("ID")&&Upfront.Util.post({action:"upfront-media-remove_item",item_id:n.get("ID")}).always(function(){t.library_view.media_collection.trigger("change")}),t.library_view.media_collection.remove(n),t.library_view.media_collection.trigger("change")}),n.trigger("upload:start",i)},progressall:function(e,t){var r=parseInt(t.loaded/t.total*100,10);n.trigger("upload:progress",r)},done:function(e,t){if(a.themeImages)return n.set(t.result.data,{silent:!0}),n.trigger("upload:finish");var r=t.result.data||[],i=r[0];n.set({ID:i},{silent:!0}),Upfront.Util.post({action:"upfront-media-get_item",item_id:i}).done(function(e){n.set(e.data,{silent:!0}),n.trigger("upload:finish")}).fail(function(){Upfront.Events.trigger("media_manager:media:list",a)})},fail:function(e,t){Upfront.Views.Editor.notify(t.jqXHR.responseJSON.error,"error"),Upfront.Events.trigger("media_manager:media:list",a)}}).trigger("click")},load:function(e){e=e&&e.type?e:a.to_request_json(),e.action=a.themeImages?"upfront-media-list_theme_images":"upfront-media-list_media";var t=this;this.library_view.media_view&&this.library_view.media_view.start_loading&&this.library_view.media_view.start_loading(),Upfront.Util.post(e).done(function(e){t.library_view.update(e.data)}).fail(function(e){t.library_view.update([])})},switch_media_type:function(e){this.load(e.to_request_json())}}),B=Backbone.View.extend({render:function(){var e=this.options.button_text,t=new j,n=new F,r=this.options.ck_insert?new q({button_text:e}):new I({button_text:e});t.render(),t.on("media_manager:switcher:to_upload",this.switch_to_upload,this),n.render(),r.render(),this.$el.empty().append(t.$el).append(r.$el).append(n.$el)},switch_to_upload:function(e){this.trigger("media_manager:switcher:to_upload")}}),j=Backbone.View.extend({className:"upload_media_container",events:{"click .upload":"switch_to_upload"},render:function(){this.$el.empty().append('<button type="button" class="upload">Upload new media</button>')},switch_to_upload:function(e){e.preventDefault(),e.stopPropagation(),this.trigger("media_manager:switcher:to_upload")}}),F=Backbone.View.extend({className:"search_container clearfix",events:{"click .search":"do_search","click .clear":"clear_search","keyup :text":"on_keyup"},render:function(){var e=a.get("search"),t=e.length?e.first():!1,n=!!t&&t.get("state");this.$el.empty().append('<input type="text" placeholder="Search" value="'+(n&&t?t.get("value"):"")+'" />'),n?(this.$el.append('<a href="#clear" class="clear upfront-icon upfront-icon-popup-search-clear"></a>'),this.$el.addClass("has_search")):this.$el.removeClass("has_search"),this.$el.append('<div class="search upfront-icon upfront-icon-popup-search" id="upfront-search_action"></div>')},do_search:function(e){e.preventDefault(),e.stopPropagation();var t=this.$el.find(":text"),n=t.val(),r=new o({filter:n,value:n,state:!0});n||(r=new o({filter:!1,value:!1,state:!1})),a.to_defaults(),a.set("search",new s([r])),Upfront.Events.trigger("media_manager:media:list",a),Upfront.Events.trigger("media:search:requested",r),this.render()},clear_search:function(e){e.preventDefault(),e.stopPropagation();var t=this.$el.find(":text");t.val(""),this.do_search(e)},on_keyup:function(e){e.keyCode==13?this.$el.find(".search").trigger("click"):e.keyCode==27&&this.$el.find(".clear").trigger("click")}}),I=Backbone.View.extend({className:"use_selection_container",events:{"click a":"use_selection"},initialize:function(){Upfront.Events.on("media:item:selection_changed",this.update_model,this)},render:function(){var e=this.options.button_text||"Ok";this.$el.empty().append('<a href="#use" class="use">'+e+"</a>")},update_model:function(e){var t=e.where({selected:!0});this.model=new r(t)},use_selection:function(e){e.preventDefault(),e.stopPropagation(),Upfront.Popup.close(this.model)}}),q=I.extend({use_selection:function(e){e.preventDefault(),e.stopPropagation(),this.model&&this.model.length>1?this.open_dialog():Upfront.Popup.close(this.model)},open_dialog:function(){var t=e('<div id="media-manager-multi-dialog" class="upfront-ui" />');t.append('<h3 class="multi-dialog-title">How would you like to insert those images?</h3>'),t.append('<ul class="multi-dialog-choices"><li class="multi-dialog-choice upfront-icon upfront-icon-media-insert-multi-plain" data-choice="plain">plain images</li><li class="multi-dialog-choice upfront-icon upfront-icon-media-insert-multi-slider" data-choice="slider">image slider</li><li class="multi-dialog-choice upfront-icon upfront-icon-media-insert-multi-gallery" data-choice="gallery">image gallery</li></ul>'),Upfront.Popup.$popup.find("#upfront-popup-content").append(t),t.on("click",".multi-dialog-choice",this,this.select_dialog)},select_dialog:function(t){t.preventDefault(),t.stopPropagation();var n=e("#media-manager-multi-dialog"),r=e(this).attr("data-choice")||"plain",i=t.data;i.model.type=r,n.remove(),Upfront.Popup.close(i.model)}}),R=Backbone.View.extend({className:"upfront-embed_media clearifx",initialize:function(){this.model=new i,this.embed_pane=new U({model:this.model}),this.embed_pane.on("embed:editable:updated",this.embed_updated,this),this.preview_pane=new z({model:this.model})},render:function(){this.embed_pane.render(),this.preview_pane.render(),this.$el.empty().append(this.embed_pane.$el).append(this.preview_pane.$el)},embed_updated:function(){this.preview_pane.render();var e=this;Upfront.Util.post({action:"upfront-media-embed",media:this.model.get("original_url")}).done(function(t){e.model.set(t.data,{silent:!0}),e.preview_pane.trigger("embed:media:imported"),e.embed_pane.render()})}}),U=Backbone.View.extend({className:"upfront-pane",events:{"click button":"save"},initialize:function(){this.editables=_([new et({model:this.model}),new tt({model:this.model}),new nt({model:this.model})])},render:function(){this.$el.empty();var e=this;this.editables.each(function(t){t.render(),t.on("embed:updated",e.editable_updated,e),e.$el.append(t.$el)}),this.$el.append('<button type="button">OK</button>')},editable_updated:function(){this.trigger("embed:editable:updated")},save:function(){this.editables.invoke("update");var e=this,t={action:"upfront-media-update_media_item",data:this.model.toJSON()};Upfront.Util.post(t).done(function(){Upfront.Util.log("successfully saved data"),e.model.trigger("change")})}}),z=Backbone.View.extend({className:"upfront-pane",initialize:function(){this.preview_view=new W({model:this.model}),this.labels_view=new Q({model:this.model}),this.on("embed:media:imported",this.update_media_preview,this)},render:function(){this.preview_view.render(),this.$el.empty().append(this.preview_view.$el)},update_media_preview:function(){this.preview_view.render(),this.labels_view.render(),this.labels_view.delegateEvents();var e=this.preview_view.is_image()?100:33;this.preview_view.set_progress(e)}}),W=Backbone.View.extend({className:"upfront-media_manager-embed-preview",template:_.template('{{thumbnail}} <div class="progress"><div class="bar" /></div>'),render:function(){if(!this.model.get("original_url"))return this.$el.empty();var e=this,t=this.is_image(),n=t?this.model.get("thumbnail"):this.get_media_thumbnail();this.$el.empty().append(this.template({thumbnail:n}))},is_image:function(){return(this.model.get("original_url")||"").match(/\.(jpe?g|gif|png)$/i)},get_media_thumbnail:function(){return this.model.get("thumbnail")},set_progress:function(e){var t=this.$el.find(".progress .bar");t.css("width",e+"%")}}),X=H.extend({className:"upfront-media_manager upfront-media_manager-post_image clearfix",initialize:function(e){var t=t||{};e=new n(e),this.media_collection=e},render:function(){var e=new V({model:this.media_collection}),t=new l({model:this.media_collection}),n=new f({model:this.media_collection});e.multiple_selection=this.multiple_selection,n.render(),t.render(),e.render(),this.$el.empty().append(n.$el).append(t.$el).append(e.$el),this.media_view=e,this.media_view.start_loading()},update:function(e){var t=this;this.media_view.model.reset(e),this.media_view.end_loading(function(){t.media_view.render()})}}),V=Backbone.View.extend({tagName:"ul",className:"upfront-media_collection",initialize:function(){this.model.on("add",this.render,this),this.model.on("remove",this.render,this),this.model.on("change",this.update,this),this.model.on("change:selected",this.propagate_selection,this)},render:function(){var e=this;this.$el.empty(),this.model.length?this.model.each(function(t){var n=new J({model:t});n.parent_view=e,n.render(),e.$el.append(n.$el)}):this.$el.append("&nbsp;")},update:function(){this.model.length&&this.model.each(function(e){e.trigger("appearance:update")})},start_loading:function(){this.loading=new Upfront.Views.Editor.Loading({loading:"Loading media files...",done:"Loaded"}),this.loading.render(),this.$el.append(this.loading.$el)},end_loading:function(e){this.loading&&this.loading.done?this.loading.done(e):e()},propagate_selection:function(e){if(!this.multiple_selection){var t=this.model.where({selected:!0});t.length&&_(t).each(function(e){e.set({selected:!1},{silent:!0}),e.trigger("appearance:update")}),e.set({selected:!0},{silent:!0}),e.trigger("appearance:update")}Upfront.Events.trigger("media:item:selection_changed",this.model)}}),J=Backbone.View.extend({tagName:"li",className:"upfront-media_item",events:{click:"toggle_item_selection"},initialize:function(){this.template=_.template("<div class='thumbnail'>{{thumbnail}}</div> <div class='title'>{{post_title}}</div> <div class='upfront-media_item-editor-container' />"),Upfront.Events.on("media_manager:media:toggle_titles",this.toggle_title,this),this.model.on("appearance:update",this.update,this),this.model.on("upload:start",this.upload_start,this),this.model.on("upload:progress",this.upload_progress,this),this.model.on("upload:finish",this.upload_finish,this)},render:function(){this.$el.empty().append(this.template(this.model.toJSON())),this.update(),this.toggle_title()},update:function(){this.model.get("parent")?this.$el.addClass("has-parent"):this.$el.removeClass("has-parent"),this.model.get("selected")&&!this.$el.hasClass("selected")?(this.$el.addClass("selected"),this.$el.find(".thumbnail").append('<i class="upfront-icon upfront-icon-media-selected"></i>')):this.model.get("selected")||(this.$el.removeClass("selected"),this.$el.find(".upfront-icon-media-selected").remove()),this.$el.find(".title").text(this.model.get("post_title"))},toggle_title:function(){var e=a.showing_titles,t=this.$el.find(".title");e&&!t.is(":visible")?t.show():t.hide()},toggle_item_selection:function(e){e.stopPropagation(),e.preventDefault(),this.model.set({selected:!this.model.get("selected")})},upload_start:function(e){this.parent_view.$el.scrollTop(0),this.$el.find(".thumbnail").append('<div class="upfront-media-progress-bar" />')},upload_progress:function(e){Upfront.Util.log(_.template("{{post.post_title}} progress changed to {{progress}}",{post:this.model.toJSON(),progress:e})),this.$el.find(".upfront-media-progress-bar").css("width",e+"%")},upload_finish:function(){this.$el.find("img").replaceWith(this.model.get("thumbnail")),this.$el.find(".upfront-media-progress-bar").remove(),this.model.set({selected:!0}),Upfront.Events.trigger("media:item:selection_changed",this.model.collection)}}),K=Backbone.View.extend({className:"upfront-media_item-editor",events:{"click button":"save"},initialize:function(e){this.editables=_([new tt({model:this.model})]),e&&e.media&&(this.media=e.media)},render:function(){this.$el.empty();var e=this;this.editables.each(function(t){t.render(),e.$el.append(t.$el)});var t=new Q({model:this.model});t.render(),this.$el.append(t.$el),this.$el.append('<button type="button">OK</button>');if(!this.media)return!0;var n=this.media.type||"application/octet-stream",r=n.match(/^image/i);if(r)return!0;var i=new G({model:this.model,media:this.media});i.render(),this.$el.append(i.$el)},save:function(){this.editables.invoke("update");var e=this,t={action:"upfront-media-update_media_item",data:this.model.toJSON()};Upfront.Util.post(t).done(function(){Upfront.Util.log("successfully saved data"),e.model.trigger("change")})}}),Q=Backbone.View.extend({className:"upfront-media_labels",events:{"click button":"create_label","click a.own_label":"drop_label","click a.all_label":"add_label"},initialize:function(){this.labels=a.get("label"),Upfront.Events.on("media_manager:media:labels_loaded",this.reset_labels,this)},reset_labels:function(){this.labels=a.get("label"),this.render()},render:function(){var e=_.template('<a class="own_label" href="#" data-idx="{{value}}">{{filter}}</a> '),t=_.template('<a class="all_label" href="#" data-idx="{{value}}">{{filter}}</a> '),n=this,r=this.model.get("labels"),i=[],s=[];this.$el.empty(),this.labels&&this.labels.each(function(n){r&&r.length&&r.indexOf(n.get("value"))>=0?i.push(e(n.toJSON())):s.push(t(n.toJSON()))}),n.$el.append("Applied labels: "),_(i).each(function(e){n.$el.append(e)}),this.$el.append('<input type="text" placeholder="label..." /><button type="button">Add</button>'),n.$el.append("All labels: "),_(s).each(function(e){n.$el.append(e)})},create_label:function(e){e.preventDefault(),e.stopPropagation();var t=this.$el.find(":text").val(),n={action:"upfront-media-add_label",term:t,post_id:this.model.get("ID")};Upfront.Util.post(n).success(function(e){Upfront.Events.trigger("media_manager:media:labels_updated")})},add_label:function(e){e.preventDefault(),e.stopPropagation(),this._update_labels(e)},drop_label:function(e){e.preventDefault(),e.stopPropagation(),this._update_labels(e,"dis")},_update_labels:function(t,n){n=n||"",t.preventDefault(),t.stopPropagation();var r=this,i=e(t.target),s=i.attr("data-idx"),o={action:"upfront-media-"+n+"associate_label",term:s,post_id:this.model.get("ID")};Upfront.Util.post(o).success(function(e){var t=r.model.get("ID"),n=e.data||{},i=n[t]||n;r.model.set("labels",i,{silent:!0}),r.render()})}}),G=Backbone.View.extend({className:"upload_type-nag",events:{"click .keep":"keep_file","click .remove":"remove_file"},render:function(){console.log("rendering"),this.$el.empty().append("We recommend using services like YouTube, Vimeo or Soundcloud to store rich media files. You can then embed it easily into your site. Find out more here.").append('<a href="#" class="button keep">Keep file</a>').append('<a href="#" class="button remove">Remove file</a>')},keep_file:function(e){e.preventDefault(),e.stopPropagation()},remove_file:function(e){e.preventDefault(),e.stopPropagation(),this.model.trigger("upload:abort")}}),Y=Backbone.View.extend({className:"upfront-media_item-editable",events:{change:"update"},template:_.template("<label>{{label}}<input type='text' name='{{name}}' value='{{value}}' placeholder='{{placeholder}}' /></label>"),get_name:function(){},get_label:function(){},get_placeholder:function(){},get_value:function(){return this.$el.find('[name="'+this.get_name()+'"]:first').val()},render:function(){var e=this.get_name()||"",t=this.get_label()||"",n=this.get_placeholder()||"",r=this.model.get(this.get_name())||"",i={name:e,label:t,placeholder:n,value:r};this.$el.empty().append(this.template(i))},update:function(){var e={};e[this.get_name()]=this.get_value(),this.model.set(e,{silent:!0})}}),Z=Y.extend({update:function(){var e={};e[this.get_name()]=this.get_value(),this.model.set(e,{silent:!0}),this.trigger("embed:updated")}}),et=Z.extend({get_name:function(){return"original_url"},get_label:function(){return"URL of the media"},get_placeholder:function(){return"http://sample.com/path-to-image/image.jpg"}}),tt=Y.extend({get_name:function(){return"post_title"},get_label:function(){return"Image Title"},get_placeholder:function(){return"Your image title"}}),nt=Y.extend({get_label:function(){return"Labels"},render:function(){var e=new r([this.model]),t=new d({model:e});t.render(),e.on("change",t.render_labels,t),this.$el.empty().append("<label>"+this.get_label()+"</label>").append(t.$el)}}),rt=Backbone.View.extend({initialize:function(){Upfront.Events.on("upfront:editor:init",this.rebind_ckeditor_image,this)},open:function(e){e=_.extend({media_type:["images"],multiple_selection:!0,button_text:"Ok",ck_insert:!1},e);var t=this,n=!1,r=e.media_type,i=e.multiple_selection,s=e.button_text;return a.allowed_media_types=r,n=Upfront.Popup.open(function(n,r,i){t.out=this,t.popup_data=n,t.popup_data.$top=r,t.popup_data.$bottom=i,t.load(e)},{width:800}),n.always(this.cleanup_active_filters),Upfront.Events.trigger("upfront:element:edit:start","media-upload"),n},cleanup_active_filters:function(){a.allowed_media_types=[]},ck_open:function(){var e=this.open({button_text:"Insert image(s)",ck_insert:!0});return Upfront.Media.Manager.instance=CKEDITOR.currentInstance.name,e.always(this.on_close),!1},load:function(e){var t=new H(_.extend({el:this.out,data:this.popup_data},e));return t.render(),!1},on_close:function(e,t){var n=Upfront.Media.Manager.results_html(t),r=CKEDITOR.instances[Upfront.Media.Manager.instance];if(r&&t){var i=r.getSelection(),s=i.getStartElement();if(CKEDITOR.tools.trim(s.getText())!=""){var o=new CKEDITOR.dom.element("p"),u=r.createRange();o.appendHtml("<br/>"),o.insertBefore(s),u.moveToElementEditablePosition(o,!0),r.getSelection().selectRanges([u])}r.insertHtml(n)}Upfront.Events.trigger("upfront:element:edit:stop")},results_html:function(e){var n="";return e&&e.each&&e.each(function(r){var i=r.toJSON(),s=r.get("selected_size")||t.FULL,o=r.get("additional_sizes");s&&"full"!=s&&_(o).each(function(e){if(t.to_size(e)!=s)return!0;i.image=e}),e.type=="gallery"&&(i.link={href:"#","class":"popup"}),i.type=e.type,n+=_.template(i.link?Upfront.Media.Templates.image_link:Upfront.Media.Templates.image,i)}),e&&e.length&&e.length>1&&(e.type=="plain"?n=_.template(Upfront.Media.Templates.multiple,{content:n}):e.type=="gallery"?n=_.template(Upfront.Media.Templates.gallery,{content:n}):e.type=="slider"&&(n=_.template(Upfront.Media.Templates.slider,{content:n}))),n},rebind_ckeditor_image:function(){var e=this;_(CKEDITOR.instances).each(function(t){var n=t.getCommand("image");n&&n.on&&n.on("exec",e.ck_open,e)})}});Upfront.Media={Manager:new rt,Templates:{image:'<p class="upfront-inserted_image-wrapper upfront-inserted_image-{{type}}"><img src="{{image.src}}" title="{{post_title}}" alt="{{post_title}}" height="{{image.height}}" width="{{image.width}}" /></p>',image_link:'<p class="upfront-inserted_image-wrapper upfront-inserted_image-{{type}}"><a href="{{link.href}}" class="{{link.class}}"><img src="{{image.src}}" title="{{post_title}}" alt="{{post_title}}" height="{{image.height}}" width="{{image.width}}" /></a></p>',embeddable:"<div>{{post_content}}<br />{{post_title}}</div>",gallery:"[upfront-gallery]{{content}}[/upfront-gallery]",slider:"[upfront-slider]{{content}}[/upfront-slider]",multiple:"{{content}}"},Transformations:{_transformations:_([]),add:function(e){this._transformations.push(e)},apply:function(e){return this._transformations.each(function(t){e=t.apply(this,[e])}),e}}}})}(jQuery),function(e,t){define("content",[],function(){var t=Backbone.View.extend({initialize:function(e){console.log("SimpleEditor Deprecated")},start:function(){console.log("SimpleEditor Deprecated")},stop:function(){console.log("SimpleEditor Deprecated")}}),n=Backbone.View.extend({post:!1,postId:!1,loadingPost:!1,isNew:!1,mode:"post_excerpt",view:!1,bar:!1,backup:!1,changed:{title:!1,thumb:!1,content:!1},events:{"keydown .ueditor_title":"goToEditor","dblclick .ueditor_content":"editContent","click .upost_thumbnail_changer":"editThumb","click .ueditor_restore":"restore","click .ueditor_date":"editDate","click .ueditor-action-pickercancel":"cancelDatepicker","click .ueditor-action-pickerok":"changeDate","click .ueditor_author":"editAuthor"},initialize:function(t){this.postId=t.post_id,this.setElement(t.node),this.autostart=t.autostart||!1,Upfront.data.posts[this.postId]&&(this.post=Upfront.data.posts[this.postId],this.loadingPost=new e.Deferred,this.loadingPost.resolve(this.post),this.bindPostEvents()),t.preload&&this.getPost(),typeof t.content_mode!="undefined"&&(this.mode=t.content_mode),this.datepickerTpl=_.template(e(Upfront.data.tpls.popup).find("#datepicker-tpl").html()),this.initEditAreas(),this.backup=this.$el.html()},bindPostEvents:function(){this.post.on("editor:cancel",this.cancelChanges,this),this.post.on("editor:publish",this.publish,this),this.post.on("editor:draft",this.saveDraft,this),this.post.on("editor:trash",this.trash,this)},updateElement:function(e){this.setElement(e),this.initEditAreas(),this.cke&&this.cke.destroy&&(this.cke.destroy(),this.cke=!1),this.bar&&(this.bar=!1),this.backup=this.$el.html()},initEditAreas:function(){var e=this,t=Upfront.data.ueditor.selectors;_.each(t,function(t){var n=t.type,r=t.selector;n=="content"||n=="excerpt"?e.prepareContentEditor(r):n=="title"?e.prepareTitleEditor(r):n=="thumbnail"?e.prepareThumbEditor(r):n=="date"?e.prepareDateEditor(r):n=="author"&&e.prepareAuthorEditor(r)});var n=this.$el.closest(".ui-draggable"),r=n.draggable("option","cancel");_.isString(r)&&r.indexOf(".ueditable")==-1&&(n.draggable("option","cancel",r+",.ueditable"),console.log("Editable areas no draggable anymore."))},fetchPost:function(){var t=this;return this.post=new Upfront.Models.Post({ID:this.postId}),this.bindPostEvents(),this.loadingPost=new e.Deferred,this.post.fetch({withMeta:!0,filterContent:!0}).done(function(e){Upfront.data.posts||(Upfront.data.posts={}),Upfront.data.posts[t.postId]=t.post,t.loadingPost.resolve(t.post)}),this.loadingPost.promise()},getPost:function(){return this.post||this.loadingPost?this.loadingPost.promise():this.fetchPost()},prepareContentEditor:function(e){this.$(e).addClass("ueditor_content ueditable"),console.log("Content editor prepared.")},prepareTitleEditor:function(e){var t=this,n=this.$(e);n.on("start",function(){t.changed.title=n,t.getPost().done(function(e){t.prepareBar()}),setTimeout(function(){n.ueditor("selectionAll")},200)}).ueditor({airButtons:{},observeLinks:!1,autostart:this.autostart,tabFocus:!1,placeholder:"Write a title..."})},prepareThumbEditor:function(e){this.$(e).addClass("ueditor_thumb ueditable").css({position:"relative","min-height":"60px","margin-bottom":"30px"}).append('<div class="upost_thumbnail_changer">Click to edit the post\'s featured image</div>').find("img").css({"z-index":"2",position:"relative"})},prepareDateEditor:function(e){var t=this,n={};if(this.$(e).find(".upfront-bar-datepicker").length)return;n.minutes=_.range(0,60),n.hours=_.range(0,24),n.currentHour=1,n.currentMinute=1,this.$(e).addClass("ueditor_date ueditable").append(t.datepickerTpl(n)).find(".upfront-bar-datepicker").datepicker({changeMonth:!0,changeYear:!0,dateFormat:"yy-mm-dd",onChangeMonthYear:function(e,n){var r=t.$(".upfront-bar-datepicker"),i=r.datepicker("getDate").getDate();i=i<10?"0"+i:i,n=n<10?"0"+n:n,t.$(".upfront-bar-datepicker").datepicker("setDate",e+"-"+n+"-"+i)}})},prepareAuthorEditor:function(e){if(this.$(e).find(".ueditor-select").length)return;var t=this,n=Upfront.data.ueditor.authors,r=[];_.each(n,function(e){r.push({value:e.ID,name:e.display_name})}),this.authorSelect=new o({options:r}),this.authorSelect.on("select",function(e){t.changeAuthor(e)}),this.$(e).addClass("ueditor_author ueditable").append(this.authorSelect.$el)},prepareBar:function(){if(this.bar){this.bar.calculateLimits();return}this.bar=new r({post:this.post}),this.bar.render(),this.$el.append(this.bar.$el),this.bar.stick();return},editTitle:function(t){var n=this,r=function(e){var t=window.getComputedStyle?window.getComputedStyle(e[0]):e[0].currentStyle,n=!window.getComputedStyle;if(!t)return!1;e.children().css({background:"transparent",border:0,"font-weight":t[i("font-weight",n)],"font-size":t[i("font-size",n)],"font-family":t[i("font-family",n)],"text-transform":t[i("text-transform",n)],"text-decoration":t[i("text-decoration",n)],"text-align":t[i("text-align",n)],color:t.color,outline:0,margin:0,padding:0})},i=function(e,t){return t?e.replace(/-([a-z])/g,function(e){return e[1].toUpperCase()}):e},s=this.$(".ueditor_title"),o=e.trim(s.text());this.getPost().done(function(e){n.prepareBar(),!n.cke&&n.mode=="post_content"&&n.editPost(".ueditor_content","post_content",!1)}),s.html(this.post&&this.post.is_new?'<input type="text" id="upfront-title" style="width:100%" value="" placeholder="'+o+'"/>':'<input type="text" id="upfront-title" style="width:100%" value="'+o+'"/>'),r(s),s.find("input").focus().val(o);if(this.post&&this.post.is_new){var u=_.find(Upfront.data.ueditor.selectors,function(e){return e.type=="title"}).selector;this.$el.find(u+".ueditable").ueditor("focus")}},goToEditor:function(e){if(e.which==9||e.which==13)e.preventDefault(),this.cke?this.cke.focus():this.editPost(".ueditor_content",this.mode,!0)},editThumb:function(t){var n=this,r=e(t.target),i=this.postId,s=r.parent().find("img"),o=new Upfront.Views.Editor.Loading({loading:"Starting image editor ...",done:"Here we are!",fixed:!1});this.getPost().done(function(e){n.prepareBar()}),s.length?(o.render(),r.parent().append(o.$el),this.getPost().done(function(e){n.getImageInfo(n.post).done(function(e){o.$el.remove(),n.openImageEditor(!1,e,i)})})):n.openImageSelector(i)},openImageSelector:function(t){var n=this;Upfront.Views.Editor.ImageSelector.open().done(function(r){var i={},s=0;_.each(r,function(e,t){i=e,s=t});var o={src:i.medium?i.medium[0]:i.full[0],srcFull:i.full[0],srcOriginal:i.full[0],fullSize:{width:i.full[1],height:i.full[2]},size:i.medium?{width:i.medium[1],height:i.medium[2]}:{width:i.full[1],height:i.full[2]},position:!1,rotation:0,id:s};e("<img>").attr("src",o.srcFull).load(function(){Upfront.Views.Editor.ImageSelector.close(),n.openImageEditor(!0,o,t)})})},getImageInfo:function(t){var n=this,r=t.meta.get("_thumbnail_data"),i=t.meta.get("_thumbnail_id"),s=e.Deferred(),o=this.$(".ueditor_thumb").find("img");if(!r||!_.isObject(r.get("meta_value"))||r.get("meta_value").imageId!=i.get("meta_value")){if(!i)return!1;Upfront.Views.Editor.ImageEditor.getImageData([i.get("meta_value")]).done(function(e){var t=e.data.images,n={},r=0;_.each(t,function(e,t){n=e,r=t}),s.resolve({src:n.medium?n.medium[0]:n.full[0],srcFull:n.full[0],srcOriginal:n.full[0],fullSize:{width:n.full[1],height:n.full[2]},size:{width:o.width(),height:o.height()},position:{top:0,left:0},rotation:0,id:r})})}else{var u=r.get("meta_value"),a=o.width()/u.cropSize.width;s.resolve({src:u.src,srcFull:u.srcFull,srcOriginal:u.srcOriginal,fullSize:u.fullSize,size:{width:u.imageSize.width*a,height:u.imageSize.height*a},position:{top:u.imageOffset.top*a,left:u.imageOffset.left*a},rotation:u.rotation,id:u.imageId})}return s.promise()},openImageEditor:function(t,n,r){var i=this,s=this.$(".ueditor_thumb"),o=Upfront.data&&Upfront.data.uposts&&Upfront.data.uposts.featured_image_height?Upfront.data.uposts.featured_image_height:300,u=_.extend({},n,{maskOffset:s.offset(),maskSize:{width:s.width(),height:o},setImageSize:t,extraButtons:[{id:"image-edit-button-swap",text:"Swap Image",callback:function(e,t){t.cancel(),i.openImageSelector(r)}}]});Upfront.Views.Editor.ImageEditor.open(u).done(function(t){var n=i.post,r=s.find("img");i.post.meta.add([{meta_key:"_thumbnail_id",meta_value:t.imageId},{meta_key:"_thumbnail_data",meta_value:t}],{merge:!0}),r.length||(r=e('<img style="z-index:2;position:relative">').appendTo(s)),r.attr("src",t.src),i.changed.thumb=!0})},editContent:function(e){e.preventDefault(),e.stopPropagation(),this.editPost(".ueditor_content",this.mode,!0)},editExcerpt:function(e){e.preventDefault(),e.stopPropagation(),this.editPost(".ueditor_excerpt","post_excerpt",!0)},editPost:function(e,t,n){var r=this,i=this.$(e);if(!i.length||i.data("ueditor"))return;var s=window.getSelection?_.clone(window.getSelection()):!1;i.css("opacity",".6"),this.getPost().done(function(e){r.prepareBar();var o=e.get(t);!o&&t=="post_excerpt"&&(confirm("This post has no excerpt, and what you could see before editing was the first words of the post content. Do you want to convert that words in the excerpt and edit the excerpt? Otherwise you will edit the post contents.")?e.set("post_excerpt",i.html()):t="post_content"),i.html(e.get(t)).on("start",function(){console.log(s),i.css("opacity","1"),i.mode=t,r.changed.content=i,r.prepareBar()}).ueditor({linebreaks:!1,placeholder:"Your content goes here ;)",focus:n,upfrontMedia:t=="post_content",upfrontImages:t=="post_content"})})},positionEditor:function(t){var n=this.cke.createRange(),r=t.focusNode,i=r.nodeName,s=e(this.cke.element.$);while(i=="#text")r=r.parentNode,i=r.nodeName;var o=s.find(i+":contains("+r.textContent+")"),u=!1;o.length&&(u=o[0])},editDate:function(e){if(this.$(".upfront-date_picker").is(":visible"))return;this.$(".upfront-date_picker").hide();var t=this,n=t.$(".ueditor_date").find(".upfront-date_picker"),r=new Upfront.Views.Editor.Loading({loading:"Loading...",done:"Here we are!",fixed:!1});r.render(),n.show().append(r.$el),this.getPost().done(function(e){var t=e.toJSON().post_date,i=t?t.split(" ")[0]:!1;r.$el.remove(),n.find(".upfront-bar-datepicker").datepicker("setDate",i),i=e.get("post_date");var s=i.getHours(),o=i.getMinutes();n.find(".ueditor-hours-select").val(s),n.find(".ueditor-minutes-select").val(o)})},cancelDatepicker:function(e){e.preventDefault(),e.stopPropagation(),this.$(".upfront-date_picker").hide()},changeDate:function(e){e.preventDefault(),e.stopPropagation();var t=this.$(".upfront-bar-datepicker").datepicker("getDate"),n=new Date;t.setHours(this.$(".ueditor-hours-select").val()),t.setMinutes(this.$(".ueditor-minutes-select").val()),this.post.set("post_date",t),n.getTime()<t.getTime()?this.post.set("post_status","future"):this.post.set("post_status","publish"),this.$(".upfront-date_picker").hide();var r=this.formatDate(t,Upfront.data.ueditor.filters.date);this.$(".ueditor_date").html(r),this.prepareDateEditor(".ueditor_date"),this.bar?this.bar.render():this.prepareBar()},formatDate:function(e,t){var n=Upfront.data.ueditor,r=e.getFullYear(),i=e.getMonth(),s=e.getDate(),o=e.getHours(),u=e.getMinutes(),a=e.getSeconds(),f=e.getMilliseconds(),l=n.months[i],c=n.days[e.getDay()],h=o%12,p={year:r,shortyear:r%100,shortmonth:i,month:i<10?"0"+i:i,shortday:s,day:s<10?"0"+s:s,shorthours:o,hours:o<10?"0"+o:o,shortminutes:u,minutes:u<10?"0"+u:u,shortseconds:a,seconds:a<10?"0"+a:a,shortmili:f,mili:f<10?"00"+f:f<100?"0"+f:f,tmonth:l,tshortmonth:l.substring(0,3),tday:c,tshortday:c.substring(0,3),shorthours12:h,hours12:h<10?"0"+h:h,am:o<12?"am":"pm",pm:o<12?"am":"pm",date:Upfront.Util.format_date(e)},d=t;return _.each(p,function(e,t){var n=new RegExp("%"+t+"%","g");d=d.replace(n,e)}),d},editAuthor:function(e){e.preventDefault(),this.getPost(),this.authorSelect.open()},formatAuthor:function(e){var t=Upfront.data.ueditor.filters.author,n=_.keys(e);return _.each(n,function(n){var r=new RegExp("%"+n+"%","g");t=t.replace(r,e[n])}),t},changeAuthor:function(e){var t=this;this.getPost().done(function(n){var r=t.getAuthorData(e);t.post.set("post_author",e),t.bar?t.bar.render():t.prepareBar(),t.$(".ueditor_author").html(t.formatAuthor(r)),t.prepareAuthorEditor(".ueditor_author"),console.log("Author changed to "+e)})},getAuthorData:function(e){var t=-1,n=!1,r=Upfront.data.ueditor.authors;while(++t<r.length&&!n)r[t].ID==e&&(n=r[t]);return n},cancelChanges:function(){this.fetchPost(),this.$el.html(this.backup),this.bar=!1,this.cke&&this.cke.destroy&&(this.cke.destroy(),this.cke=!1),this.post&&this.post.get&&(this.post.get("post_status")=="auto-draft"?window.location.reload():Upfront.Settings.Application.MODE.ALLOW.indexOf(Upfront.Settings.Application.MODE.LAYOUT)==-1?confirm("Do you want to re-load in layout mode?")||(window.location=Upfront.Settings.Content.edit.post+this.post.id):Upfront.Application.start(Upfront.Settings.Application.MODE.LAYOUT))},save:function(t,n,r){var i=this,s=this.changed,o=s.thumb,u=!o,a=new Upfront.Views.Editor.Loading({loading:n,done:"Here we are!",fixed:!1}),f=!1;a.render(),this.$el.append(a.$el),s.title&&this.post.set("post_title",e.trim(s.title.text())),s.content&&this.post.set(s.content.mode,s.content.html()),this.post.set("post_status",t),this.post.save().done(function(){u&&(a.$el.remove(),Upfront.Views.Editor.notify(r),i.options.onUpdated&&i.options.onUpdated(i.post.toJSON())),f=!0}),o&&i.post.meta.save().done(function(){f&&(a.done(),Upfront.Views.Editor.notify(r),i.options.onUpdated&&i.options.onUpdated(i.post.toJSON())),u=!0})},publish:function(){this.save("publish","Publishing "+this.post.get("post_type")+" ...",this.capitalize(this.post.get("post_type"))+" published")},saveDraft:function(){this.save("draft","Saving "+this.post.get("post_type")+" ...",this.capitalize(this.post.get("post_type"))+" saved as a draft")},capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},trash:function(){var e=this,t=this.post.get("post_type"),n=new Upfront.Views.Editor.Loading({loading:"Deleting "+t+" ...",done:"Here we are!",fixed:!1});n.render(),this.$el.append(n.$el),this.post.set("post_status","trash").save().done(function(){n.$el.remove(),Upfront.Views.Editor.notify("The "+t+" has been deleted."),e.options.onUpdated&&e.options.onUpdated(e.post.toJSON())})},restore:function(){var e=this;confirm("Are you sure to restore this "+this.post.get("post_type")+"?")&&this.post.set("post_status","draft").save().done(function(){e.options.onUpdated&&e.options.onUpdated(e.post.toJSON())})}}),r=Backbone.View.extend({className:"ueditor-bar-wrapper upfront-ui",post:!1,offset:{min:0,max:0},position:{min:0,max:0},onScrollFunction:!1,statusOptions:{future:{value:"future",name:"Scheduled"},publish:{value:"publish",name:"Published"},pending:{value:"pending",name:"Pending Review"},draft:{value:"draft",name:"Draft"},"private":{value:"private",name:"Privately Published"},"auto-draft":{value:"auto-draft",name:"New"},trash:{value:"trash",name:"Deleted"}},visibilityOptions:{"public":{value:"public",name:"Public"},sticky:{value:"sticky",name:"Sticky"},password:{value:"password",name:"Protected"},"private":{value:"private",name:"Private"}},statusSelect:!1,visibilitySelect:!1,initialStatus:!1,events:{"click .ueditor-action-cancel":"cancel","click .ueditor-action-publish":"publish","click .ueditor-action-draft":"saveDraft","click .ueditor-action-trash":"trash","click .ueditor-action-url":"editUrl","click .ueditor-action-tags":"editTaxonomies","click .ueditor-select-value":"editSelect","click .ueditor-pass-ok":"changePass","click .ueditor-action-schedule":"openDatepicker","click .ueditor-bar-show_advanced":"toggleAdvanced"},initialize:function(t){var n=this;this.post=t.post,this.initialStatus=this.post.get("post_status"),this.initialDate=this.post.get("post_date"),this.initialDate&&(this.initialDate=this.initialDate.getTime()),this.tpl=_.template(Upfront.data.uposts.barTemplate),this.datepickerTpl=_.template(e(Upfront.data.tpls.popup).find("#datepicker-tpl").html()),Upfront.Events.trigger("upfront:element:edit:start","write",this.post)},render:function(){this.destroy();var t=this,n=this.post.toJSON(),r=this.post.get("post_date"),i={};n.status=this.getBarStatus(),n.visibility=this.visibilityOptions[this.post.getVisibility()],n.schedule=this.getSchedule(),n.buttonText=this.getButtonText(),n.draftButton=["publish","future"].indexOf(this.initialStatus)==-1,n.cancelButton=!this.post.is_new,n.cid=this.cid,i.minutes=_.range(0,60),i.hours=_.range(0,24),i.currentHour=r.getHours(),i.currentMinute=r.getHours(),n.datepicker=this.datepickerTpl(i),this.$el.html(this.tpl(n)),this.$(".upfront-bar-datepicker").datepicker({changeMonth:!0,changeYear:!0,dateFormat:"yy-mm-dd",onChangeMonthYear:function(e,n){var r=t.$(".upfront-bar-datepicker"),i=r.datepicker("getDate").getDate();i=i<10?"0"+i:i,e=e<10?"0"+e:e,t.$(".upfront-bar-datepicker").datepicker("setDate",n+"-"+e+"-"+i)}}),this.prepareSelectBoxes(),e("#ui-datepicker-div").addClass("upfront-date_picker upfront-ui"),e("#"+this.cid).length&&this.stick()},prepareSelectBoxes:function(){var e=this;this.statusSelect=new o({options:this.getStatusOptions()}),this.visibilitySelect=new o({options:this.getVisibilityOptions()}),this.statusSelect.on("select",function(t){e.post.set("post_status",t),e.render()}),this.visibilitySelect.on("select",function(t){t=="password"?e.showPassEditor(e.$(".ueditor-select-visibility")):(e.post.setVisibility(t),e.render())}),this.$(".ueditor-select-visibility").append(this.visibilitySelect.$el),this.$(".ueditor-select-status").append(this.statusSelect.$el)},getBarStatus:function(){var e=this.post.get("post_status");return["auto-draft","draft","pending"].indexOf(e)!=-1?this.statusOptions[e]:this.statusOptions[this.initialStatus]},getSchedule:function(){var e=new Date,t=this.post.get("post_date"),n=Upfront.Util.format_date;return!t&&!this.initialDate?{key:"Publish",text:"Inmediately"}:t.getTime()==this.initialDate?t.getTime()<e.getTime()?{key:"Published",text:n(t,!0)}:{key:"Scheduled",text:n(t,!0)}:t.getTime()<e.getTime()?{key:"Publish on",text:n(t,!0)}:{key:"Schedule",text:n(t,!0)}},openDatepicker:function(e){var t=this.post.toJSON().post_date,n=t?t.split(" ")[0]:!1;this.$(".upfront-date_picker").toggle();if(n){this.$(".upfront-bar-datepicker").datepicker("setDate",n),n=this.post.get("post_date");var r=n.getHours(),i=n.getMinutes();this.$(".ueditor-hours-select").val(r),this.$(".ueditor-minutes-select").val(i)}},getStatusOptions:function(e){var t=[],n=this.initialStatus;return n=="publish"?t.push(this.statusOptions.publish):n=="future"&&t.push(this.statusOptions.future),t.push(this.statusOptions.pending),t.push(this.statusOptions.draft),n=="private"&&(t=[this.statusOptions.private]),t},getVisibilityOptions:function(){var e=this.post.getVisibility(),t=this.visibilityOptions;return e=="password"?[{value:"password",name:"Edit password..."},t.public,t.sticky,t.private]:_.values(t)},getButtonText:function(){var e=this.initialStatus,t=this.post.get("post_date"),n=new Date;return t=t?t.getTime():0,n=n.getTime(),n<t?e=="future"?"Update":"Schedule":e=="publish"?"Update":"Publish"},calculateLimits:function(){var e=this.$(".ueditor-bar-ph"),t=this.$el.parent();if(!t.length)return!1;e.css("position","static"),this.offset={min:t.offset().top+100,max:e.offset().top+e.height()},this.position={min:this.offset.min-t.offset().top,max:e.position().top}},onScroll:function(t,n){var r=this,i=e(window).scrollTop()+e(window).height(),s=n.css("position");s=="fixed"?i<=r.offset.min?(n.css({position:"absolute",bottom:"auto",top:r.position.min+"px",left:0,width:"100%",opacity:1}).removeClass("floating"),r.calculateLimits()):i>=r.offset.max&&(n.css({position:"absolute",bottom:"auto",top:r.position.max+"px",left:0,width:"100%",opacity:1}).removeClass("floating"),r.calculateLimits()):s=="absolute"&&i<r.offset.max&&i>r.offset.min&&(n.css({position:"fixed",bottom:"0px",left:n.offset().left+"px",top:"auto",width:n.outerWidth()+"px",opacity:.4}).addClass("floating").removeClass("show-advanced"),r.calculateLimits())},stick:function(){var t=this.$(".ueditor-bar-ph"),n=this.$(".ueditor-bar"),r=this.$el.parent(),i=this;t.height(n.height()),r.css("position","relative"),n.css({position:"absolute",bottom:"0",left:"0",width:"100%"}),this.calculateLimits(),this.onScrollFunction=function(e){i.onScroll(e,n)},e(window).on("scroll",this.onScrollFunction),this.onScroll(null,n)},destroy:function(){e(window).off("scroll",this.onScrollFunction),this.onScrollFunction=!1},cancel:function(e){e.preventDefault(),confirm("Are you sure to discard the changes made to "+this.post.get("post_title")+"?")&&(this.destroy(),this.post.trigger("editor:cancel"),Upfront.Events.trigger("upfront:element:edit:stop","write",this.post))},publish:function(e){e.preventDefault(),this.destroy(),this.initialStatus=this.post.get("post_status"),this.initialDate=this.post.get("post_date").getTime(),this.post.trigger("editor:publish"),Upfront.Events.trigger("upfront:element:edit:stop","write",this.post)},saveDraft:function(e){e.preventDefault(),this.destroy(),this.initialStatus=this.post.get("post_status"),this.initialDate=this.post.get("post_date").getTime(),this.post.trigger("editor:draft"),Upfront.Events.trigger("upfront:element:edit:stop","write",this.post)},trash:function(e){e.preventDefault(),confirm("Are you sure you want to delete this "+this.post.get("post_type")+"?")&&(this.destroy(),this.post.trigger("editor:trash"),Upfront.Events.trigger("upfront:element:edit:stop","write",this.post))},editUrl:function(t){t.preventDefault();var n=this,r={},i=Upfront.Popup.open(function(t,n,i){var s=e(this);s.empty().append('<p class="upfront-popup-placeholder">No such thing as <q>too many drinks</q>.</p>'),r={top:n,content:s,bottom:i}}),s=function(e){n.post.set("post_name",e),Upfront.Popup.close()},o=_.template(e(Upfront.data.tpls.popup).find("#upfront-slug-tpl").html());r.content.html(o({rootURL:window.location.origin+"/",slug:n.post.get("post_name")})),r.content.off("click","#upfront-post_slug-send").on("click","#upfront-post_slug-send",function(){s(e("#upfront-post_slug").val())}).off("keydown","#upfront-post_slug").on("keydown","#upfront-post_slug",function(t){t.which==13&&(t.preventDefault(),s(e("#upfront-post_slug").attr("disabled",!0).val()))})},editTaxonomies:function(t){t&&t.preventDefault();var n=this,r=e("body").append('<div id="upfront-post_taxonomies" style="display:none" />'),o=e("#upfront-post_taxonomies"),u={},a={category:!1,post_tag:!1},f="category",l={},c=Upfront.Popup.open(function(t,n,r){var i=e(this);i.empty().append('<p class="upfront-popup-placeholder"><q>I enjoy eating cheese.</q></p>').append(o),u={top:n,content:i,bottom:r}}),h=function(t){var r=e(t),o=r.attr("data-type"),c=r.attr("rel"),h=l[o]?l[o]:!1;return u.top.find(".upfront-tabs li").removeClass("active"),r.addClass("active"),f=o,a[o]?p(a[o]):(h||(h=new Upfront.Collections.TermList([],{postId:n.post.id,taxonomy:o}),l[o]=h),u.content.html('<p class="upfront-popup-placeholder"><q>Them frogs chirp really loud today.</q></p>'),h.fetch({allTerms:!0}).done(function(e){var t=e.data.taxonomy.hierarchical?i:s,n=new t({collection:h});n.allTerms=new Upfront.Collections.TermList(e.data.allTerms),a[o]=n,p()}),!1)},p=function(e){var t=a[f];t.render(),u.content.html(t.$el),t.setElement(t.$el)};e(".upfront-popup-placeholder").remove(),u.top.html('<ul class="upfront-tabs"><li data-type="category">Categories</li><li data-type="post_tag">Tags</li></ul>'+u.top.html()),u.top.find(".upfront-tabs li").on("click",function(){h(this)}),o.show(),h(u.top.find(".upfront-tabs li:first")),Upfront.Events.on("upfront:post:taxonomy_changed",function(){h(u.top.find(".upfront-tabs li.active"))})},editSelect:function(t){t.preventDefault();var n=e(t.target).data("id");this[n+"Select"].open()},showPassEditor:function(e){var t=this.visibilityOptions.password,n=this;e.find(".ueditor-select-value").data("id",t.value).text(t.name),e.find(".ueditor-select-options").hide(),e.find(".ueditor-pass-editor").show().find("input").one("blur",function(e){setTimeout(function(){n.render()},300)}).off("keydown").on("keydown",function(e){e.which==13&&n.changePass(e)}).focus()},changePass:function(t){var n=e(t.target).parent().find("input").val();n&&(this.post.setVisibility("password"),this.post.set("post_password",n),this.render())},toggleAdvanced:function(t){t.preventDefault(),e(t.target).closest(".ueditor-bar").toggleClass("show-advanced")}}),i=Backbone.View.extend({className:"upfront-taxonomy-hierarchical",events:{"click #upfront-add_term":"handle_new_term","keydown #upfront-add_term":"handle_enter_new_term","change .upfront-taxonomy_item":"handle_terms_update","keydown #upfront-new_term":"handle_enter_new_term"},termListTpl:!1,termSingleTpl:!1,updateTimer:!1,allTerms:!1,initialize:function(t){this.termListTpl=_.template(e(Upfront.data.tpls.popup).find("#upfront-term-list-tpl").html()),this.termSingleTpl=_.template(e(Upfront.data.tpls.popup).find("#upfront-term-single-tpl").html())},render:function(){this.$el.html(this.termListTpl({allTerms:this.allTerms,postTerms:this.collection,termTemplate:this.termSingleTpl,labels:this.collection.taxonomyObject.labels}))},handle_new_term:function(){var t=this,n=this.$el.find("#upfront-new_term").val(),r,i;if(!n)return!1;e("#upfront-taxonomy-parents").length&&(r=e("#upfront-taxonomy-parents").val()),i=new Upfront.Models.Term({taxonomy:this.collection.taxonomy,name:n,parent:r}),i.save().done(function(e){t.allTerms.add(i),t.collection.add(i).save(),t.render()})},handle_terms_update:function(t){var n=this,r=e(t.target),i=r.val();r.is(":checked")?this.collection.add(this.allTerms.get(i)):this.collection.remove(this.allTerms.get(i)),clearTimeout(this.updateTimer),this.updateTimer=setTimeout(function(){n.collection.save()},2e3)},handle_enter_new_term:function(e){e.which==13&&this.handle_new_term(e)}}),s=Backbone.View.extend({className:"upfront-taxonomy-flat",termListTpl:!1,termSingleTpl:!1,changed:!1,updateTimer:!1,events:{"click #upfront-add_term":"handle_new_term","click .upfront-taxonomy_item-flat":"handle_term_click","keydown #upfront-add_term":"handle_enter_new_term","keydown #upfront-new_term":"handle_enter_new_term"},initialize:function(t){this.collection.on("add remove",this.render,this),this.termListTpl=_.template(e(Upfront.data.tpls.popup).find("#upfront-flat-term-list-tpl").html()),this.termSingleTpl=_.template(e(Upfront.data.tpls.popup).find("#upfront-term-flat-single-tpl").html())},render:function(){var e=this,t=[],n=[];this.allTerms.each(function(r,i){r.children=[],e.collection.get(r.get("term_id"))?t.push(r):n.push(r)}),this.$el.html(this.termListTpl({currentTerms:t,otherTerms:n,termTemplate:this.termSingleTpl,labels:this.collection.taxonomyObject.labels}))},handle_term_click:function(t){var n=this,r=e(t.currentTarget),i=r.attr("data-term_id");r.parent().attr("id")=="upfront-taxonomy-list-current"?this.collection.remove(i):this.collection.add(this.allTerms.get(i)),clearTimeout(this.updateTimer),this.updateTimer=setTimeout(function(){n.collection.save()},2e3)},handle_new_term:function(e){var t=this,n=this.$el.find("#upfront-new_term").val(),r;e.preventDefault();if(!n)return!1;r=new Upfront.Models.Term({taxonomy:this.collection.taxonomy,name:n}),r.save().done(function(e){t.allTerms.add(r),t.collection.add(r).save()})},handle_enter_new_term:function(e){e.which==13&&this.handle_new_term(e)}}),o=Backbone.View.extend({tpl:!1,className:"ueditor-select ueditor-popup upfront-ui",events:{"blur input":"close","click .ueditor-select-option":"select"},initialize:function(e){this.opts=e.options,this.render()},render:function(){this.tpl||(this.tpl=this.getTpl()),this.tpl&&this.$el.html(this.tpl({options:this.opts}))},open:function(){var t=this;this.tpl||this.render(),this.$el.css("display","inline-block"),this.delegateEvents(),e(document).one("click",function(){t.close()})},close:function(e){var t=this;setTimeout(function(){t.$el.hide()},200)},select:function(t){var n=e(t.target).data("id");this.trigger("select",n),this.$("input").val("value"),this.$el.hide()},getTpl:function(){return this.tpl?this.tpl:Upfront.data&&Upfront.data.tpls?_.template(e(Upfront.data.tpls.popup).find("#microselect-tpl").html()):!1}}),u=function(){var e={},t=function(e){return console.log("Simple editor deprecated. Use the new Ueditor"),{on:function(){}}};return{add:t}},a=Backbone.View.extend({TYPES:{external:"external",internal:"internal",anchor:"anchor"},events:{"change .upfront-field-wrap-radios :radio":"swap_selection","click .upfront-save_settings":"apply_linkage"},initialize:function(){if(this.options.href){var e=this.options.href.match(/^#/)?this.TYPES.anchor:this.TYPES.external,t=this.options.href.match(/^#/)?this.options.href.replace(/#/,""):this.options.href;this.model.set_property("type",e),this.model.set_property("url",t)}this.model.init_property("type",this.TYPES.anchor),this.settings=new Upfront.Views.Editor.Field.Radios({model:this.model,property:"type",layout:"horizontal-inline",values:[{label:"External URL",value:this.TYPES.external},{label:"Post/Page",value:this.TYPES.internal},{label:"Anchor",value:this.TYPES.anchor}]}),this.url_field=!1},render:function(){this.$el.empty().append('<div class="wrap" />');var e=this.$el.find(".wrap");e.empty(),this.settings.render(),e.append(this.settings.$el),e.append("<div id='upfront-cke-link_editor-link_type' />"),this.$el.append("<button type='button' class='upfront-save_settings'>Ok</button>"),this.$el.offset(this.options.offset),this.swap_selection()},swap_selection:function(e){var t=this.$el.find("#upfront-cke-link_editor-link_type"),n=this.settings.get_value(),r=this.model.get_property_value_by_name("url");t.empty();if(!n)return!1;if(this.TYPES.external===n)this.url_field=new Upfront.Views.Editor.Field.Text({model:this.model,property:"url",default_value:r}),this.url_field.render(),t.append(this.url_field.$el);else if(this.TYPES.internal===n){var i=this;Upfront.Views.Editor.PostSelector.open({}).done(function(e){if(!e||!e.get)return!1;i.trigger("link:set",e.get("permalink"),i.TYPES.internal)})}else if(this.TYPES.anchor===n){var s=this.$el.find(".upfront-field-multiple.upfront-field-multiple-horizontal-inline.upfront-field-multiple-selected"),o=s.find(".upfront-field-wrap.upfront-field-wrap-select");o.length&&o.remove(),this.url_field=new Upfront.Views.Editor.Field.Anchor({model:this.model,property:"url",default_value:r}),this.url_field.render(),s.append(this.url_field.$el),s.find(".upfront-field-wrap.upfront-field-wrap-select").on("change",function(e){e.stopPropagation()}).end().find("label").css({"float":"left","padding-top":"1.4em"}).end().find(".upfront-field-wrap.upfront-field-wrap-select").css({"float":"right","margin-left":10})}return!1},apply_linkage:function(){var e=this.url_field.get_value()||this.model.get_property_value_by_name("url"),t=this.settings.get_value();this.trigger("link:set",e,t)}}),f=new(Backbone.View.extend({initialize:function(){Upfront.Events.on("upfront:editor:init",this.rebind_ckeditor_link,this)},rebind_ckeditor_link:function(){var e=this;_(CKEDITOR.instances).each(function(t){var n=t.getCommand("link");n&&n.on&&n.on("exec",e.ck_open,e),t.on("doubleclick",function(n){n.data&&n.data.dialog&&("link"===n.data.dialog||"anchor"===n.data.dialog)&&(n.data.dialog=!1);var r=CKEDITOR.plugins.link.getSelectedLink(t)||n.data.element;!r.isReadOnly()&&r.is("a")&&(t.getSelection().selectElement(r),e.ck_open({href:r.getAttribute("href")}))})})},ck_open:function(t){var n=this,r=CKEDITOR.currentInstance,i=r.getSelection(),s=i.createBookmarks(),o=e(s[0].startNode.$).parent(),u=!1,a=function(){if(i.getRanges()[0].endOffset===r.getSelection().getRanges()[0].endOffset)return!1;e("#upfront-cke-link_editor").remove()};if(o.is("span")){o=o.find("[data-cke-bookmark]").first();var l=o.show().offset();u={top:l.top?l.top+o.height():l.top,left:l.left},o.hide()}return i.selectBookmarks(s),this.open(_.extend(t,{el:o,offset:u})),r.editable().on("click",a),r.on("destroy",function(){e("#upfront-cke-link_editor").remove()}),f.instance=CKEDITOR.currentInstance.name,!1},on_close:function(e,t){var n=CKEDITOR.instances[f.instance],r=!1,i=new CKEDITOR.dom.element("a"),s=a.prototype.TYPES.anchor===t?"#"+e.replace(/#/,""):e.match(/^https?\:\/\//)?e:window.location.protocol+"//"+e;n.focus(),r=n.getSelection().getSelectedText(),i.setAttributes({href:s}),i.setText(r),n.insertElement(i)},open:function(t){t=t||{};var n=!1,r={top:0,left:0};e("#upfront-cke-link_editor").length&&e("#upfront-cke-link_editor").remove(),e("body").append("<div id='upfront-cke-link_editor' />"),n=e("#upfront-cke-link_editor");if(t.el&&t.el.length&&!t.offset){var i=t.el.offset();r={top:i.top?i.top+t.el.height():i.top,left:i.left}}else t.offset&&(r=t.offset);var s=this,o=new a(_.extend({},t,{model:new Upfront.Models.ObjectModel,el:n,offset:r}));o.render(),o.on("link:set",function(e,t){o.remove(),s.on_close(e,t)})}}));Upfront.Content={TYPES:{SIMPLE:"simple"},editor:n,editors:new u,microselect:o,Link_CkeDialog:a}})}(jQuery),function(e,t,n){function f(e,t,n){var r=[];for(var i=0;i<e.length;i++){var s=tinycolor(e[i]),u=s.toHsl().l<.5?"sp-thumb-el sp-thumb-dark":"sp-thumb-el sp-thumb-light";u+=tinycolor.equals(t,e[i])?" sp-thumb-active":"";var a=o?"background-color:"+s.toRgbString():"filter:"+s.toFilter();r.push('<span title="'+s.toRgbString()+'" data-color="'+s.toRgbString()+'" class="'+u+'"><span class="sp-thumb-inner" style="'+a+';" /></span>')}return"<div class='sp-cf "+n+"'>"+r.join("")+"</div>"}function l(){for(var e=0;e<i.length;e++)i[e]&&i[e].hide()}function c(e,n){var i=t.extend({},r,e);return i.callbacks={move:m(i.move,n),change:m(i.change,n),show:m(i.show,n),hide:m(i.hide,n),beforeShow:m(i.beforeShow,n)},i}function h(r,h){function yt(){J.toggleClass("sp-flat",m),J.toggleClass("sp-input-disabled",!d.showInput),J.toggleClass("sp-alpha-enabled",d.showAlpha),J.toggleClass("sp-buttons-disabled",!d.showButtons),J.toggleClass("sp-palette-disabled",!d.showPalette),J.toggleClass("sp-palette-only",d.showPaletteOnly),J.toggleClass("sp-initial-disabled",!d.showInitial),J.addClass(d.className),Ft()}function bt(){function o(e){return e.data&&e.data.ignore?(Mt(t(this).data("color")),Pt()):(Mt(t(this).data("color")),jt(!0),Pt(),At()),!1}s&&J.find("*:not(input)").attr("unselectable","on"),yt(),at&&X.after(ft).hide();if(m)X.after(J).hide();else{var n=d.appendTo==="parent"?X.parent():t(d.appendTo);n.length!==1&&(n=t("body")),n.append(J)}if(w&&e.localStorage){try{var r=e.localStorage[w].split(",#");r.length>1&&(delete e.localStorage[w],t.each(r,function(e,t){wt(t)}))}catch(i){}try{I=e.localStorage[w].split(";")}catch(i){}}lt.bind("click.spectrum touchstart.spectrum",function(e){V||kt(),e.stopPropagation(),t(e.target).is("input")||e.preventDefault()}),(X.is(":disabled")||d.disabled===!0)&&zt(),J.click(v),nt.change(Ct),nt.bind("paste",function(){setTimeout(Ct,1)}),nt.keydown(function(e){e.keyCode==13&&Ct()}),st.text(d.cancelText),st.bind("click.spectrum",function(e){e.stopPropagation(),e.preventDefault(),At("cancel")}),ot.text(d.chooseText),ot.bind("click.spectrum",function(e){e.stopPropagation(),e.preventDefault(),Dt()&&(jt(!0),At())}),g(et,function(e,t,n){B=1-t/O,n.shiftKey&&(B=Math.round(B*10)/10),Pt()}),g(G,function(e,t){D=parseFloat(t/L),Pt()},Tt,Nt),g(K,function(e,t,n){if(!n.shiftKey)U=null;else if(!U){var r=P*N,i=C-H*C,s=Math.abs(e-r)>Math.abs(t-i);U=s?"x":"y"}var o=!U||U==="x",u=!U||U==="y";o&&(P=parseFloat(e/N)),u&&(H=parseFloat((C-t)/C)),Pt()},Tt,Nt),pt?(Mt(pt),Ht(),mt=vt||d.showAlpha?"rgb":tinycolor(pt).format,wt(pt)):Ht(),d.textHint?ht.text(_t().toHexString()):ht.hide(),m&&Lt();var u=s?"mousedown.spectrum":"click.spectrum touchstart.spectrum";rt.delegate(".sp-thumb-el",u,{ignore:!0},o),it.delegate(".sp-thumb-el:nth-child(1)",u,{ignore:!0},o)}function wt(n){if(b){var r=tinycolor(n).toRgbString();if(t.inArray(r,I)===-1){I.push(r);while(I.length>q)I.shift()}if(w&&e.localStorage)try{e.localStorage[w]=I.join(";")}catch(i){}}}function Et(){var e=[],t=I,n={},r;if(d.showPalette){for(var i=0;i<F.length;i++)for(var s=0;s<F[i].length;s++)r=tinycolor(F[i][s]).toRgbString(),n[r]=!0;for(i=0;i<t.length;i++)r=tinycolor(t[i]).toRgbString(),n.hasOwnProperty(r)||(e.push(t[i]),n[r]=!0)}return e=e.reverse().slice(0,d.maxSelectionSize),d.allowEmpty&&(e=e.concat(["transparent"])),e}function St(){var e=_t(),n=t.map(F,function(t,n){return f(t,e,"sp-palette-row sp-palette-row-"+n)});I&&n.push(f(Et(),e,"sp-palette-row sp-palette-row-selection")),rt.html(n.join(""))}function xt(){if(d.showInitial){var e=dt,t=_t();it.html(f([e,t],t,"sp-palette-row-initial"))}}function Tt(){(C<=0||N<=0||L<=0)&&Ft(),J.addClass(R),U=null}function Nt(){J.removeClass(R)}function Ct(){var e=tinycolor(nt.val());e.ok?Mt(e):nt.addClass("sp-validation-error")}function kt(){T?At():Lt()}function Lt(){var n=t.Event("beforeShow.spectrum");if(T){Ft();return}X.trigger(n,[_t()]);if(S.beforeShow(_t())===!1||n.isDefaultPrevented())return;l(),T=!0,t(z).bind("click.spectrum",At),t(e).bind("resize.spectrum",x),ft.addClass("sp-active"),J.removeClass("sp-hidden"),d.showPalette&&St(),Ft(),Ht(),dt=_t(),xt(),S.show(dt),X.trigger("show.spectrum",[dt])}function At(n){if(n&&n.type=="click"&&n.button==2)return;if(!T||m)return;T=!1,t(z).unbind("click.spectrum",At),t(e).unbind("resize.spectrum",x),ft.removeClass("sp-active"),J.addClass("sp-hidden");var r=!tinycolor.equals(_t(),dt);r&&(gt&&n!=="cancel"?jt(!0):Ot()),S.hide(_t()),X.trigger("hide.spectrum",[_t()])}function Ot(){Mt(dt,!0)}function Mt(e,t){if(tinycolor.equals(e,_t()))return;var n=tinycolor(e),r=n.toHsv();D=r.h%360/360,P=r.s,H=r.v,B=r.a,Ht(),n.ok&&!t&&(mt=vt||n.format)}function _t(e){return e=e||{},tinycolor.fromRatio({h:D,s:P,v:H,a:Math.round(B*100)/100},{format:e.format||mt})}function Dt(){return!nt.hasClass("sp-validation-error")}function Pt(){Ht(),S.move(_t()),X.trigger("move.spectrum",[_t()])}function Ht(){nt.removeClass("sp-validation-error"),Bt();var e=tinycolor.fromRatio({h:D,s:1,v:1});K.css("background-color",e.toHexString()),J.find(".sp-input").css("border-left-color",_t().toRgbString());var t=mt;B<1&&(t==="hex"||t==="hex3"||t==="hex6"||t==="name")&&(t="rgb");var n=_t({format:t}),r=n.toHexString(),i=n.toRgbString();o||n.alpha===1?ct.css("background-color",i):(ct.css("background-color","transparent"),ct.css("filter",n.toFilter()));if(d.showAlpha){var u=n.toRgb();u.a=0;var a=tinycolor(u).toRgbString(),f="linear-gradient(bottom, "+a+", "+r+")";s?Z.css("filter",tinycolor(a).toFilter({gradientType:1},r)):(Z.css("background","-webkit-"+f),Z.css("background","-moz-"+f),Z.css("background","-ms-"+f),Z.css("background",f))}d.textHint&&ht.text(n.toHexString),d.showInput&&nt.val(n.toString("hex")),d.showPalette&&St(),xt()}function Bt(){var e=P,t=H,n=e*N,r=C-t*C;n=Math.max(-k,Math.min(N-k,n-k)),r=Math.max(-k,Math.min(C-k,r-k)),Q.css({top:r,left:n});var i=B*O;tt.css({top:Z.height()-(i-M/2)-4});var s=D*L;Y.css({top:s-_})}function jt(e){var t=_t();ut&&X.attr("value",t.toString(mt));var n=!tinycolor.equals(t,dt);dt=t,d.textHint&&ht.text(t.toHexString()),wt(t),S.change(t),e&&X.trigger("change.spectrum",[t])}function Ft(){N=K.width(),C=K.height(),k=Q.height(),A=G.width(),L=G.height(),_=Y.height(),O=et.height(),M=tt.height(),m||(J.css("position","absolute"),J.offset(p(J,lt))),Bt()}function It(){St(),Mt(d.color),Ht()}function qt(){X.show(),lt.unbind("click.spectrum touchstart.spectrum"),J.remove(),ft.remove(),i[Wt.id]=null}function Rt(e,r){if(e===n)return t.extend({},d);if(r===n)return d[e];d[e]=r,yt()}function Ut(){V=!1,X.attr("disabled",!1),lt.removeClass("sp-disabled")}function zt(){At(),V=!0,X.attr("disabled",!0),lt.addClass("sp-disabled")}var d=c(h,r),m=d.flat,b=d.showSelectionPalette,w=d.localStorageKey,E=d.theme,S=d.callbacks,x=y(Ft,10),T=!1,N=0,C=0,k=0,L=0,A=0,O=0,M=0,_=0,D=0,P=0,H=0,B=1,j=d.palette.slice(0),F=t.isArray(j[0])?j:[j],I=d.selectionPalette.slice(0),q=d.maxSelectionSize,R="sp-dragging",U=null,z=r.ownerDocument,W=z.body,X=t(r),V=!1,J=t(a,z).addClass(E),K=J.find(".sp-color"),Q=J.find(".sp-dragger"),G=J.find(".sp-hue"),Y=J.find(".sp-slider"),Z=J.find(".sp-alpha-inner"),et=J.find(".sp-alpha"),tt=J.find(".sp-alpha-handle"),nt=J.find(".sp-input"),rt=J.find(".sp-palette"),it=J.find(".sp-initial"),st=J.find(".sp-cancel"),ot=J.find(".sp-choose"),ut=X.is("input"),at=ut&&!m,ft=at?t(u).addClass(E).addClass(d.className):t([]),lt=at?ft:X,ct=ft.find(".sp-preview-inner"),ht=ft.find(".sp-texthint"),pt=d.color||ut&&X.val(),dt=!1,vt=d.preferredFormat,mt=vt,gt=!d.showButtons||d.clickoutFiresChange;bt();var Wt={show:Lt,hide:At,toggle:kt,reflow:Ft,resetUI:It,option:Rt,enable:Ut,disable:zt,set:function(e){Mt(e),jt()},get:_t,destroy:qt,container:J};return Wt.id=i.push(Wt)-1,Wt}function p(e,n){var r=0,i=e.outerWidth(),s=e.outerHeight(),o=n.outerHeight(),u=e[0].ownerDocument,a=u.documentElement,f=a.clientWidth+t(u).scrollLeft(),l=a.clientHeight+t(u).scrollTop(),c=n.offset();return c.top+=o,c.left-=Math.min(c.left,c.left+i>f&&f>i?Math.abs(c.left+i-f):0),c.left=c.left>0?c.left>50?c.left-50:0:c.left,c.top-=Math.min(c.top,c.top+s>l&&l>s?Math.abs(s+o-r):r),c}function d(){}function v(e){e.stopPropagation()}function m(e,t){var n=Array.prototype.slice,r=n.call(arguments,2);return function(){return e.apply(t,r.concat(n.call(arguments)))}}function g(n,r,i,o){function d(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault(),e.returnValue=!1}function v(e){if(a){if(s&&document.documentMode<9&&!e.button)return g();var t=e.originalEvent.touches,i=t?t[0].pageX:e.pageX,o=t?t[0].pageY:e.pageY,u=Math.max(0,Math.min(i-f.left,c)),p=Math.max(0,Math.min(o-f.top,l));h&&d(e),r.apply(n,[u,p,e])}}function m(e){var r=e.which?e.which==3:e.button==2,s=e.originalEvent.touches;!r&&!a&&i.apply(n,arguments)!==!1&&(a=!0,l=t(n).height(),c=t(n).width(),f=t(n).offset(),t(u).bind(p),t(u.body).addClass("sp-dragging"),h||v(e),d(e))}function g(){a&&(t(u).unbind(p),t(u.body).removeClass("sp-dragging"),o.apply(n,arguments)),a=!1}r=r||function(){},i=i||function(){},o=o||function(){};var u=n.ownerDocument||document,a=!1,f={},l=0,c=0,h="ontouchstart"in e,p={};p.selectstart=d,p.dragstart=d,p["touchmove mousemove"]=v,p["touchend mouseup"]=g,t(n).bind("touchstart mousedown",m)}function y(e,t,n){var r;return function(){var i=this,s=arguments,o=function(){r=null,e.apply(i,s)};n&&clearTimeout(r);if(n||!r)r=setTimeout(o,t)}}function b(){e.console&&(Function.prototype.bind?b=Function.prototype.bind.call(console.log,console):b=function(){Function.prototype.apply.call(console.log,console,arguments)},b.apply(this,arguments))}var r={beforeShow:d,move:d,change:d,show:d,hide:d,color:!1,flat:!1,showInput:!1,showButtons:!0,clickoutFiresChange:!1,showInitial:!1,showPalette:!1,showPaletteOnly:!1,showSelectionPalette:!0,localStorageKey:!1,appendTo:"body",maxSelectionSize:7,cancelText:"cancel",chooseText:"choose",preferredFormat:!1,className:"",showAlpha:!1,allowEmpty:!1,theme:"sp-light",palette:["fff","000"],selectionPalette:[],disabled:!1,textHint:!0},i=[],s=!!/msie/i.exec(e.navigator.userAgent),o=function(){function e(e,t){return!!~(""+e).indexOf(t)}var t=document.createElement("div"),n=t.style;return n.cssText="background-color:rgba(0,0,0,.5)",e(n.backgroundColor,"rgba")||e(n.backgroundColor,"hsla")}(),u=["<a class='sp-replacer' title='Click to pick a color' href='#'>","<div class='sp-preview'><div class='sp-preview-inner'></div></div>","</a>"].join(""),a=function(){var e="";if(s)for(var t=1;t<=6;t++)e+="<div class='sp-"+t+"'></div>";return["<div class='sp-container sp-hidden'>","<div class='sp-palette-container'>","<div class='sp-palette sp-thumb sp-cf'></div>","</div>","<div class='sp-picker-container'>","<div class='sp-top sp-cf'>","<div class='sp-fill'></div>","<div class='sp-top-inner'>","<div class='sp-color'>","<div class='sp-sat'>","<div class='sp-val'>","<div class='sp-dragger'></div>","</div>","</div>","</div>","<div class='sp-hue'>","<div class='sp-slider'></div>",e,"</div>","</div>","<div class='sp-alpha'><div class='sp-alpha-inner'><div class='sp-alpha-handle'></div></div></div>","</div>","<div class='sp-input-container sp-cf'>","<input class='sp-input' type='text' spellcheck='false'  />","</div>","<div class='sp-initial sp-thumb sp-cf'></div>","<div class='sp-button-container sp-cf'>","<a class='sp-cancel' href='#'></a>","<button class='sp-choose'></button>","</div>","</div>","</div>"].join("")}(),w="spectrum.id";t.fn.spectrum=function(e,n){if(typeof e=="string"){var r=this,s=Array.prototype.slice.call(arguments,1);return this.each(function(){var n=i[t(this).data(w)];if(n){var o=n[e];if(!o)throw new Error("Spectrum: no such method: '"+e+"'");e=="get"?r=n.get():e=="container"?r=n.container:e=="option"?r=n.option.apply(n,s):e=="destroy"?(n.destroy(),t(this).removeData(w)):o.apply(n,s)}}),r}return this.spectrum("destroy").each(function(){var n=h(this,e);t(this).data(w,n.id)})},t.fn.spectrum.load=!0,t.fn.spectrum.loadOpts={},t.fn.spectrum.draggable=g,t.fn.spectrum.defaults=r,t.spectrum={},t.spectrum.localization={},t.spectrum.palettes={},t.fn.spectrum.processNativeColorInputs=function(){var e=t("<input type='color' value='!' />")[0],n=e.type==="color"&&e.value!="!";n||t("input[type=color]").spectrum({preferredFormat:"hex6"})},function(e){function f(e,t){e=e?e:"",t=t||{};if(typeof e=="object"&&e.hasOwnProperty("_tc_id"))return e;var n=l(e),i=n.r,o=n.g,u=n.b,a=n.a,c=s(100*a)/100,p=t.format||n.format;return i<1&&(i=s(i)),o<1&&(o=s(o)),u<1&&(u=s(u)),{ok:n.ok,format:p,_tc_id:r++,alpha:a,toHsv:function(){var e=d(i,o,u);return{h:e.h*360,s:e.s,v:e.v,a:a}},toHsvString:function(){var e=d(i,o,u),t=s(e.h*360),n=s(e.s*100),r=s(e.v*100);return a==1?"hsv("+t+", "+n+"%, "+r+"%)":"hsva("+t+", "+n+"%, "+r+"%, "+c+")"},toHsl:function(){var e=h(i,o,u);return{h:e.h*360,s:e.s,l:e.l,a:a}},toHslString:function(){var e=h(i,o,u),t=s(e.h*360),n=s(e.s*100),r=s(e.l*100);return a==1?"hsl("+t+", "+n+"%, "+r+"%)":"hsla("+t+", "+n+"%, "+r+"%, "+c+")"},toHex:function(e){return m(i,o,u,e)},toHexString:function(e){return"#"+m(i,o,u,e)},toRgb:function(){return{r:s(i),g:s(o),b:s(u),a:a}},toRgbString:function(){return a==1?"rgb("+s(i)+", "+s(o)+", "+s(u)+")":"rgba("+s(i)+", "+s(o)+", "+s(u)+", "+c+")"},toPercentageRgb:function(){return{r:s(w(i,255)*100)+"%",g:s(w(o,255)*100)+"%",b:s(w(u,255)*100)+"%",a:a}},toPercentageRgbString:function(){return a==1?"rgb("+s(w(i,255)*100)+"%, "+s(w(o,255)*100)+"%, "+s(w(u,255)*100)+"%)":"rgba("+s(w(i,255)*100)+"%, "+s(w(o,255)*100)+"%, "+s(w(u,255)*100)+"%, "+c+")"},toName:function(){return y[m(i,o,u,!0)]||!1},toFilter:function(e){var n=m(i,o,u),r=n,s=Math.round(parseFloat(a)*255).toString(16),l=s,c=t&&t.gradientType?"GradientType = 1, ":"";if(e){var h=f(e);r=h.toHex(),l=Math.round(parseFloat(h.alpha)*255).toString(16)}return"progid:DXImageTransform.Microsoft.gradient("+c+"startColorstr=#"+N(s)+n+",endColorstr=#"+N(l)+r+")"},toString:function(e){e=e||this.format;var t=!1;e==="rgb"&&(t=this.toRgbString()),e==="prgb"&&(t=this.toPercentageRgbString());if(e==="hex"||e==="hex6")t=this.toHexString();return e==="hex3"&&(t=this.toHexString(!0)),e==="name"&&(t=this.toName()),e==="hsl"&&(t=this.toHslString()),e==="hsv"&&(t=this.toHsvString()),t||this.toHexString()}}}function l(e){var t={r:0,g:0,b:0},n=1,r=!1,i=!1;typeof e=="string"&&(e=L(e)),typeof e=="object"&&(e.hasOwnProperty("r")&&e.hasOwnProperty("g")&&e.hasOwnProperty("b")?(t=c(e.r,e.g,e.b),r=!0,i=String(e.r).substr(-1)==="%"?"prgb":"rgb"):e.hasOwnProperty("h")&&e.hasOwnProperty("s")&&e.hasOwnProperty("v")?(e.s=C(e.s),e.v=C(e.v),t=v(e.h,e.s,e.v),r=!0,i="hsv"):e.hasOwnProperty("h")&&e.hasOwnProperty("s")&&e.hasOwnProperty("l")&&(e.s=C(e.s),e.l=C(e.l),t=p(e.h,e.s,e.l),r=!0,i="hsl"),e.hasOwnProperty("a")&&(n=e.a)),n=parseFloat(n);if(isNaN(n)||n<0||n>1)n=1;return{ok:r,format:e.format||i,r:o(255,u(t.r,0)),g:o(255,u(t.g,0)),b:o(255,u(t.b,0)),a:n}}function c(e,t,n){return{r:w(e,255)*255,g:w(t,255)*255,b:w(n,255)*255}}function h(e,t,n){e=w(e,255),t=w(t,255),n=w(n,255);var r=u(e,t,n),i=o(e,t,n),s,a,f=(r+i)/2;if(r==i)s=a=0;else{var l=r-i;a=f>.5?l/(2-r-i):l/(r+i);switch(r){case e:s=(t-n)/l+(t<n?6:0);break;case t:s=(n-e)/l+2;break;case n:s=(e-t)/l+4}s/=6}return{h:s,s:a,l:f}}function p(e,t,n){function o(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+(t-e)*6*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e}var r,i,s;e=w(e,360),t=w(t,100),n=w(n,100);if(t===0)r=i=s=n;else{var u=n<.5?n*(1+t):n+t-n*t,a=2*n-u;r=o(a,u,e+1/3),i=o(a,u,e),s=o(a,u,e-1/3)}return{r:r*255,g:i*255,b:s*255}}function d(e,t,n){e=w(e,255),t=w(t,255),n=w(n,255);var r=u(e,t,n),i=o(e,t,n),s,a,f=r,l=r-i;a=r===0?0:l/r;if(r==i)s=0;else{switch(r){case e:s=(t-n)/l+(t<n?6:0);break;case t:s=(n-e)/l+2;break;case n:s=(e-t)/l+4}s/=6}return{h:s,s:a,v:f}}function v(e,t,n){e=w(e,360)*6,t=w(t,100),n=w(n,100);var r=i.floor(e),s=e-r,o=n*(1-t),u=n*(1-s*t),a=n*(1-(1-s)*t),f=r%6,l=[n,u,o,o,a,n][f],c=[a,n,n,u,o,o][f],h=[o,o,a,n,n,u][f];return{r:l*255,g:c*255,b:h*255}}function m(e,t,n,r){var i=[N(s(e).toString(16)),N(s(t).toString(16)),N(s(n).toString(16))];return r&&i[0].charAt(0)==i[0].charAt(1)&&i[1].charAt(0)==i[1].charAt(1)&&i[2].charAt(0)==i[2].charAt(1)?i[0].charAt(0)+i[1].charAt(0)+i[2].charAt(0):i.join("")}function b(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[e[n]]=n);return t}function w(e,t){x(e)&&(e="100%");var n=T(e);return e=o(t,u(0,parseFloat(e))),n&&(e=parseInt(e*t,10)/100),i.abs(e-t)<1e-6?1:e%t/parseFloat(t)}function E(e){return o(1,u(0,e))}function S(e){return parseInt(e,16)}function x(e){return typeof e=="string"&&e.indexOf(".")!=-1&&parseFloat(e)===1}function T(e){return typeof e=="string"&&e.indexOf("%")!=-1}function N(e){return e.length==1?"0"+e:""+e}function C(e){return e<=1&&(e=e*100+"%"),e}function L(e){e=e.replace(t,"").replace(n,"").toLowerCase();var r=!1;if(g[e])e=g[e],r=!0;else if(e=="transparent")return{r:0,g:0,b:0,a:0};var i;return(i=k.rgb.exec(e))?{r:i[1],g:i[2],b:i[3]}:(i=k.rgba.exec(e))?{r:i[1],g:i[2],b:i[3],a:i[4]}:(i=k.hsl.exec(e))?{h:i[1],s:i[2],l:i[3]}:(i=k.hsla.exec(e))?{h:i[1],s:i[2],l:i[3],a:i[4]}:(i=k.hsv.exec(e))?{h:i[1],s:i[2],v:i[3]}:(i=k.hex6.exec(e))?{r:S(i[1]),g:S(i[2]),b:S(i[3]),format:r?"name":"hex"}:(i=k.hex3.exec(e))?{r:S(i[1]+""+i[1]),g:S(i[2]+""+i[2]),b:S(i[3]+""+i[3]),format:r?"name":"hex"}:!1}var t=/^[\s,#]+/,n=/\s+$/,r=0,i=Math,s=i.round,o=i.min,u=i.max,a=i.random;f.fromRatio=function(e,t){if(typeof e=="object"){var n={};for(var r in e)e.hasOwnProperty(r)&&(r==="a"?n[r]=e[r]:n[r]=C(e[r]));e=n}return f(e,t)},f.equals=function(e,t){return!e||!t?!1:f(e).toRgbString()==f(t).toRgbString()},f.random=function(){return f.fromRatio({r:a(),g:a(),b:a()})},f.desaturate=function(e,t){var n=f(e).toHsl();return n.s-=(t||10)/100,n.s=E(n.s),f(n)},f.saturate=function(e,t){var n=f(e).toHsl();return n.s+=(t||10)/100,n.s=E(n.s),f(n)},f.greyscale=function(e){return f.desaturate(e,100)},f.lighten=function(e,t){var n=f(e).toHsl();return n.l+=(t||10)/100,n.l=E(n.l),f(n)},f.darken=function(e,t){var n=f(e).toHsl();return n.l-=(t||10)/100,n.l=E(n.l),f(n)},f.complement=function(e){var t=f(e).toHsl();return t.h=(t.h+180)%360,f(t)},f.triad=function(e){var t=f(e).toHsl(),n=t.h;return[f(e),f({h:(n+120)%360,s:t.s,l:t.l}),f({h:(n+240)%360,s:t.s,l:t.l})]},f.tetrad=function(e){var t=f(e).toHsl(),n=t.h;return[f(e),f({h:(n+90)%360,s:t.s,l:t.l}),f({h:(n+180)%360,s:t.s,l:t.l}),f({h:(n+270)%360,s:t.s,l:t.l})]},f.splitcomplement=function(e){var t=f(e).toHsl(),n=t.h;return[f(e),f({h:(n+72)%360,s:t.s,l:t.l}),f({h:(n+216)%360,s:t.s,l:t.l})]},f.analogous=function(e,t,n){t=t||6,n=n||30;var r=f(e).toHsl(),i=360/n,s=[f(e)];for(r.h=(r.h-(i*t>>1)+720)%360;--t;)r.h=(r.h+i)%360,s.push(f(r));return s},f.monochromatic=function(e,t){t=t||6;var n=f(e).toHsv(),r=n.h,i=n.s,s=n.v,o=[],u=1/t;while(t--)o.push(f({h:r,s:i,v:s})),s=(s+u)%1;return o},f.readability=function(e,t){var n=f(e).toRgb(),r=f(t).toRgb(),i=(n.r*299+n.g*587+n.b*114)/1e3,s=(r.r*299+r.g*587+r.b*114)/1e3,o=Math.max(n.r,r.r)-Math.min(n.r,r.r)+Math.max(n.g,r.g)-Math.min(n.g,r.g)+Math.max(n.b,r.b)-Math.min(n.b,r.b);return{brightness:Math.abs(i-s),color:o}},f.readable=function(e,t){var n=f.readability(e,t);return n.brightness>125&&n.color>500},f.mostReadable=function(e,t){var n=null,r=0,i=!1;for(var s=0;s<t.length;s++){var o=f.readability(e,t[s]),u=o.brightness>125&&o.color>500,a=3*(o.brightness/125)+o.color/500;if(u&&!i||u&&i&&a>r||!u&&!i&&a>r)i=u,r=a,n=f(t[s])}return n};var g=f.names={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"0ff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000",blanchedalmond:"ffebcd",blue:"00f",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",burntsienna:"ea7e5d",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"0ff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"f0f",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"789",lightslategrey:"789",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"0f0",limegreen:"32cd32",linen:"faf0e6",magenta:"f0f",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"f00",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"fff",whitesmoke:"f5f5f5",yellow:"ff0",yellowgreen:"9acd32"},y=f.hexNames=b(g),k=function(){var e="[-\\+]?\\d+%?",t="[-\\+]?\\d*\\.\\d+%?",n="(?:"+t+")|(?:"+e+")",r="[\\s|\\(]+("+n+")[,|\\s]+("+n+")[,|\\s]+("+n+")\\s*\\)?",i="[\\s|\\(]+("+n+")[,|\\s]+("+n+")[,|\\s]+("+n+")[,|\\s]+("+n+")\\s*\\)?";return{rgb:new RegExp("rgb"+r),rgba:new RegExp("rgba"+i),hsl:new RegExp("hsl"+r),hsla:new RegExp("hsla"+i),hsv:new RegExp("hsv"+r),hex3:/^([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/}}();e.tinycolor=f}(this),t(function(){t.fn.spectrum.load&&t.fn.spectrum.processNativeColorInputs()})}(window,jQuery),define("spectrum",function(){}),function(e){e.fn.responsiveElement=function(){function a(t){var n=_.isString(t)?e(t):e("body");return l(n)}function f(e){return l(e.$el.parent())}function l(a,f){var l=[],c=e("#"+t);a.find(n).each(function(){var t=f?e(this).closest(".upfront-module"):e(this);id=e(this).attr("id")||"bind-"+Math.floor(Math.random()*1e5),width=t.outerWidth(),height=t.outerHeight(),bind_styles=u.replace(/\( ?this ?\)/igm,"#"+id),e(this).attr("id")||e(this).attr("id",id);var n=(r&&width>=r||!r)&&(i&&width<=i||!i)&&(s&&height>=s||!s)&&(o&&height<=o||!o);n&&l.push(bind_styles)}),c.length?c.html(l.join("\n")):(c=e('<style id="'+t+'">'+l.join("\n")+"</style>"),e("body").append(c))}function c(e){if(typeof e=="undefined")return!1;var t=/^(\d+)px$/i,n=/^(\d+)col$/i,r=/^(\d+)row$/i;if(e.match(t))return e.match(t)[1]}var t="responsive-"+Math.floor(Math.random()*1e5),n=e(this).attr("data-bind"),r=c(e(this).attr("data-min-width")),i=c(e(this).attr("data-max-width")),s=c(e(this).attr("data-min-height")),o=c(e(this).attr("data-max-height")),u=e(this).html();e(window).on("load",a),e(window).on("resize",function(t){t.target==this?a():l(e(t.target),!0)}),typeof Upfront.Events!="undefined"&&Upfront.Events.on("upfront:layout:loaded",function(){a(),Upfront.Events.on("entity:module:after_render",f),Upfront.Events.on("entity:resize_stop",f),Upfront.Events.on("upfront:editor:image_on",function(e){a()}),Upfront.Events.on("upfront:editor:image_align",function(e,t){a()})})}}(jQuery),define("responsive",function(){}),function(e){define("uaccordion",["text!elements/upfront-accordion/tpl/uaccordion.html"],function(t){var n=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(Upfront.data.uaccordion.defaults);e.element_id=Upfront.Util.get_unique_id("uaccordion-object"),this.init_properties(e)}}),r=Upfront.Views.ObjectView.extend({model:n,currentEditItem:"",accordionTpl:Upfront.Util.template(t),elementSize:{width:0,height:0},initialize:function(){var e=this;this.model instanceof n||(this.model=new n({properties:this.model.get("properties")})),this.events=_.extend({},this.events,{"click .accordion-add-panel":"addPanel","click .accordion-panel-title":"onPanelTitleClick","keydown .accordion-panel-active .accordion-panel-content":"onContentKeydown","dblclick .accordion-panel-active .accordion-panel-content":"onContentDblclick","click i":"deletePanel"}),this.delegateEvents(),this.model.get("properties").bind("change",this.render,this),this.model.get("properties").bind("add",this.render,this),this.model.get("properties").bind("remove",this.render,this),this.on("deactivated",this.onDeactivate,this),this.debouncedSave=_.debounce(this.savePanelContent,1e3)},addPanel:function(){this.property("accordion").push({title:"Panel "+(1+this.property("accordion_count")),content:"Content "+(1+this.property("accordion_count"))}),this.property("accordion_count",this.property("accordion").length,!1)},deletePanel:function(t){var n=e(t.currentTarget),r=n.parents(".accordion-panel"),i=r.index()-1;this.property("accordion").splice(i,1),this.property("accordion_count",this.property("accordion_count")-1,!1)},onPanelTitleClick:function(t){var n=e(t.currentTarget);typeof currentEditItem!="undefined"&&currentEditItem!=""&&currentEditItem!=n.attr("id")&&this.onDeactivate();if(n.parent().hasClass("accordion-panel-active")&&n.attr("contenteditable")=="true")return;if(n.parent().hasClass("accordion-panel-active")){n.attr("contenteditable",!0);if(!e("#"+n.attr("id")).data("ueditor")){var r=e("#"+n.attr("id")).ueditor({autostart:!1,upfrontMedia:!1,upfrontImages:!1});r.on("syncAfter",function(){console.log("syncing after"),i.saveTitle(n),i.$el.parent().parent().parent().draggable("enable"),r.stop()})}currentEditItem=n.attr("id");var i=this;n.focus(),this.$el.parent().parent().parent().draggable("disable");return}n.parent().addClass("accordion-panel-active").find(".accordion-panel-content").show("normal"),n.parent().siblings().removeClass("accordion-panel-active").find(".accordion-panel-content").hide("normal"),n.removeAttr("contenteditable")},onDeactivate:function(){var t=e("#"+currentEditItem);t.hasClass("accordion-panel-title")?(t.removeAttr("contenteditable"),this.saveTitle(t),console.log("saved title content"),this.$el.parent().parent().parent().draggable("enable")):t.hasClass("accordion-panel-content")&&this.stopEdit(),e("#"+currentEditItem).removeAttr("contenteditable"),currentEditItem=""},onContentDblclick:function(t){var n=e(t.currentTarget);typeof currentEditItem!="undefined"&&currentEditItem!=""&&currentEditItem!=n.attr("id")&&this.onDeactivate();if(n.attr("contenteditable")==="true")return;n.attr("contenteditable",!0).addClass("upfront-object");if(!n.data("ueditor")){var r=n.ueditor({autostart:!1});r.on("syncAfter",function(){console.log("syncing after"),self.savePanelContent(),self.stopEdit(),r.stop()})}currentEditItem=n.attr("id"),self=this,n.focus(),this.$el.parent().parent().parent().draggable("disable")},onContentKeydown:function(e){this.debouncedSave()},saveTitle:function(e){return},savePanelContent:function(){var e=this.$el.find(".accordion-panel-active"),t=e.find(".accordion-panel-content"),n=e.index()-1;this.property("accordion")[n].content=t.html()},stopEdit:function(){this.savePanelContent(),this.$el.find(".accordion-panel-active .accordion-panel-content").removeAttr("contenteditable").removeClass("upfront-object"),console.log("saved content"),this.$el.parent().parent().parent().draggable("enable"),this.delegateEvents()},get_content_markup:function(){return this.accordionTpl(_.extend(this.extract_properties(),{show_add:!0,show_remove:this.property("accordion_count")>1?!0:!1}))},extract_properties:function(){var e={};return this.model.get("properties").each(function(t){e[t.get("name")]=t.get("value")}),e},on_render:function(){_.delay(function(e){e.$el.find(".accordion-panel:not(.accordion-panel-active) .accordion-panel-content").hide()},10,this)},addTooltips:function(){e(".accordion-panel").each(function(){var t=e(this).find("span")[0];t.offsetWidth<t.scrollWidth&&e(this).attr("title",e(t).text().trim())})},property:function(e,t,n){return typeof t!="undefined"?(typeof n=="undefined"&&(n=!0),this.model.set_property(e,t,n)):this.model.get_property_value_by_name(e)}}),i=Upfront.Views.Editor.Sidebar.Element.extend({priority:200,render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-accordion"),this.$el.html("Accordion")},add_element:function(){var e=new n,t=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c9 upfront-accordion_module"},{name:"has_settings",value:0},{name:"row",value:15}],objects:[e]});this.add_module(t)}}),s=Upfront.Views.Editor.Settings.Settings.extend({initialize:function(){this.panels=_([new o({model:this.model})])},get_title:function(){return"Accordion settings"}}),o=Upfront.Views.Editor.Settings.Panel.extend({className:"uaccordion-settings-panel",initialize:function(){var e,t=this;e=function(){this.settings.invoke("render")},_.bindAll(this,"onHeaderBorderChange","onHeaderBgChange","onPanelBgChange"),this.model.on("doit",e,this),this.settings=_([new Upfront.Views.Editor.Settings.Item({model:this.model,title:"Display style",fields:[new Upfront.Views.Editor.Field.Radios({className:"inline-radios",model:this.model,property:"style_type",label:"",values:[{label:"",value:"theme_defined"},{label:"Custom",value:"custom"}]}),new Upfront.Views.Editor.Field.Select({model:this.model,property:"theme_style",label:"Theme Styles",values:[{label:"Style 1",value:"style1"},{label:"Style 2",value:"style2"},{label:"Style 3",value:"style3"}]}),new Upfront.Views.Editor.Field.Color({className:"upfront-field-wrap upfront-field-wrap-color sp-cf header-border-color",model:this.model,property:"header_border_color",label:"Header Border:",spectrum:{preferredFormat:"hsl",change:this.onHeaderBorderChange}}),new Upfront.Views.Editor.Field.Color({className:"upfront-field-wrap upfront-field-wrap-color sp-cf header-bg-color",model:this.model,property:"header_bg_color",label:"Header Background:",spectrum:{preferredFormat:"hsl",change:this.onHeaderBgChange}}),new Upfront.Views.Editor.Field.Color({className:"upfront-field-wrap upfront-field-wrap-color sp-cf panel-bg-color",model:this.model,property:"panel_bg_color",label:"Section Background:",spectrum:{preferredFormat:"hsl",change:this.onPanelBgChange}})]})]),this.$el.on("change","input[name=style_type]",function(e){t.onStyleTypeChange(e)}),this.$el.on("change","input[name=theme_style]",function(e){t.onThemeStyleChange(e)})},onStyleTypeChange:function(t){this.property("style_type",e(t.currentTarget).val(),!1),this.setColorChooserVisibility()},onThemeStyleChange:function(t){this.property("theme_style",e(t.currentTarget).val(),!1)},onHeaderBorderChange:function(e){this.property("header_border_color",e.toHslString(),!1)},onHeaderBgChange:function(e){this.property("header_bg_color",e.toHslString(),!1)},onPanelBgChange:function(e){this.property("panel_bg_color",e.toHslString(),!1)},setColorChooserVisibility:function(){e(".upfront-field-wrap-color").css("visibility","hidden");if(this.property("style_type")==="theme_defined")return;if(this.property("custom_style")==="simple_text"){e(".text-color").css("visibility","visible");return}e(".upfront-field-wrap-color").css("visibility","visible")},get_label:function(){return"Appearance"},get_title:function(){return!1},property:function(e,t,n){return typeof t!="undefined"?(typeof n=="undefined"&&(n=!0),this.model.set_property(e,t,n)):this.model.get_property_value_by_name(e)},render:function(){o.__super__.render.apply(this,arguments),_.delay(function(e){e.setColorChooserVisibility()},1,this)}});Upfront.Application.LayoutEditor.add_object("Uaccordion",{Model:n,View:r,Element:i,Settings:s,anchor:{is_target:!1}}),Upfront.Models.UaccordionModel=n,Upfront.Views.UaccordionView=r})}(jQuery),function(e){function r(e,t){return new r.prototype.init(e,t)}var t=0,n=function(e){return this[0]=e.startOffset,this[1]=e.endOffset,this.range=e,this};n.prototype.equals=function(){return this[0]===this[1]},e.fn.redactor=function(t){var n=[],i=Array.prototype.slice.call(arguments,1);return typeof t=="string"?this.each(function(){var r=e.data(this,"redactor");if(typeof r=="undefined"||!e.isFunction(r[t]))return e.error('No such method "'+t+'" for Redactor');var s=r[t].apply(r,i);s!==undefined&&s!==r&&n.push(s)}):this.each(function(){e.data(this,"redactor")||e.data(this,"redactor",r(this,t))}),n.length===0?this:n.length===1?n[0]:n},e.Redactor=r,e.Redactor.VERSION="9.1.8",e.Redactor.opts={rangy:!1,iframe:!1,fullpage:!1,css:!1,lang:"en",direction:"ltr",placeholder:!1,wym:!1,mobile:!0,cleanup:!0,tidyHtml:!0,pastePlainText:!1,removeEmptyTags:!0,templateVars:!1,xhtml:!1,visual:!0,focus:!1,tabindex:!1,autoresize:!0,minHeight:!1,maxHeight:!1,shortcuts:!0,autosave:!1,autosaveInterval:60,plugins:!1,linkAnchor:!0,linkEmail:!0,linkProtocol:"http://",linkNofollow:!1,linkSize:50,imageFloatMargin:"10px",imageGetJson:!1,imageUpload:!1,imageUploadParam:"file",fileUpload:!1,fileUploadParam:"file",clipboardUpload:!0,clipboardUploadUrl:!1,dragUpload:!0,dnbImageTypes:["image/png","image/jpeg","image/gif"],s3:!1,uploadFields:!1,observeImages:!0,observeLinks:!0,modalOverlay:!0,tabSpaces:!1,tabFocus:!0,air:!1,airButtons:["formatting","|","bold","italic","deleted","|","unorderedlist","orderedlist","outdent","indent"],toolbar:!0,toolbarFixed:!1,toolbarFixedTarget:document,toolbarFixedTopOffset:0,toolbarFixedBox:!1,toolbarExternal:!1,buttonSource:!0,buttonSeparator:'<li class="redactor_separator"></li>',buttonsCustom:{},buttonsAdd:[],buttons:["html","|","formatting","|","bold","italic","deleted","|","unorderedlist","orderedlist","outdent","indent","|","image","video","file","table","link","|","alignment","|","horizontalrule"],activeButtons:["deleted","italic","bold","underline","unorderedlist","orderedlist","alignleft","aligncenter","alignright","justify","table"],activeButtonsStates:{b:"bold",strong:"bold",i:"italic",em:"italic",del:"deleted",strike:"deleted",ul:"unorderedlist",ol:"orderedlist",u:"underline",tr:"table",td:"table",table:"table"},activeButtonsAdd:!1,formattingTags:["p","blockquote","pre","h1","h2","h3","h4","h5","h6"],linebreaks:!1,paragraphy:!0,convertDivs:!0,convertLinks:!0,convertImageLinks:!1,convertVideoLinks:!1,formattingPre:!1,phpTags:!1,allowedTags:!1,deniedTags:["html","head","link","body","meta","script","style","applet"],boldTag:"strong",italicTag:"em",indentValue:20,buffer:[],rebuffer:[],textareamode:!1,emptyHtml:"<p>&#x200b;</p>",invisibleSpace:"&#x200b;",rBlockTest:/^(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)$/i,alignmentTags:["P","H1","H2","H3","H4","H5","H6","DD","DL","DT","DIV","TD","BLOCKQUOTE","OUTPUT","FIGCAPTION","ADDRESS","SECTION","HEADER","FOOTER","ASIDE","ARTICLE"],ownLine:["area","body","head","hr","i?frame","link","meta","noscript","style","script","table","tbody","thead","tfoot"],contOwnLine:["li","dt","dt","h[1-6]","option","script"],newLevel:["blockquote","div","dl","fieldset","form","frameset","map","ol","p","pre","select","td","th","tr","ul"],blockLevelElements:["P","H1","H2","H3","H4","H5","H6","DD","DL","DT","DIV","LI","BLOCKQUOTE","OUTPUT","FIGCAPTION","PRE","ADDRESS","SECTION","HEADER","FOOTER","ASIDE","ARTICLE","TD"],langs:{en:{html:"HTML",video:"Insert Video",image:"Insert Image",table:"Table",link:"Link",link_insert:"Insert link",link_edit:"Edit link",unlink:"Unlink",formatting:"Formatting",paragraph:"Normal text",quote:"Quote",code:"Code",header1:"Header 1",header2:"Header 2",header3:"Header 3",header4:"Header 4",header5:"Header 5",bold:"Bold",italic:"Italic",fontcolor:"Font Color",backcolor:"Back Color",unorderedlist:"Unordered List",orderedlist:"Ordered List",outdent:"Outdent",indent:"Indent",cancel:"Cancel",insert:"Insert",save:"Save",_delete:"Delete",insert_table:"Insert Table",insert_row_above:"Add Row Above",insert_row_below:"Add Row Below",insert_column_left:"Add Column Left",insert_column_right:"Add Column Right",delete_column:"Delete Column",delete_row:"Delete Row",delete_table:"Delete Table",rows:"Rows",columns:"Columns",add_head:"Add Head",delete_head:"Delete Head",title:"Title",image_position:"Position",none:"None",left:"Left",right:"Right",image_web_link:"Image Web Link",text:"Text",mailto:"Email",web:"URL",video_html_code:"Video Embed Code",file:"Insert File",upload:"Upload",download:"Download",choose:"Choose",or_choose:"Or choose",drop_file_here:"Drop file here",align_left:"Align text to the left",align_center:"Center text",align_right:"Align text to the right",align_justify:"Justify text",horizontalrule:"Insert Horizontal Rule",deleted:"Deleted",anchor:"Anchor",link_new_tab:"Open link in new tab",underline:"Underline",alignment:"Alignment",filename:"Name (optional)",edit:"Edit"}}},r.fn=e.Redactor.prototype={keyCode:{BACKSPACE:8,DELETE:46,DOWN:40,ENTER:13,ESC:27,TAB:9,CTRL:17,META:91,LEFT:37,LEFT_WIN:91},init:function(n,r){this.rtePaste=!1,this.$element=this.$source=e(n),this.uuid=t++;var s=e.extend(!0,{},e.Redactor.opts);this.opts=e.extend({},s,this.$element.data(),r),this.start=!0,this.dropdowns=[],this.sourceHeight=this.$source.css("height"),this.sourceWidth=this.$source.css("width"),this.opts.fullpage&&(this.opts.iframe=!0),this.opts.linebreaks&&(this.opts.paragraphy=!1),this.opts.paragraphy&&(this.opts.linebreaks=!1),this.opts.toolbarFixedBox&&(this.opts.toolbarFixed=!0),this.document=document,this.window=window,this.savedSel=!1,this.cleanlineBefore=new RegExp("^<(/?"+this.opts.ownLine.join("|/?")+"|"+this.opts.contOwnLine.join("|")+")[ >]"),this.cleanlineAfter=new RegExp("^<(br|/?"+this.opts.ownLine.join("|/?")+"|/"+this.opts.contOwnLine.join("|/")+")[ >]"),this.cleannewLevel=new RegExp("^</?("+this.opts.newLevel.join("|")+")[ >]"),this.rTestBlock=new RegExp("^("+this.opts.blockLevelElements.join("|")+")$","i");if(this.opts.linebreaks===!1){if(this.opts.allowedTags!==!1){var o=["strong","em","del"],u=["b","i","strike"];e.inArray("p",this.opts.allowedTags)==="-1"&&this.opts.allowedTags.push("p");for(i in o)e.inArray(o[i],this.opts.allowedTags)!="-1"&&this.opts.allowedTags.push(u[i])}if(this.opts.deniedTags!==!1){var a=e.inArray("p",this.opts.deniedTags);a!=="-1"&&this.opts.deniedTags.splice(a,a)}}if(this.browser("msie")||this.browser("opera"))this.opts.buttons=this.removeFromArrayByValue(this.opts.buttons,"horizontalrule");this.opts.curLang=this.opts.langs[this.opts.lang],this.buildStart()},toolbarInit:function(e){return{html:{title:e.html,func:"toggle"},formatting:{title:e.formatting,func:"show",dropdown:{p:{title:e.paragraph,func:"formatBlocks"},blockquote:{title:e.quote,func:"formatQuote",className:"redactor_format_blockquote"},pre:{title:e.code,func:"formatBlocks",className:"redactor_format_pre"},h1:{title:e.header1,func:"formatBlocks",className:"redactor_format_h1"},h2:{title:e.header2,func:"formatBlocks",className:"redactor_format_h2"},h3:{title:e.header3,func:"formatBlocks",className:"redactor_format_h3"},h4:{title:e.header4,func:"formatBlocks",className:"redactor_format_h4"},h5:{title:e.header5,func:"formatBlocks",className:"redactor_format_h5"}}},bold:{title:e.bold,exec:"bold"},italic:{title:e.italic,exec:"italic"},deleted:{title:e.deleted,exec:"strikethrough"},underline:{title:e.underline,exec:"underline"},unorderedlist:{title:"&bull; "+e.unorderedlist,exec:"insertunorderedlist"},orderedlist:{title:"1. "+e.orderedlist,exec:"insertorderedlist"},outdent:{title:"< "+e.outdent,func:"indentingOutdent"},indent:{title:"> "+e.indent,func:"indentingIndent"},image:{title:e.image,func:"imageShow"},video:{title:e.video,func:"videoShow"},file:{title:e.file,func:"fileShow"},table:{title:e.table,func:"show",dropdown:{insert_table:{title:e.insert_table,func:"tableShow"},separator_drop1:{name:"separator"},insert_row_above:{title:e.insert_row_above,func:"tableAddRowAbove"},insert_row_below:{title:e.insert_row_below,func:"tableAddRowBelow"},insert_column_left:{title:e.insert_column_left,func:"tableAddColumnLeft"},insert_column_right:{title:e.insert_column_right,func:"tableAddColumnRight"},separator_drop2:{name:"separator"},add_head:{title:e.add_head,func:"tableAddHead"},delete_head:{title:e.delete_head,func:"tableDeleteHead"},separator_drop3:{name:"separator"},delete_column:{title:e.delete_column,func:"tableDeleteColumn"},delete_row:{title:e.delete_row,func:"tableDeleteRow"},delete_table:{title:e.delete_table,func:"tableDeleteTable"}}},link:{title:e.link,func:"show",dropdown:{link:{title:e.link_insert,func:"linkShow"},unlink:{title:e.unlink,exec:"unlink"}}},fontcolor:{title:e.fontcolor,func:"show"},backcolor:{title:e.backcolor,func:"show"},alignment:{title:e.alignment,func:"show",dropdown:{alignleft:{title:e.align_left,func:"alignmentLeft"},aligncenter:{title:e.align_center,func:"alignmentCenter"},alignright:{title:e.align_right,func:"alignmentRight"},justify:{title:e.align_justify,func:"alignmentJustify"}}},alignleft:{title:e.align_left,func:"alignmentLeft"},aligncenter:{title:e.align_center,func:"alignmentCenter"},alignright:{title:e.align_right,func:"alignmentRight"},justify:{title:e.align_justify,func:"alignmentJustify"},horizontalrule:{exec:"inserthorizontalrule",title:e.horizontalrule}}},callback:function(t,n,r){var i=this.opts[t+"Callback"];return e.isFunction(i)?n===!1?i.call(this,r):i.call(this,n,r):r},destroy:function(){clearInterval(this.autosaveInterval),e(window).off(".redactor"),this.$source.off("redactor-textarea"),this.$element.off(".redactor").removeData("redactor");var t=this.get();if(this.opts.textareamode)this.$box.after(this.$source),this.$box.remove(),this.$source.val(t).show();else{var n=this.$editor;this.opts.iframe&&(n=this.$element),this.$box.after(n),this.$box.remove(),n.removeClass("redactor_editor").removeClass("redactor_editor_wym").removeAttr("contenteditable").html(t).show()}this.opts.air&&e("#redactor_air_"+this.uuid).remove()},getObject:function(){return e.extend({},this)},getEditor:function(){return this.$editor},getBox:function(){return this.$box},getIframe:function(){return this.opts.iframe?this.$frame:!1},getToolbar:function(){return this.$toolbar?this.$toolbar:!1},get:function(){return this.$source.val()},getCodeIframe:function(){this.$editor.removeAttr("contenteditable").removeAttr("dir");var e=this.outerHtml(this.$frame.contents().children());return this.$editor.attr({contenteditable:!0,dir:this.opts.direction}),e},set:function(e,t,n){e=e.toString(),this.opts.fullpage?this.setCodeIframe(e):this.setEditor(e,t),e==""&&(n=!1),n!==!1&&this.placeholderRemove()},setEditor:function(e,t){t!==!1&&(e=this.cleanSavePreCode(e),e=this.cleanStripTags(e),e=this.cleanConvertProtected(e),e=this.cleanConvertInlineTags(e,!0),this.opts.linebreaks===!1?e=this.cleanConverters(e):e=e.replace(/<p(.*?)>([\w\W]*?)<\/p>/gi,"$2<br>")),e=this.cleanEmpty(e),this.$editor.html(e),this.setNonEditable(),this.setSpansVerified(),this.sync()},setCodeIframe:function(e){var t=this.iframePage();this.$frame[0].src="about:blank",e=this.cleanConvertProtected(e),e=this.cleanConvertInlineTags(e),e=this.cleanRemoveSpaces(e),t.open(),t.write(e),t.close(),this.opts.fullpage&&(this.$editor=this.$frame.contents().find("body").attr({contenteditable:!0,dir:this.opts.direction})),this.setNonEditable(),this.setSpansVerified(),this.sync()},setFullpageOnInit:function(e){e=this.cleanSavePreCode(e,!0),e=this.cleanConverters(e),e=this.cleanEmpty(e),this.$editor.html(e),this.setNonEditable(),this.setSpansVerified(),this.sync()},setSpansVerified:function(){var t=this.$editor.find("span"),n="inline";e.each(t,function(){var t=this.outerHTML,r=new RegExp("<"+this.tagName,"gi"),i=t.replace(r,"<"+n);r=new RegExp("</"+this.tagName,"gi"),i=i.replace(r,"</"+n),e(this).replaceWith(i)})},setSpansVerifiedHtml:function(e){return e=e.replace(/<span(.*?)>/,"<inline$1>"),e.replace(/<\/span>/,"</inline>")},setNonEditable:function(){this.$editor.find(".noneditable").attr("contenteditable",!1)},sync:function(){var t="";this.cleanUnverified(),this.opts.fullpage?t=this.getCodeIframe():t=this.$editor.html(),t=this.syncClean(t),t=this.cleanRemoveEmptyTags(t),t=t.replace(/<\/li><(ul|ol)>([\w\W]*?)<\/(ul|ol)>/gi,"<$1>$2</$1></li>"),e.trim(t)==="<br>"&&(t="");if(this.opts.xhtml){var n=["br","hr","img","link","input","meta"];e.each(n,function(e,n){t=t.replace(new RegExp("<"+n+"(.*?[^/$]?)>","gi"),"<"+n+"$1 />")})}t=this.callback("syncBefore",!1,t),this.$source.val(t),this.callback("syncAfter",!1,t),this.start===!1&&this.callback("change",!1,t)},syncClean:function(t){return this.opts.fullpage||(t=this.cleanStripTags(t)),t=e.trim(t),t=this.placeholderRemoveFromCode(t),t=t.replace(/&#x200b;/gi,""),t=t.replace(/&#8203;/gi,""),t=t.replace(/<\/a>&nbsp;/gi,"</a> "),this.opts.linkNofollow&&(t=t.replace(/<a(.*?)rel="nofollow"(.*?)>/gi,"<a$1$2>"),t=t.replace(/<a(.*?)>/gi,'<a$1 rel="nofollow">')),t=t.replace("<!--?php","<?php"),t=t.replace("?-->","?>"),t=t.replace(/<(.*?)class="noeditable"(.*?) contenteditable="false"(.*?)>/gi,'<$1class="noeditable"$2$3>'),t=t.replace(/ data-tagblock=""/gi,""),t=t.replace(/<br\s?\/?>\n?<\/(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)>/gi,"</$1>"),t=t.replace(/<span(.*?)id="redactor-image-box"(.*?)>([\w\W]*?)<img(.*?)><\/span>/i,"$3<img$4>"),t=t.replace(/<span(.*?)id="redactor-image-resizer"(.*?)>(.*?)<\/span>/i,""),t=t.replace(/<span(.*?)id="redactor-image-editter"(.*?)>(.*?)<\/span>/i,""),t=t.replace(/<font(.*?)>([\w\W]*?)<\/font>/gi,"$2"),t=t.replace(/<span(.*?)>([\w\W]*?)<\/span>/gi,"$2"),t=t.replace(/<inline>/gi,"<span>"),t=t.replace(/<inline /gi,"<span "),t=t.replace(/<\/inline>/gi,"</span>"),t=t.replace(/<span(.*?)class="redactor_placeholder"(.*?)>([\w\W]*?)<\/span>/gi,""),t=t.replace(/&amp;/gi,"&"),t=t.replace(//gi,"&trade;"),t=t.replace(//gi,"&copy;"),t=this.cleanReConvertProtected(t),t},buildStart:function(){this.content="",this.$box=e('<div class="redactor_box" />'),this.$source[0].tagName==="TEXTAREA"&&(this.opts.textareamode=!0),this.opts.mobile===!1&&this.isMobile()?this.buildMobile():(this.buildContent(),this.opts.iframe?(this.opts.autoresize=!1,this.iframeStart()):this.opts.textareamode?this.buildFromTextarea():this.buildFromElement(),this.opts.iframe||(this.buildOptions(),this.buildAfter()))},buildMobile:function(){this.opts.textareamode||(this.$editor=this.$source,this.$editor.hide(),this.$source=this.buildCodearea(this.$editor),this.$source.val(this.content)),this.$box.insertAfter(this.$source).append(this.$source)},buildContent:function(){this.opts.textareamode?this.content=e.trim(this.$source.val()):this.content=e.trim(this.$source.html())},buildFromTextarea:function(){this.$editor=e("<div />"),this.$box.insertAfter(this.$source).append(this.$editor).append(this.$source),this.buildAddClasses(this.$editor),this.buildEnable()},buildFromElement:function(){this.$editor=this.$source,this.$source=this.buildCodearea(this.$editor),this.$box.insertAfter(this.$editor).append(this.$editor).append(this.$source),this.buildEnable()},buildCodearea:function(t){return e("<textarea />").attr("name",t.attr("id")).css("height",this.sourceHeight)},buildAddClasses:function(t){e.each(this.$source.get(0).className.split(/\s+/),function(e,n){t.addClass("redactor_"+n)})},buildEnable:function(){this.$editor.addClass("redactor_editor").attr({contenteditable:!0,dir:this.opts.direction}),this.$source.attr("dir",this.opts.direction).hide(),this.set(this.content,!0,!1)},buildOptions:function(){var e=this.$editor;this.opts.iframe&&(e=this.$frame),this.opts.tabindex&&e.attr("tabindex",this.opts.tabindex),this.opts.minHeight&&e.css("min-height",this.opts.minHeight+"px"),this.opts.maxHeight&&(this.opts.autoresize=!1,e.css("max-height",this.opts.maxHeight+"px")),this.opts.wym&&this.$editor.addClass("redactor_editor_wym"),this.opts.autoresize||e.css("height",this.sourceHeight)},buildAfter:function(){this.start=!1,this.opts.toolbar&&(this.opts.toolbar=this.toolbarInit(this.opts.curLang),this.toolbarBuild()),this.modalTemplatesInit(),this.buildPlugins(),this.buildBindKeyboard(),this.opts.autosave&&this.autosave(),setTimeout(e.proxy(this.observeStart,this),4);if(this.browser("mozilla"))try{this.document.execCommand("enableObjectResizing",!1,!1),this.document.execCommand("enableInlineTableEditing",!1,!1)}catch(t){}this.opts.focus&&setTimeout(e.proxy(this.focus,this),100),this.opts.visual||setTimeout(e.proxy(function(){this.opts.visual=!0,this.toggle(!1)},this),200),this.callback("init")},buildBindKeyboard:function(){this.dblEnter=0,this.opts.dragUpload&&this.opts.imageUpload!==!1&&this.$editor.on("drop.redactor",e.proxy(this.buildEventDrop,this)),this.$editor.on("paste.redactor",e.proxy(this.buildEventPaste,this)),this.$editor.on("keydown.redactor",e.proxy(this.buildEventKeydown,this)),this.$editor.on("keyup.redactor",e.proxy(this.buildEventKeyup,this)),e.isFunction(this.opts.textareaKeydownCallback)&&this.$source.on("keydown.redactor-textarea",e.proxy(this.opts.textareaKeydownCallback,this)),e.isFunction(this.opts.focusCallback)&&this.$editor.on("focus.redactor",e.proxy(this.opts.focusCallback,this));var t;e(document).mousedown(function(n){t=e(n.target)}),this.$editor.on("blur.redactor",e.proxy(function(n){!e(t).hasClass("redactor_toolbar")&&e(t).parents(".redactor_toolbar").size()==0&&(this.selectall=!1,e.isFunction(this.opts.blurCallback)&&this.callback("blur",n))},this))},buildEventDrop:function(t){t=t.originalEvent||t;if(window.FormData===undefined||!t.dataTransfer)return!0;var n=t.dataTransfer.files.length;if(n==0)return!0;t.preventDefault();var r=t.dataTransfer.files[0];if(this.opts.dnbImageTypes!==!1&&this.opts.dnbImageTypes.indexOf(r.type)==-1)return!0;this.bufferSet();var i=e('<div id="redactor-progress-drag" class="redactor-progress redactor-progress-striped"><div id="redactor-progress-bar" class="redactor-progress-bar" style="width: 100%;"></div></div>');e(document.body).append(i),this.opts.s3===!1?this.dragUploadAjax(this.opts.imageUpload,r,!0,i,t,this.opts.imageUploadParam):this.s3uploadFile(r)},buildEventPaste:function(t){var n=!1;if(this.browser("webkit")&&navigator.userAgent.indexOf("Chrome")===-1){var r=this.browser("version").split(".");r[0]<536&&(n=!0)}if(n)return!0;if(this.browser("opera"))return!0;if(this.opts.clipboardUpload&&this.buildEventClipboardUpload(t))return!0;if(this.opts.cleanup){this.rtePaste=!0,this.selectionSave(),this.selectall||(this.opts.autoresize===!0&&this.fullscreen!==!0?(this.$editor.height(this.$editor.height()),this.saveScroll=this.document.body.scrollTop):this.saveScroll=this.$editor.scrollTop());var i=this.extractContent();setTimeout(e.proxy(function(){var e=this.extractContent();this.$editor.append(i),this.selectionRestore();var t=this.getFragmentHtml(e);this.pasteClean(t),this.opts.autoresize===!0&&this.fullscreen!==!0&&this.$editor.css("height","auto")},this),1)}},buildEventClipboardUpload:function(t){var n=t.originalEvent||t;this.clipboardFilePaste=!1;if(typeof n.clipboardData=="undefined")return!1;if(n.clipboardData.items){var r=n.clipboardData.items[0].getAsFile();if(r!==null){this.bufferSet(),this.clipboardFilePaste=!0;var i=new FileReader;return i.onload=e.proxy(this.pasteClipboardUpload,this),i.readAsDataURL(r),!0}}return!1},buildEventKeydown:function(t){if(this.rtePaste)return!1;var n=t.which,r=t.ctrlKey||t.metaKey,i=this.getParent(),s=this.getCurrent(),o=this.getBlock(),u=!1;this.callback("keydown",t),this.imageResizeHide(!1);if(i&&e(i).get(0).tagName==="PRE"||s&&e(s).get(0).tagName==="PRE")u=!0,n===this.keyCode.DOWN&&this.insertAfterLastElement(o);n===this.keyCode.DOWN&&(i&&e(i)[0].tagName==="BLOCKQUOTE"&&this.insertAfterLastElement(i),s&&e(s)[0].tagName==="BLOCKQUOTE"&&this.insertAfterLastElement(s),i&&e(i)[0].tagName==="P"&&e(i).parent()[0].tagName=="BLOCKQUOTE"&&this.insertAfterLastElement(i,e(i).parent()[0]),s&&e(s)[0].tagName==="P"&&i&&e(i)[0].tagName=="BLOCKQUOTE"&&this.insertAfterLastElement(s,i)),r&&!t.shiftKey&&this.shortcuts(t,n);if(r&&n===90&&!t.shiftKey&&!t.altKey){t.preventDefault(),this.opts.buffer.length?this.bufferUndo():this.document.execCommand("undo",!1,!1);return}if(r&&n===90&&t.shiftKey&&!t.altKey){t.preventDefault(),this.opts.rebuffer.length!=0?this.bufferRedo():this.document.execCommand("redo",!1,!1);return}r&&n===65?this.selectall=!0:n!=this.keyCode.LEFT_WIN&&!r&&(this.selectall=!1);if(n==this.keyCode.ENTER&&!t.shiftKey&&!t.ctrlKey&&!t.metaKey){if(!(!this.browser("msie")||i.nodeType!=1||i.tagName!="TD"&&i.tagName!="TH"))return t.preventDefault(),this.bufferSet(),this.insertNode(document.createElement("br")),this.callback("enter",t),!1;if(o&&(o.tagName=="BLOCKQUOTE"||e(o).parent()[0].tagName=="BLOCKQUOTE"))if(this.isEndOfElement()){if(this.dblEnter==1){var a,f;o.tagName=="BLOCKQUOTE"?(f="br",a=o):(f="p",a=e(o).parent()[0]),t.preventDefault(),this.insertingAfterLastElement(a),this.dblEnter=0;if(f=="p")e(o).parent().find("p").last().remove();else{var l=e.trim(e(o).html());e(o).html(l.replace(/<br\s?\/?>$/i,""))}return}this.dblEnter++}else this.dblEnter++;if(u===!0)return this.buildEventKeydownPre(t,s);if(!this.opts.linebreaks)if(o&&this.opts.rBlockTest.test(o.tagName))this.bufferSet(),setTimeout(e.proxy(function(){var t=this.getBlock();if(t.tagName==="DIV"&&!e(t).hasClass("redactor_editor")){var n=e("<p>"+this.opts.invisibleSpace+"</p>");e(t).replaceWith(n),this.selectionStart(n)}},this),1);else if(o===!1){this.bufferSet();var c=e("<p>"+this.opts.invisibleSpace+"</p>");return this.insertNode(c[0]),this.selectionStart(c),this.callback("enter",t),!1}if(this.opts.linebreaks){if(!o||!this.opts.rBlockTest.test(o.tagName))return this.buildEventKeydownInsertLineBreak(t);this.bufferSet(),setTimeout(e.proxy(function(){var t=this.getBlock();(t.tagName==="DIV"||t.tagName==="P")&&!e(t).hasClass("redactor_editor")&&this.replaceLineBreak(t)},this),1)}if(o.tagName=="BLOCKQUOTE"||o.tagName=="FIGCAPTION")return this.buildEventKeydownInsertLineBreak(t);this.callback("enter",t)}else n===this.keyCode.ENTER&&(t.ctrlKey||t.shiftKey)&&(this.bufferSet(),t.preventDefault(),this.insertLineBreak());if(n===this.keyCode.TAB&&this.opts.shortcuts)return this.buildEventKeydownTab(t,u);n===this.keyCode.BACKSPACE&&this.buildEventKeydownBackspace(s)},buildEventKeydownPre:function(t,n){t.preventDefault(),this.bufferSet();var r=e(n).parent().text();return this.insertNode(document.createTextNode("\n")),r.search(/\s$/)==-1&&this.insertNode(document.createTextNode("\n")),this.sync(),this.callback("enter",t),!1},buildEventKeydownTab:function(e,t){return this.opts.tabFocus?this.isEmpty(this.get())&&this.opts.tabSpaces===!1?!0:(e.preventDefault(),t===!0&&!e.shiftKey?(this.bufferSet(),this.insertNode(document.createTextNode("	")),this.sync(),!1):this.opts.tabSpaces!==!1?(this.bufferSet(),this.insertNode(document.createTextNode(Array(this.opts.tabSpaces+1).join(""))),this.sync(),!1):(e.shiftKey?this.indentingOutdent():this.indentingIndent(),!1)):!0},buildEventKeydownBackspace:function(t){if(typeof t.tagName!="undefined"&&/^(H[1-6])$/i.test(t.tagName)){var n;this.opts.linebreaks===!1?n=e("<p>"+this.opts.invisibleSpace+"</p>"):n=e("<br>"+this.opts.invisibleSpace),e(t).replaceWith(n),this.selectionStart(n)}typeof t.nodeValue!="undefined"&&t.nodeValue!==null&&t.remove&&t.nodeType===3&&t.nodeValue.match(/[^/\u200B]/g)==null&&t.remove()},buildEventKeydownInsertLineBreak:function(e){this.bufferSet(),e.preventDefault(),this.insertLineBreak(),this.callback("enter",e);return},buildEventKeyup:function(t){if(this.rtePaste)return!1;var n=t.which,r=this.getParent(),i=this.getCurrent();if(!this.opts.linebreaks&&i.nodeType==3&&(r==0||r.tagName=="BODY")){var s=e("<p>").append(e(i).clone());e(i).replaceWith(s);var o=e(s).next();typeof o[0]!="undefined"&&o[0].tagName=="BR"&&o.remove(),this.selectionEnd(s)}(this.opts.convertLinks||this.opts.convertImageLinks||this.opts.convertVideoLinks)&&n===this.keyCode.ENTER&&this.buildEventKeyupConverters();if(n===this.keyCode.DELETE||n===this.keyCode.BACKSPACE)return this.formatEmpty(t);this.callback("keyup",t),this.sync()},buildEventKeyupConverters:function(){this.formatLinkify(this.opts.linkProtocol,this.opts.convertLinks,this.opts.convertImageLinks,this.opts.convertVideoLinks,this.opts.linkSize),setTimeout(e.proxy(function(){this.opts.convertImageLinks&&this.observeImages(),this.opts.observeLinks&&this.observeLinks()},this),5)},buildPlugins:function(){if(!this.opts.plugins)return;e.each(this.opts.plugins,e.proxy(function(t,n){RedactorPlugins[n]&&(e.extend(this,RedactorPlugins[n]),e.isFunction(RedactorPlugins[n].init)&&this.init())},this))},iframeStart:function(){this.iframeCreate(),this.opts.textareamode?this.iframeAppend(this.$source):(this.$sourceOld=this.$source.hide(),this.$source=this.buildCodearea(this.$sourceOld),this.iframeAppend(this.$sourceOld))},iframeAppend:function(e){this.$source.attr("dir",this.opts.direction).hide(),this.$box.insertAfter(e).append(this.$frame).append(this.$source)},iframeCreate:function(){this.$frame=e('<iframe style="width: 100%;" frameborder="0" />').one("load",e.proxy(function(){if(this.opts.fullpage){this.iframePage(),this.content===""&&(this.content=this.opts.invisibleSpace),this.$frame.contents()[0].write(this.content),this.$frame.contents()[0].close();var t=setInterval(e.proxy(function(){this.$frame.contents().find("body").html()&&(clearInterval(t),this.iframeLoad())},this),0)}else this.iframeLoad()},this))},iframeDoc:function(){return this.$frame[0].contentWindow.document},iframePage:function(){var e=this.iframeDoc();return e.documentElement&&e.removeChild(e.documentElement),e},iframeAddCss:function(t){t=t||this.opts.css,this.isString(t)&&this.$frame.contents().find("head").append('<link rel="stylesheet" href="'+t+'" />'),e.isArray(t)&&e.each(t,e.proxy(function(e,t){this.iframeAddCss(t)},this))},iframeLoad:function(){this.$editor=this.$frame.contents().find("body").attr({contenteditable:!0,dir:this.opts.direction}),this.$editor[0]&&(this.document=this.$editor[0].ownerDocument,this.window=this.document.defaultView||window),this.iframeAddCss(),this.opts.fullpage?this.setFullpageOnInit(this.$editor.html()):this.set(this.content,!0,!1),this.buildOptions(),this.buildAfter()},placeholderStart:function(t){if(this.isEmpty(t)){this.$element.attr("placeholder")&&(this.opts.placeholder=this.$element.attr("placeholder")),this.opts.placeholder===""&&(this.opts.placeholder=!1);if(this.opts.placeholder!==!1)return this.opts.focus=!1,this.$editor.one("focus.redactor_placeholder",e.proxy(this.placeholderFocus,this)),e('<span class="redactor_placeholder" data-redactor="verified">').attr("contenteditable",!1).text(this.opts.placeholder)}return!1},placeholderFocus:function(){this.$editor.find("span.redactor_placeholder").remove();var e="";this.opts.linebreaks===!1&&(e=this.opts.emptyHtml),this.$editor.off("focus.redactor_placeholder"),this.$editor.html(e),this.opts.linebreaks===!1?this.selectionStart(this.$editor.children()[0]):this.focus(),this.sync()},placeholderRemove:function(){this.opts.placeholder=!1,this.$editor.find("span.redactor_placeholder").remove(),this.$editor.off("focus.redactor_placeholder")},placeholderRemoveFromCode:function(e){return e.replace(/<span class="redactor_placeholder"(.*?)>(.*?)<\/span>/i,"")},shortcuts:function(e,t){if(!this.opts.shortcuts)return;e.altKey?t===48?this.shortcutsLoadFormat(e,"p"):t===49?this.shortcutsLoadFormat(e,"h1"):t===50?this.shortcutsLoadFormat(e,"h2"):t===51?this.shortcutsLoadFormat(e,"h3"):t===52?this.shortcutsLoadFormat(e,"h4"):t===53?this.shortcutsLoadFormat(e,"h5"):t===54&&this.shortcutsLoadFormat(e,"h6"):t===77?this.shortcutsLoad(e,"removeFormat"):t===66?this.shortcutsLoad(e,"bold"):t===73?this.shortcutsLoad(e,"italic"):t===74?this.shortcutsLoad(e,"insertunorderedlist"):t===75?this.shortcutsLoad(e,"insertorderedlist"):t===72?this.shortcutsLoad(e,"superscript"):t===76&&this.shortcutsLoad(e,"subscript")},shortcutsLoad:function(e,t){e.preventDefault(),this.execCommand(t,!1)},shortcutsLoadFormat:function(e,t){e.preventDefault(),this.formatBlocks(t)},focus:function(){this.browser("opera")?this.$editor.focus():this.window.setTimeout(e.proxy(this.focusSet,this,!0),1)},focusEnd:function(){this.focusSet()},focusSet:function(e){this.$editor.focus();var t=this.getRange();t.selectNodeContents(this.$editor[0]),t.collapse(e||!1);var n=this.getSelection();n.removeAllRanges(),n.addRange(t)},toggle:function(e){this.opts.visual?this.toggleCode(e):this.toggleVisual()},toggleVisual:function(){var e=this.$source.hide().val();typeof this.modified!="undefined"&&(this.modified=this.cleanRemoveSpaces(this.modified,!1)!==this.cleanRemoveSpaces(e,!1)),this.modified&&(this.opts.fullpage&&e===""?this.setFullpageOnInit(e):(this.set(e),this.opts.fullpage&&this.buildBindKeyboard())),this.opts.iframe?this.$frame.show():this.$editor.show(),this.opts.fullpage&&this.$editor.attr("contenteditable",!0),this.$source.off("keydown.redactor-textarea-indenting"),this.$editor.focus(),this.selectionRestore(),this.observeStart(),this.buttonActiveVisual(),this.buttonInactive("html"),this.opts.visual=!0},toggleCode:function(e){e!==!1&&this.selectionSave();var t=null;this.opts.iframe?(t=this.$frame.height(),this.opts.fullpage&&this.$editor.removeAttr("contenteditable"),this.$frame.hide()):(t=this.$editor.innerHeight(),this.$editor.hide());var n=this.$source.val();n!==""&&this.opts.tidyHtml&&this.$source.val(this.cleanHtml(n)),this.modified=n,this.$source.height(t).show().focus(),this.$source.on("keydown.redactor-textarea-indenting",this.textareaIndenting),this.buttonInactiveVisual(),this.buttonActive("html"),this.opts.visual=!1},textareaIndenting:function(t){if(t.keyCode===9){var n=e(this),r=n.get(0).selectionStart;return n.val(n.val().substring(0,r)+"	"+n.val().substring(n.get(0).selectionEnd)),n.get(0).selectionStart=n.get(0).selectionEnd=r+1,!1}},autosave:function(){var t=!1;this.autosaveInterval=setInterval(e.proxy(function(){var n=this.get();t!==n&&e.ajax({url:this.opts.autosave,type:"post",data:this.$source.attr("name")+"="+escape(encodeURIComponent(n)),success:e.proxy(function(e){this.callback("autosave",!1,e),t=n},this)})},this),this.opts.autosaveInterval*1e3)},toolbarBuild:function(){if(this.opts.air)this.opts.buttons=this.opts.airButtons;else if(!this.opts.buttonSource){var t=this.opts.buttons.indexOf("html"),n=this.opts.buttons[t+1];this.opts.buttons.splice(t,1),n==="|"&&this.opts.buttons.splice(t,1)}e.extend(this.opts.toolbar,this.opts.buttonsCustom),e.each(this.opts.buttonsAdd,e.proxy(function(e,t){this.opts.buttons.push(t)},this)),this.opts.toolbar&&e.each(this.opts.toolbar.formatting.dropdown,e.proxy(function(t,n){e.inArray(t,this.opts.formattingTags)=="-1"&&delete this.opts.toolbar.formatting.dropdown[t]},this));if(this.opts.buttons.length===0)return!1;this.airEnable(),this.$toolbar=e("<ul>").addClass("redactor_toolbar").attr("id","redactor_toolbar_"+this.uuid),this.opts.air?(this.$air=e('<div class="redactor_air">').attr("id","redactor_air_"+this.uuid).hide(),this.$air.append(this.$toolbar),e("body").append(this.$air)):this.opts.toolbarExternal?e(this.opts.toolbarExternal).html(this.$toolbar):this.$box.prepend(this.$toolbar),e.each(this.opts.buttons,e.proxy(function(t,n){if(n==="|")this.$toolbar.append(e(this.opts.buttonSeparator));else if(this.opts.toolbar[n]){var r=this.opts.toolbar[n];if(this.opts.fileUpload===!1&&n==="file")return!0;this.$toolbar.append(e("<li>").append(this.buttonBuild(n,r)))}},this)),this.$toolbar.find("a").attr("tabindex","-1"),this.opts.toolbarFixed&&(this.toolbarObserveScroll(),e(this.opts.toolbarFixedTarget).on("scroll.redactor",e.proxy(this.toolbarObserveScroll,this)));if(this.opts.activeButtons){var r=e.proxy(this.buttonActiveObserver,this);this.$editor.on("mouseup.redactor keyup.redactor",r)}},toolbarObserveScroll:function(){var t=e(this.opts.toolbarFixedTarget).scrollTop(),n=this.$box.offset().top,r=0,i=n+this.$box.height()+40;if(t>n){var s="100%";this.opts.toolbarFixedBox&&(r=this.$box.offset().left,s=this.$box.innerWidth(),this.$toolbar.addClass("toolbar_fixed_box")),this.toolbarFixed=!0,this.$toolbar.css({position:"fixed",width:s,zIndex:1005,top:this.opts.toolbarFixedTopOffset+"px",left:r}),t<i?this.$toolbar.css("visibility","visible"):this.$toolbar.css("visibility","hidden")}else this.toolbarFixed=!1,this.$toolbar.css({position:"relative",width:"auto",top:0,left:r}),this.opts.toolbarFixedBox&&this.$toolbar.removeClass("toolbar_fixed_box")},airEnable:function(){if(!this.opts.air)return;this.$editor.on("mouseup.redactor keyup.redactor",this,e.proxy(function(t){var n=this.getSelectionText();t.type==="mouseup"&&n!=""&&this.airShow(t);if(t.type==="keyup"&&t.shiftKey&&n!=""){var r=e(this.getElement(this.getSelection().focusNode)),i=r.offset();i.height=r.height(),this.airShow(i,!0)}},this))},airShow:function(t,n){if(!this.opts.air)return;var r,i;e(".redactor_air").hide();if(n)r=t.left,i=t.top+t.height+14,this.opts.iframe&&(i+=this.$box.position().top-e(this.document).scrollTop(),r+=this.$box.position().left);else{var s=this.$air.innerWidth();r=t.clientX,e(this.document).width()<r+s&&(r-=s),i=t.clientY+14,this.opts.iframe?(i+=this.$box.position().top,r+=this.$box.position().left):i+=e(this.document).scrollTop()}this.$air.css({left:r+"px",top:i+"px"}).show(),this.airBindHide()},airBindHide:function(){if(!this.opts.air)return;var t=e.proxy(function(t){e(t).on("mousedown.redactor",e.proxy(function(n){e(n.target).closest(this.$toolbar).length===0&&(this.$air.fadeOut(100),this.selectionRemove(),e(t).off(n))},this)).on("keydown.redactor",e.proxy(function(n){n.which===this.keyCode.ESC&&this.getSelection().collapseToStart(),this.$air.fadeOut(100),e(t).off(n)},this))},this);t(document),this.opts.iframe&&t(this.document)},airBindMousemoveHide:function(){if(!this.opts.air)return;var t=e.proxy(function(t){e(t).on("mousemove.redactor",e.proxy(function(n){e(n.target).closest(this.$toolbar).length===0&&(this.$air.fadeOut(100),e(t).off(n))},this))},this);t(document),this.opts.iframe&&t(this.document)},dropdownBuild:function(t,n){e.each(n,e.proxy(function(n,r){r.className||(r.className="");var i;r.name==="separator"?i=e('<a class="redactor_separator_drop">'):(i=e('<a href="#" class="'+r.className+" redactor_dropdown_"+n+'">'+r.title+"</a>"),i.on("click",e.proxy(function(e){e.preventDefault&&e.preventDefault(),this.browser("msie")&&(e.returnValue=!1),r.callback&&r.callback.call(this,n,i,r,e),r.exec&&this.execCommand(r.exec,n),r.func&&this[r.func](n),this.buttonActiveObserver(),this.opts.air&&this.$air.fadeOut(100)},this))),t.append(i)},this))},dropdownShow:function(t,n){if(!this.opts.visual)return t.preventDefault(),!1;var r=this.$toolbar.find(".redactor_dropdown_box_"+n),i=this.buttonGet(n);if(i.hasClass("dropact"))this.dropdownHideAll();else{this.dropdownHideAll(),this.buttonActive(n),i.addClass("dropact");var s=i.position();this.toolbarFixed&&(s=i.offset());var o=r.width();s.left+o>e(document).width()&&(s.left-=o);var u=s.left+"px",a=29,f="absolute",l=a+"px";this.opts.toolbarFixed&&this.toolbarFixed?f="fixed":this.opts.air||(l=s.top+a+"px"),r.css({position:f,left:u,top:l}).show()}var c=e.proxy(function(e){this.dropdownHide(e,r)},this);e(document).one("click",c),this.$editor.one("click",c),t.stopPropagation()},dropdownHideAll:function(){this.$toolbar.find("a.dropact").removeClass("redactor_act").removeClass("dropact"),e(".redactor_dropdown").hide()},dropdownHide:function(t,n){e(t.target).hasClass("dropact")||(n.removeClass("dropact"),this.dropdownHideAll())},buttonBuild:function(t,n){var r=e('<a href="javascript:;" title="'+n.title+'" tabindex="-1" class="redactor_btn redactor_btn_'+t+'"></a>');r.on("click",e.proxy(function(e){e.preventDefault&&e.preventDefault(),this.browser("msie")&&(e.returnValue=!1);if(r.hasClass("redactor_button_disabled"))return!1;this.isFocused()===!1&&!n.exec&&this.$editor.focus(),n.exec?(this.$editor.focus(),this.execCommand(n.exec,t),this.airBindMousemoveHide()):n.func&&n.func!=="show"?(this[n.func](t),this.airBindMousemoveHide()):n.callback?(n.callback.call(this,t,r,n,e),this.airBindMousemoveHide()):n.dropdown&&this.dropdownShow(e,t),this.buttonActiveObserver(!1,t)},this));if(n.dropdown){var i=e('<div class="redactor_dropdown redactor_dropdown_box_'+t+'" style="display: none;">');i.appendTo(this.$toolbar),this.dropdownBuild(i,n.dropdown)}return r},buttonGet:function(t){return this.opts.toolbar?e(this.$toolbar.find("a.redactor_btn_"+t)):!1},buttonActiveToggle:function(e){var t=this.buttonGet(e);t.hasClass("redactor_act")?t.removeClass("redactor_act"):t.addClass("redactor_act")},buttonActive:function(e){this.buttonGet(e).addClass("redactor_act")},buttonInactive:function(e){this.buttonGet(e).removeClass("redactor_act")},buttonInactiveAll:function(t){e.each(this.opts.toolbar,e.proxy(function(e){e!=t&&this.buttonInactive(e)},this))},buttonActiveVisual:function(){this.$toolbar.find("a.redactor_btn").not("a.redactor_btn_html").removeClass("redactor_button_disabled")},buttonInactiveVisual:function(){this.$toolbar.find("a.redactor_btn").not("a.redactor_btn_html").addClass("redactor_button_disabled")},buttonChangeIcon:function(e,t){this.buttonGet(e).addClass("redactor_btn_"+t)},buttonRemoveIcon:function(e,t){this.buttonGet(e).removeClass("redactor_btn_"+t)},buttonAddSeparator:function(){this.$toolbar.append(e(this.opts.buttonSeparator))},buttonAddSeparatorAfter:function(t){this.buttonGet(t).parent().after(e(this.opts.buttonSeparator))},buttonAddSeparatorBefore:function(t){this.buttonGet(t).parent().before(e(this.opts.buttonSeparator))},buttonRemoveSeparatorAfter:function(e){this.buttonGet(e).parent().next().remove()},buttonRemoveSeparatorBefore:function(e){this.buttonGet(e).parent().prev().remove()},buttonSetRight:function(e){if(!this.opts.toolbar)return;this.buttonGet(e).parent().addClass("redactor_btn_right")},buttonSetLeft:function(e){if(!this.opts.toolbar)return;this.buttonGet(e).parent().removeClass("redactor_btn_right")},buttonAdd:function(t,n,r,i){if(!this.opts.toolbar)return;var s=this.buttonBuild(t,{title:n,callback:r,dropdown:i});this.$toolbar.append(e("<li>").append(s))},buttonAddFirst:function(t,n,r,i){if(!this.opts.toolbar)return;var s=this.buttonBuild(t,{title:n,callback:r,dropdown:i});this.$toolbar.prepend(e("<li>").append(s))},buttonAddAfter:function(t,n,r,i,s){if(!this.opts.toolbar)return;var o=this.buttonBuild(n,{title:r,callback:i,dropdown:s}),u=this.buttonGet(t);u.size()!==0?u.parent().after(e("<li>").append(o)):this.$toolbar.append(e("<li>").append(o))},buttonAddBefore:function(t,n,r,i,s){if(!this.opts.toolbar)return;var o=this.buttonBuild(n,{title:r,callback:i,dropdown:s}),u=this.buttonGet(t);u.size()!==0?u.parent().before(e("<li>").append(o)):this.$toolbar.append(e("<li>").append(o))},buttonRemove:function(e,t){var n=this.buttonGet(e);t&&n.parent().next().remove(),n.parent().removeClass("redactor_btn_right"),n.remove()},buttonActiveObserver:function(t,n){var r=this.getParent();this.buttonInactiveAll(n);if(t===!1&&n!=="html"){e.inArray(n,this.opts.activeButtons)!=-1&&this.buttonActiveToggle(n);return}r&&r.tagName==="A"?this.$toolbar.find("a.redactor_dropdown_link").text(this.opts.curLang.link_edit):this.$toolbar.find("a.redactor_dropdown_link").text(this.opts.curLang.link_insert),this.opts.activeButtonsAdd&&(e.each(this.opts.activeButtonsAdd,e.proxy(function(e,t){this.opts.activeButtons.push(t)},this)),e.extend(this.opts.activeButtonsStates,this.opts.activeButtonsAdd)),e.each(this.opts.activeButtonsStates,e.proxy(function(t,n){e(r).closest(t,this.$editor.get()[0]).length!=0&&this.buttonActive(n)},this));var i=e(r).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);if(i.length){var s=i.css("text-align");switch(s){case"right":this.buttonActive("alignright");break;case"center":this.buttonActive("aligncenter");break;case"justify":this.buttonActive("justify");break;default:this.buttonActive("alignleft")}}},exec:function(e,t,n){e==="formatblock"&&this.browser("msie")&&(t="<"+t+">"),e==="inserthtml"&&this.browser("msie")?(this.$editor.focus(),this.document.selection.createRange().pasteHTML(t)):this.document.execCommand(e,!1,t),n!==!1&&this.sync(),this.callback("execCommand",e,t)},execCommand:function(e,t,n){if(!this.opts.visual)return this.$source.focus(),!1;if(e==="inserthtml"){this.insertHtml(t,n),this.callback("execCommand",e,t);return}if(this.currentOrParentIs("PRE")&&!this.opts.formattingPre)return!1;if(e==="insertunorderedlist"||e==="insertorderedlist")return this.execLists(e,t);if(e==="unlink")return this.execUnlink(e,t);this.exec(e,t,n),e==="inserthorizontalrule"&&this.$editor.find("hr").removeAttr("id")},execUnlink:function(t,n){this.bufferSet();var r=this.currentOrParentIs("A");if(r){e(r).replaceWith(e(r).text()),this.sync(),this.callback("execCommand",t,n);return}},execLists:function(t,n){this.bufferSet();var r=this.getParent(),i=e(r).closest("ol, ul"),s=!1;if(i.length){s=!0;var o=i[0].tagName;if(t==="insertunorderedlist"&&o==="OL"||t==="insertorderedlist"&&o==="UL")s=!1}this.selectionSave();if(s){var u=this.getNodes(),a=this.getBlocks(u);typeof u[0]!="undefined"&&u.length>1&&u[0].nodeType==3&&a.unshift(this.getBlock());var f="",l="";e.each(a,e.proxy(function(t,n){if(n.tagName=="LI"){var r=e(n),i=r.clone();i.find("ul","ol").remove(),this.opts.linebreaks===!1?f+=this.outerHtml(e("<p>").append(i.contents())):f+=i.html()+"<br>",t==0?(r.addClass("redactor-replaced").empty(),l=this.outerHtml(r)):r.remove()}},this)),html=this.$editor.html().replace(l,"</"+o+">"+f+"<"+o+">"),this.$editor.html(html),this.$editor.find(o+":empty").remove()}else{var c=this.getParent();this.document.execCommand(t);var r=this.getParent(),i=e(r).closest("ol, ul");c&&c.tagName=="TD"&&i.wrapAll("<td>");if(i.length){(this.browser("msie")||this.browser("mozilla"))&&r.tagName!=="LI"&&e(r).replaceWith(e(r).html());var h=i.parent();this.isParentRedactor(h)&&this.nodeTestBlocks(h[0])&&h.replaceWith(h.contents())}this.browser("mozilla")&&this.$editor.focus()}this.selectionRestore(),this.sync(),this.callback("execCommand",t,n);return},indentingIndent:function(){this.indentingStart("indent")},indentingOutdent:function(){this.indentingStart("outdent")},indentingStart:function(t){this.bufferSet();if(t==="indent"){var n=this.getBlock();this.selectionSave();if(n&&n.tagName=="LI"){var r=this.getParent(),i=e(r).closest("ol, ul"),s=i[0].tagName,o=this.getBlocks();e.each(o,function(t,n){if(n.tagName=="LI"){var r=e(n).prev();if(r.size()!=0&&r[0].tagName=="LI"){var i=r.children("ul, ol");i.size()==0?r.append(e("<"+s+">").append(n)):i.append(n)}}})}else if(n===!1&&this.opts.linebreaks===!0){this.exec("formatBlock","blockquote");var u=this.getBlock(),n=e('<div data-tagblock="">').html(e(u).html());e(u).replaceWith(n);var a=this.normalize(e(n).css("margin-left"))+this.opts.indentValue;e(n).css("margin-left",a+"px")}else{var f=this.getBlocks();e.each(f,e.proxy(function(t,n){var r=!1;if(n.tagName==="TD")return;e.inArray(n.tagName,this.opts.alignmentTags)!==-1?r=e(n):r=e(n).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);var i=this.normalize(r.css("margin-left"))+this.opts.indentValue;r.css("margin-left",i+"px")},this))}this.selectionRestore()}else{this.selectionSave();var n=this.getBlock();if(n&&n.tagName=="LI"){var o=this.getBlocks(),l=0;this.insideOutdent(n,l,o)}else{var f=this.getBlocks();e.each(f,e.proxy(function(t,n){var r=!1;e.inArray(n.tagName,this.opts.alignmentTags)!==-1?r=e(n):r=e(n).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);var i=this.normalize(r.css("margin-left"))-this.opts.indentValue;i<=0?this.opts.linebreaks===!0&&typeof r.data("tagblock")!="undefined"?r.replaceWith(r.html()):(r.css("margin-left",""),this.removeEmptyAttr(r,"style")):r.css("margin-left",i+"px")},this))}this.selectionRestore()}this.sync()},insideOutdent:function(t,n,r){if(t&&t.tagName=="LI"){var i=e(t).parent().parent();i.size()!=0&&i[0].tagName=="LI"?i.after(t):typeof r[n]!="undefined"?(t=r[n],n++,this.insideOutdent(t,n,r)):this.execCommand("insertunorderedlist")}},alignmentLeft:function(){this.alignmentSet("","JustifyLeft")},alignmentRight:function(){this.alignmentSet("right","JustifyRight")},alignmentCenter:function(){this.alignmentSet("center","JustifyCenter")},alignmentJustify:function(){this.alignmentSet("justify","JustifyFull")},alignmentSet:function(t,n){this.bufferSet();if(this.oldIE())return this.document.execCommand(n,!1,!1),!0;this.selectionSave();var r=this.getBlock();if(!r&&this.opts.linebreaks){this.exec("formatBlock","blockquote"),this.selectionRestore();var i=this.getBlock(),r=e('<div data-tagblock="">').html(e(i).html());e(i).replaceWith(r),e(r).css("text-align",t),this.removeEmptyAttr(r,"style"),t==""&&typeof e(r).data("tagblock")!="undefined"&&e(r).replaceWith(e(r).html())}else{var s=this.getBlocks();e.each(s,e.proxy(function(n,r){var i=!1;e.inArray(r.tagName,this.opts.alignmentTags)!==-1?i=e(r):i=e(r).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]),i&&(i.css("text-align",t),this.removeEmptyAttr(i,"style"))},this))}this.selectionRestore(),this.sync()},cleanEmpty:function(e){var t=this.placeholderStart(e);return t!==!1?t:(this.opts.linebreaks===!1&&(e===""?e=this.opts.emptyHtml:e.search(/^<hr\s?\/?>$/gi)!==-1&&(e="<hr>"+this.opts.emptyHtml)),e)},cleanConverters:function(e){return this.opts.convertDivs&&(e=e.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p$1>$2</p>")),this.opts.paragraphy&&(e=this.cleanParagraphy(e)),e},cleanConvertProtected:function(e){return this.opts.templateVars&&(e=e.replace(/\{\{(.*?)\}\}/gi,"<!-- template double $1 -->"),e=e.replace(/\{(.*?)\}/gi,"<!-- template $1 -->")),e=e.replace(/<script(.*?)>([\w\W]*?)<\/script>/gi,'<title type="text/javascript" style="display: none;" class="redactor-script-tag"$1>$2</title>'),e=e.replace(/<style(.*?)>([\w\W]*?)<\/style>/gi,'<section$1 style="display: none;" rel="redactor-style-tag">$2</section>'),e=e.replace(/<form(.*?)>([\w\W]*?)<\/form>/gi,'<section$1 rel="redactor-form-tag">$2</section>'),this.opts.phpTags?e=e.replace(/<\?php([\w\W]*?)\?>/gi,'<section style="display: none;" rel="redactor-php-tag">$1</section>'):e=e.replace(/<\?php([\w\W]*?)\?>/gi,""),e},cleanReConvertProtected:function(e){return this.opts.templateVars&&(e=e.replace(/<!-- template double (.*?) -->/gi,"{{$1}}"),e=e.replace(/<!-- template (.*?) -->/gi,"{$1}")),e=e.replace(/<title type="text\/javascript" style="display: none;" class="redactor-script-tag"(.*?)>([\w\W]*?)<\/title>/gi,'<script$1 type="text/javascript">$2</script>'),e=e.replace(/<section(.*?) style="display: none;" rel="redactor-style-tag">([\w\W]*?)<\/section>/gi,"<style$1>$2</style>"),e=e.replace(/<section(.*?)rel="redactor-form-tag"(.*?)>([\w\W]*?)<\/section>/gi,"<form$1$2>$3</form>"),this.opts.phpTags&&(e=e.replace(/<section style="display: none;" rel="redactor-php-tag">([\w\W]*?)<\/section>/gi,"<?php\r\n$1\r\n?>")),e},cleanRemoveSpaces:function(t,n){if(n!==!1){var n=[],r=t.match(/<(pre|style|script|title)(.*?)>([\w\W]*?)<\/(pre|style|script|title)>/gi);r===null&&(r=[]);if(this.opts.phpTags){var i=t.match(/<\?php([\w\W]*?)\?>/gi);i&&(r=e.merge(r,i))}r&&e.each(r,function(e,r){t=t.replace(r,"buffer_"+e),n.push(r)})}return t=t.replace(/\n/g," "),t=t.replace(/[\t]*/g,""),t=t.replace(/\n\s*\n/g,"\n"),t=t.replace(/^[\s\n]*/g," "),t=t.replace(/[\s\n]*$/g," "),t=t.replace(/>\s{2,}</g,"> <"),t=this.cleanReplacer(t,n),t=t.replace(/\n\n/g,"\n"),t},cleanReplacer:function(t,n){return n===!1?t:(e.each(n,function(e,n){t=t.replace("buffer_"+e,n)}),t)},cleanRemoveEmptyTags:function(e){e=e.replace(/<span>([\w\W]*?)<\/span>/gi,"$1"),e=e.replace(/[\u200B-\u200D\uFEFF]/g,"");var t=["<b>\\s*</b>","<b>&nbsp;</b>","<em>\\s*</em>"],n=["<pre></pre>","<blockquote>\\s*</blockquote>","<dd></dd>","<dt></dt>","<ul></ul>","<ol></ol>","<li></li>","<table></table>","<tr></tr>","<span>\\s*<span>","<span>&nbsp;<span>","<p>\\s*</p>","<p></p>","<p>&nbsp;</p>","<p>\\s*<br>\\s*</p>","<div>\\s*</div>","<div>\\s*<br>\\s*</div>"];this.opts.removeEmptyTags?n=n.concat(t):n=t;var r=n.length;for(var i=0;i<r;++i)e=e.replace(new RegExp(n[i],"gi"),"");return e},cleanParagraphy:function(t){function o(e,n,r){return t.replace(new RegExp(e,n),r)}t=e.trim(t);if(this.opts.linebreaks===!0)return t;if(t===""||t==="<p></p>")return this.opts.emptyHtml;t+="\n";var n=[],r=t.match(/<(table|div|pre|object)(.*?)>([\w\W]*?)<\/(table|div|pre|object)>/gi);r||(r=[]);var i=t.match(/<!--([\w\W]*?)-->/gi);i&&(r=e.merge(r,i));if(this.opts.phpTags){var s=t.match(/<section(.*?)rel="redactor-php-tag">([\w\W]*?)<\/section>/gi);s&&(r=e.merge(r,s))}r&&e.each(r,function(e,r){n[e]=r,t=t.replace(r,"{replace"+e+"}\n")}),t=t.replace(/<br \/>\s*<br \/>/gi,"\n\n");var u="(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)";t=o("(<"+u+"[^>]*>)","gi","\n$1"),t=o("(</"+u+">)","gi","$1\n\n"),t=o("\r\n","g","\n"),t=o("\r","g","\n"),t=o("/\n\n+/","g","\n\n");var a=t.split(new RegExp("\ns*\n","g"),-1);t="";for(var f in a)a.hasOwnProperty(f)&&(a[f].search("{replace")==-1?t+="<p>"+a[f].replace(/^\n+|\n+$/g,"")+"</p>":t+=a[f]);return t=o("<p>s*</p>","gi",""),t=o("<p>([^<]+)</(div|address|form)>","gi","<p>$1</p></$2>"),t=o("<p>s*(</?"+u+"[^>]*>)s*</p>","gi","$1"),t=o("<p>(<li.+?)</p>","gi","$1"),t=o("<p>s*(</?"+u+"[^>]*>)","gi","$1"),t=o("(</?"+u+"[^>]*>)s*</p>","gi","$1"),t=o("(</?"+u+"[^>]*>)s*<br />","gi","$1"),t=o("<br />(s*</?(?:p|li|div|dl|dd|dt|th|pre|td|ul|ol)[^>]*>)","gi","$1"),t=o("\n</p>","gi","</p>"),t=o("<li><p>","gi","<li>"),t=o("</p></li>","gi","</li>"),t=o("</li><p>","gi","</li>"),t=o("<p>	?\n?<p>","gi","<p>"),t=o("</dt><p>","gi","</dt>"),t=o("</dd><p>","gi","</dd>"),t=o("<br></p></blockquote>","gi","</blockquote>"),t=o("<p>	*</p>","gi",""),e.each(n,function(e,n){t=t.replace("{replace"+e+"}",n)}),e.trim(t)},cleanConvertInlineTags:function(e,t){var n="strong";this.opts.boldTag==="b"&&(n="b");var r="em";return this.opts.italicTag==="i"&&(r="i"),e=e.replace(/<span style="font-style: italic;">([\w\W]*?)<\/span>/gi,"<"+r+">$1</"+r+">"),e=e.replace(/<span style="font-weight: bold;">([\w\W]*?)<\/span>/gi,"<"+n+">$1</"+n+">"),this.opts.boldTag==="strong"?e=e.replace(/<b>([\w\W]*?)<\/b>/gi,"<strong>$1</strong>"):e=e.replace(/<strong>([\w\W]*?)<\/strong>/gi,"<b>$1</b>"),this.opts.italicTag==="em"?e=e.replace(/<i>([\w\W]*?)<\/i>/gi,"<em>$1</em>"):e=e.replace(/<em>([\w\W]*?)<\/em>/gi,"<i>$1</i>"),t!==!0?e=e.replace(/<strike>([\w\W]*?)<\/strike>/gi,"<del>$1</del>"):e=e.replace(/<del>([\w\W]*?)<\/del>/gi,"<strike>$1</strike>"),e},cleanStripTags:function(t){if(t==""||typeof t=="undefined")return t;var n=!1;this.opts.allowedTags!==!1&&(n=!0);var r=n===!0?this.opts.allowedTags:this.opts.deniedTags,i=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;return t=t.replace(i,function(t,i){return n===!0?e.inArray(i.toLowerCase(),r)>"-1"?t:"":e.inArray(i.toLowerCase(),r)>"-1"?"":t}),t=this.cleanConvertInlineTags(t),t},cleanSavePreCode:function(t,n){var r=t.match(/<(pre|code)(.*?)>([\w\W]*?)<\/(pre|code)>/gi);return r!==null&&e.each(r,e.proxy(function(e,r){var i=r.match(/<(pre|code)(.*?)>([\w\W]*?)<\/(pre|code)>/i);i[3]=i[3].replace(/&nbsp;/g," "),n!==!1&&(i[3]=this.cleanEncodeEntities(i[3])),t=t.replace(r,"<"+i[1]+i[2]+">"+i[3]+"</"+i[1]+">")},this)),t},cleanEncodeEntities:function(e){return e=String(e).replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"'),String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},cleanUnverified:function(){var t=this.$editor.find("li, img, a, b, strong, sub, sup, i, em, u, small, strike, del, span, cite");t.filter('[style*="background-color: transparent;"][style*="line-height"]').css("background-color","").css("line-height",""),t.filter('[style*="background-color: transparent;"]').css("background-color",""),t.css("line-height",""),e.each(t,e.proxy(function(e,t){this.removeEmptyAttr(t,"style")},this)),this.$editor.find('div[style="text-align: -webkit-auto;"]').contents().unwrap()},cleanHtml:function(e){var t=0,n=e.length,r=0,i=null,s=null,o="",u="",a="";this.cleanlevel=0;for(;t<n;t++){r=t;if(-1==e.substr(t).indexOf("<"))return u+=e.substr(t),this.cleanFinish(u);while(r<n&&e.charAt(r)!="<")r++;t!=r&&(a=e.substr(t,r-t),a.match(/^\s{2,}$/g)||("\n"==u.charAt(u.length-1)?u+=this.cleanGetTabs():"\n"==a.charAt(0)&&(u+="\n"+this.cleanGetTabs(),a=a.replace(/^\s+/,"")),u+=a),a.match(/\n/)&&(u+="\n"+this.cleanGetTabs())),i=r;while(r<n&&">"!=e.charAt(r))r++;o=e.substr(i,r-i),t=r;var f;if("!--"==o.substr(1,3)){if(!o.match(/--$/)){while("-->"!=e.substr(r,3))r++;r+=2,o=e.substr(i,r-i),t=r}"\n"!=u.charAt(u.length-1)&&(u+="\n"),u+=this.cleanGetTabs(),u+=o+">\n"}else"!"==o[1]?u=this.placeTag(o+">",u):"?"==o[1]?u+=o+">\n":(f=o.match(/^<(script|style|pre)/i))?(f[1]=f[1].toLowerCase(),o=this.cleanTag(o),u=this.placeTag(o,u),s=String(e.substr(t+1)).toLowerCase().indexOf("</"+f[1]),s&&(a=e.substr(t+1,s),t+=s,u+=a)):(o=this.cleanTag(o),u=this.placeTag(o,u))}return this.cleanFinish(u)},cleanGetTabs:function(){var e="";for(var t=0;t<this.cleanlevel;t++)e+="	";return e},cleanFinish:function(e){return e=e.replace(/\n\s*\n/g,"\n"),e=e.replace(/^[\s\n]*/,""),e=e.replace(/[\s\n]*$/,""),e=e.replace(/<script(.*?)>\n<\/script>/gi,"<script$1></script>"),this.cleanlevel=0,e},cleanTag:function(e){var t="";e=e.replace(/\n/g," "),e=e.replace(/\s{2,}/g," "),e=e.replace(/^\s+|\s+$/g," ");var n="";e.match(/\/$/)&&(n="/",e=e.replace(/\/+$/,""));var r;while(r=/\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/.exec(e))r[2]?t+=r[1].toLowerCase()+"="+r[2]:r[1]&&(t+=r[1].toLowerCase()),t+=" ",e=e.substr(r[0].length);return t.replace(/\s*$/,"")+n+">"},placeTag:function(e,t){var n=e.match(this.cleannewLevel);if(e.match(this.cleanlineBefore)||n)t=t.replace(/\s*$/,""),t+="\n";n&&"/"==e.charAt(1)&&this.cleanlevel--,"\n"==t.charAt(t.length-1)&&(t+=this.cleanGetTabs()),n&&"/"!=e.charAt(1)&&this.cleanlevel++,t+=e;if(e.match(this.cleanlineAfter)||e.match(this.cleannewLevel))t=t.replace(/ *$/,""),t+="\n";return t},formatEmpty:function(t){var n=e.trim(this.$editor.html());if(this.opts.linebreaks)n==""&&(t.preventDefault(),this.$editor.html(""),this.focus());else{n=n.replace(/<br\s?\/?>/i,"");var r=n.replace(/<p>\s?<\/p>/gi,"");if(n===""||r===""){t.preventDefault();var i=e(this.opts.emptyHtml).get(0);this.$editor.html(i),this.focus()}}this.sync()},formatBlocks:function(t){this.bufferSet();var n=this.getBlocks();this.selectionSave(),e.each(n,e.proxy(function(n,r){if(r.tagName!=="LI"){var i=e(r).parent();if(t==="p"){if(r.tagName==="P"&&i.size()!=0&&i[0].tagName==="BLOCKQUOTE"||r.tagName==="BLOCKQUOTE"){this.formatQuote();return}if(this.opts.linebreaks)return;this.formatBlock(t,r)}else this.formatBlock(t,r)}},this)),this.selectionRestore(),this.sync()},formatBlock:function(t,n){n===!1&&(n=this.getBlock());if(n===!1)return this.opts.linebreaks===!0&&this.execCommand("formatblock",t),!0;var r="";t!=="pre"?r=e(n).contents():(r=e(n).html(),e.trim(r)===""&&(r='<span id="selection-marker-1"></span>')),n.tagName==="PRE"&&(t="p");if(this.opts.linebreaks===!0&&t==="p")e(n).replaceWith(e("<div>").append(r).html()+"<br>");else{var i=this.getParent(),s=e("<"+t+">").append(r);e(n).replaceWith(s),i&&i.tagName=="TD"&&e(s).wrapAll("<td>")}},formatChangeTag:function(t,n,r){r!==!1&&this.selectionSave();var i=e("<"+n+"/>");return e(t).replaceWith(function(){return i.append(e(this).contents())}),r!==!1&&this.selectionRestore(),i},formatQuote:function(){this.bufferSet();if(this.opts.linebreaks===!1){this.selectionSave();var t=this.getBlocks(),n=!1,r=t.length;if(t){var i="",s="",o=!1,u=!0;e.each(t,function(e,t){t.tagName!=="P"&&(u=!1)}),e.each(t,e.proxy(function(a,f){if(f.tagName==="BLOCKQUOTE")this.formatBlock("p",f,!1);else if(f.tagName==="P"){n=e(f).parent();if(n[0].tagName=="BLOCKQUOTE"){var l=e(n).children("p").size();l==1?e(n).replaceWith(f):l==r?(o="blockquote",i+=this.outerHtml(f)):(o="html",i+=this.outerHtml(f),a==0?(e(f).addClass("redactor-replaced").empty(),s=this.outerHtml(f)):e(f).remove())}else u===!1||t.length==1?this.formatBlock("blockquote",f,!1):(o="paragraphs",i+=this.outerHtml(f))}else f.tagName!=="LI"&&this.formatBlock("blockquote",f,!1)},this));if(o)if(o=="paragraphs")e(t[0]).replaceWith("<blockquote>"+i+"</blockquote>"),e(t).remove();else if(o=="blockquote")e(n).replaceWith(i);else if(o=="html"){var a=this.$editor.html().replace(s,"</blockquote>"+i+"<blockquote>");this.$editor.html(a),this.$editor.find("blockquote").each(function(){e.trim(e(this).html())==""&&e(this).remove()})}}this.selectionRestore()}else{var f=this.getBlock();if(f.tagName==="BLOCKQUOTE"){this.selectionSave();var a=e.trim(e(f).html()),l=e.trim(this.getSelectionHtml());a=a.replace(/<span(.*?)id="selection-marker(.*?)<\/span>/gi,"");if(a==l)e(f).replaceWith(e(f).html()+"<br>");else{this.inlineFormat("tmp");var c=this.$editor.find("tmp");c.empty();var h=this.$editor.html().replace("<tmp></tmp>",'</blockquote><span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>"+l+"<blockquote>");this.$editor.html(h),c.remove(),this.$editor.find("blockquote").each(function(){e.trim(e(this).html())==""&&e(this).remove()})}this.selectionRestore(),this.$editor.find("span#selection-marker-1").attr("id",!1)}else{var p=this.selectionWrap("blockquote"),a=e(p).html(),d=["ul","ol","table","tr","tbody","thead","tfoot","dl"];e.each(d,function(e,t){a=a.replace(new RegExp("<"+t+"(.*?)>","gi"),""),a=a.replace(new RegExp("</"+t+">","gi"),"")});var v=this.opts.blockLevelElements;v.push("td"),e.each(v,function(e,t){a=a.replace(new RegExp("<"+t+"(.*?)>","gi"),""),a=a.replace(new RegExp("</"+t+">","gi"),"<br>")}),e(p).html(a),this.selectionElement(p);var m=e(p).next();m.size()!=0&&m[0].tagName==="BR"&&m.remove()}}this.sync()},blockRemoveAttr:function(t,n){var r=this.getBlocks();e(r).removeAttr(t),this.sync()},blockSetAttr:function(t,n){var r=this.getBlocks();e(r).attr(t,n),this.sync()},blockRemoveStyle:function(t){var n=this.getBlocks();e(n).css(t,""),this.removeEmptyAttr(n,"style"),this.sync()},blockSetStyle:function(t,n){var r=this.getBlocks();e(r).css(t,n),this.sync()},blockRemoveClass:function(t){var n=this.getBlocks();e(n).removeClass(t),this.removeEmptyAttr(n,"class"),this.sync()},blockSetClass:function(t){var n=this.getBlocks();e(n).addClass(t),this.sync()},inlineRemoveClass:function(t){this.selectionSave(),this.inlineEachNodes(function(n){e(n).removeClass(t),this.removeEmptyAttr(n,"class")}),this.selectionRestore(),this.sync()},inlineSetClass:function(t){var n=this.getCurrent();e(n).hasClass(t)||this.inlineMethods("addClass",t)},inlineRemoveStyle:function(t){this.selectionSave(),this.inlineEachNodes(function(n){e(n).css(t,""),this.removeEmptyAttr(n,"style")}),this.selectionRestore(),this.sync()},inlineSetStyle:function(e,t){this.inlineMethods("css",e,t)},inlineRemoveAttr:function(t){this.selectionSave();var n=this.getRange(),r=this.getElement(),i=this.getNodes();if(n.collapsed||n.startContainer===n.endContainer&&r)i=e(r);e(i).removeAttr(t),this.inlineUnwrapSpan(),this.selectionRestore(),this.sync()},inlineSetAttr:function(e,t){this.inlineMethods("attr",e,t)},inlineMethods:function(t,n,r){this.bufferSet(),this.selectionSave();var i=this.getRange(),s=this.getElement();if((i.collapsed||i.startContainer===i.endContainer)&&s&&!this.nodeTestBlocks(s))e(s)[t](n,r);else{this.document.execCommand("fontSize",!1,4);var o=this.$editor.find("font");e.each(o,e.proxy(function(e,i){this.inlineSetMethods(t,i,n,r)},this))}this.selectionRestore(),this.sync()},inlineSetMethods:function(t,n,r,i){var s=e(n).parent(),o;return s&&s[0].tagName==="INLINE"&&s[0].attributes.length!=0?(o=s,e(n).replaceWith(e(n).html())):(o=e("<inline>").append(e(n).contents()),e(n).replaceWith(o)),e(o)[t](r,i),o},inlineEachNodes:function(t){var n=this.getRange(),r=this.getElement(),i=this.getNodes(),s;if(n.collapsed||n.startContainer===n.endContainer&&r)i=e(r),s=!0;e.each(i,e.proxy(function(n,r){if(!s&&r.tagName!=="INLINE"){if(r.parentNode.tagName!=="INLINE"||!!e(r.parentNode).hasClass("redactor_editor"))return;r=r.parentNode}t.call(this,r)},this))},inlineUnwrapSpan:function(){var t=this.$editor.find("inline");e.each(t,e.proxy(function(t,n){var r=e(n);r.attr("class")===undefined&&r.attr("style")===undefined&&r.contents().unwrap()},this))},inlineFormat:function(t){this.selectionSave(),this.document.execCommand("fontSize",!1,4);var n=this.$editor.find("font"),r;e.each(n,function(n,i){var s=e("<"+t+"/>").append(e(i).contents());e(i).replaceWith(s),r=s}),this.selectionRestore(),this.sync()},inlineRemoveFormat:function(t){this.selectionSave();var n=t.toUpperCase(),r=this.getNodes(),i=e(this.getParent()).parent();e.each(r,function(e,t){t.tagName===n&&this.inlineRemoveFormatReplace(t)}),i&&i[0].tagName===n&&this.inlineRemoveFormatReplace(i),this.selectionRestore(),this.sync()},inlineRemoveFormatReplace:function(t){e(t).replaceWith(e(t).contents())},insertHtml:function(t,n){var r=this.getCurrent(),i=r.parentNode;this.$editor.focus(),this.bufferSet();var s=e("<div>").append(e.parseHTML(t));t=s.html(),t=this.cleanRemoveEmptyTags(t),s=e("<div>").append(e.parseHTML(t));var o=this.getBlock();if(s.contents().length==1){var u=s.contents()[0].tagName;if(u!="P"&&u==o.tagName||u=="PRE")t=s.text(),s=e("<div>").append(t)}!this.opts.linebreaks&&s.contents().length==1&&s.contents()[0].nodeType==3&&(this.getRangeSelectedNodes().length>2||!r||r.tagName=="BODY"&&!i||i.tagName=="HTML")&&(t="<p>"+t+"</p>"),t=this.setSpansVerifiedHtml(t),s.contents().length>1&&o||s.contents().is("p, :header, ul, ol, li, div, table, td, blockquote, pre, address, section, header, footer, aside, article")?this.browser("msie")?this.document.selection.createRange().pasteHTML(t):this.document.execCommand("inserthtml",!1,t):this.insertHtmlAdvanced(t,!1),this.selectall&&this.window.setTimeout(e.proxy(function(){this.opts.linebreaks?this.focusEnd():this.selectionEnd(this.$editor.contents().last())},this),1),this.observeStart(),this.setNonEditable(),n!==!1&&this.sync()},insertHtmlAdvanced:function(e,t){e=this.setSpansVerifiedHtml(e);var n=this.getSelection();if(n.getRangeAt&&n.rangeCount){var r=n.getRangeAt(0);r.deleteContents();var i=this.document.createElement("div");i.innerHTML=e;var s=this.document.createDocumentFragment(),o,u;while(o=i.firstChild)u=s.appendChild(o);r.insertNode(s),u&&(r=r.cloneRange(),r.setStartAfter(u),r.collapse(!0),n.removeAllRanges(),n.addRange(r))}t!==!1&&this.sync()},insertBeforeCursor:function(t){t=this.setSpansVerifiedHtml(t);var n=e(t),r=document.createElement("span");r.innerHTML="";var i=this.getRange();i.insertNode(r),i.insertNode(n[0]),i.collapse(!1);var s=this.getSelection();s.removeAllRanges(),s.addRange(i),this.sync()},insertText:function(t){var n=e(e.parseHTML(t));n.length&&(t=n.text()),this.$editor.focus(),this.browser("msie")?this.document.selection.createRange().pasteHTML(t):this.document.execCommand("inserthtml",!1,t),this.sync()},insertNode:function(t){t=t[0]||t;if(t.tagName=="SPAN"){var n="inline",r=t.outerHTML,i=new RegExp("<"+t.tagName,"i"),s=r.replace(i,"<"+n);i=new RegExp("</"+t.tagName,"i"),s=s.replace(i,"</"+n),t=e(s)[0]}var o=this.getSelection();o.getRangeAt&&o.rangeCount&&(range=o.getRangeAt(0),range.deleteContents(),range.insertNode(t),range.setEndAfter(t),range.setStartAfter(t),o.removeAllRanges(),o.addRange(range))},insertNodeToCaretPositionFromPoint:function(e,t){var n,r=e.clientX,i=e.clientY;if(this.document.caretPositionFromPoint){var s=this.document.caretPositionFromPoint(r,i);n=this.getRange(),n.setStart(s.offsetNode,s.offset),n.collapse(!0),n.insertNode(t)}else if(this.document.caretRangeFromPoint)n=this.document.caretRangeFromPoint(r,i),n.insertNode(t);else if(typeof document.body.createTextRange!="undefined"){n=this.document.body.createTextRange(),n.moveToPoint(r,i);var o=n.duplicate();o.moveToPoint(r,i),n.setEndPoint("EndToEnd",o),n.select()}},insertAfterLastElement:function(t,n){typeof n!="undefined"&&(t=n);if(this.isEndOfElement()){if(this.opts.linebreaks){var r=e("<div>").append(e.trim(this.$editor.html())).contents();if(this.outerHtml(r.last()[0])!=this.outerHtml(t))return!1}else if(this.$editor.contents().last()[0]!==t)return!1;this.insertingAfterLastElement(t)}},insertingAfterLastElement:function(t){this.bufferSet();if(this.opts.linebreaks===!1){var n=e(this.opts.emptyHtml);e(t).after(n),this.selectionStart(n)}else{var n=e('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>",this.document)[0];e(t).after(n),e(n).after(this.opts.invisibleSpace),this.selectionRestore(),this.$editor.find("span#selection-marker-1").removeAttr("id")}},insertLineBreak:function(){this.selectionSave(),this.$editor.find("#selection-marker-1").before("<br>"+(this.browser("webkit")?this.opts.invisibleSpace:"")),this.selectionRestore()},insertDoubleLineBreak:function(){this.selectionSave(),this.$editor.find("#selection-marker-1").before("<br><br>"+(this.browser("webkit")?this.opts.invisibleSpace:"")),this.selectionRestore()},replaceLineBreak:function(t){var n=e("<br>"+this.opts.invisibleSpace);e(t).replaceWith(n),this.selectionStart(n)},pasteClean:function(t){t=this.callback("pasteBefore",!1,t);if(this.browser("msie")){var n=e.trim(t);n.search(/^<a(.*?)>(.*?)<\/a>$/i)==0&&(t=t.replace(/^<a(.*?)>(.*?)<\/a>$/i,"$2"))}if(this.opts.pastePlainText){var n=this.document.createElement("div");return t=t.replace(/<br>|<\/H[1-6]>|<\/p>|<\/div>/gi,"\n"),n.innerHTML=t,t=n.textContent||n.innerText,t=e.trim(t),t=t.replace("\n","<br>"),t=this.cleanParagraphy(t),this.pasteInsert(t),!1}if(this.currentOrParentIs("PRE"))return t=this.pastePre(t),this.pasteInsert(t),!0;t=t.replace(/<p(.*?)class="MsoListParagraphCxSpFirst"([\w\W]*?)<\/p>/gi,"<ul><li$2</li>"),t=t.replace(/<p(.*?)class="MsoListParagraphCxSpMiddle"([\w\W]*?)<\/p>/gi,"<li$2</li>"),t=t.replace(/<p(.*?)class="MsoListParagraphCxSpLast"([\w\W]*?)<\/p>/gi,"<li$2</li></ul>"),t=t.replace(/<p(.*?)class="MsoListParagraph"([\w\W]*?)<\/p>/gi,"<ul><li$2</li></ul>"),t=t.replace(//g,""),t=t.replace(/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi,""),t=t.replace(/(&nbsp;){2,}/gi,"&nbsp;"),t=t.replace(/&nbsp;/gi," "),t=t.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2"),t=t.replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3"),t=this.cleanStripTags(t),t=t.replace(/<td><\/td>/gi,"[td]"),t=t.replace(/<td>&nbsp;<\/td>/gi,"[td]"),t=t.replace(/<td><br><\/td>/gi,"[td]"),t=t.replace(/<td(.*?)colspan="(.*?)"(.*?)>([\w\W]*?)<\/td>/gi,'[td colspan="$2"]$4[/td]'),t=t.replace(/<td(.*?)rowspan="(.*?)"(.*?)>([\w\W]*?)<\/td>/gi,'[td rowspan="$2"]$4[/td]'),t=t.replace(/<a(.*?)href="(.*?)"(.*?)>([\w\W]*?)<\/a>/gi,'[a href="$2"]$4[/a]'),t=t.replace(/<iframe(.*?)>([\w\W]*?)<\/iframe>/gi,"[iframe$1]$2[/iframe]"),t=t.replace(/<video(.*?)>([\w\W]*?)<\/video>/gi,"[video$1]$2[/video]"),t=t.replace(/<audio(.*?)>([\w\W]*?)<\/audio>/gi,"[audio$1]$2[/audio]"),t=t.replace(/<embed(.*?)>([\w\W]*?)<\/embed>/gi,"[embed$1]$2[/embed]"),t=t.replace(/<object(.*?)>([\w\W]*?)<\/object>/gi,"[object$1]$2[/object]"),t=t.replace(/<param(.*?)>/gi,"[param$1]"),t=t.replace(/<img(.*?)>/gi,"[img$1]"),t=t.replace(/ class="(.*?)"/gi,""),t=t.replace(/<(\w+)([\w\W]*?)>/gi,"<$1>"),t=t.replace(/<[^\/>][^>]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,""),t=t.replace(/<div>\s*?\t*?\n*?(<ul>|<ol>|<p>)/gi,"$1"),t=t.replace(/\[td colspan="(.*?)"\]([\w\W]*?)\[\/td\]/gi,'<td colspan="$1">$2</td>'),t=t.replace(/\[td rowspan="(.*?)"\]([\w\W]*?)\[\/td\]/gi,'<td rowspan="$1">$2</td>'),t=t.replace(/\[td\]/gi,"<td>&nbsp;</td>"),t=t.replace(/\[a href="(.*?)"\]([\w\W]*?)\[\/a\]/gi,'<a href="$1">$2</a>'),t=t.replace(/\[iframe(.*?)\]([\w\W]*?)\[\/iframe\]/gi,"<iframe$1>$2</iframe>"),t=t.replace(/\[video(.*?)\]([\w\W]*?)\[\/video\]/gi,"<video$1>$2</video>"),t=t.replace(/\[audio(.*?)\]([\w\W]*?)\[\/audio\]/gi,"<audio$1>$2</audio>"),t=t.replace(/\[embed(.*?)\]([\w\W]*?)\[\/embed\]/gi,"<embed$1>$2</embed>"),t=t.replace(/\[object(.*?)\]([\w\W]*?)\[\/object\]/gi,"<object$1>$2</object>"),t=t.replace(/\[param(.*?)\]/gi,"<param$1>"),t=t.replace(/\[img(.*?)\]/gi,"<img$1>"),this.opts.convertDivs&&(t=t.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p>$2</p>"),t=t.replace(/<\/div><p>/gi,"<p>"),t=t.replace(/<\/p><\/div>/gi,"</p>")),this.currentOrParentIs("LI")?t=t.replace(/<p>([\w\W]*?)<\/p>/gi,"$1<br>"):t=this.cleanParagraphy(t),t=t.replace(/<span(.*?)>([\w\W]*?)<\/span>/gi,"$2"),t=t.replace(/<img>/gi,""),t=t.replace(/<[^\/>][^>][^img|param|source]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,""),t=t.replace(/\n{3,}/gi,"\n"),t=t.replace(/<p><p>/gi,"<p>"),t=t.replace(/<\/p><\/p>/gi,"</p>"),t=t.replace(/<li>(\s*|\t*|\n*)<p>/gi,"<li>"),t=t.replace(/<\/p>(\s*|\t*|\n*)<\/li>/gi,"</li>"),this.opts.linebreaks===!0&&(t=t.replace(/<p(.*?)>([\w\W]*?)<\/p>/gi,"$2<br>")),t=t.replace(/<[^\/>][^>][^img|param|source]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,""),t=t.replace(/<img src="webkit-fake-url\:\/\/(.*?)"(.*?)>/gi,""),t=t.replace(/<td(.*?)>(\s*|\t*|\n*)<p>([\w\W]*?)<\/p>(\s*|\t*|\n*)<\/td>/gi,"<td$1>$3</td>"),t=t.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"$2"),t=t.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"$2"),this.pasteClipboardMozilla=!1;if(this.browser("mozilla")){if(this.opts.clipboardUpload){var r=t.match(/<img src="data:image(.*?)"(.*?)>/gi);if(r!==null){this.pasteClipboardMozilla=r;for(k in r){var i=r[k].replace("<img",'<img data-mozilla-paste-image="'+k+'" ');t=t.replace(r[k],i)}}}while(/<br>$/gi.test(t))t=t.replace(/<br>$/gi,"")}t=t.replace(/<p>([\w\W]*?)<\/p>/gi,"<li>$1</li>");while(/<font>([\w\W]*?)<\/font>/gi.test(t))t=t.replace(/<font>([\w\W]*?)<\/font>/gi,"$1");this.pasteInsert(t)},pastePre:function(e){e=e.replace(/<br>|<\/H[1-6]>|<\/p>|<\/div>/gi,"\n");var t=this.document.createElement("div");return t.innerHTML=e,this.cleanEncodeEntities(t.textContent||t.innerText)},pasteInsert:function(t){this.selectall&&(this.opts.linebreaks?this.$editor.html(""):this.$editor.html(this.opts.emptyHtml),this.$editor.focus()),t=this.callback("pasteAfter",!1,t),this.insertHtml(t),this.selectall=!1,setTimeout(e.proxy(function(){this.rtePaste=!1,this.browser("mozilla")&&this.$editor.find("p:empty").remove(),this.pasteClipboardMozilla!==!1&&this.pasteClipboardUploadMozilla()},this),100),this.opts.autoresize&&this.fullscreen!==!0?e(this.document.body).scrollTop(this.saveScroll):this.$editor.scrollTop(this.saveScroll)},pasteClipboardUploadMozilla:function(){var t=this.$editor.find("img[data-mozilla-paste-image]");e.each(t,e.proxy(function(t,n){var r=e(n),i=n.src.split(","),s=i[1],o=i[0].split(";")[0].split(":")[1];e.post(this.opts.clipboardUploadUrl,{contentType:o,data:s},e.proxy(function(t){var n=typeof t=="string"?e.parseJSON(t):t;r.attr("src",n.filelink),r.removeAttr("data-mozilla-paste-image"),this.sync(),this.callback("imageUpload",r,n)},this))},this))},pasteClipboardUpload:function(t){var n=t.target.result,r=n.split(","),i=r[1],s=r[0].split(";")[0].split(":")[1];this.opts.clipboardUpload?e.post(this.opts.clipboardUploadUrl,{contentType:s,data:i},e.proxy(function(t){var n=typeof t=="string"?e.parseJSON(t):t,r='<img src="'+n.filelink+'" id="clipboard-image-marker" />';this.execCommand("inserthtml",r,!1);var i=e(this.$editor.find("img#clipboard-image-marker"));i.length?i.removeAttr("id"):i=!1,this.sync(),i&&this.callback("imageUpload",i,n)},this)):this.insertHtml('<img src="'+n+'" />')},bufferSet:function(e){e!==undefined?this.opts.buffer.push(e):(this.selectionSave(),this.opts.buffer.push(this.$editor.html()),this.selectionRemoveMarkers("buffer"))},bufferUndo:function(){if(this.opts.buffer.length===0){this.$editor.focus();return}this.selectionSave(),this.opts.rebuffer.push(this.$editor.html()),this.selectionRestore(!1,!0),this.$editor.html(this.opts.buffer.pop()),this.selectionRestore(),setTimeout(e.proxy(this.observeStart,this),100)},bufferRedo:function(){if(this.opts.rebuffer.length===0)return this.$editor.focus(),!1;this.selectionSave(),this.opts.buffer.push(this.$editor.html()),this.selectionRestore(!1,!0),this.$editor.html(this.opts.rebuffer.pop()),this.selectionRestore(!0),setTimeout(e.proxy(this.observeStart,this),4)},observeStart:function(){this.observeImages(),this.opts.observeLinks&&this.observeLinks()},observeLinks:function(){this.$editor.find("a").on("click",e.proxy(this.linkObserver,this)),this.$editor.on("click.redactor",e.proxy(function(e){this.linkObserverTooltipClose(e)},this))},observeImages:function(){if(this.opts.observeImages===!1)return!1;this.$editor.find("img").each(e.proxy(function(t,n){this.browser("msie")&&e(n).attr("unselectable","on"),this.imageResize(n)},this))},linkObserver:function(t){var n=e(t.target),r=n.offset();if(this.opts.iframe){var i=this.$frame.offset();r.top=i.top+(r.top-e(this.document).scrollTop()),r.left+=i.left}var s=e('<span class="redactor-link-tooltip"></span>'),o=n.attr("href");o.length>24&&(o=o.substring(0,24)+"...");var u=e('<a href="'+n.attr("href")+'" target="_blank">'+o+"</a>").on("click",e.proxy(function(e){this.linkObserverTooltipClose(!1)},this)),a=e('<a href="#">'+this.opts.curLang.edit+"</a>").on("click",e.proxy(function(e){e.preventDefault(),this.linkShow(),this.linkObserverTooltipClose(!1)},this)),f=e('<a href="#">'+this.opts.curLang.unlink+"</a>").on("click",e.proxy(function(e){e.preventDefault(),this.execCommand("unlink"),this.linkObserverTooltipClose(!1)},this));s.append(u),s.append(" | "),s.append(a),s.append(" | "),s.append(f),s.css({top:r.top+20+"px",left:r.left+"px"}),e(".redactor-link-tooltip").remove(),e("body").append(s)},linkObserverTooltipClose:function(t){if(t!==!1&&t.target.tagName=="A")return!1;e(".redactor-link-tooltip").remove()},getSelection:function(){return this.opts.rangy?this.opts.iframe?rangy.getSelection(this.$frame[0]):rangy.getSelection():this.document.getSelection()},getRange:function(){if(!this.opts.rangy){if(this.document.getSelection){var e=this.getSelection();if(e.getRangeAt&&e.rangeCount)return e.getRangeAt(0)}return this.document.createRange()}return this.opts.iframe?rangy.createRange(this.iframeDoc()):rangy.createRange()},selectionElement:function(e){this.setCaret(e)},selectionStart:function(e){this.selectionSet(e[0]||e,0,null,0)},selectionEnd:function(e){this.selectionSet(e[0]||e,1,null,1)},selectionSet:function(e,t,n,r){n==null&&(n=e),r==null&&(r=t);var i=this.getSelection();if(!i)return;var s=this.getRange();s.setStart(e,t),s.setEnd(n,r);try{i.removeAllRanges()}catch(o){}i.addRange(s)},selectionWrap:function(e){e=e.toLowerCase();var t=this.getBlock();if(t){var n=this.formatChangeTag(t,e);return this.sync(),n}var r=this.getSelection(),i=r.getRangeAt(0),n=document.createElement(e);return n.appendChild(i.extractContents()),i.insertNode(n),this.selectionElement(n),n},selectionAll:function(){var e=this.getRange();e.selectNodeContents(this.$editor[0]);var t=this.getSelection();t.removeAllRanges(),t.addRange(e)},selectionRemove:function(){this.getSelection().removeAllRanges()},getCaretOffset:function(t){var n=0,r=this.getRange(),i=r.cloneRange();return i.selectNodeContents(t),i.setEnd(r.endContainer,r.endOffset),n=e.trim(i.toString()).length,n},getCaretOffsetRange:function(){return new n(this.getSelection().getRangeAt(0))},setCaret:function(e,t,n){typeof n=="undefined"&&(n=t),e=e[0]||e;var r=this.getRange();r.selectNodeContents(e);var i=this.getTextNodesIn(e),s=!1,o=0,u;if(i.length==1&&t)r.setStart(i[0],t),r.setEnd(i[0],n);else for(var a=0,f;f=i[a++];){u=o+f.length,!s&&t>=o&&(t<u||t==u&&a<i.length)&&(r.setStart(f,t-o),s=!0);if(s&&n<=u){r.setEnd(f,n-o);break}o=u}var l=this.getSelection();l.removeAllRanges(),l.addRange(r)},getTextNodesIn:function(e){var t=[];if(e.nodeType==3)t.push(e);else{var n=e.childNodes;for(var r=0,i=n.length;r<i;++r)t.push.apply(t,this.getTextNodesIn(n[r]))}return t},getCurrent:function(){var e=!1,t=this.getSelection();return t.rangeCount>0&&(e=t.getRangeAt(0).startContainer),this.isParentRedactor(e)},getParent:function(t){return t=t||this.getCurrent(),t?this.isParentRedactor(e(t).parent()[0]):!1},getBlock:function(t){typeof t=="undefined"&&(t=this.getCurrent());while(t){if(this.nodeTestBlocks(t))return e(t).hasClass("redactor_editor")?!1:t;t=t.parentNode}return!1},getBlocks:function(t){var n=[];if(typeof t=="undefined"){var r=this.getRange();if(r&&r.collapsed===!0)return[this.getBlock()];var t=this.getNodes(r)}return e.each(t,e.proxy(function(t,r){if(this.opts.iframe===!1&&e(r).parents("div.redactor_editor").size()==0)return!1;this.nodeTestBlocks(r)&&n.push(r)},this)),n.length===0&&(n=[this.getBlock()]),n},nodeTestBlocks:function(e){return e.nodeType==1&&this.rTestBlock.test(e.nodeName)},tagTestBlock:function(e){return this.rTestBlock.test(e)},getNodes:function(t,n){if(typeof t=="undefined"||t==0)var t=this.getRange();if(t&&t.collapsed===!0){if(typeof n=="undefined"&&this.tagTestBlock(n)){var r=this.getBlock();return r.tagName==n?[r]:[]}return[this.getCurrent()]}var i=[],s=[],o=this.document.getSelection();o.isCollapsed||(i=this.getRangeSelectedNodes(o.getRangeAt(0))),e.each(i,e.proxy(function(t,r){if(this.opts.iframe===!1&&e(r).parents("div.redactor_editor").size()==0)return!1;typeof n=="undefined"?e.trim(r.textContent)!=""&&s.push(r):r.tagName==n&&s.push(r)},this));if(s.length==0){if(typeof n=="undefined"&&this.tagTestBlock(n)){var r=this.getBlock();return r.tagName==n?s.push(r):[]}s.push(this.getCurrent())}var u=s[s.length-1];return this.nodeTestBlocks(u)&&(s=s.slice(0,-1)),s},getElement:function(t){t||(t=this.getCurrent());while(t){if(t.nodeType==1)return e(t).hasClass("redactor_editor")?!1:t;t=t.parentNode}return!1},getRangeSelectedNodes:function(e){e=e||this.getRange();var t=e.startContainer,n=e.endContainer;if(t==n)return[t];var r=[];while(t&&t!=n)r.push(t=this.nextNode(t));t=e.startContainer;while(t&&t!=e.commonAncestorContainer)r.unshift(t),t=t.parentNode;return r},nextNode:function(e){if(e.hasChildNodes())return e.firstChild;while(e&&!e.nextSibling)e=e.parentNode;return e?e.nextSibling:null},getSelectionText:function(){return this.getSelection().toString()},getSelectionHtml:function(){var e="",t=this.getSelection();if(t.rangeCount){var n=this.document.createElement("div"),r=t.rangeCount;for(var i=0;i<r;++i)n.appendChild(t.getRangeAt(i).cloneContents());e=n.innerHTML}return this.syncClean(e)},selectionSave:function(){this.isFocused()||this.$editor.focus(),this.opts.rangy?this.savedSel=rangy.saveSelection():this.selectionCreateMarker(this.getRange())},selectionCreateMarker:function(t,n){if(!t)return;var r=e('<span id="selection-marker-1" class="redactor-selection-marker">'+this.opts.invisibleSpace+"</span>",this.document)[0],i=e('<span id="selection-marker-2" class="redactor-selection-marker">'+this.opts.invisibleSpace+"</span>",this.document)[0];t.collapsed===!0?this.selectionSetMarker(t,r,!0):(this.selectionSetMarker(t,r,!0),this.selectionSetMarker(t,i,!1)),this.savedSel=this.$editor.html(),this.selectionRestore(!1,!1)},selectionSetMarker:function(e,t,n){var r=e.cloneRange();r.collapse(n),r.insertNode(t),r.detach()},selectionRestore:function(e,t){if(!this.opts.rangy){e===!0&&this.savedSel&&this.$editor.html(this.savedSel);var n=this.$editor.find("span#selection-marker-1"),r=this.$editor.find("span#selection-marker-2");this.browser("mozilla")?this.$editor.focus():this.isFocused()||this.$editor.focus(),n.length!=0&&r.length!=0?this.selectionSet(n[0],0,r[0],0):n.length!=0&&this.selectionSet(n[0],0,null,0),t!==!1&&(this.selectionRemoveMarkers(),this.savedSel=!1)}else rangy.restoreSelection(this.savedSel)},selectionRemoveMarkers:function(t){this.opts.rangy?rangy.removeMarkers(this.savedSel):e.each(this.$editor.find("span.redactor-selection-marker"),function(){var t=e.trim(e(this).html().replace(/[^\u0000-\u1C7F]/g,""));t==""?e(this).remove():e(this).removeAttr("class").removeAttr("id")})},tableShow:function(){this.selectionSave(),this.modalInit(this.opts.curLang.table,this.opts.modal_table,300,e.proxy(function(){e("#redactor_insert_table_btn").click(e.proxy(this.tableInsert,this)),setTimeout(function(){e("#redactor_table_rows").focus()},200)},this))},tableInsert:function(){var t=e("#redactor_table_rows").val(),n=e("#redactor_table_columns").val(),r=e("<div></div>"),i=Math.floor(Math.random()*99999),s=e('<table id="table'+i+'"><tbody></tbody></table>'),o,u,a,f;for(o=0;o<t;o++){u=e("<tr></tr>");for(a=0;a<n;a++)f=e("<td>"+this.opts.invisibleSpace+"</td>"),o===0&&a===0&&f.append('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>"),e(u).append(f);s.append(u)}r.append(s);var l=r.html();this.modalClose(),this.selectionRestore();var c=this.getBlock()||this.getCurrent();c&&c.tagName!="BODY"?e(c).after(l):this.insertHtmlAdvanced(l,!1),this.selectionRestore();var h=this.$editor.find("#table"+i);this.buttonActiveObserver(),h.find("span#selection-marker-1").remove(),h.removeAttr("id"),this.sync()},tableDeleteTable:function(){var t=e(this.getParent()).closest("table");if(!this.isParentRedactor(t))return!1;if(t.size()==0)return!1;this.bufferSet(),t.remove(),this.sync()},tableDeleteRow:function(){var t=e(this.getParent()).closest("table");if(!this.isParentRedactor(t))return!1;if(t.size()==0)return!1;this.bufferSet();var n=e(this.getParent()).closest("tr"),r=n.prev().length?n.prev():n.next();if(r.length){var i=r.children("td").first();i.length&&i.prepend('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>")}n.remove(),this.selectionRestore(),this.sync()},tableDeleteColumn:function(){var t=e(this.getParent()).closest("table");if(!this.isParentRedactor(t))return!1;if(t.size()==0)return!1;this.bufferSet();var n=e(this.getParent()).closest("td"),r=n.get(0).cellIndex;t.find("tr").each(e.proxy(function(t,n){var i=r-1<0?r+1:r-1;t===0&&e(n).find("td").eq(i).prepend('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>"),e(n).find("td").eq(r).remove()},this)),this.selectionRestore(),this.sync()},tableAddHead:function(){var t=e(this.getParent()).closest("table");if(!this.isParentRedactor(t))return!1;if(t.size()==0)return!1;this.bufferSet();if(t.find("thead").size()!==0)this.tableDeleteHead();else{var n=t.find("tr").first().clone();n.find("td").html(this.opts.invisibleSpace),$thead=e("<thead></thead>"),$thead.append(n),t.prepend($thead),this.sync()}},tableDeleteHead:function(){var t=e(this.getParent()).closest("table");if(!this.isParentRedactor(t))return!1;var n=t.find("thead");if(n.size()==0)return!1;this.bufferSet(),n.remove(),this.sync()},tableAddRowAbove:function(){this.tableAddRow("before")},tableAddRowBelow:function(){this.tableAddRow("after")},tableAddColumnLeft:function(){this.tableAddColumn("before")},tableAddColumnRight:function(){this.tableAddColumn("after")},tableAddRow:function(t){var n=e(this.getParent()).closest("table");if(!this.isParentRedactor(n))return!1;if(n.size()==0)return!1;this.bufferSet();var r=e(this.getParent()).closest("tr"),i=r.clone();i.find("td").html(this.opts.invisibleSpace),t==="after"?r.after(i):r.before(i),this.sync()},tableAddColumn:function(t){var n=e(this.getParent()).closest("table");if(!this.isParentRedactor(n))return!1;if(n.size()==0)return!1;this.bufferSet();var r=0,i=e(this.getParent()).closest("tr"),s=e(this.getParent()).closest("td");i.find("td").each(e.proxy(function(t,n){e(n)[0]===s[0]&&(r=t)},this)),n.find("tr").each(e.proxy(function(n,i){var s=e(i).find("td").eq(r),o=s.clone();o.html(this.opts.invisibleSpace),t==="after"?s.after(o):s.before(o)},this)),this.sync()},videoShow:function(){this.selectionSave(),this.modalInit(this.opts.curLang.video,this.opts.modal_video,600,e.proxy(function(){e("#redactor_insert_video_btn").click(e.proxy(this.videoInsert,this)),setTimeout(function(){e("#redactor_insert_video_area").focus()},200)},this))},videoInsert:function(){var t=e("#redactor_insert_video_area").val();t=this.cleanStripTags(t),this.selectionRestore();var n=this.getBlock()||this.getCurrent();n?e(n).after(t):this.insertHtmlAdvanced(t,!1),this.sync(),this.modalClose()},linkShow:function(){this.selectionSave();var t=e.proxy(function(){this.insert_link_node=!1;var t=this.getSelection(),n="",r="",i="",s=this.getParent(),o=e(s).parent().get(0);o&&o.tagName==="A"&&(s=o),s&&s.tagName==="A"?(n=s.href,r=e(s).text(),i=s.target,this.insert_link_node=s):r=t.toString(),e(".redactor_link_text").val(r);var u=self.location.href.replace(/\/$/i,""),a=n.replace(u,"");if(this.opts.linkProtocol===!1){var f=new RegExp("^(http|ftp|https)://"+self.location.host,"i");a=a.replace(f,"")}var l=e("#redactor_tabs").find("a");this.opts.linkEmail===!1&&l.eq(1).remove(),this.opts.linkAnchor===!1&&l.eq(2).remove(),this.opts.linkEmail===!1&&this.opts.linkAnchor===!1?(e("#redactor_tabs").remove(),e("#redactor_link_url").val(a)):n.search("mailto:")===0?(this.modalSetTab.call(this,2),e("#redactor_tab_selected").val(2),e("#redactor_link_mailto").val(n.replace("mailto:",""))):a.search(/^#/gi)===0?(this.modalSetTab.call(this,3),e("#redactor_tab_selected").val(3),e("#redactor_link_anchor").val(a.replace(/^#/gi,""))):e("#redactor_link_url").val(a),i==="_blank"&&e("#redactor_link_blank").prop("checked",!0),e("#redactor_insert_link_btn").click(e.proxy(this.linkProcess,this)),setTimeout(function(){e("#redactor_link_url").focus()},200)},this);this.modalInit(this.opts.curLang.link,this.opts.modal_link,460,t)},linkProcess:function(){var t=e("#redactor_tab_selected").val(),n="",r="",i="",s="";if(t==="1"){n=e("#redactor_link_url").val(),r=e("#redactor_link_url_text").val(),e("#redactor_link_blank").prop("checked")&&(i=' target="_blank"',s="_blank");var o="((xn--)?[a-z0-9]+(-[a-z0-9]+)*.)+[a-z]{2,}",u=new RegExp("^(http|ftp|https)://"+o,"i"),a=new RegExp("^"+o,"i");n.search(u)==-1&&n.search(a)==0&&this.opts.linkProtocol&&(n=this.opts.linkProtocol+n)}else t==="2"?(n="mailto:"+e("#redactor_link_mailto").val(),r=e("#redactor_link_mailto_text").val()):t==="3"&&(n="#"+e("#redactor_link_anchor").val(),r=e("#redactor_link_anchor_text").val());r=r.replace(/<|>/g,""),this.linkInsert('<a href="'+n+'"'+i+">"+r+"</a>",e.trim(r),n,s)},linkInsert:function(t,n,r,i){this.selectionRestore(),n!==""&&(this.insert_link_node?(this.bufferSet(),e(this.insert_link_node).text(n).attr("href",r),i!==""?e(this.insert_link_node).attr("target",i):e(this.insert_link_node).removeAttr("target"),this.sync()):this.exec("inserthtml",t)),setTimeout(e.proxy(function(){this.opts.observeLinks&&this.observeLinks()},this),5),this.modalClose()},fileShow:function(){this.selectionSave();var t=e.proxy(function(){var t=this.getSelection(),n="";this.oldIE()?n=t.text:n=t.toString(),e("#redactor_filename").val(n),this.isMobile()||this.draguploadInit("#redactor_file",{url:this.opts.fileUpload,uploadFields:this.opts.uploadFields,success:e.proxy(this.fileCallback,this),error:e.proxy(function(e,t){this.callback("fileUploadError",t)},this),uploadParam:this.opts.fileUploadParam}),this.uploadInit("redactor_file",{auto:!0,url:this.opts.fileUpload,success:e.proxy(this.fileCallback,this),error:e.proxy(function(e,t){this.callback("fileUploadError",t)},this)})},this);this.modalInit(this.opts.curLang.file,this.opts.modal_file,500,t)},fileCallback:function(t){this.selectionRestore();if(t!==!1){var n=e("#redactor_filename").val();n===""&&(n=t.filename);var r='<a href="'+t.filelink+'" id="filelink-marker">'+n+"</a>";this.browser("webkit")&&!!this.window.chrome&&(r+="&nbsp;"),this.execCommand("inserthtml",r,!1);var i=e(this.$editor.find("a#filelink-marker"));i.size()!=0?i.removeAttr("id"):i=!1,this.sync(),this.callback("fileUpload",i,t)}this.modalClose()},imageShow:function(){this.selectionSave();var t=e.proxy(function(){this.opts.imageGetJson?e.getJSON(this.opts.imageGetJson,e.proxy(function(t){var n={},r=0;e.each(t,e.proxy(function(e,t){typeof t.folder!="undefined"&&(r++,n[t.folder]=r)},this));var i=!1;e.each(t,e.proxy(function(t,r){var s="";typeof r.title!="undefined"&&(s=r.title);var o=0;!e.isEmptyObject(n)&&typeof r.folder!="undefined"&&(o=n[r.folder],i===!1&&(i=".redactorfolder"+o));var u=e('<img src="'+r.thumb+'" class="redactorfolder redactorfolder'+o+'" rel="'+r.image+'" title="'+s+'" />');e("#redactor_image_box").append(u),e(u).click(e.proxy(this.imageThumbClick,this))},this));if(!e.isEmptyObject(n)){e(".redactorfolder").hide(),e(i).show();var s=function(t){e(".redactorfolder").hide(),e(".redactorfolder"+e(t.target).val()).show()},o=e('<select id="redactor_image_box_select">');e.each(n,function(t,n){o.append(e('<option value="'+n+'">'+t+"</option>"))}),e("#redactor_image_box").before(o),o.change(s)}},this)):e("#redactor_tabs").find("a").eq(1).remove();if(this.opts.imageUpload||this.opts.s3)!this.isMobile()&&this.opts.s3===!1&&e("#redactor_file").length&&this.draguploadInit("#redactor_file",{url:this.opts.imageUpload,uploadFields:this.opts.uploadFields,success:e.proxy(this.imageCallback,this),error:e.proxy(function(e,t){this.callback("imageUploadError",t)},this),uploadParam:this.opts.imageUploadParam}),this.opts.s3===!1?this.uploadInit("redactor_file",{auto:!0,url:this.opts.imageUpload,success:e.proxy(this.imageCallback,this),error:e.proxy(function(e,t){this.callback("imageUploadError",t)},this)}):e("#redactor_file").on("change.redactor",e.proxy(this.s3handleFileSelect,this));else{e(".redactor_tab").hide();if(!this.opts.imageGetJson)e("#redactor_tabs").remove(),e("#redactor_tab3").show();else{var t=e("#redactor_tabs").find("a");t.eq(0).remove(),t.eq(1).addClass("redactor_tabs_act"),e("#redactor_tab2").show()}}e("#redactor_upload_btn").click(e.proxy(this.imageCallbackLink,this)),!this.opts.imageUpload&&!this.opts.imageGetJson&&setTimeout(function(){e("#redactor_file_link").focus()},200)},this);this.modalInit(this.opts.curLang.image,this.opts.modal_image,610,t)},imageEdit:function(t){var n=t,r=n.parent().parent(),i=e.proxy(function(){e("#redactor_file_alt").val(n.attr("alt")),e("#redactor_image_edit_src").attr("href",n.attr("src")),e("#redactor_form_image_align").val(n.css("float")),e(r).get(0).tagName==="A"&&(e("#redactor_file_link").val(e(r).attr("href")),e(r).attr("target")=="_blank"&&e("#redactor_link_blank").prop("checked",!0)),e("#redactor_image_delete_btn").click(e.proxy(function(){this.imageRemove(n)},this)),e("#redactorSaveBtn").click(e.proxy(function(){this.imageSave(n)},this))},this);this.modalInit(this.opts.curLang.edit,this.opts.modal_image_edit,380,i)},imageRemove:function(t){var n=e(t).parent();e(t).remove(),n.length&&n[0].tagName==="P"&&(this.$editor.focus(),this.selectionStart(n)),this.callback("imageDelete",t),this.modalClose(),this.sync()},imageSave:function(t){var n=e(t),r=n.parent();n.attr("alt",e("#redactor_file_alt").val());var i=e("#redactor_form_image_align").val();if(i==="left")this.imageMargin="0 "+this.opts.imageFloatMargin+" "+this.opts.imageFloatMargin+" 0",n.css({"float":"left",margin:this.imageMargin});else if(i==="right")this.imageMargin="0 0 "+this.opts.imageFloatMargin+" "+this.opts.imageFloatMargin+"",n.css({"float":"right",margin:this.imageMargin});else{this.imageMargin="0px";var s=n.closest("#redactor-image-box");s.size()!=0&&s.css({"float":"",margin:""}),n.css({"float":"",margin:""})}var o=e.trim(e("#redactor_file_link").val());if(o!==""){var u=!1;e("#redactor_link_blank").prop("checked")&&(u=!0);if(r.get(0).tagName!=="A"){var a=e('<a href="'+o+'">'+this.outerHtml(t)+"</a>");u&&a.attr("target","_blank"),n.replaceWith(a)}else r.attr("href",o),u?r.attr("target","_blank"):r.removeAttr("target")}else r.get(0).tagName==="A"&&r.replaceWith(this.outerHtml(t));this.modalClose(),this.observeImages(),this.sync()},imageResizeHide:function(t){if(t!==!1&&e(t.target).parent().size()!=0&&e(t.target).parent()[0].id==="redactor-image-box")return!1;var n=this.$editor.find("#redactor-image-box");if(n.size()==0)return!1;this.$editor.find("#redactor-image-editter, #redactor-image-resizer").remove(),this.imageMargin!="0px"&&(n.find("img").css("margin",this.imageMargin),n.css("margin",""),this.imageMargin="0px"),n.find("img").css("opacity",""),n.replaceWith(function(){return e(this).contents()}),e(document).off("click.redactor-image-resize-hide"),this.$editor.off("click.redactor-image-resize-hide"),this.$editor.off("keydown.redactor-image-delete"),this.sync()},imageResize:function(t){var n=e(t);n.on("mousedown",e.proxy(function(){this.imageResizeHide(!1)},this)),n.on("dragstart",e.proxy(function(){this.$editor.on("drop.redactor-image-inside-drop",e.proxy(function(){setTimeout(e.proxy(function(){this.observeImages(),this.$editor.off("drop.redactor-image-inside-drop"),this.sync()},this),1)},this))},this)),n.on("click",e.proxy(function(t){if(this.$editor.find("#redactor-image-box").size()!=0)return!1;var r=!1,i,s,o=n.width()/n.height(),u=20,a=10,f=this.imageResizeControls(n),l=!1;f.on("mousedown",function(e){l=!0,e.preventDefault(),o=n.width()/n.height(),i=Math.round(e.pageX-n.eq(0).offset().left),s=Math.round(e.pageY-n.eq(0).offset().top)}),e(this.document.body).on("mousemove",e.proxy(function(e){if(l){var t=Math.round(e.pageX-n.eq(0).offset().left)-i,r=Math.round(e.pageY-n.eq(0).offset().top)-s,a=n.height(),f=parseInt(a,10)+r,c=Math.round(f*o);c>u&&(n.width(c),c<100?this.imageEditter.css({marginTop:"-7px",marginLeft:"-13px",fontSize:"9px",padding:"3px 5px"}):this.imageEditter.css({marginTop:"-11px",marginLeft:"-18px",fontSize:"11px",padding:"7px 10px"})),i=Math.round(e.pageX-n.eq(0).offset().left),s=Math.round(e.pageY-n.eq(0).offset().top),this.sync()}},this)).on("mouseup",function(){l=!1}),this.$editor.on("keydown.redactor-image-delete",e.proxy(function(e){var t=e.which;if(this.keyCode.BACKSPACE==t||this.keyCode.DELETE==t)this.bufferSet(),this.imageResizeHide(!1),this.imageRemove(n)},this)),e(document).on("click.redactor-image-resize-hide",e.proxy(this.imageResizeHide,this)),this.$editor.on("click.redactor-image-resize-hide",e.proxy(this.imageResizeHide,this))},this))},imageResizeControls:function(t){var n=e('<span id="redactor-image-box" data-redactor="verified">');n.css({position:"relative",display:"inline-block",lineHeight:0,outline:"1px dashed rgba(0, 0, 0, .6)","float":t.css("float")}),n.attr("contenteditable",!1),this.imageMargin=t[0].style.margin,this.imageMargin!="0px"&&(n.css("margin",this.imageMargin),t.css("margin","")),t.css("opacity",.5).after(n),this.imageEditter=e('<span id="redactor-image-editter" data-redactor="verified">'+this.opts.curLang.edit+"</span>"),this.imageEditter.css({position:"absolute",zIndex:2,top:"50%",left:"50%",marginTop:"-11px",marginLeft:"-18px",lineHeight:1,backgroundColor:"#000",color:"#fff",fontSize:"11px",padding:"7px 10px",cursor:"pointer"}),this.imageEditter.attr("contenteditable",!1),this.imageEditter.on("click",e.proxy(function(){this.imageEdit(t)},this)),n.append(this.imageEditter);var r=e('<span id="redactor-image-resizer" data-redactor="verified"></span>');return r.css({position:"absolute",zIndex:2,lineHeight:1,cursor:"nw-resize",bottom:"-4px",right:"-5px",border:"1px solid #fff",backgroundColor:"#000",width:"8px",height:"8px"}),r.attr("contenteditable",!1),n.append(r),n.append(t),r},imageThumbClick:function(t){var n='<img id="image-marker" src="'+e(t.target).attr("rel")+'" alt="'+e(t.target).attr("title")+'" />',r=this.getParent();this.opts.paragraphy&&e(r).closest("li").size()==0&&(n="<p>"+n+"</p>"),this.imageInsert(n,!0)},imageCallbackLink:function(){var t=e("#redactor_file_link").val();if(t!==""){var n='<img id="image-marker" src="'+t+'" />';this.opts.linebreaks===!1&&(n="<p>"+n+"</p>"),this.imageInsert(n,!0)}else this.modalClose()},imageCallback:function(e){this.imageInsert(e)},imageInsert:function(t,n){this.selectionRestore();if(t!==!1){var r="";if(n!==!0){r='<img id="image-marker" src="'+t.filelink+'" />';var i=this.getParent();this.opts.paragraphy&&e(i).closest("li").size()==0&&(r="<p>"+r+"</p>")}else r=t;this.execCommand("inserthtml",r,!1);var s=e(this.$editor.find("img#image-marker"));s.length?s.removeAttr("id"):s=!1,this.sync(),n!==!0&&this.callback("imageUpload",s,t)}this.modalClose(),this.observeImages()},modalTemplatesInit:function(){e.extend(this.opts,{modal_file:String()+"<section>"+'<div id="redactor-progress" class="redactor-progress redactor-progress-striped" style="display: none;">'+'<div id="redactor-progress-bar" class="redactor-progress-bar" style="width: 100%;"></div>'+"</div>"+'<form id="redactorUploadFileForm" method="post" action="" enctype="multipart/form-data">'+"<label>"+this.opts.curLang.filename+"</label>"+'<input type="text" id="redactor_filename" class="redactor_input" />'+'<div style="margin-top: 7px;">'+'<input type="file" id="redactor_file" name="'+this.opts.fileUploadParam+'" />'+"</div>"+"</form>"+"</section>",modal_image_edit:String()+"<section>"+"<label>"+this.opts.curLang.title+"</label>"+'<input id="redactor_file_alt" class="redactor_input" />'+"<label>"+this.opts.curLang.link+"</label>"+'<input id="redactor_file_link" class="redactor_input" />'+'<label><input type="checkbox" id="redactor_link_blank"> '+this.opts.curLang.link_new_tab+"</label>"+"<label>"+this.opts.curLang.image_position+"</label>"+'<select id="redactor_form_image_align">'+'<option value="none">'+this.opts.curLang.none+"</option>"+'<option value="left">'+this.opts.curLang.left+"</option>"+'<option value="right">'+this.opts.curLang.right+"</option>"+"</select>"+"</section>"+"<footer>"+'<button id="redactor_image_delete_btn" class="redactor_modal_btn redactor_modal_delete_btn">'+this.opts.curLang._delete+"</button>&nbsp;&nbsp;&nbsp;"+'<button class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+"</button>"+'<input type="button" name="save" class="redactor_modal_btn redactor_modal_action_btn" id="redactorSaveBtn" value="'+this.opts.curLang.save+'" />'+"</footer>",modal_image:String()+"<section>"+'<div id="redactor_tabs">'+'<a href="#" class="redactor_tabs_act">'+this.opts.curLang.upload+"</a>"+'<a href="#">'+this.opts.curLang.choose+"</a>"+'<a href="#">'+this.opts.curLang.link+"</a>"+"</div>"+'<div id="redactor-progress" class="redactor-progress redactor-progress-striped" style="display: none;">'+'<div id="redactor-progress-bar" class="redactor-progress-bar" style="width: 100%;"></div>'+"</div>"+'<form id="redactorInsertImageForm" method="post" action="" enctype="multipart/form-data">'+'<div id="redactor_tab1" class="redactor_tab">'+'<input type="file" id="redactor_file" name="'+this.opts.imageUploadParam+'" />'+"</div>"+'<div id="redactor_tab2" class="redactor_tab" style="display: none;">'+'<div id="redactor_image_box"></div>'+"</div>"+"</form>"+'<div id="redactor_tab3" class="redactor_tab" style="display: none;">'+"<label>"+this.opts.curLang.image_web_link+"</label>"+'<input type="text" name="redactor_file_link" id="redactor_file_link" class="redactor_input"  />'+"</div>"+"</section>"+"<footer>"+'<button class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+"</button>"+'<input type="button" name="upload" class="redactor_modal_btn redactor_modal_action_btn" id="redactor_upload_btn" value="'+this.opts.curLang.insert+'" />'+"</footer>",modal_link:String()+"<section>"+'<form id="redactorInsertLinkForm" method="post" action="">'+'<div id="redactor_tabs">'+'<a href="#" class="redactor_tabs_act">URL</a>'+'<a href="#">Email</a>'+'<a href="#">'+this.opts.curLang.anchor+"</a>"+"</div>"+'<input type="hidden" id="redactor_tab_selected" value="1" />'+'<div class="redactor_tab" id="redactor_tab1">'+"<label>URL</label>"+'<input type="text" id="redactor_link_url" class="redactor_input"  />'+"<label>"+this.opts.curLang.text+"</label>"+'<input type="text" class="redactor_input redactor_link_text" id="redactor_link_url_text" />'+'<label><input type="checkbox" id="redactor_link_blank"> '+this.opts.curLang.link_new_tab+"</label>"+"</div>"+'<div class="redactor_tab" id="redactor_tab2" style="display: none;">'+"<label>Email</label>"+'<input type="text" id="redactor_link_mailto" class="redactor_input" />'+"<label>"+this.opts.curLang.text+"</label>"+'<input type="text" class="redactor_input redactor_link_text" id="redactor_link_mailto_text" />'+"</div>"+'<div class="redactor_tab" id="redactor_tab3" style="display: none;">'+"<label>"+this.opts.curLang.anchor+"</label>"+'<input type="text" class="redactor_input" id="redactor_link_anchor"  />'+"<label>"+this.opts.curLang.text+"</label>"+'<input type="text" class="redactor_input redactor_link_text" id="redactor_link_anchor_text" />'+"</div>"+"</form>"+"</section>"+"<footer>"+'<button class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+"</button>"+'<input type="button" class="redactor_modal_btn redactor_modal_action_btn" id="redactor_insert_link_btn" value="'+this.opts.curLang.insert+'" />'+"</footer>",modal_table:String()+"<section>"+"<label>"+this.opts.curLang.rows+"</label>"+'<input type="text" size="5" value="2" id="redactor_table_rows" />'+"<label>"+this.opts.curLang.columns+"</label>"+'<input type="text" size="5" value="3" id="redactor_table_columns" />'+"</section>"+"<footer>"+'<button class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+"</button>"+'<input type="button" name="upload" class="redactor_modal_btn redactor_modal_action_btn" id="redactor_insert_table_btn" value="'+this.opts.curLang.insert+'" />'+"</footer>",modal_video:String()+"<section>"+'<form id="redactorInsertVideoForm">'+"<label>"+this.opts.curLang.video_html_code+"</label>"+'<textarea id="redactor_insert_video_area" style="width: 99%; height: 160px;"></textarea>'+"</form>"+"</section>"+"<footer>"+'<button class="redactor_modal_btn redactor_btn_modal_close">'+this.opts.curLang.cancel+"</button>"+'<input type="button" class="redactor_modal_btn redactor_modal_action_btn" id="redactor_insert_video_btn" value="'+this.opts.curLang.insert+'" />'+"</footer>"})},modalInit:function(t,n,r,i){var s=e("#redactor_modal_overlay");s.length||(this.$overlay=s=e('<div id="redactor_modal_overlay" style="display: none;"></div>'),e("body").prepend(this.$overlay)),this.opts.modalOverlay&&s.show().on("click",e.proxy(this.modalClose,this));var o=e("#redactor_modal");o.length||(this.$modal=o=e('<div id="redactor_modal" style="display: none;"><div id="redactor_modal_close">&times;</div><header id="redactor_modal_header"></header><div id="redactor_modal_inner"></div></div>'),e("body").append(this.$modal)),e("#redactor_modal_close").on("click",e.proxy(this.modalClose,this)),this.hdlModalClose=e.proxy(function(e){if(e.keyCode===this.keyCode.ESC)return this.modalClose(),!1},this),e(document).keyup(this.hdlModalClose),this.$editor.keyup(this.hdlModalClose),this.modalcontent=!1,n.indexOf("#")==0?(this.modalcontent=e(n),e("#redactor_modal_inner").empty().append(this.modalcontent.html()),this.modalcontent.html("")):e("#redactor_modal_inner").empty().append(n),o.find("#redactor_modal_header").html(t),typeof e.fn.draggable!="undefined"&&(o.draggable({handle:"#redactor_modal_header"}),o.find("#redactor_modal_header").css("cursor","move"));var u=e("#redactor_tabs");if(u.length){var a=this;u.find("a").each(function(t,n){t++,e(n).on("click",function(n){n.preventDefault(),u.find("a").removeClass("redactor_tabs_act"),e(this).addClass("redactor_tabs_act"),e(".redactor_tab").hide(),e("#redactor_tab"+t).show(),e("#redactor_tab_selected").val(t);if(a.isMobile()===!1){var r=o.outerHeight();o.css("margin-top","-"+(r+10)/2+"px")}})})}o.find(".redactor_btn_modal_close").on("click",e.proxy(this.modalClose,this)),this.opts.autoresize===!0?this.saveModalScroll=this.document.body.scrollTop:this.saveModalScroll=this.$editor.scrollTop(),this.isMobile()===!1?(o.css({position:"fixed",top:"-2000px",left:"50%",width:r+"px",marginLeft:"-"+(r+60)/2+"px"}).show(),this.modalSaveBodyOveflow=e(document.body).css("overflow"),e(document.body).css("overflow","hidden")):o.css({position:"fixed",width:"100%",height:"100%",top:"0",left:"0",margin:"0",minHeight:"300px"}).show(),typeof i=="function"&&i(),this.isMobile()===!1&&setTimeout(function(){var e=o.outerHeight();o.css({top:"50%",height:"auto",minHeight:"auto",marginTop:"-"+(e+10)/2+"px"})},10)},modalClose:function(){return e("#redactor_modal_close").off("click",this.modalClose),e("#redactor_modal").fadeOut("fast",e.proxy(function(){var t=e("#redactor_modal_inner");this.modalcontent!==!1&&(this.modalcontent.html(t.html()),this.modalcontent=!1),t.html(""),this.opts.modalOverlay&&e("#redactor_modal_overlay").hide().off("click",this.modalClose),e(document).unbind("keyup",this.hdlModalClose),this.$editor.unbind("keyup",this.hdlModalClose),this.selectionRestore(),this.opts.autoresize&&this.saveModalScroll?e(this.document.body).scrollTop(this.saveModalScroll):this.opts.autoresize===!1&&this.saveModalScroll&&this.$editor.scrollTop(this.saveModalScroll)},this)),this.isMobile()===!1&&e(document.body).css("overflow",this.modalSaveBodyOveflow?this.modalSaveBodyOveflow:"visible"),!1},modalSetTab:function(t){e(".redactor_tab").hide(),e("#redactor_tabs").find("a").removeClass("redactor_tabs_act").eq(t-1).addClass("redactor_tabs_act"),e("#redactor_tab"+t).show()},s3handleFileSelect:function(e){var t=e.target.files;for(var n=0,r;r=t[n];n++)this.s3uploadFile(r)},s3uploadFile:function(t){this.s3executeOnSignedUrl(t,e.proxy(function(e){this.s3uploadToS3(t,e)},this))},s3executeOnSignedUrl:function(t,n){var r=new XMLHttpRequest,i="?";this.opts.s3.search(/\?/)!="-1"&&(i="&"),r.open("GET",this.opts.s3+i+"name="+t.name+"&type="+t.type,!0),r.overrideMimeType("text/plain; charset=x-user-defined"),r.onreadystatechange=function(t){this.readyState==4&&this.status==200?(e("#redactor-progress").fadeIn(),n(decodeURIComponent(this.responseText))):this.readyState==4&&this.status!=200},r.send()},s3createCORSRequest:function(e,t){var n=new XMLHttpRequest;return"withCredentials"in n?n.open(e,t,!0):typeof XDomainRequest!="undefined"?(n=new XDomainRequest,n.open(e,t)):n=null,n},s3uploadToS3:function(t,n){var r=this.s3createCORSRequest("PUT",n);!r||(r.onload=e.proxy(function(){if(r.status==200){e("#redactor-progress, #redactor-progress-drag").hide();var t=n.split("?");if(!t[0])return!1;this.selectionRestore();var i="";i='<img id="image-marker" src="'+t[0]+'" />',this.opts.paragraphy&&(i="<p>"+i+"</p>"),this.execCommand("inserthtml",i,!1);var s=e(this.$editor.find("img#image-marker"));s.length?s.removeAttr("id"):s=!1,this.sync(),this.callback("imageUpload",s,!1),this.modalClose(),this.observeImages()}},this),r.onerror=function(){},r.upload.onprogress=function(e){},r.setRequestHeader("Content-Type",t.type),r.setRequestHeader("x-amz-acl","public-read"),r.send(t))},uploadInit:function(t,n){this.uploadOptions={url:!1,success:!1,error:!1,start:!1,trigger:!1,auto:!1,input:!1},e.extend(this.uploadOptions,n);var r=e("#"+t);r.length&&r[0].tagName==="INPUT"?(this.uploadOptions.input=r,this.el=e(r[0].form)):this.el=r,this.element_action=this.el.attr("action"),this.uploadOptions.auto?e(this.uploadOptions.input).change(e.proxy(function(e){this.el.submit(function(e){return!1}),this.uploadSubmit(e)},this)):this.uploadOptions.trigger&&e("#"+this.uploadOptions.trigger).click(e.proxy(this.uploadSubmit,this))},uploadSubmit:function(t){e("#redactor-progress").fadeIn(),this.uploadForm(this.element,this.uploadFrame())},uploadFrame:function(){this.id="f"+Math.floor(Math.random()*99999);var t=this.document.createElement("div"),n='<iframe style="display:none" id="'+this.id+'" name="'+this.id+'"></iframe>';return t.innerHTML=n,e(t).appendTo("body"),this.uploadOptions.start&&this.uploadOptions.start(),e("#"+this.id).load(e.proxy(this.uploadLoaded,this)),this.id},uploadForm:function(t,n){if(this.uploadOptions.input){var r="redactorUploadForm"+this.id,i="redactorUploadFile"+this.id;this.form=e('<form  action="'+this.uploadOptions.url+'" method="POST" target="'+n+'" name="'+r+'" id="'+r+'" enctype="multipart/form-data" />'),this.opts.uploadFields!==!1&&typeof this.opts.uploadFields=="object"&&e.each(this.opts.uploadFields,e.proxy(function(t,n){n!=null&&n.toString().indexOf("#")===0&&(n=e(n).val());var r=e("<input/>",{type:"hidden",name:t,value:n});e(this.form).append(r)},this));var s=this.uploadOptions.input,o=e(s).clone();e(s).attr("id",i).before(o).appendTo(this.form),e(this.form).css("position","absolute").css("top","-2000px").css("left","-2000px").appendTo("body"),this.form.submit()}else t.attr("target",n).attr("method","POST").attr("enctype","multipart/form-data").attr("action",this.uploadOptions.url),this.element.submit()},uploadLoaded:function(){var t=e("#"+this.id)[0],n;t.contentDocument?n=t.contentDocument:t.contentWindow?n=t.contentWindow.document:n=window.frames[this.id].document;if(this.uploadOptions.success){e("#redactor-progress").hide();if(typeof n!="undefined"){var r=n.body.innerHTML,i=r.match(/\{(.|\n)*\}/)[0];i=i.replace(/^\[/,""),i=i.replace(/\]$/,"");var s=e.parseJSON(i);typeof s.error=="undefined"?this.uploadOptions.success(s):(this.uploadOptions.error(this,s),this.modalClose())}else this.modalClose(),alert("Upload failed!")}this.el.attr("action",this.element_action),this.el.attr("target","")},draguploadInit:function(t,n){this.draguploadOptions=e.extend({url:!1,success:!1,error:!1,preview:!1,uploadFields:!1,text:this.opts.curLang.drop_file_here,atext:this.opts.curLang.or_choose,uploadParam:!1},n);if(window.FormData===undefined)return!1;this.droparea=e('<div class="redactor_droparea"></div>'),this.dropareabox=e('<div class="redactor_dropareabox">'+this.draguploadOptions.text+"</div>"),this.dropalternative=e('<div class="redactor_dropalternative">'+this.draguploadOptions.atext+"</div>"),this.droparea.append(this.dropareabox),e(t).before(this.droparea),e(t).before(this.dropalternative),this.dropareabox.on("dragover",e.proxy(function(){return this.draguploadOndrag()},this)),this.dropareabox.on("dragleave",e.proxy(function(){return this.draguploadOndragleave()},this)),this.dropareabox.get(0).ondrop=e.proxy(function(e){e.preventDefault(),this.dropareabox.removeClass("hover").addClass("drop"),this.dragUploadAjax(this.draguploadOptions.url,e.dataTransfer.files[0],!1,!1,!1,this.draguploadOptions.uploadParam)},this)},dragUploadAjax:function(t,n,r,i,s,o){if(!r){var u=e.ajaxSettings.xhr();u.upload&&u.upload.addEventListener("progress",e.proxy(this.uploadProgress,this),!1),e.ajaxSetup({xhr:function(){return u}})}var a=new FormData;o!==!1?a.append(o,n):a.append("file",n),this.opts.uploadFields!==!1&&typeof this.opts.uploadFields=="object"&&e.each(this.opts.uploadFields,e.proxy(function(t,n){n!=null&&n.toString().indexOf("#")===0&&(n=e(n).val()),a.append(t,n)},this)),e.ajax({url:t,dataType:"html",data:a,cache:!1,contentType:!1,processData:!1,type:"POST",success:e.proxy(function(t){t=t.replace(/^\[/,""),t=t.replace(/\]$/,"");var n=typeof t=="string"?e.parseJSON(t):t;if(r){i.fadeOut("slow",function(){e(this).remove()});var o=e("<img>");o.attr("src",n.filelink).attr("id","drag-image-marker"),this.insertNodeToCaretPositionFromPoint(s,o[0]);var u=e(this.$editor.find("img#drag-image-marker"));u.length?u.removeAttr("id"):u=!1,this.sync(),this.observeImages(),u&&this.callback("imageUpload",u,n),typeof n.error!="undefined"&&this.callback("imageUploadError",n)}else typeof n.error=="undefined"?this.draguploadOptions.success(n):(this.draguploadOptions.error(this,n),this.draguploadOptions.success(!1))},this)})},draguploadOndrag:function(){return this.dropareabox.addClass("hover"),!1},draguploadOndragleave:function(){return this.dropareabox.removeClass("hover"),!1},uploadProgress:function(e,t){var n=e.loaded?parseInt(e.loaded/e.total*100,10):e;this.dropareabox.text("Loading "+n+"% "+(t||""))},isMobile:function(){return/(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent)},normalize:function(e){return typeof e=="undefined"?0:parseInt(e.replace("px",""),10)},outerHtml:function(t){return e("<div>").append(e(t).eq(0).clone()).html()},isString:function(e){return Object.prototype.toString.call(e)=="[object String]"},isEmpty:function(e){return e=e.replace(/&#x200b;|<br>|<br\/>|&nbsp;/gi,""),e=e.replace(/\s/g,""),e=e.replace(/^<p>[^\W\w\D\d]*?<\/p>$/i,""),e==""},browser:function(e){var t=navigator.userAgent.toLowerCase(),n=/(chrome)[ \/]([\w.]+)/.exec(t)||/(webkit)[ \/]([\w.]+)/.exec(t)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(t)||/(msie) ([\w.]+)/.exec(t)||t.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(t)||[];return e=="version"?n[2]:e=="webkit"?n[1]=="chrome"||n[1]=="webkit":n[1]==e},oldIE:function(){return this.browser("msie")&&parseInt(this.browser("version"),10)<9?!0:!1},getFragmentHtml:function(e){var t=e.cloneNode(!0),n=this.document.createElement("div");return n.appendChild(t),n.innerHTML},extractContent:function(){var e=this.$editor[0],t=this.document.createDocumentFragment(),n;while(n=e.firstChild)t.appendChild(n);return t},isParentRedactor:function(t){return t?this.opts.iframe?t:e(t).parents("div.redactor_editor").length==0||e(t).hasClass("redactor_editor")?!1:t:!1},currentOrParentIs:function(e){var t=this.getParent(),n=this.getCurrent();return t&&t.tagName===e?t:n&&n.tagName===e?n:!1},isEndOfElement:function(){var t=this.getBlock(),n=this.getCaretOffset(t),r=e.trim(e(t).text()).replace(/\n\r\n/g,""),i=r.length;return n==i?!0:!1},isFocused:function(){var t,n=this.getSelection();return n&&n.rangeCount&&n.rangeCount>0&&(t=n.getRangeAt(0).startContainer),t?this.opts.iframe?this.getCaretOffsetRange().equals()?!this.$editor.is(t):!0:e(t).closest("div.redactor_editor").length!=0:!1},removeEmptyAttr:function(t,n){e(t).attr(n)==""&&e(t).removeAttr(n)},removeFromArrayByValue:function(e,t){var n=null;while((n=e.indexOf(t))!==-1)e.splice(n,1);return e}},r.prototype.init.prototype=r.prototype,e.Redactor.fn.formatLinkify=function(t,n,r,i,s){var o=/(^|&lt;|\s)(www\..+?\..+?)(\s|&gt;|$)/g,u=/(^|&lt;|\s)(((https?|ftp):\/\/|mailto:).+?)(\s|&gt;|$)/g,a=/(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/gi,f=/https?:\/\/(?:[0-9A-Z-]+\.)?(?:youtu\.be\/|youtube\.com\S*[^\w\-\s])([\w\-]{11})(?=[^\w\-]|$)(?![?=&+%\w.-]*(?:['"][^<>]*>|<\/a>))[?=&+%\w.-]*/ig,l=/https?:\/\/(www\.)?vimeo.com\/(\d+)($|\/)/,c=(this.$editor?this.$editor.get(0):this).childNodes,h=c.length;while(h--){var p=c[h];if(p.nodeType===3){var d=p.nodeValue;if(i&&d){var v='<iframe width="500" height="281" src="',m='" frameborder="0" allowfullscreen></iframe>';d.match(f)?(d=d.replace(f,v+"//www.youtube.com/embed/$1"+m),e(p).after(d).remove()):d.match(l)&&(d=d.replace(l,v+"//player.vimeo.com/video/$2"+m),e(p).after(d).remove())}r&&d&&d.match(a)&&(d=d.replace(a,'<img src="$1">'),e(p).after(d).remove());if(n&&d&&(d.match(o)||d.match(u))){var g=d.match(o)||d.match(u);g=g[0],g.length>s&&(g=g.substring(0,s)+"..."),d=d.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(o,'$1<a href="'+t+'$2">'+e.trim(g)+"</a>$3").replace(u,'$1<a href="$2">'+e.trim(g)+"</a>$5"),e(p).after(d).remove()}}else p.nodeType===1&&!/^(a|button|textarea)$/i.test(p.tagName)&&e.Redactor.fn.formatLinkify.call(p,t,n,r,i,s)}}}(jQuery),define("redactor",function(){}),define("text!scripts/redactor/ueditor-templates.html",[],function(){return'<div> \n<!-- \n	Wrap everything in a div to convert this file\'s content in a jquery element \n	so it is possible to use $.find.\n-->\n\n<script type="text/template" id="link-tpl">	\n	<input type="hidden" id="ueditor-link" value="{{url}}">\n	<div class="upfront-field-wrap">\n		<input type="radio" name="ueditor-link" value="external" class="upfront-field-radio"  {{link == \'external\' ? \'checked="checked"\' : \'\'}} id="ueditor-link-external">\n		<label for="ueditor-link-external">External URL</label>\n		<input type="text" value="{{url}}" id="ueditor-link-url" placeholder="Type link URL" style="{{link != \'external\' ? \'display:none\' : \'\'}}" class="upfront-field-text ueditor-link-hidden">\n	</div>\n	<div class="upfront-field-wrap">\n		<input type="radio" name="ueditor-link" value="post" class="upfront-field-radio" {{link == \'post\' ? \'checked="checked"\' : \'\'}} id="ueditor-link-post">\n		<label for="ueditor-link-post">Post or page</label>\n		<a title="Change link" href="#" class="ueditor-change-link-post ueditor-link-hidden" style="{{link != \'post\' ? \'display:none\' : \'\'}}">{{url}}</a>\n	</div>\n\n	{[if(anchors.length > 1) { ]}\n	<div class="upfront-field-wrap">\n		<input type="radio" name="ueditor-link" value="anchor" class="upfront-field-radio" {{link == \'anchor\' ? \'checked="checked"\' : \'\'}} id="ueditor-link-anchor">\n		<label for="ueditor-link-anchor">Anchor</label>\n		<div class="ueditor-anchor ueditor-link-hidden" style="{{link != \'anchor\' ? \'display:none\' : \'\'}}">\n			<select class="ueditor-anchor-selector">\n			{[ _.each(anchors, function(anchor){ ]}\n				<option value="#{{ anchor }}" {{ url == \'#\' + anchor ? \'selected="selected"\' : \'\' }}>{{anchor}}</option>\n			{[ }); ]}\n			</select>\n		</div>\n	</div>	\n	{[ } ]}\n\n	{[if(url) { ]}\n	<div class="upfront-field-wrap">\n		<a href="#" class="ueditor-unlink">Unlink</a>\n	</div>\n	{[ } ]}\n</script>\n\n\n</div>'}),function(e){define("ueditor",["text!scripts/redactor/ueditor-templates.html"],function(t){var n=!1,r=_.extend({},Backbone.Events);e.fn.ueditor=function(t){var r=!1,o=this,u;return n||i(),typeof t=="string"&&(r=!0),this.each(function(){var n=e(this),i=n.data("ueditor");i?r?u=i.callMethod(t):e.error("Ueditor is already instantiated"):r?e.error("Can't call the ueditor method "+t+". Ueditor not initialized"):(n.data("ueditor",new s(n,t)),s.prototype.redactorInitialized=!0)}),this.length==1&&typeof u!="undefined"?u:this};var i=function(){e.Redactor.prototype.buildEnable=function(){if(!this.pluginsBuilt){var t=this;this.opts.plugins||(this.opts.plugins=[]),this.pluginsBuilt=[],e.each(this.opts.plugins,function(n,r){var i=o[r];i&&(t.pluginsBuilt.push(i),e.extend(t,i),e.isFunction(i.beforeInit)&&t.beforeInit())})}this.$editor.addClass("redactor_editor").attr({contenteditable:!0,dir:this.opts.direction}),this.$source.attr("dir",this.opts.direction).hide(),this.set(this.content,!1,!1)},e.Redactor.prototype.buildPlugins=function(){var t=this;e.each(this.pluginsBuilt,function(n,r){if(e.isFunction(r.init)){var i=e.proxy(r.init,t);i()}})},e.Redactor.prototype.airEnable=function(){if(!this.opts.air)return;var t=[224,17,91,93];this.$editor.on("mouseup.redactor keyup.redactor",this,e.proxy(function(n){var r=this.getSelectionText();n.type==="mouseup"&&r!=""&&this.airShow(n);if(n.type==="keyup"&&n.shiftKey&&r!=""){var i=e(this.getElement(this.getSelection().focusNode)),s=i.offset();s.height=i.height(),this.airShow(s,!0)}"keyup"===n.type&&n.ctrlKey&&""!=r&&this.airShow(n),"keyup"===n.type&&t.indexOf(n.which)>0&&""!=r&&this.airShow(n)},this))},e.Redactor.prototype.airBindHide=function(){if(!this.opts.air)return;var t=e.proxy(function(t){e(t).on("mouseup.redactor",e.proxy(function(n){e(n.target).closest(this.$toolbar).length===0&&(this.getSelectionText()||(this.$air.fadeOut(100),this.selectionRemove(),e(t).off(n)))},this)).on("keydown.redactor",e.proxy(function(n){n.which===this.keyCode.ESC&&this.getSelection().collapseToStart(),this.$air.fadeOut(100),e(t).off(n)},this))},this);t(document),this.opts.iframe&&t(this.document)},e.Redactor.prototype.selectionSet=function(e,t,n,r){n===null&&(n=e),r===null&&(r=t);var i=this.getSelection();if(!i)return;var s=this.getRange();n!=e&&e.id=="selection-marker-1"&&(e=e.nextSibling,t=0,n=n.previousSibling,r=typeof n.length!="undefined"?n.length:n.innerText.length),s.setStart(e,t),s.setEnd(n,r);try{i.removeAllRanges()}catch(o){}i.addRange(s)},e.Redactor.prototype.airShow=function(t,n){if(!this.opts.air)return;e(".redactor_air").hide(),this.selectionRemoveMarkers(),this.selectionSave();var r=this.airWidth||this.$air.width(),i=this.$editor.find("#selection-marker-1").offset(),s=this.$editor.find("#selection-marker-2").offset(),o=s.top<i.top?{top:s.top-55,left:s.left,right:i.left,i:2}:{top:i.top-55,left:i.left,right:s.left,i:1},u=!1,a=e(window),f=a.width()+a.scrollLeft(),l,c;this.airWidth||(this.airWidth=r,this.$air.width(r));if(o.right<o.left||o.right>f){var c=this.$editor.find("#selection-marker-"+o.i).parent();o.right=Math.min(f,c.offset().left+c.width())}l=Math.floor((o.right+o.left+1)/2),l+r/2>f?(this.$air.addClass("at-right"),l>f&&(l=f-5),o.left=l-r):(this.$air.removeClass("at-right"),o.left=l-Math.floor((r+1)/2)),this.selectionRemoveMarkers(),this.$air.css({left:o.left+"px",top:o.top+"px"}).show(),this.airBindHide(),this.$air.trigger("show")},e.Redactor.prototype.doInsertLineBreak=e.Redactor.prototype.insertLineBreak,e.Redactor.prototype.insertLineBreak=function(){return this.opts.disableLineBreak?!1:this.doInsertLineBreak()},n=!0,e.Redactor.prototype.events=r},s=function(t,n){var i=this.pluginList(n);this.$el=t,this.options=e.extend({autostart:!0,stateButtons:{},air:!0,linebreaks:!0,disableLineBreak:!1,placeholder:"Your text here...",focus:!0,cleanup:!1,plugins:i,airButtons:["upfrontFormatting","bold","italic","blockquote","upfrontLink","stateLists","stateAlign","upfrontColor"],buttonsCustom:{},activeButtonsAdd:{},observeLinks:!1,formattingTags:["h1","h2","h3","h4","p","pre"]},n),this.options.initCallback=function(){r.trigger("ueditor:init",this)},this.options.enterCallback=function(){r.trigger("ueditor:enter",this)},this.options.changeCallback=function(){r.trigger("ueditor:change",this)},this.options.pasteBeforeCallback=function(){r.trigger("ueditor:paste:before",this)},this.options.pasteAfterCallback=function(){r.trigger("ueditor:paste:after",this)},this.options.focusCallback=function(){r.trigger("ueditor:focus",this)},this.options.blurCallback=function(){r.trigger("ueditor:blur",this)},this.options.keyupCallback=function(e){r.trigger("ueditor:key:up",this)},this.options.keydownCallback=function(e){r.trigger("ueditor:key:down",this)},this.options.textareaKeydownCallback=function(){r.trigger("ueditor:key:down:textarea",this)},this.options.syncBeforeCallback=function(e){return r.trigger("ueditor:sync:before",this,e),e},this.options.syncAfterCallback=function(e){r.trigger("ueditor:sync:after",this,e),t.trigger("syncAfter",e)},this.options.autosaveCallback=function(){r.trigger("ueditor:autosave",this)},this.id="ueditor"+Math.random()*1e4,this.options.autostart?this.redactor=this.start():(this.bindStartEvents(),this.startPlaceholder())};s.prototype={disableStop:!1,mouseupListener:!1,start:function(){this.stopPlaceholder(),this.$el.addClass("ueditable").removeClass("ueditable-inactive").attr("title","").redactor(this.options),this.$el.trigger("start"),this.redactor=this.$el.data("redactor"),this.redactor.ueditor=this,this.preventDraggable(),this.redactor.selectionRemoveMarkers(),r.trigger("ueditor:start",this.redactor),Upfront.data.Ueditor||(Upfront.data.Ueditor={instances:{}}),Upfront.data.Ueditor.instances[this.id]=this,this.mouseupListener=e.proxy(this.listenForMouseUp,this),this.$el.on("mousedown",this.mouseupListener)},stop:function(){this.redactor&&(r.trigger("ueditor:stop",this.redactor),this.$el.trigger("stop"),this.restoreDraggable(),this.$el.removeClass("ueditable"),this.redactor.destroy(),this.redactor=!1),delete Upfront.data.Ueditor.instances[this.id],this.startPlaceholder()},bindStartEvents:function(){var t=this,n=function(n){var r=document.getSelection?document.getSelection():document.selection;if(r&&r.type=="Range")return;if(!t.options.autostart&&t.redactor){var i=e(n.target);!t.disableStop&&!i.closest(".redactor_air").length&&!i.closest(".ueditable").length&&(t.stop(),t.bindStartEvents())}};t.$el.addClass("ueditable-inactive").attr("title","Double click to edit the text").one("dblclick",function(r){t.redactor||(t.start(r),e(document).on("click",n))})},callMethod:function(e){var t=this.$el.redactor(e);return r.trigger("ueditor:method:"+e,this.$el.redactor),t},startPlaceholder:function(){console.log("start placeholder");var t=this.options.placeholder;this.$el.attr("placeholder")&&(t=this.$el.attr("placeholder")),t===""&&(t=!1);if(t!==!1&&e.trim(this.$el.text()).length===0){this.$placeholder=this.$el.clone(!1),this.$placeholder.attr("contenteditable",!1).removeClass("ueditable redactor_editor").addClass("ueditor-placeholder").html(t),this.$el.after(this.$placeholder);var n=this.$el.parent();n.css("position")=="static"&&n.css("position","relative"),this.$el.css("position")=="static"&&this.$el.css("position","relative"),this.$el.css("z-index",1);var r=this.$el.position();this.$placeholder.css({position:"absolute","z-index":"0",top:r.top,left:r.left,right:n.outerWidth()-(r.left+this.$el.outerWidth())}),this.$el.html("&nbsp;"),this.options.placeholder=t}},stopPlaceholder:function(){console.log("stop placeholder"),this.$placeholder&&this.$placeholder.remove(),this.$el.html()=="&nbsp;"&&this.$el.html("")},preventDraggable:function(){var e=this.$el.closest(".ui-draggable"),t=e.draggable("option","cancel");_.isString(t)&&t.indexOf(".ueditable")==-1&&e.draggable("option","cancel",t+",.ueditable")},restoreDraggable:function(){var e=this.$el.closest(".ui-draggable"),t=e.draggable("option","cancel");_.isString(t)&&t.indexOf(".ueditable")!=-1&&e.draggable("option","cancel",t.replace(/,\.ueditable/g,""))},pluginList:function(t){var n=["stateAlignment","stateLists","blockquote","stateButtons","upfrontLink","upfrontColor","panelButtons","upfrontMedia","upfrontImages","upfrontFormatting","upfrontSink","upfrontPlaceholder"],r=[];return e.each(n,function(e,n){(typeof t[n]=="undefined"||t[n])&&r.push(n)}),r},listenForMouseUp:function(){var t=this;t.redactor||(t.redactor=t.$el.data("redactor")),t.redactor&&(t.redactor.waitForMouseUp=!0),e(document).one("mouseup",function(e){t.redactor&&t.redactor.waitForMouseUp&&t.redactor.getSelectionText()&&(t.redactor.airShow(e),t.redactor.$element.trigger("mouseup.redactor"))})}};if(!o)var o={};o.stateButtons={beforeInit:function(){this.addStateButtons(),this.startStateObserver()},addStateButtons:function(){if(this.stateButtons)return;var t=this;this.stateButtons={},e.each(this.opts.stateButtons,function(e,n){var r=new t.StateButton(e,n);t.stateButtons[e]=r,t.opts.buttonsCustom[e]=r})},startStateObserver:function(){var t=e.proxy(this.stateObserver,this);this.$element.on("mouseup.redactor keyup.redactor",t)},stateObserver:function(){var t=this;e.each(this.stateButtons,function(e,n){n.guessState(t)}),t.waitForMouseUp=!1},StateButton:function(t,n){var r=this,i={},s=!1;return firstState=!1,r.id=t,r.currentState=n.defaultState,r.states=n.states,r.iconClasses="",r.defaultState=n.defaultState,e.each(r.states,function(e,t){s?i[s]=e:firstState=e,r.iconClasses+=" "+t.iconClass,s=e}),i[s]=firstState,r.nextStates=i,r.nextState=function(e){this.setState(r.nextStates[this.currentState],e)},r.setState=function(e,t){this.currentState=e,t.removeClass(this.iconClasses).addClass(this.states[this.currentState].iconClass)},r.triggerState=function(t,n,r,i){var s=e.proxy(this.states[this.currentState].callback,t);s(n,r,i)},r.guessState=function(t){var n=!1;e.each(this.states,function(e,r){n=r.isActive(t)?e:n}),n||(n=this.defaultState),this.setState(n,this.getElement(t))},r.getElement=function(e){return e.$toolbar.find(".redactor_btn_"+this.id)},{id:t,title:n.title,callback:function(e,t,n){n.nextState(t),n.triggerState(this,e,t,n)},nextState:e.proxy(r.nextState,r),setState:e.proxy(r.setState,r),triggerState:e.proxy(r.triggerState,r),guessState:e.proxy(r.guessState,r)}}},o.stateAlignment={beforeInit:function(){this.opts.stateButtons.stateAlign={title:"Text alignment",defaultState:"left",states:{left:{iconClass:"ueditor-left",isActive:function(t){var n=e(t.getSelection().baseNode);return n.length&&n[0].nodeType==3&&(n=n.parent()),n.length&&n.css("text-align")=="left"},callback:function(e,t,n){this.alignmentLeft()}},center:{iconClass:"ueditor-center",isActive:function(t){var n=e(t.getSelection().baseNode);return n.length&&n[0].nodeType==3&&(n=n.parent()),n.length&&n.css("text-align")=="center"},callback:function(e,t,n){this.alignmentCenter()}},right:{iconClass:"ueditor-right",isActive:function(t){var n=e(t.getSelection().baseNode);return n.length&&n[0].nodeType==3&&(n=n.parent()),n.length&&n.css("text-align")=="right"},callback:function(e,t,n){this.alignmentRight()}},justify:{iconClass:"ueditor-justify",isActive:function(t){var n=e(t.getSelection().baseNode);return n.length&&n[0].nodeType==3&&(n=n.parent()),n.length&&n.css("text-align")=="justify"},callback:function(e,t,n){this.alignmentJustify()}}}}}},o.stateLists={beforeInit:function(){this.opts.stateButtons.stateLists={title:"List style",defaultState:"none",states:{none:{iconClass:"ueditor-nolist",isActive:function(t){var n=e(t.getParent());return n.length&&n.css("text-align")=="left"},callback:function(e,t,n){this.execLists("insertorderedlist","orderedlist")}},unordered:{iconClass:"ueditor-unorderedlist",isActive:function(t){var n=e(t.getParent());if(n.length){var r=n.closest("ul");if(r.length)return r.closest(".ueditable").length}return!1},callback:function(e,t,n){this.execLists("insertunorderedlist","unorderedlist")}},ordered:{iconClass:"ueditor-orderedlist",isActive:function(t){var n=e(t.getParent());if(n.length){var r=n.closest("ol");if(r.length)return r.closest(".ueditable").length}return!1},callback:function(e,t,n){this.execLists("insertorderedlist","orderedlist")}}}}}},o.panelButtons={init:function(){var t=this;e.each(this.opts.buttonsCustom,function(n,r){if(r.panel){var i=e('<div class="redactor_dropdown ueditor_panel redactor_dropdown_box_'+n+'" style="display: none;">'),s=t.$toolbar.find(".redactor_btn_"+n);r.panel=new r.panel({redactor:t,button:s,panel:i}),i.html(r.panel.$el),i.appendTo(t.$toolbar),r.dropdown=!0,s.on("click",function(){s.hasClass("dropact")?(t.selectionRemoveMarkers(),t.selectionSave(),t.selectionRemoveMarkers(),r.panel.trigger("open",t)):r.panel.trigger("closed",t)}),t.$editor.on("mouseup.redactor keyup.redactor",function(){s.hasClass("dropact")&&(t.dropdownHideAll(),r.panel.trigger("closed",t))}),i.on("click keydown keyup",function(e){e.stopPropagation()})}})}};var u=Backbone.View.extend({initialize:function(e){var t=this;t.redactor=e.redactor,t.button=e.button,t.panel=e.panel,this.on("open",function(e){console.log("Panel open"),t.$el.trigger("open",e)}),this.on("closed",function(e){console.log("Panel closed"),t.$el.trigger("closed",e)}),this.render()},openToolbar:function(e){var t=this;t.redactor.$air.show(),t.redactor.airBindHide(),e&&setTimeout(function(){t.panel.is(":visible")||t.button.click()},300)},closeToolbar:function(){this.redactor.$air.fadeOut(100)},closePanel:function(){this.panel.is(":visible")&&this.button.click()},disableEditorStop:function(){this.redactor.ueditor.disableStop=!0},enableEditorStop:function(){var e=this;setTimeout(function(){e.redactor.ueditor.disableStop=!1},300)},appendOkButton:function(t){var n=this;if(!n.$el.siblings(".ueditor-ok").length){t=t||"Ok";var r=e('<a class="ueditor-ok">'+t+"</a>").on("click",function(e){n.$el.trigger("ok")});r.insertAfter(n.$el)}}});o.upfrontLink={beforeInit:function(){this.opts.buttonsCustom.upfrontLink={title:"Link",panel:this.panel}},panel:u.extend({tpl:_.template(e(t).find("#link-tpl").html()),events:{"click .ueditor-unlink":"unlink","change .upfront-field-radio":"updateLinkType","click .ueditor-change-link-post":"selectPost",open:"open",close:"close",ok:"prepareLink"},render:function(e){e=e||{},this.$el.html(this.tpl({url:e.url,link:e.link,anchors:this.getAnchors()})),this.appendOkButton()},open:function(t,n){this.redactor=n;var r=n.currentOrParentIs("A");r?this.render({url:e(r).attr("href"),link:e(r).attr("rel")||"external"}):this.render()},close:function(e,t){this.redactor.selectionRemoveMarkers()},unlink:function(e){e.preventDefault(),this.redactor.execCommand("unlink"),this.closeToolbar()},link:function(e,t){if(e){this.redactor.selectionRestore(!0,!1);var n=this.redactor.getSelection().toString();this.redactor.exec("insertHTML",'<a href="'+e+'" rel="'+t+'">'+n+"</a>"),this.redactor.selectionRemoveMarkers()}},prepareLink:function(e){var t=this.$('input[name="ueditor-link"]:checked').val(),n="";t&&(t=="external"?n=this.$("#ueditor-link-url").val():t=="post"?n=this.$(".ueditor-change-link-post").text():t=="anchor"&&(n=this.$(".ueditor-anchor-selector").val())),this.link(n,t),this.closeToolbar()},updateLinkType:function(e){var t=this.$('input[name="ueditor-link"]:checked').val();this.$(".ueditor-link-hidden").hide(),t=="external"?this.$("#ueditor-link-url").show():t=="post"?this.selectPost():t=="anchor"&&this.$(".ueditor-anchor").show()},selectPost:function(){var e=this,t={},n=[];_.each(Upfront.data.ugallery.postTypes,function(e){e.name!="attachment"&&n.push({name:e.name,label:e.label})}),t.postTypes=n,this.disableEditorStop(),Upfront.Views.Editor.PostSelector.open(t).done(function(t){e.enableEditorStop(),e.link(t.get("permalink"),"post")})},getAnchors:function(){var e=Upfront.Application.layout.get("regions"),t=[""];return e.each(function(e){e.get("modules").each(function(e){e.get("objects").each(function(e){var n=e.get_property_value_by_name("anchor");n&&n.length&&t.push(n)})})}),t}})},o.upfrontColor={beforeInit:function(){this.opts.buttonsCustom.upfrontColor={title:"Color",panel:this.panel}},panel:u.extend({current_color:!1,current_bg:!1,events:{open:"open"},setCurrentColors:function(){var t=this.redactor.getParent();if(t||t&&e(t).prop("tagName")=="INLINE"){var n=e(t).css("background-color").split(",");this.current_color=e(t).css("color");if(n.length<4||parseFloat(n[3].replace(")",""))>0)this.current_bg=e(t).css("background-color")}else this.current_color=this.current_bg=!1},open:function(e,t){this.setCurrentColors(),this.current_color?(this.$("li#tabforeground-content").find(".sp-dragger").css("border-bottom-color",this.current_color),this.$("li#tabforeground-content").find(".sp-dragger").css("border-left-color",this.current_color),this.$("input.foreground").spectrum("option","color",this.current_color)):this.$("input.foreground").spectrum("option","color","#000"),this.current_bg?(this.$("li#tabbackground-content").find(".sp-dragger").css("border-bottom-color",this.current_bg),this.$("li#tabbackground-content").find(".sp-dragger").css("border-left-color",this.current_bg),this.$("input.background").spectrum("option","color",this.current_bg)):this.$("input.background").spectrum("option","color","#000"),this.$("input.foreground").spectrum("resetUI"),this.$("input.background").spectrum("resetUI")},render:function(){var t=e('<li id="tabforeground" class="active">').html("Text Color"),n=e('<li id="tabbackground">').html("Text Background"),r=e('<ul class="tablist">').append(t).append(n),i=e('<ul class="tabs">').append(e('<li id="tabforeground-content" class="active">').html('<input class="foreground" type="text">')).append(e('<li id="tabbackground-content">').html('<input class="background" type="text">')),s=this.redactor,o=this,u=function(){o.setCurrentColors(),o.current_bg?s.$toolbar.find(".redactor_btn.redactor_btn_upfrontColor").removeClass("transparent").css("border-color",o.current_bg):s.$toolbar.find(".redactor_btn.redactor_btn_upfrontColor").addClass("transparent").css("border-color",""),o.current_color?s.$toolbar.find(".redactor_btn.redactor_btn_upfrontColor").css("color",o.current_color):s.$toolbar.find(".redactor_btn.redactor_btn_upfrontColor").css("color","")};s.bufferAirBindHide=this.redactor.airBindHide,s.airBindHide=function(){u(),s.bufferAirBindHide()};var a=function(){o.current_color&&typeof o.current_color=="object"&&(s.selectionRestore(!0,!1),s.inlineRemoveStyle("color"),s.inlineSetStyle("color",o.current_color.toRgbString())),o.current_bg&&typeof o.current_bg=="object"&&(s.selectionRestore(!0,!1),s.inlineRemoveStyle("background-color"),o.current_bg.toRgbString().toLowerCase()!="rgba(0, 0, 0, 0)"&&s.inlineSetStyle("background-color",o.current_bg.toRgbString())),u(),s.selectionRemove(),s.sync(),o.closePanel(),o.closeToolbar()};r.children("li").on("click",function(){r.children("li").removeClass("active"),e(this).addClass("active"),i.children("li").removeClass("active"),i.children("li#"+e(this).attr("id")+"-content").addClass("active"),o.$("input.foreground").spectrum("option","color",typeof o.current_color=="object"?o.current_color.toRgbString():o.current_color),o.$("input.foreground").spectrum("resetUI"),o.$("input.background").spectrum("option","color",typeof o.current_bg=="object"?o.current_bg.toRgbString():o.current_bg),o.$("input.background").spectrum("resetUI")}),this.$el.html(r).append(i),this.$("input.foreground").spectrum({flat:!0,showAlpha:!0,showPalette:!0,palette:["fff","000","f00"],localStorageKey:"spectrum.recent_colors",maxSelectionSize:10,preferredFormat:"hex",chooseText:"Ok",showInput:!0,change:function(e){a()},move:function(t){s.selectionRestore(!0,!1),o.current_color=t,e(this).parent().find(".sp-dragger").css("border-top-color",t.toRgbString()),e(this).parent().find(".sp-dragger").css("border-right-color",t.toRgbString())}}),this.$("input.background").spectrum({flat:!0,showAlpha:!0,showPalette:!0,palette:["fff","000","0f0"],maxSelectionSize:9,localStorageKey:"spectrum.recent_bgs",preferredFormat:"hex",chooseText:"Ok",showInput:!0,allowEmpty:!0,change:function(e){a()},move:function(t){s.selectionRestore(!0,!1),o.current_bg=t,e(this).parent().find(".sp-dragger").css("border-top-color",t.toRgbString()),e(this).parent().find(".sp-dragger").css("border-right-color",t.toRgbString())}}),s.selectionSave()}})},o.upfrontFormatting={beforeInit:function(){this.opts.buttonsCustom.upfrontFormatting={title:"Formatting",panel:this.panel}},panel:u.extend({tags:{p:"P",h1:"H1",h2:"H2",h3:"H3",h4:"H4",h5:"H5",pre:"&lt;/&gt;",blockquote:'"'},events:{"click .ueditor-format-option":"applyTag",open:"selectionSave"},render:function(){var e=this,t="";_.each(this.redactor.opts.formattingTags,function(n){t+='<a class="ueditor-format-option ueditor-format-'+n+'" data-value="'+n+'">'+e.tags[n]+"</a>"}),this.button.html("&para;"),this.$el.html(t)},applyTag:function(t){var n=e(t.target).data("value");this.redactor.selectionRestore(),this.redactor.formatBlocks(n),this.closePanel()},selectionSave:function(e){this.redactor.selectionSave()}})},o.blockquote={beforeInit:function(){var t=this;this.opts.stateButtons.blockquote={title:"Set a quote",defaultState:"noquote",states:{noquote:{iconClass:"ueditor-noquote",isActive:function(e){var n=t.getQuote();return!n},callback:function(e,n,r){t.formatQuote("blockquote")}},quote:{iconClass:"ueditor-quote",isActive:function(n){var r=t.getQuote();return r&&!e(r).hasClass("upfront-quote-alternative")},callback:function(e,n,r){t.formatQuote("blockquote")}},alternative:{iconClass:"ueditor-quote-alternative",isActive:function(n){var r=t.getQuote();return r&&e(r).hasClass("upfront-quote-alternative")},callback:function(e,n,r){t.getQuote().addClass("upfront-quote-alternative")}}}}},getQuote:function(){var t=e(this.getParent());return t.prop("tagName")=="BLOCKQUOTE"?t:(t=t.closest("blockquote"),t.closest(".redactor_box").length?t:!1)}},o.upfrontMedia={beforeInit:function(){this.events.on("ueditor:init",this.reinsert_handlers_callback),this.events.on("ueditor:enter",this.reinsert_handlers_callback),this.events.on("ueditor:insert:media",this.reinsert_handlers_callback),this.events.on("ueditor:stop",function(){e(".upfront-image-attachment-bits").remove()})},reinsert_handlers_callback:function(t){var n=t.$editor,r=n.offset(),i=e("body"),s=n.find("p:not(.upfront-inserted_image-wrapper),div,ul,ol");e(document).off("click",".upfront-image-attachment-bits"),e(".upfront-image-attachment-bits").remove(),s.each(function(t){var n=e(this),s=n.offset();i.append("<div data-idx='"+t+"' class='upfront-image-attachment-bits' style='top:"+(s.top-20)+"px;left:"+(r.left-18)+"px;' />"),n.on("mouseenter",function(){e(".upfront-image-attachment-bits").hide();var n=e('.upfront-image-attachment-bits[data-idx="'+t+'"]');n.length&&n.show()})}),e(document).on("click",".upfront-image-attachment-bits",function(n){var r=e(this),i=r.attr("data-idx");return Upfront.Media.Manager.open({ck_insert:!0}).done(function(n,r){var o=Upfront.Media.Manager.results_html(r),u=e(s[i]);u.before("<div id='upfront-insert-media-insertion_point'>upfront:insert:media:insertion_point</div>"),u=e("#upfront-insert-media-insertion_point");var a=t.$editor.find("#upfront-insert-media-insertion_point");a.replaceWith(o),t.sync(),t.events.trigger("ueditor:insert:media",t,o)}),!1})}};var a={Image:{redactor:!1,selector:".upfront-inserted_image-wrapper",bind_events:function(){this.unbind_events(),this.redactor.$editor.on("mouseover",this.selector,this,this.hover_on).on("mouseout",this.selector,this,this.hover_off).on("mouseenter",":not("+this.selector+")",this,this.hover_off)},unbind_events:function(){this.redactor.$editor.off("mouseover",this.selector,this.hover_on).off("mouseout",this.selector,this.hover_off).off("mouseenter",":not("+this.selector+")",this,this.hover_off),this.remove_dialog()},hover_on:function(t){var n=e(t.target),r=e("#upfront-image-details");n.is(t.data.selector)||(n=n.closest(t.data.selector));if(!n.find("img").length)return;t.data.show_dialog(n),Upfront.Events.trigger("upfront:editor:image_on",n.get())},hover_off:function(t){var n=e(t.target);$isParent=e(t.toElement).closest("#upfront-image-details"),$isParent.length||t.data.remove_dialog()},create_dialog:function(){if(e("#upfront-image-details").length)return;var t=e("<div id='upfront-image-details' class='upfront-ui' />");t.append('<div class="upfront-image-orientation"><div class="upfront-image-align-left upfront-icon upfront-icon-image-left">left</div><div class="upfront-image-align-center upfront-icon upfront-icon-image-center">center</div><div class="upfront-image-align-right upfront-icon upfront-icon-image-right">right</div><div class="upfront-image-align-full upfront-icon upfront-icon-image-full">full width</div></div><div class="upfront-image-actions"><div class="upfront-image-action-change upfront-icon upfront-icon-image-select">Change Image</div><div class="upfront-image-action-details upfront-icon upfront-icon-image-detail">Image Details</div></div><div class="upfront-image-delete upfront-icon-button upfront-icon-button-delete"></div>'),e("body").append(t),t.find(".upfront-image-align-left").on("click",this,this.Align.left).end().find(".upfront-image-align-center").on("click",this,this.Align.center).end().find(".upfront-image-align-right").on("click",this,this.Align.right).end().find(".upfront-image-align-full").on("click",this,this.Align.full).end().find(".upfront-image-action-change").on("click",this,this.change_image).end().find(".upfront-image-action-details").on("click",this,this.Details.toggle).end().find(".upfront-image-delete").on("click",this,this.delete_image).end(),t.hide()},remove_dialog:function(t,n){var r=e("#upfront-image-details"),i=e("#upfront-image-details-image_details");i.length?t&&(i.remove(),r.hide()):(r.hide(),e("#upfront-inline-slider-nav").hide()),t&&n&&r.remove()},show_dialog:function(t){var n=e("#upfront-image-details");n.data("ref",t.get(0)),t.hasClass("upfront-inserted_image-slider")||t.hasClass("upfront-inserted_image-gallery")?n.addClass("no-orientation"):n.removeClass("no-orientation");var r=t.offset(),i=t.outerHeight(),s=t.outerWidth(),o=n.outerHeight();n.css({top:r.top+(o>i?0:i-o),left:r.left,width:s}),n.show()},get_target:function(t){return e(e(t).closest("#upfront-image-details").data("ref"))},change_image:function(e){var t=e.data.get_target(e.target);return Upfront.Media.Manager.open({multiple_selection:!1,button_text:"Change image"}).done(function(n,r){if(!r)return!1;if(!r.length)return!1;var i=Upfront.Media.Manager.results_html(r);t.replaceWith(i),e.data.redactor.sync(),e.data.bind_events()}),!1},delete_image:function(e){var t=e.data.get_target(e.target),n=t.parent(),r=n.hasClass("upfront-inline_post-slider"),i=n.hasClass("upfront-inline_post-gallery");return(r||i)&&n.find("img")==1?n.remove():t.remove(),r&&Slider.reset_nav(n),e.data.redactor.sync(),e.data.redactor.focus(),!1},Align:{_apply:function(t,n){n=e.extend({"float":"","text-align":"",width:""},n),t.css(n)},left:function(e){var t=e.data.get_target(e.target),n=t.find("img");return e.data.Align._apply(t,{"float":"left"}),e.data.Align._apply(n,{}),e.data.show_dialog(t),Upfront.Events.trigger("upfront:editor:image_align",t.get(),"left"),e.data.redactor.sync(),!1},center:function(e){var t=e.data.get_target(e.target),n=t.find("img");return e.data.Align._apply(t,{"text-align":"center"}),e.data.Align._apply(n,{}),e.data.show_dialog(t),Upfront.Events.trigger("upfront:editor:image_align",t.get(),"center"),e.data.redactor.sync(),!1},right:function(e){var t=e.data.get_target(e.target),n=t.find("img");return e.data.Align._apply(t,{"float":"right"}),e.data.Align._apply(n,{}),e.data.show_dialog(t),Upfront.Events.trigger("upfront:editor:image_align",t.get(),"right"),e.data.redactor.sync(),!1},full:function(e){var t=e.data.get_target(e.target),n=t.find("img");return e.data.Align._apply(t,{}),e.data.show_dialog(t),Upfront.Events.trigger("upfront:editor:image_align",t.get(),"full"),e.data.redactor.sync(),!1}},Details:{toggle:function(t){var n=e("#upfront-image-details"),r=e("#upfront-image-details-image_details");return r.length?t.data.Details.close(t):t.data.Details.open(t),!1},open:function(t){var n=t.data.get_target(t.target),r=n.find("img"),i=e("#upfront-image-details"),s=i.find(".upfront-image-action-details"),o=e('<div id="upfront-image-details-image_details" />'),u=n.find("a"),a=u.length?"":'checked="checked"',f=u.length&&u.is(".popup")?'checked="checked"':"",l=u.length&&u.attr("href").match(/^[^#]+/)?'checked="checked"':"",c=u.length&&!!l?u.attr("href"):"";o.append('<div class="upfront-image-detail-alt"><label class="upfront-field-label">Image Details:</label><input class="upfront-field upfront-field-text" type="text" placeholder="Alt" value="'+r.attr("alt")+'" />'+"</div>"+'<div class="upfront-image-detail-link">'+'<label class="upfront-field-label">Image links to:</label>'+"<ul>"+'<li><label><input class="upfront-field-radio" type="radio" '+a+' name="link_to" value="" /> No link</label></li>'+'<li><label><input class="upfront-field-radio" type="radio" '+f+' name="link_to" value="popup" /> Larger version (opens in lightbox)</label></li>'+'<li><label><input class="upfront-field-radio" type="radio" '+l+' name="link_to" value="link" /> Link <input class="upfront-field upfront-field-text" type="text" placeholder="http://www.google.com" value="'+c+'" /></label></li>'+'<li><label><input class="upfront-field-radio" type="radio" name="link_to" value="post" /> Post or page <em>/your-cool-post/</em></label></li>'+"</ul>"+"</div>"+'<button class="upfront-image-detail-button" type="button">OK</button>'),o.css({position:"absolute",top:s.offset().top+s.height(),"z-index":99}),e("body").append(o),o.css({left:s.offset().left+46-o.width()/2}),s.addClass("upfront-image-action-details-active"),o.on("click","button",t.data,t.data.Details.apply_details)},close:function(t){var n=e("#upfront-image-details"),r=n.find(".upfront-image-action-details"),i=e("#upfront-image-details-image_details");r.removeClass("upfront-image-action-details-active"),i.remove()},apply_details:function(t){var n=e("#upfront-image-details"),r=e("#upfront-image-details-image_details"),i=e(n.data("ref")),s=i.find("img"),o=i.find("a"),u=r.find(".upfront-image-detail-alt :text").val(),a=r.find(".upfront-image-detail-link :radio:checked").val(),f=r.find(".upfront-image-detail-link :text").val();s.attr("alt",u);if(a){var l=o.length?o:e('<a href="#" />');switch(a){case"popup":l.addClass("popup");break;case"link":l.attr("href",f);break;case"post":l.attr("href","http://localhost/upfront/edit/post/8")}o.length||s.wrapAll(l)}else o.length&&o.replaceWith(s);return t.data.redactor.sync(),t.data.Details.close(t)}},cleanup:function(t){var n=e("<div />").append(t);return n.find("#upfront-image-details").remove(),n.html()}},Gallery:{to_html:function(e){var t=e.$editor.html(),n=t.replace(/\[upfront-gallery\](.*?)\[\/upfront-gallery\]/,'<div class="upfront-inline_post-gallery clearfix">$1</div>');e.$editor.html(n),e.sync()},from_html:function(t){var n=e("<div />").append(t),r=n.find(".upfront-inline_post-gallery");return r.length?(r.each(function(){var t=e(this),n="";n=t.html(),t.replaceWith("[upfront-gallery]"+n+"[/upfront-gallery]")}),n.html()):t}},Slider:{to_html:function(e){var t=e.$editor.html(),n=t.replace(/\[upfront-slider\](.*?)\[\/upfront-slider\]/,'<div class="upfront-inline_post-slider clearfix">$1</div>');e.$editor.html(n),e.sync(),this.init_sliders_edit(e)},init_sliders_edit:function(t){var n=t.$editor.find(".upfront-inline_post-slider"),r=e('<div id="upfront-inline-slider-nav" class="upfront-default-slider-nav upfront-ui" />');e("body").append(r),n.each(function(){function s(){n.css("height",9999),r.each(function(t){var n=e(this).find("img"),r=n.height();i=i>r?i:r}),n.css("height",Math.ceil(i/15)*15),t.sync()}var n=e(this),r=n.find(".upfront-inserted_image-wrapper"),i=0;s(),n.find("img").on("load",s)}),e(document).on("mouseenter",".upfront-inline_post-slider",this,this.hover_on).on("mouseleave",".upfront-inline_post-slider",this,this.hover_off),r.on("click",".upfront-default-slider-nav-item",this,this.slide_switch)},hover_on:function(t){var n=e(this),r=e("#upfront-inline-slider-nav"),i=n.offset(),s=n.outerHeight(),o=n.outerWidth(),u=t.data;r.css({top:i.top+s,left:i.left,width:o}),r.show();if(u.$current_slider&&u.$current_slider.get(0)==n.get(0))return;u.$current_slider=n,u.reset_nav(n)},hover_off:function(e){},slide_switch:function(t){var n=e(this),r=n.attr("data-slider-index"),i=e("#upfront-inline-slider-nav"),s=t.data;s.$current_slider.find(".slide-edit-active").removeClass("slide-edit-active"),s.$current_slider.find(".upfront-inserted_image-wrapper").eq(r).addClass("slide-edit-active"),i.find(".upfront-default-slider-nav-item-selected").removeClass("upfront-default-slider-nav-item-selected"),n.addClass("upfront-default-slider-nav-item-selected"),a.Image.remove_dialog(),i.show()},reset_nav:function(t){var n=e("#upfront-inline-slider-nav");n.html(""),t.find(".upfront-inserted_image-wrapper").each(function(e){n.append('<i class="upfront-default-slider-nav-item" data-slider-index="'+e+'">'+e+"</i>")}),n.find(".upfront-default-slider-nav-item:first").trigger("click")},from_html:function(t){var n=e("<div />").append(t),r=n.find(".upfront-inline_post-slider");return r.length?(r.each(function(){var t=e(this),n="";n=t.html(),t.replaceWith("[upfront-slider]"+n+"[/upfront-slider]")}),n.html()):t}}};o.upfrontImages={beforeInit:function(){var t=this;t.events.on("ueditor:stop",function(){a.Image.unbind_events()}),t.events.on("ueditor:insert:media",function(){a.Gallery.to_html(t),a.Slider.to_html(t)}),a.Image.redactor=t,a.Image.create_dialog(),a.Image.bind_events(),Upfront.Media.Transformations.add(a.Image.cleanup),Upfront.Media.Transformations.add(a.Gallery.from_html),Upfront.Media.Transformations.add(a.Slider.from_html),Upfront.Events.on("upfront:editor:image_align",function(t,n){var r=!1;"left"===n?r="margin-right":"right"===n&&(r="margin-left");if(!r)return!1;e(t).css(r,"15px")})}},o.upfrontSink={beforeInit:function(){var e=this;Upfront.data.ueditor||(Upfront.data.ueditor={sink:!1}),this.opts.buttonsCustom.upfrontSink={title:"More tools"}},init:function(){var t=this,n=this.$toolbar.find(".redactor_btn_upfrontSink").parent().addClass("upfront-sink-button"),r=this.$toolbar.find(".upfront-sink-button ~ li"),i=e('<div class="ueditor-sink"></div>');n.on("click",function(){Upfront.data.ueditor.sink?t.closeSink():t.openSink()}),r.detach().appendTo(i),this.$toolbar.append(i),Upfront.data.ueditor.sink&&this.$toolbar.addClass("ueditor-sink-open"),r.each(function(){var n=e(this).find("a").attr("class").match(/redactor_btn_[^\s]*/g),r=!1,i=!1;n.length&&(r=n[0].replace("redactor_btn_","")),i=t.$toolbar.find(".redactor_dropdown_box_"+r),i.length&&i.css({"margin-top":"40px"})}),this.$air.on("show",function(){Upfront.data.ueditor.sink&&t.$air.css({top:t.$air.offset().top-40})})},openSink:function(){Upfront.data.ueditor.sink=!0,this.$toolbar.addClass("ueditor-sink-open"),this.$air.css({top:this.$air.offset().top-40})},closeSink:function(){Upfront.data.ueditor.sink=!1,this.$toolbar.removeClass("ueditor-sink-open"),this.$air.css({top:this.$air.offset().top+40})}},o.upfrontPlaceholder={init:function(){var t=this.opts.placeholder;this.$element.attr("placeholder")&&(t=this.$element.attr("placeholder")),t===""&&(t=!1);if(t!==!1){this.placeholderRemove(),this.$placeholder=this.$editor.clone(!1),this.$placeholder.attr("contenteditable",!1).removeClass("ueditable redactor_editor").addClass("ueditor-placeholder").html(this.opts.linebreaks?t:this.cleanParagraphy(t)),this.$editor.after(this.$placeholder),this.$editor.css("position")=="static"&&this.$editor.css("position","relative"),this.$editor.css("z-index",1);var n=this.$editor.position();this.$placeholder.css({position:"absolute","z-index":"0",top:n.top,left:n.left,right:this.$box.outerWidth()-(n.left+this.$editor.outerWidth())}),this.opts.placeholder=t,this.$editor.on("focus keyup",e.proxy(this.placeholderUpdate,this)),this.placeholderUpdate()}},placeholderUpdate:function(){this.sync();var e=this.get();e==""?this.$placeholder.show():this.$placeholder.hide()}}})}(jQuery),function(e){define("ucomment",[],function(){var t=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(Upfront.data.ucomments.defaults);e.element_id=Upfront.Util.get_unique_id(e.id_slug+"-object"),this.init_properties(e)}}),n=Upfront.Views.ObjectView.extend({initialize:function(e){this.model instanceof t||(this.model=new t({properties:this.model.get("properties")})),this.constructor.__super__.initialize.call(this,[e])},get_content_markup:function(){var t=e(document).data("upfront-comment-"+_upfront_post_data.post_id);return t?t:"Loading"},on_render:function(){e(document).data("upfront-comment-"+_upfront_post_data.post_id)||this._get_comment_markup();var t=new s({model:this.model});t.render(),this.$el.append(t.$el)},_get_comment_markup:function(){var t=this;Upfront.Util.post({action:"ucomment_get_comment_markup",data:JSON.stringify({post_id:_upfront_post_data.post_id})}).success(function(n){var r=n.data.replace(/<script.*?>.*?<\/script>/gim,"");e(document).data("upfront-comment-"+_upfront_post_data.post_id,r),t.render()}).error(function(e){Upfront.Util.log("Error loading comment")})}}),r=Upfront.Models.ObjectModel.extend({cache:!1,load:function(){this.loading=e.Deferred();if(this.cache)this._populate();else{var t=this;Upfront.Util.post({action:"upfront-discussion_settings-get"}).done(function(e){t.cache=e.data,t._populate()})}return this.loading},_populate:function(){var t=_(this.cache.avatar_defaults).map(function(t){return t.icon&&(t.icon=t.icon.match(/^https?:\/\//)?t.icon:e(t.icon).attr("src")),t});this.set({properties:new Upfront.Collections.Properties(_(this.cache.properties).values()),avatars:_(t).values()}),this.loading.resolve()}}),i=Backbone.View.extend({className:"upfront-global_settings",events:{"click a.settings":"popup_open"},render:function(){this.$el.empty().append('<a href="#" class="settings">'+this.label+"</a>")},popup_open:function(e){e.preventDefault(),e.stopPropagation();var t=this,n=Upfront.Popup.open(function(e,n,r){t.out=this,t.popup_data=e,t.setup_tabs(n),t.setup_actions(r),t.setup_content()});this.popup=this},setup_tabs:function(e){},setup_actions:function(e){},setup_content:function(){},save_settings:function(){}}),s=i.extend({label:"Discussion settings",initialize:function(){i.prototype.initialize.call(this),this.on("settings:tabs:switch_to:settings",this.render_settings_content,this),this.on("settings:tabs:switch_to:avatars",this.render_avatars_content,this),this.on("settings:save",this.save_settings,this)},setup_tabs:function(e){this.tabs=new o,this.tabs.parent_view=this,this.tabs.render(),e.append(this.tabs.$el)},setup_actions:function(e){var t=new u;t.parent_view=this,t.render(),e.empty().append(t.$el)},setup_content:function(){e(this.out).css({height:this.popup_data.height,"overflow-y":"scroll"}),this.render_settings_content(),this.tabs.activate_tab("settings")},render_settings_content:function(){var e=new l({el:this.out,model:new r});e.render(),this.active_view=e},render_avatars_content:function(){var e=new f({el:this.out,model:new r});e.render(),this.active_view=e},save_settings:function(){var e={action:"upfront-discussion_settings-"+this.active_view.type+"-save",data:this.active_view.get_data()};Upfront.Util.post(e).done(function(){Upfront.Popup.close()})}}),o=Backbone.View.extend({tagName:"ul",className:"upfront-tabs upfront-ucomment-tabs",events:{"click li":"switch_to"},render:function(){this.$el.empty().append('<li class="settings">Discussion Settings</li>').append('<li class="avatars">Avatars</li>')},switch_to:function(t){t.preventDefault(),t.stopPropagation();var n=e(t.target),r=n.is(".settings")?"settings":"avatars";this.activate_tab(r),this.parent_view.trigger("settings:tabs:switch_to:"+r)},activate_tab:function(e){var t=this.$el.find("li."+e);this.$el.find("li").removeClass("active"),t.addClass("active")}}),u=Backbone.View.extend({className:"use_selection_container",events:{"click a":"trigger_settings_save"},render:function(){this.$el.empty().append('<a href="#">OK</a>')},trigger_settings_save:function(e){e.preventDefault(),e.stopPropagation(),this.parent_view.trigger("settings:save")}}),a=Backbone.View.extend({templates:{section_label:"<h3>{{label}}</h3>"},initialize:function(){var e=this;this.model.load().done(function(){e.render_final()})},render_final:function(){var e=this;this.populate_sections(),this.$el.empty(),this.$el.addClass("discussion-settings-wrapper"),this.sections.each(function(t){t.label&&e.$el.append(_.template(e.templates.section_label,{label:t.label})),t.fields.each(function(t){t.render(),e.$el.append(t.$el)})})},get_data:function(){var e={};return this.sections.each(function(t){t.fields.each(function(t){t.get_name?e[t.get_name()]=t.get_value():e=_.extend(e,t.get_value())})}),e},render:function(){this.$el.empty().append("Please, wait")}}),f=a.extend({type:"avatars",populate_sections:function(){this.sections=_([{label:"Avatar Settings",fields:_([new h({model:this.model,property:"show_avatars",values:[{label:"Show avatars",value:"1"}]})])},{label:"Maximum rating",fields:_([new Upfront.Views.Editor.Field.Radios({model:this.model,property:"avatar_rating",layout:"vertical",values:[{label:"Suitable for all audiences",value:"G",icon:"http://1.gravatar.com/avatar/31cb559695bfc798dbf0981a52c7a748?s=32&d=&r=G&forcedefault=1"},{label:"Possibly offensive, usually for audiences 13 and above",value:"PG",icon:"http://1.gravatar.com/avatar/31cb559695bfc798dbf0981a52c7a748?s=32&d=&r=G&forcedefault=1"},{label:"Intended for adult audiences above 17",value:"R",icon:"http://1.gravatar.com/avatar/31cb559695bfc798dbf0981a52c7a748?s=32&d=&r=G&forcedefault=1"},{label:"Even more mature than R",value:"X",icon:"http://1.gravatar.com/avatar/31cb559695bfc798dbf0981a52c7a748?s=32&d=&r=G&forcedefault=1"}]})])},{label:"Default Avatar",fields:_([new Upfront.Views.Editor.Field.Radios({model:this.model,property:"avatar_default",layout:"vertical",values:this.model.get("avatars")})])}])}}),l=a.extend({type:"settings",spawn_checkbox:function(e,t,n){return n=n||"1",new h({model:this.model,property:t,values:[{label:e,value:n}]})},populate_sections:function(){this.sections=_([{label:"Default Article Settings",fields:_([this.spawn_checkbox("Attempt to notify any blogs linked to from the article","default_pingback_flag"),this.spawn_checkbox("Allow link notifications from other blogs (pingbacks and trackbacks)","default_ping_status","open"),this.spawn_checkbox("Allow people to post comments on new articles<br />(These settings may be overridden for individual articles.)","default_comment_status","open"),this.spawn_checkbox("Allow attachments in comments","allow_attachments"),this.spawn_checkbox("Show email subscription field","show_email_subscription_field")])},{label:"Other Comment Settings",fields:_([this.spawn_checkbox("Comment author must fill out name and e-mail","require_name_email"),this.spawn_checkbox("Users must be registered and logged in to comment","comment_registration"),new c({model:this.model,property:"",field:new Upfront.Views.Editor.Field.Checkboxes({model:this.model,property:"close_comments_for_old_posts",values:[{label:"Automatically close comments on articles older than {{subfield}} days",value:"1"}]}),subfield:new p({model:this.model,property:"close_comments_days_old"})}),new c({model:this.model,property:"",field:new Upfront.Views.Editor.Field.Checkboxes({model:this.model,property:"thread_comments",values:[{label:"Enable threaded (nested) comments {{subfield}} levels deep",value:"1"}]}),subfield:new p({model:this.model,property:"thread_comments_depth"})}),new v({model:this.model,field:new Upfront.Views.Editor.Field.Checkboxes({model:this.model,property:"page_comments",values:[{label:"Paginate comments after {{depth}} top level comments and display {{page}} page by default",value:"1"}]}),depth:new p({model:this.model,property:"default_comments_page"}),page:new Upfront.Views.Editor.Field.Select({model:this.model,property:"default_comments_page",values:[{label:"last",value:"newest"},{label:"first",value:"oldest"}]})}),new Upfront.Views.Editor.Field.Select({model:this.model,property:"comment_order",label:"Comments should be displayed with the these comments at the top of each page",values:[{label:"older",value:"asc"},{label:"newer",value:"desc"}]})])},{label:"E-mail me whenever",fields:_([this.spawn_checkbox("Anyone posts a comment","comments_notify"),this.spawn_checkbox("A comment is held for moderation","moderation_notify")])},{label:"Before a comment appears",fields:_([this.spawn_checkbox("An administrator must always approve the comment","comment_moderation"),this.spawn_checkbox("Comment author must have a previously approved comment","comment_whitelist")])},{label:"Comment Moderation",fields:_([new d({model:this.model,property:"comment_max_links",label:"Hold a comment in the queue if it contains {{field}} or more links. (A common characteristic of comment spam is a large number of hyperlinks.)"}),new Upfront.Views.Editor.Field.Textarea({model:this.model,property:"moderation_keys",label:"When a comment contains any of these words in its content, name, URL, e-mail, or IP, it will be held in the moderation queue. One word or IP per line. It will match inside words, so press will match WordPress."}),new Upfront.Views.Editor.Field.Textarea({model:this.model,property:"blacklist_keys",label:"When a comment contains any of these words in its content, name, URL, e-mail, or IP, it will be marked as spam. One word or IP per line. It will match inside words, so press will match WordPress."})])}])}}),c=Backbone.View.extend({className:"upfront-field-complex_field",render:function(){this.$el.empty(),this.$el.append(this.get_field_html()),this.$el.on("click",'[name="'+this.options.subfield.get_name()+'"]',this.stop_prop)},stop_prop:function(e){e.stopPropagation(),e.preventDefault()},get_field_html:function(){return this.options.subfield.render(),this.options.field.render(),_.template(this.options.field.$el.html(),{subfield:this.options.subfield.$el.html()})},get_value:function(){var e={};return $field=this.$el.find('[name="'+this.options.field.get_name()+'"]'),$subfield=this.$el.find('[name="'+this.options.subfield.get_name()+'"]'),e[this.options.field.get_name()]=$field.is(":checkbox")?$field.is(":checked")?1:0:$field.val(),e[this.options.subfield.get_name()]=$subfield.val(),e}}),h=Upfront.Views.Editor.Field.Checkboxes.extend({multiple:!1}),p=Upfront.Views.Editor.Field.Text.extend({get_label_html:function(){},get_field_html:function(){var e={type:"number","class":"upfront-field upfront-field-counter",min:0,step:1,id:this.get_field_id(),name:this.get_field_name(),value:this.get_saved_value()};return"<input "+this.get_field_attr_html(e)+" />"}}),d=p.extend({className:"upfront-field-labeled_counter_field",get_field_html:function(){},get_label_html:function(){var e=p.prototype.get_field_html.call(this);return _.template(Upfront.Views.Editor.Field.Text.prototype.get_label_html.call(this),{field:e})}}),v=c.extend({render:function(){this.$el.empty(),this.$el.append(this.get_field_html()),this.$el.on("click",'[name="'+this.options.depth.get_name()+'"]',this.stop_prop),this.$el.on("click",'[name="'+this.options.page.get_name()+'"]',this.stop_prop)},stop_prop:function(e){e.stopPropagation(),e.preventDefault()},get_field_html:function(){return this.options.depth.render(),this.options.page.render(),this.options.field.render(),_.template(this.options.field.$el.html(),{depth:this.options.depth.$el.html(),page:this.options.page.$el.html()})},get_value:function(){var e={},t=this.$el.find('[name="'+this.options.field.get_name()+'"]'),n=this.$el.find('[name="'+this.options.depth.get_name()+'"]'),r=this.$el.find('[name="'+this.options.page.get_name()+'"]');return e[this.options.field.get_name()]=t.is(":checkbox")?t.is(":checked")?1:0:t.val(),e[this.options.depth.get_name()]=n.val(),e[this.options.page.get_name()]=r.val(),e}}),m=Upfront.Views.Editor.Sidebar.Element.extend({render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-comment"),this.$el.html("Comment")},add_element:function(){var e=new t,n=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c11 upfront-comment_module"},{name:"has_settings",value:0},{name:"row",value:25}],objects:[e]});this.add_module(n)}});_upfront_post_data.post_id&&Upfront.Application.LayoutEditor.add_object("Ucomment",{Model:t,View:n,Element:m}),Upfront.Models.UcommentModel=t,Upfront.Views.UcommentView=n})}(jQuery),define("text!elements/upfront-contact-form/templates/ucontact.html",[],function(){return'<div class=" upfront-contact-form" id="<?php echo $element_id ?>">\r\n	<?php if($form_add_title){ ?>\r\n	<div class="upfront-contact-form-title"><?php echo $form_title ?></div>\r\n	<?php } ?>\r\n	<form action="" method="POST">\r\n		<div class="ucontact-message-container">\r\n			<?php if($message){ ?>\r\n			<div class="ucontact-msg msg <?php echo $message_class ?>"><?php echo $message ?></div>\r\n			<?php } ?>\r\n		</div>\r\n		<input type="hidden" name="ucontact" value="sent">\r\n		<input type="hidden" name="contactformid" value="<?php echo $element_id ?>">\r\n		<input type="hidden" name="entity_ids" value=\'<?php echo $entity_id ?>\'>\r\n		<div class="upfront-field-container <?php echo $field_classes ?>">\r\n			<label for="sendername"><?php echo $form_name_label ?></label>\r\n			<input type="text" class="text-field <?php echo $validate ?>" name="sendername" value="<?php echo $values[\'name\'] ?>" <?php echo $placeholders[\'name\'] ?> />\r\n		</div>\r\n		<div class="upfront-field-container <?php echo $field_classes ?>">\r\n			<label for="senderemail"><?php echo $form_email_label ?></label>\r\n			<input type="email" class="email-field <?php echo $validate ?>" name="senderemail" value="<?php echo $values[\'email\'] ?>" <?php echo $placeholders[\'email\'] ?> />\r\n		</div>\r\n		<?php if($show_subject){ ?>\r\n		<div class="upfront-field-container <?php echo $field_classes ?>">\r\n			<label for="subject"><?php echo $form_subject_label ?></label>\r\n			<input type="text" class="text-field <?php echo $validate ?>" name="subject" value="<?php echo $values[\'subject\'] ?>" <?php echo $placeholders[\'subject\'] ?> />\r\n		</div>\r\n		<?php } ?>\r\n		<div class="upfront-field-container <?php echo $field_classes ?>">\r\n			<label for="sendermessage"><?php echo $form_message_label ?></label>\r\n			<textarea class="textarea-field <?php echo $validate ?>" name="sendermessage" <?php echo $placeholders[\'message\'] ?>><?php echo $values[\'message\'] ?></textarea>\r\n		</div>\r\n		<div class="upfront-field-container upfront-submit-container <?php echo $field_classes ?>">\r\n			<input type="submit" name="send" value="<?php echo $form_button_text ?>" class="button submit-field">\r\n		</div>\r\n	</form>\r\n</div>'}),function(e){define("ucontact",["text!elements/upfront-contact-form/templates/ucontact.html"],function(t){var n=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(Upfront.data.ucontact.defaults);e.element_id=Upfront.Util.get_unique_id(e.id_slug+"-object"),this.init_properties(e)}}),r=Upfront.Views.ObjectView.extend({tpl:Upfront.Util.template(t),initialize:function(e){this.model instanceof n||(this.model=new n({properties:this.model.get("properties")})),this.constructor.__super__.initialize.call(this,[e]),Upfront.Events.on("command:layout:save_success",this.checkDeleteElement,this)},checkDeleteElement:function(){},get_content_markup:function(){var e=_.extend({},this.extract_properties(),{message:!1,field_classes:this.getFieldStyleClass(),validate:"",entity_id:"",placeholders:{name:this.getPlaceholder("form_name_label"),email:this.getPlaceholder("form_email_label"),subject:this.getPlaceholder("form_subject_label"),message:this.getPlaceholder("form_message_label")},values:{}});return this.tpl(e)},property_value:function(e){return this.model.get_property_value_by_name(e)},extract_properties:function(){var e={};return this.model.get("properties").each(function(t){e[t.get("name")]=t.get("value")}),e},getFieldStyleClass:function(){return" ucontact-label-"+this.property_value("form_label_position")},getPlaceholder:function(e){return this.property_value("form_label_position")=="over"?'placeholder="'+this.property_value(e)+'"':""}}),i=Upfront.Views.Editor.Sidebar.Element.extend({priority:140,render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-contact"),this.$el.html("Contact")},add_element:function(){var e=new n,t=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c12 upfront-contact_form_module"},{name:"has_settings",value:0},{name:"row",value:29}],objects:[e]});this.add_module(t)}}),s=Upfront.Views.Editor.Field.Checkboxes.extend({className:"upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-checkboxes upfront-field-wrap-optional",events:{"change input":"onChange"},initialize:function(e){var t=this;s.__super__.initialize.apply(this,arguments),this.on("panel:set",function(){this.panel.on("rendered",function(){t.onChange()})}),e.onChange&&(this.onChange=e.onChange)},onChange:function(){var t=this.$("input"),n=this.panel.$("input[name="+this.options.relatedField+"]").closest(".upfront-field-wrap");t.is(":checked")?n.show():n.hide(),console.log(n),e("#settings").height(this.panel.$(".upfront-settings_panel").outerHeight())}}),o=Upfront.Views.Editor.Settings.Settings.extend({initialize:function(){var e=Upfront.Views.Editor.Settings.Panel,t=Upfront.Views.Editor.Settings.Item,n=Upfront.Views.Editor.Field;this.panels=_([this.get_general_panel(e,t,n),this.get_fields_panel(e,t,n),this.get_appearance_panel(e,t,n)])},get_general_panel:function(e,t,n){return new e({label:"General",model:this.model,settings:[new t({title:"General setup",model:this.model,fields:[new n.Email({model:this.model,property:"form_email_to",label:"Send results to:"}),new s({model:this.model,property:"form_add_title",relatedField:"form_title",values:[{label:"Use form title",value:"true"}]}),new n.Text({model:this.model,property:"form_title",label:"Contact form title:"})]}),new t({title:"Form validation",model:this.model,fields:[new n.Radios({model:this.model,property:"form_validate_when",values:[{label:"Each field is filled out",value:"field"},{label:"Once send field button is clicked",value:"submit"}]})]})]})},get_fields_panel:function(e,t,n){return new e({label:"Form Fields",title:"Contact Form Fields",model:this.model,settings:[new t({title:"Form fields setup",model:this.model,fields:[new n.Text({model:this.model,property:"form_name_label",label:"Name Field Text:"}),new n.Text({model:this.model,property:"form_email_label",label:"Email Field Text:"}),new n.Text({model:this.model,property:"form_message_label",label:"Message Field Text:"}),new s({model:this.model,property:"show_subject",relatedField:"form_subject_label",values:[{label:"Show subject field",value:"true"}],onChange:function(){var e=this.$("input"),t=this.panel.$("input[name="+this.options.relatedField+"]").closest(".upfront-field-wrap"),n=this.panel.$("input[name=form_default_subject]").closest(".upfront-field-wrap");e.is(":checked")?(t.show(),n.hide()):(t.hide(),n.show()),console.log(t)}}),new n.Text({model:this.model,property:"form_subject_label",label:"Subject Field text:"}),new n.Text({model:this.model,property:"form_default_subject",label:"Default subject:"})]})]})},get_appearance_panel:function(e,t,n){return new e({label:"Appearance",model:this.model,settings:[new t({title:"Field label position",fields:[new n.Radios({model:this.model,property:"form_label_position",values:[{label:"Above the field",value:"above",icon:"contact-above-field"},{label:"Over the field",value:"over",icon:"contact-over-field"},{label:"Inline with field",value:"inline",icon:"contact-inline-field"}]})]})]})},get_title:function(){return"Contact form settings"}});Upfront.Application.LayoutEditor.add_object("Ucontact",{Model:n,View:r,Element:i,Settings:o}),Upfront.Models.UcontactModel=n,Upfront.Views.UcontactView=r})}(jQuery),define("text!elements/upfront-gallery/tpl/ugallery.html",[],function(){return'<div class="ugallery ugallery_publish" id="<?php echo $element_id ?>">\r\n<?php if ($labelFilters[\'length\']){ ?>\r\n	<div class="ugallery_labels">\r\n	<?php for($i=0; $i<$labels_length; $i++) { ?>\r\n		<a href="#" class="ugallery_label_filter <?php echo $i == 0 ? \'filter_selected\' : \'\' ?>" rel="label_<?php echo $labels[$i][\'id\'] ?>"><?php echo $labels[$i][\'text\'] ?></a>\r\n	<?php } ?>\r\n	</div>\r\n<?php } ?>\r\n<?php if($imagesLength){ ?>\r\n	<div class="ugallery_items <?php echo $labelFilters[\'length\'] ? \'ugallery_grid\' : \'\' ?>" rel="<?php echo $element_id ?>">\r\n	<?php for($i=0; $i<$imagesLength; $i++) { ?>\r\n		<div class="ugallery_item ugallery_caption_<?php echo $captionWhen ?>" style="position:relative; width:<?php echo $thumbWidth ?>px;" rel="<?php echo $images[$i][\'id\'] ?>" data-groups=\'[<?php echo $image_labels[$images[$i][\'id\']] ?>]\'>\r\n			<a class="ugallery_link" href="<?php echo $linkTo == \'image\' ? $images[$i][\'sizes\'][\'full\'][0] : $images[$i][\'url\'] ?>" title="">\r\n			<div class="ugallery-image-wrapper" style="position: relative; width:<?php echo $thumbWidth ?>px; height:<?php echo $thumbHeight ?>px">\r\n				<img src="<?php echo $images[$i][\'src\'] ?>" alt="" class="ugallery-image" style="<?php echo $images[$i][\'loading\'] ? \'display:none;\' : \'\' ?> margin-left:<?php echo $images[$i][\'margin\'][\'left\'] ?>px;  margin-top:<?php echo $images[$i][\'margin\'][\'top\'] ?>px;">				\r\n			</div>\r\n			<?php if($captionWhen != \'never\'){ ?>\r\n			<div class="ugallery-thumb-title ugallery-caption-<?php echo $captionWhen ?> ugallery-caption-<?php echo $captionPosition ?>"><?php echo $images[$i][\'title\'] ?></div>\r\n			<?php } ?>\r\n			</a>\r\n		</div>\r\n	<?php } ?>\r\n	<?php if($editing) { ?>\r\n		<div class="ugallery_addmore_wrapper upfront-ui" style="width: <?php echo $thumbWidth ?>px; min-height: <?php echo $thumbHeight ?>px">\r\n			<div class="ugallery_addmore"  title="Add new images to the Gallery">Add more</div></div>\r\n		<style>\r\n			.ugallery_addmore_wrapper {\r\n				height: 0px;\r\n				-moz-transition:height .3s;\r\n			    -webkit-transition:height .3s;\r\n			    -o-transition:height .3s;\r\n			    transition:height .3s;\r\n				overflow: hidden;\r\n			}\r\n			.upfront-active_entity .ugallery_addmore_wrapper {\r\n				height: <?php echo $thumbHeight ?>px;\r\n			}\r\n		</style>\r\n	<?php } ?>\r\n	</div>\r\n<?php } else { ?>\r\n	<?php if(! $editing) { ?>\r\n		No images in this gallery\r\n	<?php } else { ?>\r\n		<div class="ugallery-starting-wrapper">\r\n				<div class="uimage-centered">\r\n					<span class="upfront-image-resizethiselement">Add Images</span>\r\n					<div class=""><a class="upfront-image-select button" href="#" title="Add Images to the Gallery">+</a></div>\r\n				</div>\r\n		</div>\r\n	<?php } ?>\r\n<?php } ?>\r\n</div>\r\n\r\n<style>	\r\n	#<?php echo $element_id ?> .ugallery-thumb-title {\r\n		color: <?php echo $captionColor ?>;\r\n		background: <?php echo $captionUseBackground != "0" ? $captionBackground : \'transparent\' ?>;\r\n	}\r\n\r\n	#<?php echo $element_id ?> .ugallery-caption-above {\r\n		display: block;\r\n	}\r\n\r\n	#<?php echo $element_id ?> .ugallery-caption-over {\r\n		position: absolute;\r\n		width: 100%;\r\n		left: 0;\r\n		bottom: 0;\r\n	}\r\n\r\n	#<?php echo $element_id ?> .ugallery-caption-never {\r\n		display: none;\r\n	}\r\n\r\n	#<?php echo $element_id ?> .ugallery_caption_hover .ugallery-caption-over {\r\n		display: none;\r\n	}\r\n\r\n	#<?php echo $element_id ?> .ugallery_caption_hover:hover .ugallery-caption-over {\r\n		display: block;\r\n	}\r\n\r\n</style>\r\n'}),define("text!elements/upfront-gallery/tpl/ugallery_editor.html",[],function(){return'<div> \r\n<!-- \r\n	Wrap everything in a div to convert this file\'s content in a jquery element \r\n	so it is possible to use $.find.\r\n-->\r\n\r\n<script type="text/template" id="selector-tpl">\r\n	<div id="upront-image-placeholder" class="upfront-image-section">\r\n		<div class="upfront-image-selector-container">\r\n			<h2>Drop images here</h2>\r\n			or<br>\r\n			<a class="button select-files" href="#">Select images</a>\r\n			<div id="upfront-image-maxsize">Maximum upload file size: 32MB</div>\r\n			or browse your\r\n			<div class="upfront-image-media-container">\r\n			<i class="icon-picture"></i> <a class="open-media-gallery" href="#">media gallery</a>\r\n			</div>\r\n			<span class="dragimagehand"></span>	\r\n		</div>\r\n	</div>	\r\n</div>\r\n</script>\r\n\r\n<script type="text/template" id="progress-tpl">\r\n	<div id="upfront-image-uploading" class="upfront-image-section">\r\n		<h2>Uploading...</h2>\r\n		<div class="upfront-progress-container">\r\n			<div id="upfront-progress"></div>\r\n		</div>\r\n	</div>\r\n</script>\r\n\r\n<script type="text/template" id="editor-tpl">\r\n	<div id="upfront-image-edit" class="upfront-image-section">\r\n		<div id="uimage-canvas-container" style="position:absolute">\r\n			<div id="uimage-canvas" style="position:relative; overflow:hidden;">\r\n				<img class="uimage-img {{ rotation }}" src="{{src}}" style="width:{{size.width}}px; height:{{size.height}}px;position:absolute">\r\n				<div id="uimage-mask" class="image-edit-mask" style="position:absolute; top:{{offset.top}}px; left:{{offset.left}}px"></div>\r\n			</div>\r\n			<div class="image-edit-resize image-edit-control"><i class="icon-resize-full ui-resizable-handle ui-resizable-handle-se"></i></div>\r\n			<div class="image-edit-rotate image-edit-control"><i class="icon-repeat"></i></div>\r\n		</div>\r\n		<div class="image-edit-save-container">\r\n			<div class="no-shadow">\r\n				<a class="image-edit-save" href="#"><i class="icon-ok"></i> I like that</a>\r\n				<a class="image-edit-change" href="#"><i class="icon-upload-alt "></i> upload a different image</a>\r\n			</div>\r\n		</div>\r\n	</div>\r\n</script>\r\n\r\n\r\n<script type="text/template" id="upload-form-tpl">\r\n<form id="upfront-upload-image" name="upfront-upload-image" enctype="multipart/form-data" method="post" action="{{url}}">\r\n	<input type="file" name="media[]" id="upfront-image-file-input" multiple="multiple">\r\n	<input type="hidden" name="action" value="upfront-media-upload">\r\n	<input type="submit" value="Upload">\r\n</form>\r\n</script>\r\n\r\n<script type="text/template" id="details-tpl">\r\n<div class="upfront-settings-panel">\r\n	<input type="hidden" id="ugallery-image-id" value="{{id}}">\r\n	<h3>Edit image details</h3>\r\n	<div class="upfront-field-wrap">\r\n		<label for="ugallery-image-title">Title</label>\r\n		<input type="text" name="ugallery-image-title" value="{{title}}" class="upfront-field-text">\r\n	</div>\r\n	<div class="upfront-field-wrap">\r\n		<label for="ugallery-image-title">Caption</label>\r\n		<input type="text" name="ugallery-image-caption" value="{{caption}}" class="upfront-field-text">\r\n	</div>\r\n	<div class="upfront-field-wrap">\r\n		<label for="ugallery-image-title">Alternative text</label>\r\n		<input type="text" name="ugallery-image-alt" value="{{alt}}" class="upfront-field-text">\r\n	</div>\r\n	<div class="upfront-settings-button_panel">\r\n		<button type="button" class="upfront-save_settings"><i class="icon-ok"></i> Ok</button>\r\n	</div>\r\n\r\n	<div class="upfront-field-wrap upfront-additive_multiselection upfront-media-controls ">\r\n		<label for="ugallery-image-labels">Labels</label>\r\n		<div class="existing_labels">\r\n		<a href="#remove" class="upfront-icon upfront-icon-media-label-delete" data-idx="2">Una etiqueta</a>\r\n		</div>\r\n		<div class="label_selector">\r\n			<input type="text" name="ugallery-image-labels" placeholder="Add a new label" class="upfront-field-text">\r\n			<div class="labels_list">\r\n			</div>\r\n		</div>\r\n	</div>\r\n\r\n</div>\r\n</script>\r\n\r\n<script type="text/template" id="link-tpl">\r\n<div class="upfront-settings-panel">\r\n	<input type="hidden" id="ugallery-image-id" value="{{id}}">\r\n	<h3>Image links to:</h3>\r\n	<div class="upfront-field-wrap">\r\n		<input type="radio" name="ugallery-image-link" value="external" class="upfront-field-radio" id="ugallery-image-link-1" {{link == \'external\' ? checked : \'\'}}>\r\n		<label for="ugallery-image-link-1">External link</label>\r\n		<input type="text" value="{{url}}" id="ugallery-image-link-url" placeholder="Type link URL" style="{{link != \'external\' ? \'display:none\' : \'\'}}" class="upfront-field-text">\r\n	</div>\r\n	<div class="upfront-field-wrap">\r\n		<input type="radio" name="ugallery-image-link" value="post" class="upfront-field-radio" id="ugallery-image-link-2" {{link == \'post\' ? checked : \'\'}}>\r\n		<label for="ugallery-image-link-2">Link to a post or page</label>\r\n		<a title="Change link" class="ugallery-change-link-post" style="{{link != \'post\' ? \'display:none\' : \'\'}}">{{url}}</a>\r\n	</div>\r\n	<div class="upfront-settings-button_panel">\r\n		<button type="button" class="upfront-save_settings"><i class="icon-ok"></i> Ok</button>\r\n	</div>\r\n\r\n	<div class="upfront-field-wrap upfront-additive_multiselection upfront-media-controls ugallery-label-selector">\r\n		<h3>Image labels:</h3>\r\n		<div class="existing_labels">\r\n		<a href="#remove" class="upfront-icon upfront-icon-media-label-delete" data-idx="2">Una etiqueta</a>\r\n		</div>\r\n		<div class="label_selector">\r\n			<input type="text" name="ugallery-image-labels" placeholder="Add a new label" class="upfront-field-text">\r\n			<div class="labels_list">\r\n			</div>\r\n		</div>\r\n	</div>\r\n</div>\r\n</script>\r\n\r\n<script type="text/template" id="labels-tpl">\r\n	{[ _.each(labels, function(label){ ]}\r\n		<a href="#remove" title="Remove" class="upfront-icon upfront-icon-media-label-delete" data-idx="{{label.id}}">{{label.text}}</a>\r\n	{[ }) ]}\r\n</script>\r\n\r\n<script type="text/template" id="labels-selection-tpl">\r\n	<ul {{labels.length ? \'\' : \'class="empty"\'}}>\r\n	{[ _.each(labels, function(label){ ]}\r\n		<li><label rel="{{label.id}}">{{label.text}}</label></li>\r\n	{[ }) ]}\r\n	</ul>\r\n</script>\r\n\r\n<script type="text/template" id="magnific-labels-tpl">\r\n	<div class="ugallery-magnific-labels upfront-ui">\r\n		<div class="ugallery-magnific-panel closed upfront-media-controls">\r\n			<div class="ugallery-magnific-info">Turn on \'Label Sorting\' in the settings to display gallery labels.</div>\r\n			<div class="ugallery-magnific-wrapper existing_labels">\r\n				{{labels}}\r\n				<div class="ugallery-magnific-add">\r\n					\r\n					<div class="ugallery-magnific-addform label_selector">\r\n						<input type="hidden" id="ugallery-image-id" value="{{imageId}}">\r\n						<input type="text" id="ugallery-addlabels" class="upfront-field-text" name="ugallery-image-labels" placeholder="Add label">\r\n						<div class="labels_list"></div>\r\n					</div>\r\n					<div class="ugallery-magnific-addbutton">Add label</div>\r\n				</div>\r\n			</div>\r\n		</div>\r\n		<div class="ugallery-magnific-toggle"></div>\r\n	</div>\r\n	\r\n</script>\r\n\r\n<!--\r\n{[ _.each(labels, function(label){ ]}\r\n					<div><label rel="{{label.id}}">{{label.text}}</label></div>\r\n					{[ }) ]}\r\n					-->\r\n\r\n</div>'}),function(e){define("ugallery",["text!elements/upfront-gallery/tpl/ugallery.html","text!elements/upfront-gallery/tpl/ugallery_editor.html"],function(t,n){var r=Backbone.Model.extend({defaults:Upfront.data.ugallery.imageDefaults}),i=Backbone.Collection.extend({model:r}),s=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(Upfront.data.ugallery.defaults);e.element_id=Upfront.Util.get_unique_id(e.id_slug+"-object"),this.init_properties(e)}}),o=Upfront.Views.ObjectView.extend(_.extend({},{model:s,tpl:Upfront.Util.template(t),selectorTpl:_.template(e(n).find("#selector-tpl").html()),progressTpl:_.template(e(n).find("#progress-tpl").html()),editorTpl:_.template(e(n).find("#editor-tpl").html()),formTpl:_.template(e(n).find("#upload-form-tpl").html()),detailsTpl:_.template(e(n).find("#details-tpl").html()),linkTpl:_.template(e(n).find("#link-tpl").html()),labelsTpl:_.template(e(n).find("#labels-tpl").html()),labelSelectorTpl:_.template(e(n).find("#labels-selection-tpl").html()),magnificLabelTpl:_.template(e(n).find("#magnific-labels-tpl").html()),sortMode:!1,lastThumbnailSize:!1,imageLabels:{},reopenSettings:!1,initialize:function(t){var n=this,r=this.property("element_id");console.log("Gallery Element"),this.model instanceof s||(this.model=new s({properties:this.model.get("properties")})),this.constructor.__super__.initialize.call(this,[t]),this.events=_.extend({},this.events,{"click a.upfront-image-select":"openImageSelector","click .ugallery_addmore_wrapper":"openImageSelector","click .ugallery_op_link":"imageEditLink","click .ugallery_op_mask":"imageEditMask","click .ugallery_item_rm_yes":"removeImage","click .ugallery-image-wrapper":"selectItem","click .upfront-quick-swap":"openImageSelector","click .ugallery-nolabels-alert":"openLightboxLabels"});var o=this.property("images");this.images=new i(o),this.listenTo(this.images,"add remove reset change",this.imagesChanged),this.property("images",this.images.toJSON()),e("body").on("click",this.closeTooltip),this.listenTo(Upfront.Events,"entity:settings:activate",this.closeTooltip),this.listenTo(Upfront.Events,"entity:activated",this.closeTooltip),this.listenTo(Upfront.Events,"entity:deactivated",this.closeTooltip),this.listenTo(Upfront.Events,"entity:region:activated",this.closeTooltip),this.lastThumbnailSize={width:this.property("thumbWidth"),height:this.property("thumbHeight")};if(typeof ugalleries!="undefined"&&ugalleries[r])ugalleries[r].labels&&(this.labels=ugalleries[r].labels),ugalleries[r].image_labels&&(this.imageLabels=ugalleries[r].image_labels);else{if("undefined"==typeof ugalleries||!ugalleries)ugalleries={};ugalleries[r]={},this.labels=[],this.imageLabels={},ugalleries[r].labels=this.labels,ugalleries[r].imageLabels=this.imageLabels}this.on("deactivated",this.sortCancel,this),this.listenTo(this.model,"settings:closed",function(e){n.checkRegenerateThumbs(e)}),this.listenTo(this.model,"thumbChange",function(e){n.$(".ugallery-image-wrapper").css("overflow","hidden").find("img").css({"min-width":"100%","min-height":"100%",margin:"0"})}),(this.property("status")!="ok"||!this.images.length)&&this.property("has_settings",0)},selectItem:function(t){var n=e(t.target).hasClass("gallery_item")?e(t.target):e(t.target).closest(".ugallery_item");n.siblings().removeClass("ugallery_selected"),e(t.target).closest(".ugallery-controls").length||n.toggleClass("ugallery_selected"),t.gallerySelected=!0},createControls:function(){var e=new Upfront.Views.Editor.InlinePanels.ControlPanel,t=this.property("linkTo")=="url"?this.createControl("link","Link image","imageEditLink"):this.createControl("fullscreen","Show image","openLightbox");return e.items=_([this.createControl("crop","Edit image","imageEditMask"),t,this.createControl("remove","Remove image","removeImage")]),e},createControl:function(e,t,n){var r=this,i=new Upfront.Views.Editor.InlinePanels.Control;return i.icon=e,i.tooltip=t,n&&this.listenTo(i,"click",function(e){r[n](e)}),i},openLightbox:function(t,n){var r=this,i=e(t.target).closest(".ugallery_item"),s=r.images.get(i.attr("rel")),o=!1;e.magnificPopup.open({items:{src:i.find(".ugallery_link").attr("href")},type:"image",image:{titleSrc:function(){return s.get("caption")},markup:Upfront.data.ugallery.lightboxTpl},callbacks:{imageLoadComplete:function(){var t=e(this.container).find(".mfp-title"),i=e(this.container).find("figure"),u=e.trim(r.labelsTpl({labels:r.extractImageLabels(s.id)}));t.length&&t.ueditor({linebreaks:!1,autostart:!1,upfrontMedia:!1,upfrontImages:!1}).on("start",function(){o=!0}).on("syncAfter",function(){s.set("caption",t.html())}),i.append(r.magnificLabelTpl({labels:u,imageId:s.id}));var a=i.find(".ugallery-magnific-panel"),f=function(){a.removeClass("closed"),setTimeout(function(){a.css("overflow","visible")},500)};n&&setTimeout(function(){f()},300),i.on("click",".ugallery-magnific-toggle",function(e){var t=i.find(".ugallery-magnific-panel");t.hasClass("closed")?f():t.css("overflow","hidden").addClass("closed")}).on("click",".ugallery-magnific-addbutton",function(e){i.find(".ugallery-magnific-addbutton").hide(),i.find(".ugallery-magnific-addform").show().find("#ugallery-addlabels").focus()}),r.createLabelSelector(i)},beforeClose:function(){o&&Upfront.Views.Editor.notify("Image description has been successfully updated.")}}})},openLightboxLabels:function(e){this.openLightbox(e,!0)},get_content_markup:function(){var e=this.extract_properties();return rendered={},e.imagesLength=e.images.length,e.editing=!0,e.labels=this.labels,e.labels_length=this.labels.length,e.image_labels=this.imageLabels,rendered=this.tpl(e),rendered},on_render:function(){var t=this,n=t.$el.closest("body").length?this.calculateMargins():!1;this.images.each(function(e){e.get("loading")&&t.$('.ugallery_item[rel="'+e.id+'"]').find(".ugallery-image-wrapper").append('<p class="ugallery-image-loading">Loading...</p>')}),_.indexOf(["ok","starting"],t.property("status"))==-1&&t.$(".upfront-gallery").append('<div class="upfront-quick-swap"><p>Click to personalize this gallery</p></div>'),setTimeout(function(){var r=t.$(".ugallery_item");_.each(r,function(r){var i=e(r),s=t.images.get(i.attr("rel")),o=t.createControls(s),u=i.find(".ugallery-thumb-title");n||t.calculateMargins(),o.setWidth(i.width()),o.render(),i.find(".ugallery-image-wrapper").append(e('<div class="ugallery-controls upfront-ui"></div>').append(o.$el)),t.property("captionPosition")!="nocaption"&&!u.data("ueditor")&&u.ueditor({linebreaks:!1,autostart:!1,upfrontMedia:!1,upfrontImages:!1}).on("start",function(){t.$el.addClass("upfront-editing")}).on("stop",function(){t.$el.removeClass("upfront-editing")}).on("syncAfter",function(){s.set("title",u.html())}),t.imageLabels[s.id]&&t.property("labelFilters").length&&t.imageLabels[s.id].split(",").length<2&&i.find(".ugallery-image-wrapper").append('<div class="ugallery-nolabels-alert" title="This image has no labels"></div>'),s.controls&&s.controls.remove(),s.controls=o})},300),this.activateSortable()},calculateMargins:function(){var t=this.$(".ugallery_items").width(),n=this.$(".ugallery_item"),r=n.outerWidth(),i=30,s=Math.floor(t/r);s*r+(s-1)*i>t&&s--;var o=Math.floor((t-s*r)/(s-1))-2*s;return _.each(n,function(t,n){e(t).css("margin-right",(n+1)%s?o:0)}),1},getLabelSelector:function(t){var n=e(e.trim(this.labelsTpl({labels:this.extractImageLabels(t)})));return n},extractImageLabels:function(e){var t=this.imageLabels[e].match(/-?\d+/g),n=[];return t&&_.each(this.labels,function(e){t.indexOf(e.id.toString())!=-1&&e.id!=0&&n.push(e)}),n},openImageSelector:function(e,t){var n=this,r={multiple:!0,preparingText:"Preparing images",customImageSize:{width:this.property("thumbWidth"),height:this.property("thumbHeight")},element_id:this.model.get_property_value_by_name("element_id")};e&&e.preventDefault(),Upfront.Views.Editor.ImageSelector.open(r).done(function(e,r){n.addImages(e,t),r.given!=r.returned&&Upfront.Views.Editor.notify("Not all images could be added.","warning"),Upfront.Views.Editor.ImageSelector.close()})},addImages:function(e,t){var n=this,i=[],s=!1,o=this.model.get_property_value_by_name("element_id");this.getNewLabels(_.keys(e)),_.each(e,function(e,t){i.push(new r({id:t,srcFull:e.full[0],sizes:e,size:e.custom.editdata.resize,cropSize:e.custom.crop,cropOffset:e.custom.editdata.crop,src:e.custom.url,loading:!1,status:"ok",element_id:o}))});if(n.property("status")!="ok")n.property("status","ok"),n.property("has_settings",1),n.images.reset(i),s=!0;else if(t){var u=n.images.get(t),a=n.images.indexOf(u);n.images.remove(t),n.images.add(i,{at:a})}else n.images.add(i);n.render(),s&&this.selectOnClick()},selectOnClick:function(){var t=this,n=e('<div class="upfront-ui ugallery-onclick"><div class="ugallery-onclick-dialog"><span>When a gallery thumbnail is clicked</span><div class="ugallery-onclick-options"><a href="#" class="ugallery-lager_image" rel="image">show larger image</a><a href="#" class="ugallery-linked_page" rel="url">go to linked page</a></div></div></div>');n.on("click","a",function(r){r.preventDefault();var i=e(r.target).attr("rel");t.property("linkTo",i,!1),setTimeout(function(){n.fadeOut("fast",function(){n.remove(),t.render()})},100)}),e("#"+this.property("element_id")).append(n.hide()),n.fadeIn()},getNewLabels:function(e){var t={action:"upfront-media_get_image_labels",post_ids:e},n=this;Upfront.Util.post(t).done(function(e){var t=e.data;console.log(t),_.each(t,function(e,t){var r=[];r.push('"label_0"'),_.each(e,function(e){var t=Upfront.data.ugallery,i={id:e.term_id,text:e.name};t.label_names[e.name]||(t.label_names[e.name]=i),t.label_ids[e.term_id]||(t.label_ids[e.term_id]=i),n.isLabelInGallery(i)||n.labels.push(i),r.push('"label_'+e.term_id+'"')}),n.imageLabels[t]=r.join(", ")})})},isLabelInGallery:function(e){var t=this,n=!1,r=0;while(r<t.labels.length&&!n)n=t.labels[r].id==e.id,r++;return n},getCropOffset:function(e,t){var n=t.width/e.width>t.height/e.height?"height":"width",r=t[n]/e[n],i,s;return r>0?(i={width:Math.floor(t.width/r),height:Math.floor(t.height/r)},s={left:(i.width-e.width)/2,top:(i.height-e.height)/2}):(i=e,s={left:0,top:0}),{size:i,offset:s}},centeredPosition:function(e){var t={width:this.property("thumbWidth"),height:this.property("thumbHeight")};return{top:(t.height-e.height)/2/t.height*100,left:(t.width-e.width)/2/t.width*100}},checkRegenerateThumbs:function(e,t){var n=this;if(t||this.lastThumbnailSize.width!=this.property("thumbWidth")||this.lastThumbnailSize.height!=this.property("thumbHeight")){var r={images:this.getRegenerateData(t),action:"upfront-media-image-create-size"},i=new Upfront.Views.Editor.Loading({loading:"Regenerating images...",done:"Wow, those are cool!",fixed:!1});console.log("sent"),console.log(r.images),i.render(),this.parent_module_view.$el.append(i.$el),Upfront.Util.post(r).done(function(e){i.done();var t=e.data.images,s=[];console.log("received"),console.log(t),_.each(r.images,function(e){var r=n.images.get(e.id),i=t[e.id];i.error||r.set({src:i.url,srcFull:i.urlOriginal,size:e.resize,cropPosition:{top:e.crop.top,left:e.crop.left}},{silent:!0}),s.push(r)}),n.images.set(s,{remove:!1}),n.imagesChanged(),n.render(),n.lastThumbnailSize={width:n.property("thumbWidth"),height:n.property("thumbHeight")}})}},getRegenerateData:function(e){var t=this,n=this.property("thumbWidth")/this.lastThumbnailSize.width,r=this.property("thumbHeight")/this.lastThumbnailSize.height,s=n>r?n:r,o={width:this.property("size").width*s,height:this.property("size").height*s},u=[],a=this.images,f=this.model.get_property_value_by_name("element_id");return e&&(a=[],_.each(e,function(e){a.push(t.images.get(e))}),a=new i(a)),a.each(function(e){var n=e.get("size"),r=e.get("cropOffset"),i={id:e.id,rotate:e.get("rotation"),resize:{width:n.width*s,height:n.height*s},crop:{top:Math.round(r.top*s),left:Math.round(r.left*s),width:t.property("thumbWidth"),height:t.property("thumbHeight")},element_id:f};u.push(i)}),u},imageEditLink:function(t){t.preventDefault();var n=this,r=e(t.target).closest(".ugallery_item"),i=this.images.get(r.attr("rel")),s=i.toJSON(),o="",u=this.getLabelSelector(r.attr("rel"));s.checked='checked="checked"',o=e(this.linkTpl(s)).on("change","input[name=ugallery-image-link]",function(e){n.imageLinkChanged(e)}).on("click","button.upfront-save_settings",function(e){n.saveImageLink(e)}).on("click",".ugallery-change-link-post",function(e){n.imageLinkChanged(e)}),o.find(".existing_labels").html(u),o=this.createLabelSelector(o),this.openTooltip(o,e(t.target))},imageEditMask:function(t){var n=this,r=e(t.target).closest(".ugallery_item"),i=this.images.get(r.attr("rel")),s=this.getEditorOptions(i);if(i.get("status")!="ok"){var o={multiple:!1,preparingText:"Preparing images",element_id:this.model.get_property_value_by_name("element_id")};return Upfront.Views.Editor.ImageSelector.open(o).done(function(e,t){n.addImages(e);var r=n.images.indexOf(i);n.images.remove(i,{silent:!0});var s=n.images.at(n.images.length-1);n.images.remove(s,{silent:!0}),n.images.add(s,{at:r}),Upfront.Views.Editor.ImageSelector.close()})}s=this.getEditorOptions(i),t.preventDefault(),Upfront.Views.Editor.ImageEditor.open(s).done(function(e){i.set({src:e.src,srcFull:e.src,cropSize:e.cropSize,size:e.imageSize,cropOffset:e.imageOffset,margin:{left:Math.max(0-e.imageOffset.left,0),top:Math.max(0-e.imageOffset.top,0)},rotation:e.rotation}),n.render()}).fail(function(e){e&&e.reason=="changeImage"?n.openImageSelector(!1,e.id):n.render()})},getEditorOptions:function(e){var t=this,n=this.$(".ugallery_item[rel="+e.id+"]").find(".ugallery-image-wrapper"),r=e.get("sizes").full;return{id:e.id,maskSize:{width:n.width(),height:n.height()},maskOffset:n.offset(),position:e.get("cropOffset"),size:e.get("size"),fullSize:{width:r[1],height:r[2]},src:e.get("src"),srcOriginal:r[0],rotation:e.get("rotation"),element_id:this.model.get_property_value_by_name("element_id")}},imagesChanged:function(){this.property("images",this.images.toJSON()),this.calculateMargins()},imageLinkChanged:function(t){var n=e("#ugallery-tooltip").find("input[name=ugallery-image-link]:checked").val(),r=e("#ugallery-tooltip").find("#ugallery-image-id").val();if(n=="external")e("#ugallery-image-link-url").show();else{e("#ugallery-image-link-url").hide();if(n=="post"||t.type!="change"){var i=this,s={postTypes:this.postTypes()};this.closeTooltip(),Upfront.Views.Editor.PostSelector.open(s).done(function(e){var n=i.images.get(r);n.set({link:"post",url:e.get("permalink")});var s=n.toJSON();s.checked='checked="checked"',setTimeout(function(){t.target=i.$("[rel="+r+"]"),i.imageEditLink(t)},200)})}}},createLabelSelector:function(t){var n=this,r=t.find("#ugallery-image-id").val();return t.on("keyup",'input[name="ugallery-image-labels"]',function(t){if([9,13,38,40].indexOf(t.which)!=-1)return;var i=e(t.target).val(),s=_.keys(Upfront.data.ugallery.label_names),o=[];return i.length<2?e(".labels_list").html(""):(_.each(s,function(e){var t=e.indexOf(i);if(t!=-1){var s=Upfront.data.ugallery.label_names[e],u=n.imageLabels[r];u.indexOf('"label_'+s.id+'"')==-1&&o.push({id:s.id,text:s.text.replace(i,'<span class="selection">'+i+"</span>")})}}),e(".labels_list").html(n.labelSelectorTpl({labels:o})))}),t.on("keydown",'input[name="ugallery-image-labels"]',function(i){var s=function(t){var n=t.find("label.selected");n.length&&n.removeClass("selected");var r=-1,i=0;while(i<t.length&&r==-1)r=t[i]==n.parent()[0]?i:-1,i++;r==-1?e(t[0]).find("label").addClass("selected"):r<t.length-1&&e(t[r+1]).find("label").addClass("selected")},o=function(t){var n=t.find("label.selected");n.length&&n.removeClass("selected");var r=-1,i=0;while(i<t.length&&r==-1)r=t[i]==n.parent()[0]?i:-1,i++;r==-1?e(t[t.length-1]).find("label").addClass("selected"):r>0&&e(t[r-1]).find("label").addClass("selected")};if(i.which==13){i.preventDefault();var u=t.find(".labels_list label.selected");if(u.length){var a=u.attr("rel"),f=Upfront.data.ugallery.label_ids[a];e(i.target).val("").siblings(".labels_list").html(""),n.addLabel(f.text,r)}else{var f=e.trim(e(i.target).val());f.length&&(e(i.target).val("").siblings(".labels_list").html(""),n.addLabel(f,r))}}else if(i.which==9||i.which==40){var l=t.find(".labels_list li");l.length&&(i.preventDefault(),s(l))}else if(i.which==38){var l=t.find(".labels_list li");l.length&&(i.preventDefault(),o(l))}else i.which==27&&(i.preventDefault(),e(i.target).siblings(".labels_list").html(""))}).on("click","label",function(i){var s=e(i.target).attr("rel");if(s){var o=Upfront.data.ugallery.label_ids[s];n.addLabel(o.text,r),t.find('input[name="ugallery-image-labels"]').val("").siblings(".labels_list").html("")}}).on("click",".existing_labels a",function(t){t.preventDefault();var i=e(t.target),s=i.data("idx"),o=n.imageLabels[r].split(", "),u=!0,a={action:"upfront-media-disassociate_label",term:s,post_id:r};Upfront.Util.post(a).success(function(e){console.log(e)});for(var f in o)o[f]&&o[f]=='"label_'+s+'"'&&o.splice(f,1);n.imageLabels[r]=o.join(", "),n.deleteLabel(s,r),e(t.target).fadeOut("fast",function(){e(this).remove(),n.render()})}),t},deleteLabel:function(e,t){var n=this,r=!0;n.images.each(function(i){i.id!=t&&n.imageLabels[i.id].indexOf('"label_'+e+'"')!=-1&&(r=!1)});if(r)for(var i in n.labels)n.labels[i]&&n.labels[i].id==e&&n.labels.splice(i,1)},addLabel:function(t,n){var r=Upfront.data.ugallery.label_names[t];if(r){var i=!1,s=0,o=!1;while(s<this.labels.length&&!i)i=this.labels[s].id==r.id,s++;i?this.imageLabels[n].indexOf("label_"+r.id)==-1&&(this.imageLabels[n]+=', "label_'+r.id+'"',o=!0):(this.labels.push({id:r.id,text:r.text}),this.imageLabels[n]=this.imageLabels[n]?this.imageLabels[n]+', "label_'+r.id+'"':'"label_'+r.id+'"',o=!0);if(o){this.renderLabels(n);var u={action:"upfront-media-associate_label",term:r.id,post_id:n};Upfront.Util.post(u).success(function(e){console.log(e)})}}else{var a=this,f=-parseInt(Math.random()*100,10),r={id:f,term_id:f,text:t},u={action:"upfront-media-add_label",term:t,post_id:n};Upfront.data.ugallery.label_names[t]=r,Upfront.data.ugallery.label_ids[f]=r,this.labels.push(r),this.imageLabels[n]=this.imageLabels[n]?this.imageLabels[n]+', "label_'+f+'"':'"label_'+f+'"',e("#ugallery-tooltip").find(".existing_labels").html(this.labelsTpl({labels:this.extractImageLabels(n)})),Upfront.Util.post(u).success(function(e){console.log(e);var r=e.data[n],i=[],s=0,o={};_.each(r,function(e){i.push('"label_'+e+'"'),Upfront.data.ugallery.label_ids[e]||(s=e)}),i=i.join(", "),o={id:s,text:t},Upfront.data.ugallery.label_names[t]=o,Upfront.data.ugallery.label_ids[o.id]=o,delete Upfront.data.ugallery.label_ids[f],a.imageLabels[n]=i,_.each(a.labels,function(e){e.text==t&&(e.id=o.id)})}),this.renderLightboxLabels(n)}this.renderLightboxLabels(n),this.render()},renderLabels:function(t){e("#ugallery-tooltip").find(".existing_labels").html(this.labelsTpl({labels:this.extractImageLabels(t)}))},renderLightboxLabels:function(t){var n=e(".ugallery-magnific-wrapper");n.length&&(n.find("a").remove(),n.prepend(e.trim(this.labelsTpl({labels:this.extractImageLabels(t)}))))},postTypes:function(){var e=[];return _.each(Upfront.data.ugallery.postTypes,function(t){t.name!="attachment"&&e.push({name:t.name,label:t.label})}),e},saveImageLink:function(t){var n=e("#ugallery-tooltip"),r=n.find("input[name=ugallery-image-link]:checked").val(),i=n.find("#ugallery-image-id").val(),s=n.find("#ugallery-image-link-url").val();return r=="external"||r=="post"?this.images.get(i).set({link:r,url:s}):this.images.get(i).set({link:"original",url:""}),this.closeTooltip(),this.render()},getItemElement:function(t){return e(t.target).closest(".ugallery_item")},removeImage:function(t){var n=this,r=this.getItemElement(t);t.preventDefault(),r.fadeOut("fast",function(){var t=r.attr("rel");n.images.remove(t),n.imagesChanged(),n.images.length||n.property("has_settings",0);var i=n.imageLabels[t].split(",");_.each(i,function(r){var i=e.trim(r.replace('"label_',"").replace('"',""));n.deleteLabel(i,t)}),n.imageLabels[t]="",n.render()})},activateSortable:function(){var e=this;this.$(".ugallery").sortable({items:"div.ugallery_item:not(.ugallery_addmore)",start:function(t,n){console.log("draggin"),e.$el.addClass("ugallery_sorting")},stop:function(t,n){e.$el.removeClass("ugallery_sorting")},update:function(){e.sortOk()},change:function(e,t){},delay:500,cancel:".ugallery-thumb-title"}),this.$(".ugallery_item_removing").removeClass("ugallery_item_removing")},sortOk:function(){var t=this.$(".ugallery_item"),n=[],r=this;_.each(t,function(t){var i=e(t).attr("rel");i&&n.push(r.images.get(i))}),this.images.reset(n)},activateLightbox:function(){var t=[];this.$(".ugallery_item").each(function(n,r){t.push({el:e(r),src:e(r).find("a.ugallery_link").attr("href")}),e(r).find(".upfront-icon-region-fullscreen").attr("href",e(r).find("a.ugallery_link").attr("href"))}),this.$(".ugallery").magnificPopup({gallery:{enabled:!0},type:"image",delegate:".upfront-icon-region-fullscreen",items:t})},openTooltip:function(t,n){var r=e("#ugallery-tooltip"),i=n.offset(),s={top:i.top+n.outerHeight(),left:i.left-125+Math.floor(n.outerWidth()/2)},o="ugallery-tooltip-bottom",u=this;r.length||(r=e('<div id="ugallery-tooltip" class="upfront-ui"></div>'),e("body").append(r)),r.hide().html(t),i.right=i.left+n.width(),i.left-280<0&&(s.left=i.left+n.width()+20,o="ugallery-tooltip-bottom"),r.css(s).addClass(o).show().on("click",function(e){e.stopPropagation()}).on("blur",function(e){u.closeTooltip()}).on("closed",function(e){n.closest(".ugallery_item").removeClass("tooltip-open")}),n.closest(".ugallery_item").addClass("tooltip-open"),Upfront.Events.trigger("entity:settings:deactivate")},closeTooltip:function(t){if(t)if(e(t.target).closest("#ugallery-tooltip").length||e(t.target).hasClass("upfront-icon-region-link"))return;var n=e("#ugallery-tooltip");n.hide().trigger("closed"),setTimeout(function(){n.remove()},100)},cleanup:function(){this.images.each(function(e){e.controls&&e.controls.remove()}),e("body").off("click",this.closeTooltip)},extract_properties:function(){var e={};return this.model.get("properties").each(function(t){e[t.get("name")]=t.get("value")}),e},property:function(e,t,n){return typeof t!="undefined"?(typeof n=="undefined"&&(n=!0),this.model.set_property(e,t,n)):this.model.get_property_value_by_name(e)}})),u=Upfront.Views.Editor.Sidebar.Element.extend({priority:30,render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-gallery"),this.$el.html("Gallery")},add_element:function(){var e=new s,t=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c22 upfront-ugallery_module"},{name:"has_settings",value:0},{name:"row",value:16}],objects:[e]});this.add_module(t)}}),a=Upfront.Views.Editor.Settings.Settings.extend({initialize:function(){var e=this;this.panels=_([new f({model:this.model}),new l({model:this.model})]),this.on("closed",function(){e.model.trigger("settings:closed")})},get_title:function(){return"Gallery settings"}}),f=Upfront.Views.Editor.Settings.Panel.extend({className:"upfront-settings_panel_wrap ugallery-settings",initialize:function(){var t=this,n=Upfront.Views.Editor.Field;this.settings=_([new Upfront.Views.Editor.Settings.Item({title:"Show Caption",fields:[new n.Radios({model:this.model,property:"captionWhen",layout:"horizontal-inline",values:[{value:"never",label:"never"},{value:"hover",label:"on hover"},{value:"always",label:"always"}]}),new n.Radios({model:this.model,property:"captionPosition",layout:"horizontal-inline",values:[{value:"over",label:"over img",icon:"over"},{value:"below",label:"under img",icon:"below"}]})]}),new h({title:"Caption Background",fields:[new n.Radios({model:this.model,property:"captionUseBackground",layout:"horizontal-inline",values:[{value:"0",label:"None"},{value:"1",label:"Pick color"}]})]}),new Upfront.Views.Editor.Settings.Item({group:!1,fields:[new n.Checkboxes({model:this.model,property:"labelFilters",values:[{value:"true",label:"Enable label sorting"}]})]})]),this.on("rendered",function(){t.toggleColorSetting();var n=!1,r=t.model.get_property_value_by_name("captionBackground"),i=e('<input type="text" value="'+r+'">'),s=t.$(".ugallery-colorpicker-setting");s.find(".upfront-field-wrap").append(i),s.find('input[name="captionUseBackground"]').on("change",function(){t.toggleColorPicker()}),i.spectrum({showAlpha:!0,showPalette:!0,palette:["fff","000","0f0"],maxSelectionSize:9,localStorageKey:"spectrum.recent_bgs",preferredFormat:"hex",chooseText:"Ok",showInput:!0,allowEmpty:!0,show:function(){n=e(".sp-container:visible")},change:function(e){var n=e.toRgbString();t.model.set_property("captionBackground",n,!0),r=n},move:function(e){var r=e.toRgbString();n.find(".sp-dragger").css("border-top-color",r),n.parent().find(".sp-dragger").css("border-right-color",r),t.parent_view.for_view.$el.find(".ugallery-thumb-title").css("background-color",r)},hide:function(){t.parent_view.for_view.$el.find(".ugallery-thumb-title").css("background-color",r)}}),s.find(".sp-replacer").css("display","inline-block"),t.toggleColorPicker()}),this.$el.on("change","input[name=captionWhen]",function(e){t.toggleColorSetting()})},toggleColorPicker:function(){var e=this.$(".ugallery-colorpicker-setting"),t=e.find("input:checked").val(),n=e.find(".sp-replacer");t=="1"?(n.show(),this.parent_view&&this.parent_view.for_view.$el.find(".ugallery-thumb-title").css("background-color",this.model.get_property_value_by_name("captionBackground"))):(n.hide(),this.parent_view&&this.parent_view.for_view.$el.find(".ugallery-thumb-title").css("background-color","transparent"))},toggleColorSetting:function(){var t=this.$("input[name=captionWhen]:checked").val();t=="never"?this.$(".ugallery-colorpicker-setting").hide():this.$(".ugallery-colorpicker-setting").show();var n=e("#settings");n.height(n.find(".upfront-settings_panel:visible").outerHeight())},get_label:function(){return"Layout"},get_title:function(){return!1}}),l=Upfront.Views.Editor.Settings.Panel.extend({initialize:function(){var t=this,n=Upfront.Views.Editor.Field;this.settings=_([new p({model:this.model})]),this.on("rendered",function(){e(t.$(".ugallery-thumbnail-fields").find(".upfront-field-wrap-number").get(0)).after('<div class="ugallery-proportional"></div>'),t.setEvents([["change","input[name=thumbWidth]","onThumbChangeSize"],["change","input[name=thumbProportions]","onThumbChangeProportions"]])})},get_label:function(){return"Thumbnails"},get_title:function(){return!1},setEvents:function(e){var t=this;_.each(e,function(e){t.$el.on(e[0],e[1],function(n){t[e[2]](n)})})},onThumbChangeSize:function(t){var n=this,r=this.property("thumbProportions"),i=e(t.target).val(),s=Math.round(e(t.target).val()/r);return r=="theme"&&(r=1),this.$("input[name=thumbHeight]").val(s),this.property("thumbWidth",i),this.property("thumbHeight",s,!1),this.model.trigger("thumbChange"),s},onThumbChangeProportions:function(t){var n=this,r=e(t.target).val(),i=this.$("input[name=thumbWidth]"),s=i.val();r=="theme"&&(r=1),this.property("thumbProportions",r);var o=this.onThumbChangeSize({target:i[0]});this.$("input[name=thumbWidth]").siblings(".upfront-field-slider-value").text("("+s+"px x "+o+"px)"),this.model.trigger("thumbChange")},property:function(e,t,n){return typeof t!="undefined"?(typeof n=="undefined"&&(n=!0),this.model.set_property(e,t,n)):this.model.get_property_value_by_name(e)}}),c=Upfront.Views.Editor.Field.Field.extend({init:function(){console.log("Button!!")},events:{"click button":"buttonClicked"},render:function(){this.$el.html(this.get_field_html())},get_field_html:function(){return'<p class="upfront-field-button-info">'+this.options.info+'</p><button class="upfront-field-button ugallery-reset-button">'+this.options.label+"</button>"},buttonClicked:function(e){this.options.on_click&&this.options.on_click(e)},isProperty:!1}),h=Upfront.Views.Editor.Settings.Item.extend({className:"ugallery-colorpicker-setting"}),p=Upfront.Views.Editor.Settings.Item.extend({className:"align-center ugallery-thumbnail-fields",initialize:function(){var e=this,t=Upfront.Views.Editor.Field;this.fields=_([new t.Radios({model:this.model,property:"thumbProportions",label:"Crop",layout:"vertical",values:[{label:"Theme",value:"theme",icon:"gallery-crop-theme"},{label:"1:1",value:"1",icon:"gallery-crop-1_1"},{label:"2:3",value:"0.66",icon:"gallery-crop-2_3"},{label:"4:3",value:"1.33",icon:"gallery-crop-4_3"}]}),new t.Slider({model:this.model,property:"thumbWidth",min:100,max:250,step:5,label:"Size",info:"Slide to resize the thumbnails.",valueTextFilter:function(t){return"("+t+"px x "+e.model.get_property_value_by_name("thumbHeight")+"px)"}}),new t.Hidden({model:this.model,property:"thumbHeight"})])},get_title:function(){return"Thumbnails Settings"}});Upfront.Application.LayoutEditor.add_object("Ugallery",{Model:s,View:o,Element:u,Settings:a}),Upfront.Models.UgalleryModel=s,Upfront.Views.UgalleryView=o})}(jQuery),define("text!elements/upfront-image/tpl/image.html",[],function(){return'<div class="uimage uimage-<?php echo $caption_position ?> uimage-status-<?php echo $image_status ?> uimage-caption-<?php echo $caption_position ?>-<?php echo $caption_alignment ?>" id="<?php echo $element_id ?>" style="text-align: <?php echo $align ?>; min-height: <?php echo $element_size[\'height\'] ?>px;">\r\n	<div class="upfront-image-caption-container" style="margin-top:<?php echo $marginTop ?>px">\r\n		<?php if($url) { ?>\r\n		<a href="<?php echo $url ?>">\r\n		<?php } ?>\r\n			<?php if($src){ ?>\r\n			<div class="upfront-image-container">\r\n				<img src="<?php echo $src ?>" alt="<?php echo $alternative_text ?>" title="<?php echo $image_title ?>" style="width:<?php echo $imgWidth ?>;"/>\r\n			</div>\r\n			<?php } ?>\r\n\r\n		<?php if($include_image_caption){// && $caption_position != \'below_image\'){ ?>\r\n		<div class="wp-caption uimage-<?php echo $caption_alignment ?> uimage-<?php echo $caption_trigger ?>" style="background:<?php echo $captionBackground == \'1\' ? $background : \'\' ?>; ">\r\n			<?php if($cover_caption) { ?>\r\n				<div class="uimage-caption-cover">\r\n			<?php } ?>\r\n					<?php echo $image_caption ?>\r\n			<?php if($cover_caption) { ?>\r\n				</div>\r\n			<?php } ?>\r\n		</div>\r\n		<?php } ?>\r\n\r\n		<?php if($url) { ?>\r\n		</a>\r\n		<?php } ?>\r\n	</div>\r\n</div>\r\n\r\n<style>\r\n	#<?php echo $element_id ?> .uimage {\r\n		line-height: 0;\r\n	}\r\n	#<?php echo $element_id ?> .wp-caption *{\r\n		-moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box;\r\n	}\r\n	#<?php echo $element_id ?> .wp-caption {\r\n		line-height: initial;\r\n	}\r\n	#<?php echo $element_id ?> .uimage-over_image {\r\n		position:relative;\r\n	}\r\n	#<?php echo $element_id ?> .uimage-over_image .wp-caption{\r\n		position:absolute;\r\n		width: 100%;\r\n		left: 0;\r\n		top: 0;\r\n	}\r\n	#<?php echo $element_id ?> .uimage-over_image .uimage-fill,\r\n	#<?php echo $element_id ?> .uimage-over_image .uimage-fill_middle,\r\n	#<?php echo $element_id ?> .uimage-over_image .uimage-fill_bottom{\r\n		text-align: left;\r\n		height: 100%;\r\n	}\r\n\r\n	#<?php echo $element_id ?> .uimage-caption-over_image-top .wp-caption{\r\n	}\r\n\r\n	#<?php echo $element_id ?> .uimage-caption-over_image-bottom .wp-caption{\r\n		top: auto;\r\n		bottom: 0;\r\n	}\r\n\r\n	#<?php echo $element_id ?> .uimage-fill_bottom:before,\r\n	#<?php echo $element_id ?> .uimage-fill_middle:before,\r\n	#<?php echo $element_id ?> .uimage-fill:before{\r\n		content: \' \';\r\n		display: inline-block;\r\n		vertical-align: middle;\r\n		width: 1px;\r\n		margin-right: -0.25em;\r\n		height: 100%;\r\n	}\r\n\r\n	#<?php echo $element_id ?> .uimage-caption-cover{\r\n		display: inline-block;\r\n		vertical-align: top;\r\n		width:99%;\r\n	}\r\n	#<?php echo $element_id ?> .uimage-fill_middle .uimage-caption-cover{\r\n		vertical-align: middle;\r\n	}\r\n	#<?php echo $element_id ?> .uimage-fill_bottom .uimage-caption-cover{\r\n		vertical-align: bottom;\r\n	}\r\n\r\n	#<?php echo $element_id ?> .uimage-over_image div.uimage-bottom{\r\n		top:auto;\r\n	}\r\n\r\n	#<?php echo $element_id ?> .uimage-over_image .uimage-hover_show {\r\n		opacity:0;\r\n	}\r\n\r\n	#<?php echo $element_id ?> .uimage-over_image:hover .uimage-hover_show {\r\n		opacity:1;\r\n	}\r\n\r\n	#<?php echo $element_id ?> .uimage-over_image .wp-caption{\r\n		padding: 5px 15px;\r\n	}\r\n\r\n	#<?php echo $element_id ?> img {\r\n		<?php if($size[\'width\'] > 30 || $size[\'height\'] > 30){ ?>\r\n		max-width: 100%;\r\n		<?php } ?>\r\n		max-height: none;\r\n		vertical-align: top;\r\n	}\r\n</style>'}),define("text!elements/upfront-image/tpl/image_editor.html",[],function(){return'<div>\r\n<!--\r\n	Wrap everything in a div to convert this file\'s content in a jquery element\r\n	so it is possible to use $.find.\r\n-->\r\n\r\n<script type="text/template" id="selector-tpl">\r\n	<div id="upront-image-placeholder" class="upfront-image-section">\r\n		<div class="upfront-image-selector-container">\r\n			<h2>Drop files here to upload</h2>\r\n			<a class="button select-files" href="#">Select Files</a>\r\n			<div id="upfront-image-maxsize">Maximum upload file size: 32MB</div>\r\n			or browse your\r\n			<div class="upfront-image-media-container">\r\n			<i class="icon-picture"></i> <a class="open-media-gallery" href="#">media gallery</a>\r\n			</div>\r\n			<span class="dragimagehand"></span>\r\n		</div>\r\n	</div>\r\n</div>\r\n</script>\r\n\r\n<script type="text/template" id="progress-tpl">\r\n	<div id="upfront-image-uploading" class="upfront-image-section">\r\n		<h2>Uploading...</h2>\r\n		<div class="upfront-progress-container">\r\n			<div id="upfront-progress"></div>\r\n		</div>\r\n	</div>\r\n</script>\r\n\r\n<script type="text/template" id="editor-tpl">\r\n	<div id="uimage-cover" style="position:absolute; top:{{maskOffset.top}}px; left:{{maskOffset.left}}px; height: {{maskSize.height}}px; width: {{maskSize.width}}px"></div>\r\n	<div id="uimage-canvas" style="position:absolute; overflow:hidden; top:{{offset.top}}px; left:{{offset.left}}px; height: {{size.height}}px; width: {{size.width}}px">\r\n		<img class="uimage-img {{ rotation }}" src="{{src}}" style="width:100%; height:100%; position:absolute">\r\n	</div>\r\n\r\n	<div id="uimage-mask" class="image-edit-mask" style="position:absolute; top:{{maskOffset.top}}px; left:{{maskOffset.left}}px; height: {{maskSize.height}}px; width: {{maskSize.width}}px"></div>\r\n\r\n	<div id="uimage-drag-handle" style="width:{{size.width}}px; height:{{size.height}}px;position:absolute; top:{{offset.top}}px; left:{{offset.left}}px">\r\n		<div class="image-edit-resize image-edit-control"><i class="ui-resizable-handle ui-resizable-handle-se"></i></div>\r\n		<div class="image-edit-rotate image-edit-control"><i class=""></i></div>\r\n	</div>\r\n\r\n	<div id="image-edit-buttons" style="position: absolute; top:{{maskOffset.top}}px; left: {{maskOffset.left + maskSize.width + 5}}px;">\r\n		{[ for (var i = 0; i < buttons.length; i++) { ]}\r\n		<a class="image-edit-button" id="{{buttons[i].id}}" data-tooltip="{{buttons[i].tooltip}}">{{buttons[i].text}}</a>\r\n		{[ } ]}\r\n	</div>\r\n	<div id="image-edit-buttons-bottom" style="z-index: 11; position: absolute; top:{{maskSize.width < 150 ? maskOffset.top : maskOffset.top + maskSize.height + 5}}px; left:{{maskSize.width < 150 ? maskOffset.left - 205 : maskOffset.left}}px; width: 200px" class="{{maskSize.width < 150 ? \'image-edit-buttons-toleft\' : \'\' }}">\r\n		<a class="image-edit-button" id="image-edit-button-swap" data-tooltip="Use a different image">Change IMG</a>\r\n		<a class="image-edit-button" id="image-edit-button-align" data-tooltip="Align image" ></a>\r\n		</div>\r\n	<div id="uimage-tooltip" class="nav_tooltip upfront-ui"></div>\r\n</script>\r\n\r\n<script type="text/template" id="upload-form-tpl">\r\n<form id="upfront-upload-image" name="upfront-upload-image" enctype="multipart/form-data" method="post" action="{{url}}">\r\n	<input type="file" name="media" id="upfront-image-file-input" >\r\n	<input type="hidden" name="action" value="upfront-media-upload">\r\n	<input type="submit" value="Upload">\r\n</form>\r\n</script>\r\n\r\n<script type="text/template" id="link-tpl">\r\n	<h3>Links to:</h3>\r\n	<div class="upfront-field-wrap">\r\n		<input type="radio" name="ugallery-image-link" value="do_nothing" class="upfront-field-radio" id="ugallery-image-link-1" {{when_clicked == \'do_nothing\' ? checked : \'\'}}>\r\n		<label for="ugallery-image-link-1">No link</label>\r\n	</div>\r\n	<div class="upfront-field-wrap">\r\n		<input type="radio" name="ugallery-image-link" value="external" class="upfront-field-radio" id="ugallery-image-link-2" {{when_clicked == \'external\' ? checked : \'\'}}>\r\n		<label for="ugallery-image-link-2">External link</label>\r\n		<input type="text" value="{{image_link}}" id="ugallery-image-link-url" placeholder="Type link URL" style="{{when_clicked != \'external\' ? \'display:none\' : \'\'}}" class="upfront-field-text">\r\n	</div>\r\n	<div class="upfront-field-wrap">\r\n		<input type="radio" name="ugallery-image-link" value="post" class="upfront-field-radio" id="ugallery-image-link-3" {{when_clicked == \'post\' ? checked : \'\'}}>\r\n		<label for="ugallery-image-link-3">Link to a post or page</label>\r\n		<a title="Change link" class="ugallery-change-link-post" style="{{when_clicked != \'post\' ? \'display:none\' : \'\'}}">{{image_link}}</a>\r\n	</div>\r\n	<div class="upfront-field-wrap">\r\n		<input type="radio" name="ugallery-image-link" value="show_larger_image" class="upfront-field-radio" id="ugallery-image-link-4" {{when_clicked == \'show_larger_image\' ? checked : \'\'}}>\r\n		<label for="ugallery-image-link-4">Show larger image</label>\r\n	</div>\r\n	{[if(anchors.length > 1) { ]}\r\n	<div class="upfront-field-wrap">\r\n		<input type="radio" name="ugallery-image-link" value="anchor" class="upfront-field-radio" {{when_clicked == \'anchor\' ? checked : \'\'}} id="ugallery-image-link-anchor">\r\n		<label for="ugallery-image-link-anchor">Anchor</label>\r\n		<div id="ugallery-image-anchor-select" style="{{when_clicked != \'anchor\' ? \'display:none\' : \'\'}}">\r\n			<select class="ueditor-anchor-selector">\r\n			{[ _.each(anchors, function(anchor){ ]}\r\n				<option value="#{{ anchor }}" {{ image_link == \'#\' + anchor ? \'selected="selected"\' : \'\' }}>{{anchor}}</option>\r\n			{[ }); ]}\r\n			</select>\r\n		</div>\r\n	</div>\r\n	{[ } ]}\r\n	<div class="upfront-settings-button_panel">\r\n		<button type="button" class="upfront-save_settings"><i class="icon-ok"></i> Ok</button>\r\n	</div>\r\n</script>\r\n\r\n\r\n<script type="text/template" id="sizehint-tpl">\r\n	<b class="uimage-sizehint-big">w:</b>{{width}}<span class="uimage-sizehint-big">px</span> <span class="uimage-sizehint-small">x</span> <b class="uimage-sizehint-big">h:</b>{{height}}<span class="uimage-sizehint-big">px</span>\r\n</div>\r\n</script>\r\n\r\n<script type="text/template" id="fullwidth-alert-tpl">\r\n	<div class="uimage-fullwidth-alert">\r\n		<p>To achieve full-width Image, please first move it so that there are no other elements in the way.</p>\r\n		<div class="clearfix">\r\n			<div class="uimage-fullwidth-info uimage-fullwidth-info-1"></div>\r\n			<div class="uimage-fullwidth-info uimage-fullwidth-info-2"></div>\r\n			<div class="uimage-fullwidth-info uimage-fullwidth-info-3"></div>\r\n		</div>\r\n		<div style="margin-top:10px">\r\n			<input class="upfront-field-checkbox" type="checkbox" id="uimage-fullwidth-noalert" value="1">\r\n			<label for="uimage-fullwidth-noalert">Don\'t show this message again</label>\r\n		</div>\r\n	</div>\r\n</div>\r\n</script>\r\n\r\n</div>'}),function(e){define("uimage",["text!elements/upfront-image/tpl/image.html","text!elements/upfront-image/tpl/image_editor.html","text!elements/upfront-gallery/tpl/ugallery_editor.html"],function(t,n,r){var i=e(n),s={},o=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(Upfront.data.uimage.defaults);e.element_id=Upfront.Util.get_unique_id(e.id_slug),this.init_properties(e)}}),u=Upfront.Views.ObjectView.extend(_.extend({},{model:o,imageTpl:Upfront.Util.template(t),selectorTpl:_.template(i.find("#selector-tpl").html()),progressTpl:_.template(i.find("#progress-tpl").html()),linkTpl:_.template(i.find("#link-tpl").html()),formTpl:_.template(i.find("#upload-form-tpl").html()),sizehintTpl:_.template(i.find("#sizehint-tpl").html()),sizes:!1,elementSize:{width:0,height:0},imageId:0,imageSize:{width:0,height:0},imageOffset:{top:0,left:0},maskOffset:{top:0,left:0},imageInfo:!1,controls:!1,editor:!1,temporaryProps:{size:!1,position:!1},cropTimer:!1,stoppedTimer:!1,cropTimeAfterResize:1e4,cssSelectors:{".upfront-image":{label:"Image element",info:"The whole image element"},".wp-caption":{label:"Caption panel",info:"Caption layer"},".upfront-image-container":{label:"Image wrapper",info:"Image container"}},initialize:function(){var t=this;this.model instanceof o||(this.model=new o({properties:this.model.get("properties")})),this.events=_.extend({},this.events,{"click a.upfront-image-select":"openImageSelector","click div.upfront-quick-swap":"openImageSelector","dblclick .wp-caption":"editCaption"}),this.delegateEvents(),this.bodyEventHandlers={dragover:function(e){e.preventDefault(),t.handleDragEnter(e)},dragenter:function(e){t.handleDragEnter(e)},dragleave:function(e){t.handleDragLeave(e)},drop:function(e){console.log("drop body")}},e("body").on("dragover",this.bodyEventHandlers.dragover).on("dragenter",this.bodyEventHandlers.dragenter).on("dragleave",this.bodyEventHandlers.dragleave).on("drop",this.bodyEventHandlers.drop),this.property("image_id")||this.property("srcFull",this.property("src")),this.listenTo(this.model.get("properties"),"change",this.render),this.listenTo(this.model.get("properties"),"add",this.render),this.listenTo(this.model.get("properties"),"remove",this.render),this.listenTo(this.model,"uimage:edit",this.editRequest),this.controls=this.createControls(),(this.property("image_status")!="ok"||this.property("quick_swap"))&&this.property("has_settings",0),this.listenTo(Upfront.Events,"upfront:element:edit:start",this.on_element_edit_start),this.listenTo(Upfront.Events,"upfront:element:edit:stop",this.on_element_edit_stop),this.listenTo(Upfront.Events,"command:layout:save",this.saveResizing),this.listenTo(Upfront.Events,"command:layout:save_as",this.saveResizing),this.sizeClasses={narrow:!1,small:!1,tiny:!1}},getSelectedAlignment:function(){if(!this.property("include_image_caption"))return"nocaption";if(this.property("caption_position")=="below_image")return"below";var e=this.property("caption_alignment");switch(e){case"top":return"topOver";case"bottom":return"bottomOver";case"fill":return"topCover";case"fill_middle":return"middleCover";case"fill_bottom":return"bottomCover"}return"nocaption"},createControls:function(){var e=this,t=new y,n=new v;return n.sub_items={topOver:this.createControl("topOver","Over image, top"),bottomOver:this.createControl("bottomOver","Over image, bottom"),topCover:this.createControl("topCover","Covers image, top"),middleCover:this.createControl("middleCover","Covers image, middle"),bottomCover:this.createControl("bottomCover","Covers image, bottom"),below:this.createControl("below","Below the image"),nocaption:this.createControl("nocaption","No caption")},n.icon="caption",n.tooltip="Caption position",n.selected=this.getSelectedAlignment(),this.listenTo(n,"select",function(t){switch(t){case"topOver":e.property("include_image_caption",[1]),e.property("caption_position","over_image"),e.property("caption_alignment","top");break;case"bottomOver":e.property("include_image_caption",[1]),e.property("caption_position","over_image"),e.property("caption_alignment","bottom");break;case"topCover":e.property("include_image_caption",[1]),e.property("caption_position","over_image"),e.property("caption_alignment","fill");break;case"middleCover":e.property("include_image_caption",[1]),e.property("caption_position","over_image"),e.property("caption_alignment","fill_middle");break;case"bottomCover":e.property("include_image_caption",[1]),e.property("caption_position","over_image"),e.property("caption_alignment","fill_bottom");break;case"below":e.property("include_image_caption",[1]),e.property("caption_position","below_image");break;case"nocaption":e.property("include_image_caption",!1)}e.render()}),t.items=_([this.createControl("crop","Edit image","editRequest"),this.createControl("link","Link image","openLinkEditor"),n]),t},openLinkEditor:function(t){t.preventDefault();var n=this,r=this.extract_properties(),i;r.checked='checked="checked"',r.anchors=this.getAnchors(),i=e("<div/>").append(this.linkTpl(r)).on("change","input[name=ugallery-image-link]",function(e){n.linkChanged(e)}).on("click","button.upfront-save_settings",function(e){n.saveLink(e)}).on("click",".ugallery-change-link-post",function(e){n.linkChanged(e)}),this.openTooltip(i,e(t.target))},getAnchors:function(){var e=Upfront.Application.layout.get("regions"),t=[""];return e.each(function(e){e.get("modules").each(function(e){e.get("objects").each(function(e){var n=e.get_property_value_by_name("anchor");n&&n.length&&t.push(n)})})}),t},linkChanged:function(t){var n=this,r=e("#ugallery-tooltip").find("input[name=ugallery-image-link]:checked").val();if(r=="external")e("#ugallery-image-link-url").show(),e("#ugallery-image-anchor-select").hide();else if(r=="anchor")e("#ugallery-image-anchor-select").show(),e("#ugallery-image-link-url").hide();else{e("#ugallery-image-link-url").hide(),e("#ugallery-image-anchor-select").hide();if(r=="post"||t.type!="change"){var i={postTypes:this.postTypes()};this.closeTooltip(),Upfront.Views.Editor.PostSelector.open(i).done(function(e){n.property("when_clicked",r),n.property("image_link",e.get("permalink"))})}}},saveLink:function(t){var n=e("#ugallery-tooltip"),r=n.find("input[name=ugallery-image-link]:checked").val(),i=n.find("#ugallery-image-link-url").val();return this.property("when_clicked",r),r!="external"&&r!="post"||!i?r=="show_larger_image"?this.property("image_link",this.property("srcFull")):r=="anchor"?this.property("image_link",e("#ugallery-image-anchor-select").find("select").val()):this.property("image_link",""):this.property("image_link",i),this.closeTooltip(),this.render()},openTooltip:function(t,n){var r=e("#ugallery-tooltip"),i=n.offset(),s={top:i.top+n.outerHeight(),left:i.left-125+Math.floor(n.outerWidth()/2)},o="ugallery-tooltip-bottom",u=this;r.length||(r=e('<div id="ugallery-tooltip" class="upfront-ui"></div>'),e("body").append(r)),r.hide().html(t),i.right=i.left+n.width(),i.left-280<0&&(s.left=i.left+n.width()+20,o="ugallery-tooltip-bottom"),r.css(s).addClass(o).show().on("click",function(e){e.stopPropagation()}).on("blur",function(e){u.closeTooltip()}).on("closed",function(e){u.$el.removeClass("tooltip-open")}),this.$el.addClass("tooltip-open"),Upfront.Events.trigger("entity:settings:deactivate")},closeTooltip:function(){var t=e("#ugallery-tooltip");t.hide().trigger("closed"),setTimeout(function(){t.remove()},100)},postTypes:function(){var e=[];return _.each(Upfront.data.ugallery.postTypes,function(t){t.name!="attachment"&&e.push({name:t.name,label:t.label})}),e},editCaption:function(t){var n=this,r=e("#"+this.property("element_id")).find(".wp-caption");r.find(".uimage-caption-cover").length&&(r=r.find(".uimage-caption-cover"));if(r.data("ueditor")||!r.length)return;r.ueditor({autostart:!1,upfrontMedia:!1,upfrontImages:!1}).on("start",function(){n.$el.addClass("upfront-editing")}).on("stop",function(){n.$el.removeClass("upfront-editing")}).on("syncAfter",function(){n.property("image_caption",r.html())})},createControl:function(e,t,n){var r=this,i=new d;return i.icon=e,i.tooltip=t,n&&this.listenTo(i,"click",function(e){r[n](e)}),i},setImageInfo:function(){var e,t,n=this.$(".upfront-image-starting-select"),r=this.temporaryProps.size,i=this.temporaryProps.position,s=this.property("stretch"),o=this.$("img"),u=this.property("caption_position")=="below_image"?this.$(".wp-caption").outerHeight():0;n.length?(e={width:n.outerWidth(),height:n.outerHeight()},t=n.offset(),i=!1):(n=this.$(".uimage"),e={width:n.width(),height:n.height()-u},t={top:n.offset().top,left:n.offset().left}),this.imageInfo={id:this.property("image_id"),src:this.property("src"),srcFull:this.property("srcFull"),srcOriginal:this.property("srcOriginal"),size:r,position:i,rotation:this.property("rotation"),fullSize:this.property("fullSize"),align:this.property("align"),maskSize:e,maskOffset:t}},get_content_markup:function(){if(!this.property("element_size").width||!this.property("quick_swap")&&!_.isNumber(this.property("element_size").height))this.setElementSize(),this.property("element_size",this.elementSize);var t=this,n=this.extract_properties(),r=this.property("when_clicked");if(!this.temporaryProps||!this.temporaryProps.size)this.temporaryProps={size:n.size,position:n.position};n.url=r=="do_nothing"?!1:this.property("image_link"),n.size=this.temporaryProps.size,n.position=this.temporaryProps.position,n.marginTop=Math.max(0,-n.position.top),n.cover_caption=n.caption_position!="below_image",n.stretch?n.imgWidth="100%":n.imgWidth=n.size.width+"px";var i=this.imageTpl(n);console.log("Image element");if(this.property("quick_swap")){var s=n.element_size.width<150||n.element_size.height<90?"uimage-quick-swap-small":"";i+='<div class="upfront-quick-swap '+s+'"><p>Change this image</p></div>'}else if(this.property("image_status")=="starting")i+='<div class="upfront-image-starting-select upfront-ui" style="height:'+n.element_size.height+'px"><div class="uimage-centered">'+'<span class="upfront-image-resizethiselement">Add Image</span><div class=""><a class="upfront-image-select button" href="#" title="Add Image">+</a></div>'+"</div></div>";else{var o=e("<div></div>").append(i),u=n.element_size,a=n.size,f=o.find("img");n=this.temporaryProps,o.find(".upfront-image-container").css({overflow:"hidden",position:"relative",width:Math.min(u.width,a.width),height:Math.min(u.height,a.height)}),f.attr("src",t.property("srcFull")).css({width:a.width,height:a.height,position:"absolute",top:Math.min(0,-n.position.top),left:Math.min(0,-n.position.left),"margin-top":0,"max-height":"none","max-width":"none"}),i=o.html()}return i},on_render:function(){var t=this;t.parent_module_view.$el.data("resizeHandling")||t.parent_module_view.$el.on("resizestart",e.proxy(t.onElementResizeStart,t)).on("resize",e.proxy(t.onElementResizing,t)).on("resizestop",e.proxy(t.onElementResize,t)).data("resizeHandling",!0);if(this.property("image_status")!="ok"){var n=this.$(".upfront-image-starting-select");this.elementSize.height||(this.setElementSize(),n.height(this.elementSize.height)),t.$el.append(e("<div>").addClass("uimage-resize-hint upfront-ui").html(t.sizehintTpl({width:t.elementSize.width,height:t.elementSize.height})));return}if(this.property("quick_swap"))return!1;setTimeout(function(){var n=e("#"+t.property("element_id")).find(".upfront-image-container");t.controls.setWidth(n.width()),t.controls.render(),t.controls.$el.prepend('<div class="uimage-controls-toggle"></div>'),n.parent().append(e('<div class="uimage-controls upfront-ui"></div>').append(t.controls.$el)),t.controls.delegateEvents(),t.$el.removeClass("upfront-editing"),t.editCaption(),t.setSizeClasses(n.width(),n.height()),t.setSizeHTMLClasses()},300)},setSizeClasses:function(e,t){e<131&&!this.sizeClasses.narrow?(this.sizeClasses.narrow=!0,this.parent_module_view.$el.addClass("uimage-narrow")):e>130&&this.sizeClasses.narrow&&(this.sizeClasses.narrow=!1,this.parent_module_view.$el.removeClass("uimage-narrow")),t<120&&!this.sizeClasses.small?(this.sizeClasses.small=!0,this.parent_module_view.$el.addClass("uimage-small")):t>119&&this.sizeClasses.small&&(this.sizeClasses.small=!1,this.parent_module_view.$el.removeClass("uimage-small")),e<50&&!this.sizeClasses.tiny?(this.sizeClasses.tiny=!0,this.parent_module_view.$el.addClass("uimage-tiny")):e>49&&this.sizeClasses.tiny&&(this.sizeClasses.tiny=!1,this.parent_module_view.$el.removeClass("uimage-tiny"))},setSizeHTMLClasses:function(){var e=this;e.sizeClasses.small?this.parent_module_view.$el.addClass("uimage-small"):this.parent_module_view.$el.removeClass("uimage-small"),e.sizeClasses.tiny?this.parent_module_view.$el.addClass("uimage-tiny uimage-narrow"):(this.parent_module_view.$el.removeClass("uimage-tiny"),e.sizeClasses.narrow?this.parent_module_view.$el.addClass("uimage-narrow"):this.parent_module_view.$el.removeClass("uimage-narrow")),e.sizeClasses.small||e.sizeClasses.narrow?this.parent_module_view.$el.addClass("upfront-module-small"):this.parent_module_view.$el.removeClass("upfront-module-small")},on_edit:function(){return!1},extract_properties:function(){var e={};return this.model.get("properties").each(function(t){e[t.get("name")]=t.get("value")}),e},handleDragEnter:function(t){var n=this;if(!this.$(".uimage-drop-hint").length){var r=e('<div class="uimage-drop-hint">Drop the image here<form </div>').on("drop",function(t){t.preventDefault(),t.stopPropagation(),n.openImageSelector(),e(".uimage-drop-hint").remove();if(t.originalEvent.dataTransfer){var r=t.originalEvent.dataTransfer.files,i=e("#upfront-image-file-input");r.length&&i.length&&(i[0].files=r)}}).on("dragenter",function(t){t.preventDefault(),t.stopPropagation(),e(this).addClass("uimage-dragenter")}).on("dragleave",function(t){t.preventDefault(),t.stopPropagation(),e(this).removeClass("uimage-dragenter")});this.$(".upfront-image").append(r)}this.dragTimer&&(clearTimeout(this.dragTimer),this.dragTimer=!1)},handleDragLeave:function(e){var t=this;this.dragTimer=setTimeout(function(){t.$(".uimage-drop-hint").remove(),this.dragTimer=!1},200)},onElementResize:function(t,n){var r=this.$(".upfront-image-starting-select");if(r.length){this.elementSize={height:e(".upfront-resize").height()-30,width:e(".upfront-resize").width()-30},this.property("element_size",this.elementSize);return}if(this.property("quick_swap"))return;this.onElementResizing();var i=this,o=s.img,u=s.data.size,a=s.data.position,f={width:o.width(),height:o.height()},l=o.position();l.top=-l.top,l.left=-l.left,this.temporaryProps={size:f,position:l},this.cropTimer=setTimeout(function(){i.saveTemporaryResizing(),console.log("resizingTimer")},this.cropTimeAfterResize),this.property("element_size",s.data.elementSize),this.setSizeHTMLClasses(),s={},this.$(".wp-caption").fadeIn("fast")},onElementResizeStart:function(e,t){var n=this.$(".upfront-image-starting-select");this.property("caption_position")!="below_image"&&this.$(".wp-caption").fadeOut("fast"),s={starting:n,data:{position:this.property("position"),size:this.property("size"),stretch:this.property("stretch"),vstretch:this.property("vstretch")},img:this.$("img"),setTextHeight:this.property("caption_position")=="below_image"},this.cropTimer&&(clearTimeout(this.cropTimer),this.cropTimer=!1);if(n.length)return;this.$(".upfront-image-caption-container, .upfront-image-container").css({width:"100%",height:"100%",marginTop:0}),this.$(".uimage").css("min-height","auto")},onElementResizing:function(t,n){var r=s.starting,i=s.resizer,o=s.data,u=s.img,a=s.setTextHeight?this.$(".wp-caption").outerHeight():0;i||(i=e("html").find(".upfront-resize"),s.resizer=i),o.elementSize={width:i.width()-30,height:i.height()-30-a},this.setSizeClasses(i.width(),i.height());if(r.length)return this.$el.find(".uimage-resize-hint").html(this.sizehintTpl({width:o.elementSize.width,height:o.elementSize.height})).css({bottom:"auto",top:i.height()-39}),r.outerHeight(o.elementSize.height);this.$(".uimage").css("height",o.elementSize.height);if(o.stretch&&!o.vstretch)this.resizingH(u,o,!0),this.resizingV(u,o);else if(!o.stretch&&o.vstretch)this.resizingV(u,o,!0),this.resizingH(u,o);else{var f=o.size.width/o.size.height-o.elementSize.width/o.elementSize.height;f>0&&o.stretch||f<0&&!o.stretch?(this.resizingV(u,o,!0),this.resizingH(u,o)):(this.resizingH(u,o,!0),this.resizingV(u,o))}},resizingH:function(e,t,n){var r=t.elementSize.width,i=n?t.size.width:e.width(),s=t.position.left,o={};if(t.stretch)r<i-s?(o.left=-s,n&&(o.width=i)):i>r&&r>=i-s?(o.left=r-i,n&&(o.width=i)):(o.left=0,n&&(o.width=r)),n&&(o.height="auto");else if(r>i){var u=this.property("align");u=="left"?o.left=0:u=="center"?o.left=(r-i)/2:(o.left="auto",o.right=0),n&&(o.width=i,o.height="auto")}else o.left=0,n&&(o.width=r,o.height="auto");e.css(o)},resizingV:function(e,t,n){var r=t.elementSize.height,i=n?t.size.height:e.height(),s=t.position.top,o={};t.vstretch?(r<i-s?(o.top=-s,n&&(o.height=i)):i>r&&r>=i-s?(o.top=r-i,n&&(o.height=i)):(o.top=0,n&&(o.height=r)),n&&(o.width="auto")):(r>i-s?(o.top=-s,n&&(o.height=i)):i-s>=r&&r>i?(o.top=r-i,n&&(o.height=i)):(o.top=0,n&&(o.height=r)),n&&(o.width="auto")),e.css(o)},saveTemporaryResizing:function(){var e=this,t=e.property("element_size"),n=e.property("image_id"),r=e.temporaryProps.size,i=e.temporaryProps.position;t.top=Math.min(0,i.top),t.left=Math.min(0,i.left),t.width=Math.min(t.width,r.width),t.height=Math.min(t.height,r.height);var s=Upfront.Views.Editor.ImageEditor.saveImageEdition(n,e.property("rotation"),r,t).done(function(s){var o=s.data.images[n];if(o.error){console.error(o.msg);return}e.property("size",r),e.property("position",i),e.property("src",o.url),e.property("srcFull",o.urlOriginal,!1),e.property("stretch",r.width>=t.width),e.property("vstretch",r.height>=t.height),clearTimeout(e.cropTimer),e.cropTimer=!1});return s},saveResizing:function(){var e=this;this.cropTimer&&(clearTimeout(this.cropTimer),this.cropTimer=!1,this.saveTemporaryResizing().done(function(){var t={element:JSON.stringify(Upfront.Util.model_to_json(e.model)),action:"upfront_update_layout_element"};Upfront.Util.post(t).done(function(e){console.log("Ok")})}))},setElementSize:function(t){var n=this,r=this.parent_module_view.$(".upfront-editable_entity:first"),i=t?e(".upfront-resize"):r;n.elementSize={width:i.width()-32,height:i.height()-30},this.property("caption_position")=="below_image"&&(this.elementSize.height-=r.find(".wp-caption").outerHeight()),this.property("image_status")=="starting"&&this.$(".upfront-object-content").height(n.elementSize.height)},openImageSelector:function(t){var n=this;t&&t.preventDefault(),Upfront.Views.Editor.ImageSelector.open().done(function(t){var r={};_.each(t,function(e,t){r=e,n.imageId=t});var i={src:r.medium?r.medium[0]:r.full[0],srcFull:r.full[0],srcOriginal:r.full[0],fullSize:{width:r.full[1],height:r.full[2]},size:r.medium?{width:r.medium[1],height:r.medium[2]}:{width:r.full[1],height:r.full[2]},position:!1,rotation:0,id:n.imageId};e("<img>").attr("src",i.srcFull).load(function(){Upfront.Views.Editor.ImageSelector.close(),n.openEditor(!0,i)})})},handleEditorResult:function(e){this.property("image_status","ok",!0),this.property("has_settings",1),this.property("src",e.src,!0),this.property("srcFull",e.srcFull,!0),this.property("srcOriginal",e.srcOriginal,!0),this.property("size",e.imageSize,!0),this.property("position",e.imageOffset,!0);var t=e.mode=="horizontal"||e.mode=="small"?e.imageOffset.top*-1:0;this.property("marginTop",t,!0),this.property("rotation",e.rotation,!0),this.property("fullSize",e.fullSize,!0),this.property("element_size",e.maskSize,!0),this.property("align",e.align,!0),this.property("stretch",e.stretch,!0),this.property("vstretch",e.vstretch,!0),this.property("quick_swap",!1,!0),e.imageId&&this.property("image_id",e.imageId,!0);var n=this.parent_module_view.model;e.elementSize&&(console.log(e.elementSize),this.set_element_size(e.elementSize.columns,e.elementSize.rows,"all",!0)),this.temporaryProps=!1,this.render()},editRequest:function(){var e=this;if(this.property("image_status")=="ok"&&this.property("image_id"))return this.openEditor();Upfront.Views.Editor.notify("Image editing it is only suitable for images uploaded to WordPress","error")},getElementColumns:function(){var e=this.$el.closest(".upfront-module"),t,n=!1;return e.length?(t=e.attr("class").split(" "),_.each(t,function(e){e.match(/^c\d+$/)&&(n=e.replace("c",""))}),n||-1):-1},openEditor:function(e,t){var n=this,r={setImageSize:e,saveOnClose:e,editElement:this};this.setElementSize(),this.setImageInfo(),t?_.extend(r,this.imageInfo,t):_.extend(r,this.imageInfo),this.cropTimer&&(this.stoppedTimer=!0,clearTimeout(this.cropTimer),this.cropTimer=!1),r.element_id=n.model.get_property_value_by_name("element_id"),Upfront.Views.Editor.ImageEditor.open(r).done(function(e){n.handleEditorResult(e),this.stoppedTimer=!1}).fail(function(e){e&&e.reason=="changeImage"?n.openImageSelector():n.stoppedTimer&&(n.saveTemporaryResizing(),n.stoppedTimer=!1)})},cleanup:function(){this.controls.remove(),this.bodyEventHandlers&&_.each(this.bodyEventHandlers,function(t,n){e("body").off(n,t)})},property:function(e,t,n){return typeof t!="undefined"?(typeof n=="undefined"&&(n=!0),this.model.set_property(e,t,n)):this.model.get_property_value_by_name(e)}})),a=Upfront.Views.Editor.Sidebar.Element.extend({priority:20,render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-image"),this.$el.html("Image")},add_element:function(){var e=new o,t=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c22 upfront-image_module"},{name:"has_settings",value:0},{name:"row",value:17}],objects:[e]});this.add_module(t)}}),f=Upfront.Views.Editor.Settings.Settings.extend({initialize:function(){var e=this;this.panels=_([new l({model:this.model})]),this.on("open",function(){e.model.trigger("settings:open",e)})},get_title:function(){return"Image settings"}}),l=Upfront.Views.Editor.Settings.Panel.extend({className:"upfront-settings_panel_wrap uimage-settings",initialize:function(){var e=this,t=Upfront.Views.Editor.Settings.Item,n=Upfront.Views.Editor.Field;this.settings=_([new t({title:"alternative_text",group:!1,fields:[new n.Text({model:this.model,property:"alternative_text",label:"Alternative text"})]}),new t({title:"Show Caption:",fields:[new n.Radios({className:"field-caption_trigger upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-radios over_image_field",model:this.model,property:"caption_trigger",layout:"horizontal-inline",values:[{label:"always",value:"always_show"},{label:"on hover",value:"hover_show"}]})]})]),this.model.get_property_value_by_name("include_image_caption")&&this.addCaptionBackgroundPicker()},addCaptionBackgroundPicker:function(){var t=this,n=Upfront.Views.Editor.Field;this.settings.push(new c({title:"Caption Background",fields:[new n.Radios({model:this.model,property:"captionBackground",layout:"horizontal-inline",values:[{value:"0",label:"None"},{value:"1",label:"Pick color"}]})]})),this.on("rendered",function(){var n=!1,r=t.model.get_property_value_by_name("background"),i=e('<input type="text" value="'+r+'">'),s=t.$(".ugallery-colorpicker-setting");s.find(".upfront-field-wrap").append(i),s.find('input[name="captionBackground"]').on("change",function(){t.toggleColorPicker()}),i.spectrum({showAlpha:!0,showPalette:!0,palette:["fff","000","0f0"],maxSelectionSize:9,localStorageKey:"spectrum.recent_bgs",preferredFormat:"hex",chooseText:"Ok",showInput:!0,allowEmpty:!0,show:function(){n=e(".sp-container:visible")},change:function(e){var n=e.toRgbString();t.model.set_property("background",n,!0),r=n},move:function(e){var r=e.toRgbString();n.find(".sp-dragger").css("border-top-color",r),n.parent().find(".sp-dragger").css("border-right-color",r),t.parent_view.for_view.$el.find(".wp-caption").css("background-color",r)},hide:function(){t.parent_view.for_view.$el.find(".wp-caption").css("background-color",r)}}),s.find(".sp-replacer").css("display","inline-block"),t.toggleColorPicker()})},toggleColorPicker:function(){var e=this.$(".ugallery-colorpicker-setting"),t=e.find("input:checked").val(),n=e.find(".sp-replacer");t=="1"?(n.show(),this.parent_view&&this.parent_view.for_view.$el.find(".wp-caption").css("background-color",this.model.get_property_value_by_name("background"))):(n.hide(),this.parent_view&&this.parent_view.for_view.$el.find(".wp-caption").css("background-color","transparent"))},get_label:function(){return"Settings"},get_title:function(){return!1}}),c=Upfront.Views.Editor.Settings.Item.extend({className:"ugallery-colorpicker-setting"}),h=Backbone.View.extend({id:"upfront-image-edit",rotation:0,mode:"big",invert:!1,tpl:_.template(e(n).find("#editor-tpl").html()),src:"#",bordersWidth:0,response:!1,fullSize:{width:0,height:0},buttons:[],sizes:!1,events:{"click #image-edit-button-ok":"imageOk","click #image-edit-button-reset":"image100","click #image-edit-button-fit":"fitImage","click #image-edit-button-align":"selectAlign","click .image-edit-rotate":"rotate","click .image-fit-element-button":"fitMask","click #image-edit-button-swap":"changeImage","mouseover a.image-edit-button":"showTooltip","mouseout a.image-edit-button":"hideTooltip"},initialize:function(){var e=this;this.$el.on("click",function(t){t.target==t.currentTarget&&(e.saveOnClose?e.imageOk():e.isResizing||e.cancel()),e.isResizing=!1})},resetDefaults:function(){this.rotation=0,this.mode="big",this.invert=!1,this.src="#",this.fullSize={width:0,height:0},this.setImageInitialSize=!1,this.buttons=[{id:"image-edit-button-fit",text:"Fit to Element",tooltip:"Adapt to the mask"},{id:"image-edit-button-reset",text:"IMG 100%",tooltip:"Expand image"},{id:"image-edit-button-ok",text:"Ok",tooltip:"Save image"}],this.sizes=!1,this.align="left",this.saveOnClose=!1,this.elementSize=!1,this.fitImageButton=!0},centerImageOffset:function(e,t){return{top:-(e.height-t.height)/2,left:-(e.width-t.width)/2}},open:function(t){this.resetDefaults(),this.options=t,this.src=t.src,this.saveOnClose=t.saveOnClose,t.maskOffset.top+=this.fixImageTop(t.maskOffset),this.setOptions(t);var n=this.maybeResizeElement(t);if(n)return t.position={top:0,left:0},t.maskSize=n.maskSize,t.size=n.imageSize,t.setImageSize=!1,t.align="left",t.resizedElement=!0,this.open(t);this.options.editElement||(this.buttons=[{id:"image-edit-button-ok",text:"Ok",tooltip:"Save image"}]);var r=this.bordersWidth/2,i={top:parseInt(t.maskOffset.top)-r,left:parseInt(t.maskOffset.left)-r},s={width:parseInt(t.maskSize.width)+this.bordersWidth,height:parseInt(t.maskSize.height)+this.bordersWidth};t.position||(t.position=this.centerImageOffset(t.size,s));var o={top:parseInt(i.top)-t.position.top+r,left:parseInt(i.left)-t.position.left+r},u={width:parseInt(t.size.width),height:parseInt(t.size.height)};this.imageId=t.id,this.src=t.srcOriginal,this.fullSize=t.fullSize,t.align&&(this.align=t.align);if(this.setImageInitialSize){var a=this.getFullWidthImage();u=a.size,o.left=a.left}else t.imageFit&&(u=this.initialImageSize(0,!1,s));var f={size:u,offset:o,maskOffset:i,rotation:"rotate_"+this.rotation,src:this.src,maskSize:s,buttons:this.buttons,fitMask:t.fitMaskColumns};return this.$el.html(this.tpl(f)).find("div").hide(),this.$el.closest("body").length||(this.response=e.Deferred(),e("body").append(this.$el)),this.addGridLines(i.top,s.height),this.$el.css({height:e(document).height(),width:e(document).width()}).find("div").fadeIn(200),this.selectMode(u),this.startEditorUI(),this.selectMode(u,!0),this.setImageSize(u),this.$("#image-edit-button-align").addClass("align-"+this.align),this.setImageInitialSize&&this.resetImage(!1,!1),t.editElement&&this.check100ButtonActivation(),this.response.promise()},setOptions:function(e){var t=this;typeof e.rotation!="undefined"?this.setRotation(e.rotation):this.setRotation(0),e.setImageSize&&(this.setImageInitialSize=!0),e.extraButtons&&e.extraButtons.length&&_.each(e.extraButtons,function(e){t.buttons.push({id:e.id,text:e.text}),t.$el.off("click","#"+e.id).on("click","#"+e.id,function(n){e.callback(n,t)})}),this.element_id=e.element_id||!1},check100ButtonActivation:function(){var e=this.getFullWidthImage(this.options.fullSize).size,t=this.getCurrentImageRowsCols(e.width,e.height),n=this.$("#image-edit-button-reset");this.elementSize.columns==t.columns&&this.elementSize.rows==t.rows?n.addClass("deactivated expanded").attr("data-tooltip","The image is completely expanded"):this.elementSize.columns==this.elementSize.maxColumns&&this.elementSize.columns<t.columns&&this.elementSize.rows==t.rows&&n.addClass("deactivated").attr("data-tooltip","Can't expand the image")},maybeResizeElement:function(e,t){if(!e.editElement)return!1;var n=e.editElement,r={maxColumns:n.get_element_max_columns(),maxRows:n.get_element_max_rows(),rowHeight:15};r.maxRows||(r.maxRows=n.get_element_rows()),r.columnWidth=n.get_element_max_columns_px()/r.maxColumns,r.rows=Math.round(e.maskSize.height/15)+2,r.columns=Math.ceil(e.maskSize.width/r.columnWidth),this.elementSize=r;if(!e.setImageSize)return!1;var i=this.getFullWidthImage(e.fullSize).size,s=this.getCurrentImageRowsCols(i.width,i.height),o={width:s.columns*this.elementSize.columnWidth-30,height:(s.rows-2)*this.elementSize.rowHeight};if(s.columns>r.columns||s.rows>r.rows)return!1;if(!t)o={width:Math.min(s.columns,r.columns)*r.columnWidth-30,height:(Math.min(s.rows,r.rows)-2)*15};else if(this.elementSize.maxColumns<s.columns){var u=i.height/i.width,a=this.elementSize.maxColumns*this.elementSize.columnWidth-30;o={width:a,height:i.height}}return{maskSize:o,imageSize:i}},imageOk:function(){var e=this.getEditorResults(),t=this,n=new Upfront.Views.Editor.Loading({loading:"Saving image...",done:"Here we are",fixed:!1}),r=this.$("#uimage-mask");e.imageId&&(n.render(),r.append(n.$el),this.saveImageEdition(e.imageId,e.rotation,e.imageSize,{top:e.imageOffset.top,left:e.imageOffset.left,width:e.maskSize.width,height:e.maskSize.height}).done(function(r){var i=r.data.images[e.imageId];n.done();if(i.error){console.error(i.msg);return}e.src=i.url,e.srcFull=i.urlOriginal,e.cropSize=i.crop,t.options.resizedElement&&(e.elementSize=t.getCurrentMaskRowsCols()),t.response.resolve(e),t.close()}).error(function(e){console.log(e)}))},close:function(e){var t=this;this.unfixImageTop(),this.$("div").fadeOut(200,function(){t.$el.detach()}),this.options=!1,t.response.reject({reason:e,id:this.imageId})},cancel:function(e){this.close(e)},changeImage:function(e){e.preventDefault(),this.close("changeImage")},getEditorResults:function(){var e=this.$("#uimage-canvas"),t=e.find("img"),n=this.$("#uimage-mask"),r=t.attr("src"),i=this.bordersWidth/2;return{imageSize:{width:Math.round(this.invert?t.height():t.width()),height:Math.round(this.invert?t.width():t.height())},imageOffset:{top:n.offset().top-e.offset().top+i,left:n.offset().left-e.offset().left+i},maskSize:{width:n.width(),height:n.height()},rotation:this.rotation,imageId:this.imageId,fullSize:this.fullSize,srcOriginal:r,align:this.align,stretch:this.mode=="big"||this.mode=="horizontal",vstretch:this.mode=="big"||this.mode=="vertical",mode:this.mode}},rotate:function(t){var n=this.rotation,r=this.$(".uimage-img"),i="",s={width:r.width(),height:r.height()},o=this.$("#uimage-canvas"),u=this.$("#uimage-drag-handle");t&&(t.preventDefault(),t.stopPropagation()),n=n==270?0:n+90,n&&(i="rotate_"+n),r.removeClass().addClass("uimage-img "+i),this.setRotation(n),this.invert?(o.css({height:s.width,width:s.height}),u.css({height:s.width,width:s.height}),r.css({height:s.height,width:s.width})):(o.css(s),u.css(s),r.css({height:"100%",width:"100%"})),r.css(this.imgOffset({width:r.width(),height:r.height()})),this.selectMode({width:o.width(),height:o.height()}),e("#uimage-drag-handle").draggable("option","containment",this.getContainment()),this.setResizingLimits()},setRotation:function(e){this.rotation=e,this.invert=[90,270].indexOf(e)!=-1},imgOffset:function(e){return this.invert?{top:Math.floor((e.width-e.height)/2),left:Math.floor((e.height-e.width)/2)}:{top:0,left:0}},startEditorUI:function(){var t=this,n=this.$("#uimage-canvas");e("#uimage-drag-handle").resizable({handles:{se:e(".image-edit-resize i")},autoHide:0,aspectRatio:!0,start:function(){t.$("#image-edit-button-reset").attr("class","image-edit-button").attr("data-tooltip","Expand image"),t.isResizing=!0},resize:function(e,r){n.css(r.size),t.setImageSize(r.size)},stop:function(r,i){var s=t.$("#uimage-drag-handle");r.preventDefault();var o={width:t.invert?i.size.height:i.size.width,height:t.invert?i.size.width:i.size.height},u=t.fullSize.width/Math.floor(o.width),a;o={width:Math.floor(o.width),height:Math.round(t.fullSize.height/u)},a={width:t.invert?o.height:o.width,height:t.invert?o.width:o.height},n.css(a),s.css(a),t.selectMode(a,!0),t.setImageSize(a),(t.mode=="small"||t.mode=="vertical")&&t.centerImage(!1),e("#uimage-drag-handle").draggable("option","containment",t.getContainment())}}).draggable({opacity:1,start:function(e,t){},drag:function(e,t){n.css({top:t.position.top,left:t.position.left})},stop:function(e,r){n.css({top:r.position.top,left:r.position.left}),t.setResizingLimits()},containment:t.getContainment()}),t.setResizingLimits()},addGridLines:function(e,t){var n=15,r=t-this.bordersWidth,i=this.bordersWidth/2;while(i<=r+n)this.$el.append('<div class="gridline" style="position: absolute;width: 100%; height: 0; top:'+(e+i)+'px"></div>'),i+=n},selectMode:function(e,t){var n="small",r=this.$("#uimage-mask"),i={width:r.width(),height:r.height()};e.width>=i.width?e.height>=i.height?n="big":n="horizontal":e.height>=i.height&&(n="vertical"),this.setMode(n,t)},setMode:function(t,n){var r=e("#uimage-drag-handle"),i=(t=="small"||t=="vertical")&&t!=this.mode;this.$el.removeClass("uimage-mode-big uimage-mode-small uimage-mode-vertical uimage-mode-horizontal uimage-mode-tiny").addClass("uimage-mode-"+t),(r.width()<40||r.height()<40)&&this.$el.addClass("uimage-mode-tiny"),this.mode=t,n&&(this.mode=="horizontal"||this.mode=="small"?r.draggable("option",{snap:".gridline",snapMode:"outer",snapTolerance:6}):r.draggable("option",{snap:!1})),i&&this.centerImage(!1)},setImageSize:function(e){if(this.invert){var t={width:e.height,height:e.width};this.$(".uimage-img").css(t).css(this.imgOffset(t))}},getContainment:function(){var e=this.$("#uimage-canvas"),t=this.$("#uimage-mask"),n=t.offset(),r=this.bordersWidth/2;if(this.mode=="big")return[n.left-e.width()+t.width()+r,n.top-e.height()+t.height()+r,n.left+r,n.top+r];if(this.mode=="horizontal")return[n.left-e.width()+t.width()+r,n.top,n.left+r,n.top-e.height()+t.height()];var i=this.align=="left"?n.left:this.align=="right"?n.left+t.width()-e.width():n.left+(t.width()-e.width())/2;return i+=r,this.mode=="vertical"?[i,n.top-e.height()+t.height()+r,i,n.top+r]:[i,n.top,i,n.top-e.height()+t.height()]},setResizingLimits:function(){var t=this.$("#uimage-canvas"),n=this.$("#uimage-mask"),r=n.offset(),i={minWidth:15,minHeight:15};this.mode=="big"&&(i={minWidth:n.width()+r.left-t.offset().left+this.bordersWidth,minHeight:n.height()+r.top-t.offset().top+this.bordersWidth}),e("#uimage-drag-handle").resizable("option",i)},resetImage:function(e,t){e&&(e.preventDefault(),e.stopPropagation()),this.setRotation(270),this.rotate(),this.setImageFullSize(e,t),this.centerImage(!0)},image100:function(t){if(e(t.target).hasClass("deactivated")){if(e(t.target).hasClass("expanded"))return;return this.showExpandAlert()}var n=this.getFullWidthImage().size,r=this.getCurrentImageRowsCols(n.width,n.height),i=r;if(this.elementSize.maxColumns<r.columns){var s=n.height/n.width,o=this.elementSize.maxColumns*this.elementSize.columnWidth-30,u=n.height;i={columns:this.elementSize.maxColumns,rows:Math.ceil(u/this.elementSize.rowHeight)+2}}if(i.columns!=this.elementSize.columns||i.rows!=this.elementSize.rows)this.resizeMask(i.columns,i.rows);else{var a=this.$("#uimage-mask").offset();n.top=a.top,n.left=a.left,this.$("#uimage-canvas").css(n),this.$("#uimage-drag-handle").css(n)}i.columns!=22&&r.columns>i.columns&&this.showExpandAlert()},getCurrentImageRowsCols:function(e,t){var n=this.$("#uimage-canvas"),r=e?e:n.width(),i=t?t:n.height();return{rows:Math.ceil(i/this.elementSize.rowHeight)+2,columns:Math.ceil((r+30)/this.elementSize.columnWidth)}},getCurrentMaskRowsCols:function(){var e=this.$("#uimage-mask");return this.getCurrentImageRowsCols(e.width(),e.height())},showExpandAlert:function(){if(this.ignoreFullwidthAlert)return;var t=this;Upfront.Popup.open(function(){},{width:320}).progress(function(n){n=="before_close"&&(t.ignoreFullwidthAlert=e("#upfront-popup-content").find("input:checked").length)}),e("#upfront-popup-content").append(e(n).find("#fullwidth-alert-tpl").html())},resizeMask:function(e,t){var n=this.options;n.maskSize={width:this.elementSize.columnWidth*e-30,height:this.elementSize.rowHeight*(t-2)},n.size=this.getFullWidthImage().size,n.position={left:0,top:0},n.setImageSize=!1,n.resizedElement=!0,this.open(n)},fitImage:function(t){t.preventDefault(),t.stopPropagation();if(!this.fitImageButton){var n=e("#image-edit-button-fit");return n.text("Fit to Element"),this.fitImageButton=!0,this.resetImage()}var r=this.$("#uimage-canvas"),i=this.$("#uimage-mask"),s=this.$("#uimage-drag-handle"),o=this.getResizeImageDimensions(this.fullSize,{width:i.width(),height:i.height()},"inner",0);this.invert&&(o={width:o.height,height:o.width}),r.css(o),s.css(o),this.setImageSize(o),this.centerImage(!0),this.selectMode(o,!0),this.centerImage(!0),this.setResizingLimits(),e("#uimage-drag-handle").draggable("option","containment",this.getContainment()),e("#image-edit-button-fit").attr("data-tooltip","Restore image size").text("Reset image size"),e("#image-edit-button-reset").attr("class","image-edit-button").attr("data-tooltip","Expand image"),this.fitImageButton=!1},fitMask:function(){var t=e("#uimage-canvas"),n=e("#uimage-mask"),r=Math.round((n.width()+30)/this.options.fitMaskColumns),i=this.bordersWidth/2,s={width:t.width(),height:t.height()},o=15,u=Math.ceil((s.width+30)/r),a={height:Math.ceil(s.height/o)*o,width:u*r-30},f=this.options;f.position={top:0,left:0},f.size=s,f.maskSize=a,f.align="left",f.setImageSize=!1,f.rotation=this.rotation,f.elementColumns=u,this.open(f),console.log(s)},setImageFullSize:function(t,n){t&&t.preventDefault();var r=this.$(".uimage-img"),i=this.$("#uimage-mask"),s=this.$("#uimage-canvas"),o=this.$("#uimage-drag-handle"),u=this.initialImageSize(100,!1,{width:i.width(),height:i.height()});s.css(u),o.css(u),r.css({height:"100%",width:"100%"}),this.selectMode(u,!0),this.setResizingLimits(),e("#uimage-drag-handle").draggable("option","containment",this.getContainment())},centerImage:function(e){var t=this.$("#uimage-canvas"),n=this.$("#uimage-mask"),r=this.$("#uimage-drag-handle"),i=this.bordersWidth/2,s={top:t.offset().top};e&&(s.top=n.offset().top-(t.height()-n.height())/2+i),this.mode!="vertical"&&this.mode!="small"||this.align=="center"?s.left=n.offset().left-(t.width()-n.width())/2:this.align=="left"?s.left=n.offset().left:s.left=n.offset().left+n.width()-t.width(),s.left+=i,t.css(s),r.css(s)},getFullWidthImage:function(t){var n=e(document.querySelector(".upfront-grid-layout")),r=n.width()-30,i=n.css("max-width"),s=t||this.fullSize;return s.width>r&&(s={width:r,height:Math.round(s.height/(s.width/r))}),{size:s,left:n.offset().left+15}},initialImageSize:function(e,t,n){var r=this.$("#uimage-mask"),i={width:0,height:0},s=n?n:{width:r.width(),height:r.height()},o,u,a,f=!!t;return e=e?e:0,o=s.width/s.height<this.fullSize.width/this.fullSize.height?"height":"width",a=this.invert?o=="width"?"height":"width":o,u=this.fullSize[o]/(s[a]+e),!f&&u<1?i=this.fullSize:i={width:Math.ceil(this.fullSize.width/u),height:Math.ceil(this.fullSize.height/u)},i},getResizeImageDimensions:function(e,t,n,r){var i=e.width/e.height,s=t.width/t.height,o=n&&n=="outer"?"outer":"inner",u=o=="inner"?i>s?"width":"height":i>s?"height":"width",a=r||0,f=t[u]+a,l=f/e[u];return{width:Math.round(e.width*l),height:Math.round(e.height*l)}},getImageData:function(e,t,n){var r=this,i={action:"upfront-media-image_sizes",item_id:JSON.stringify(e),element_id:n};return t&&(i.customSize=t),Upfront.Util.post(i)},saveImageEdition:function(e,t,n,r){var i=this,s={action:"upfront-media-image-create-size",images:[{element_id:this.element_id,id:e,rotate:t,resize:n,crop:r}]};return Upfront.Util.post(s)},selectAlign:function(){this.align=="left"?this.setAlign("center"):this.align=="center"?this.setAlign("right"):this.align=="right"&&this.setAlign("left")},setAlign:function(e){var t=this.$("#uimage-mask"),n=this.$("#uimage-canvas"),r=this.$("#uimage-drag-handle"),i=n.position();this.$("#image-edit-button-align").removeClass("align-left align-right align-center").addClass("align-"+e);if(e!="left"&&e!="center"&&e!="right")return!1;this.align=e,this.align=="center"?i.left=t.offset().left-(n.width()-t.width())/2:this.align=="left"?i.left=t.offset().left:i.left=t.offset().left+t.width()-n.width(),i.left+=this.bordersWidth/2,n.css(i),r.css(i),this.$("#uimage-drag-handle").draggable("option","containment",this.getContainment())},showTooltip:function(t){var n=e(t.target),r=this.$("#uimage-tooltip").text(n.attr("data-tooltip")).show();r.css({top:n.offset().top-Math.round(1.5*r.height()),left:n.offset().left+n.width()/2-r.width()/2+5})},hideTooltip:function(e){this.$("#uimage-tooltip").hide()},keyMove:function(e){switch(e.which){case 40:this.maskOffset.top--,this.positionEditorElements();break;case 39:this.maskOffset.left--,this.positionEditorElements();break;case 37:this.maskOffset.left++,this.positionEditorElements();break;case 38:this.maskOffset.top++,this.positionEditorElements()}},fixImageTop:function(t){if(t&&typeof t.top!="undefined"&&t.top<120){var n=e("body").css("marginTop");n=parseInt(n.replace("px",""),10);if(!isNaN(n))return this.fixTop=120-t.top,e("body").css("marginTop",n+this.fixTop),this.fixTop}return 0},unfixImageTop:function(){if(this.fixTop){var t=e("body").css("marginTop");t=parseInt(t.replace("px",""),10),isNaN(t)||e("body").css("marginTop",t-this.fixTop),this.fixTop=0}}}),p=Backbone.View.extend({selectorTpl:_.template(e(n).find("#selector-tpl").html()),progressTpl:_.template(e(n).find("#progress-tpl").html()),formTpl:_.template(e(n).find("#upload-form-tpl").html()),deferred:!1,defaultOptions:{multiple:!1,preparingText:"Preparing image"},options:{},initialize:function(){var t=this;e("#upfront-upload-image").length||(e("body").append(t.formTpl({url:Upfront.Settings.ajax_url})),e("#upfront-image-file-input").on("change",function(e){if(this.files.length){var n=this.files[0].size;n>2048e3?confirm("You are trying to upload a file bigger than 2MB. It will take long time. Are you sure?")&&t.openProgress(function(){t.uploadImage()}):t.openProgress(function(){t.uploadImage()})}}))},open:function(t){var n=this;return this.deferred=e.Deferred(),_.isObject(t)||(t={}),this.options=_.extend({},this.defaultOptions,t),this.openSelector(),Upfront.Events.trigger("upfront:element:edit:start","media-upload"),this.deferred.promise()},openSelector:function(){var t=this;this.openOverlaySection(this.selectorTpl,{},function(n){e("#upront-image-placeholder").on("dragenter",function(e){e.preventDefault(),e.stopPropagation()}).on("dragleave",function(t){t.preventDefault(),t.stopPropagation(),e(this).css("border-color","#C3DCF1"),e(this).css("background","none")}).on("dragover",function(t){t.preventDefault(),t.stopPropagation(),e(this).css("border-color","#1fcd8f"),e(this).css("background","rgba(255,255,255,.1)"),e(this).find()}).on("drop",function(t){t.preventDefault(),t.stopPropagation();if(t.originalEvent.dataTransfer){var n=t.originalEvent.dataTransfer.files,r=e("#upfront-image-file-input");n.length&&r.length&&(r[0].files=n)}}),t.resizeOverlay()})},openProgress:function(e){var t=this;this.openOverlaySection(this.progressTpl,{},function(){t.resizeOverlay(),e()})},resizeOverlay:function(){var t=e("#upfront-image-overlay");if(!t.length)return;var n=e("#upront-image-placeholder"),r=e("#upfront-image-uploading"),i={},s=e("#sidebar-ui").width(),o={left:s,width:e(window).width()-s,height:e(window).height()},u=o.height/2-220;u>0?(t.removeClass("small_placeholder"),u+="px"):(t.addClass("small_placeholder"),u=o.height/2-140+"px"),t.css(o),i={height:o.height-100,"padding-top":u},n.css(i),r.css(i)},close:function(){this.closeOverlay()},cancelOverlay:function(e){e.target==e.currentTarget&&this.closeOverlay(e)},closeOverlay:function(t){var n=this;e("#upfront-image-overlay").off("click").fadeOut("fast",function(){e(this).remove(),e("#upfront-image-overlay").remove()}),e("html").css({overflow:this.bodyOverflow?this.bodyOverflow:"auto",height:"auto",width:"auto"}),e("body").removeClass("upfront-image-upload-open"),this.reopenSettings&&(e("#settings").fadeIn(),this.reopenSettings=!1),e(window).off("resize",this.resizeOverlay),Upfront.Events.trigger("upfront:element:edit:stop")},openOverlaySection:function(t,n,r){var i=this,s=e("#settings"),o=e("#upfront-image-overlay");if(o.length){e(".upfront-image-section").fadeOut("fast",function(){var i=e(t(n)).hide();o.append(i),i.fadeIn("fast"),e(this).remove(),r&&r(o)});return}this.bodyOverflow=e("html").css("overflow"),e("html").css({overflow:"hidden",width:e(window).width()+"px",height:e(window).height()+"px"}),o=e('<div id="upfront-image-overlay"></div>').append(t(n)).hide(),e("body").append(o).addClass("upfront-image-upload-open"),this.setOverlayEvents(),o.fadeIn("fast"),this.resizeOverlay(),e(window).on("resize",function(e){e.target==window&&i.resizeOverlay()}),s.is(":visible")&&(s.fadeOut(),this.reopenSettings=!0),r&&r(o)},setOverlayEvents:function(){var t=this;e("#upfront-image-overlay").on("click",function(e){t.cancelOverlay(e)}).on("click","a.select-files",function(e){t.openFileBrowser(e)}).on("click","a.image-edit-change",function(e){t.openImageSelector(e)}).on("click","a.open-media-gallery",function(e){t.openMediaGallery(e)})},openMediaGallery:function(t){var n=this;t.preventDefault(),Upfront.Media.Manager.open({multiple_selection:this.options.multiple,media_type:["images"]}).done(function(t,r){if(r&&r.length>0){var i=[];r.each(function(e){i.push(e.get("ID"))}),Upfront.Views.Editor.ImageEditor.getImageData(i,n.options.customImageSize,n.options.element_id).done(function(e){n.deferred.resolve(e.data.images,e)}),n.openProgress(function(){e("#upfront-image-uploading h2").html(n.options.preparingText)})}})},openFileBrowser:function(t){t.preventDefault(),console.log("clicking"),e("#upfront-image-file-input").click()},checkFileUpdate:function(e){return console.log("here we are"),!0},uploadImage:function(t){t&&t.preventDefault();var n=this,r=e("#upfront-progress"),i=e("#upfront-image-file-input"),s=e("#upfront-upload-image");s.ajaxSubmit({beforeSend:function(){r.css("width","0")},uploadProgress:function(e,t,n,i){r.css("width",i+"%"),console.log(i)},complete:function(){e("#upfront-image-uploading h2").html("Preparing Image")},success:function(e){r.css("width","100%"),console.log(e),Upfront.Views.Editor.ImageEditor.getImageData(e.data,n.options.customImageSize).done(function(e){n.deferred.resolve(e.data.images,e)}).error(function(){Upfront.Views.Editor.notify("There was an error uploading the file. Please try again.","error"),n.openSelector()}),s[0].reset()},error:function(e){Upfront.Views.Editor.notify(e.responseJSON.error,"error"),n.openSelector(),s[0].reset()},dataType:"json"})}}),d=Upfront.Views.Editor.InlinePanels.Item.extend({events:{click:"clicked"},clicked:function(e){e.preventDefault(),this.$el.siblings(".upfront-inline-panel-subitem-active").removeClass("upfront-inline-panel-subitem-active"),this.trigger("click",e)}}),v=d.extend({events:{click:"onClickControl","click .upfront-inline-panel-item":"selectItem"},onClickControl:function(e){e.preventDefault(),this.clicked(e),this.$el.toggleClass("open")},render:function(){Upfront.Views.Editor.InlinePanels.Item.prototype.render.call(this,arguments);var t=this.$(".uimage-control-tooltip"),n=this;this.$el.hasClass("uimage-control-tooltip-item")||this.$el.addClass("uimage-control-tooltip-item"),t.length||(t=e('<div class="uimage-control-tooltip"></div>'),this.$el.append(t)),t.html('<div class="uimage-control-tooltip-tip"></div>'),_.each(this.sub_items,function(e,r){r!=n.selected&&(e.render(),t.append(e.$el))}),this.$(".upfront-icon-region-caption").addClass("upfront-icon-region-"+this.selected)},get_selected_item:function(){return this.selected},selectItem:function(t){var n=!1,r=e(t.target).is("i")?e(t.target):e(t.target).find("i");_.each(this.sub_items,function(e,t){r.hasClass("upfront-icon-region-"+e.icon)&&(n=t)}),n&&(this.selected=n,this.render(),this.trigger("select",n))}}),m=Upfront.Views.Editor.InlinePanels.ItemMulti.extend({events:{click:"clicked","click .upfront-inline-panel-item":"selectItem"},render:function(){Upfront.Views.Editor.InlinePanels.ItemMulti.prototype.render.call(this,arguments)},clicked:function(e){this.trigger("click",e),this.toggle_subitem()},get_selected_item:function(){return this.selected},selectItem:function(t){var n=!1,r=e(t.target).is("i")?e(t.target):e(t.target).find("i");_.each(this.sub_items,function(e,t){r.hasClass("upfront-icon-region-"+e.icon)&&(n=t)}),n&&(this.selected=n,this.render(),this.trigger("select",n))}}),g=m.extend({collapsed:!0,render:function(){if(!this.sub_items.collapsedControl){var e=new d;e.icon="collapsedControl",e.tooltip="More tools",this.sub_items.collapsedControl=e}this.selected="collapsedControl",this.constructor.__super__.render.call(this,arguments)},selectItem:function(t){var n=!1,r=!1,i=e(t.target).is("i")?e(t.target):e(t.target).find("i");_.each(this.sub_items,function(e,t){i.hasClass("upfront-icon-region-"+e.icon)&&(n=e,r=t)});if(n){if(n instanceof m)return!1;this.render(),this.trigger("select",r)}},open_subitem:function(){_.each(this.sub_items,function(e,t){e instanceof m&&e.close_subitem()}),this.constructor.__super__.open_subitem.call(this,arguments)}}),y=Upfront.Views.Editor.InlinePanels.Panel.extend({setWidth:function(e){var t=40,n=this.items._wrapped,r=!!n.collapsed;if(!r&&n.length>3&&e<n.length*t){var i=n.slice(1,n.length-1),s=new g;_.each(i,function(e){s.sub_items[e.icon]=e}),s.icon="collapsedControl",s.tooltip="More tools",s.position="left",this.items=_([n[0],s,n[n.length-1]]);return}if(r){var o=2+n[1].sub_items.length;if(o*t<=e){var u=[n[0]],a=n[1].subitems;_.each(a,function(e){u.push(e)}),u.push(n[2]),this.items=u}}}}),b=Upfront.Views.ContextMenuList.extend({initialize:function(){this.constructor.__super__.initialize.call(this,arguments);var e=this,t=[new Upfront.Views.ContextMenuItem({get_label:function(){return e.for_view.$el.find("div.upfront-image-container > img").length>0?"Edit Image":"Add Image"},action:function(){e.for_view.$el.find("div.upfront-image-container > img").length>0?e.for_view.editRequest():e.for_view.openImageSelector()}})];this.for_view.$el.find("div.upfront-image-container > img").length>0&&t.push(new Upfront.Views.ContextMenuItem({get_label:function(){return e.for_view.$el.find("div.upfront-image-container div.wp-caption").length>0?"Edit Caption":"Add Caption"},action:function(){e.for_view.$el.find("div.upfront-image-container > div.wp-caption").length>0?e.for_view.$el.find("div.upfront-image-container > div.wp-caption").data("ueditor").start():(e.for_view.controls.items.value()[2].selected="topOver",e.for_view.controls.items.value()[2].trigger("select"),e.for_view.property("include_image_caption",[1]),e.for_view.property("caption_position","over_image"),e.for_view.property("caption_alignment","top"),e.for_view.render())}})),this.menuitems=_(t)}}),w=Upfront.Views.ContextMenu.extend({initialize:function(){this.constructor.__super__.initialize.call(this,arguments),this.menulists=_([new b({for_view:this.for_view})])}});Upfront.Views.Editor.InlinePanels.MultiControl=m,Upfront.Views.Editor.InlinePanels.Control=d,Upfront.Views.Editor.InlinePanels.ControlPanel=y,Upfront.Views.Editor.InlinePanels.TooltipControl=v,Upfront.Application.LayoutEditor.add_object("Uimage",{Model:o,View:u,Element:a,Settings:f,ContextMenu:w}),Upfront.Views.Editor.ImageEditor=new h,Upfront.Views.Editor.ImageSelector=new p,Upfront.Models.UimageModel=o,Upfront.Views.UimageView=u})}(jQuery),function(e){define("upfront-like-box",[],function(){var e=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(Upfront.data.ulikebox.defaults);e.element_id=Upfront.Util.get_unique_id(e.id_slug+"-object"),this.init_properties(e)}}),t=Upfront.Views.ObjectView.extend({model:e,elementSize:{width:0,height:0},initialize:function(t){this.model instanceof e||(this.model=new e({properties:this.model.get("properties")})),this.constructor.__super__.initialize.call(this,[t]),Upfront.Events.on("entity:resize_start",this.hideFrame,this),Upfront.Events.on("entity:resize_stop",this.onElementResize,this)},setUrl:function(){this.property("facebook_url",Upfront.data.social.panel.model.get_property_value_by_name("global_social_media_services-facebook-url"))},hideFrame:function(e,t){this.$el.find("iframe").css("display","none")},onElementResize:function(e,t){this.parent_module_view==e&&this.setElementSize()},setElementSize:function(){var e=this,t=this.parent_module_view.$(".upfront-editable_entity:first");if(t.length&&t.height()){this.elementSize.height=t.height();var n=e.get_element_size_px(!1);n.col!=0&&e.property("element_size",{width:n.col,height:n.row})}},property:function(e,t){return typeof t!="undefined"?this.model.set_property(e,t):this.model.get_property_value_by_name(e)},events:function(){return _.extend({},Upfront.Views.ObjectView.prototype.events,{"click a.back_global_settings":"backToGlobalSettings"})},backToGlobalSettings:function(e){e.preventDefault(),Upfront.data.social.panel.popupFunc()},getGlobalFBUrl:function(){if(!Upfront.data.usocial.globals)return!1;var e=Upfront.data.usocial.globals.services,t=!1;return _(e).each(function(e){e.id=="facebook"&&(t=e.url)}),t},get_content_markup:function(){var e=this,t=this.model.get_property_value_by_name("facebook_url");if(!t||t=="")t=this.getGlobalFBUrl();if(t){var n=_.last(t.split("/"));return'<iframe src="//www.facebook.com/plugins/likebox.php?href=https%3A%2F%2Fwww.facebook.com%2F'+(n?n:"wpmudev")+"&amp;width="+this.model.get_property_value_by_name("element_size").width+"&amp;height="+this.model.get_property_value_by_name("element_size").height+'&amp;show_faces=true&amp;colorscheme=light&amp;stream=false&amp;show_border=true&amp;header=false" scrolling="no" frameborder="0" style="border:none; overflow:hidden; float:left; height:'+this.model.get_property_value_by_name("element_size").height+'px;" allowTransparency="true"></iframe>'+(n?"":'<span class="alert-url">!</span>')}return'You need to set a Facebook URL in your <a class="back_global_settings" href="#">global social settings</a>.'}}),n=Upfront.Views.Editor.Sidebar.Element.extend({priority:70,render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-likebox"),this.$el.html("Like Box")},add_element:function(){var t=new e,n=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c7 upfront-like-box_module"},{name:"has_settings",value:0},{name:"row",value:6}],objects:[t]});this.add_module(n)}}),r=Upfront.Views.Editor.Field.Text.extend({}),i=Upfront.Views.Editor.Field.Field.extend({events:{"click a":"buttonClicked"},render:function(){this.$el.html(this.get_field_html())},get_field_html:function(){return'<i class="upfront-field-icon upfront-field-icon-social-back"></i><span class="upfront-back-global-settings-info">'+this.options.info+' <a href="#">'+this.options.label+"</a></span>"},buttonClicked:function(e){this.options.on_click&&this.options.on_click(e)},isProperty:!1}),s=Upfront.Views.Editor.Settings.Settings.extend({getGlobalFBUrl:function(){if(!Upfront.data.usocial.globals)return!1;var e=Upfront.data.usocial.globals.services,t=!1;return _(e).each(function(e){e.id=="facebook"&&(t=e.url)}),t},initialize:function(){this.panel=new Upfront.Views.Editor.Settings.Panel({model:this.model,label:"Layout Style",title:"Layout Style settings",settings:[new Upfront.Views.Editor.Settings.Item({className:"upfront-social-services-item",model:this.model,title:"Your Facebook Page URL",fields:[new r({model:this.model,property:"facebook_url",default_value:this.getGlobalFBUrl(),label:"https://www.facebook.com/YourPage",compact:!0})]}),new Upfront.Views.Editor.Settings.Item({className:"upfront-social-back",group:!1,fields:[new i({model:this.model,info:"Back to your",label:"global settings",on_click:function(e){e.preventDefault(),Upfront.Events.trigger("entity:settings:deactivate"),Upfront.data.social.panel.popupFunc()}})]})]}),this.panels=_([this.panel])},get_title:function(){return"LikeBox settings"}});Upfront.Application.LayoutEditor.add_object("LikeBox",{Model:e,View:t,Element:n,Settings:s}),Upfront.Models.LikeBoxModel=e,Upfront.Views.LikeBoxView=t})}(jQuery),define("text!elements/upfront-login/css/edit.css",[],function(){return".upfront_login-settings-panel .upfront-settings_panel {\n	width: 290px;\n}\n\n.upfront_login-fields-complex_boolean {\n	width: 48%;\n	float: left;\n}\n.upfront_login-fields-complex_boolean .upfront-field-wrap-radios {\n	float: left;\n}\n.upfront_login-fields-complex_boolean .upfront-field-wrap-text {\n	width: 80%;\n	float: left;\n}\n.upfront_login-fields-complex_boolean.upfront_login-appearance-icon {\n	width: 60%;\n}\n.upfront_login-fields-complex_boolean.upfront_login-appearance-icon .upfront-field-text {\n	width: 80%;\n}\n.upfront_login-fields-complex_boolean.upfront_login-appearance-label {\n	width: 40%;\n}\n.upfront_login-fields-complex_boolean.upfront_login-appearance-icon .upfront_login-icon {\n	float: left;\n	width: 85%;\n}\n.upfront_login-fields-complex_boolean.upfront_login-appearance-icon .upfront_login-icon input {\n	width: 80%;\n}\n\n.upfront_login-item-display_behavior .upfront-field-multiple {\n	max-width: 48%;\n	margin-right: 1%;\n	float: left;\n}"}),define("text!elements/upfront-login/css/public.css",[],function(){return'/* GENERAL FORM STYLE \n	 ================== */\n.upfront_login-form form input {\n	height:34px;\n	border:2px solid #c2dbf2;\n	background-color: #fff;\n	padding:0 10px;\n}\n.upfront_login-form form input:hover, .upfront_login-form form input:focus { \n	border-color: #aec4d8;\n	outline:none;\n}\n.upfront_login-form form input[type="submit"]{\n	border: 2px solid #269a47;\n	background-color: #2cad4a;\n	color: #fff;\n	width: 100%;\n	text-align: center;\n}\n.upfront_login-form form input[type="submit"]:hover {\n	background-color: #269a47;\n}\n.upfront_login-form form input[type="checkbox"]{\n	height:20px;\n	margin-bottom:15px;\n	position: relative;\n	top: 3px;\n}\n.upfront_login-form form label, .upfront_login-form p { color:#6486a6; }\n.upfront_login-form p { margin-bottom: 0; text-align: center; }\n.upfront_login-form p a { color:#39a678; }\n\n\n/* HOVER FORM \n	 ========== */\n\n.upfront_login.upfront_login-hover { position: relative; }\n.upfront_login.upfront_login-hover .upfront_login-form-wrapper{\n	 display: none; \n}\n.upfront_login.upfront_login-hover .upfront_login-form-wrapper { \n	position: absolute;\n	z-index: 1;\n	top:15px;\n	width:210px;\n	left:-50px;\n}\n.upfront_login.upfront_login-hover .upfront_login-form-wrapper {\n	display: none;\n}\n.upfront_login.upfront_login-hover:hover .upfront_login-form-wrapper{\n	display: block;\n}\n\n/* login panel styling */\n.upfront_login.upfront_login-hover .upfront_login-form {\n	position: relative;\n	display: block;\n	background-color: #fff;\n	border-radius: 3px;\n	cursor: default;\n	border:2px solid #aec4d8;\n	top:20px;\n	left:0;\n	padding:15px;\n	padding-bottom: 5px;\n}\n\n/* triangular tooltip */\n.upfront_login.upfront_login-hover:hover .upfront_login-form:before {\n	content:\'\';\n	display:inline-block;\n	width:10px;\n	height:10px;\n	background-color:#fff;\n	transform:rotate(45deg);\n	-webkit-transform:rotate(45deg);\n	border-top:2px solid #aec4d8;\n	border-left:2px solid #aec4d8;\n	position:absolute;\n	top:-7px;\n	left:25%;\n}\n.upfront_login.upfront_login-hover .upfront_login-form label { text-align: left; display: block; padding-left: 15px; }\n\n.upfront_login.upfront_login-hover:hover .upfront_login-trigger {\n	display: inline-block;\n}\n\n/* Click */\n.upfront_login.upfront_login-click .upfront_login-form form input[type="submit"]{\n	width: 70%;\n}\n.upfront_login.upfront_login-click .login-username, \n.upfront_login.upfront_login-click .login-password { margin-bottom: 15px; }\n.upfront_login.upfront_login-click .upfront_login-form {\n	display: none;\n}\n.upfront_login.upfront_login-click {\n	z-index: 0;\n}\n.upfront_login.upfront_login-click.active {\n	background: rgba(38,58,77,.8);\n	position: fixed;\n	top: 0; left: 0;\n	bottom: 0; right: 0;\n	z-index: 9;\n	padding-top: 5em;\n}\n.upfront_login.upfront_login-click.active .upfront_login-form {\n	display: block;\n	background: #fff;\n	z-index: 10;\n	width: 80%;\n	max-width: 350px;\n	margin: 0 auto;\n	padding: 2em;\n}\n.upfront_login.upfront_login-click.active .upfront_login-trigger {\n	display: none;\n}\n\n/* css animation */\n.upfront_login.upfront_login-hover .upfront_login-form{-webkit-animation-fill-mode:both;-moz-animation-fill-mode:both;-ms-animation-fill-mode:both;-o-animation-fill-mode:both;animation-fill-mode:both;-webkit-animation-duration:0.5s;-moz-animation-duration:0.5s;-ms-animation-duration:0.5s;-o-animation-duration:0.5s;animation-duration:0.5s;}\n@-webkit-keyframes fadeInDown {\n	0% {\n		opacity: 0;\n		-webkit-transform: translateY(-10px);\n	}	100% {\n		opacity: 1;\n		-webkit-transform: translateY(0);\n	}\n}\n\n@-moz-keyframes fadeInDown {\n	0% {\n		opacity: 0;\n		-moz-transform: translateY(-10px);\n	}\n	\n	100% {\n		opacity: 1;\n		-moz-transform: translateY(0);\n	}\n}\n\n@-o-keyframes fadeInDown {\n	0% {\n		opacity: 0;\n		-o-transform: translateY(-10px);\n	}\n	\n	100% {\n		opacity: 1;\n		-o-transform: translateY(0);\n	}\n}\n\n@keyframes fadeInDown {\n	0% {\n		opacity: 0;\n		transform: translateY(-10px);\n	}\n	\n	100% {\n		opacity: 1;\n		transform: translateY(0);\n	}\n}\n\n.fadeInDown, .upfront_login.upfront_login-hover:hover .upfront_login-form {\n	-webkit-animation-name: fadeInDown;\n	-moz-animation-name: fadeInDown;\n	-o-animation-name: fadeInDown;\n	animation-name: fadeInDown;\n}\n\n'}),function(e){define("upfront_login",["text!elements/upfront-login/css/edit.css","text!elements/upfront-login/css/public.css"],function(t,n){e("head").append("<style>"+t+"</style>"),e("head").append("<style>"+n+"</style>");var r=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(Upfront.data.upfront_login.defaults);e.element_id=Upfront.Util.get_unique_id(e.id_slug+"-object"),this.init_properties(e)}}),i=Upfront.Views.ObjectView.extend({markup:!1,initialize:function(){this.model instanceof r||(this.model=new r({properties:this.model.get("properties")})),Upfront.Views.ObjectView.prototype.initialize.call(this);var e=this;this.model.get("properties").on("change",function(t){if(!t||!t.get)return!0;"row"!=t.get("name")&&(e.markup=!1,e.render())})},render:function(){if(!this.markup){var e=this,t=Upfront.Util.model_to_json(this.model);Upfront.Util.post({action:"upfront-login_element-get_markup",properties:t.properties}).done(function(t){e.markup=t.data,Upfront.Views.ObjectView.prototype.render.call(e)})}Upfront.Views.ObjectView.prototype.render.call(this)},get_content_markup:function(){return this.markup?this.markup:"Please, hold on"}}),s=Upfront.Views.Editor.Field.Text.extend({className:"upfront-field-wrap upfront-field-wrap-appearance-icon-image",get_field_html:function(){return'<div class="upfront_login-icon"><img src="'+Upfront.data.upfront_login.root_url+'img/icon.png" />'+Upfront.Views.Editor.Field.Text.prototype.get_field_html.call(this)+"</div>"},get_saved_value:function(){var e=this.property?this.property.get("value"):this.model?this.model.get(this.name):"";return"icon"===e?"":e},get_value:function(){return this.$el.find("input").val()||"icon"}}),o=Upfront.Views.Editor.Settings.Item.extend({save_fields:function(){var e=this.model;this.fields.each(function(t){var n=t.get_value();_(n).each(function(t,n){if("appearance"==n&&!t)return!0;e.set_property(n,t)})})}}),u=Backbone.View.extend({className:"upfront_login-fields-complex_boolean clearfix",initialize:function(){var e=this.options.model,t=this.options.boolean_field.values||[];t.length||t.push({label:"",value:"1"}),this.options.field=new Upfront.Views.Editor.Field.Radios(_.extend(this.options.boolean_field,{model:e,mutiple:!1,values:t}))},render:function(){this.$el.empty(),this.options.subfield.render(),this.options.field.render(),this.$el.append(this.options.field.$el),this.$el.append(this.options.subfield.$el),this.options.additional_class&&this.$el.addClass(this.options.additional_class)},get_value:function(){var e={};return e[this.options.field.get_name()]=this.options.field.get_value(),e[this.options.subfield.get_name()]=this.options.subfield.get_value(),e}}),a=Upfront.Views.Editor.Settings.Settings.extend({initialize:function(){var e=new f({model:this.model});this.panels=_([e])},get_title:function(){return"Login settings"}}),f=Upfront.Views.Editor.Settings.Panel.extend({initialize:function(){var e=new c({model:this.model}),t=new l({model:this.model}),n=new h({model:this.model}),r=this;this.settings=_([e,t,n]),e.on("login:appearance:changed",t.update,t),e.on("login:appearance:changed",n.update,n),e.on("login:appearance:changed",function(){r.trigger("upfront:settings:panel:refresh",r)})},render:function(){Upfront.Views.Editor.Settings.Panel.prototype.render.call(this),this.$el.addClass("upfront_login-settings-panel"),this.settings.each(function(e){e.update&&e.update()})},get_label:function(){return"Display"},get_title:function(){return"Display"}}),l=Upfront.Views.Editor.Settings.Item.extend({events:function(){return _.extend({},Upfront.Views.Editor.Settings.Item.prototype.events,{click:"register_change"})},initialize:function(){var e=this.model.get_property_value_by_name("style"),t=!e||"popup"==e,n=[{label:"Show on hover",value:"hover",disabled:t},{label:"Show on click",value:"click"}];this.fields=_([new Upfront.Views.Editor.Field.Radios({model:this.model,property:"behavior",values:n})])},render:function(){Upfront.Views.Editor.Settings.Item.prototype.render.call(this),this.$el.addClass("upfront_login-item-display_behavior").find(".upfront-settings-item-content").addClass("clearfix").end().hide()},get_title:function(){return"Display behavior"},register_change:function(){this.fields.each(function(e){e.property.set({value:e.get_value()},{silent:!1})}),this.trigger("login:behavior:changed")},update:function(){var e=this.model.get_property_value_by_name("style");this.initialize(),this.$el.empty(),this.render(),"form"!=e&&this.$el.show()}}),c=o.extend({events:function(){return _.extend({},Upfront.Views.Editor.Settings.Item.prototype.events,{click:"register_change"})},initialize:function(){var e=[{label:"Form on page",value:"form"},{label:"Drop down form",value:"dropdown"},{label:"Form in lightbox",value:"popup"}];this.fields=_([new Upfront.Views.Editor.Field.Radios({model:this.model,property:"style",layout:"vertical",values:e})])},render:function(){Upfront.Views.Editor.Settings.Item.prototype.render.call(this),this.$el.find(".upfront-settings-item-content").addClass("clearfix")},get_title:function(){return"Display Appearance"},register_change:function(){this.fields.each(function(e){e.property.set({value:e.get_value()},{silent:!1})}),this.trigger("login:appearance:changed")}}),h=o.extend({initialize:function(){this.fields=_([new u({model:this.model,additional_class:"upfront_login-appearance-icon",boolean_field:{property:"appearance",values:[{label:"",value:"icon"}]},subfield:new s({model:this.model,property:"label_image"})}),new u({model:this.model,additional_class:"upfront_login-appearance-label",boolean_field:{property:"appearance",values:[{label:"",value:"label"}]},subfield:new Upfront.Views.Editor.Field.Text({model:this.model,property:"label_text"})})])},update:function(){var e=this.model.get_property_value_by_name("style");this.initialize(),this.$el.empty(),this.render(),"form"!=e&&this.$el.show()},render:function(){Upfront.Views.Editor.Settings.Item.prototype.render.call(this),this.$el.find(".upfront-settings-item-content").addClass("clearfix").end().hide()},get_title:function(){return"Trigger"}}),p=Upfront.Views.Editor.Sidebar.Element.extend({priority:130,render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-login"),this.$el.html("Login")},add_element:function(){var e=new r,t=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c22 upfront-login_element-module"},{name:"has_settings",value:0},{name:"row",value:14}],objects:[e]});this.add_module(t)}});Upfront.Application.LayoutEditor.add_object("Login",{Model:r,View:i,Element:p,Settings:a}),Upfront.Models.LoginModel=r,Upfront.Views.LoginView=i})}(jQuery),define("text!elements/upfront-maps/css/edit.css",[],function(){return".upfront-editable_entity .ufm-gmap-container img {\r\n  max-width: none !important;\r\n  max-height: none !important;\r\n}\r\n.upfront_map-fields-simple_location .upfront-field-wrap-text {\r\n	float: left;\r\n	width: 80%;\r\n}\r\n.upfront_map-fields-simple_location .upfront-field-wrap-refresh button {\r\n	width: 24px;\r\n	height: 30px;\r\n	border: none;\r\n	background: none;\r\n	padding: 0;\r\n}\r\n#settings .upfront-settings-item-maps_element-location .upfront-settings-item {\r\n	border: none;\r\n	padding-right: 0;\r\n}\r\n#settings .ufpront-maps_element-settings_panel .upfront-settings_panel {\r\n	width: 180px;\r\n}\r\n#settings .ufpront-maps_element-settings_panel .upfront-settings_panel .upfront-settings_panel_scroll {\r\n	min-width: 180px;\r\n}\r\n\r\n.ufm-context-menu{\r\nbackground:white;\r\n-webkit-border-radius: 3px;\r\n-moz-border-radius: 3px;\r\nborder-radius: 3px;\r\n}\r\n.ufm-context-menu-item{\r\npadding:0px 10px;\r\n}\r\n\r\n.ufm-context-menu-item:hover{\r\nbackground:#f0f0f0;\r\n}\r\n\r\n.ufm-context-menu .ufm-context-menu-item:first-child{\r\n-webkit-border-top-left-radius: 3px;\r\n-webkit-border-top-right-radius: 3px;\r\n-moz-border-radius-topleft: 3px;\r\n-moz-border-radius-topright: 3px;\r\nborder-top-left-radius: 3px;\r\nborder-top-right-radius: 3px;\r\n}\r\n.ufm-context-menu .ufm-context-menu-item:last-child{\r\n-webkit-border-bottom-right-radius: 3px;\r\n-webkit-border-bottom-left-radius: 3px;\r\n-moz-border-radius-bottomright: 3px;\r\n-moz-border-radius-bottomleft: 3px;\r\nborder-bottom-right-radius: 3px;\r\nborder-bottom-left-radius: 3px;\r\n}\r\n\r\n.ufm-map-marker-select{\r\nposition:absolute;\r\nbackground:white;\r\nborder:1px solid #cccccc;\r\npadding:10px;\r\n}\r\n\r\n.ufm-map-marker-select .marker-url label{\r\ndisplay: block;\r\nline-height: 20px;\r\n}\r\n\r\n.ufm-map-marker-select .marker-url [name=\"marker-url\"]{\r\nwidth:100%;\r\nheight:44px;\r\n}\r\n\r\n.ufm-map-marker-select .marker-url{\r\nmargin-top: 10px;\r\n}\r\n\r\n.ufm-marker-demo{\r\nwidth:38px;\r\nheight:38px;\r\nline-height: 35px;\r\nborder:1px solid transparent;\r\n\r\ntext-align:center;\r\ndisplay:inline-block;\r\n}\r\n.ufm-marker-demo img{\r\ndisplay:inline-block;\r\nvertical-align: middle;\r\n}\r\n.ufm-marker-demo:hover{\r\nborder: 1px solid #cccccc;\r\ncursor: pointer;\r\n}\r\n.ufm-marker-demo.ufm-current{\r\nborder: 1px dashed #cccccc;\r\n}\r\n.ufm-marker-demo.ufm-current:hover{\r\nborder: 1px solid red;\r\n}\r\n\r\n\r\n\r\n.ufm-rounded{\r\n-webkit-border-radius: 3px;\r\n-moz-border-radius: 3px;\r\nborder-radius: 3px;\r\n}\r\n\r\n\r\n/* override upfront styles that cause visual google maps bugs */\r\n.upfront-map_module .upfront-editable_entity img {\r\nmax-width: none;\r\n}\r\n\r\n.marker-imgs{\r\nmax-height:120px;\r\noverflow-x: auto;\r\n}\r\n\r\n/* triagnle pointer */\r\n.ufm-map-marker-select{\r\nposition: relative;\r\n}\r\n.ufm-map-marker-select:after{\r\ncontent: '';\r\ndisplay: block;\r\nposition: absolute;\r\ntop: -20px;\r\nleft: 159px;\r\nwidth: 0;\r\nheight: 0;\r\nborder-color: transparent transparent #ffffff transparent;\r\nborder-style: solid;\r\nborder-width: 10px;\r\n}\r\n\r\n.ufm-map-marker-select:before{\r\ncontent: '';\r\ndisplay: block;\r\nposition: absolute;\r\ntop: -23px;\r\nleft: 158px;\r\nwidth: 0;\r\nheight: 0;\r\nborder-color: transparent transparent #cccccc transparent;\r\nborder-style: solid;\r\nborder-width: 11px;\r\n}\r\n\r\n.ufm-map-main img {\r\n	height: auto;\r\n	width: auto;\r\n}\r\n\r\n/* initial experience layout */\r\n\r\n#upfront_map-location_overlay-wrapper, \r\n.uf_el_map_initial-overlay {\r\n	background:rgb(227, 227, 220);\r\n	color:#fff;\r\n	margin: auto;\r\n	position: absolute;\r\n	top: 0; left: 0; bottom: 0; right: 0;\r\n	text-align:center;\r\n	line-height: 80%;\r\n	font-weight: 300;\r\n	font-size:20px;\r\n}\r\n\r\n.uf_el_map_initial-overlay {\r\n	height: 150px;\r\n	padding:15px;\r\n}\r\n\r\n/* address input */\r\n.uf_el_map_initial-overlay input[type=\"text\"] {\r\n	background:rgb(201,201,195);\r\n	font-size: 1em;\r\n	width:100%;\r\n}\r\n\r\n/* refresh button */\r\n.uf_el_map_initial-overlay button {\r\n	position: absolute;\r\n	top: 0;\r\n	right: 0;\r\n	background-color: transparent;\r\n	padding: 10px;\r\n}\r\n\r\n.uf_el_map_initial-overlay button , \r\n.uf_el_map_initial-overlay .uf-current-location {\r\n	margin:0;\r\n}\r\n\r\n.uf_el_map_initial-overlay .uf-address  {\r\n	margin:0 auto;\r\n	max-width:500px;\r\n	position: relative;\r\n	margin-bottom: 10px;\r\n}\r\n\r\n.uf-current-location {\r\n	font-size: 0.8em;\r\n	margin-top:10px;\r\n}\r\n/* Use My Location */\r\n.uf-current-location a {\r\n	background:transparent;\r\n	color:#395269;\r\n	text-decoration: underline;\r\n	padding:0;\r\n	margin:0;\r\n}\r\n.uf-current-location a:hover { cursor: pointer; }\r\n\r\n.uf_el_map_initial-overlay  button,\r\n.uf_el_map_initial-overlay  input { outline:none; }"}),function(e){define("upfront_maps",["maps_context_menu","text!elements/upfront-maps/css/edit.css"],function(t,n){var r={OPTIMUM_MAP_HEIGHT:300,center:[10.72225,106.730762],zoom:10,style:"ROADMAP",controls:{pan:!1,zoom:!1,map_type:!1,scale:!1,street_view:!1,overview_map:!1}};e("head").append("<style>"+n+"</style>");var i=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(Upfront.data.umaps.defaults);r.center=e.map_center,navigator&&navigator.geolocation&&delete e.map_center,e.element_id=Upfront.Util.get_unique_id(e.id_slug+"-object"),this.init_properties(e)}}),s=Upfront.Views.Editor.Field.Checkboxes.extend({multiple:!1}),o=Upfront.Views.Editor.Field.Text.extend({className:"upfront-field-wrap upfront-field-wrap-refresh",events:function(){return _.extend({},Upfront.Views.Editor.Field.Text.prototype.events,{click:"propagate_activation_request"})},get_field_html:function(){return'<button type="button"><img src="'+Upfront.data.upfront_maps.root_url+'img/refresh.png" /></button>'},propagate_activation_request:function(e){e.preventDefault(),e.stopPropagation(),this.trigger("refresh")}}),u=Backbone.View.extend({className:"upfront_map-fields-simple_location clearfix",events:{keypress:"wait_for_enter"},initialize:function(){this.model instanceof i||(this.model=new i({properties:this.model.get("properties")}));var e=_.extend({},this.options);this.options.field=new Upfront.Views.Editor.Field.Text(e),this.options.locate=new o(e),this.property=this.options.field.property,this.options.locate.on("refresh",this.geocode,this),this.model.on("options:location:geocode",this.geocode,this)},wait_for_enter:function(e){13==e.which&&(e.stopPropagation(),e.preventDefault(),this.geocode())},render:function(){this.$el.empty(),this.options.locate.render(),this.options.field.render(),this.$el.append(this.options.field.$el),this.$el.append(this.options.locate.$el)},get_value:function(){return this.options.field.get_value()},get_saved_value:function(){return this.options.field.get_saved_value()},geocode:function(){if("undefined"==typeof window.google)return!1;var t=this.options.field.get_value(),n=this.model.get_property_value_by_name("element_id"),r=e(document).data(n+"-location"),i=new google.maps.Geocoder,s=this;if(!t||t==r)return!1;if(this._geocoding_in_progress)return!1;this._geocoding_in_progress=!0,i.geocode({address:t},function(r,i){if(i!=google.maps.GeocoderStatus.OK)return!1;var o=r[0].geometry.location,u=s.model.get_property_value_by_name("markers")||[];u.push({lat:o.lat(),lng:o.lng()}),s.model.set_property("markers",u,!0),s.model.set_property("map_center",[o.lat(),o.lng()],!1),e(document).data(n+"-location",t),s._geocoding_in_progress=!1})}}),a=Upfront.Views.ObjectView.extend({map:!1,on_render:function(){this.update_properties();var e=this,t=this.$el.find(".ufm-gmap-container:first"),n=this.model.get_property_value_by_name("row")?this.model.get_property_value_by_name("row"):this.parent_module_view.model.get_property_value_by_name("row"),i=this.model.get_property_value_by_name("controls")||[],s={center:this.model.get_property_value_by_name("map_center")||r.center,zoom:parseInt(this.model.get_property_value_by_name("zoom"),10)||r.zoom,type:this.model.get_property_value_by_name("style")||r.style,panControl:i.indexOf("pan")>=0||r.controls.pan,zoomControl:i.indexOf("zoom")>=0||r.controls.zoom,mapTypeControl:i.indexOf("map_type")>=0||r.controls.map_type,scaleControl:i.indexOf("scale")>=0||r.controls.scale,streetViewControl:i.indexOf("street_view")>=0||r.controls.street_view,overviewMapControl:i.indexOf("overview_map")>=0||r.controls.overview_map,style_overlay:this.model.get_property_value_by_name("styles")||!1};n=n?parseInt(n,10)*Upfront.Settings.LayoutEditor.Grid.baseline:r.OPTIMUM_MAP_HEIGHT,t.css({width:"100%",height:n+"px"}),t.on("click mousedown mouseup",function(e){e.cancelBubble=!0,e.stopPropagation&&e.stopPropagation()}),"undefined"!=typeof window.google?(this.map=new google.maps.Map(t.get(0),{center:new google.maps.LatLng(s.center[0],s.center[1]),zoom:s.zoom,mapTypeId:google.maps.MapTypeId[s.type],panControl:s.panControl,zoomControl:s.zoomControl,mapTypeControl:s.mapTypeControl,scaleControl:s.scaleControl,streetViewControl:s.streetViewControl,overviewMapControl:s.overviewMapControl,scrollwheel:!1}),s.style_overlay&&this.map.setOptions({styles:s.style_overlay}),this.model.get_property_value_by_name("map_center")||this.add_location_overlay(),setTimeout(function(){var t=e.map.getCenter();google.maps.event.trigger(e.map,"resize"),e.map.setCenter(t)},300),this.add_stored_markers(),this.init_rightclick_context_menu()):t.text("Please, check your internet connectivity")},add_location_overlay:function(){var t=this,n=this.$el.find("#upfront_map-location_overlay-wrapper");n.length||(this.$el.append('<div id="upfront_map-location_overlay-wrapper"><div id="upfront_map-location_overlay" class="uf_el_map_initial-overlay"><p id="upfront_map-location_overlay-instruction">Please enter address for us to generate a map from:</p><div id="upfront_map-location_overlay-address" class="upfront-ui uf-address"><input type="text" id="upfront_map-location_overlay-location" placeholder="Street, city, country" /><button type="button" id="upfront_map-location_overlay-use_location" class="upfront-field-icon upfront-icon-map-refresh"></button></div><span class="uf-current-location">or <a id="upfront_map-location_overlay-use_current">Use my current location</a></span></div></div>'),n=this.$el.find("#upfront_map-location_overlay-wrapper")),n.find("#upfront_map-location_overlay-use_location").off("click").on("click",function(){var n=t.$el.find("#upfront_map-location_overlay-wrapper #upfront_map-location_overlay-location"),r=new google.maps.Geocoder,i=t.model.get_property_value_by_name("element_id"),s=n.length?n.val():"";if(!s)return!1;r.geocode({address:s},function(n,r){if(r!=google.maps.GeocoderStatus.OK)return!1;var s=n[0].geometry.location,o=t.model.get_property_value_by_name("markers")||[];o.push({lat:s.lat(),lng:s.lng()}),t.model.set_property("markers",o,!0),t.model.set_property("map_center",[s.lat(),s.lng()],!1),e(document).data(i+"-location",location)})}).end().find("#upfront_map-location_overlay-location").off("keypress").on("keypress",function(e){13===e.which&&n.find("#upfront_map-location_overlay-use_location").click()}).end().find("#upfront_map-location_overlay-use_current").off("click").on("click",function(){if(!navigator||!navigator.geolocation)return!1;var e=t.model.get_property_value_by_name("markers")||[];navigator.geolocation.getCurrentPosition(function(n){e.push({lat:n.coords.latitude,lng:n.coords.longitude}),t.model.set_property("markers",e,!0),t.model.set_property("map_center",[n.coords.latitude,n.coords.longitude],!1)})}).end().off("dblclick").on("dblclick",function(e){e.preventDefault(),e.stopPropagation()}),this.$el.find(".upfront-entity_meta").hide()},get_content_markup:function(){return'<div class="ufm-gmap-container"><p>Please, hold on</p></div>'},update_properties:function(){this.model.trigger("options:location:geocode")},center_map:function(e,t){var n=new google.maps.LatLng(e,t);this.map.setCenter(n),this.model.set_property("map_center",[e,t])},init_rightclick_context_menu:function(){var e={};e.classNames={menu:"ufm-context-menu",menuSeparator:"context_menu_separator"};var t=[];t.push({className:"ufm-context-menu-item",eventName:"center_map",label:"Center Map Here"}),t.push({className:"ufm-context-menu-item",eventName:"add_marker",label:"Add Marker"}),e.menuItems=t;var n=new ContextMenu(this.map,e);google.maps.event.addListener(this.map,"rightclick",function(e){n.show(e.latLng)});var r=this;google.maps.event.addListener(n,"menu_item_selected",function(e,t){switch(t){case"add_marker":r.add_marker(e.lat(),e.lng());break;case"center_map":r.center_map(e.lat(),e.lng())}})},init_marker_context_menu:function(e){var t={};t.classNames={menu:"ufm-context-menu",menuSeparator:"context_menu_separator"};var n=[];n.push({className:"ufm-context-menu-item",eventName:"remove_marker",label:"Remove Marker"}),n.push({className:"ufm-context-menu-item",eventName:"change_icon",label:"Change Icon"}),t.menuItems=n;var r=new ContextMenu(this.map,t);google.maps.event.addListener(e,"rightclick",function(e){r.show(e.latLng)});var i=this;google.maps.event.addListener(r,"menu_item_selected",function(t,n){switch(n){case"remove_marker":i.remove_map_marker(e);break;case"change_icon":i.show_icon_select(e)}})},add_marker:function(e,t){var n=this.model.get_property_value_by_name("markers")||[];n.push({lat:e,lng:t}),this.model.set_property("markers",n),this.add_map_marker({lat:e,lng:t})},update_marker:function(e){var t=this.model.get_property_value_by_name("markers")||[];_(t).each(function(n,r){n.lat===e.lat&&n.lng===e.lng&&(t[r]=e)}),this.model.set_property("markers",t)},add_map_marker:function(t){var n=this,r=new google.maps.Marker({position:new google.maps.LatLng(t.lat,t.lng),draggable:!1,icon:t.icon?t.icon:"",map:this.map}),i=e('<div contenteditable="true">'+(t.content?t.content:"Edit this...")+"</div>"),s=new google.maps.InfoWindow({content:i.get(0)});r._raw=t,i.on("input",function(){t.content=i.text(),n.update_marker(t)}),t.is_open&&s.open(n.map,r),google.maps.event.addListener(r,"click",function(){t.is_open?(t.is_open=!1,s.close()):(s.open(n.map,r),t.is_open=!0),n.update_marker(t)}),this.init_marker_context_menu(r)},remove_map_marker:function(e){var t=e._raw,n=this.model.get_property_value_by_name("markers")||[],r=[];_(n).each(function(e,n){(e.lat!==t.lat||e.lng!==t.lng)&&r.push(e)}),this.model.set_property("markers",r),e.setMap(null)},add_stored_markers:function(){var e=this,t=this.model.get_property_value_by_name("markers")||[];_(t).each(function(t){e.add_map_marker(t)})},show_icon_select:function(e){var t=this.get_icon_select_overlay();this.icon_select_overlay=new t(this.map,e)},get_icon_select_overlay:function(t){function i(e,t){this.map=e,this.marker=t,this.div=null,this.setMap(e)}var n=this.map,r=this;return i.prototype=new google.maps.OverlayView,i.prototype.onAdd=function(){var t=this,n=e('<div class="ufm-map-marker-select ufm-rounded"><div class="marker-imgs"></div><div class="marker-url"><label for="marker-url">Image URL (.png):</label><textarea id="marker-url" name="marker-url" value="" rows="4"/></textarea></div></div>');this.div=n.get(0);var i=["POI.png","arts.png","bar.png","blue-dot.png","blue-pushpin.png","blue.png","bus.png","cabs.png","camera.png","campfire.png","campground.png","casetta_base.png","casetta_brown.png","casetta_green.png","casetta_red.png","casetta_yellow.png","caution.png","coffeehouse.png","convienancestore.png","cycling.png","dollar.png","drinking_water.png","earthquake.png","electronics.png","euro.png","fallingrocks.png","ferry.png","firedept.png","fishing.png","flag.png","gas.png","golfer.png","grocerystore.png","hiker.png","homegardenbusiness.png","hospitals.png","info_circle.png","man.png","marina.png","marker.png","plane.png","snack_bar.png","sportvenue.png","toilets.png","trail.png","tree.png","wheel_chair_accessible.png","woman.png"],s=Upfront.data.upfront_maps.markers,o="";_.each(i,function(e){o=o+'<div class="ufm-marker-demo ufm-rounded"> <img src="'+s+e+'" /> </div>'}),e(".marker-imgs",n).html(o),e(".marker-imgs img",n).on("click dblclick",function(){var t=e(this).parent(),n=t.hasClass("ufm-current")?"":e(this).attr("src");e("div",t.parent()).removeClass("ufm-current"),n!==""&&t.addClass("ufm-current"),u.val(n).trigger("change")}),e(".marker-imgs img",n).on("dblclick",function(){t.setMap(null)}),e(".marker-url button",n).click(function(){t.setMap(null)});var u=e('.marker-url [name="marker-url"]',n),a=this.marker.getIcon(),f=typeof a=="string"?a:"";e('img[src="'+f+'"]',n).parent().addClass("ufm-current"),u.val(f),u.click(function(){this.focus()}),u.on("input propertychange change",function(){var n=e(this).val(),n=n===""?null:n;if(/png$/.test(n)||n===null)t.marker._raw.icon=n,r.update_marker(t.marker._raw),t.marker.setIcon(n)});var l=function(e){e.cancelBubble=!0,e.stopPropagation&&e.stopPropagation()};google.maps.event.addDomListener(this.div,"click",l),google.maps.event.addDomListener(this.div,"dblclick",l),e(this.div).on("click mousedown mouseup",l);var c=function(e){t.setMap(null)};google.maps.event.addListener(this.map,"click",c),google.maps.event.addListener(this.map,"rightclick",c);var h=this.getPanes();h.floatPane.appendChild(this.div)},i.prototype.draw=function(){var e=this.getProjection(),t=this.marker.getPosition(),n=e.fromLatLngToDivPixel(t),r=this.div;r.style.left=n.x-170+"px",r.style.top=n.y+15+"px",r.style.width="320px"},i.prototype.onRemove=function(){this.div.parentNode.removeChild(this.div),this.div=null},i}}),f=Upfront.Views.Editor.Sidebar.Element.extend({priority:40,render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-maps"),this.$el.html("Map")},add_element:function(){var e=new i,t=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c12 upfront-map_element-module"},{name:"has_settings",value:0},{name:"row",value:22}],objects:[e]});this.add_module(t)}}),l=Upfront.Views.Editor.Settings.Settings.extend({initialize:function(){this.panels=_([new c({model:this.model})])},get_title:function(){return"Map settings"}}),c=Upfront.Views.Editor.Settings.Panel.extend({initialize:function(){this.settings=_([new h({model:this.model}),new p({model:this.model}),new d({model:this.model}),new v({model:this.model})])},render:function(){Upfront.Views.Editor.Settings.Panel.prototype.render.call(this),this.$el.addClass("ufpront-maps_element-settings_panel")},get_label:function(){return"Google Map"},get_title:function(){return"Google Map"}}),h=Upfront.Views.Editor.Settings.Item.extend({className:"upfront-settings-item-maps_element-location",initialize:function(){this.fields=_([new u({model:this.model,property:"location"})])},get_title:function(){return"Location"}}),p=Upfront.Views.Editor.Settings.Item.extend({initialize:function(){var e=[],t=this.model.get_property_value_by_name("zoom");t||this.model.set_property("zoom",r.zoom,!0),_(_.range(1,19)).each(function(t){e.push({label:t,value:t})}),this.fields=_([new Upfront.Views.Editor.Field.Slider({model:this.model,property:"zoom",min:1,max:19,change:function(){this.property.set({value:this.get_value()})}})])},get_title:function(){return"Map Zoom"}}),d=Upfront.Views.Editor.Settings.Item.extend({initialize:function(){var e=this.model.get_property_value_by_name("style");styles=[{label:"Roadmap",value:"ROADMAP"},{label:"Satellite",value:"SATELLITE"},{label:"Hybrid",value:"HYBRID"},{label:"Terrain",value:"TERRAIN"}],e||this.model.set_property("style",r.style,!0),this.fields=_([new Upfront.Views.Editor.Field.Select({model:this.model,property:"style",values:styles,change:function(){this.property.set({value:this.get_value()})}})])},get_title:function(){return"Map Style"}}),v=Upfront.Views.Editor.Settings.Item.extend({initialize:function(){var e=[{label:"Pan",value:"pan"},{label:"Zoom",value:"zoom"},{label:"Map Type",value:"map_type"},{label:"Scale",value:"scale"},{label:"Street View",value:"street_view"},{label:"Overview Map",value:"overview_map"}];this.fields=_([new Upfront.Views.Editor.Field.Select({model:this.model,property:"controls",multiple:!0,values:e,change:function(){this.property.set({value:this.get_value()})}})])},get_title:function(){return"Controls"}});Upfront.Application.LayoutEditor.add_object("Map",{Model:i,View:a,Element:f,Settings:l}),Upfront.Models.MapModel=i,Upfront.Views.MapView=a})}(jQuery),function(e){define("upfront-navigation",[],function(){var t=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(Upfront.data.unavigation.defaults);e.element_id=Upfront.Util.get_unique_id(e.id_slug+"-object"),this.init_properties(e)}}),n=Backbone.Model.extend({defaults:{id:!1,name:!1,url:!1,model_true:!0,menu_id:!1,menuList:!1}}),r=new n,i=Upfront.Views.ObjectView.extend({model:t,toolTip:_.template('<div class="nav_tooltip upfront-ui" style="display: none;"><a class="edit_url" href="#"><i class="upfront-field-icon upfront-field-icon-navigation-link"></i>edit URL</a><a class="visit_page" href="#"><i class="upfront-field-icon upfront-field-icon-navigation-open"></i>visit page</a></div>'),initialize:function(){this.model instanceof t||(this.model=new t({properties:this.model.get("properties")})),Upfront.Views.ObjectView.prototype.initialize.call(this);if(r.get("model_true")){this.getMenus();var e=this.model.get_property_value_by_name("menu_id");r.set({model_true:!1,menu_id:e}),this.auto_add_pages(),e&&(Upfront.data.navigation.get_this_menu_items=Upfront.Util.post({action:"upfront_load_menu_items",data:r.get("menu_id")})),Upfront.data.navigation.get_all_pages=Upfront.Util.post({action:"upfront_load_all_pages"}),Upfront.data.navigation.get_all_categories=Upfront.Util.post({action:"upfront_load_all_categories"}),Upfront.Events.on("entity:object:render_navigation",this.renderTrigger,this),!this.model.get_property_by_name("menu_id")||this.model.get_property_by_name("menu_id").on("change",this.auto_add_pages,this),!this.model.get_property_by_name("allow_new_pages")||this.model.get_property_by_name("allow_new_pages").on("change",this.update_auto_add_pages,this),this.model.get("properties").on("all",this.update_model,this),this.model.get("properties").on("all",this.getMenus,this)}},update_model:function(){var e=this.model.get_property_value_by_name("menu_id");r.set({menu_id:e}),Upfront.Events.trigger("navigation:get:this:menu:items")},update_auto_add_pages:function(){var e=this.model.get_property_value_by_name("menu_id"),t=this.property("allow_new_pages"),n=Upfront.data.navigation.auto_add.auto_add,r;if(!e)return!1;e=parseInt(this.model.get_property_value_by_name("menu_id"),10),n||(n=[]),t[0]==["yes"]?n.indexOf(e)==-1&&n.push(e):-1!==(r=n.indexOf(e))&&n.splice(r,1),Upfront.data.navigation.auto_add?Upfront.data.navigation.auto_add.auto_add=n:Upfront.data.navigation.auto_add={0:!1,auto_add:[]},Upfront.Util.post({action:"upfront_update_auto_add_pages",nav_menu_option:JSON.stringify(Upfront.data.navigation.auto_add)}).error(function(e){Upfront.Util.log("Cannot update auto add pages!")})},auto_add_pages:function(){var e=parseInt(this.model.get_property_value_by_name("menu_id"),10);Upfront.data.navigation.auto_add.auto_add?-1!==Upfront.data.navigation.auto_add.auto_add.indexOf(e)?this.model.set_property("allow_new_pages",["yes"],!0):this.model.set_property("allow_new_pages",["no"],!0):this.model.set_property("allow_new_pages",["no"],!0)},getMenus:function(){var e=this;Upfront.Util.post({action:"upfront_load_menu_list"}).success(function(t){var n=_.map(t.data,function(n,r){if(t.data.length&&r==0){var i=e.property("menu_id");i||e.property("menu_id",n.term_id)}return{label:n.name,value:n.term_id}});r.set({menuList:n})}).error(function(e){Upfront.Util.log("Error loading menu list")})},events:function(){return _.extend({},Upfront.Views.ObjectView.prototype.events,{"hover .upfront-object-content .menu-item > a":"onMenuItemHover"})},property:function(e,t){return typeof t!="undefined"?this.model.set_property(e,t):this.model.get_property_value_by_name(e)},get_content_markup:function(){var e=this.model.get_property_value_by_name("menu_id"),t=this;return e?(Upfront.Util.post({action:"upfront_load_menu_html",data:e}).success(function(e){if(!e.data){t.$el.find(".upfront-object-content").html("Please add menu items");return}t.$el.find(".upfront-object-content").html(e.data),t.toolTipAppend(),t.$el.find(".upfront-object-content a").attr("contenteditable",!0),t.changeMenuItemTitle()}).error(function(e){Upfront.Util.log("Error loading menu")}),"Loading"):"Please select menu on settings"},toolTipAppend:function(){var t=e("body"),n=this;t.find(".nav_tooltip").remove().end().append(this.toolTip),t.find(".nav_tooltip").hover(function(){e(this).show()},function(){e(this).hide()}),console.log("navigation"),t.find(".nav_tooltip").find(".edit_url").click(function(e){e.preventDefault(),Upfront.Events.trigger("entity:settings:activate",n),Upfront.Events.trigger("entity:settings:panel:open")})},renderTrigger:function(){this.render()},changeMenuItemTitle:function(){var e=this.$el.find(".upfront-object-content a[contentEditable]");for(var t=0,n=e.length;t<n;t++)e[t].setAttribute("data-orig",e[t].innerHTML),e[t].onblur=function(){if(this.innerHTML!==this.getAttribute("data-orig")){this.setAttribute("data-orig",this.innerHTML);var e=this.offsetParent.id.replace(/^\D+/g,"");if(!e)return"Error Item id is missing";Upfront.Util.post({action:"upfront_change_menu_label",item_id:e,item_label:this.innerHTML}).success(function(e){Upfront.Events.trigger("navigation:get:this:menu:items"),Upfront.Views.Editor.notify("Navigation item name updated!")}).error(function(e){Upfront.Util.log("Error changing menu item label")})}}},onMenuItemHover:function(t){var n=e(t.target),i=n.html(),s=n.attr("href"),o=t.target.parentElement.id,u=o.replace(/^\D+/g,""),a=e(".nav_tooltip");r.set({id:u,name:i,url:s}),n.on("click mousedown mouseup",function(e){e.cancelBubble=!0,e.stopPropagation&&e.stopPropagation()});if(t.type=="mouseenter"){a.find(".visit_page").attr("href",t.target.href);var f=n.offset().left+n.outerWidth()/2-a.outerWidth()/2,l=n.offset().top-a.outerHeight();a.css({top:l,left:f,position:"absolute"}).show()}else a.hide()},on_render:function(){var e=this.property("menu_style"),t=this.property("menu_alignment"),n=this.property("allow_sub_nav"),r;r=this.$el.find(".upfront-object-content"),r.attr("data-aliment",t?t:"left"),r.attr("data-style",e?e:"horizontal"),r.attr("data-allow-sub-nav",n.length!==0&&n[0]=="yes"?n[0]:"no")}}),s=Upfront.Views.Editor.Sidebar.Element.extend({priority:200,render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-nav"),this.$el.html("Menus")},add_element:function(){var e=new t({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("nav")}]}),n=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c22 upfront-navigation_module"},{name:"has_settings",value:0},{name:"row",value:4}],objects:[e]});this.add_module(n)}}),o=Upfront.Views.Editor.Settings.Item.extend({get_values:function(){var e=this.fields._wrapped[0].$el.find("input").val(),t=this.fields._wrapped[1].$el.find("input").val(),n=this.fields._wrapped[1].$el.find("input").attr("name");return[e,t,n]},reset_fields:function(e){e?(this.fields._wrapped[0].$el.find("input").val(e[0]).attr("name",e[2]),this.fields._wrapped[1].$el.find("input").val(e[1]).attr("name",e[2])):(this.fields._wrapped[0].$el.find("input").val("").attr("name",""),this.fields._wrapped[1].$el.find("input").val("").attr("name",""))}}),u=Upfront.Views.Editor.Field.Checkboxes.extend({className:"upfront-field-wrap-multiple upfront-field-wrap-checkboxes",initialize:function(){},render:function(){var t=this;return this.$el.html(""),this.label&&this.$el.append(this.get_label_html()),this.$el.append(this.get_field_html()),this.$el.on("change",".upfront-field-multiple input",function(){t.$el.find(".upfront-field-multiple").each(function(){e(this).find("input:checked").size()>0?e(this).addClass("upfront-field-multiple-selected"):e(this).removeClass("upfront-field-multiple-selected")})}),this.trigger("rendered"),this},get_field_html:function(){return this.get_values_html()},get_value_html:function(e,t){var n=e.id,r="upfront-field-multiple",i={type:this.type,id:e.type+"-"+n,name:"menu-item[-"+n+"][menu-item-object-id]",value:n,"class":"upfront-field-"+this.type};return e.disabled&&(i.disabled="disabled",r+=" upfront-field-multiple-disabled"),i.checked&&(r+=" upfront-field-multiple-selected"),'<span class="'+r+'"><input '+this.get_field_attr_html(i)+" />"+'<label for="'+e.type+"-"+n+'"><span class="upfront-field-label-text">'+e.label+"</span></label></span>"+'<input type="hidden" class="menu-item-db-id" name="menu-item[-'+n+'][menu-item-db-id]" value="0">'+'<input type="hidden" class="menu-item-object" name="menu-item[-'+n+'][menu-item-object]" value="'+e.type+'">'+'<input type="hidden" class="menu-item-parent-id" name="menu-item[-'+n+'][menu-item-parent-id]" value="0">'+'<input type="hidden" class="menu-item-type" name="menu-item[-'+n+'][menu-item-type]" value="'+e.item_type+'">'+'<input type="hidden" class="menu-item-title" name="menu-item[-'+n+'][menu-item-title]" value="'+e.label+'">'+'<input type="hidden" class="menu-item-url" name="menu-item[-'+n+'][menu-item-url]" value="'+e.url+'">'+'<input type="hidden" class="menu-item-target" name="menu-item[-'+n+'][menu-item-target]" value="">'+'<input type="hidden" class="menu-item-attr_title" name="menu-item[-'+n+'][menu-item-attr_title]" value="">'+'<input type="hidden" class="menu-item-classes" name="menu-item[-'+n+'][menu-item-classes]" value="">'+'<input type="hidden" class="menu-item-xfn" name="menu-item[-'+n+'][menu-item-xfn]" value="">'},isProperty:!1}),a=Upfront.Views.Editor.Settings.Panel.extend({initialize:function(e){a.__super__.initialize.apply(this,arguments),Upfront.Events.on("entity:settings:deactivate",this.close,this),Upfront.Events.on("entity:settings:panel:open",this.openPanel,this)},close:function(){Upfront.Events.off("entity:settings:panel:open",this.openPanel,this),Upfront.Events.off("entity:settings:deactivate",this.close,this)},openPanel:function(){this.on_toggle(),this.actCustomLink(),this.settings._wrapped[2].reveal()},save_settings:function(){this.settings._wrapped[0].settings._wrapped[0].fields._wrapped[0].createPages(),this.settings._wrapped[1].settings._wrapped[0].fields._wrapped[0].createPages(),this.addCustomLink(this.settings._wrapped[2].settings._wrapped[0].get_values());var e=this.settings._wrapped[2].settings._wrapped[2].get_values();e&&e.anchor&&this.addCustomLink(["#"+e.anchor,e.label])},reset_fields:function(e){this.settings._wrapped[2].settings._wrapped[0].reset_fields(e)},addCustomLink:function(e){var t=e.length?parseInt(e[2],10):0;if(""==e[0]||"http://"==e[0]||""==e[1])return!1;t?this.addItemToMenu({"menu-item-db-id":t,"menu-item-type":"custom","menu-item-url":e[0],"menu-item-title":e[1]}):this.addItemToMenu({"-1":{"menu-item-type":"custom","menu-item-url":e[0],"menu-item-title":e[1]}})},addItemToMenu:function(e){var t=this.model.get_property_value_by_name("menu_id"),n=this,r=e["menu-item-db-id"]?e["menu-item-db-id"]:0;if(!t)return"Please select menu on settings";r?Upfront.Util.post({action:"upfront_update_menu_item",menu:t,"menu-item-id":r,"menu-item":e}).success(function(e){Upfront.Events.trigger("entity:object:render_navigation"),Upfront.Events.trigger("navigation:get:this:menu:items"),Upfront.Events.trigger("navigation:render_menu_order"),n.reset_fields()}).error(function(e){Upfront.Util.log("Error updating menu item")}):Upfront.Util.post({action:"upfront_add_menu_item",menu:t,"menu-item":e}).success(function(e){n.update_post_status(e)}).error(function(e){Upfront.Util.log("Error adding menu item")})},update_post_status:function(e){var t=this;if(!e)return!1;Upfront.Util.post({action:"upfront_update_post_status",postIds:e}).success(function(e){Upfront.Events.trigger("entity:object:render_navigation"),Upfront.Events.trigger("navigation:get:this:menu:items"),Upfront.Events.trigger("navigation:render_menu_order"),t.reset_fields()}).error(function(e){Upfront.Util.log("Error updating status")})},actCustomLink:function(){var e=r.get("id"),t=r.get("url"),n=r.get("name");this.reset_fields([t,n,e])}}),f=Upfront.Views.Editor.Settings.Panel.extend({initialize:function(){f.__super__.initialize.apply(this,arguments),Upfront.Events.on("entity:settings:deactivate",this.close,this),Upfront.Events.on("entity:settings:init:sort",this.showPanel,this),Upfront.Events.on("entity:settings:init:sort:after",this.hidePanel,this)},close:function(){Upfront.Events.off("entity:settings:deactivate",this.close,this),Upfront.Events.off("entity:settings:init:sort",this.showPanel,this),Upfront.Events.off("entity:settings:init:sort:after",this.hidePanel,this)},showPanel:function(){this.is_active()||this.$el.find(".upfront-settings_panel").show()},hidePanel:function(){this.is_active_tab()||this.$el.find(".upfront-settings_panel").hide()},is_active_tab:function(){return this.$el.find(".upfront-settings_label").hasClass("active")},save_settings:function(){this.settings._wrapped[0].fields._wrapped[0].saveAllChanges()}}),l=Upfront.Views.Editor.Field.Field.extend({render:function(){this.$el.html(this.getAllItems())},getAllItems:function(){var e=this;Upfront.data.navigation[e.options.action].success(function(t){e.$el.empty().append((new b({collection:new y(t.data)})).render().el)}).error(function(e){Upfront.Util.log("Error loading Items")})},val:function(e,t){return typeof t!="undefined"?this.model.set_property(e,t):this.model.get_property_value_by_name(e)},createPages:function(){this.addSelectedToMenu(this.$el.find("ul"))},addSelectedToMenu:function(t){var n=t,r={},i=this,s=n.find("input:checked"),o=new RegExp("menu-item\\[([^\\]]*)");return s.length?(e(s).each(function(){var t=e(this),n=o.exec(t.attr("name")),s="undefined"==typeof n[1]?0:parseInt(n[1],10);r[s]=i.getItemData("add-menu-item",s,t.closest("li"))}),i.addItemToMenu(r),r):!1},getItemData:function(e,t,n){e=e||"menu-item";var r={},i,s,o=["menu-item-db-id","menu-item-object-id","menu-item-object","menu-item-parent-id","menu-item-position","menu-item-type","menu-item-title","menu-item-url","menu-item-description","menu-item-attr-title","menu-item-target","menu-item-classes","menu-item-xfn"];return s=n,!t&&e=="menu-item"&&(t=s.find(".menu-item-data-db-id").val()),t?(s.find("input").each(function(){var n;i=o.length;while(i--)e=="menu-item"?n=o[i]+"["+t+"]":e=="add-menu-item"&&(n="menu-item["+t+"]["+o[i]+"]"),this.name&&n==this.name&&(r[o[i]]=this.value)}),r):r},addItemToMenu:function(e){Upfront.Events.trigger("navigation:render_get_all_items");var t=this.val("menu_id"),n=this,r=e["menu-item-db-id"]?e["menu-item-db-id"]:0;if(!t)return"Please select menu on settings";r?Upfront.Util.post({action:"upfront_update_menu_item",menu:t,"menu-item-id":r,"menu-item":e}).success(function(e){Upfront.Events.trigger("entity:object:render_navigation"),Upfront.Events.trigger("navigation:get:this:menu:items"),Upfront.Events.trigger("navigation:render_menu_order")}).error(function(e){Upfront.Util.log("Error updating menu item")}):Upfront.Util.post({action:"upfront_add_menu_item",menu:t,"menu-item":e}).success(function(e){n.update_post_status(e)}).error(function(e){Upfront.Util.log("Error adding menu item")})},update_post_status:function(e){var t=this;if(!e)return!1;Upfront.Util.post({action:"upfront_update_post_status",postIds:e}).success(function(e){Upfront.Events.trigger("entity:object:render_navigation"),Upfront.Events.trigger("navigation:get:this:menu:items"),Upfront.Events.trigger("navigation:render_menu_order")}).error(function(e){Upfront.Util.log("Error updating status")})},isProperty:!1}),c=Backbone.View.extend({initialize:function(){Upfront.Events.on("navigation:get:this:menu:items",this.getThisMenuItemsData,this)},getThisMenuItemsData:function(){if(!r.get("menu_id"))return!0;Upfront.data.navigation.get_this_menu_items=Upfront.Util.post({action:"upfront_load_menu_items",data:r.get("menu_id")}).success(function(e){Upfront.Events.trigger("navigation:this:menu:items:success")}).done(function(){setTimeout(function(){Upfront.Events.trigger("navigation:render_get_all_items")},100)})}}),h=new c,p=Upfront.Views.Editor.Field.Field.extend({events:{"click span":"deleteMenuItem"},initialize:function(){p.__super__.initialize.apply(this,arguments),Upfront.Events.on("navigation:this:menu:items:success",this.getThisMenuItems,this)},render:function(){this.$el.html(this.getThisMenuItems())},getThisMenuItems:function(){var e=this;if(!r.get("menu_id"))return!0;Upfront.data.navigation.get_this_menu_items.success(function(t){e.$el.empty(),_.each(t.data,function(t){e.$el.append('<span id="'+t.ID+'">'+t.title+"</span>")})}).error(function(e){Upfront.Util.log("Error loading this menu items")})},deleteMenuItem:function(e){var t=this;Upfront.Util.post({action:"upfront_delete_menu_item",menu_item_id:e.target.id}).success(function(e){Upfront.Events.trigger("navigation:get:this:menu:items"),Upfront.Events.trigger("entity:object:render_navigation"),Upfront.Events.trigger("navigation:render_menu_order")}).error(function(e){Upfront.Util.log("Error Deleting Menu Item")})},isProperty:!1}),d=Upfront.Views.Editor.Field.Text.extend({addNewMenu:function(){var e=this.$el.find("input");e.val()?this.addNewMenuCall(e.val()):this.model.set_property("create_menu","",!0)},addNewMenuCall:function(e){var t=this,n=Upfront.Util.post({action:"upfront_create_menu",menu_name:e}).success(function(e){t.model.set_property("create_menu","",!0),t.getMenus()}).error(function(e){Upfront.Util.log("Error creating menu")})},getMenus:function(){var e=this;Upfront.Util.post({action:"upfront_load_menu_list"}).success(function(t){var n=_.map(t.data,function(e){return{label:e.name,value:e.term_id}});r.set({menuList:n}),e.trigger("panel:set")}).error(function(e){Upfront.Util.log("Error loading menu list")})}}),v=Upfront.Views.Editor.Field.Field.extend({tagName:"ul",className:"upfront-field-wrap menu",id:"menu-to-edit",options:{menuItemDepthPerLevel:20,globalMaxDepth:4},menuList:undefined,targetList:undefined,menusChanged:!1,isRTL:"undefined"!=typeof isRtl&&!!isRtl,negateIfRTL:"undefined"!=typeof isRtl&&isRtl?-1:1,MenuOrderListTemplate:_.template('<li id="menu-item-{{ item.db_id }}" class="menu-item menu-item-depth-{{depth}} menu-item-page menu-item-edit-inactive"><dl class="menu-item-bar"><dt class="menu-item-handle"><span class="item-title">{{ item.title }}</span><span class="item-controls"><span class="item-type">{{ item.type_label }}</span></span></dt></dl><div class="menu-item-settings" id="menu-item-settings-251"><input class="menu-item-data-db-id" type="hidden" name="menu-item-db-id[{{ item.db_id }}]" value="{{ item.db_id }}" /><input class="menu-item-data-parent-id" type="hidden" name="menu-item-parent-id[{{ item.db_id }}]" value="{{ item.menu_item_parent }}" /></div><ul class="menu-item-transport"></ul></li>'),initialize:function(){v.__super__.initialize.apply(this,arguments),this.jQueryExtensions(),Upfront.Events.on("navigation:save:re:ordered:menu",this.saveAllChanges,this),Upfront.Events.on("navigation:render_menu_order",this.MenuOrder,this)},render:function(){this.$el.html(this.MenuOrder())},registerChange:function(){this.menusChanged=!0},jQueryExtensions:function(){var t=this;e.fn.extend({menuItemDepth:function(){var e=t.isRTL?this.eq(0).css("margin-right"):this.eq(0).css("margin-left");return t.pxToDepth(e&&-1!=e.indexOf("px")?e.slice(0,-2):0)},updateDepthClass:function(t,n){return this.each(function(){var r=e(this);n=n||r.menuItemDepth(),e(this).removeClass("menu-item-depth-"+n).addClass("menu-item-depth-"+t)})},shiftDepthClass:function(t){return this.each(function(){var n=e(this),r=n.menuItemDepth();e(this).removeClass("menu-item-depth-"+r).addClass("menu-item-depth-"+(r+t))})},childMenuItems:function(){var t=e();return this.each(function(){var n=e(this),r=n.menuItemDepth(),i=n.next();while(i.length&&i.menuItemDepth()>r)t=t.add(i),i=i.next()}),t},updateParentMenuItemDBId:function(){return this.each(function(){var t=e(this),n=t.find(".menu-item-data-parent-id"),r=t.menuItemDepth(),i=t.prev();if(r==0)n.val(0);else{while(!i[0]||!i[0].className||-1==i[0].className.indexOf("menu-item")||i.menuItemDepth()!=r-1)i=i.prev();n.val(i.find(".menu-item-data-db-id").val())}})}})},initSortables:function(){function m(e){var t;s=e.placeholder.prev(),o=e.placeholder.next(),s[0]==e.item[0]&&(s=s.prev()),o[0]==e.item[0]&&(o=o.next()),u=s.length?s.offset().top+s.height():0,a=o.length?o.offset().top+o.height()/3:0,r=o.length?o.menuItemDepth():0,s.length?i=(t=s.menuItemDepth()+1)>d.options.globalMaxDepth?d.options.globalMaxDepth:t:i=0}function g(e,n){e.placeholder.updateDepthClass(n,t),t=n}function y(){if(!h[0].className)return 0;var e=h[0].className.match(/menu-max-depth-(\d+)/);return e&&e[1]?parseInt(e[1]):0}function b(t){var n,r=v;if(t===0)return;if(t>0)n=p+t,n>v&&(r=n);else if(t<0&&p==v)while(!e(".menu-item-depth-"+r,d.menuList).length&&r>0)r--;h.removeClass("menu-max-depth-"+v).addClass("menu-max-depth-"+r),v=r}var t=0,n,r,i,s,o,u,a,f,l,c=this.menuList.offset().left,h=e("body"),p,d=this,v=y();c+=this.isRTL?this.menuList.width():0,this.menuList.sortable({handle:".menu-item-handle",placeholder:"sortable-placeholder",start:function(t,r){var i,s,o,u,a;d.isRTL&&(r.item[0].style.right="auto"),l=r.item.children(".menu-item-transport"),n=r.item.menuItemDepth(),g(r,n),o=r.item.next()[0]==r.placeholder[0]?r.item.next():r.item,u=o.childMenuItems(),l.append(u),i=l.outerHeight(),i+=i>0?r.placeholder.css("margin-top").slice(0,-2)*1:0,i+=r.helper.outerHeight(),f=i,i-=2,r.placeholder.height(i),p=n,u.each(function(){var t=e(this).menuItemDepth();p=t>p?t:p}),s=r.helper.find(".menu-item-handle").outerWidth(),s+=d.depthToPx(p-n),s-=2,r.placeholder.width(s),a=r.placeholder.next(),a.css("margin-top",f+"px"),r.placeholder.detach(),e(this).sortable("refresh"),r.item.after(r.placeholder),a.css("margin-top",0),m(r)},stop:function(e,r){var i,s=t-n;i=l.children().insertAfter(r.item),s!=0&&(r.item.updateDepthClass(t),i.shiftDepthClass(s),b(s)),d.registerChange(),r.item.updateParentMenuItemDBId(),r.item[0].style.top=0,d.isRTL&&(r.item[0].style.left="auto",r.item[0].style.right=0)},change:function(e,t){t.placeholder.parent().hasClass("menu")||(s.length?s.after(t.placeholder):d.menuList.prepend(t.placeholder)),m(t)},sort:function(n,s){var l=s.helper.offset(),h=d.isRTL?l.left+s.helper.width():l.left,p=d.negateIfRTL*d.pxToDepth(h-c);p>i||l.top<u?p=i:p<r&&(p=r),p!=t&&g(s,p),a&&l.top+f>a&&(o.after(s.placeholder),m(s),e(this).sortable("refreshPositions"))}})},depthToPx:function(e){return e*this.options.menuItemDepthPerLevel},pxToDepth:function(e){return Math.floor(e/this.options.menuItemDepthPerLevel)},getItemData:function(e,t,n){e=e||"menu-item";var r={},i,s,o=["menu-item-db-id","menu-item-parent-id"];return s=n,!t&&e=="menu-item"&&(t=s.find(".menu-item-data-db-id").val()),t?(s.find("input").each(function(){var n;i=o.length;while(i--)e=="menu-item"&&(n=o[i]+"["+t+"]"),this.name&&n==this.name&&(r[o[i]]=this.value)}),r):r},addSelectedToMenu:function(t){var n=t,r={},i=this,s=n.find("li");return s.length?(e(s).each(function(t){var n=e(this),s=n.find(".menu-item-data-db-id").val();r[t]=i.getItemData("menu-item",s,n)}),r):!1},update_menu_order:function(){var e,t=this;e=this.addSelectedToMenu(this.$el);if(!e||_.isEqual(e,t.old_menuItems))return!1;Upfront.Util.post({action:"upfront_update_menu_order",menu_items:e}).success(function(e){Upfront.Events.trigger("entity:object:render_navigation"),Upfront.Events.trigger("navigation:get:this:menu:items")}).error(function(e){Upfront.Util.log("Error updating menu")})},iniSort:!0,MenuOrder:function(){var e=this.model.get_property_value_by_name("menu_id"),t=[],n=this;return e?(setTimeout(function(){Upfront.data.navigation.get_this_menu_items.success(function(e){var r=n.$el;r.empty(),_.each(e.data,function(e){t[e.ID]=(t[e.menu_item_parent]||0)+1,r.append(n.MenuOrderListTemplate({item:e,depth:t[e.ID]-1}))}),n.old_menuItems=n.addSelectedToMenu(n.$el)}).done(function(){n.menuList=n.$el,n.targetList=n.menuList,n.menuList.length&&n.iniSort&&(Upfront.Events.trigger("entity:settings:init:sort"),n.initSortables(),Upfront.Events.trigger("entity:settings:init:sort:after"),n.iniSort=!1),n.panel.trigger("upfront:settings:panel:refresh",n.panel)}).error(function(e){Upfront.Util.log("Error loading menu")})},100),"Loading..."):"Please select menu on settings"},saveAllChanges:function(){this.update_menu_order()},isProperty:!1}),m=Upfront.Views.Editor.Settings.Panel.extend({save_settings:function(){m.__super__.save_settings.apply(this,arguments),this.settings._wrapped[1].fields._wrapped[0].addNewMenu()}}),g=Upfront.Views.Editor.Settings.Settings.extend({initialize:function(){this.panels=_([new m({model:this.model,label:"Menu",title:"Menu settings",settings:[new Upfront.Views.Editor.Settings.Item({model:this.model,title:"Select Menu",fields:[new Upfront.Views.Editor.Field.Select({model:this.model,property:"menu_id",label:"",values:r.get("menuList")})]}),new Upfront.Views.Editor.Settings.Item({model:this.model,title:"Create Menu",fields:[new d({model:this.model,property:"create_menu",label:"New Menu Name",compact:!0})]})]}),new Upfront.Views.Editor.Settings.Panel({model:this.model,label:"Layout",title:"Layout settings",settings:[new Upfront.Views.Editor.Settings.Item({model:this.model,title:"Menu Style",fields:[new Upfront.Views.Editor.Field.Radios({model:this.model,property:"menu_style",default_value:"horizontal",label:"",layout:"vertical",values:[{label:"Horizontal",value:"horizontal",icon:"navigation-horizontal"},{label:"Vertical",value:"vertical",icon:"navigation-vertical"}]})]}),new Upfront.Views.Editor.Settings.Item({model:this.model,title:"Menu Alignment",fields:[new Upfront.Views.Editor.Field.Radios({model:this.model,property:"menu_alignment",default_value:"left",label:"",layout:"vertical",values:[{label:"Left",value:"left",icon:"navigation-left"},{label:"Center",value:"center",icon:"navigation-center"},{label:"Right",value:"right",icon:"navigation-right"}]})]}),new Upfront.Views.Editor.Settings.Item({model:this.model,title:"Misc. Settings",fields:[new Upfront.Views.Editor.Field.Checkboxes({model:this.model,property:"allow_sub_nav",label:"",default_value:["no"],values:[{label:"Allow subnavigation on hover",value:"yes"}]}),new Upfront.Views.Editor.Field.Checkboxes({model:this.model,property:"allow_new_pages",label:"",values:[{label:"Add new Pages to this menu",value:"yes"}]}),new Upfront.Views.Editor.Field.Checkboxes({model:this.model,property:"is_floating",label:"",values:[{label:"Allow floating...",value:"yes"}]})]})]}),new a({model:this.model,label:"Contents",title:"Contents settings",tabbed:!0,settings:[new Upfront.Views.Editor.Settings.ItemTabbed({model:this.model,title:"Pages",settings:[new Upfront.Views.Editor.Settings.Item({className:"upfront-nav-get-menu-items",model:this.model,title:"All Pages",fields:[new l({model:this.model,action:"get_all_pages"})]}),new Upfront.Views.Editor.Settings.Item({className:"upfront-nav-this-menu-items",model:this.model,title:"This Menu Items",fields:[new p({model:this.model})]})]}),new Upfront.Views.Editor.Settings.ItemTabbed({model:this.model,title:"Categories",settings:[new Upfront.Views.Editor.Settings.Item({className:"upfront-nav-get-menu-items",model:this.model,title:"All Categories",fields:[new l({model:this.model,action:"get_all_categories"})]}),new Upfront.Views.Editor.Settings.Item({className:"upfront-nav-this-menu-items",model:this.model,title:"This Menu Items",fields:[new p({model:this.model})]})]}),new Upfront.Views.Editor.Settings.ItemTabbed({model:this.model,title:"Custom Links",settings:[new o({model:this.model,title:"Add Custom Link",fields:[new d({model:this.model,property:"custom_url",label:"http://",compact:!0}),new d({model:this.model,property:"custom_label",label:"Label",compact:!0})]}),new Upfront.Views.Editor.Settings.Item({className:"upfront-nav-this-menu-items",model:this.model,title:"This Menu Items",fields:[new p({model:this.model})]}),new Upfront.Views.Editor.Settings.Anchor.LabeledTrigger({model:this.model,title:"Anchor link"})]})]}),new f({model:this.model,label:"Menu Order",title:"Menu Order settings",settings:[new Upfront.Views.Editor.Settings.Item({className:"upfront-nav-menu-order",model:this.model,title:"Order of your menu items",fields:[new v({model:this.model,refresh_panel:function(){this.panel.trigger("upfront:settings:panel:refresh",this.panel)}})]})]})])},get_title:function(){return"Navigation settings"}}),y=Backbone.Collection.extend({initialize:function(e){this.bind("reset",this.relationships)},relationships:function(){this.relations=_.groupBy(this.models,this.parent)},root:function(){return this.relations||this.relationships(),this.relations[0]},children:function(e){return this.relations||this.relationships(),typeof this.relations[e.get("ID")]=="undefined"?[]:this.relations[e.get("ID")]},parent:function(e){var t=e.get("parent_id");return t?t:0}}),b=Backbone.View.extend({initialize:function(e){if(!e.collection)throw"no collection provided";_.bindAll(this,"render"),this.collection.bind("reset",this.render),Upfront.Events.on("navigation:render_get_all_items",this.render,this)},render:function(e){return this.$el.empty().append(this.renderMenu(this.collection.root())),this},renderMenu:function(t){if(_.size(t)===0)return null;var n=e("<ul></ul>");return _.each(t,function(e){n.append(this.renderMenuItem(e));var t=this.collection.children(e);n.find("li:last").append(this.renderMenu(t))},this),n},renderMenuItem:function(e){var t=new w({model:e});return t.render().el}}),w=Backbone.View.extend({tagName:"li",disable_already_existing_page:function(){var e=this;if(!r.get("menu_id"))return!0;Upfront.data.navigation.get_this_menu_items.success(function(t){e.model.set({disabled:!1}),_.each(t.data,function(t){e.model.get("type")==t.object&&e.model.get("ID")==t.object_id&&e.model.set({disabled:!0})})}).error(function(e){Upfront.Util.log("Error loading this menu items")})},render:function(e){this.disable_already_existing_page();var t=this,n=(new u({values:[{id:this.model.get("ID"),label:this.model.get("name"),value:this.model.get("slug"),type:this.model.get("type"),item_type:this.model.get("item_type"),url:this.model.get("url"),disabled:this.model.get("disabled")?this.model.get("disabled"):!1}]})).render().el;return this.$el.html(n),this}});Upfront.Application.LayoutEditor.add_object("Navigation",{Model:t,View:i,Element:s,Settings:g}),Upfront.Models.NavigationModel=t,Upfront.Views.NavigationView=i})}(jQuery),define("text!elements/upfront-newnavigation/tpl/link_editor.html",[],function(){return'<div> \r\n<script type="text/template" id="link-tpl">\r\n	Type of link:	\r\n	<div class="upfront-field-wrap">\r\n		<input type="radio" name="unavigation-link-type" value="custom" class="upfront-field-radio" id="unavigation-link-type-1" {{menu_item_type == \'custom\' ? \'checked = "checked"\' : \'\'}} >\r\n		<label for="unavigation-link-type-1">URL</label>\r\n		<input type="text" name="unavigation-link-url" placeholder="http://www.example.com" class="upfront-field-text" id="unavigation-link-url" value="{{ menu_item_url }}" >\r\n	</div>\r\n	<div class="upfront-field-wrap">\r\n		<input type="radio" name="unavigation-link-type" value="post_type" class="upfront-field-radio" id="unavigation-link-type-2" {{menu_item_type == \'post_type\' ? \'checked = "checked"\' : \'\'}} >\r\n		<label for="unavigation-link-type-2">Page or post</label> \r\n		\r\n		<input type="radio" name="unavigation-link-type" value="anchor" class="upfront-field-radio" id="unavigation-link-type-3" {{menu_item_type == \'anchor\' ? \'checked = "checked"\' : \'\'}} >\r\n		<label for="unavigation-link-type-3">Anchor</label>\r\n	</div>\r\n	\r\n	<div class="upfront-settings-button_panel">\r\n		<button type="button" class="upfront-save_settings"><i class="icon-ok"></i> Ok</button>\r\n	</div>\r\n</script>\r\n</div>'}),function(e){define("unewnavigation",["text!elements/upfront-newnavigation/tpl/link_editor.html"],function(t){var n=e(t),r=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(Upfront.data.unewnavigation.defaults);e.element_id=Upfront.Util.get_unique_id(e.id_slug+"-object"),this.init_properties(e)}}),i=Backbone.View.extend({tagName:"li",linkTpl:_.template(n.find("#link-tpl").html()),events:{"click i.delete_menu_item":"deleteMenuItem","click i.navigation-add-item":"addMenuItem","contextmenu a.menu_item":"on_context_menu"},initialize:function(t){this.parent_view=t.parent_view,this.newitem=t.newitem;var n=this;_.bindAll(this,"render");var r=Upfront.Views.ContextMenuList.extend({initialize:function(){this.menuitems=_([new Upfront.Views.ContextMenuItem({get_label:function(){return"Visit URL"},action:function(){n.model["menu-item-type"]=="custom"?window.open(n.model["menu-item-url"]):window.location.href=n.model["menu-item-url"]}}),new Upfront.Views.ContextMenuItem({get_label:function(){return"Edit URL"},action:function(){e(n.event.target).addClass("new_menu_item"),n.parent_view.editMenuItem(n.$el.find("a.new_menu_item"))}}),new Upfront.Views.ContextMenuItem({get_label:function(){return"Create Drop-Down"},action:function(){n.createDropDown(n.event)}})])}});this.ContextMenu=Upfront.Views.ContextMenu.extend({initialize:function(){this.constructor.__super__.initialize.apply(this,arguments),this.menulists=_([new r])}}),Upfront.Events.on("entity:contextmenu:deactivate",this.remove_context_menu,this)},on_context_menu:function(t){t.stopPropagation();if(this.parent_view.$el.find("ul.menu").hasClass("edit_mode"))return;this.closeTooltip(),t.preventDefault(),this.event=t,context_menu_view=new this.ContextMenu({model:this.model,el:e(Upfront.Settings.LayoutEditor.Selectors.contextmenu)}),context_menu_view.for_view=this,this.context_menu_view=context_menu_view,context_menu_view.render()},remove_context_menu:function(t){if(!this.context_menu_view)return!1;e(Upfront.Settings.LayoutEditor.Selectors.contextmenu).html("").hide(),this.context_menu_view=!1},render:function(t){var n=this,r='<a class="menu_item';return n.newitem&&(r+=" new_menu_item menu_item_placeholder"),r=r+'" >'+this.model["menu-item-title"]+'</a><i class="delete_menu_item">x</i>',e(this.el).html(r),e(this.el).data("backboneview",n).addClass("menu-item"),n.newitem&&e(this.el).addClass("new_menu_item"),this},createDropDown:function(t){var n=e("<ul>").addClass("sub-menu").addClass("time_being_display");e(t.target).closest("li").append(n),this.parent_view.addMenuItem(n)},addMenuItem:function(e){e.preventDefault(),e.stopPropagation(),this.parent_view.addMenuItem(e)},deleteMenuItem:function(e){var t=this,n=t.$el.parent("ul"),r=t.$el.parent("ul").find("i.navigation-add-item");t.$el.remove(),n.children("li:last").append(r),typeof t.model["menu-item-db-id"]!="undefined"&&Upfront.Util.post({action:"upfront_delete_menu_item",menu_item_id:t.model["menu-item-db-id"],new_menu_order:t.parent_view.new_menu_order()}).success(function(e){}).error(function(e){Upfront.Util.log("Error Deleting Menu Item")})},editMenuItem:function(t){var n;typeof t.target=="undefined"?n=t:n=t.target;var r=this,i;i=e("<div/>").append(this.linkTpl({menu_item_type:r.model["menu-item-type"],menu_item_url:r.model["menu-item-url"]})).on("change","input[name=unavigation-link-type]",function(e){r.linkChanged(e)}).on("change","input[name=unavigation-link-url]",function(e){r.linkChanged(e)}).on("click","button.upfront-save_settings",function(t){r.model["menu-item-type"]=e("#unewnavigation-tooltip").find("input[name=unavigation-link-type]:checked").val(),r.model["menu-item-url"]=e("#unewnavigation-tooltip").find("input[name=unavigation-link-url]").val(),r.$el.children("div").length>0&&r.$el.children("div").children("a.menu_item").data("redactor")&&r.$el.children("div").children("a.menu_item").removeClass("ueditable").data("redactor").destroy(),r.parent_view.editModeOff(),r.saveLink(t),r.closeTooltip()}).on("click",".unewnavigation-change-link-post",function(e){r.linkChanged(e)}),this.openTooltip(i,e(n))},linkChanged:function(t){var n=this,r=e("#unewnavigation-tooltip").find("input[name=unavigation-link-type]:checked").val();if(r=="post_type"){if(r=="post_type"||t.type!="change"){var i={postTypes:this.postTypes()};Upfront.Views.Editor.PostSelector.open(i).done(function(t){var r=t.get("permalink");n.model["menu-item-type"]="post_type",n.model["menu-item-object"]=t.get("post_type"),n.model["menu-item-object-id"]=t.get("ID"),n.model["menu-item-url"]=r,e("#unewnavigation-tooltip").find("input[name=unavigation-link-url]").val(r)})}}else r=="custom"&&(n.model["menu-item-type"]="custom",n.model["menu-item-url"]=e("#unewnavigation-tooltip").find("input[name=unavigation-link-url]").val())},saveLink:function(t){var n=this;n.$el.find("a.new_menu_item").removeClass("new_menu_item"),n.$el.removeClass("new_menu_item"),n.$el.parent("ul").hasClass("time_being_display")&&n.$el.parent("ul").removeClass("time_being_display"),this.model["menu-item-title"]=e(this.el).children("a.menu_item").text();var r={action:"upfront_update_menu_item",menu:n.parent_view.model.get_property_value_by_name("menu_id"),"menu-item":this.model};typeof this.model["menu-item-db-id"]!="undefined"&&(r["menu-item-id"]=n.model["menu-item-db-id"]),Upfront.Util.post(r).success(function(e){n.model["menu-item-db-id"]=e.data}).error(function(e){Upfront.Util.log("Error updating menu item")})},openTooltip:function(t,n){var r=e("#unewnavigation-tooltip"),i=n.offset(),s={top:i.top+n.outerHeight(),left:i.left-125+Math.floor(n.outerWidth()/2)},o="unewnavigation-tooltip-bottom",u=this;r.length||(r=e('<div id="unewnavigation-tooltip" class="upfront-ui"></div>'),e("body").append(r)),r.hide().html(t),i.right=i.left+n.width(),i.left-280<0&&(s.left=i.left+n.width()+20,o="unewnavigation-tooltip-bottom"),r.css(s).addClass(o).show().on("click",function(e){e.stopPropagation()}).on("blur",function(e){console.log(e)}).on("closed",function(e){u.$el.removeClass("tooltip-open")}),this.$el.addClass("tooltip-open"),Upfront.Events.trigger("entity:settings:deactivate")},closeTooltip:function(){var t=e("#unewnavigation-tooltip");t.hide().trigger("closed"),setTimeout(function(){t.remove()},100)},postTypes:function(){var e=[];return _.each(Upfront.data.ugallery.postTypes,function(t){t.name!="attachment"&&e.push({name:t.name,label:t.label})}),e}}),s=Backbone.Model.extend({defaults:{id:!1,name:!1,url:!1,model_true:!0,menu_id:!1,menuList:!1}}),o=new s,u=Upfront.Views.ObjectView.extend({elementSize:{width:0,height:0},initialize:function(e){var t=this;this.editmode=!1,this.property("initialized",!1),this.model instanceof r||(this.model=new r({properties:this.model.get("properties")})),Upfront.Views.ObjectView.prototype.initialize.call(this),this.events=_.extend({},this.events,{"click a.menu_item":"exitEditMode","dblclick a.menu_item":"editMenuItem"});if(o.get("model_true")){this.getMenus();var n=this.model.get_property_value_by_name("menu_id");o.set({model_true:!1,menu_id:n}),n&&(Upfront.data.navigation.get_this_menu_items=Upfront.Util.post({action:"upfront_load_menu_items",data:o.get("menu_id")})),this.property("menu_items",!1)}this.on("deactivated",this.onDeactivate,this)},preventClick:function(e){e.preventDefault()},exitEditMode:function(t){e(t.target).hasClass("ueditable")||this.$el.find("a.ueditable").data("ueditor").stop()},editMenuItem:function(t){this.editModeOn(t);var n=this,r;typeof t.target=="undefined"||t.target.trim==""?r=t:r=t.target,e(r).closest("li").addClass("edit_mode"),e(r).data("ueditor")?(e(r).data("ueditor").start(),e(r).focus()):e(r).ueditor({linebreaks:!0,disableLineBreak:!0,focus:!0,tabFocus:!1,airButtons:!1,allowedTags:["h5"],placeholder:"Link Name"}).on("start",function(t){e(r).focus()}).on("keydown",function(t){t.which==9&&(t.preventDefault(),e(r).hasClass("new_menu_item")||(e(r).blur(),e(r).closest("ul").children("li:last").children("i.navigation-add-item").trigger("click"))),e(r).text().trim()!=""?e(r).removeClass("menu_item_placeholder"):e(r).addClass("menu_item_placeholder")}).on("blur",function(){e(r).data("ueditor").stop(),e(r).closest("li").removeClass("edit_mode"),e(r).hasClass("new_menu_item")||e(r).closest("li").data("backboneview").saveLink()}).on("stop",function(){n.editModeOff()}),e(r).hasClass("new_menu_item")&&_.delay(function(n){e(r).closest("li").data("backboneview").editMenuItem(t)},30,this)},editModeOn:function(t){this.$el.find(".upfront-object-content ul").each(function(){e(this).hasClass("ui-sortable")&&e(this).sortable("disable")})},editModeOff:function(){this.$el.find(".upfront-object-content ul.menu").hasClass("ui-sortable")&&this.$el.find(".upfront-object-content ul").sortable("enable")},onDeactivate:function(){this.editModeOff(),this.$el.find(".time_being_display").removeClass("time_being_display")},property:function(e,t,n){return typeof t!="undefined"?this.model.set_property(e,t,n):this.model.get_property_value_by_name(e)},getMenus:function(){var e=this;Upfront.Util.post({action:"upfront_load_menu_list"}).success(function(t){var n=_.map(t.data,function(e,t){return{label:e.name,value:e.term_id}});o.set({menuList:n}),e.property("menu_id")||e.display_menu_list()}).error(function(e){Upfront.Util.log("Error loading menu list")})},display_menu_list:function(){var e=this;e.$el.find("div.upfront-object-content").html("");var t=new Upfront.Views.Editor.Field.Select({model:e.model,label:"",className:"existing_menu_list",values:[{label:"Choose existing menu",value:0}].concat(o.get("menuList"))});t.render(),e.$el.find("div.upfront-object-content").append(t.el).append("<span> or </span>");var n=new Upfront.Views.Editor.Field.Text({model:e.model,label:"New Menu Name",className:"new_menu_name",compact:!0});n.render(),e.$el.find("div.upfront-object-content").append(n.el);var r=new Upfront.Views.Editor.Field.Button({model:e.model,label:"Create New",className:"new_menu_button",compact:!0});r.render(),e.$el.find("div.upfront-object-content").append(r.el),e.$el.find("div.upfront-object-content > div.existing_menu_list").on("mouseover",function(){e.$el.parent().parent().parent().draggable("disable")}),e.$el.find("div.upfront-object-content > div.existing_menu_list").on("mouseout",function(){e.$el.parent().parent().parent().draggable("enable")}),e.$el.find("div.upfront-object-content > div.new_menu_button > input").on("click",function(){e.$el.find("div.upfront-object-content > div.new_menu_name input").val()!=""&&e.create_new_menu(e.$el.find("div.upfront-object-content > div.new_menu_name input").val())}),e.$el.find("div.upfront-object-content > div.existing_menu_list input").on("change",function(){e.$el.parent().parent().parent().draggable("enable"),e.$el.find("div.upfront-object-content > div.existing_menu_list input:checked").val()!=0&&(e.property("initialized")||e.property("initialized",!0,!0),e.property("menu_id",e.$el.find("div.upfront-object-content > div.existing_menu_list input:checked").val()))})},create_new_menu:function(e){var t=this,n=Upfront.Util.post({action:"upfront_create_menu",menu_name:e}).success(function(e){t.property("menu_id",e.data),t.getMenus()}).error(function(e){Upfront.Util.log("Error creating menu")})},get_content_markup:function(){var e=this.model.get_property_value_by_name("menu_id"),t=this;return e?(Upfront.Util.post({action:"upfront_load_menu_array",data:e}).success(function(e){if(!e.data){t.$el.find(".upfront-object-content").html("Please add menu items");return}t.property("menu_items",e.data),t.generate_menu()}).error(function(e){Upfront.Util.log("Error loading menu")}),"Loading"):""},on_render:function(){this.property("menu_id")||this.display_menu_list();var e=this.property("menu_style"),t=this.property("menu_alignment"),n=this.property("allow_sub_nav"),r;r=this.$el.find(".upfront-object-content"),r.attr("data-aliment",t?t:"left"),r.attr("data-style",e?e:"horizontal"),r.attr("data-allow-sub-nav",n.length!==0&&n[0]=="yes"?n[0]:"no")},generate_menu:function(){var e=this,t=this.model.get_property_value_by_name("menu_id");if(!t)return;this.$el.find(".upfront-object-content").html(""),this.property("menu_items").length>0?this.$el.find(".upfront-object-content").append(this.renderMenu(this.property("menu_items"),"menu")):(this.$el.find(".upfront-object-content").append(this.renderMenu([e.menuItemTemplate()],"menu")),e.$el.find("ul.menu li.menu-item").addClass("new_menu_item").find("a.menu_item").addClass("new_menu_item").addClass("menu_item_placeholder"),e.editMenuItem(this.$el.find("a.new_menu_item"))),this.makeSortable()},makeSortable:function(){var e=this;this.$el.find(".upfront-object-content ul").sortable({stop:function(t,n){n.item.parent("ul").children("li:last").append(n.item.parent("ul").children("li").children("i.navigation-add-item")),e.saveMenuOrder()}})},saveMenuOrder:function(){var e=this;Upfront.Util.post({action:"upfront_update_menu_order",menu_items:e.new_menu_order()}).success(function(e){}).error(function(e){Upfront.Util.log("Error updating menu")})},new_menu_order:function(){var t=0,n=new Array;return this.$el.find(".upfront-object-content ul li").each(function(){e(this).parent().parent("li").length>0?e(this).data("backboneview").model["menu-item-parent-id"]=e(this).parent().parent("li").data("backboneview").model["menu-item-db-id"]:e(this).data("backboneview").model["menu-item-parent-id"]=0,n[t]={"menu-item-db-id":e(this).data("backboneview").model["menu-item-db-id"],"menu-item-parent-id":e(this).data("backboneview").model["menu-item-parent-id"]},e(this).data("backboneview").model["menu-item-position"]=t,t++}),n},renderMenu:function(t,n){var r=e("<ul>").addClass(n);return n=="menu"&&r.addClass("drag_mode"),t.forEach(function(e){r.append(this.renderMenuItem(e)),typeof e.sub!="undefined"&&r.find(":last").parent().addClass("parent").append(this.renderMenu(e.sub,"sub-menu"))},this),r.children("li:last").append('<i class="navigation-add-item"></i>'),r},renderMenuItem:function(e,t){var n=this;typeof t=="undefined"&&(t=!1);var r=new i({model:e,parent_view:n,newitem:t});return r.render().el},menuItemTemplate:function(){return{"menu-item-parent-id":"0","menu-item-target":"","menu-item-title":"","menu-item-type":"custom","menu-item-url":"http://#"}},addMenuItem:function(t){var n=this,r=!1,i=this.model.get_property_value_by_name("menu_id");n.$el.find("a.new_menu_item").removeClass("new_menu_item");var s=this.menuItemTemplate(),o;typeof t.target=="undefined"&&t.parent("li").length>0?(s["menu-item-parent-id"]=t.parent("li").data("backboneview").model["menu-item-db-id"],t.append(this.renderMenuItem(s,!0)),t.children("li:last").append('<i class="navigation-add-item"></i>')):(e(t.target).parent("li").parent("ul").parent("li").length>0&&(s["menu-item-parent-id"]=e(t.target).parent("li").parent("ul").parent("li").data("backboneview").model["menu-item-db-id"],e(t.target).parent("li").parent("ul").addClass("time_being_display")),e(t.target).parent("li").parent("ul").append(this.renderMenuItem(s,!0)),e(t.target).parent("li").next("li").append(t.target)),n.editMenuItem(n.$el.find("a.new_menu_item"))}}),a=Upfront.Views.Editor.Sidebar.Element.extend({priority:200,render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-newnavigation"),this.$el.html("New Navigation")},add_element:function(){var e=new r,t=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c22 upfront-newnavigation_module"},{name:"has_settings",value:0},{name:"row",value:5}],objects:[e]});this.add_module(t)}}),f=Upfront.Views.Editor.Settings.Panel.extend({save_settings:function(){f.__super__.save_settings.apply(this,arguments),this.model.set_property("menu_items",!1,!0)}}),l=Upfront.Views.Editor.Field.Text.extend({renameMenu:function(){var e=this.$el.find("input"),t=this,n=Upfront.Util.post({action:"upfront_rename_menu",new_menu_name:e.val(),menu_id:o.get("menu_id")}).success(function(e){t.getMenus()}).error(function(e){})},getMenus:function(){var e=this;Upfront.Util.post({action:"upfront_load_menu_list"}).success(function(t){var n=_.map(t.data,function(e){return{label:e.name,value:e.term_id}});o.set({menuList:n}),e.trigger("panel:set")}).error(function(e){Upfront.Util.log("Error loading menu list")})}}),c=Upfront.Views.Editor.Settings.Settings.extend({initialize:function(){this.panels=_([new f({model:this.model,label:"Menu",title:"Menu settings",settings:[new Upfront.Views.Editor.Settings.Item({model:this.model,title:"This Menu",fields:[new l({model:this.model,property:"menu_name",label:"Menu Name",value:"Menu dfdf Name",compact:!0})]}),new Upfront.Views.Editor.Settings.Item({model:this.model,title:"Select Menu",fields:[new Upfront.Views.Editor.Field.Select({model:this.model,property:"menu_id",label:"",values:o.get("menuList")})]})]}),new Upfront.Views.Editor.Settings.Panel({model:this.model,label:"Layout",title:"Layout settings",settings:[new Upfront.Views.Editor.Settings.Item({model:this.model,title:"Menu Style",fields:[new Upfront.Views.Editor.Field.Radios({model:this.model,property:"menu_style",default_value:"horizontal",label:"",layout:"vertical",values:[{label:"Horizontal",value:"horizontal",icon:"navigation-horizontal"},{label:"Vertical",value:"vertical",icon:"navigation-vertical"}]})]}),new Upfront.Views.Editor.Settings.Item({model:this.model,title:"Menu Alignment",fields:[new Upfront.Views.Editor.Field.Radios({model:this.model,property:"menu_alignment",default_value:"left",label:"",layout:"vertical",values:[{label:"Left",value:"left",icon:"navigation-left"},{label:"Center",value:"center",icon:"navigation-center"},{label:"Right",value:"right",icon:"navigation-right"}]})]}),new Upfront.Views.Editor.Settings.Item({model:this.model,title:"Misc. Settings",fields:[new Upfront.Views.Editor.Field.Checkboxes({model:this.model,property:"allow_sub_nav",label:"",default_value:["no"],values:[{label:"Allow subnavigation on hover",value:"yes"}]}),new Upfront.Views.Editor.Field.Checkboxes({model:this.model,property:"allow_new_pages",label:"",values:[{label:"Add new Pages to this menu",value:"yes"}]}),new Upfront.Views.Editor.Field.Checkboxes({model:this.model,property:"is_floating",label:"",values:[{label:"Allow floating...",value:"yes"}]})]})]})])},get_title:function(){return"Navigation settings"}});Upfront.Application.LayoutEditor.add_object("Unewnavigation",{Model:r,View:u,Element:a,Settings:c}),Upfront.Models.UnewnavigationModel=r,Upfront.Views.UnewnavigationView=u})}(jQuery),function(e){define("uposts",[],function(){var t={};Upfront.Util.post({action:"uposts_list_initial_info"}).success(function(e){t=e.data});var n=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(Upfront.data.uposts.defaults);e.element_id=Upfront.Util.get_unique_id("uposts-object"),this.init_properties(e)}}),r=Upfront.Views.ObjectView.extend({changed:!1,markup:!1,editors:{},initialize:function(e){this.model instanceof n||(this.model=new n({properties:this.model.get("properties")})),this.events=_.extend({},this.events,{"click .uposts-pagination>a":"paginate"}),this.page=1,this.model.on("region:updated",this.refreshMarkup,this),this.listenTo(this.model.get("properties"),"change",this.refreshMarkup),console.log("Posts element")},get_content_markup:function(){return this.changed||!this.markup?(this.parent_module_view.region.get("name")!="shadow"&&this.refreshMarkup(),"Loading"):this.markup},on_render:function(){var e=this;setTimeout(function(){e.updateEditors()},100)},refreshMarkup:function(t){var n=this.model.get("properties").toJSON(),r={},i=this,s="#"+this.property("element_id"),o=new Upfront.Views.Editor.Loading({loading:"Refreshing ...",done:"Here we are!",fixed:!0});t||(t=1),r.page=t,_.each(n,function(e){r[e.name]=e.value}),o.render(),e("#page").append(o.$el),window._upfront_get_current_query?r.query=_upfront_get_current_query():r.query={},Upfront.Util.post({action:"uposts_get_markup",data:JSON.stringify(r)}).success(function(t){i.markup=t.data,e(s).find(".upfront-object-content").html(i.get_content_markup()),o.$el.remove(),i.updateEditors()})},updateEditors:function(){var t=this,n=e("#"+this.property("element_id")).find(".uposts-post"),r=this.property("content_type")=="excerpt";n.each(function(){var n=e(this),i=n.data("post_id");t.editors[i]?t.editors[i].updateElement(n):t.editors[i]=new Upfront.Content.editor({editor_id:"uposts_meta_"+i,post_id:i,node:n,content_mode:r?"post_excerpt":"post_content",view:t,onUpdated:function(e){t.onPostUpdated(e)},autostart:!1})})},onPostUpdated:function(t){var n=new Upfront.Views.Editor.Loading({loading:"Refreshing post ...",done:"Here we are!",fixed:!1}),r=e("#"+this.property("element_id")).find("[data-post_id="+t.ID+"]"),i=this;if(r.length){n.render(),r.append(n.$el);var s={},o=this.model.get("properties").toJSON();_.each(o,function(e){s[e.name]=e.value}),Upfront.Util.post({action:"uposts_single_markup",data:{post:t,properties:s}}).success(function(e){n.$el.remove(),n=!1,r.html(e.data),i.editors[t.ID].updateElement(r)})}},paginate:function(e){console.log("Paginating!"+e.target.search);var t=e.target.search;t&&t.match(/^\?paged=\d+$/)&&this.refreshMarkup(t.replace("?paged=",""))},property:function(e,t,n){return typeof t!="undefined"?(typeof n=="undefined"&&(n=!0),this.model.set_property(e,t,n)):this.model.get_property_value_by_name(e)}}),i=Upfront.Views.Editor.Sidebar.Element.extend({priority:60,render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-posts"),this.$el.html("Posts")},add_element:function(){var e=new n,t=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c22 upfront-posts_module"},{name:"has_settings",value:0},{name:"row",value:25}],objects:[e]});this.add_module(t)}}),s=Upfront.Views.Editor.Settings.Panel.extend({initialize:function(){var e=new u({model:this.model}),t=new a({model:this.model}),n=Upfront.Views.Editor.Settings.Item,r=Upfront.Views.Editor.Field;this.settings=_([new o({model:this.model}),e,t,new f({model:this.model}),new n({title:"Pagination",fields:[new r.Radios({model:this.model,property:"pagination",values:[{label:"No pagination",value:0},{label:"Previous/next page",value:"prevnext"},{label:"Numeric",value:"numeric"}]})]})]),e.on("uposts:taxonomy:changed",t.generate_term_markup,t)},get_label:function(){return"Query"},get_title:function(){return"Query settings"}}),o=Upfront.Views.Editor.Settings.Item.extend({initialize:function(){var e=[];_(t.post_types).each(function(t,n){e.push({label:t,value:n})}),this.fields=_([new Upfront.Views.Editor.Field.Select({model:this.model,property:"post_type",values:e})])},get_title:function(){return"Post Type"}}),u=Upfront.Views.Editor.Settings.Item.extend({events:function(){return _.extend({},Upfront.Views.Editor.Settings.Item.prototype.events,{click:"register_change"})},initialize:function(){var e=[];_(t.taxonomies).each(function(t,n){e.push({label:t,value:n})}),this.fields=_([new Upfront.Views.Editor.Field.Select({model:this.model,property:"taxonomy",values:e})])},register_change:function(){this.fields.each(function(e){e.property.set({value:e.get_value()},{silent:!1})}),this.trigger("uposts:taxonomy:changed")},get_title:function(){return"Taxonomy"}}),a=Upfront.Views.Editor.Settings.Item.extend({initialize:function(){this.fields=_([new Upfront.Views.Editor.Field.Select({model:this.model,property:"term",values:[{label:"Please, select a taxonomy",value:"",disabled:!0}]})]),this.generate_term_markup()},get_title:function(){return"Term"},generate_term_markup:function(){var e=this;this.reset_fields(function(){e.$el.empty(),e.render()})},reset_fields:function(e){var t=this,n=this.model.get_property_value_by_name("taxonomy");if(!n)return!1;Upfront.Util.post({action:"upost_get_taxonomy_terms",taxonomy:n}).success(function(n){var r=[];_(n.data).each(function(e,t){r.push({label:e,value:t})}),t.fields=_([new Upfront.Views.Editor.Field.Select({model:t.model,property:"term",values:r})]),e&&e.apply(this)})}}),f=Upfront.Views.Editor.Settings.Item.extend({initialize:function(){var e=[];_(_.range(20)).each(function(t){e.push({label:t,value:t})}),this.fields=_([new Upfront.Views.Editor.Field.Select({model:this.model,property:"limit",values:e})])},get_title:function(){return"Limit"}}),l=Upfront.Views.Editor.Settings.Panel.extend({initialize:function(){this.settings=_([new c({model:this.model})])},get_label:function(){return"Post"},get_title:function(){return"Post settings"}}),c=Upfront.Views.Editor.Settings.Item.extend({initialize:function(){this.fields=_([new Upfront.Views.Editor.Field.Radios({model:this.model,property:"content_type",values:[{label:"Full",value:"full"},{label:"Excerpt",value:"excerpt"}]})])},get_title:function(){return"Content"}}),h=Upfront.Views.Editor.Settings.Item.extend({initialize:function(){this.fields=_([new Upfront.Views.Editor.Field.Radios({model:this.model,property:"featured_image",layout:"vertical",values:[{label:"Yes",value:"1"},{label:"No",value:"0"}]})])},get_title:function(){return"Show featured image?"}}),p=Upfront.Views.Editor.Settings.Settings.extend({initialize:function(){var e=new Upfront.data.thisPost.PostDataPanel({model:this.model});e.label="Elements",this.panels=_([new s({model:this.model}),new l({model:this.model}),e])},get_title:function(){return"Posts settings"}});Upfront.Application.LayoutEditor.add_object("Uposts",{Model:n,View:r,Element:i,Settings:p}),Upfront.Models.UpostsModel=n,Upfront.Views.UpostsView=r})}(jQuery),function(e){define("usearch",[],function(){var t=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(Upfront.data.usearch.defaults);e.element_id=Upfront.Util.get_unique_id(e.id_slug+"-object"),this.init_properties(e)}}),n=Upfront.Views.ObjectView.extend({initialize:function(e){this.model instanceof t||(this.model=new t({properties:this.model.get("properties")})),this.constructor.__super__.initialize.call(this,[e])},get_content_markup:function(){var e=this.model.get_property_value_by_name("placeholder"),t=e||"Search",n=this.model.get_property_value_by_name("label"),r='<i class="icon-search"></i>';return'<input type="search" name="s" class="search-field" value="" placeholder="'+(e?t:"")+'" />'+(n!=""?'<button class="search-button'+(n=="__image__"||!n?" image":"")+'">'+(n=="__image__"||!n?r:n)+"</button>":"")},on_render:function(){var e=this.model.get_property_value_by_name("is_rounded"),t=this.model.get_property_value_by_name("color"),n=this.$el.find(".upfront-editable_entity:first");e==1?n.addClass("rounded"):n.removeClass("rounded"),t?n.css("background-color",t):n.css("background-color","")}}),r=Upfront.Views.Editor.Sidebar.Element.extend({priority:200,render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-search"),this.$el.html("Search")},add_element:function(){var e=new t,n=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c6 upfront-search_module"},{name:"has_settings",value:0},{name:"row",value:5}],objects:[e]});this.add_module(n)}}),i=Upfront.Views.Editor.Settings.Panel.extend({initialize:function(){this.settings=_([new s({model:this.model}),new o({model:this.model})])},get_label:function(){return"Field"},get_title:function(){return"Field settings"}}),s=Upfront.Views.Editor.Settings.Item.extend({render:function(){var t=this,n=this.model.get_property_value_by_name("placeholder"),r=n||"Search";this.wrap({title:"Placeholder",markup:'<input type="radio" id="search-placeholder-none" name="search_placeholder" value="" '+(n?"":'checked="checked"')+" /> None"+"<br />"+'<input type="radio" id="search-placeholder-normal" name="search_placeholder" value="'+r+'" '+(n?'checked="checked"':"")+" /> "+'<span class="search-search_placeholder'+(n?" active":"")+'" contenteditable="true">'+r+"</span>"}),this.$el.find(".search-search_placeholder").on("click",function(){e(this).trigger("input")}),this.$el.find(".search-search_placeholder").on("input",function(){e("#search-placeholder-normal").val(e(this).text()).attr("checked",!0),e(this).addClass("active")}),this.$el.on("change","#search-placeholder-normal, #search-placeholder-none",function(){e(this).attr("id")=="search-placeholder-normal"&&e(this).prop("checked")?t.$el.find(".search-search_placeholder").addClass("active"):t.$el.find(".search-search_placeholder").removeClass("active")})},get_name:function(){return"placeholder"},get_value:function(){var e=this.$el.find(':radio[name="search_placeholder"]:checked');return e.length?e.val():0}}),o=Upfront.Views.Editor.Settings.Item.extend({render:function(){var t=this,n=this.model.get_property_value_by_name("label"),r="__image__"==n||""==n||!n?"Custom text":n,i='<label for="search_type-image"><i class="icon-search"></i> Image</label>',s='<span class="search-search_text'+(n!=""&&n!="__image__"?" active":"")+'" contenteditable="true">'+r+"</span>";this.wrap({title:"Button content",markup:'<input type="radio" id="search_type-image" name="search_type" value="__image__" '+(n=="__image__"?'checked="checked"':"")+" /> "+i+"<br />"+'<input type="radio" id="search_type-text" name="search_type" value="'+r+'" '+(n!=""&&n!="__image__"?'checked="checked"':"")+" /> "+s+"<br />"+'<input type="radio" id="search_type-none" name="search_type" value="" '+(n==""?'checked="checked"':"")+" /> <span>No Button</span>"}),this.$el.find(".search-search_placeholder").on("click",function(){e(this).trigger("input")}),this.$el.find(".search-search_text").on("input",function(){e("#search_type-text").val(e(this).text()).attr("checked",!0),e(this).addClass("active")}),this.$el.on("change","#search_type-image, #search_type-text, #search_type-none",function(){e(this).attr("id")=="search_type-text"&&e(this).prop("checked")?t.$el.find(".search-search_text").addClass("active"):t.$el.find(".search-search_text").removeClass("active")})},get_name:function(){return"label"},get_value:function(){var e=this.$el.find(':radio[name="search_type"]:checked');return e.length?e.val():"__image__"}}),u=Upfront.Views.Editor.Settings.Settings.extend({initialize:function(){this.panels=_([new i({model:this.model})])},get_title:function(){return"Search settings"}});Upfront.Application.LayoutEditor.add_object("Usearch",{Model:t,View:n,Element:r,Settings:u}),Upfront.Models.UsearchModel=t,Upfront.Views.UsearchView=n})}(jQuery),define("text!elements/upfront-slider/tpls/uslider.html",[],function(){return"<div class=\" uslider uslider-<?php echo $controlsWhen ?> uslider-<?php echo $style ?> uslider-<?php echo $transition ?> <?php echo $captionUseBackground == '1' ? 'uslider-caption-background' : '' ?>\" id=\"uslider-<?php echo $element_id ?>\">\n	<?php if($slidesLength){ ?>\n	<div class=\"uslides\">\n		<?php for($i=0; $i<$slidesLength; $i++) { ?>\n		<div class=\"uslide uslide-<?php echo $slides[$i]['style'] ?>\"\n			<?php if($primaryStyle != 'notext'){ ?>\n				data-caption-selector=\"#uslider-<?php echo $element_id ?> .caption-<?php echo $slides[$i]['id'] ?>\"\n			<?php } ?>\n			rel=\"<?php echo $slides[$i]['id'] ?>\">\n\n			<?php if($slides[$i]['url']){ ?>\n			<a href=\"<?php echo $slides[$i]['url'] ?>\" class=\"uslider-link uslide-image\">\n			<?php } else { ?>\n			<div class=\"uslide-image\">\n			<?php } ?>\n				<img src=\"<?php echo $slides[$i]['src'] ?>\" style=\"min-width:100%, min-height:100%\">\n			<?php if($slides[$i]['url']){ ?>\n			</a>\n			<?php } else { ?>\n			</div>\n			<?php } ?>\n\n		</div>\n		<?php } ?>\n	</div>\n	<?php if($primaryStyle != 'notext'){ ?>\n	<div class=\"uslider-texts\">\n		<?php for($i=0; $i<$slidesLength; $i++) { ?>\n		<div class=\"uslide-text caption-<?php echo $slides[$i]['id'] ?>\" rel=\"<?php echo $slides[$i]['id'] ?>\" style=\"background-color:<?php echo $captionUseBackground == '1' ? $slides[$i]['captionBackground'] : 'transparent' ?>;color:<?php echo $slides[$i]['captionColor'] ?>\">\n			<div class=\"uslide-editable-text\" placeholder=\"Slider description\">\n				<?php echo $slides[$i]['text'] ?>\n			</div>\n		</div>\n		<?php } ?>\n	</div>\n	<?php } ?>\n	<?php } else { ?>\n	<!-- No images in this slider -->\n	<?php } ?>\n</div>\n\n<style type=\"text/css\">\n	#uslider-<?php echo $element_id ?> .uslide-caption {\n		width: <?php echo $textWidth ?>;\n		<?php echo $captionUseBackground ? 'padding: 5px 15px;' : '' ?>\n	}\n\n	#uslider-<?php echo $element_id ?> .uslide-right .uslide-caption {\n		margin-left: <?php echo $imageWidth ?>;\n	}\n\n	#uslider-<?php echo $element_id ?> .uslide-right .uslide-image {\n		float: left;\n	}\n\n	#uslider-<?php echo $element_id ?> .uslide-left .uslide-caption {\n		float: left;\n	}\n\n	#uslider-<?php echo $element_id ?> .uslide-left .uslide-image {\n		margin-left: <?php echo $textWidth ?>\n	}\n	#uslider-<?php echo $element_id ?> .uslide-left .uslide-caption,\n	#uslider-<?php echo $element_id ?> .uslide-right .uslide-caption {\n		height: <?php echo $imageHeight ?>px;\n	}\n\n	#uslider-<?php echo $element_id ?> .uslide-left .uslide-image,\n	#uslider-<?php echo $element_id ?> .uslide-right .uslide-image {\n		width: <?php echo $imageWidth ?>;\n	}\n\n	#uslider-<?php echo $element_id ?> .uslide-image {\n		height: <?php echo $imageHeight ?>px;\n		position: relative;\n		overflow: hidden;\n	}\n\n	#uslider-<?php echo $element_id ?> .uslide-caption {\n		background-color:<?php echo $captionUseBackground == '1' ? $captionBackground : 'transparent' ?>;\n	}\n</style>\n\n<script>\njQuery(function($){\n	var slider = $('#uslider-<?php echo $element_id ?>'),\n		options = {\n			item: '.uslide',\n			auto: <?php echo $rotate ?>,\n			auto_height: <?php echo $production ?>,\n			adjust_slide_size: <?php echo $production ?>,\n			effect: '<?php echo $transition ?>',\n			interval: <?php echo $rotateTime * 1000 ?>,\n			show_control: '<?php echo $controlsWhen ?>',\n			control_num: <?php echo $dots && $production ?>,\n			control_next_prev: <?php echo $arrows && $production ?>,\n			starting_slide: <?php echo $startingSlide ?>,\n			caption_height: <?php echo $primaryStyle == 'below' ? 1 : 0 ?>\n		}\n	;\n	slider.find('.uslides').upfront_default_slider(options);\n\n	slider.find('.uslide-above').each(function(){\n		var slide = $(this);\n		slide.find('.uslide-caption').remove().prependTo(slide);\n	});\n	slider.find('.uslide-left').each(function(){\n		var slide = $(this);\n		slide.find('.uslide-caption').remove().prependTo(slide);\n	});\n});\n</script>"}),define("text!elements/upfront-slider/tpls/backend.html",[],function(){return'<div>\n<script type="text/template" id="link-tpl">\n	<input type="hidden" id="uslider-slide-id" value="{{id}}">\n	<h3>Links to:</h3>\n	<div class="upfront-field-wrap">\n		<input type="radio" name="ugallery-image-link" value="external" class="upfront-field-radio" id="ugallery-image-link-1" {{urlType == \'external\' ? checked : \'\'}}>\n		<label for="ugallery-image-link-1">External link</label>\n		<input type="text" value="{{url}}" id="ugallery-image-link-url" placeholder="Type link URL" style="{{urlType != \'external\' ? \'display:none\' : \'\'}}" class="upfront-field-text">\n	</div>\n	<div class="upfront-field-wrap">\n		<input type="radio" name="ugallery-image-link" value="post" class="upfront-field-radio" id="ugallery-image-link-2" {{urlType == \'post\' ? checked : \'\'}}>\n		<label for="ugallery-image-link-2">Link to a post or page</label>\n		<a title="Change link" class="ugallery-change-link-post" style="{{urlType != \'post\' ? \'display:none\' : \'\'}}">{{url}}</a>\n	</div>\n	<div class="upfront-settings-button_panel">\n		<button type="button" class="upfront-save_settings"><i class="icon-ok"></i> Ok</button>\n	</div>\n</script>\n\n<script type="text/template" id="slides-setting-tpl">\n<div class="uslider-slides-setting">\n{[ slides.each(function(slide){ ]}\n<div class="uslider_content_imgslide uslider_content_imgslide  uslider_content_slide" rel="{{slide.id}}">\n		<img src="{{slide.get(\'src\')}}" />\n	</div>\n{[ }) ]}\n<div class="uslider-add upfront-region-bg-slider-add-image upfront-icon upfront-icon-region-add-slide">Add Slide</div>\n</div>\n</script>\n\n\n<script type="text/template" id="startingTpl">\n	<div class="upfront-image-starting-select upfront-ui" style="min-height:{{startingHeight}}px">\n		<div class="uslider-starting-centered">\n			<div class="uslider-starting-title">Please choose the type of slider</div>\n			<div class="uslider-starting-info">This can later be cahanged via the settings panel</div>\n			<div class="uslider-starting-options">\n				<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline">\n					<input type="radio" class="upfront-field-radio" checked="checked" id="uslider-starting-notext" value="notext" name="upfront-starting-style">\n					<label for="uslider-starting-notext">\n						<i class="upfront-field-icon upfront-field-icon-nocaption"></i>\n						<span class="upfront-field-label-text">img only</span>\n					</label>\n				</span>\n				<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline">\n					<input type="radio" class="upfront-field-radio" id="uslider-starting-over" value="over" name="upfront-starting-style">\n					<label for="uslider-starting-over">\n						<i class="upfront-field-icon upfront-field-icon-bottomOver"></i>\n						<span class="upfront-field-label-text">txt over img</span>\n					</label>\n				</span>\n				<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline">\n					<input type="radio" class="upfront-field-radio" id="uslider-starting-below" value="below" name="upfront-starting-style">\n					<label for="uslider-starting-below">\n						<i class="upfront-field-icon upfront-field-icon-below"></i>\n						<span class="upfront-field-label-text">txt below img</span>\n					</label>\n				</span>\n				<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline">\n					<input type="radio" class="upfront-field-radio" id="uslider-starting-side" value="side" name="upfront-starting-style">\n					<label for="uslider-starting-side">\n						<i class="upfront-field-icon upfront-field-icon-right"></i>\n						<span class="upfront-field-label-text">txt on the side</span>\n					</label>\n				</span>\n				<!--\n				<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline">\n					<input type="radio" class="upfront-field-radio" id="uslider-starting-onlytext" value="onlytext" name="upfront-starting-style">\n					<label for="uslider-starting-onlytext">\n						<i class="upfront-field-icon upfront-field-icon-nocaption"></i>\n						<span class="upfront-field-label-text">txt / widget only</span>\n					</label>\n				</span>\n				-->\n			</div>\n			<a href="#" class="button upfront-image-select">Choose Images</a>\n		</div>\n	</div>\n</script>\n\n\n</div>\n'}),function(e){define("upfront_slider",["text!elements/upfront-slider/tpls/uslider.html","text!elements/upfront-slider/tpls/backend.html"],function(t,n){var r=Backbone.Model.extend({defaults:Upfront.data.uslider.slideDefaults}),i=Backbone.Collection.extend({model:r}),s=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(Upfront.data.uslider.defaults);e.element_id=Upfront.Util.get_unique_id(e.id_slug+"-object"),this.init_properties(e)}}),o=Upfront.Views.ObjectView.extend({self:{},module_settings:{},tpl:Upfront.Util.template(t),linkTpl:_.template(e(n).find("#link-tpl").html()),startingTpl:_.template(e(n).find("#startingTpl").html()),initialize:function(e){var t=this;console.log("Uslider"),this.model instanceof s||(this.model=new s({properties:this.model.get("properties")})),console.log("Uslider"),this.constructor.__super__.initialize.call(this,[e]),this.events=_.extend({},this.events,{"click .upfront-image-select":"firstImageSelection","click .upfront-icon-next":"nextSlide","click .upfront-icon-prev":"prevSlide","click .uslider-starting-options":"checkStartingInputClick"});var n=this.property("slides");this.slides=new i(n),this.listenTo(this.slides,"add remove reset change",this.slidesChange),this.listenTo(this.model,"addRequest",this.openImageSelector),this.lastStyle=this.property("primaryStyle"),this.listenTo(this.model.get("properties"),"change",this.checkStyles),this.listenTo(this.model,"background",function(e){t.slides.each(function(t){t.set("captionBackground",e)})}),this.listenTo(Upfront.Events,"command:layout:save",this.saveResizing),this.listenTo(Upfront.Events,"command:layout:save_as",this.saveResizing),this.imageProps={},this.cropHeight=!1,this.cropTimer=!1,this.cropTimeAfterResize=1e4,this.currentSlide=0},on_edit:function(){return!1},get_content_markup:function(){var t=this,n=this.extract_properties(),r={};if(!this.slides.length)return this.startingHeight=this.startingHeight||225,this.startingTpl({startingHeight:this.startingHeight});n.rotate=!1,n.dots=_.indexOf(["dots","both"],n.controls)!=-1,n.arrows=_.indexOf(["arrows","both"],n.controls)!=-1,this.slides=new i(this.property("slides")),n.slides=this.slides.toJSON(),n.slidesLength=n.slides.length,n.imageWidth=n.primaryStyle=="side"?Math.round(n.rightImageWidth/n.rightWidth*100)+"%":"100%",n.textWidth=n.primaryStyle=="side"?Math.round((n.rightWidth-n.rightImageWidth)/n.rightWidth*100)+"%":"100%",n.imageHeight="100%";if(n.slides.length){var s=t.imageProps[n.slides[0].id];s?n.imageHeight=s.size.height:n.imageHeight=n.slides[0].cropSize.height}n.production=!1,n.startingSlide=this.currentSlide,r=this.tpl(n);var o=e("<div></div>").append(r);return this.slides.each(function(e){t.imageProps[e.id]||(t.imageProps[e.id]={size:e.get("size"),cropOffset:e.get("cropOffset"),cropSize:e.get("cropSize")});var n=t.imageProps[e.id],r=o.find(".uslide[rel="+e.id+"]").height(n.size.height).find("img");r.attr("src",e.get("srcFull")).css({position:"absolute",width:n.size.width,height:n.size.height,top:0-n.cropOffset.top,left:0-n.cropOffset.left,"max-width":"none","max-height":"none"}).parent().css({position:"relative",height:t.cropHeight||e.get("cropSize").height,overflow:"hidden"})}),o.html()},on_render:function(){var t=this;t.parent_module_view.$el.data("resizeHandling")||t.parent_module_view.$el.on("resizestart",e.proxy(t.onElementResizeStart,t)).on("resize",e.proxy(t.onElementResizing,t)).on("resizestop",e.proxy(t.onElementResize,t)).data("resizeHandling",!0);if(!this.slides.length)return;this.$el.parent().length?t.prepareSlider():setTimeout(function(){t.on_render()},100)},prepareSlider:function(){var t=this,n=t.$(".uslide-image"),r=t.createControls(),i=t.$(".uslide-editable-text"),s=t.slides.at(t.currentSlide);r.setWidth(n.width()),r.render(),t.$(".uslides").append(e('<div class="uimage-controls upfront-ui" rel="'+s.id+'"></div>').append(r.$el)),t.onSlideShow(),this.controls=r,t.$(".uslide").css({height:"auto"}),t.$(".uslide-editable-text").data("ueditor")||t.$(".uslide-editable-text").ueditor({autostart:!1,upfrontMedia:!1,upfrontImages:!1,placeholder:"Slide description"}).on("start",function(){var n=e(this),r=n.closest(".uslide").attr("rel"),i=t.slides.get(r);t.$el.addClass("upfront-editing"),n.on("syncAfter",function(){i.set("text",n.html(),{silent:!0})}).on("stop",function(){i.set("text",n.html()),t.property("slides",t.slides.toJSON()),t.$el.removeClass("upfront-editing")})}),t.property("primaryStyle")=="side"&&t.setImageResizable();var o=this.property("primaryStyle")=="below"?this.$(".uslide[rel="+s.id+"]").find(".uslide-caption").outerHeight():0;t.$(".uslides").height(n.height()+o)},updateControls:function(){this.controls.remove();var e=this.createControls();e.render(),this.$(".uimage-controls").append(e.$el).attr("rel",this.slides.at(this.currentSlide).id),this.controls=e},get_buttons:function(){return this.property("slides").length?'<a href="#" class="upfront-icon-button upfront-icon-button-nav upfront-icon-next"></a><a href="#" class="upfront-icon-button upfront-icon-button-nav upfront-icon-prev"></a>':""},nextSlide:function(e){e.preventDefault(),this.$(".uslides").upfront_default_slider("next")},prevSlide:function(e){e.preventDefault(),this.$(".uslides").upfront_default_slider("prev")},checkStyles:function(){var e=this,t=this.property("primaryStyle"),n={below:"below",over:"bottomOver",side:"right"};t!=this.lastStyle&&(this.slides.each(function(r){var i=r.get("style");(t=="below"&&_.indexOf(["below","above"],i)==-1||t=="over"&&_.indexOf(["topOver","bottomOver","topCover","middleCover","bottomCover"],i)==-1||t=="side"&&_.indexOf(["right","left"],i)==-1)&&r.set("style",n[t]);if(t=="side"||e.lastStyle=="side"){var s=e.$(".uslide[rel="+r.id+"]").find(".uslide-image");e.imageProps[r.id]=e.calculateImageResize({width:s.width(),height:s.height()},r)}}),(t=="side"||this.lastStyle=="side")&&this.setTimer(),this.lastStyle=t,this.slidesChange())},checkStartingInputClick:function(e){e.stopPropagation()},firstImageSelection:function(e){e.preventDefault();var t=this.$el.find("input:checked").val(),n="nocaption";return t=="over"?n="bottomOver":t=="below"?n="below":t=="side"&&(n="right"),this.property("primaryStyle",t),this.property("style",n),this.openImageSelector()},setImageResizable:function(){var e=this,t=this.$(".upfront-default-slider-item-current"),n=t.find(".uslide-image"),r=e.$(".upfront-object").outerWidth(),i,s,o=t.find(".uslide-caption"),u=t.attr("rel"),a=this.slides.get(u),f=!1,l=a.get("style");this.$(".ui-resizable").resizable("destroy");if(l=="nocaption")return;n.resizable({handles:l=="right"?"e":"w",helper:"uslider-resize-handler",start:function(t,o){if(!o.element.hasClass("uslide-image"))return;r=e.$(".upfront-object").outerWidth(),i=e.get_element_columns(),s=e.get_element_max_columns_px()/e.get_element_max_columns(),f=n.height(),o.element.parent().closest(".ui-resizable").resizable("disable"),n.resizable("option",{minWidth:s*3,maxWidth:(i-3)*s,grid:[s,100],handles:l=="right"?"e":"w",helper:"uslider-resize-handler",minHeigth:f,maxHeight:f})},resize:function(t,i){if(!i.element.hasClass("uslide-image"))return;var s=i.helper.width(),u=r-s-30,f={width:u},c={width:s};e.calculateImageResize({width:s,height:i.element.height()},a),l=="right"?f["margin-left"]=s:c["margin-left"]=u,o.css(f),n.css(c)},stop:function(t,r){if(!r.element.hasClass("uslide-image"))return;var o=r.helper.width(),u=o>(i-3)*s?(i-3)*s:o<3*s?3*s:o,a=Math.round((u-(s-15))/s)+1,f=Math.floor(a/i*100);n.css({width:f+"%"}),e.slides.each(function(t){t.get("style")!="nocaption"&&(e.imageProps[t.id]=e.calculateImageResize({width:n.width(),height:r.element.height()},t))}),e.cropHeight=r.element.height(),e.property("rightWidth",i,!0),e.property("rightImageWidth",a,!1),e.setTimer(),e.parent_module_view.$el.children(".upfront-module").resizable("enable")}})},setTimer:function(){var e=this;e.cropTimer&&(clearTimeout(e.cropTimer),e.cropTimer=!1),e.cropTimer=setTimeout(function(){var t=e.slides.at(e.currentSlide),n=e.$(".uslide[rel="+t.id+"]").find(".uslide-editable-text");n.length&&n.data("redactor")?n.on("stop",function(){e.saveTemporaryResizing(),console.log("delayedResizingTimer")}):(e.saveTemporaryResizing(),console.log("resizingTimer"))},e.cropTimeAfterResize)},onSlideShow:function(){var e=this;this.$(".uslides").on("slidein",function(t,n,r){n&&(e.currentSlide=r,e.updateControls(),e.$(".uimage-controls").attr("rel",n.attr("rel")),e.property("primaryStyle")=="side"&&e.setImageResizable(),e.property("primaryStyle")=="below"&&e.$(".uslides").height(n.find(".uslide-image").outerHeight()+n.find(".uslide-caption").outerHeight()))})},createControls:function(){var e=this,t=new Upfront.Views.Editor.InlinePanels.ControlPanel,n={above:["above","Above the image"],below:["below","Below the image"],nocaption:["nocaption","No text"]},r={topOver:["topOver","Over image, top"],bottomOver:["bottomOver","Over image, bottom"],topCover:["topCover","Covers image, top"],middleCover:["middleCover","Covers image, middle"],bottomCover:["bottomCover","Covers image, bottom"],nocaption:["nocaption","No text"]},i={right:["right","At the right"],left:["left","At the left"],nocaption:["nocaption","No text"]},s=this.property("primaryStyle"),o={},u=new Upfront.Views.Editor.InlinePanels.TooltipControl,a=[],f=this.slides.at(this.currentSlide);return u.sub_items={},s=="below"?o=n:s=="over"?o=r:s=="side"?o=i:o=!1,o&&(_.each(o,function(t,n){u.sub_items[n]=e.createControl(t[0],t[1])}),u.icon="caption",u.tooltip="Caption position",u.selected=o[f.get("style")]?f.get("style"):"nocaption",this.listenTo(u,"select",function(t){var n=f.get("style");f.set("style",t),e.slidesChange(),(s=="side"&&n=="nocaption"||t=="nocaption")&&setTimeout(function(){var t=e.$(".upfront-default-slider-item-current").find(".uslide-image");e.imageProps[f.id]=e.calculateImageResize({width:t.width(),height:t.height()},f),e.setTimer()},100)})),a.push(this.createControl("crop","Edit image","imageEditMask")),a.push(this.createControl("link","Link slide","slideEditLink")),_.indexOf(["notext","onlytext"],s)==-1&&a.push(u),a.push(this.createControl("remove","Remove slide","removeSlide")),t.items=_(a),t},createControl:function(e,t,n){var r=this,i=new Upfront.Views.Editor.InlinePanels.Control;return i.icon=e,i.tooltip=t,n&&i.on("click",function(e){r[n](e)}),i},getElementColumns:function(){var e=this.$el.closest(".upfront-module"),t,n=!1;return e.length?(t=e.attr("class").split(" "),_.each(t,function(e){e.match(/^c\d+$/)&&(n=e.replace("c",""))}),n||-1):-1},slidesChange:function(){this.property("slides",this.slides.toJSON(),!1),this.model.trigger("slidesChanged")},openImageSelector:function(e,t){var n=this,r=this.slides.length?this.$(".upfront-default-slider-item-current").find(".uslide-image"):this.$(".upfront-object-content"),i={multiple:!0,preparingText:"Preparing images",element_id:this.model.get_property_value_by_name("element_id"),customImageSize:{width:r.width(),height:r.height()}};e&&e.preventDefault(),Upfront.Views.Editor.ImageSelector.open(i).done(function(e,r){n.addSlides(e,t),Upfront.Views.Editor.ImageSelector.close()})},addSlides:function(e,t){var n=[];console.log(e),_.each(e,function(e,t){var r={sizes:e,id:t,srcFull:e.full[0],status:"ok"};e.custom&&!e.custom.error?(r.src=e.custom.url,r.size=e.custom.editdata.resize,r.cropSize=e.custom.crop,r.cropOffset=e.custom.editdata.crop):(r.src=e.full[0],r.size={width:e.full[1],height:e.full[2]}),n.push(r)}),t?(this.slides.get(t).set(n[0]),this.slidesChange()):this.slides.add(n)},onElementResizeStart:function(e,t){if(t.element.hasClass("uslide-image")||this.$(".upfront-image-starting-select").length)return;var n=this.property("style"),r=this;this.calculateColumnWidth();if(_.indexOf(["nocaption","below","above","right","left"],n)==-1)this.$(".uslider-caption").fadeOut("fast");else if(n=="right"||n=="left")t.element.resizable("option",{minWidth:r.colWidth*6}),this.$(".uslide").css({height:"100%"})},calculateColumnWidth:function(){return this.colWidth=this.get_element_max_columns_px()/this.get_element_max_columns()},onElementResize:function(t,n){if(n.element.hasClass("uslide-image"))return;var r=this.$(".upfront-image-starting-select");if(r.length){this.startingHeight=e(".upfront-resize").height()-30;return}var i=this,s=this.$(".upfront-default-slider-item-current").find(".uslide-image"),o=this.slides.at(this.currentSlide),u=this.property("primaryStyle"),a=e(".upfront-resize"),f=u=="below"?this.$(".uslide-caption"):[],l=f.length?f.outerHeight():0,c={width:a.outerWidth()-30,height:a.outerHeight()-30-l},h=this.get_element_columns(),p=Math.max(3,Math.round(this.property("rightImageWidth")*h/this.property("rightWidth"))),d=p*this.calculateColumnWidth();this.slides.each(function(e){var t={height:c.height};t.width=u=="side"&&e.get("style")!="nocaption"?d:c.width,i.imageProps[e.id]=i.calculateImageResize(t,e)}),i.cropHeight=c.height,u=="side"&&this.property("rightImageWidth",p),this.property("rightWidth",h),i.setTimer()},onElementResizing:function(t,n){if(n.element.hasClass("uslide-image"))return;var r=this.$(".upfront-image-starting-select");if(r.length)return r.outerHeight(e(".upfront-resize").height()-30);var i=e(".upfront-resize"),s=this.$(".upfront-default-slider-item-current"),o=this.property("primaryStyle")=="below"?s.find(".uslide-caption"):[],u=o.length?o.outerHeight():0,a={width:i.outerWidth()-30,height:i.outerHeight()-30-u},f=s.attr("rel"),l=this.slides.get(f),c=s.find(".uslide-image"),h=this.property("primaryStyle"),p={width:h=="side"?c.width():a.width,height:a.height},d={height:p.height};h=="side"?s.find(".uslide-caption").height(a.height):d.width=p.width,c.css(d).closest(".uslide").height(a.height).closest(".uslides").height(a.height),this.calculateImageResize(p,l)},calculateImageResize:function(e,t){var n=this.$(".uslide[rel="+t.id+"]").find("img"),r=n.position(),i=t.get("size"),s=t.get("cropOffset"),o={top:-s.top,left:-s.left},u=i.width/i.height,a=e.width/e.height,f=i.width/i.height>e.width/e.height?"height":"width",l=f=="height"?"width":"height";return f=="height"&&e.height>i.height?n.css({width:"auto",height:"100%",top:0,left:Math.min(0,Math.max(o.left,e.width-i.width))}):f=="width"&&e.width>i.width?n.css({width:"100%",height:"auto",left:0,top:Math.min(0,Math.max(o.top,e.height-i.height))}):n.css({height:i.height,width:i.width,top:Math.max(o.top,e.height-i.height),left:Math.max(o.left,e.width-i.width)}),{size:{width:n.width(),height:n.height()},cropOffset:{left:0-n.position().left,top:0-n.position().top},cropSize:e}},saveTemporaryResizing:function(){var e=this,t=[],n={action:"upfront-media-image-create-size"},r={},i=this.model.get_property_value_by_name("element_id");return this.slides.each(function(n){var s=e.imageProps[n.id],o=s.cropOffset,u;o.width=s.cropSize.width,o.height=s.cropSize.height,u={id:n.id,element_id:i,rotate:n.get("rotation"),resize:s.size,crop:o},t.push(u),r[n.id]=u}),n.images=t,Upfront.Util.post(n).done(function(t){var n=t.data.images;console.log(n),_.each(n,function(t,n){var i=e.slides.get(n),s=r[n];i.set({src:t.url,srcFull:t.urlOriginal,size:s.resize,cropSize:{width:s.crop.width,height:s.crop.height},cropOffset:{left:s.crop.left,top:s.crop.top}},{silent:!0})}),clearTimeout(e.cropTimer),e.cropTimer=!1,e.imageProps={},e.slidesChange()})},saveResizing:function(){var e=this;this.cropTimer&&this.saveTemporaryResizing().done(function(){var t={element:JSON.stringify(Upfront.Util.model_to_json(e.model)),action:"upfront_update_layout_element"};Upfront.Util.post(t).done(function(e){console.log("Ok")})})},removeSlide:function(t){var n=e(t.target).closest(".uimage-controls");this.startingHeight=this.$(".upfront-slider").height(),confirm("Are you sure to delete this slide?")&&this.slides.remove(n.attr("rel"))},imageEditMask:function(t){var n=this,r=e(t.target).closest(".uimage-controls"),i=this.slides.get(r.attr("rel")),s=this.getEditorOptions(i);if(i.get("status")!="ok"){var o={multiple:!1,preparingText:"Preparing slides",element_id:n.model.get_property_value_by_name("element_id")};return Upfront.Views.Editor.ImageSelector.open(o).done(function(e,t){n.addSlides(e);var r=n.slides.indexOf(i);n.slides.remove(i,{silent:!0});var s=n.slides.at(n.slides.length-1);n.slides.remove(s,{silent:!0}),n.slides.add(s,{at:r}),Upfront.Views.Editor.ImageSelector.close()})}t.preventDefault(),Upfront.Views.Editor.ImageEditor.open(s).done(function(e){i.set({src:e.src,srcFull:e.srcFull,cropSize:e.cropSize,size:e.imageSize,cropOffset:e.imageOffset,margin:{left:Math.max(0-e.imageOffset.left,0),top:Math.max(0-e.imageOffset.top,0)},rotation:e.rotation,id:e.imageId}),n.imageProps[i.id]={cropOffset:e.imageOffset,size:e.imageSize,cropSize:e.cropSize},n.render()}).fail(function(e){e&&e.reason=="changeImage"&&n.openImageSelector(null,e.id)})},getEditorOptions:function(e){var t=this,n=this.$(".uslide[rel="+e.id+"]").find(".uslide-image"),r=n.find("img"),i=e.get("sizes").full,s={width:r.width(),height:r.height()},o={left:0-r.position().left,top:0-r.position().top},u=this.model.get_property_value_by_name("element_id");return{id:e.id,element_id:u,maskSize:{width:n.width(),height:n.height()},maskOffset:n.offset(),position:o,size:s,fullSize:{width:i[1],height:i[2]},src:e.get("src"),srcOriginal:i[0],rotation:e.get("rotation")}},slideEditLink:function(t){t.preventDefault();if(this.$el.hasClass("tooltip-open"))return this.closeTooltip();var n=this,r=e(t.target).closest(".uimage-controls"),i=this.slides.get(r.attr("rel")),s=i.toJSON(),o="";s.checked='checked="checked"',o=e(this.linkTpl(s)).on("change","input[name=ugallery-image-link]",function(e){n.slideLinkChanged(t)}).on("click","button.upfront-save_settings",function(e){n.saveSlideLink(e)}).on("click",".ugallery-change-link-post",function(e){n.slideLinkChanged(t)}),this.openTooltip(o,e(t.target))},slideLinkChanged:function(t){var n=this,r=e("#ugallery-tooltip").find("input[name=ugallery-image-link]:checked").val(),i=e("#ugallery-tooltip").find("#uslider-slide-id").val();if(r=="external")e("#ugallery-image-link-url").show();else{e("#ugallery-image-link-url").hide();if(r=="post"||t.type!="change"){var s={postTypes:this.postTypes()};this.closeTooltip(),Upfront.Views.Editor.PostSelector.open(s).done(function(e){var t=n.slides.get(i);t.set({urlType:"post",url:e.get("permalink")})})}}},postTypes:function(){var e=[];return _.each(Upfront.data.ugallery.postTypes,function(t){t.name!="attachment"&&e.push({name:t.name,label:t.label})}),e},saveSlideLink:function(t){var n=e("#ugallery-tooltip"),r=n.find("input[name=ugallery-image-link]:checked").val(),i=n.find("#uslider-slide-id").val(),s=n.find("#ugallery-image-link-url").val();return r!="external"&&r!="post"||!s?this.slides.get(i).set({urlType:"original",url:""}):this.slides.get(i).set({urlType:r,url:s}),this.closeTooltip(),this.render()},openTooltip:function(t,n){var r=e("#ugallery-tooltip"),i=n.offset(),s={top:i.top+n.outerHeight(),left:i.left-125+Math.floor(n.outerWidth()/2)},o="ugallery-tooltip-bottom",u=this;r.length||(r=e('<div id="ugallery-tooltip" class="upfront-ui"></div>'),e("body").append(r)),r.hide().html(t),i.right=i.left+n.width(),i.left-280<0&&(s.left=i.left+n.width()+20,o="ugallery-tooltip-bottom"),r.css(s).addClass(o).show().on("click",function(e){e.stopPropagation()}).on("blur",function(e){u.closeTooltip()}).on("closed",function(e){u.$el.removeClass("tooltip-open")}),this.$el.addClass("tooltip-open"),Upfront.Events.trigger("entity:settings:deactivate")},closeTooltip:function(){var t=e("#ugallery-tooltip");t.hide().trigger("closed"),setTimeout(function(){t.remove()},100)},cleanup:function(){this.controls&&(this.controls.remove(),this.controls=!1)},extract_properties:function(){var e=this.model.get("properties").toJSON(),t={};return _.each(e,function(e){t[e.name]=e.value}),t},property:function(e,t,n){return typeof t!="undefined"?(typeof n=="undefined"&&(n=!0),this.model.set_property(e,t,n)):this.model.get_property_value_by_name(e)}}),u=Upfront.Views.Editor.Field.Field.extend({template:_.template(e(n).find("#slides-setting-tpl").html()),events:{"click .uslider-add":"addSlides"},initialize:function(){this.slides=new i(this.model.get_property_value_by_name("slides")),this.listenTo(this.slides,"add remove sort reset",this.updateSlides),this.listenTo(this.model,"slidesChanged",this.slidesChanged)},updateSlides:function(){this.model.set_property("slides",this.slides.toJSON())},slidesChanged:function(){this.slides=new i(this.model.get_property_value_by_name("slides")),this.listenTo(this.slides,"add remove sort reset",this.updateSlides),this.render(),setTimeout(function(){var t=e("#settings");t.height(t.find(".upfront-settings_panel:visible").outerHeight())},100)},render:function(){var e=this;this.$el.html(this.template({slides:this.slides})),this.$(".uslider-slides-setting").sortable({items:".uslider_content_imgslide",start:function(e,t){t.item.addClass("uslider-is-dragged")},stop:function(t,n){var r=n.item.attr("rel"),i=e.getSlidePosition(r),s=!1,o=e.slides;i!=-1&&(s=o.get(r),o.remove(r,{silent:!0}),e.slides.add(s,{at:i}))}})},addSlides:function(){this.model.trigger("addRequest")},getSlidePosition:function(t){var n=0,r=!1;return this.$("div.uslider_content_slide").each(function(i){e(this).attr("rel")==t&&(r=n),n++}),r!==!1?r:-1},get_name:function(){return"slides"},get_value:function(){return this.slides.toJSON()}}),a=Upfront.Views.Editor.Sidebar.Element.extend({draggable:!0,render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-slider"),this.$el.html("Slider")},add_element:function(){var e=new s,t=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c10 upfront-slider_module"},{name:"has_settings",value:0},{name:"row",value:17}],objects:[e]});this.add_module(t)}}),f=Upfront.Views.Editor.Settings.Settings.extend({initialize:function(){this.panels=_([new l({model:this.model}),new c({model:this.model})])},get_title:function(){return"Settings"}}),l=Upfront.Views.Editor.Settings.Panel.extend({className:"upfront-settings_panel_wrap uslider-settings",initialize:function(){var t=this,n=Upfront.Views.Editor.Settings.Item,r=Upfront.Views.Editor.Field;this.settings=_([new n({title:"Slider styles",className:"uslider-style-setting",fields:[new r.Radios({model:this.model,property:"primaryStyle",layout:"horizontal-inline",values:[{label:"no txt",value:"notext",icon:"nocaption"},{label:"txt below",value:"below",icon:"below"},{label:"txt over",value:"over",icon:"bottomOver"},{label:"txt on side",value:"side",icon:"right"}]})]}),new h({title:"Caption Background",fields:[new r.Radios({model:this.model,property:"captionUseBackground",layout:"horizontal-inline",values:[{value:"0",label:"None"},{value:"1",label:"Pick color"}]})]}),new n({title:"",group:!1,className:"uslider-rotate-settings",fields:[new r.Checkboxes({model:this.model,property:"rotate",layout:"horizontal-inline",multiple:!0,values:[{label:"Rotate every ",value:"true"}]}),new r.Number({model:this.model,property:"rotateTime",min:1,max:60,step:1,suffix:"sec."})]}),new n({title:"Transitions",className:"uslider-transition-setting",fields:[new r.Radios({model:this.model,property:"transition",layout:"horizontal-inline",icon_class:"upfront-region-field-icon",className:"uslider-transition-setting upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-radios",values:[{label:"Slide Down",value:"slide-down",icon:"bg-slider-slide-down"},{label:"Slide Up",value:"slide-up",icon:"bg-slider-slide-up"},{label:"Slide Right",value:"slide-right",icon:"bg-slider-slide-right"},{label:"Slide Left",value:"slide-left",icon:"bg-slider-slide-left"},{label:"Crossfade",value:"crossfade",icon:"bg-slider-crossfade"}]})]}),new n({title:"Slider Controls",fields:[new r.Radios({model:this.model,property:"controlsWhen",layout:"horizontal-inline",className:"uslider-controlswhen-setting upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-radios",values:[{label:"show on hover",value:"hover"},{label:"always show",value:"always"}]}),new r.Select({model:this.model,property:"controls",values:[{label:"Dots",value:"dots"},{label:"Arrows",value:"arrows"},{label:"Both",value:"both"}]})]})]),this.on("rendered",function(){t.toggleColorSetting();var n=!1,r=t.model.get_property_value_by_name("captionBackground"),i=e('<input type="text" value="'+r+'">'),s=t.$(".ugallery-colorpicker-setting");s.find(".upfront-field-wrap").append(i),s.find('input[name="captionUseBackground"]').on("change",function(){t.toggleColorPicker()}),i.spectrum({showAlpha:!0,showPalette:!0,palette:["fff","000","0f0"],maxSelectionSize:9,localStorageKey:"spectrum.recent_bgs",preferredFormat:"hex",chooseText:"Ok",showInput:!0,allowEmpty:!0,show:function(){n=e(".sp-container:visible")},change:function(e){var n=e.toRgbString();t.model.set_property("captionBackground",n,!0),r=n,t.model.trigger("background",n)},move:function(e){var r=e.toRgbString();n.find(".sp-dragger").css("border-top-color",r),n.parent().find(".sp-dragger").css("border-right-color",r),t.parent_view.for_view.$el.find(".uslide-caption").css("background-color",r)},hide:function(){t.parent_view.for_view.$el.find(".uslide-caption").css("background-color",r)}}),s.find(".sp-replacer").css("display","inline-block"),t.toggleColorPicker()}),this.$el.on("change",'input[name="primaryStyle"]',function(e){t.toggleColorSetting()})},toggleColorSetting:function(){var e=this.$(".uslider-style-setting").find("input:checked").val();e=="notext"?this.$(".ugallery-colorpicker-setting").hide():this.$(".ugallery-colorpicker-setting").show()},toggleColorPicker:function(){var e=this.$(".ugallery-colorpicker-setting"),t=e.find("input:checked").val(),n=e.find(".sp-replacer");t=="1"?n.show():n.hide()},get_label:function(){return"General"},get_title:function(){return!1}}),c=Upfront.Views.Editor.Settings.Panel.extend({initialize:function(){var e=this,t=Upfront.Views.Editor.Settings.Item,n=Upfront.Views.Editor.Field;this.settings=_([new t({title:"Slides order",fields:[new u({model:this.model})]})])},get_label:function(){return"Slides"},get_title:function(){return!1}}),h=Upfront.Views.Editor.Settings.Item.extend({className:"ugallery-colorpicker-setting"});Upfront.Application.LayoutEditor.add_object("USlider",{Model:s,View:o,Element:a,Settings:f}),Upfront.Models.USliderModel=s,Upfront.Views.USliderView=o})}(jQuery),define("text!elements/upfront-social-media/tpl/social-back.html",[],function(){return'<div>\n\n<script type="text/template" id="service-tpl">\n	<li class="upfront-field-multiple">\n		{[ if(expandable){ ]}\n			<i class="usocial-global-triangle"></i>\n		{[ } ]}\n		<i class="upfront-field-icon upfront-field-icon-social-sort"></i>\n		<input type="checkbox" id="service-{{service.id}}" name="" value="{{service.id}}" class="upfront-field-checkbox"{{service.active ? \' checked="checked"\' : \'\' }}>\n		<label for="service-{{service.id}}">\n			<span class="upfront-field-label-text">{{service.name}}</span>\n		</label>\n		{[ if(expandable){ ]}\n		<div class="upfront-field-wrap upfront-field-wrap-text" data-tooltip="link address" style="display:none">\n			<input type="text" class="upfront-field upfront-field-text usocial_text usocial_url" id="service-url-{{service.id}}" name="{{service.id}}_url" value="{{service.url}}" placeholder="{{service.name}} url" data-field="url" data-service="{{service.id}}">\n			{[if(meta){_.each(service.meta, function(meta){ ]}\n			<input type="text" class="upfront-field upfront-field-text usocial_text usocial_{{meta.id}} usocial_service_meta" id="service-{{meta.id}}-{{service.id}}" name="{{meta.id}}" value="{{meta.value}}" placeholder="{{service.name}} {{meta.name}}" data-field="{{meta.id}}" data-service="{{service.id}}">\n			{[ });} ]}\n		</div>\n		{[ } ]}\n	</li>\n</script>\n\n<script type="text/template" id="add-service-tpl">\n	{[ if(services.length){ ]}\n	<div class="upfront-field-wrap upfront-field-wrap-select">\n		<label class="usocial-select-label">Add a new service:</label>\n		<div class="usocial-select upfront-field-select upfront-field-select-single usocial-select-closed" id="">\n			<ul class="usocial-select-list">\n				{[ _.each(services, function(service){  ]}\n				<li class="upfront-field-select-option">\n					<label for="service-{{service.id}}">\n						<span class="upfront-field-label-text">{{service.name}}</span>\n					</label>\n					<input type="radio" id="service-{{service.id}}" name="select" class="upfront-field-radio" value="{{service.id}}"{{services[0].name == service.name ? \' checked="checked"\' : \'\'}} >\n				</li>\n				{[ }) ]}\n			</ul>\n		</div>\n		<i class="upfront-field-icon upfront-field-icon-social-add usocial-add"></i>\n	</div>\n	{[ } ]}\n</script>\n\n<script type="text/template" id="global-tpl">\n	<div class="upfront-global-social-settings">\n		<div class="upfront-settings-item">\n			<div class="upfront-settings-item-title">Set up your Social accounts</div>\n			<div class="upfront-settings-item-content">\n				<ul class="upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-checkboxes social_media_services_list ui-sortable">\n					{[ _.each(services, function(service){ ]}\n					<li class="upfront-field-multiple upfront-field-multiple-selected">\n						<i class="usocial-global-triangle"></i>\n						<i class="upfront-field-icon upfront-field-icon-social-sort"></i>\n						<input type="checkbox" id="social_global_{{service.id}}" name="services" value="{{service.id}}" class="upfront-field-checkbox" {{service.active ? \'checked="checked"\' : \'\'}}>\n						<label for="social_global_{{service.id}}">\n							<span class="upfront-field-label-text">{{service.name}}</span>\n						</label>\n						<div class="upfront-field-wrap upfront-field-wrap-text" data-tooltip="link address" style="display:none">\n							<input type="text" class="upfront-field upfront-field-text" id="{{service.id}}-url" name="{{service.id}}-url" value="{{service.url}}" placeholder="{{service.name}} url">\n						</div>\n					</li>\n					{[ }) ]}\n				</ul>\n			</div>\n		</div>\n		<div class="upfront-settings-item">\n			<div class="upfront-settings-item-title">In-post social media</div>\n			<div class="upfront-settings-item-content">\n				<div class="upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-checkboxes">\n					<span class="upfront-field-multiple upfront-field-multiple-selected">\n						<input type="checkbox" id="usocial-global-add_to_post" name="inpost" value="yes" class="upfront-field-checkbox" {{inpost.length ? \'checked="checked"\' : \'\'}}>\n						<label for="usocial-global-add_to_post">\n							<span class="upfront-field-label-text">Add social media counters to all posts</span>\n						</label>\n					</span>\n				</div>				\n			</div>\n			<div class="">\n				<label for="usocial-global_after_title" class="upfront-field-label upfront-field-label-block">In-post location:</label>\n				<div class="usocial-global-add-post">\n					<div class="upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-checkboxes">\n						\n						<span class="upfront-field-multiple {{after_title.length ? \'upfront-field-multiple-selected\' : \'\' }}">\n							<input type="checkbox" id="usocial-global-after_title" name="after_title" value="yes" class="upfront-field-checkbox usocial_post_location" {{after_title.length ? \'checked="checked"\' : \'\'}}>\n							<label for="usocial-global-after_title">\n								<span class="upfront-field-label-text">After Post Title</span>\n							</label>\n						</span>\n					</div>\n\n					<div class="upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-radios">\n						<i class="usocial-align-icon upfront-field-icon upfront-field-icon-social-title-align"></i>\n						<div class="usocial-global-align {{after_title.length ? \'align-active\' : \'\'}}">\n							<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline">\n								<input type="radio" id="usocial-global-align-0" name="after_title_align" value="left" class="upfront-field-radio" {{after_title_align == \'left\' ? \'checked="checked"\' : \'\'}} {{after_title.length ? \'\' : \'disabled="disabled"\'}}>\n							</span>\n							<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline">\n								<input type="radio" id="usocial-global-align-1" name="after_title_align" value="center" class="upfront-field-radio" {{after_title_align == \'center\' ? \'checked="checked"\' : \'\'}} {{after_title.length ? \'\' : \'disabled="disabled"\'}}>\n							</span>\n							<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline">\n								<input type="radio" id="usocial-global-align-2" name="after_title_align" value="right" class="upfront-field-radio" {{after_title_align == \'right\' ? \'checked="checked"\' : \'\'}} {{after_title.length ? \'\' : \'disabled="disabled"\'}}>\n							</span>\n						</div>\n						<label class="usocial-global-align-label" for="after_content_align">Aligned {{after_title_align}}</label>\n					</div>\n				</div>\n				<div class="usocial-global-add-post">\n					<div class="upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-checkboxes">\n						<span class="upfront-field-multiple {{after_content.length ? \'upfront-field-multiple-selected\' : \'\' }}">\n							<input type="checkbox" id="usocial-global-after_content" name="after_content" value="yes" class="upfront-field-checkbox usocial_post_location" {{after_content.length ? \'checked="checked"\' : \'\'}}>\n							<label for="usocial-global-after_content">\n								<span class="upfront-field-label-text">After Post Content</span>\n							</label>\n						</span>\n					</div>\n					<div class="upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-radios">\n						<i class="usocial-align-icon upfront-field-icon upfront-field-icon-social-content-align"></i>\n						<div class="usocial-global-align {{after_content.length ? \'align-active\' : \'\'}}">\n							<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline">\n								<input type="radio" id="usocial-global-align-0" name="after_content_align" value="left" class="upfront-field-radio" {{after_content_align == \'left\' ? \'checked="checked"\' : \'\'}} {{after_content.length ? \'\' : \'disabled="disabled"\'}}>\n							</span>\n							<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline">\n								<input type="radio" id="usocial-global-align-1" name="after_content_align" value="center" class="upfront-field-radio" {{after_content_align == \'center\' ? \'checked="checked"\' : \'\'}} {{after_content.length ? \'\' : \'disabled="disabled"\'}}>\n							</span>\n							<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline">\n								<input type="radio" id="usocial-global-align-2" name="after_content_align" value="right" class="upfront-field-radio" {{after_content_align == \'right\' ? \'checked="checked"\' : \'\'}} {{after_content.length ? \'\' : \'disabled="disabled"\'}}>\n							</span>\n						</div>\n						<label class="usocial-global-align-label" for="after_content_align">Aligned {{after_content_align}}</label>\n					</div>\n				</div>\n			</div>\n			<div class="upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-radios">\n				<label for="usocial-global-counter_style" class="upfront-field-label upfront-field-label-block">Social Counter style:</label>\n				<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline">\n					<input type="radio" id="usocial-global-counter_style-0" name="counter_style" value="horizontal" class="upfront-field-radio" {{counter_style == \'horizontal\' ? \'checked="checked"\' : \'\'}}>\n					<label for="usocial-global-counter_style-0">\n						<i class="upfront-field-icon upfront-field-icon-social-count-horizontal"></i>\n						<span class="upfront-field-label-text"></span>\n					</label>\n				</span>\n				<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline upfront-field-multiple-selected">\n					<input type="radio" id="usocial-global-counter_style-1" name="counter_style" value="vertical" class="upfront-field-radio" {{counter_style == \'vertical\' ? \'checked="checked"\' : \'\'}}>\n					<label for="usocial-global-counter_style-1">\n						<i class="upfront-field-icon upfront-field-icon-social-count-vertical"></i>\n						<span class="upfront-field-label-text"></span>\n					</label>\n				</span>\n			</div>\n		</div>\n	</div>\n</script>\n\n<script type="text/template" id="fb_like-tpl">\n<div data-id="upfront-icon-facebook" class="upfront-social-icon">\n	<iframe class="social-frame usocial-fb {{style}} like" src="//www.facebook.com/plugins/like.php?href={{url}}&amp;send=false&amp;layout={{layout}}&amp;width={{width}}px&amp;show_faces=true&amp;font&amp;colorscheme=light&amp;action=like&amp;height={{height}}px" scrolling="no" frameborder="0" style="border:none; overflow:hidden;" allowTransparency="true"></iframe>\n</div>\n</script>\n<script type="text/template" id="tweet-tpl">\n<div data-id="upfront-icon-twitter" class="upfront-social-icon">\n	<iframe class="social-frame usocial-twitter {{style}} like" allowtransparency="true" frameborder="0" scrolling="no" src="//platform.twitter.com/widgets/tweet_button.html?text={{text}}&amp;url={{url}}&amp;original_referer={{url}}&amp;count={{style}}&amp;size=medium" style=""></iframe>\n</div>\n</script>\n<script type="text/template" id="plusone-tpl">\n<div data-id="upfront-icon-google" class="upfront-social-icon social-frame usocial-google {{style}} like">\n	<script type="text/javascript" src="//apis.google.com/js/plusone.js"></{{\'s\'}}cript>\n	<div class="g-plusone" data-size="{{size}}"></div>\n</div>\n</script>\n\n\n</div>'}),function(e){define("upfront-social_media",["text!elements/upfront-social-media/tpl/social-back.html"],function(t){var n=Backbone.View.extend({popup:!1,deferred:!1,model:!1,tpl:_.template(e(t).find("#global-tpl").html()),events:{"click .use":"store","click li":"revealUrl","change input[name=services]":"toggleService","change .usocial_post_location":"changePostLocation","change input[name=after_title_align]":"changeAlign","change input[name=after_content_align]":"changeAlign"},popupFunc:function(){return this.open()},isOpen:function(){return e(".upfront-global-social-settings").length},open:function(){var t=this,n=!1;return console.log("Global social settings"),this.popup=Upfront.Popup.open(function(){}),this.deferred=e.Deferred(),this.setElement(e("#upfront-popup")),settings=_.clone(Upfront.data.usocial.globals?Upfront.data.usocial.globals:Upfront.data.usocial.global_defaults),this.$("#upfront-popup-top").html('<ul class="upfront-tabs"><li class="active upfront-social-popup-hd">Global Social Settings</li></ul>'),this.$("#upfront-popup-bottom").html('<div class="use_selection_container"><a href="#use" class="use">OK</a></div>'),this.$("#upfront-popup-content").html(this.tpl(settings)),this.setDraggableUp(),this.deferred.promise()},setDraggableUp:function(){this.$("ul").sortable({handle:".upfront-field-icon-social-sort"})},store:function(t){t.preventDefault();var n=this,r={inpost:this.$('input[name="inpost"]:checked').length?["yes"]:[],after_title:this.$('input[name="after_title"]:checked').length?["yes"]:[],after_title_align:this.$('input[name="after_title_align"]:checked').val(),after_content:this.$('input[name="after_content"]:checked').length?["yes"]:[],after_content_align:this.$('input[name="after_content_align"]:checked').val(),counter_style:this.$('input[name="counter_style"]:checked').val()},i=[],s=!1;this.$(".social_media_services_list").find("input[type=checkbox]").each(function(t,r){var s=e(r),o={id:s.val(),active:s.is(":checked"),meta:Upfront.data.usocial.global_defaults.services[s.val()].meta};o.name=Upfront.data.usocial.global_defaults.services[o.id].name,o.url=n.$('input[name="'+o.id+'-url"]').val(),i.push(o)}),r.services=i,s=this.arrayToProperties(r);var o=new Upfront.Views.Editor.Loading({loading:"Saving settings...",fixed:!1});o.render(),this.$("#upfront-popup-content").css("position","relative").append(o.$el),Upfront.Util.post({action:"usocial_save_globals",data:JSON.stringify(s)}).success(function(e){o.cancel(),Upfront.Popup.close(),Upfront.Views.Editor.notify("Settings Updated. Reload posts to see in-post changes."),Upfront.data.usocial.globals=r,n.deferred.resolve(r)}).error(function(e){Upfront.Util.log("Error Saving settings")})},revealUrl:function(t){var n=e(t.target).hasClass("usocial-global-triangle")?e(t.target).closest("li"):e(t.target),r=n.parent().find(".open");r.removeClass("open").find(".upfront-field-wrap-text").slideUp("fast"),r[0]!=n[0]&&n.addClass("open").find(".upfront-field-wrap-text").slideDown("fast")},toggleService:function(t){t.preventDefault();var n=e(t.target),r=e(t.target).closest("li");input=r.find("input[type=text]"),n.is(":checked")&&!input.val()&&!input.is(":visible")&&(t.target=r[0],this.revealUrl(t),input.focus())},changePostLocation:function(t){var n=e(t.target),r=n.is(":checked"),i=n.closest(".usocial-global-add-post");r?(n.parent().addClass("upfront-field-multiple-selected"),i.find(".usocial-global-align").addClass("align-active").find("input[type=radio]").attr("disabled",!1)):(n.parent().removeClass("upfront-field-multiple-selected"),i.find(".usocial-global-align").removeClass("align-active").find("input[type=radio]").attr("disabled",!0))},changeAlign:function(t){var n=e(t.target),r=n.is(":checked");r&&n.closest(".upfront-field-wrap").find(".usocial-global-align-label").text("Aligned "+n.val())},arrayToProperties:function(e){var t=[];return _.each(e,function(e,n){t.push({name:n,value:e})}),t}});Upfront.data.social.panel=new n;var r=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(this.getDefaults());e.element_id=Upfront.Util.get_unique_id(e.id_slug+"-object"),this.init_properties(e)},getDefaults:function(){var e=Upfront.data.usocial.globals,t=Upfront.data.usocial.defaults,n=[],r=[],i={};if(!e)return t;_.each(e.services,function(e){n.push(e.id),e.active&&r.push(e.id),i[e.id]=e.url});var s=_.clone(e.services);return s.push({id:"linked-in",name:"Linked in",active:!1,url:"",meta:{}}),s.push({id:"pinterest",name:"Pinterest",active:!1,url:"",meta:{}}),s.push({id:"youtube",name:"Youtube",active:!1,url:"",meta:{}}),_.extend({},t,{services:e.services,button_services:s,counter_options:e.counter_style})}}),i=Upfront.Views.ObjectView.extend({settings:!1,counts:!1,initialize:function(){this.model instanceof r||(this.model=new r({properties:this.model.get("properties")})),Upfront.Views.ObjectView.prototype.initialize.call(this),Upfront.Events.on("entity:drag_stop",this.dragStop,this)},dragStop:function(e,t){var n=this;this.parent_module_view==e&&!Upfront.data.usocial.globals&&!Upfront.data.social.panel.isOpen()&&(Upfront.data.social.panel.open().done(function(e){var t=n.model.getDefaults();_.each(t,function(e,t){n.model.set_property(t,e,!0)}),n.model.trigger("change")}),console.log("No globals"))},property:function(e,t){return typeof t!="undefined"?this.model.set_property(e,t):this.model.get_property_value_by_name(e)},buttons:function(){var e=this.property("button_services"),t=this.property("button_style"),n=this.property("button_size"),r="";return e.length?(_.each(e,function(e){var i=e.url?"":'<span class="alert-url">!</span>';e.active&&(r+='<div class="upfront-'+e.id+"-link-box upfront-social-icon upfront-"+t+" usocial-button-"+n+'">'+'<a class="usocial-button '+e.id+'-link" href="'+e.url+'"></a>'+i+"</div>")}),r):"Please, add some social media services."},fans:function(){var e=this,t=this.property("services"),n="",r=this.property("button_style"),i=this.property("button_size"),s={facebook:"Fans",twitter:"Followers",google:"Subscribers"};return _(t).each(function(t){if(t.active){var r=t.url?"":'<span class="alert-url">!</span>',i=e.getCount(t);n+='<div data-id="upfront-icon-'+t.id+'" class="ufront-'+t.id+'-count-box upfront-social-icon usocial_count_wrapper">'+'<a class="upfront-fan-counts '+t.id+'-count" href="'+t.url+'">'+r+' <span class="upfront-fan-count"><strong class="usocial_count">'+i+"</strong> "+s[t.id]+"</span></a>"+"</div>"}}),n?(this.refreshCount(),n):"Please, add some social media services."},getCount:function(e){var t=this,n=e.id,r=!1,i=!1,s=this.property("element_id");if(typeof usocial=="undefined"||!usocial.counts||!usocial.counts[s]||!usocial.counts[s][e.id])i=!0;return i?(this.counts?this.counts.done(function(e){var r=e.data[n];t.$el.find('div[data-id="upfront-icon-'+n+'"]').find("strong.usocial_count").html(r)}):this.refreshCount(),"Loading"):usocial.counts[s][e.id]},refreshCount:function(){var e=this;this.counts=Upfront.Util.post({action:"usocial_get_counts",element_id:this.property("element_id"),services:e.property("services")}).done(function(t){_.each(t.data,function(t,n){e.$el.find('div[data-id="upfront-icon-'+n+'"]').find("strong.usocial_count").html(t)})})},rawUrlEncode:function(e){return e=(e+"").toString(),encodeURIComponent(e).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A")},likes:function(){var n=this.property("counter_options"),r=this.property("services"),i=this,s="";if(r.length){var o=n=="horizontal",u={url:this.rawUrlEncode(location.href),style:n,width:o?90:70,height:o?20:60,size:o?"medium":"tall",layout:o?"button_count":"box_count",text:document.title?document.title:"What an awesome stuff! "},a={facebook:"fb_like-tpl",twitter:"tweet-tpl",google:"plusone-tpl"};_.each(r,function(n){if(n.active){var r=_.template(e(t).find("#"+a[n.id]).html());s+=r(u)}})}return s?s:"Please, select some social services."},get_content_markup:function(){if(!Upfront.data.usocial.globals)return"There is no global settings for the social media. Please configure them pressing the settings button.";var e=this,t=this.property("social_type"),n="";switch(t){case"likes":n=e.likes();break;case"fans":n=e.fans();break;case"buttons":n=e.buttons()}return this.$el.html(n),n}}),s=Upfront.Views.Editor.Sidebar.Element.extend({priority:60,render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-social"),this.$el.html("Social")},add_element:function(){var e=new r,t=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c8 upfront-social-media_module"},{name:"has_settings",value:0},{name:"row",value:4}],objects:[e]});this.add_module(t)}}),o=Upfront.Views.Editor.Settings.Item.extend({events:function(){return _.extend({},o.prototype.events,{"click .social-toggle":"social_toggle"})},social_toggle:function(){this.fields._wrapped[0].$el.toggle()},render:function(){this.$el.empty(),this.group?this.$el.append('<div class="upfront-settings-item"><div class="upfront-settings-item-title">'+this.get_title()+"</div>"+'<div class="upfront-settings-item-content">'+'<span class="social-toggle">Drag to re-order the services</span>'+'<span class="social-sort"></span>'+"</div>"+"</div>"):this.$el.append('<div class="upfront-settings-item-content"></div>');var e=this.$el.find(".upfront-settings-item-content");this.fields.each(function(t){t.render(),e.append(t.el)}),this.trigger("rendered")}}),u=Upfront.Views.Editor.Field.Field.extend({events:{"click a":"buttonClicked"},render:function(){this.$el.html(this.get_field_html())},get_field_html:function(){return'<i class="upfront-field-icon upfront-field-icon-social-back"></i><span class="upfront-back-global-settings-info">'+this.options.info+' <a href="#">'+this.options.label+"</a></span>"},buttonClicked:function(e){this.options.on_click&&this.options.on_click(e)},isProperty:!1}),a=Upfront.Views.Editor.Field.Field.extend({className:"",tpl:_.template(e(t).find("#service-tpl").html()),variableTpl:_.template(e(t).find("#add-service-tpl").html()),events:{"click .usocial-global-triangle":"toggleService","click .usocial-select":"showServiceList","blur .usocial-select":"hideServiceList","click .upfront-field-select-option":"selectService","click .usocial-add":"addService","change input[type=checkbox]":"changeService","blur input.usocial_text":"updateServiceMeta"},initialize:function(e){var t=this;a.__super__.initialize.apply(this,arguments),this.$el.on("click",function(e){t.hideServiceList(e)})},render:function(){console.log("render");var e=this,t=[],n=this.prop(this.options.prop);this.$el.html('<ul class="upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-checkboxes social_media_services_list"></ul>'),_.each(n,function(n){(!e.options.variable||n.active)&&e.$("ul").append(e.tpl({service:n,expandable:e.options.expandable,meta:e.options.meta})),n.active||t.push(n)}),this.initSortable(),this.options.variable&&this.$el.append(this.variableTpl({services:t})),this.trigger("rendered")},toggleService:function(t){var n=e(t.target).siblings(".upfront-field-wrap-text");n.is(":visible")?n.slideUp("fast"):n.slideDown("fast")},showServiceList:function(t){console.log("Show"),t.preventDefault(),t.stopPropagation(),e(t.currentTarget).removeClass("usocial-select-closed").focus()},hideServiceList:function(e){this.$(".usocial-select").addClass("usocial-select-closed")},selectService:function(t){if(!this.$(".usocial-select").hasClass("usocial-select-closed")){t.preventDefault(),t.stopPropagation();var n=e(t.currentTarget).detach();this.$(".usocial-select-list").prepend(n),this.$(".usocial-select").addClass("usocial-select-closed")}},addService:function(t){t.preventDefault();var n=this.$(".usocial-select-list").find("input").first().val(),r=this.prop(this.options.prop),i={};_.each(r,function(e){e.id==n&&(e.active=!0,i=e)}),this.prop(this.options.prop,r,!0);var s=e(this.tpl({service:i,expandable:this.options.expandable})).hide().find(".upfront-field-wrap-text").show().end();this.$(".social_media_services_list").append(s),s.slideDown("fast").find("input[type=text]").focus(),this.$(".usocial-select-list").find("li").first().remove()},changeService:function(t){var n=e(t.target),r=n.val(),i=this.prop(this.options.prop);_.each(i,function(e){e.id==r&&(e.active=n.is(":checked"))}),this.prop(this.options.prop,i,!1);if(n.is(":checked")&&this.options.expandable){var s=n.parent().find("input[type=text]");s.val()||(n.siblings(".upfront-field-wrap-text").slideDown(),s.focus())}this.model.trigger("change")},initSortable:function(){var e=this;this.$("ul").sortable({start:function(e,t){},stop:function(e,t){},update:function(t,n){e.updateOrder()}})},updateOrder:function(){this.save(!0)},updateServiceMeta:function(t){var n=e(t.target),r=n.data("field"),i=n.val(),s=this.serv(n.data("service"));i||n.closest("li").find("input[type=checkbox]").attr("checked",!1);if(!s)return console.log("Unknown service couldn't be saved");if(r=="url")s.url=i;else{var o=s.meta;for(var u in o)o[u].id==r&&(o[u].value=i);s.meta=o}this.serv(n.data("service"),s,!1)},save:function(t){var n=this,r=this.prop(this.options.prop),i={},s=this.$(".ui-sortable").find("input[type=checkbox]"),o=[],u=[];_.each(r,function(e){i[e.id]=e}),typeof t=="undefined"&&(t=!1),s.each(function(r,s){var a=e(s),f=i[a.val()];if(f){if(!t){f.active=a.is(":checked");if(n.options.expandable){var l=a.closest("li");f.url=l.find("input[name="+f.id+"_url]").val(),f.meta.length&&_.each(f.meta,function(e){e.value=l.find("input[name="+e.id+"]").val()})}}u.push(f),o.push(f.id)}}),_.each(r,function(e){o.indexOf(e.id)==-1&&u.push(e)}),this.prop(this.options.prop,u,!1)},serv:function(e,t,n){var r=this.prop(this.options.prop);if(typeof t=="undefined"){for(var i in r)if(r[i].id==e)return r[i];return!1}var s=!1;for(var i in r)r[i].id==e&&(r[i]=t,s=!0);s||r.push(t),typeof n=="undefined"&&(n=!0),this.prop(this.options.prop,r,n)},prop:function(e,t,n){return typeof t!="undefined"?(typeof n=="undefined"&&(n=!0),this.model.set_property(e,t,n)):this.model.get_property_value_by_name(e)}}),f=Upfront.Views.Editor.Settings.Settings.extend({panel:!1,servicesItems:[],events:{"change input[type=radio]":"changeRadio"},initialize:function(){this.panel=new Upfront.Views.Editor.Settings.Panel({model:this.model,label:"Layout Style",title:"Layout Style settings",tabbed:!0,settings:[new Upfront.Views.Editor.Settings.ItemTabbed({model:this.model,title:"Like,<br> Tweet, +1",radio:!0,icon:"social-like",property:"social_type",value:"likes",is_default:!0,settings:this.getLikesSettings()}),new Upfront.Views.Editor.Settings.ItemTabbed({model:this.model,title:"Fan, Follower count",radio:!0,icon:"social-count",property:"social_type",value:"fans",settings:this.getFansSettings()}),new Upfront.Views.Editor.Settings.ItemTabbed({model:this.model,title:"Call to action icon",radio:!0,icon:"social-button",property:"social_type",value:"buttons",settings:this.getButtonsSettings()})]}),this.panels=_([this.panel]),this.panel.on("upfront:settings:panel:saved",this.saveServices,this)},getLikesSettings:function(){var e=new a({model:this.model,prop:"services",expandable:!1});return this.servicesItems.push(e),[new Upfront.Views.Editor.Settings.Item({model:this.model,title:"Counter Options",fields:[new Upfront.Views.Editor.Field.Radios({model:this.model,property:"counter_options",layout:"horizontal-inline",label:"",values:[{label:"",value:"horizontal",icon:"social-count-horizontal"},{label:"",value:"vertical",icon:"social-count-vertical"}]})]}),new o({className:"upfront-social-services-item",model:this.model,title:"Social Media Services",fields:[e]}),this.getGlobalsButton()]},getFansSettings:function(){var e=new a({model:this.model,prop:"services",meta:!0,expandable:!0});return this.servicesItems.push(e),[new o({className:"upfront-social-services-item",model:this.model,title:"Social Media Services",fields:[e]}),this.getGlobalsButton()]},getButtonsSettings:function(){var e=new a({model:this.model,prop:"button_services",expandable:!0,variable:!0});return this.servicesItems.push(e),[new Upfront.Views.Editor.Settings.Item({model:this.model,title:"Button Size",fields:[new Upfront.Views.Editor.Field.Radios({model:this.model,property:"button_size",layout:"vertical",label:"",values:[{label:"Small",value:"small"},{label:"Medium",value:"medium"},{label:"Large",value:"large"}]})]}),new Upfront.Views.Editor.Settings.Item({model:this.model,title:"Button Style",fields:[new Upfront.Views.Editor.Field.Radios({model:this.model,property:"button_style",layout:"horizontal-inline",label:"",values:[{label:"",value:"button-style-1",icon:"social-button-style-1"},{label:"",value:"button-style-2",icon:"social-button-style-2"},{label:"",value:"button-style-3",icon:"social-button-style-3"}]})]}),new o({className:"upfront-social-services-item",model:this.model,title:"Social Media Services",fields:[e]}),this.getGlobalsButton()]},getGlobalsButton:function(){return new Upfront.Views.Editor.Settings.Item({className:"upfront-social-back",group:!1,fields:[new u({model:this.model,info:"Back to your",label:"global settings",on_click:function(e){e.preventDefault(),Upfront.Events.trigger("entity:settings:deactivate"),Upfront.data.social.panel.popupFunc()}})]})},changeRadio:function(t){var n=e(t.target),r=n.attr("name"),i=this.$el.find("input[name="+r+"]:checked").val();this.model.set_property(r,i)},get_title:function(){return"Social Media settings"},render:function(){var e=this;Upfront.data.usocial.globals?this.constructor.__super__.render.call(this):Upfront.data.social.panel.open().done(function(t){_.each(t,function(t,n){e.model.set_property(n,t,!0)}),e.model.trigger("change")})},saveServices:function(){console.log("Saving services"),_.each(this.servicesItems,function(e){e.$el.is(":visible")&&e.save()}),this.model.trigger("change")}});Upfront.Application.LayoutEditor.add_object("SocialMedia",{Model:r,View:i,Element:s,Settings:f,anchor:{is_target:!1}}),Upfront.Models.SocialMediaModel=r,Upfront.Views.SocialMediaView=i})}(jQuery),define("text!elements/upfront-tabs/tpl/utabs.html",[],function(){return'<?php if ($style_type === \'custom\') { ?>\r\n    <style>\r\n      /* Tabbed style */\r\n      .upfront-tabs-container.custom.tabbed  .tabs-menu {\r\n        border-color: <?php echo $active_tab_color ?>;\r\n      }\r\n\r\n      .upfront-tabs-container.custom.tabbed  .tabs-tab .inner-box {\r\n        color: <?php echo $inactive_tab_text_color ?>;\r\n        background: <?php echo $inactive_tab_color ?>;\r\n      }\r\n\r\n      .upfront-tabs-container.custom.tabbed  .tabs-tab-active .inner-box {\r\n        color: <?php echo $active_tab_text_color ?>;\r\n        background: none;\r\n      }\r\n\r\n      .upfront-tabs-container.custom.tabbed  .tabs-tab-active {\r\n        border-color: <?php echo $active_tab_color ?>;\r\n      }\r\n      /* Simple text */\r\n      .upfront-tabs-container.custom.simple_text .tabs-tab .inner-box {\r\n        color: <?php echo $inactive_tab_text_color ?>;\r\n      }\r\n\r\n      .upfront-tabs-container.custom.simple_text .tabs-tab-active .inner-box {\r\n        color: <?php echo $active_tab_text_color ?>;\r\n      }\r\n\r\n      /* Button tabs */\r\n      .upfront-tabs-container.custom.button_tabs .tabs-tab {\r\n        color: <?php echo $inactive_tab_text_color ?>;\r\n        background: <?php echo $inactive_tab_color ?>;\r\n      }\r\n\r\n      .upfront-tabs-container.custom.button_tabs .tabs-tab-active {\r\n        color: <?php echo $active_tab_text_color ?>;\r\n        background: <?php echo $active_tab_color ?>;\r\n      }\r\n    </style>\r\n<?php } ?>\r\n<div class=" upfront-tabs-container <?php if($style_type === \'theme_defined\') { ?><?php echo $theme_style ?><?php } else { ?>custom <?php echo $custom_style ?><?php } ?>" id="<?php echo $element_id ?>">\r\n  <div class="tabs-menu-wrapper">\r\n    <div class="tabs-menu">\r\n      <?php for ($i = 0; $i < $tabs_count; $i++) { ?>\r\n      <div class="tabs-tab <?php if($i === 0) { ?>tabs-tab-active<?php } ?>" data-content-id="<?php echo $element_id ?>-<?php echo $i ?>">\r\n        <div class="inner-box">\r\n          <span style="width: <?php echo $tabs_fixed_width ?>"><?php echo $tabs[$i][\'title\'] ?></span>\r\n        </div>\r\n        <?php if ($show_remove) { ?>\r\n        <i>x</i>\r\n        <?php } ?>\r\n      </div>\r\n      <?php } ?>\r\n      <?php if ($show_add) { ?>\r\n      <div class="add-tab">+</div>\r\n      <?php } ?>\r\n    </div>\r\n  </div>\r\n  <div class="tabs-content" >\r\n    <?php for ($i = 0; $i < $tabs_count; $i++) { ?>\r\n    <div id="<?php echo $element_id ?>-<?php echo $i ?>" class="tab-content <?php if($i === 0) { ?>tab-content-active<?php } ?>"><?php echo $tabs[$i][\'content\'] ?></div>\r\n    <?php } ?>\r\n  </div>\r\n</div>\r\n'}),function(e){define("utabs",["text!elements/upfront-tabs/tpl/utabs.html"],function(t){var n=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(Upfront.data.utabs.defaults);e.element_id=Upfront.Util.get_unique_id("utabs-object"),this.init_properties(e)}}),r=Upfront.Views.ObjectView.extend({model:n,tabsTpl:Upfront.Util.template(t),elementSize:{width:0,height:0},initialize:function(){var e=this;this.model instanceof n||(this.model=new n({properties:this.model.get("properties")})),this.events=_.extend({},this.events,{"click .add-tab":"addTab","click .tabs-tab":"onTabClick","keydown .tabs-tab[contenteditable=true]":"onTabKeydown","keydown .tab-content-active":"onContentKeydown","dblclick .tab-content-active":"onContentDblclick","click i":"deleteTab"}),this.delegateEvents(),this.model.get("properties").bind("change",this.render,this),this.model.get("properties").bind("add",this.render,this),this.model.get("properties").bind("remove",this.render,this),Upfront.Events.on("entity:resize_stop",this.onResizeStop,this),this.on("deactivated",this.stopEdit,this),this.debouncedSave=_.debounce(this.saveTabContent,1e3)},addTab:function(){this.property("tabs").push({title:"Tab "+(1+this.property("tabs_count")),content:"Content "+(1+this.property("tabs_count"))}),this.property("tabs_count",this.property("tabs").length,!1)},deleteTab:function(t){var n=e(t.currentTarget),r=n.parents(".tabs-tab"),i=e(r).data("content-id").split("-").pop();this.property("tabs").splice(i,1),this.property("tabs_count",this.property("tabs_count")-1,!1)},fixTabWidth:function(){var t=this.$el.width()-36-30,n=0,r="auto",i,s=36;this.property("theme_style")==="simple_text"&&(s=26),this.property("theme_style")==="button_tabs"&&(s=47,t+=5),this.$el.find(".tabs-menu span").css("width","auto"),this.$el.find(".tabs-tab").each(function(){n+=e(this).outerWidth()}),n>t?(r=(t-10)/this.property("tabs_count"),i=Math.floor(r)-s+"px",this.property("tabs_fixed_width",i),this.$el.find(".tabs-menu span").css("width",i)):(this.property("tabs_fixed_width","auto"),this.$el.find(".tabs-menu span").css("width","auto"))},onTabClick:function(t){var n=e(t.currentTarget),r;if(n.hasClass("tabs-tab-active")){n.attr("contenteditable",!0),n.find("span").css("width","auto"),n.focus();return}n.addClass("tabs-tab-active"),n.siblings().removeClass("tabs-tab-active").removeAttr("contenteditable"),this.$el.find(".tab-content-active").attr("contenteditable")===!0&&this.stopEdit(),r=n.data("content-id"),e(".tab-content").removeClass("tab-content-active"),e("#"+r).addClass("tab-content-active")},onContentDblclick:function(t){var n=e(t.currentTarget);if(n.attr("contenteditable")===!0)return;n.attr("contenteditable",!0).addClass("upfront-object"),this.editor=CKEDITOR.inline(n[0]),n.focus(),this.$el.parent().parent().parent().draggable("disable")},onContentKeydown:function(e){this.debouncedSave()},saveTabContent:function(){var e=this.$el.find(".tab-content-active"),t=e.attr("id").split("-").pop();this.property("tabs")[t].content=e.html()},stopEdit:function(){this.saveTabContent(),this.$el.find(".tab-content-active").removeAttr("contenteditable").removeClass("upfront-object"),this.editor&&this.editor.destroy&&this.editor.destroy(),this.$el.parent().parent().parent().draggable("enable"),this.delegateEvents()},onTabKeydown:function(t){var n;t.keyCode===13&&(t.preventDefault(),e(t.currentTarget).removeAttr("contenteditable"),n=e(t.currentTarget).data("content-id").split("-").pop(),this.property("tabs")[n].title=e(t.currentTarget).text(),this.fixTabWidth(),this.addTooltips(),e(t.currentTarget).find("i").size()<1&&e(t.currentTarget).append("<i>x</i>"))},get_content_markup:function(){return this.tabsTpl(_.extend(this.extract_properties(),{show_add:!0,show_remove:this.property("tabs_count")>1?!0:!1}))},extract_properties:function(){var e={};return this.model.get("properties").each(function(t){e[t.get("name")]=t.get("value")}),e},onResizeStop:function(e,t,n){this.fixTabWidth()},on_render:function(){_.delay(function(e){e.fixTabWidth(),e.addTooltips()},10,this)},addTooltips:function(){e(".tabs-tab").each(function(){var t=e(this).find("span")[0];t.offsetWidth<t.scrollWidth&&e(this).attr("title",e(t).text().trim())})},property:function(e,t,n){return typeof t!="undefined"?(typeof n=="undefined"&&(n=!0),this.model.set_property(e,t,n)):this.model.get_property_value_by_name(e)}}),i=Upfront.Views.Editor.Sidebar.Element.extend({priority:100,render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-tabs"),this.$el.html("Tabs")},add_element:function(){var e=new n,t=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c9 upfront-tabs_module"},{name:"has_settings",value:0},{name:"row",value:15}],objects:[e]});this.add_module(t)}}),s=Upfront.Views.Editor.Settings.Settings.extend({initialize:function(){this.panels=_([new o({model:this.model})])},get_title:function(){return"Tabs settings"}}),o=Upfront.Views.Editor.Settings.Panel.extend({className:"utabs-settings-panel",initialize:function(){var e,t=this;e=function(){this.settings.invoke("render")},_.bindAll(this,"onActiveTabColorChange","onInactiveTabColorChange","onActiveTabTextColorChange","onInactiveTabTextColorChange"),this.model.on("doit",e,this),this.settings=_([new Upfront.Views.Editor.Settings.Item({model:this.model,title:"Display style",fields:[new Upfront.Views.Editor.Field.Select({model:this.model,property:"theme_style",label:"Theme Styles",values:[{label:"Tabbed",value:"tabbed"},{label:"Simple text",value:"simple_text"},{label:"Button Tabs",value:"button_tabs"}]})]})]),this.$el.on("change","input[name=style_type]",function(e){t.onStyleTypeChange(e)}),this.$el.on("change","input[name=theme_style]",function(e){t.onThemeStyleChange(e)}),this.$el.on("change","input[name=custom_style]",function(e){t.onCustomStyleChange(e)})},onStyleTypeChange:function(t){this.property("style_type",e(t.currentTarget).val(),!1),this.setColorChooserVisibility()},onCustomStyleChange:function(t){this.property("custom_style",e(t.currentTarget).val(),!1),this.setColorChooserVisibility()},onThemeStyleChange:function(t){this.property("theme_style",e(t.currentTarget).val(),!1)},onActiveTabColorChange:function(e){this.property("active_tab_color",e.toHslString(),!1)},onActiveTabTextColorChange:function(e){this.property("active_tab_text_color",e.toHslString(),!1)},onInactiveTabColorChange:function(e){this.property("inactive_tab_color",e.toHslString(),!1)},onInactiveTabTextColorChange:function(e){this.property("inactive_tab_text_color",e.toHslString(),!1)},setColorChooserVisibility:function(){e(".upfront-field-wrap-color").css("visibility","hidden");if(this.property("style_type")==="theme_defined")return;if(this.property("custom_style")==="simple_text"){e(".text-color").css("visibility","visible");return}e(".upfront-field-wrap-color").css("visibility","visible")},get_label:function(){return"Appearance"},get_title:function(){return!1},property:function(e,t,n){return typeof t!="undefined"?(typeof n=="undefined"&&(n=!0),this.model.set_property(e,t,n)):this.model.get_property_value_by_name(e)},render:function(){o.__super__.render.apply(this,arguments),_.delay(function(e){e.setColorChooserVisibility()},1,this)}});Upfront.Application.LayoutEditor.add_object("Utabs",{Model:n,View:r,Element:i,Settings:s,anchor:{is_target:!1}}),Upfront.Models.UtabsModel=n,Upfront.Views.UtabsView=r})}(jQuery),function(e){define("this_post",[],function(){var t=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(Upfront.data.thisPost.defaults);e.element_id=Upfront.Util.get_unique_id(e.id_slug+"-object"),this.init_properties(e)}}),n=Upfront.Views.ObjectView.extend({changed:!1,markup:!1,loading:!1,postId:!1,editor:!1,initialize:function(e){this.model instanceof t||(this.model=new t({properties:this.model.get("properties")})),this.constructor.__super__.initialize.call(this,[e]),this.postId=_upfront_post_data.post_id?_upfront_post_data.post_id:Upfront.Settings.LayoutEditor.newpostType?0:!1},get_content_markup:function(){return this.changed||!this.markup?(this.refreshMarkup(),"Loading"):this.markup},on_edit:function(){console.log("Start editing"),this.updateEditor(e("#"+this.property("element_id")).find(".upfront-object-content")),this.editor.editTitle()},refreshMarkup:function(){var t=this;if(this.postId===!1)return(new e.Deferred).resolve({data:{filtered:"Error"}});var n=e("#"+t.property("element_id")).find(".upfront-object-content"),r=n.length?new Upfront.Views.Editor.Loading({loading:"Refreshing post ...",done:"Here we are!",fixed:!1}):!1;return r&&(r.render(),n.append(r.$el)),Upfront.Util.post({action:"this_post-get_markup",data:JSON.stringify({post_id:this.postId,post_type:Upfront.Settings.LayoutEditor.newpostType,properties:{post_data:this.property("post_data")}})}).success(function(n){r&&(r.done(),r=!1);var i=i||e("#"+t.property("element_id")).find(".upfront-object-content");t.markup=n.data.filtered,i.html(t.get_content_markup());var s=Upfront.data.posts[t.postId];s&&s.is_new&&(_.each(Upfront.data.ueditor.selectors,function(e){e.type=="title"&&i.find(e.selector).html("")}),t.updateEditor(i),t.editor.editTitle(),t.editor.post.is_new=!1,t.editor.post.on("editor:publish",function(){t.redirectPostEdit(t.editor.post)}),t.editor.post.on("editor:draft",function(){(Upfront.Settings.Application.MODE.ALLOW.indexOf(Upfront.Settings.Application.MODE.LAYOUT)==-1||confirm("Do you want to re-load in layout mode?"))&&t.redirectPostEdit(t.editor.post)}))})},redirectPostEdit:function(e){var t="/edit/"+e.get("post_type")+"/"+e.id;Upfront.Application.navigate(t,{trigger:!0}),Upfront.Settings.Application.MODE.ALLOW.indexOf(Upfront.Settings.Application.MODE.LAYOUT)!=-1&&Upfront.Application.set_current(Upfront.Settings.Application.MODE.LAYOUT)},updateEditor:function(e){var t=this;if(this.editor)return this.editor.updateElement(e);this.editor=new Upfront.Content.editor({editor_id:"this_post_"+this.postId,post_id:this.postId,preload:!0,node:e,content_mode:"post_content",view:t,autostart:!0,onUpdated:function(e){t.refreshMarkup(e)}})},on_element_edit_start:function(e,t){e=="write"&&this.parent_module_view&&(t.id!=this.postId?this.parent_module_view.disable():this.parent_module_view.$el.find(".upfront-module").addClass("upfront-module-editing"))},on_element_edit_stop:function(e,t){this.parent_module_view&&(this.parent_module_view.$el.find(".upfront-module").removeClass("upfront-module-editing"),this.parent_module_view.enable())},property:function(e,t,n){return typeof t!="undefined"?(typeof n=="undefined"&&(n=!0),this.model.set_property(e,t,n)):this.model.get_property_value_by_name(e)}}),r=Upfront.Views.Editor.Sidebar.Element.extend({draggable:!1,render:function(){this.$el.html("This Post")},add_element:function(){var e=new t,n=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c6 upfront-this_post_module"},{name:"has_settings",value:0}],objects:[e]});this.add_module(n)}}),i=Upfront.Views.Editor.Settings.Item.extend({initialize:function(){var e=[{label:"Post Author",value:"author"},{label:"Post Date",value:"date"},{label:"Categories",value:"categories"},{label:"Tags",value:"tags"},{label:"Comments count",value:"comments_count"},{label:"Featured image",value:"featured_image"}];this.fields=_([new Upfront.Views.Editor.Field.Checkboxes({model:this.model,label:"Show the following Post Data:",property:"post_data",values:e})])},get_title:function(){return"Post Data"}}),s=Upfront.Views.Editor.Settings.Panel.extend({label:"This post",initialize:function(){this.settings=_([new i({model:this.model})])},get_label:function(){return this.label},get_title:function(){return"Post settings"}}),o=Upfront.Views.Editor.Settings.Settings.extend({initialize:function(){this.panels=_([new s({model:this.model})])},get_title:function(){return"Post settings"}});Upfront.Application.LayoutEditor.add_object("ThisPost",{Model:t,View:n,Element:r,Settings:o}),Upfront.Models.ThisPostModel=t,Upfront.Views.ThisPostView=n,Upfront.data.thisPost.PostDataPanel=s})}(jQuery),function(e){define("this_page",[],function(){var t=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(Upfront.data.thisPage.defaults);e.element_id=Upfront.Util.get_unique_id(e.id_slug+"-object"),this.init_properties(e)}}),n=function(){var n=!1,r=!1,i=!1,s=!1,o=[],u={},a={};return Upfront.Views.ObjectView.extend({markup:!1,loading:!1,display:"title",deferred:!1,is_new:!1,is_started:!1,initialize:function(e){var r=this;this.model instanceof t||(this.model=new t({properties:this.model.get("properties")})),this.constructor.__super__.initialize.call(this,[e]),this.display=this.model.get_property_value_by_name("display"),o.push(this),n=_upfront_post_data.post_id?_upfront_post_data.post_id:Upfront.Settings.LayoutEditor.newpostType?0:!1,this.listenTo(Upfront.Events,"command:layout:save_start",this.on_save)},get_content_markup:function(){return r||!this.markup?(this.get_markup().done(e.proxy(this.refresh_markup,this)),"Loading"):this.markup},on_render:function(){this.update_editor(this.$el.find(".upfront-object-content"))},on_edit:function(){this.update_editor(this.$el.find(".upfront-object-content"),!0,!0)},get_markup:function(){var t=this;t.deferred=new e.Deferred;if(n===!1)return t.deferred.resolve("error");if(i)return t.deferred.promise();if(!r&&u.length>0&&u[t.display])return t.deferred.resolve(u[t.display]);var s=t.$el.find(".upfront-object-content"),a=s.length?new Upfront.Views.Editor.Loading({loading:"Refreshing...",done:"Here we are!",fixed:!1}):!1;return a&&(a.render(),s.append(a.$el)),i=!0,Upfront.Util.post({action:"this_page-get_markup",data:JSON.stringify({post_id:n,post_type:Upfront.Settings.LayoutEditor.newpostType})}).success(function(e){a&&(a.done(),a=!1);var r=r||t.$el.find(".upfront-object-content"),i=Upfront.data.posts[n];u=e.data.filtered,_.each(o,function(e){e.is_new=i&&i.is_new,e.deferred.resolve(u[e.display])}),i&&(i.is_new=!1)}).done(function(){i=!1}),t.deferred.promise()},get_page:function(){var t,r=new e.Deferred;return Upfront.data.posts[n]?(t=Upfront.data.posts[n],r.resolve(t)):(t=new Upfront.Models.Post({ID:n}),t.fetch({withMeta:!0,filterContent:!0}).done(function(e){Upfront.data.posts||(Upfront.data.posts={}),Upfront.data.posts[n]=t,r.resolve(t)}),r.promise())},refresh_markup:function(e){var t=this,n=this.$el.find(".upfront-object-content"),r=_.findWhere(Upfront.data.ueditor.selectors,{type:this.display}).selector,i="";this.get_page().done(function(s){n.html(e),t.display=="title"?i=s.get("post_title"):t.display=="content"&&(i=s.get("post_content")),n.find(r).html(i),t.markup=n.html(),t.update_editor(n)})},update_editor:function(t,n,r){var i=this,r=typeof r=="undefined"?!0:r,s=_.findWhere(Upfront.data.ueditor.selectors,{type:this.display}).selector,u=t.find(s),f=u.data("ueditor"),l={},c=!1;if(f){n===!0&&!i.is_started&&u.trigger("dblclick");return}i.display=="title"?l={airButtons:{},observeLinks:!1,tabFocus:!1,disableLineBreak:!0,pastePlainText:!0,autostart:n===!0,placeholder:"Write a title...",focus:r}:i.display=="content"&&(l={linebreaks:!1,autostart:n===!0,placeholder:"Your content goes here ;)",focus:r,upfrontMedia:!0,upfrontImages:!0}),u.on("start",function(){c=!0,i.is_started=!0,_.each(o,function(e){if(e==i)return;e.update_editor(e.$el.find(".upfront-object-content"),!0,!1)}),setTimeout(function(){u.ueditor("focus")},100),Upfront.Events.trigger("upfront:element:edit:start","text")}).on("stop",function(){c=!1,i.is_started=!1,Upfront.Events.trigger("upfront:element:edit:stop")}).on("syncAfter",function(){c&&(a[i.display]=u.ueditor("get"),i.markup=e(i.markup).html(a[i.display]).get(0).outerHTML)}).ueditor(l)},on_save:function(){if(s)return;s=!0;var e=this;this.get_page().done(function(t){t.set("post_status","publish"),t.set("post_title",a.title),t.set("post_content",a.content),t.save().done(function(){if(!e.is_new)return;var t="/edit/page/"+n;Upfront.Application.navigate(t),s=!1})})},cleanup:function(){var e=this;_.each(o,function(t,n){t==e&&o.splice(n)})}})}(),r=Upfront.Views.Editor.Sidebar.Element.extend({draggable:!1,render:function(){this.$el.html("Page Title")},add_element:function(){var e=new t({view:"ThisPageTitle"}),n=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c6 upfront-this_page_title_module"},{name:"has_settings",value:0}],objects:[e]});this.add_module(n)}}),i=Upfront.Views.Editor.Sidebar.Element.extend({draggable:!1,render:function(){this.$el.html("Page Content")},add_element:function(){var e=new t({view:"ThisPageContent"}),n=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c6 upfront-this_page_content_module"},{name:"has_settings",value:0}],objects:[e]});this.add_module(n)}});Upfront.Models.ThisPageModel=t,Upfront.Views.ThisPageView=n})}(jQuery),function(e){define("uwidget",[],function(){var e=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(Upfront.data.uwidget.defaults);e.element_id=Upfront.Util.get_unique_id(e.id_slug+"-object"),this.init_properties(e)}}),t=Upfront.Views.ObjectView.extend({loading:null,content_loaded:!1,initialize:function(t){this.model instanceof e||(this.model=new e({properties:this.model.get("properties")})),this.constructor.__super__.initialize.call(this,[t])},init:function(){Upfront.data.uwidget.widgets_cache||(Upfront.data.uwidget.widgets_cache={}),Upfront.Events.on("entity:settings:activate",this.clear_cache,this)},clear_cache:function(){Upfront.data.uwidget.widgets_cache[this.model.get_property_value_by_name("widget")+this.cid]=null},get_content_markup:function(){var e=this.model.get_property_value_by_name("widget");me=this;if(!e)return"Please select widget on settings";var t=Upfront.data.uwidget.widgets_cache[e+this.cid]||"";return t&&(this.content_loaded=!0),t},on_render:function(){var e=this.model.get_property_value_by_name("widget");if(!e)return;if(typeof Upfront.data.uwidget.widgets_cache[e+this.cid]=="undefined"||Upfront.data.uwidget.widgets_cache[e+this.cid]==null)this.content_loaded&&(this.loading=new Upfront.Views.Editor.Loading({loading:"Loading...",done:"Done!"}),this.loading.render(),this.$el.append(this.loading.el)),this._get_widget_markup(e)},_get_widget_markup:function(e){var t=this,n=this.model.get_property_value_by_name("widget_specific_fields"),r={};for(key in n)r[n[key].name]=this.model.get_property_value_by_name(n[key].name);Upfront.Util.post({action:"uwidget_get_widget_markup",data:JSON.stringify({widget:e,instance:r})}).success(function(n){Upfront.data.uwidget.widgets_cache[e+t.cid]=n.data,t.loading?t.loading.done(function(){t.render()}):t.render()}).error(function(e){Upfront.Util.log("Error loading widget")})}}),n=Upfront.Views.Editor.Sidebar.Element.extend({priority:120,render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-widget"),this.$el.html("Widget")},add_element:function(){var t=new e,n=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c6 upfront-widget_module"},{name:"has_settings",value:0},{name:"row",value:10}],objects:[t]});this.add_module(n)}}),r=Upfront.Views.Editor.Settings.Item.extend({get_title:function(){for(i in Upfront.data.uwidget.widgets)if(Upfront.data.uwidget.widgets[i].class==this.model.get_property_value_by_name("selected_widget"))return Upfront.data.uwidget.widgets[i].name;return this.model.get_property_value_by_name("widget")},update_settings:function(e,t){var n=this;Upfront.Util.post({action:"uwidget_get_widget_admin_form",data:JSON.stringify({widget:e})}).success(function(r){n.model.set_property("widget_specific_fields",r.data),n.$el.html(""),n.model.set_property("selected_widget",e),n.model.set_property("widget",e),n.udpate_fields(),n.render(),t.$el.parent().parent().parent().parent().parent().parent().parent().height(t.$el.parent().parent().parent().parent().height()+22)}).error(function(e){console.log("error receiving widget specific settings")})},initialize:function(){this.model.set_property("selected_widget",this.model.get_property_value_by_name("widget")),this.udpate_fields()},udpate_fields:function(){var e=this;this.fields=_([]);var t=this.model.get_property_value_by_name("widget_specific_fields");for(key in t)t[key]["type"]=="select"?this.fields._wrapped[this.fields._wrapped.length]=new Upfront.Views.Editor.Field.Select({model:this.model,property:t[key].name,label:t[key].label,values:_.map(t[key].options,function(e,t){return{label:e,value:t}}),change:this.clear_cache}):t[key]["type"]=="text"?this.fields._wrapped[this.fields._wrapped.length]=new Upfront.Views.Editor.Field.Text({model:this.model,property:t[key].name,label:t[key].label,value:t[key].value,change:this.clear_cache}):t[key]["type"]=="textarea"?this.fields._wrapped[this.fields._wrapped.length]=new Upfront.Views.Editor.Field.Textarea({model:this.model,property:t[key].name,label:t[key].label,value:t[key].value,change:this.clear_cache}):t[key]["type"]=="checkbox"?this.fields._wrapped[this.fields._wrapped.length]=new Upfront.Views.Editor.Field.Checkboxes({model:this.model,property:t[key].name,label:"",values:[{label:t[key].label,value:t[key].value}],change:this.clear_cache}):t[key]["type"]=="radio"&&(this.fields._wrapped[this.fields._wrapped.length]=new Upfront.Views.Editor.Field.Radios({model:this.model,property:t[key].name,label:"",values:[{label:t[key].label,value:t[key].value}],change:this.clear_cache}))},clear_cache:function(){Upfront.data.uwidget.widgets_cache={}}}),s=Upfront.Views.Editor.Settings.Settings.extend({initialize:function(){var e=_.map(Upfront.data.uwidget.widgets,function(e){return{label:e.name,value:e.class}}),t=new Upfront.Views.Editor.Settings.Panel({model:this.model,label:"Widget",title:"Widget settings",min_height:"200px"}),n=new r({model:this.model}),i=new Upfront.Views.Editor.Settings.Item({model:this.model,title:"Select Widget",fields:[new Upfront.Views.Editor.Field.Select({model:this.model,property:"widget",label:"",values:e,change:function(){var e=this.$el.find(".upfront-field-select-option input:checked");this.model.get_property_value_by_name("selected_widget")!=e.val()&&n.update_settings(e.val(),this)}})]});t.settings=_([i,n]),this.panels=_([t])},get_title:function(){return"Widget settings"}});Upfront.Application.LayoutEditor.add_object("Uwidget",{Model:e,View:t,Element:n,Settings:s}),Upfront.Models.UwidgetModel=e,Upfront.Views.UwidgetView=t})}(jQuery),define("text!elements/upfront-youtube/tpl/youtube.html",[],function(){return'<div class=" upfront-youtube-container" id="<?php echo $element_id ?>">\r\n  <?php if ($videoType == \'single\') { ?>\r\n    <?php if ($single_video_url) { ?>\r\n      <iframe src="http://www.youtube.com/embed/<?php echo $single_video_id ?>?modestbranding=1" height="<?php echo $player_height ?>" width="<?php echo $player_width ?>"></iframe>\r\n      <?php if($show_title[0]){ ?>\r\n        <h3><?php echo $title ?></h3>\r\n      <?php } ?>\r\n      <?php if($show_description[0]){ ?>\r\n        <p><?php echo $description ?></p>\r\n      <?php } ?>\r\n    <?php } else { ?>\r\n      <div class="uyoutube-player" style="width: <?php echo $player_width ?>px; height: <?php echo $player_height ?>px;"></div>\r\n    <?php } ?>\r\n  <?php } ?>\r\n  <?php if ($videoType == \'multiple\') { ?>\r\n    <div class="uyoutube-main-video">\r\n      <?php if ($multiple_videos[0]) { ?>\r\n        <iframe src="http://www.youtube.com/embed/<?php echo $multiple_videos[0][\'id\'] ?>?modestbranding=1" height="<?php echo $player_height ?>" width="<?php echo $player_width ?>"></iframe>\r\n      <?php } else { ?>\r\n        <div class="uyoutube-player" style="height:<?php echo $player_height ?>px; width:<?php echo $player_width ?>px;"></div>\r\n      <?php } ?>\r\n    </div>\r\n    <?php if ($display_style == \'gallery\') { ?>\r\n      <?php if ($multiple_videos) { ?>\r\n        <?php for ($i = 0; $i < $multiple_count; $i++) { ?>\r\n          <div class="uyoutube-gallery-item" data-video-id="<?php echo $multiple_videos[$i][\'id\'] ?>" style="width:<?php echo $thumbWidth ?>px;">\r\n            <div class="uyoutube-thumb-mask" style="width:<?php echo $thumbWidth ?>px;height:<?php echo $thumbHeight ?>px"><!-- add width height dynamicly -->\r\n              <img class="uyoutube-thumb" src="<?php echo $multiple_videos[$i][\'thumbnail\'] ?>" style="width:<?php echo $thumbWidth ?>px; margin-top: -<?php echo $thumbOffset ?>px;">\r\n            </div>\r\n            <?php if($multiple_show_title[0]){ ?>\r\n            <h4 class="uyoutube-title"><?php echo $multiple_videos[$i][\'title\'] ?></h4>\r\n            <?php } ?>\r\n          </div>\r\n        <?php } ?>\r\n      <?php } else { ?>\r\n        <?php for ($i = 0; $i < $multiple_count; $i++) { ?>\r\n          <div class="uyoutube-gallery-item" style="width:<?php echo $thumbWidth ?>px;">\r\n            <div class="uyoutube-thumb-mask" style="width:<?php echo $thumbWidth ?>px;height:<?php echo $thumbHeight ?>px"></div><!-- add width height dynamicly -->\r\n          </div>\r\n        <?php } ?>\r\n      <?php } ?>\r\n    <?php } ?>\r\n    <?php if ($display_style == \'list\') { ?>\r\n      <?php if ($multiple_videos) { ?>\r\n        <?php for ($i = 0; $i < $multiple_count; $i++) { ?>\r\n        <div class="uyoutube-list-item" data-video-id="<?php echo $multiple_videos[$i][\'id\'] ?>">\r\n            <div class="uyoutube-thumb-holder" style="width:<?php echo $thumbWidth ?>px;">\r\n              <div class="uyoutube-thumb-mask" style="width:<?php echo $thumbWidth ?>px;height:<?php echo $thumbHeight ?>px">\r\n                <img class="uyoutube-thumb" style="width:<?php echo $thumbWidth ?>px; margin-top: -<?php echo $thumbOffset ?>px" src="<?php echo $multiple_videos[$i][\'thumbnail\'] ?>" width="80">\r\n              </div>\r\n            </div>\r\n            <div class="uyoutube-content-holder">\r\n              <?php if ($multiple_show_title[0]) { ?>\r\n                <h4 class="uyoutube-title"><?php echo $multiple_videos[$i][\'title\'] ?></h4>\r\n              <?php } ?>\r\n              <?php if ($multiple_show_description[0]) { ?>\r\n                <p class="uyoutube-description"><?php echo $multiple_videos[$i][\'description\'] ?></p>\r\n              <?php } ?>\r\n            </div>\r\n          </div>\r\n        <?php } ?>\r\n      <?php } else { ?>\r\n        <?php for ($i = 0; $i < $multiple_count; $i++) { ?>\r\n          <div class="uyoutube-list-item">\r\n            <div class="uyoutube-thumb-holder" style="width:<?php echo $thumbWidth ?>px;">\r\n              <div class="uyoutube-thumb-mask" style="width:<?php echo $thumbWidth ?>px; height:<?php echo $thumbHeight ?>px"></div>\r\n            </div>\r\n            <div class="uyoutube-content-holder">\r\n              <h4 class="uyoutube-title uyoutube-fake-title"></h4>\r\n              <p class="uyoutube-description uyoutube-fake-description"></p>\r\n            </div>\r\n          </div>\r\n        <?php } ?>\r\n      <?php } ?>\r\n    <?php } ?>\r\n  <?php } ?>\r\n</div>\r\n'}),function(e){define("uyoutube",["text!elements/upfront-youtube/tpl/youtube.html"],function(t){var n=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(Upfront.data.uyoutube.defaults);e.element_id=Upfront.Util.get_unique_id("youtube-object"),this.init_properties(e)}}),r=Upfront.Views.ObjectView.extend({model:n,youtubeTpl:Upfront.Util.template(t),elementSize:{width:0,height:0},initialize:function(){var e=this;this.model instanceof n||(this.model=new n({properties:this.model.get("properties")})),this.events=_.extend({},this.events,{"click .single-video":"setType","click .multiple-videos":"setType"}),this.delegateEvents(),this.model.get("properties").bind("change",this.render,this),this.model.get("properties").bind("add",this.render,this),this.model.get("properties").bind("remove",this.render,this),Upfront.Events.on("entity:resize_stop",this.onResizeStop,this)},setType:function(t){this.property("youtube_status","ok"),e(t.currentTarget).hasClass("single-video")?this.property("videoType","single",!1):this.property("videoType","multiple",!1),Upfront.Events.trigger("entity:settings:activate",this)},get_content_markup:function(){var e,t=this.extract_properties();return this.model.set_property("description",t.full_description.substring(0,t.description_length)),this.model.set_property("title",t.full_title.substring(0,t.title_length)),t.videoType==="multiple"&&t.display_style==="list"&&this.trimListDescriptions(),e=this.youtubeTpl(this.extract_properties()),this.property("youtube_status")==="starting"&&(e+='<div class="upfront-youtube-starting-select" style="min-height:'+this.elementSize.height+'px">'+'<span class="upfront-youtube-starting-title">Video List or Single Video?</span>'+'<div class="upfront-youtube-resizing-icons">'+'<a class="upfront-youtube-select-button button multiple-videos" href="#"><span class="yticon"></span><span class="ytdesc">Multiple Videos</span></a>'+'<a class="upfront-youtube-select-button button single-video" href="#"><span class="yticon"></span><span class="ytdesc">Single Video</span></a>'+"</div>"+"</div>"),e},trimListDescriptions:function(){var t=this,n=this.extract_properties();e.each(n.multiple_videos,function(e,n){n.original_description&&(n.description=n.original_description.substring(0,t.property("multiple_description_length")))})},extract_properties:function(){var e={};return this.model.get("properties").each(function(t){e[t.get("name")]=t.get("value")}),e},onResizeStop:function(e,t,n){var r;this.property("youtube_status")!=="starting"&&(r=this.$el.find(".upfront-object-content").width(),this.property("player_height",parseInt(r/1.641,10)),this.property("player_width",r,!1))},property:function(e,t,n){return typeof t!="undefined"?(typeof n=="undefined"&&(n=!0),this.model.set_property(e,t,n)):this.model.get_property_value_by_name(e)}}),i=Upfront.Views.Editor.Sidebar.Element.extend({priority:110,render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-youtube"),this.$el.html("YouTube")},add_element:function(){var e=new n,t=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c11 upfront-youtube_module"},{name:"has_settings",value:0},{name:"row",value:15}],objects:[e]});this.add_module(t)}}),s=Upfront.Views.Editor.Field.Text.extend({className:function(){var e="upfront-field-wrap upfront-field-wrap-number";return this.options.disabled?e+" upfront-field-wrap-disabled":e},get_field_html:function(){var e={type:"number","class":"upfront-field upfront-field-number",id:this.get_field_id(),name:this.get_field_name(),value:this.get_saved_value(),min:this.options.min,max:this.options.max,step:this.options.step};return this.options.disabled&&(e.disabled="disabled")," <input "+this.get_field_attr_html(e)+" /> "+(this.options.suffix?this.options.suffix:"")}}),o=Upfront.Views.Editor.Settings.Settings.extend({events:{'change [name="video_url"]':"singleVideo",'change [name="multiple_source_id"]':"multipleVideos",'change [name="videoType"]':"setType"},initialize:function(){this.panels=_([new u({model:this.model})])},actions:{single:"upfront_youtube_single",channel:"upfront_youtube_channel",playlist:"upfront_youtube_playlist"},singleVideo:function(t){var n=this,r=e(t.currentTarget).val(),i=r.match(/^(https?:\/\/(www\.)?)?youtube\.com\/watch\?v=([0-9a-zA-Z\-_]{11}).*/)[3],s={video_id:i};Upfront.Util.post({action:this.actions.single,data:s}).success(function(e){n.for_view.model.set_property("full_title",e.data.video.title,!1),n.for_view.model.set_property("full_description",e.data.video.description,!1),n.for_view.model.set_property("single_video_id",i,!1),n.for_view.model.set_property("single_video_url",r)}).error(function(){Upfront.Util.log("error single video")})},multipleVideos:function(t){var n=this,r=e(t.currentTarget).val(),i=this.$el.find('[name="multiple_source"]:checked').val();i==="user_channel"?Upfront.Util.post({action:this.actions.channel,data:{channel:r}}).success(function(e){n.for_view.model.set_property("multiple_videos",e.data.videos)}).error(function(){Upfront.Util.log("error channel video")}):(r.match(/^http/)&&(r=r.match(/^(https?:\/\/(www\.)?)?youtube\.com\/.*list=([0-9a-zA-Z\-_]+).*/)[3]),Upfront.Util.post({action:this.actions.playlist,data:{playlist:r}}).success(function(e){n.for_view.model.set_property("multiple_videos",e.data.videos)}).error(function(){Upfront.Util.log("error playlist videos")}))},setType:function(t){this.for_view.model.set_property("videoType",e(t.currentTarget).val(),!1)},get_title:function(){return"YouTube settings"}}),u=Upfront.Views.Editor.Settings.Panel.extend({className:"uyoutube-settings",tabbed:!0,initialize:function(){var e=function(){this.settings.invoke("render")},t=this,n=Upfront.Views.Editor.Settings.Item,r=Upfront.Views.Editor.Settings.ItemTabbed,i=Upfront.Views.Editor.Field;this.model.on("doit",e,this),this.settings=_([new r({model:this.model,title:"Multiple Videos",radio:!0,is_default:!0,icon:"video-multiple",property:"videoType",value:"multiple",settings:[new n({className:"optional-field align-center",title:"Display Style",fields:[new i.Radios({model:this.model,property:"display_style",layout:"horizontal",className:"field-display_style upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-radios",values:[{label:"Gallery",value:"gallery",icon:"display-style-gallery"},{label:"List",value:"list",icon:"display-style-list"}]})]}),new n({model:this.model,title:"Custom Options",fields:[new i.Radios({model:this.model,property:"multiple_source",layout:"horizontal-inline",values:[{label:"User Channel",value:"user_channel"},{label:"Playlist",value:"playlist"}]}),new i.Text({model:this.model,property:"multiple_source_id",label:"",placeholder:"YouTube Username or Channel ID"}),new s({model:this.model,property:"multiple_count",label:"Display",label_style:"inline",suffix:"latest Videos",min:3,max:60,step:1,default_value:6}),new i.Checkboxes({model:this.model,property:"multiple_show_title",values:[{value:"multiple_show_title",label:""}]}),new s({model:this.model,property:"multiple_title_length",label:"Title",label_style:"inline",suffix:"characters",min:50,max:100,step:1,default_value:100}),new i.Checkboxes({model:this.model,property:"multiple_show_description",values:[{label:"",value:"multiple_show_description",disabled:!0}]}),new i.Number({model:this.model,property:"multiple_description_length",label:"Description",label_style:"inline",suffix:"characters",min:50,max:100,step:1,default_value:100,disabled:!0}),new i.Slider({model:this.model,property:"thumbWidth",min:100,max:250,step:5,label:"Thumbnail Size",info:"Slide to resize the thumbnails.",valueTextFilter:function(e){return"("+e+"px x "+t.model.get_property_value_by_name("thumbHeight")+"px)"}}),new i.Hidden({model:this.model,property:"thumbHeight"})]})]}),new Upfront.Views.Editor.Settings.ItemTabbed({model:this.model,title:"Single Video",radio:!0,is_default:!1,icon:"video-single",property:"videoType",value:"single",settings:[new n({model:this.model,title:"Custom Options",fields:[new i.Text({model:this.model,property:"video_url",label:"",placeholder:"Video URL"}),new i.Checkboxes({model:this.model,property:"show_title",label:"",values:[{label:"",value:"show_title"}]}),new i.Number({model:this.model,property:"title_length",label:"Title",label_style:"inline",suffix:"characters",min:50,max:100,step:1,default_value:100}),new i.Checkboxes({model:this.model,property:"show_description",label:"",values:[{label:"",value:"show_description"}]}),new i.Number({model:this.model,property:"description_length",label:"Description",label_style:"inline",suffix:"characters",min:50,max:100,step:1,default_value:100})]})]})]),this.$el.on("change","input[name=display_style]",function(e){t.changeDisplayStyle(e)}).on("change","input[name=thumbWidth]",function(e){t.onThumbChangeSize(e)}),this.on("concealed",this.setFieldEvents,this)},get_label:function(){return"Settings"},get_title:function(){return!1},render:function(){this.constructor.__super__.render.apply(this,arguments),this.$el.find(".upfront-settings_label").remove(),this.$el.find(".upfront-settings_panel").css("left",0),this.toggleDescriptionEnabled(),this.$el.find("[name=multiple_show_description], [name=multiple_show_title], [name=show_title], [name=show_description]").parent().css({"float":"left","margin-top":"2px"})},onThumbChangeSize:function(t){var n=this,r=1.8,i=10.4,s=e(t.target).val(),o=Math.round(e(t.target).val()/r),u=Math.round(e(t.target).val()/i);return this.$("input[name=thumbHeight]").val(o),this.property("thumbWidth",s),this.property("thumbOffset",u),this.property("thumbHeight",o,!1),o},changeDisplayStyle:function(t){this.property("display_style",e(t.currentTarget).val(),!1),this.toggleDescriptionEnabled()},toggleDescriptionEnabled:function(){if(this.property("display_style")==="gallery"){this.$el.find("[name=multiple_description_length]").attr("disabled","disabled").parent().addClass("upfront-field-wrap-disabled"),this.$el.find("[name=multiple_show_description]").attr("disabled","disabled").parent().addClass("upfront-field-multiple-disabled");return}this.$el.find("[name=multiple_description_length]").removeAttr("disabled").parent().removeClass("upfront-field-wrap-disabled"),this.$el.find("[name=multiple_show_description]").removeAttr("disabled").parent().removeClass("upfront-field-multiple-disabled")},property:function(e,t,n){return typeof t!="undefined"?(typeof n=="undefined"&&(n=!0),this.model.set_property(e,t,n)):this.model.get_property_value_by_name(e)}});Upfront.Application.LayoutEditor.add_object("Uyoutube",{Model:n,View:r,Element:i,Settings:o,anchor:{is_target:!1}}),Upfront.Models.UyoutubeModel=n,Upfront.Views.UyoutubeView=r})}(jQuery),define("text!elements/upfront-code/css/editor.css",[],function(){return"/* Common */\n\n.upfront_code-editor {\n	position: fixed;\n	width: 100%;\n	cursor: auto;\n	right: 0;\n	bottom: 0;\n	z-index: 100;\n	min-height: 200px;\n	display: none\n}\n\n.upfront_code-editor button {\n	background: #2ecc90;\n	color: #fff;\n	position: absolute;\n	bottom: 10px;\n	right: 25px;\n	padding: 5px 10px;\n	border-radius: 0;\n	font-size: 14px;\n}\n.upfront_code-editor button:hover {\n	background: #3ea;\n}\n\n.upfront-icon-button.re-edit:before {\n	/*\n	background-position: -701px -710px;\n	*/\n	display: none;\n}\n.upfront-icon-button.re-edit {\n	background: #515b65; /* Old browsers */\n	background: -moz-linear-gradient(-45deg,  #515b65 47%, #454e56 49%); /* FF3.6+ */\n	background: -webkit-gradient(linear, left top, right bottom, color-stop(47%,#515b65), color-stop(49%,#454e56)); /* Chrome,Safari4+ */\n	background: -webkit-linear-gradient(-45deg,  #515b65 47%,#454e56 49%); /* Chrome10+,Safari5.1+ */\n	background: -o-linear-gradient(-45deg,  #515b65 47%,#454e56 49%); /* Opera 11.10+ */\n	background: -ms-linear-gradient(-45deg,  #515b65 47%,#454e56 49%); /* IE10+ */\n	background: linear-gradient(135deg,  #515b65 47%,#454e56 49%); /* W3C */\n\n	color: #97b8da;\n	font-size: 14px;\n	line-height: 20px;\n	text-align: center;\n}\n\n/* Simple */\n.upfront_code-editor.upfront_code-editor-simple {\n	padding: 10px;\n}\n.upfront_code-editor.upfront_code-editor-simple h3 {\n	margin: 0;\n	text-transform: none;\n}\n\n.upfront_code-editor-simple textarea {\n	min-height: 80px;\n}\n\n/* Complex */\n.upfront_code-editor.upfront_code-editor-complex textarea {\n	color: white;\n	background: #454e58;\n	border: none;\n	outline: none;\n}\n.upfront_code-editor .upfront_code-editor-complex-wrapper {\n	position: absolute;\n	width: 100%;\n	bottom: 0;\n	left: 0;\n	background: #3d5266;\n	min-height: 200px;\n}\n\n.upfront_code-switches {\n	margin: 2px 15px 0 20px;\n	float: left;\n}\n\n\n.upfront_code-switch {\n	color: #cbe5ff;\n	float: left;\n	padding: 2px 10px;\n	margin: 2px 5px 0 0;\n	cursor: pointer;\n}\n\n.upfront_code-switch:hover {\n	color: #dae6f2;\n	background: #2E3D4C;\n}\n\n.upfront_code-switch.active {\n	background: #26333F ;\n}\n\n.upfront_code-jsalert {\n	display: inline-block;\n	margin: 0 5px 0;\n	padding: 0 5px;\n	color: #444d56;\n	display: none;\n	float: left;\n}\n\n.upfront_code-jsalert .upfront-icon-button:before {\n	background-position: -480px -205px;\n	margin-top: 7px;\n}\n\n.upfront_code-editor-section {\n	height: 100%;\n}\n\n.upfront_code-editor.upfront_code-editor-complex .upfront_code-editor-complex-wrapper .upfront_code-editor-section {\n	display: none;\n}\n.upfront_code-editor.upfront_code-editor-complex .upfront_code-editor-complex-wrapper .upfront_code-editor-section.active {\n	display: block;\n}\n.upfront_code-editor.upfront_code-editor-complex .handle.ui-resizable-handle.ui-resizable-s {\n	text-align: center;\n	font-size: 18px;\n	line-height: 7px;\n	bottom: 5px;\n}\n\n.ace_editor.upfront_code-ace {\n	height: 100%;\n	width: 100%;\n}\n\n"}),define("text!elements/upfront-code/tpl/editor.html",[],function(){return'<div>\n<!-- Div to select elements inside -->\n\n<div id="editorTpl">\n		<div class="upfront_code-editor-complex-wrapper">\n			<div class="upfront-css-top ui-resizable-handle ui-resizable-n">\n				<div class="upfront_code-switches">\n					<div class="upfront_code-switch active" data-for="markup">HTML</div>\n					<div class="upfront_code-switch" data-for="style">CSS</div>\n					<div class="upfront_code-switch" data-for="script">JS</div>\n				</div>\n				<a class="upfront-css-image" href="#">Link image</a>\n				<input class="upfront-css-color" type="text">\n				<div class="upfront_code-jsalert error javascript"><i class="upfront-icon-button" title="There is an error in your JS code"></i></div>\n				<a class="upfront-css-close" href="#">close</a>\n			</div>\n			<div class="upfront-css-body">\n				<div class="upfront_code-editor-section upfront_code-markup active">\n					<div class="upfront_code-ace" data-type="markup" >{{markup}}</div>\n				</div>\n				<div class="upfront_code-editor-section upfront_code-style">\n					<div class="upfront_code-ace" data-type="style" >{{style}}</div>\n				</div>\n				<div class="upfront_code-editor-section upfront_code-script">\n					<div class="upfront_code-ace" data-type="script" >{{script}}</div>\n				</div>\n				<button>Save</button>\n			</div>\n		</div>\n</div>\n\n<div id="embedTpl">\n	<section class="upfront_code-editor-simple">\n		<h3>Paste your embed code below</h3>\n		<textarea class="upfront_code-markup" data-type="markup">{{ markup }}</textarea>\n		<button>Save</button>\n	</section>\n</div>\n\n</div>'}),function($,undefined){define("upfront_code",["text!elements/upfront-code/css/editor.css","text!elements/upfront-code/tpl/editor.html"],function(style,tplSource){$("head").append("<style>"+style+"</style>");var tpls=$(tplSource),CodeModel=Upfront.Models.ObjectModel.extend({init:function(){var e=_.clone(Upfront.data.upfront_code.defaults);e.element_id=Upfront.Util.get_unique_id(e.id_slug+"-object"),this.init_properties(e)}}),Views={Start:Backbone.View.extend({events:{"click .embed":"embed_code","click .create":"create_code"},render:function(){this.$el.empty().append('<p style="text-align:center"><button type="button" class="embed">Embed 3rd Party code</button>&nbsp;or&nbsp;<button type="button" class="create">Write Custom Code</button></p>')},embed_code:function(){this.model.set_property("code_selection_type","Embed",!0),this.trigger("code:selection:selected")},create_code:function(){this.model.set_property("code_selection_type","Create",!0),this.trigger("code:selection:selected")}}),Create:Upfront.Views.ObjectView.extend({is_editing:!1,script_error:!1,SYNTAX_TYPES:{markup:"html",style:"css",script:"javascript"},MIN_HEIGHT:200,editorTpl:_.template(tpls.find("#editorTpl").html()),initialize:function(){var e=this.fallback("script");this.checkJS(e)},get_content_markup:function(){var e=this.fallback("markup"),t=this.fallback("style"),n=this.script_error?"":"(function($){"+this.fallback("script")+"})(jQuery)",r=this.property("element_id"),i="";return console.log("CODE"),t&&_(t.split("}")).each(function(e,t){if(!e.length)return!0;i+="#"+r+" .upfront_code-element "+e+"}"}),'<section class="upfront_code-element clearfix">'+e+"<style>"+i+"</style>"+"<script>"+n+"</script>"+"</section>"},on_render:function(){this.$el.find(".upfront-entity_meta").append('<a href="#" class="upfront-icon-button re-edit">...</a>');var e=this;this.$el.find(".upfront-entity_meta .re-edit").on("click",function(t){t.preventDefault(),e.on_edit()}),!this.property("markup")&&!this.property("style")&&!this.property("script")&&setTimeout(function(){e.on_edit()},10)},on_edit:function(){if(this.is_editing)return!1;this.is_editing=!0;var e=$("#upfront_code-editor");e.length||(e=$('<section id="upfront_code-editor" class="upfront-ui upfront_code-editor upfront_code-editor-complex"></section>'),$("body").append(e)),this.createEditor(e)},createEditor:function(e){var t=this;e.html(this.editorTpl({markup:this.fallback("markup"),style:this.fallback("style"),script:this.fallback("script")})),e.show(),console.log("create editor"),this.resizeHandler=this.resizeHandler||function(){e.width($(window).width()-$("#sidebar-ui").width()-1)},$(window).on("resize",this.resizeHandler),this.resizeHandler(),this.editors={},this.timers={},__editors=[],e.find(".upfront_code-ace").each(function(){var n=$(this),r=n.html(),i=ace.edit(this),s=n.data("type");i.getSession().setUseWorker(!1),i.setTheme("ace/theme/monokai"),i.getSession().setMode("ace/mode/"+t.SYNTAX_TYPES[s]),i.setShowPrintMargin(!1),"markup"===s&&r&&i.getSession().setValue(r),i.on("change",function(){t.timers[s]&&clearTimeout(t.timers[s]),t.timers[s]=setTimeout(function(){var n=i.getValue();s=="script"&&t.checkJS(n),t.script_error?e.find(".upfront_code-jsalert").show().find("i").attr("title","JS error: "+t.script_error):e.find(".upfront_code-jsalert").hide(),t.property(s,n,!1)},1e3)}),i.renderer.scrollBar.width=5,i.renderer.scroller.style.right="5px",t.editors[s]=i}),this.currentEditor=this.editors.markup;var n=e.find(".upfront-css-top"),r=e.find(".upfront-css-body");r.height(this.MIN_HEIGHT-n.outerHeight()),e.find(".upfront_code-editor-complex-wrapper").resizable({handles:{n:".upfront-css-top"},resize:function(e,i){r.height(i.size.height-n.outerHeight()),_.each(t.editors,function(e){e.resize()})},minHeight:t.MIN_HEIGHT,delay:100}),e.find(".upfront_code-switch").on("click",function(n){var r=$(n.target),i=r.data("for");e.find(".active").removeClass("active"),r.addClass("active"),e.find(".upfront_code-"+i).addClass("active"),t.editors[i].resize(),t.currentEditor=t.editors[i],i=="script"?e.find("upfront-css-image").hide():e.find("upfront-css-image").show()}),e.find("button").on("click",function(e){_.each(t.editors,function(e,n){t.property(n,e.getValue())}),t.$("section.upfront_code-element").replaceWith(t.get_content_markup()).end(),t.is_editing=!1,t.destroyEditor()}),e.on("click",".upfront-css-type",function(e){t.hiliteElement(e)}).on("click",".upfront-css-close",function(e){e.preventDefault(),t.destroyEditor()}),this.prepareSpectrum(e),e.on("click",".upfront-css-image",function(){t.openImagePicker()})},prepareSpectrum:function(e){var t=this;e.find(".upfront-css-color").spectrum({showAlpha:!0,showPalette:!0,palette:["fff","000","0f0"],maxSelectionSize:9,localStorageKey:"spectrum.recent_bgs",preferredFormat:"hex",chooseText:"Ok",showInput:!0,allowEmpty:!0,show:function(){spectrum=$(".sp-container:visible")},change:function(e){var n=e.alpha<1?e.toRgbString():e.toHexString();t.currentEditor.insert(n),t.currentEditor.focus()},move:function(e){var t=e.toRgbString();spectrum.find(".sp-dragger").css("border-top-color",t),spectrum.parent().find(".sp-dragger").css("border-right-color",t)}})},openImagePicker:function(){var e=this,t=$("#upfront_code-editor").find(".upfront_code-switch.active").data("for"),n=t=="style";Upfront.Media.Manager.open({themeImages:n,multiple_selection:!1,media_type:["images"]}).done(function(r,i){Upfront.Events.trigger("upfront:element:edit:stop");if(!i)return;var s=i.models[0],o=n?s.get("original_url"):s.get("image").src;o=o.replace(document.location.origin,"");if(t=="style")e.currentEditor.insert('url("'+o+'")');else{var u=o.split("."),a=u[u.length-1],f=s.get("selected_size");f!="full"&&(o=o.replace(new RegExp("."+a+"$"),"-"+f+"."+a)),e.currentEditor.insert('<img src="'+o+'" >')}e.currentEditor.focus()})},destroyEditor:function(){var e=this;this.editors&&this.editors.length&&(_.each(this.editors,function(e){e.destroy()}),e.editors=!1),this.currentEditor=!1,$("#upfront_code-editor").html("").hide(),$(window).off("resize",this.resizeHandler),this.is_editing=!1},hiliteElement:function(e){e.preventDefault();var t=this.$el.find(".upfront-object-content"),n=t.offset().top-50;$(document).scrollTop(n>0?n:0),this.blink(t,4)},blink:function(e,t){var n=this;e.css("outline","3px solid #3ea"),setTimeout(function(){e.css("outline","none"),t--,t>0&&setTimeout(function(){n.blink(e,t-1)},100)},100)},checkJS:function(script){this.script_error=!1;try{eval(script)}catch(e){this.script_error=e.message}},fallback:function(e){return this.model.get_property_value_by_name(e)||Upfront.data.upfront_code.defaults.fallbacks[e]},property:function(e,t,n){return typeof t!="undefined"?(typeof n=="undefined"&&(n=!0),this.model.set_property(e,t,n)):this.model.get_property_value_by_name(e)}}),Embed:Upfront.Views.ObjectView.extend({is_editing:!1,tpl:_.template(tpls.find("#embedTpl").html()),get_content_markup:function(){var e=this.fallback("markup"),t=this.model.get_property_value_by_name("element_id");return'<section class="upfront_code-element clearfix">'+e+"</section>"},update_property:function(e){var t=$(this),n=t.attr("data-type"),r=t.val();e.set_property(n,r,!0)},on_render:function(){this.$el.find(".upfront-entity_meta").append('<a href="#" class="upfront-icon-button re-edit">...</a>');var e=this;this.$el.find(".upfront-entity_meta .re-edit").on("click",function(t){t.preventDefault(),e.on_edit()}),this.model.get_property_value_by_name("markup")||setTimeout(function(){e.on_edit()},10)},on_edit:function(){if(this.is_editing)return!1;this.is_editing=!0;var e=this;this.$el.find("section.upfront_code-element").hide().end().append(this.tpl({markup:this.fallback("markup")})),this.$el.find("textarea").on("keyup change",function(){e.update_property.apply(this,[e.model])}).end().find("button").on("click",function(){e.$el.find("pre code").each(function(){e.update_property.apply(this,[e.model])}),e.$el.find("section.upfront_code-element").replaceWith(e.get_content_markup()).end().find("section.upfront_code-editor-simple").remove(),e.is_editing=!1,e.trigger("code:model:updated")})},fallback:function(e){return this.model.get_property_value_by_name(e)||Upfront.data.upfront_code.defaults.fallbacks[e]}})},CodeView=Upfront.Views.ObjectView.extend({on_render:function(){var e=this.model.get_property_value_by_name("code_selection_type"),t=this;this.$el.empty().append("Loading..."),require(["//cdnjs.cloudflare.com/ajax/libs/ace/1.1.01/ace.js"],function(){e?t.render_code_view():t.render_initial_view()})},render_initial_view:function(){var e=new Views.Start({model:this.model});e.render(),e.on("code:selection:selected",this.render_code_view,this),this.$el.empty().append(e.$el)},render_code_view:function(){var e=this.model.get_property_value_by_name("code_selection_type");if(!e)return Upfront.Util.log("Missing type"),this.render_initial_view();var t=new Views[e]({model:this.model});t.render(),t.on("code:model:updated",this.propagate_model_update,this),this.$el.empty().append(t.$el)},propagate_model_update:function(){Upfront.Events.trigger("upfront:element:edit:stop")}}),CodeElement=Upfront.Views.Editor.Sidebar.Element.extend({priority:130,render:function(){this.$el.addClass("upfront-icon-element upfront-icon-element-code"),this.$el.html("Code")},add_element:function(){var e=new CodeModel,t=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c22 upfront-code_element-module"},{name:"has_settings",value:0},{name:"row",value:14}],objects:[e]});this.add_module(t)}});Upfront.Application.LayoutEditor.add_object("Code",{Model:CodeModel,View:CodeView,Element:CodeElement}),Upfront.Models.CodeModel=CodeModel,Upfront.Views.CodeView=CodeView})}(jQuery),function(e){define("application",["models","views","editor_views","behaviors","upfront-data","scripts/backbone-query-parameters/backbone-query-parameters"],function(t,n,r,i,s){_.extend(Upfront,s),Upfront.Events.trigger("data:ready"),_.extend(Upfront,t),_.extend(Upfront,n),_.extend(Upfront.Views,r),_.extend(Upfront,i);var o=Backbone.Router.extend({start:function(){Upfront.Util.log("Implement runner method")},go:function(e){return Upfront.Events.trigger("subapplication:navigate:"+e),this.navigate(e)}}),u=new(o.extend({Objects:{},boot:function(){},start:function(){this.stop(),this.set_up_event_plumbing_before_render(),this.set_up_editor_interface(),this.set_up_event_plumbing_after_render(),e("html").removeClass("upfront-edit-content").addClass("upfront-edit-layout")},stop:function(){return this.stopListening(Upfront.Events)},save_layout_as:function(){Upfront.Behaviors.LayoutEditor.save_dialog(this._save_layout,this)},save_layout:function(){this._save_layout(this.layout.get("current_layout"))},_save_layout:function(e){var t=Upfront.Util.model_to_json(this.layout);t.layout=_upfront_post_data.layout,t.preferred_layout=e,t=JSON.stringify(t,undefined,2),Upfront.Events.trigger("command:layout:save_start");if(Upfront.Settings.Application.NO_SAVE)return Upfront.Events.trigger("command:layout:save_success"),!1;Upfront.Util.post({action:Upfront.Application.actions.save,data:t}).success(function(){Upfront.Util.log("layout saved"),Upfront.Events.trigger("command:layout:save_success")}).error(function(){Upfront.Util.log("error saving layout"),Upfront.Events.trigger("command:layout:save_error")})},get_layout_data:function(){var e=Upfront.Util.model_to_json(this.layout);return e.layout=_upfront_post_data.layout,e},preview_layout:function(){var e=!1,t=!1;t=Upfront.PreviewUpdate.preview_url();if(!t)return Upfront.Views.Editor.notify("Your preview is not ready yet"),!1;e=window.open(t,"_blank")},list_revisions:function(){var t={action:"upfront_list_revisions",cascade:_upfront_post_data.layout,current_url:window.location.href};Upfront.Util.post(t).done(function(t){Upfront.Popup.open(function(){var n=_.template('<h3>Revisions</h3><ul>{[ _.each(data, function (item) { ]}<li><a target="_blank" href="{{item.preview_url}}">{{item.date_created}}</a><br /><small>created by {{item.created_by.display_name}}</small></li>{[ }); ]}</ul>');e(this).html(n(t))})}).error(function(e){console.log(e)})},destroy_editor:function(){return this.navigate(""),window.location.reload(),!1},set_up_editor_interface:function(){if(!this.layout)return!1;var e=this,t=function(){var t=[];_(e.Objects).each(function(n,r){if(n.Element){var i=new n.Element({model:e.layout});i.element_type=r,t.push(i)}n.Command&&e.sidebar.get_commands("control").commands.push(new n.Command({model:e.layout}))}),Upfront.Application.sidebar.get_panel("elements").elements=_(_.sortBy(t,function(e){return e.priority})),Upfront.Application.sidebar.render()};t(),this.listenTo(Upfront.Events,"elements:requirements:async:added",t)},add_object:function(e,t){this.Objects[e]=_.extend({},Upfront.Mixins.Anchorable,t)},set_up_event_plumbing_before_render:function(){this.listenTo(Upfront.Events,"entity:module:after_render",Upfront.Behaviors.GridEditor.create_resizable),this.listenTo(Upfront.Events,"entity:module:after_render",Upfront.Behaviors.GridEditor.create_draggable),this.listenTo(Upfront.Events,"entity:region:after_render",Upfront.Behaviors.GridEditor.create_region_resizable),this.listenTo(Upfront.Events,"entity:region_container:after_render",Upfront.Behaviors.GridEditor.create_region_container_resizable),this.listenTo(Upfront.Events,"layout:render",Upfront.Behaviors.GridEditor.refresh_draggables),this.listenTo(Upfront.Events,"layout:after_render",Upfront.Behaviors.GridEditor.init)},set_up_event_plumbing_after_render:function(){this.listenTo(Upfront.Events,"entity:activated",this.create_properties),this.listenTo(Upfront.Events,"entity:deactivated",this.destroy_properties),this.listenTo(Upfront.Events,"command:exit",this.destroy_editor),this.listenTo(Upfront.Events,"command:layout:save",this.save_layout),this.listenTo(Upfront.Events,"command:layout:save_as",this.save_layout_as),this.listenTo(Upfront.Events,"command:layout:preview",this.preview_layout),this.listenTo(Upfront.Events,"command:region:edit_toggle",Upfront.Behaviors.GridEditor.toggle_region_resizable),this.listenTo(Upfront.Events,"entity:activated",Upfront.Behaviors.LayoutEditor.create_undo),this.listenTo(Upfront.Events,"entity:resize_start",Upfront.Behaviors.LayoutEditor.create_undo),this.listenTo(Upfront.Events,"entity:drag_start",Upfront.Behaviors.LayoutEditor.create_undo),this.listenTo(Upfront.Events,"entity:removed:before",Upfront.Behaviors.LayoutEditor.create_undo),this.listenTo(Upfront.Events,"entity:region:activated",Upfront.Behaviors.LayoutEditor.create_undo),this.listenTo(Upfront.Events,"command:undo",Upfront.Behaviors.LayoutEditor.apply_history_change),this.listenTo(Upfront.Events,"command:redo",Upfront.Behaviors.LayoutEditor.apply_history_change),this.listenTo(Upfront.Events,"command:select",Upfront.Behaviors.LayoutEditor.create_mergeable),this.listenTo(Upfront.Events,"command:deselect",Upfront.Behaviors.LayoutEditor.destroy_mergeable),this.listenTo(Upfront.Events,"command:merge",Upfront.Behaviors.LayoutEditor.destroy_mergeable),this.listenTo(Upfront.Events,"entity:settings:activate",this.create_settings),this.listenTo(Upfront.Events,"entity:settings:deactivate",this.destroy_settings),this.listenTo(Upfront.Events,"entity:removed:after",this.destroy_settings),this.listenTo(Upfront.Events,"entity:contextmenu:activate",this.create_menu),this.listenTo(Upfront.Events,"entity:contextmenu:deactivate",this.destroy_menu);var t=!1,n=function(){t=new Upfront.Views.Editor.Loading({loading:"Saving...",done:"All done!",fixed:!0}),t.render(),e("body").append(t.$el)},r=function(){t.done()};this.listenTo(Upfront.Events,"command:layout:save_start",n),this.listenTo(Upfront.Events,"command:layout:save_success",r),this.listenTo(Upfront.Events,"command:layout:save_error",r)},create_properties:function(t,n){this.property_view=new Upfront.Views.Editor.Properties({model:n,el:e(Upfront.Settings.LayoutEditor.Selectors.properties)}),this.property_view.render()},destroy_properties:function(){e(Upfront.Settings.LayoutEditor.Selectors.properties).html("")},create_menu:function(t){var n=_(this.Objects).reduce(function(e,n){return t instanceof n.View?n:e},!1),n=n&&n.ContextMenu?n:Upfront.Views.ContextMenu;if(n.ContextMenu===!1)return!1;typeof n.ContextMenu=="undefined"&&(n.ContextMenu=Upfront.Views.ContextMenu),context_menu_view=new n.ContextMenu({model:t.model,for_view:t,el:e(Upfront.Settings.LayoutEditor.Selectors.contextmenu)}),context_menu_view.for_view=t,context_menu_view.render(),this.context_menu_view=context_menu_view},destroy_menu:function(){if(!this.context_menu_view)return!1;e(Upfront.Settings.LayoutEditor.Selectors.contextmenu).html("").hide(),this.context_menu_view=!1,context_menu_view.trigger("closed")},create_settings:function(t){if(this.settings_view)return this.destroy_settings();if(!parseInt(t.model.get_property_value_by_name("has_settings"),10))return!1;var n=_(this.Objects).reduce(function(e,n){return t instanceof n.View?n:e},!1),n=n&&n.Settings?n:Upfront.Views.Editor.Settings;settings_view=new n.Settings({model:t.model,anchor:n.anchor,el:e(Upfront.Settings.LayoutEditor.Selectors.settings)}),settings_view.for_view=t,settings_view.render(),this.settings_view=settings_view,settings_view.trigger("rendered")},destroy_settings:function(){if(!this.settings_view)return!1;this.settings_view.remove(),this.settings_view=!1,e("body").append('<div id="settings"/>'),settings_view.trigger("closed")},create_post:function(e){Upfront.Settings.LayoutEditor.newpostType=e,this.load_layout({item:"single-"+e,type:"single"})}})),a=new(o.extend({boot:function(){Upfront.Util.log("Preparing content mode for execution")},start:function(){Upfront.Util.log("Starting the content edit mode"),e("html").removeClass("upfront-edit-layout").addClass("upfront-edit-content")},stop:function(){Upfront.Util.log("Stopping the content edit mode")}})),f=new(Backbone.Router.extend({LayoutEditor:u,ContentEditor:a,actions:{save:"upfront_save_layout",load:"upfront_load_layout"},routes:{done:"destroy_editor","new-layout":"dispatch_layout_creation","create_new(/:postType)":"create_new_entry","*otherRoutes":"fetchLayout"},MODE:{CONTENT:"content",LAYOUT:"layout"},mode:{last:!1,current:!1},urlCache:{},current_subapplication:!1,sidebar:!1,layout:!1,boot:function(){this.MODE=Upfront.Settings.Application.MODE;var t=this;e("body").on("click",".upfront-edit_layout",function(){return t.start(),!1}),e(document).trigger("upfront-load")},start:function(t){t||(t=this.MODE.DEFAULT);if(this.mode.current==t)return!1;e("#wpadminbar").hide(),e("html").attr("style","margin-top: 0 !important;"),this.set_current(t),(!this.current_subapplication||!this.current_subapplication.start)&&Upfront.Util.log("Can't boot invalid subapplication"),Upfront.Events.trigger("application:mode:before_switch");if(!!this.layout){var n=this.layout.get("regions"),r=n.get_by_name("shadow");return n&&r&&n.remove(r,{silent:!0}),this.create_sidebar(),this.current_subapplication.layout=this.layout,this.current_subapplication&&this.current_subapplication.start?this.current_subapplication.start():Upfront.Util.log("No current subapplication"),Upfront.Events.trigger("application:mode:after_switch"),!1}var i=this;i.loading=new Upfront.Views.Editor.Loading({loading:"Loading...",done:"Thank you for waiting",fixed:!0}),i.loading.on_finish(function(){e(Upfront.Settings.LayoutEditor.Selectors.sidebar).show(),e(".upfront-editable_trigger").hide()}),i.loading.render(),e("body").append(i.loading.$el),i.create_sidebar(),require(["objects","media","content","spectrum","responsive","uaccordion","redactor","ueditor","ucomment","ucontact","ugallery","uimage","upfront-like-box","upfront_login","upfront_maps","upfront-navigation","unewnavigation","uposts","usearch","upfront_slider","upfront-social_media","utabs","this_post","this_page","uwidget","uyoutube","upfront_code"],function(e){_.extend(Upfront.Objects,e),i.currentUrl=window.location.pathname+window.location.search,i.saveCache=!0,i.load_layout(_upfront_post_data.layout),i.start_navigation(),i.create_cssEditor()})},stop:function(){},restart:function(){var e=this.mode.last||this.MODE.DEFAULT;this.start(e)},load_layout:function(t,n){var r=this,i={action:this.actions.load,data:t};return n&&(i.new_post=n),e("body").removeClass(Upfront.Settings.LayoutEditor.Grid.scope),this.loadingLayout&&this.loadingLayout.abort(),this.loadingLayout=Upfront.Util.post(i).success(function(t){r.set_layout_up(t),r.saveCache&&(r.urlCache[r.currentUrl]=e.extend(!0,{},t),r.saveCache=!1)}).error(function(n){if(n.statusText=="abort")return;Upfront.Util.log("Error loading layout "+t),r.loading.cancel(function(){e(Upfront.Settings.LayoutEditor.Selectors.sidebar).hide(),e("#wpadminbar").show(),e("html").removeAttr("style")})}),this.loadingLayout},set_layout_up:function(t){var n=this,r=e.extend(!0,{},t.data.layout)||{};t.data.post&&this.post_set_up(t.data.post),this.layout&&this.unset_layout(),this.layout=new Upfront.Models.Layout(r),this.current_subapplication.layout=this.layout,this.sidebar.model.set(this.layout.toJSON());var i=this.layout.get("regions").get_by_name("shadow");i&&this.layout.get("regions").remove(i),this.layout.get("regions")&&(_upfront_post_data.layout=t.data.cascade),Upfront.Application.loading.done(function(){Upfront.Events.trigger("upfront:layout:loaded"),n.current_subapplication&&n.current_subapplication.start?n.current_subapplication.start():Upfront.Util.log("No current subapplication"),n.layout_view=new Upfront.Views.Layout({model:n.layout,el:e(Upfront.Settings.LayoutEditor.Selectors.main)}),Upfront.Events.trigger("layout:render",n.current_subapplication),Upfront.PreviewUpdate.run(n.layout),Upfront.Events.trigger("application:mode:after_switch")})},unset_layout:function(){var t,n,r;Upfront.data.currentEntity=!1,this.current_subapplication&&this.current_subapplication.stop(),Upfront.data.Ueditor&&_.each(Upfront.data.Ueditor.instances,function(e){e.stop()}),this.layout&&(this.layout.trigger("destroy"),this.layout=!1),this.current_subapplication.layout&&(this.current_subapplication.layout=!1),this.layout_view&&(n=this.layout_view.el,t={name:n.tagName,id:n.id,className:n.className},r=e("<"+t.name+">"),this.layout_view.$el.after(r),this.layout_view.remove(),this.layout_view=!1,r.attr({"class":t.className,id:t.id}),Upfront.Events.off("upfront:editor:init"),Upfront.Events.off("upfront:post:taxonomy_changed")),e(Upfront.Settings.LayoutEditor.Selectors.main).length||e("body").prepend('<div id="page" />')},create_new_entry:function(t){var n=this,r={item:"single-"+t,type:"single",specificity:"single-"+t+"-1000000"},i=new e.Deferred,s={},o=this.set_loading("Preparing new "+t+"...","Here we are!");return this.current_subapplication&&this.current_subapplication.stop&&this.current_subapplication.stop(),this.load_layout(r,t).done(function(e){Upfront.Settings.LayoutEditor.newpostType=t,s=e.data.post,i.resolve(Upfront.data.posts[s.ID]),o.done()}),i.promise()},post_set_up:function(t){t.meta=[];var n=new Upfront.Models.Post(t);n.is_new=t.post_status=="auto-draft"&&t.post_content==="",Upfront.data.posts[n.id]=n,_upfront_post_data.post_id=n.id;var r="logged-in admin-bar upfront customize-support flex-support";t.post_type=="page"?r+=" page page-id-"+n.id+" page-template-default":r+=" single single-"+t.post_type+" postid-"+n.id,e("body").removeClass().addClass(r)},set_gridstate:function(e){this.gridstate=e},get_gridstate:function(){return this.gridstate},get_current:function(){return this.mode.current||this.MODE.DEFAULT},set_current:function(e){this.current_subapplication&&this.current_subapplication.stop&&this.current_subapplication.stop(),e||(e=this.MODE.DEFAULT);if(this.mode.current==e)return!1;this.mode.last=this.mode.current,e&&this.MODE.CONTENT==e?(this.mode.current=this.MODE.CONTENT,this.current_subapplication=this.ContentEditor):(this.mode.current=this.MODE.LAYOUT,this.current_subapplication=this.LayoutEditor),this.current_subapplication.boot()},create_sidebar:function(){this.sidebar||(this.sidebar=new Upfront.Views.Editor.Sidebar.Sidebar({model:new Upfront.Models.Layout({}),el:e(Upfront.Settings.LayoutEditor.Selectors.sidebar)})),this.layout_sizes||(this.layout_sizes=new Upfront.Views.Editor.Layouts({model:this.layout,el:e(Upfront.Settings.LayoutEditor.Selectors.layouts)})),this.layout_sizes.render()},create_cssEditor:function(){var t=new Upfront.Views.Editor.CSSEditor;t.fetchThemeStyles(!0).done(function(n){e("#upfront-theme-styles").remove(),_.each(n,function(n,r){_.each(n,function(n,r){var i=e("#upfront-style-"+r);i.length||(i=e('<style id="upfront-style-'+r+'"></style>'),e("body").append(i)),i.append(t.stylesAddSelector(n,".upfront-object."+r))})})}),t.createSelectors(Upfront.Application.LayoutEditor.Objects),this.cssEditor=t},fetchLayout:function(e,t){var n=this,r=t?[]:!1,i=e?"/"+e:"/",s;r&&(_.each(t,function(e,t){r.push(t+"="+e)}),i+="?"+r.join("&")),s=this.set_loading("Loading "+i,"Here we are!"),this.urlCache[i]?setTimeout(function(){n.set_layout_up(n.urlCache[i]),n.currentUrl=i,s.done()},150):(this.load_layout(i).done(function(e){s.done(),Upfront.Settings.LayoutEditor.newpostType=!1,n.urlCache[i]=e,this.currentUrl=i}),setTimeout(function(){n.unset_layout()},150))},start_navigation:function(){var t=this,n=document.createElement("a");console.log("Starting router history"),n.href=Upfront.Settings.site_url,Backbone.history.start({pushState:!0,root:n.pathname,silent:!0}),e(document).on("click","a",function(n){var r=n.target.getAttribute("href"),i=n.target,s=window.location;if(r=="#"||i.origin!=s.origin||i.pathname==s.pathname&&i.search==s.search)return;if(e(n.target).closest(".redactor_box").length)return;n.preventDefault(),(!Upfront.PreviewUpdate._is_dirty||confirm("You have unsaved changes you're about to lose by navigating off this page. Do you really want to leave this page?"))&&t.navigate(i.pathname+i.search,{trigger:!0})})},set_loading:function(t,n){var r=this,i=this.loadingLayer;return i?(document.querySelector(".upfront-loading-text").innerText=t,i.options.done=n):(i=new Upfront.Views.Editor.Loading({loading:t,done:n,fixed:!0}),i.render(),e("body").append(i.$el),i.on_finish(function(){r.loadingLayer=!1})),this.loadingLayer=i,i}}));return{Application:f}})}(jQuery),function(e){define("util",[],function(){var t={model_to_json:function(e){var t=e.toJSON?e.toJSON():e,n=JSON.stringify(t),r=JSON.parse(n);return r},get_unique_id:function(e){return _.template("{{prefix}}-{{stamp}}-{{numeric}}",{prefix:e||"entity",stamp:(new Date).getTime(),numeric:Math.floor(Math.random()*999+1e3)})},log:function(){var e="UPFRONT: ",t="",n=typeof console!="undefined"&&console&&console.log?console.log:alert;if(arguments.length>1)for(var r in arguments)e+="["+r+"]: "+arguments[r]+"\n";else e+=arguments[0];console.log(e)},dbg:function(){Upfront.Util.log(JSON.stringify(arguments[0]))},post:function(t){var n=_.isObject(t)&&t.action?t:{action:"upfront_request",data:t};return Upfront.Application.LayoutEditor.layout&&(n.layout=Upfront.Application.LayoutEditor.layout.get("layout")),e.post(Upfront.Settings.ajax_url,n,function(){},"json")},format_date:function(e,t,n){var r=e.getFullYear()+"/",i=e.getDate(),s=e.getMonth()+1;i<10&&(i="0"+i),s<10&&(s="0"+s),r+=s+"/"+i;if(t){var o=e.getHours(),u=e.getMinutes();r+=" "+(o<10?"0":"")+o+":"+(u<10?"0":"")+u;if(n){var a=e.getSeconds();r+=":"+(a<10?"0":"")+a}}return r},get_avatar:function(e,t){var n=window.location.href.split("//"),r=n[0]+"//www.gravatar.com/avatar/",i="";t=t&&parseInt(t,10)==t?t:32;if(_.isString(e))i=e;else{if(!(e instanceof Upfront.Models.User||e instanceof Upfront.Models.Comment))return!1;i=e.get("gravatar")}return r+i+"?d=mm&s="+t},template:function(e){var t=_.templateSettings,n=!1;return _.templateSettings={interpolate:/<\?php echo (.+?) \?>/g,evaluate:/<\?php (.+?) \?>/g},n=_.template(e),_.templateSettings=t,function(e){return _.each(e,function(t,n){e["$"+n]=t}),n(e)}},Transient:{_memory_queue:{},_key:window.location.path+window.location.search,initialize:function(){Upfront.Settings.Debug.transients||(this._memory_queue[this._key]=JSON.stringify({}))},get_current:function(){return this._memory_queue[this._key]?JSON.parse(this._memory_queue[this._key]):{}},length:function(e){var t=this.get(e);return t.length},set:function(e,n){var r=this.get_current();r[e]=t.model_to_json(n),this._memory_queue[this._key]=JSON.stringify(r)},get:function(e){var t=this.get_current(),n=t[e]||!1;return n},get_all:function(e){var t=e?new RegExp(e):!1,n=[],r=this._memory_queue[this._key]?JSON.parse(this._memory_queue[this._key]):!1;return r&&_(r).each(function(e,r){if(t&&!r.match(t))return!0;n=e}),n},push:function(e,t){var n=this.get(e)||[];return n.push(t),this.set(e,n)},pop:function(e){var t=this.get(e)||[],n=t&&t.pop?t.pop():!1;return this.set(e,t),n}}},n={$popup:{},$background:{},_deferred:{},init:function(){e("#upfront-popup").length?this.close():e("#page").append('<div id="upfront-popup" class="upfront-ui" style="display:none"><div id="upfront-popup-close" class="upfront-icon upfront-icon-popup-close"></div><div class="upfront-popup-meta" id="upfront-popup-top"></div><div id="upfront-popup-content"></div><div class="upfront-popup-meta" id="upfront-popup-bottom"></div></div>').append("<div id='upfront-popup-background' style='display:none' />"),this.$popup=e("#upfront-popup"),this.$background=e("#upfront-popup-background"),this.$popup.find("#upfront-popup-content").empty()},open:function(t,n){n=n||{},this.init();var r=this,i=e("#sidebar-ui").width(),s=e(window),o=n.width||630,u=(s.width()-o)/2+i/2,a=s.height()/3*2,f=function(){return r.close(),!1};return n.width=o,n.height=a,this.$background.css({height:s.height(),width:s.width()-i,left:i}).on("click",f).show(),this.$popup.css({width:o,height:a,left:i}).show().find("#upfront-popup-close").on("click",f).end(),e("body").addClass("upfront-popup-open"),s.off("resize.upfront-popup").on("resize.upfront-popup",function(){var t=e("#sidebar-ui").width();r.$background.is(":visible")&&r.$background.css({height:s.height(),width:s.width()-t,left:t});if(r.$popup.is(":visible")){var n=(s.width()-o)/2+t/2,i=s.height()/3*2;r.$popup.css({width:o,height:i,left:n})}}),t.apply(this.$popup.find("#upfront-popup-content").get(),[n,this.$popup.find("#upfront-popup-top"),this.$popup.find("#upfront-popup-bottom")]),this._deferred=new e.Deferred,this._deferred.promise()},close:function(t){this._deferred.notify("before_close"),this.$background.hide(),this.$popup.hide().css("height","auto").find("#upfront-popup-content").empty(),this.$popup.find("#upfront-popup-top").empty(),this.$popup.find("#upfront-popup-bottom").empty(),e("body").removeClass("upfront-popup-open"),this._deferred.resolve(this.$popup,t)}},r=function(){var e=!1,t=!1,n=!1,r=!1,i=!1,s=function(e){t=e,r=!1,o(),window.onbeforeunload=l},o=function(){Upfront.Events.off("entity:region:deactivated",a),Upfront.Events.off("entity:settings:deactivate",a),Upfront.Events.off("entity:removed:after",a),Upfront.Events.off("entity:resize_start",a),Upfront.Events.off("entity:drag_stop",a),Upfront.Events.off("entity:module:after_render",a),Upfront.Events.off("upfront:element:edit:stop",a),Upfront.Events.on("entity:region:deactivated",a,this),Upfront.Events.on("entity:settings:deactivate",a,this),Upfront.Events.on("entity:removed:after",a,this),Upfront.Events.on("entity:resize_start",a,this),Upfront.Events.on("entity:drag_stop",a,this),Upfront.Events.on("entity:module:after_render",a,this),Upfront.Events.on("upfront:element:edit:stop",a,this),Upfront.Events.off("command:layout:save_success",f),Upfront.Events.on("command:layout:save_success",f)},u=function(){e=Upfront.Util.model_to_json(t),e&&e.regions&&(e.regions=_(e.regions).reject(function(e){return e.name==="shadow"})),e.layout=_upfront_post_data.layout,e.preferred_layout=t.get("current_layout"),e=JSON.stringify(e,undefined,2)},a=function(){if(n)return!1;n=!0,r=!0,u(),Upfront.Events.trigger("preview:build:start"),Upfront.Util.post({action:"upfront_build_preview",data:e,current_url:window.location.href}).success(function(e){var t=e.data||{};"html"in t&&t.html?i=t.html:Upfront.Util.log("Invalid response"),n=!1,Upfront.Events.trigger("preview:build:stop"),Upfront.Util.log("we're good here")}).error(function(){Upfront.Util.log("error building layout preview")}),s(t)},f=function(){r=!1},l=function(e){var e=e||window.event,t="You have unsaved changes you're about to lose by navigating off this page.";if(!n&&!r)return;return e&&(e.returnValue=t),t},c=function(){return i};return{run:s,preview_url:c,rebind_events:o}};return{Util:t,Popup:n,PreviewUpdate:new r}})}(jQuery);var Upfront=window.Upfront||{};Upfront.mainData=Upfront.mainData||{},Upfront.Events={},require.config(Upfront.mainData.requireConfig),require(["backbone"],function(e){_.templateSettings={evaluate:/\{\[([\s\S]+?)\]\}/g,interpolate:/\{\{([\s\S]+?)\}\}/g},require(["application","util"],function(t,n){_.extend(Upfront.Events,e.Events),Upfront.Settings={root_url:Upfront.mainData.root,ajax_url:Upfront.mainData.ajax,admin_url:Upfront.mainData.admin,site_url:Upfront.mainData.site,Debug:Upfront.mainData.debug,ContentEditor:{Requirements:Upfront.mainData.layoutEditorRequirements,Selectors:{sidebar:"#sidebar-ui"}},Application:{MODE:Upfront.mainData.applicationModes,NO_SAVE:Upfront.mainData.readOnly},LayoutEditor:{Requirements:Upfront.mainData.layoutEditorRequirements,Selectors:{sidebar:"#sidebar-ui",commands:"#commands",properties:"#properties",layouts:"#layouts",settings:"#settings",contextmenu:"#contextmenu",main:"#page"},Specificity:Upfront.mainData.specificity,Grid:Upfront.mainData.gridInfo},Content:Upfront.mainData.content},_.extend(Upfront,t),_.extend(Upfront,n),Upfront.Util.Transient.initialize(),Upfront.LoadedObjectsDeferreds={},Upfront.Events.trigger("application:loaded:layout_editor"),Upfront.Application&&Upfront.Application.boot?Upfront.Application.boot():Upfront.Util.log("something went wrong")})}),define("main",function(){});