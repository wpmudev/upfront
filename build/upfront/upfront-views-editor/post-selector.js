!function(t){var e=Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.views:Upfront.mainData.l10n.global.views;define(["scripts/upfront/upfront-views-editor/post-selector/post-selector-navigation","scripts/upfront/upfront-views-editor/loading","text!upfront/templates/popup.html"],function(s,o,p){return Backbone.View.extend({postTypeTpl:_.template(t(p).find("#selector-post_type-tpl").html()),postListTpl:_.template(t(p).find("#selector-post-tpl").html()),postType:"post",posts:[],pagination:!1,selected:!1,deferred:!1,popup:!1,defaultOptions:{title:e.select_content_to_link,postTypes:[{name:"post",label:e.posts},{name:"page",label:e.pages}]},events:{"click .upfront-field-select-value":"openTypesSelector","click .upfront-field-select-option":"selectType","click .upfront-selector-post":"selectPost","click .use":"postOk","click #upfront-search_action":"search","keyup .search_container>input":"inputSearch"},initialize:function(){("post_types"in Upfront.mainData.content_settings?Upfront.mainData.content_settings:{post_types:[]}).post_types.length&&(this.defaultOptions.postTypes=Upfront.mainData.content_settings.post_types)},open:function(o){var p=this,n=!1;return o=_.extend({},this.defaultOptions,o),t("#upfront-popup").length||"upfront-popup"==this.$el.attr("id")||(n=!0),this.popup=Upfront.Popup.open(function(){}),this.deferred=t.Deferred(),this.posts=new Upfront.Collections.PostList([],{postType:"page"}),this.posts.pagination.pageSize=20,this.pagination=new s({collection:this.posts,pageSelection:function(t){p.fetch({page:t})}}),this.setElement(t("#upfront-popup")),this.$("#upfront-popup-top").html('<h3 class="upfront-selector-title">'+o.title+"</h3>"),this.$("#upfront-popup-content").html(this.postTypeTpl(o)),this.fetch({}),this.$("#upfront-popup-bottom").html('<div class="use_selection_container inactive"><a href="#use" class="use">'+Upfront.Settings.l10n.global.content.ok+'</a></div><div class="search_container clearfix"><input type="text" placeholder="'+e.search+'" value=""><div class="search upfront-icon upfront-icon-popup-search" id="upfront-search_action"></div></div>').append(this.pagination.$el),t("#upfront-popup").addClass("upfront-postselector-popup"),this.$(".upfront-field-select-value").text(e.pages),this.deferred.promise()},openTypesSelector:function(){var t=this.$(".upfront-field-select");t.hasClass("open")?t.removeClass("open"):t.addClass("open")},selectType:function(e){var s=t(e.target).attr("rel");s!=this.posts.postType&&(this.$(".upfront-field-select-value").text(t(e.target).text()),this.$(".upfront-field-select").removeClass("open"),this.fetch({postType:s}))},selectPost:function(e){t(e.currentTarget);this.$(".upfront-selector-post.selected").removeClass("selected"),this.selected=t(e.currentTarget).addClass("selected").attr("rel"),this.$(".use_selection_container").removeClass("inactive")},postOk:function(t){return t.preventDefault(),this.selected?(Upfront.Popup.close(),this.deferred.resolve(this.posts.get(this.selected))):void 0},fetch:function(t){var s=this,p=new o({loading:e.loading,done:e.thank_you_for_waiting,fixed:!1});this.$(".use_selection_container").addClass("inactive"),this.selected=!1,p.render(),this.$("#upfront-selector-posts").append(p.$el),t.postType&&t.postType!=this.posts.postType&&(t.flush=!0,this.posts.postType=t.postType);var n=t.page;n||(n=0),this.posts.fetchPage(n,t).done(function(t){p.done(),s.$("#upfront-selector-posts").find("table").remove(),s.$("#upfront-selector-posts").append(s.postListTpl({posts:s.posts.getPage(n)})),s.pagination.render()})},search:function(t){t.preventDefault();var e=this.$(".search_container input").val();e?this.fetch({search:e,flush:!0}):this.$(".search_container input").focus()},inputSearch:function(t){13==t.which&&this.search(t)}})})}(jQuery);