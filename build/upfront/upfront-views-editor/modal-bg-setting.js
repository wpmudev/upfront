!function(e){var t=Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.views:Upfront.mainData.l10n.global.views;define(["scripts/upfront/upfront-views-editor/modal","scripts/upfront/upfront-views-editor/fields","text!upfront/templates/bg_setting.html"],function(i,n,o){return i.extend({open:function(){return this._backup={},this._prompt=!1,i.prototype.open.call(this,this.render_modal,this,!0)},close:function(e){return this._prompt&&this.prompt_responsive_change("background_type"),i.prototype.close.call(this,e)},render_modal:function(i,r){var a=Upfront.Settings.LayoutEditor.Grid,s=e(o),d=_.template(s.find("#upfront-bg-setting").html()),l=d(),p=new n.Number({model:this.model,property:"contained_region_width",label:t.contained_region_width,label_style:"inline",default_value:a.size*a.column_width,min:a.size*a.column_width,max:5120,step:1,suffix:t.px,change:function(){var e=this.get_value();e=e<this.options.min?this.options.min:e,this.property.set({value:e}),Upfront.Events.trigger("upfront:layout:contained_region_width",e)}});i.find(".upfront-bg-setting-tab-primary, .upfront-bg-setting-tab-secondary").children().detach(),i.html(l),r.addClass("upfront-modal-bg"),p.render(),i.find(".upfront-bg-setting-theme-body").append(p.$el),this.render_bg_type_settings(i)},render_bg_type_settings:function(e){var t=this,i=Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),o=i&&!i["default"],r=this.model.get_breakpoint_property_value("background_image",!0),a=i&&!i["default"]?"":r?"image":"color",_=this.model.get_breakpoint_property_value("background_type"),s=new n.Select({model:this.model,name:"background_type",default_value:_?_:a,icon_class:"upfront-region-field-icon",values:this.get_bg_types(),change:function(){var n=this.get_value();""===n&&o?(t.reset_breakpoint_background(i,!1),e.find(".upfront-bg-setting-tab").hide()):(o&&t.revert_breakpoint_background(i,["background_type"],!0),t.model.set_breakpoint_property("background_type",n),e.find(".upfront-bg-setting-tab").not(".upfront-bg-setting-tab-"+n).hide(),e.find(".upfront-bg-setting-tab-"+n).show(),t.render_modal_tab(n,e.find(".upfront-bg-setting-tab-"+n),e)),o||(t._prompt=_!==n)}});s.render(),e.find(".upfront-bg-setting-type").append(s.$el),s.trigger("changed")},get_bg_types:function(){return[{label:t.solid_color,value:"color",icon:"color"},{label:t.image,value:"image",icon:"image"},{label:t.video,value:"video",icon:"video"}]},is_responsive_changed:function(e){var t=this,i=Upfront.Views.breakpoints_storage.get_breakpoints().get_enabled(),n=Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),o=!1;return n["default"]?(_.each(i,function(i){if(!o){var i=i.toJSON(),n=t.model.get_breakpoint_property_value(e,!1,!1,i);i["default"]||!1!==n&&(o=!0)}}),o):!1},prompt_responsive_change:function(i){if(this.is_responsive_changed(i)){var n=this,o=this.model instanceof Upfront.Models.Region,r=o?this.model.get("title"):t.global_bg,a=new Upfront.Views.Editor.Modal({to:e("body"),button:!1,top:120,width:450});a.render(),e("body").append(a.el),a.open(function(e,i){var o=new Upfront.Views.Editor.Field.Button({name:"confirm",label:t.bg_changed_confirm,compact:!0,classname:"upfront-bg-setting-prompt-button",on_click:function(){n.reset_responsive_background(),a.close()}}),s=new Upfront.Views.Editor.Field.Button({name:"cancel",label:t.bg_changed_cancel,compact:!0,classname:"upfront-bg-setting-prompt-button",on_click:function(){a.close()}});i.addClass("upfront-bg-setting-prompt-modal"),e.html("<p>"+t.bg_changed_prompt.replace("%s",r)+"</p>"),_.each([o,s],function(t){t.render(),t.delegateEvents(),e.append(t.$el)})},this).always(function(){a.remove()})}},reset_responsive_background:function(){var e=this,t=Upfront.Views.breakpoints_storage.get_breakpoints().get_enabled();_.each(t,function(t){var i=t.toJSON();e.reset_breakpoint_background(i,!0)})},reset_breakpoint_background:function(e,t){if(!e["default"]){var i=this,n=["background_type","background_color","background_image","background_image_ratio","background_style","background_default","background_repeat","background_position","background_slider_transition","background_slider_rotate","background_slider_rotate_time","background_slider_control","background_slider_images","background_video_mute","background_video_autoplay","background_video_style","background_video","background_video_embed","background_video_width","background_video_height","background_map_center","background_map_zoom","background_map_style","background_map_controls","background_show_markers","background_use_custom_map_code","background_map_location"],o=Upfront.Util.clone(this.model.get_property_value_by_name("breakpoint")||{});_.isObject(o[e.id])||(o[e.id]={}),_.each(n,function(t){_.isUndefined(o[e.id][t])||(_.isObject(i._backup[e.id])||(i._backup[e.id]={}),i._backup[e.id][t]=o[e.id][t],delete o[e.id][t])}),this.model.set_property("breakpoint",o,!0===t)}},revert_breakpoint_background:function(e,t,i){var n=Upfront.Util.clone(this.model.get_property_value_by_name("breakpoint")||{});_.isObject(this._backup)&&_.isObject(this._backup[e.id])&&(t=_.isArray(t)?t:[],_.isObject(n[e.id])||(n[e.id]={}),_.each(this._backup[e.id],function(i,o){_.contains(t,o)||(n[e.id][o]=i)}),delete this._backup[e.id],this.model.set_property("breakpoint",n,!0===i))},render_modal_tab:function(e,t,i){switch(e){case"color":this.render_modal_tab_color(t);break;case"image":this.render_modal_tab_image(t,e);break;case"featured":this.render_modal_tab_image(t,e);break;case"slider":this.render_modal_tab_slider(t);break;case"map":this.render_modal_tab_map(t);break;case"video":this.render_modal_tab_video(t)}},_render_tab_template:function(t,i,n,r){var a=e(o),s=!1,d=!1;d=r?_.template(a.find("#upfront-bg-setting-tab-"+r).html()):_.template(a.find("#upfront-bg-setting-tab").html()),d&&(s=e("<div>"+d()+"</div>")),s.find(".upfront-bg-setting-tab-primary").append(i),n&&s.find(".upfront-bg-setting-tab-secondary").append(n),t.html(""),t.append(s)},render_modal_tab_color:function(e){this._color_item||(this._color_item=new Upfront.Views.Editor.BgSettings.ColorItem({model:this.model}),this._color_item.render()),this._color_item.trigger("show"),this._render_tab_template(e,this._color_item.$el,"")},render_modal_tab_image:function(e,t){this._image_item||(this._image_item=new Upfront.Views.Editor.BgSettings.ImageItem({model:this.model}),this._image_item.render(),this.$_image_primary=this._image_item.$el.find(".uf-bgsettings-image-style, .uf-bgsettings-image-pick")),this._image_item.trigger("show"),this._render_tab_template(e,this.$_image_primary,this._image_item.$el)},render_modal_tab_slider:function(t){this._slider_item||(this.$_slides=e('<div class="upfront-bg-slider-slides"></div>'),this._slider_item=new Upfront.Views.Editor.BgSettings.SliderItem({model:this.model,slides_item_el:this.$_slides}),this._slider_item.render(),this.$_slider_primary=this._slider_item.$el.find(".uf-bgsettings-slider-transition")),this._slider_item.trigger("show"),this._render_tab_template(t,this.$_slider_primary,[this._slider_item.$el,this.$_slides])},render_modal_tab_map:function(e){this._map_item||(this._map_item=new Upfront.Views.Editor.BgSettings.MapItem({model:this.model}),this._map_item.render()),this._map_item.trigger("show"),this._render_tab_template(e,"",this._map_item.$el)},render_modal_tab_video:function(e){this._video_item||(this._video_item=new Upfront.Views.Editor.BgSettings.VideoItem({model:this.model}),this._video_item.render()),this._video_item.trigger("show"),this._render_tab_template(e,"",this._video_item.$el)}})})}(jQuery);