!function(e){Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.views:Upfront.mainData.l10n.global.views;define(["scripts/upfront/upfront-views-editor/sidebar/sidebar-panel-settings-item","scripts/upfront/upfront-views-editor/theme-colors","scripts/upfront/upfront-views-editor/fields","text!upfront/templates/sidebar_settings_theme_colors.html"],function(o,t,r,n){return o.extend({color_styles:[],initialize:function(){this.template=_.template(n),0!==this.model.get("properties").length&&(Upfront.Events.off("command:layout:save",this.on_save),Upfront.Events.off("command:layout:save_as",this.on_save),Upfront.Events.on("command:layout:save",this.on_save,this),Upfront.Events.on("command:layout:save_as",this.on_save,this),Upfront.Settings.Application.NO_SAVE&&Upfront.Events.on("preview:build:start",this.on_save,this),this.update_styles_debounced=_.debounce(this.update_styles,500),this.update_styles_debounced(),t.colors.bind("change reset add",this.update_styles_debounced,this))},events:{"change .panel-setting-theme-colors-shades-range":"change_range","click .theme-colors-color-box":"select_variation"},on_save:function(){Upfront.Application.colorSaver.queue([t.colors.toJSON(),t.range,this.styles])},color_style_is_initialized:function(e){return this.color_styles[e]},color_is_original:function(e){return"undefined"==typeof e.previous("prev")},color_is_updated:function(e,o){return this.color_is_original(e)===!1&&e.previous("prev")!==o},theme_color_to_string:function(e){return"#000000"===e.get("color")&&0===e.get("alpha")?"inherit":e.get("color")},generate_theme_color_style:function(e,o,t){var r="";return r+=" .upfront_theme_color_"+o+"{ color: "+t+";}",r+=" a .upfront_theme_color_"+o+":hover{ color: "+e.get_hover_color()+";}",r+=" button .upfront_theme_color_"+o+":hover{ color: "+e.get_hover_color()+";}",r+=" .upfront_theme_bg_color_"+o+"{ background-color: "+t+";}",r+=" a .upfront_theme_bg_color_"+o+":hover{ background-color: "+e.get_hover_color()+";}",r+=" button .upfront_theme_bg_color_"+o+":hover{ background-color: "+e.get_hover_color()+";}"},update_styles:function(){var o=this;t.colors.each(function(e,t){var r=o.theme_color_to_string(e);!1===o.color_is_updated(e,r)&&o.color_style_is_initialized(t)||(o.color_styles[t]=o.generate_theme_color_style(e,t,r),Upfront.Util.colors.update_colors_in_dom(e.get("prev"),r,t),e._previousAttributes.prev=r)}),this.styles=this.color_styles.join(" "),e("#upfront_theme_colors_dom_styles").remove(),e("<style id='upfront_theme_colors_dom_styles' type='text/css'>"+this.styles+"</style>").appendTo("body"),Upfront.Events.trigger("theme_colors:update")},on_render:function(){var e;for(this.theme_colors=t,this.theme_color_range=t.range,this.$el.html(this.template({colors:this.theme_colors.colors.toJSON(),range:t.range})),this.add_previous_pickers(),e=this.theme_colors.colors.length;e<10;)this.add_unset_color(e),e++;this.add_slider()},add_empty_picker:function(e){var o=this,t=new r.Color({className:"upfront-field-wrap upfront-field-wrap-color sp-cf theme_color_swatch theme_color_swatch_empty",hide_label:!0,default_value:"#ffffff",blank_alpha:0,spectrum:{choose:function(r){if(!_.isObject(r))return!1;var n=t.get_value();n&&"undefined"!=typeof tinycolor&&(r=tinycolor(n)),o.add_new_color(r,e)},change:function(e){return!!_.isObject(e)&&void t.update_input_val(e.toHexString())}}});t.render(),this.$(".theme_colors_empty_picker").html(t.$el).prepend('<span class="theme-colors-color-name">ufc'+e+"</span>")},add_unset_color:function(e){var o=this,t=new r.Color({className:"upfront-field-wrap upfront-field-wrap-color sp-cf theme_color_swatch",hide_label:!0,default_value:"#ffffff",blank_alpha:0,spectrum:{choose:function(r){if(!_.isObject(r))return!1;var n=t.get_value();n&&"undefined"!=typeof tinycolor&&(r=tinycolor(n)),o.add_new_color(r,e)},change:function(r){return!!_.isObject(r)&&(t.update_input_val(r.toHexString()),void(o.theme_colors.colors.at(e)?o.update_colors(this,r,e):(o.add_new_color(r,e),o.update_colors(this,r,e))))}}});t.render(),t.$(".sp-preview").addClass("uf-unset-color"),this.$("#theme-colors-swatches").append(t.$el),t.$el.wrap('<span class="theme-colors-color-picker color-index">'.replace("index",e)),t.$el.closest(".theme-colors-color-picker").prepend('<span class="theme-colors-color-name">ufcindex</span>'.replace("index",e))},add_previous_pickers:function(){var o=this;this.$(".theme-colors-color-picker").each(function(t){var n=e(this),s=n.data("color"),a=o.theme_colors.colors.at(t),l=new r.Color({className:"upfront-field-wrap upfront-field-wrap-color sp-cf theme_color_swatch",hide_label:!0,default_value:s,blank_alpha:0,spectrum:{change:function(e){o.update_colors(this,e,t)},move:function(e){l.$(".sp-preview").css({backgroundColor:e.toRgbString(),backgroundImage:"none"})},hide:function(e){l.$(".sp-preview").css({backgroundColor:e.toRgbString(),backgroundImage:"none"})}}});l.render(),l.$(".sp-preview").css({backgroundColor:s,backgroundImage:"none"}),"#000000"===a.get("color")&&0==a.get("alpha")?l.$(".sp-preview").addClass("uf-unset-color"):l.$(".sp-preview").removeClass("uf-unset-color"),n.html(l.$el),n.prepend('<span class="theme-colors-color-name">ufc'+t+"</span>")})},add_new_color:function(o,n){for(var s=parseInt(t.range,10)/100||0,a=this.theme_colors.colors.length;a<n;a++)this.theme_colors.colors.push({color:"#000000",prev:"#000000",highlight:"#000000",shade:"#000000",alpha:0});var l=this,c=this.theme_colors.colors.add({color:o.toHexString(),prev:o.toHexString(),highlight:l.color_luminance(o.toHex(),s),shade:l.color_luminance(o.toHex(),s*-1),alpha:o.alpha}),i=new r.Color({className:"upfront-field-wrap upfront-field-wrap-color sp-cf theme_color_swatch theme-colors-color-picker",hide_label:!0,default_value:o.toRgbString(),blank_alpha:0,change:function(o){var r=parseInt(t.range,10)/100||0;o=tinycolor(o),c.set({color:o.toHexString(),highlight:l.color_luminance(o.toHex(),r),shade:l.color_luminance(o.toHex(),r*-1),alpha:o.alpha}),e(this).parent().find(".sp-preview").css({backgroundColor:o.toRgbString(),backgroundImage:"none"}),this.default_value=o.toRgbString(),l.render_bottom()}}),p=t.colors.length-1,h=e('<span class="theme-colors-color-picker color-'+p+'" data-index="'+p+'" data-color="'+o.toHexString()+'"><span class="theme-colors-color-name">ufc'+p+"</span></span>");i.render(),i.$(".sp-preview").css({backgroundColor:o.toRgbString(),backgroundImage:"none"}),"#000000"===o.toHexString()&&0==o.alpha?i.$(".sp-preview").addClass("uf-unset-color"):i.$(".sp-preview").removeClass("uf-unset-color"),h.append(i.$el),this.$("#theme-colors-no-color-notice").hide(),this.render_bottom(),this.on_save()},render_bottom:function(){},color_luminance:function(e,o){e=String(e).replace(/[^0-9a-f]/gi,""),e.length<6&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),o=o||0;var t,r,n="#";for(r=0;r<3;r++)t=parseInt(e.substr(2*r,2),16),t=Math.round(Math.min(Math.max(0,t+t*o),255)).toString(16),n+=("00"+t).substr(t.length);return n},change_range:function(e){var o=this;t.range=e,percentage=parseInt(e,10)/100||0,t.colors.each(function(e){var t=e.get("color");e.set("highlight",o.color_luminance(t,percentage)),e.set("shade",o.color_luminance(t,percentage*-1))}),this.render_bottom()},select_variation:function(o){var r=this,n=e(o.target),s=n.data("type"),a=n.data("index"),l=n.data("color"),c=t.colors.at(a);c.get("selected")?(c.set("selected",""),c.set("luminance",r.luminance(l))):(c.set("selected",s),c.set("luminance",r.luminance(l))),this.render_bottom()},luminance:function(e){e=e.substring(1);var o=parseInt(e,16),t=o>>16&255,r=o>>8&255,n=o>>0&255,s=.2126*t+.7152*r+.0722*n;return s<80?"dark":"light"},add_slider:function(){var e=this;this.$(".panel-setting-theme-colors-shades-range").slider({value:t.range,min:0,max:50,change:function(o,t){e.change_range(t.value)}})},update_colors:function(o,r,n){var s=t.colors.at(n),a=parseInt(t.range,10)/100||0;s&&(s.set({color:r.toHexString(),prev:s.get("color"),highlight:this.color_luminance(r.toHex(),a),shade:this.color_luminance(r.toHex(),a*-1),alpha:r.alpha}),e(o).parent().find(".sp-preview").css({backgroundColor:r.toRgbString(),backgroundImage:"none"}),"#000000"===r.toHexString()&&0==r.alpha?e(o).parent().find(".sp-preview").addClass("uf-unset-color"):e(o).parent().find(".sp-preview").removeClass("uf-unset-color"),o.default_value=r.toRgbString(),this.render_bottom())}})})}(jQuery);