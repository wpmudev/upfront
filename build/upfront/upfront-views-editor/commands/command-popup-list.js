!function(t){var e=Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.views:Upfront.mainData.l10n.global.views;define(["scripts/upfront/upfront-views-editor/commands/command","scripts/upfront/upfront-views-editor/content-editor"],function(n,o){return o.SidebarCommand.extend({tagName:"li",className:"command-popup-list",$popup:{},views:{},currentPanel:!1,render:function(){this.$el.addClass("upfront-entity_list upfront-icon upfront-icon-browse"),this.$el.html('<a title="'+e.posts_pages+'">'+e.posts_pages+"</a>")},on_click:function(){var n=this,o=Upfront.Popup.open(function(o,p,s){var a=t(this);a.empty().append('<p class="upfront-popup-placeholder">'+e.popup_preloader+"</p>"),n.$popup={top:p,content:a,bottom:s}});n.$popup.top.parent().addClass("upfront-popup-posts");var p=!1,s=Upfront.data.currentPost&&Upfront.data.currentPost.id?Upfront.data.currentPost.id:_upfront_post_data.post_id;p=!!s,s&&Upfront.data.posts&&Upfront.data.posts.length&&(p=!(!Upfront.data.posts[s]||!Upfront.data.posts[s].get)&&!!parseInt(Upfront.data.posts[s].get("comment_count"),10)),n.$popup.top.html('<ul class="upfront-tabs"><li data-type="posts" class="active">'+e.posts+'</li><li data-type="pages">'+e.pages+"</li>"+(Upfront.mainData.content_settings.post_types.length>3?'<li data-type="cpts">'+e.cpts+"</li>":"")+"</ul>"+n.$popup.top.html()+'<div class="upfront-icon upfront-icon-popup-search"></div>').find(".upfront-tabs li").on("click",function(){n.dispatch_panel_creation(this)}),n.$popup.top.find(".upfront-icon-popup-search").click(n.toggle_filter),n.dispatch_panel_creation(),o.done(function(){Upfront.Events.off("upfront:posts:sort"),Upfront.Events.off("upfront:posts:post:expand"),Upfront.Events.off("upfront:pages:sort"),Upfront.Events.off("upfront:comments:sort")})},toggle_filter:function(e){var n=t(e.target).parents(".upfront-popup-posts").find("#upfront-entity_list-search"),o=n.parent();return"none"===n.css("display")?(t(e.target).addClass("upfront-popup-icon-search-open"),o.addClass("upfront-filter-panel-open"),n.slideToggle("fast")):(t(e.target).removeClass("upfront-popup-icon-search-open"),o.removeClass("upfront-filter-panel-open"),n.slideToggle("fast"))},hide_filter_panel:function(){var e=t("#upfront-entity_list-search"),n=e.parent();n.removeClass("upfront-filter-panel-open"),t(".upfront-popup-icon-search-open").removeClass("upfront-popup-icon-search-open"),e.hide(),t(".upfront-popup-content-search-ran").removeClass("upfront-popup-content-search-ran")},dispatch_panel_creation:function(n){var p=this,s=n?t(n):p.$popup.top.find(".upfront-tabs li.active"),a=s.attr("data-type"),i=(a.charAt(0).toUpperCase()+a.slice(1).toLowerCase(),!1),r=(this.post.id,{});if(p.$popup.top.find(".upfront-tabs li").removeClass("active"),s.addClass("active"),this.hide_filter_panel(),this.currentPanel=a,p.views[a]&&"pages"!=a&&"posts"!=a&&("comments"!=a||Upfront.data.currentPost&&Upfront.data.currentPost.id&&p.views[a].view.collection.postId==Upfront.data.currentPost.id))return this.render_panel(p.views[a]);if("posts"==a)i=new Upfront.Collections.PostList([],{postType:"post"}),i.orderby="post_date",r={filterContent:!0,withAuthor:!0,limit:25,post_status:"any"};else if("pages"==a)i=new Upfront.Collections.PostList([],{postType:"page"}),r={limit:25,hierarchical:!0};else if("cpts"==a){var l=Upfront.mainData.content_settings.post_types,c=[];l.map(function(t){var e=t.name;"attachment"!==e&&"post"!==e&&"page"!==e&&c.push(e)}),i=new Upfront.Collections.PostList([],{postType:c}),i.orderby="post_date",r={limit:25,withThumbnail:!0}}else{var f=Upfront.data.currentPost&&Upfront.data.currentPost.id?Upfront.data.currentPost.id:_upfront_post_data.post_id;i=new Upfront.Collections.CommentList([],{postId:f}),i.orderby="comment_date"}return i.fetch(r).done(function(t){var n,s;switch(a){case"posts":if(n=null,"undefined"!=typeof p.views[a]&&(n=p.views[a].view.collection.pagination.totalElements),s=i.pagination.totalElements,n==s)return p.render_panel(p.views[a]);i.on("reset sort",p.render_panel,p),views={view:new o.Posts({collection:i,$popup:p.$popup}),search:new o.Search({collection:i,postType:"post"}),pagination:new o.Pagination({collection:i,postType:e.posts})},p.views.posts=views;break;case"pages":if(n=null,"undefined"!=typeof p.views[a]&&(n=p.views[a].view.collection.pagination.totalElements),s=i.pagination.totalElements,n==s)return p.render_panel(p.views[a]);i.on("reset sort",p.render_panel,p),views={view:new o.Pages({collection:i,$popup:p.$popup}),search:new o.Search({collection:i,postType:"page"}),pagination:new o.Pagination({collection:i,postType:e.pages})},p.views.pages=views;break;case"comments":i.on("reset sort",p.render_panel,p),views={view:new o.Comments({collection:i,$popup:p.$popup}),search:new o.Search({collection:i}),pagination:new o.Pagination({collection:i})},p.views.comments=views;break;case"cpts":if(n=null,"undefined"!=typeof p.views[a]&&(n=p.views[a].view.collection.pagination.totalElements),s=i.pagination.totalElements,n==s)return p.render_panel(p.views[a]);i.on("reset sort",p.render_panel,p),views={view:new o.Cpt({collection:i,$popup:p.$popup}),search:new o.Search({collection:i,postType:c}),pagination:new o.Pagination({collection:i,postType:e.cpts})},p.views.cpts=views}p.render_panel()}),!1},render_panel:function(){var t=this,e=this.views[this.currentPanel];e.view.render(),t.$popup.content.html(e.view.$el),e.view.setElement(e.view.$el),e.search.render(),t.$popup.content.prepend(e.search.$el),e.search.setElement(e.search.$el),t.$popup.bottom.empty(),e.pagination&&(e.pagination.render(),t.$popup.bottom.html(e.pagination.$el),e.pagination.setElement(e.pagination.$el))}})})}(jQuery);