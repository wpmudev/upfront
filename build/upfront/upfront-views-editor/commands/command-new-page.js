!function(e){var t=Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.views:Upfront.mainData.l10n.global.views;define(["scripts/upfront/upfront-views-editor/commands/command-new-post","scripts/upfront/upfront-views-editor/fields"],function(a,l){return a.extend({className:"command-new-page",postType:"page",_default_label:t.new_page,initialize:function(){this.setMode=Upfront.Application.MODE.LAYOUT},render:function(){Upfront.Events.trigger("command:newpage:start",!0),this.$el.html(this._default_label),this.$el.prop("title",this._default_label)},on_click:function(e){e.preventDefault();var t=this;Upfront.Util.post({action:"upfront-create-post_type",data:_.extend({post_type:t.postType,title:t._default_label},{})}).done(function(e){_upfront_post_data&&(_upfront_post_data.post_id=e.data.post_id),Upfront.Application.navigate("/edit/page/"+e.data.post_id,{trigger:!0}),Upfront.Events.trigger("click:edit:navigate",e.data.post_id)})},render_modal:function(){var e=this,a=this.modal.$el.find(".upfront-inline-modal-content");a.empty().append("<h2>"+t.add_new_page+"</h2>"),_.each(e.modal._fields,function(e){e.render(),e.delegateEvents(),a.append(e.$el)})},spawn_modal:function(){if(this.modal)return this.initialize_modal_data();var a=this,i=function(){if(_.each(a.modal._fields,function(e,t){a.modal._data[t]=e.get_value()}),!a.modal._fields.permalink.has_been_edited()){var t=e.trim(a.modal._data.title||a._default_label),l=t.replace(/^[^a-z0-9]+/gi,"").replace(/[^a-z0-9]+$/gi,"").replace(/[^-_0-9a-z]/gi,"-").toLowerCase();a.modal._fields.permalink.set_value(l)}},n=[{label:t.none,value:""}],o=Upfront.Util.post({action:"upfront-wp-model",model_action:"get_post_extra",postId:"fake",allTemplates:!0});this.modal=new Upfront.Views.Editor.Modal({to:e("body"),button:!0,top:120,width:540,button_text:t.create_page}),this.modal._fields={title:new Upfront.Views.Editor.Field.Text({label:"",name:"title",default_value:this._default_label,change:i}),permalink:new l.ToggleableText({label:"<b>"+t.permalink+":</b> "+Upfront.Settings.site_url.replace(/\/$/,"")+"/",label_style:"inline",name:"permalink",change:i}),template:new Upfront.Views.Editor.Field.Select({label:t.page_template,name:"template",values:n})},this.initialize_modal_data(),this.on("new_page:modal:open",i,this),this.on("new_page:modal:close",i,this),o.done(function(e){return a.modal._fields.template.options.values=n,e.data&&e.data.allTemplates?(_.each(e.data.allTemplates,function(e,t){a.modal._fields.template.options.values.push({label:t,value:e})}),void a.modal._fields.template.render()):!1})},initialize_modal_data:function(){var e=this;this.modal._data={},_.each(_.keys(this.modal._fields),function(t){e.modal._data[t]="",e.modal._fields[t].reset_state&&e.modal._fields[t].reset_state()})}})})}(jQuery);