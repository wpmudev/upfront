!function(e){var t=Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.views:Upfront.mainData.l10n.global.views;define(["scripts/upfront/upfront-views-editor/region/region-panel-item","scripts/upfront/upfront-views-editor/fields","scripts/upfront/upfront-views-editor/modal","text!upfront/templates/region_add_panel.html"],function(o,n,i,r){return o.extend({width:24,height:24,events:{click:"add_region_modal"},className:"upfront-inline-panel-item upfront-region-panel-item-add-region",icon:function(){var e=this.options.to;if(!e.match(/^(top|bottom)-(left|right)$/))return"add add-"+e},tooltip:function(){var e,o=this.options.to;switch(o){case"bottom":e=t.new_region_below;break;case"left":e=t.new_sidebar_region;break;case"right":e=t.new_sidebar_region;break;case"top":e=t.new_region_above;break;case"top-left":case"top-right":case"bottom-left":case"bottom-right":e=t.add_floating_region}return e},tooltip_pos:function(){var e,t=this.options.to;switch(t){case"bottom":e="top";break;case"left":case"top-left":case"bottom-left":e="right";break;case"right":case"top-right":case"bottom-right":e="left";break;case"top":e="bottom"}return e},initialize:function(e){this.options=e,this.options.to||(this.options.to="top"),this.options.width&&(this.width=this.options.width),this.options.height&&(this.height=this.options.height)},add_region_modal:function(e){var o=this.options.to,a=this,s=new i({to:this.panel_view.panels_view.$el,width:500,button:!0,button_text:t.add_region}),l=("left"==o||"right"==o)&&"global"==a.model.get("scope"),g=a.$el.parents(".upfront-region-center");g.addClass("upfront-region-editing-modal"),g.next().find(".upfront-icon-control-region-resize").hide(),fields={from:new n.Radios({name:"from",default_value:"new",layout:"horizontal-inline",values:[{label:t.new_region,value:"new"},{label:t.choose_global_region,value:"global",disabled:l}],change:function(){var e=this.get_value();a.from=e}}),region_title:new n.Text({name:"name",placeholder:t.region_name_placeholder,focus:function(){fields.from.set_value("new"),fields.from.trigger("changed")},change:function(){var e=this.get_value();a.region_title=e}}),make_global:new n.Checkboxes({name:"make_global",multiple:!1,values:[{label:t.make_this_region_global,value:1}],focus:function(){fields.from.set_value("new"),fields.from.trigger("changed")},change:function(){var e=this.get_value();a.make_global=1==e?!0:!1}}),from_region:new n.Select({name:"from_region",values:[{label:Upfront.Settings.l10n.global.behaviors.loading,value:""}],disabled:l,focus:function(){fields.from.set_value("global"),fields.from.trigger("changed")},change:function(){var e=this.get_value();a.from_region=e}})},from_region_values=function(){var e=[],n="top"==o||"bottom"==o,i="left"==o||"right"==o;return e.push({label:t.select_global_region,value:"",disabled:!0}),_.each(Upfront.data.global_regions,function(t){if(!(n&&t.container&&t.name!=t.container||i&&"left"!=t.sub&&"right"!=t.sub)){var o=a.model.collection,r=o.get_by_name(t.name);e.push({label:t.title,value:t.name,disabled:r!==!1})}}),e},s.render(),this.panel_view.panels_view.$el.append(s.$el),this.from="new",this.region_title="",this.make_global=!1,this.from_region="",Upfront.data.global_regions?fields.from_region.options.values=from_region_values():Upfront.Util.post({action:"upfront_list_scoped_regions",scope:"global",storage_key:_upfront_save_storage_key}).done(function(e){Upfront.data.global_regions=e.data,fields.from_region.options.values=from_region_values(),fields.from_region.render(),fields.from_region.delegateEvents()}),s.open(function(e,t){var o=_.template(r,{});_.each(fields,function(e,t){e.render(),e.delegateEvents()}),t.addClass("upfront-add-region-modal"),e.append(o),e.find(".upfront-add-region-choice").append(fields.from.$el),e.find(".upfront-add-region-new").append(fields.region_title.$el),l||e.find(".upfront-add-region-new").append(fields.make_global.$el),e.find(".upfront-add-region-global").append(fields.from_region.$el)},this).done(function(e){"new"!=a.from&&a.from_region?a.add_region_from_global(a.from_region):a.add_region()}).always(function(e){g.removeClass("upfront-region-editing-modal"),g.next().find(".upfront-icon-control-region-resize").show(),e.remove()}),e.stopPropagation()},add_region:function(){var t=this.options.to,o=this.model.collection,n=(o.size()-1,o.indexOf(this.model)),i=this.model.get("position"),r=this.model.get_sub_regions(),a="top"==t||"bottom"==t,s="top"==t||"left"==t,l=this.region_title?this.region_title.replace(/[^A-Za-z0-9\s_-]/g,""):a?"Region ":this.model.get("title")+" "+t.charAt(0).toUpperCase()+t.slice(1),g=l.toLowerCase().replace(/\s/g,"-"),d=o.get_by_name(g)||!this.region_title&&a?o.get_new_title(l,1):!1,f=d!==!1?d.title:l,p=d!==!1?d.name:g,m=new Upfront.Models.Region(_.extend(_.clone(Upfront.data.region_default_args),{name:p,container:a?p:this.model.get("name"),title:f})),c={},h=function(e){return e&&e.cid?o.indexOf(e):-1};if(a){m.set_property("row",Upfront.Util.height_to_row(300));var u=_.filter(_.map(r,h),function(e){return e>=0}),b=r.fixed.length>0?_.map(r.fixed,h):[];u=_.union(u,b,[n]),u.length>0&&("top"==t?n=_.min(u):"bottom"==t&&(n=_.max(u))),this.make_global&&m.set({scope:"global"})}else m.set_property("col",5),"left"==t||"right"==t?(m.set("sub",s?"left":"right"),m.set("position",s?i-1:i+1),c.sub=s?"left":"right"):("top-left"==t||"top-right"==t||"bottom-left"==t||"bottom-right"==t)&&(m.set("type","fixed"),m.set("sub","fixed"),m.set_property("width",225),m.set_property("height",225),t.match(/^top/)&&m.set_property("top",30),t.match(/^bottom/)&&m.set_property("bottom",30),t.match(/left$/)&&m.set_property("left",30),t.match(/right$/)&&m.set_property("right",30),m.set_property("background_type","color"),m.set_property("background_color","#aeb8c2"),c.sub="fixed"),this.make_global?m.set({scope:"global"}):m.set({scope:this.model.get("scope")});m.get("clip")||!a?(Upfront.Events.once("entity:region:before_render",this.before_animation,this),Upfront.Events.once("entity:region:added",this.run_animation,this)):(Upfront.Events.once("entity:region_container:before_render",this.before_animation,this),Upfront.Events.once("entity:region:added",this.run_animation,this)),m.add_to(o,s?n:n+1,c);var v=o.where({type:"wide"});v.length>0&&e("div.upfront-regions a#no_region_add_one").remove()},add_region_from_global:function(e){var t=this,o=this.options.to,n=this.model.collection,i=(n.size()-1,n.indexOf(this.model)),r=(this.model.get("position"),this.model.get_sub_regions()),a="top"==o||"bottom"==o,s="top"==o||"left"==o,l=function(e){return e&&e.cid?n.indexOf(e):-1};if(a){var g=_.filter(_.map(r,l),function(e){return e>=0}),d=r.fixed.length>0?_.map(r.fixed,l):[];g=_.union(g,d,[i]),g.length>0&&("top"==o?i=_.min(g):"bottom"==o&&(i=_.max(g)))}a?(Upfront.Events.once("entity:region_container:before_render",this.before_animation,this),Upfront.Events.once("entity:region:added",this.run_animation,this)):(Upfront.Events.once("entity:region:before_render",this.before_animation,this),Upfront.Events.once("entity:region:added",this.run_animation,this)),Upfront.Util.post({action:"upfront_get_scoped_regions",scope:"global",name:e,storage_key:_upfront_save_storage_key}).done(function(e){var r=e.data,a=!1,l=[],g=function(){_.each(l,function(e){e.model.add_to(n,e.index,e.options)})};_.each(r,function(e,n){var r=new Upfront.Models.Region(e),g={};r.is_main()?a={model:r,index:s?i:i+1,options:g}:("left"==o||"right"==o?(r.set("container",t.model.get("name")),r.set("sub",s?"left":"right"),g.sub=s?"left":"right"):g.sub=r.get("sub"),l.push({model:r,index:(s?i:i+1)+n,options:g}))}),a!==!1?(Upfront.Events.once("entity:region:added",function(){g()}),a.model.add_to(n,a.index,a.options)):g()})},before_animation:function(e,t){Upfront.Events.trigger("command:region:edit_toggle",!1),Upfront.Events.trigger("command:region:fixed_edit_toggle",!1)},run_animation:function(t,o){function n(){Upfront.Settings.LayoutEditor.Grid.baseline,t.$el.outerHeight();t.$el.removeClass(r),Upfront.Events.trigger("command:region:edit_toggle",!0),Upfront.Events.trigger("command:region:fixed_edit_toggle",!0),t.trigger("activate_region",t)}var i=this.options.to,r="upfront-add-region-ani upfront-add-region-ani-"+i,a=setTimeout(n,500),s="animationstart.region_ani webkitAnimationStart.region_ani MSAnimationStart.region_ani oAnimationStart.region_ani",l="animationend.region_ani webkitAnimationEnd.region_ani MSAnimationEnd.region_ani oAnimationEnd.region_ani";if(t.$el.one(s,function(){clearTimeout(a),t.$el.off(s)}),t.$el.one(l,function(){n(),t.$el.off(l)}),t.$el.addClass(r),"top"==i||"bottom"==i){var g=t.$el.hasClass("upfront-region-container")?t.$el:t.$el.closest(".upfront-region-container"),d=g.offset(),f=e(document).scrollTop(),p=!1,_=g.height(),m=e(window).height();"top"==i&&d.top<f?p=d.top-50:"bottom"==i&&d.top+_>f+m&&(p=d.top+_-m),p!==!1&&e("html,body").animate({scrollTop:p},600)}}})})}(jQuery);