(function(e){define(["upfront/post-editor/upfront-post-content","text!upfront/templates/popup.html","text!elements/upfront-image/tpl/image_editor.html","scripts/upfront/element-settings/settings","scripts/upfront/element-settings/root-settings-panel"],function(t,n,r,i,s){var o=Upfront.Views.ObjectView.extend({initialize:function(e){var t=this,n=this.model.get_property_value_by_name("postPart");this.postPart=n,this.listenTo(Upfront.Events,"entity:resize_start",this.close_settings),this.listenTo(Upfront.Events,"entity:drag_start",this.close_settings),this.postView=Upfront.Application.PostLayoutEditor.postView,this.postView.partOptions&&this.postView.partOptions[this.postPart]&&_.each(this.postView.partOptions[this.postPart],function(e,n){t.model.set_property(n,e,!0)}),this.listenTo(this.model.get("properties"),"change add remove",this.updateOptions),this.listenTo(this.postView.model,"template:"+n,this.refreshTemplate),_upfront_post_data&&(this.post=Upfront.data.posts[_upfront_post_data.post_id]),this.tpl=this.getTemplate(),this.model.tpl=this.tpl,typeof this.init=="function"&&this.init.apply(this,arguments)},get_content_markup:function(){var e=this.property("postPart"),n=t.getMarkupper(),r=this.getTemplate(),i=Upfront.Application.PostLayoutEditor.partMarkup,s=n.markup(e,i,r);return s?s:(this.updatePartContent(),"Loading")},on_render:function(){var e=this.postView.partOptions,t=e[this.property("postPart")]||{};t.extraClasses&&this.$(".upfront-object").addClass(t.extraClasses),this.$(".upfront-object").addClass("Postpart_"+this.postPart),Upfront.Events.trigger("post:layout:partrendered",this)},updateOptions:function(){var e=this.model.get("properties").toJSON(),t={},n=this.postView.partOptions,r=["","row","type","view_class","has_settings","id_slug","postPart","element_id"];_.isArray(n)&&(n={}),_.each(e,function(e){r.indexOf(e.name)==-1&&(t[e.name]=e.value)}),n[this.postPart]=t,this.postView.partOptions=n,this.updatePartContent(),this.$(".upfront-object-content").html("Loading")},updatePartContent:function(){var e=this,t=this.postView.partOptions||{},n={action:"content_part_markup",post_id:this.postView.editor.postId?this.postView.editor.postId:this.post.id,parts:JSON.stringify([{slug:this.postPart,options:t[this.postPart]||{}}]),templates:{}};n.templates[this.postPart]=this.getTemplate(),Upfront.Util.post(n).done(function(t){_.extend(Upfront.Application.PostLayoutEditor.partMarkup,t.data.replacements),e.render()})},getTemplate:function(){var e=this.postView.partTemplates,t=this.postPart;return t=="contents"&&this.postView.property("content_type")=="excerpt"&&(t="excerpt"),e&&e[t]?e[t]:Upfront.data.thisPost.templates[t]},refreshTemplate:function(){this.model.tpl=this.getTemplate(),this.render()},property:function(e,t,n){return typeof t!="undefined"?(typeof n=="undefined"&&(n=!0),this.model.set_property(e,t,n)):this.model.get_property_value_by_name(e)}}),u=Upfront.Views.Editor.Sidebar.Element.extend({className:"draggable-element upfront-no-select draggable-post-element",initialize:function(e){this.options=e,this.title=e.title,this.slug=this.title.toLowerCase().replace(" ","_"),this.Model=w,this.View=g[this.slug]?g[this.slug]:o,this.Settings=p},add_element:function(){var e=new this.Model({properties:{type:"PostPart_"+this.slug+"Model",view_class:"PostPart_"+this.slug+"View",has_settings:1,id_slug:"PostPart_"+this.slug,postPart:this.slug}}),t=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c10 post-part"},{name:"has_settings",value:0},{name:"row",value:Upfront.Util.height_to_row(100)}],objects:[e]});this.add_module(t)}}),a={type:"Button",compact:!0,on_click:function(){Upfront.Events.trigger("post:edit:templatepart",this.model.tpl,this.model.get_property_value_by_name("postPart"))},label:"Edit markup"},f=s.extend({settings:[{type:"SettingsItem",fields:[a]}]}),l=f.extend({label:"date",settings:[{type:"SettingsItem",title:"Date",fields:[{type:"Text",label:Upfront.Settings.l10n.global.content.php_date_fmt,property:"format"},a]}],title:"Date"}),c=f.extend({label:"tag",settings:[{type:"SettingsItem",title:"Tag",fields:[{type:"Text",label:Upfront.Settings.l10n.global.content.tag_separator,property:"tag_separator"},a]}],title:"Tag"}),h=f.extend({label:"content",settings:[{type:"SettingsItem",title:"Content",fields:[{type:"Number",label:Upfront.Settings.l10n.global.content.left,property:"padding_left",min:0,step:1},{type:"Number",label:Upfront.Settings.l10n.global.content.right,property:"padding_right",min:0,step:1},a]}],title:"Content"}),p=i.extend({initialize:function(){var e=this.model.get_property_value_by_name("postPart");this.panels=e&&this.raw_panels[e]?{General:this.raw_panels[e]}:this.raw_panels,i.prototype.initialize.apply(this,arguments)},raw_panels:{date:l,tags:c,contents:h,title:f.extend({label:"title",title:"Title"}),featured_image:f.extend({label:"featured_image",title:"Featured Image"}),author:f.extend({label:"author",title:"Author"}),author_gravatar:f.extend({label:"gravatar",title:"Gravatar"}),comments_count:f.extend({label:"comments_count",title:"Count"}),categories:f.extend({label:"categories",title:"Categories"})}}),d=o.extend({updateOptions:function(){var e=this.model.get("properties").toJSON(),t={},n=this.postView.partOptions,r=["","row","type","view_class","has_settings","id_slug","postPart","element_id"];_.isArray(n)&&(n={}),_.each(e,function(e){r.indexOf(e.name)==-1&&(t[e.name]=e.value)});var i=t.overflow_left||0,s=t.overflow_right||0;n[this.postPart]=t,n.colSize=Upfront.Behaviors.GridEditor.col_size,this.postView.partOptions=n,this.updatePartContent(),this.$(".upfront-object-content").html("Loading")},render:function(){var e=this;o.prototype.render.apply(this,arguments),this.paddingChangeHandler||(this.paddingChangeHandler=_.bind(this.refreshPaddings,this),Upfront.Events.on("post:padding:update",this.paddingChangeHandler)),this.refreshPaddingsFromProperties()},refreshPaddingsFromProperties:function(){this.refreshPaddings(this.property("padding_left")||0,this.property("padding_right")||0)},refreshPaddings:function(t,n){var r=Upfront.Behaviors.GridEditor,i=r.col_size,s=n>0?n*i:15,o=t>0?t*i:15,u=e(".upfront-region-postlayouteditor").find(".upfront-post-padding"),a=".upfront-region-postlayouteditor .upfront-output-PostPart_contents {",f=e(".upfront-region-postlayouteditor .upfront-output-PostPart_contents");u.length||(u=e('<style class="upfront-post-padding"></style>'),setTimeout(function(){e(".upfront-region-postlayouteditor").append(u)},200)),a+="padding-left: "+o+"px; padding-right: "+s+"px;}",a+=".upfront-region-postlayouteditor  .upfront-output-PostPart_contents .ueditor-insert-variant {",a+=" margin-left: "+o*-1+"px; margin-right: "+s*-1+"px; }",u.html(a)}}),v=o.extend({sizehintTpl:_.template(e(r).find("#sizehint-tpl").html()),init:function(e){this.partOptions=this.postView.partOptions.featured_image||{}},on_render:function(){var t=this,n=this.moduleId||this.parent_module_view.model.get_property_value_by_name("element_id"),r=this.partOptions.height||100,i=this.parent_module_view;this.moduleId=n,this.moduleView=i.$("#"+n),this.placeholder||(this.placeholder=e('<div class="upfront-post-thumb-placeholder upfront-ui"><div>'+Upfront.Settings.l10n.global.content.post_featured_image+"</div></div>"),r&&this.placeholder.height(r)),this.$(".upfront-content-marker").replaceWith(this.placeholder),r||this.resizePlaceholder(),i.$("#style-"+this.cid).length||i.$el.append('<style id="style-'+this.cid+'">#'+n+" div{ height: 100%; }</style>"),this.resizePlaceholderCallback||(this.resizePlaceholderCallback=_.bind(this.resizePlaceholder,this)),this.moduleView.off("resizestop",t.resizePlaceholderCallback).off("resize",t.resizePlaceholderCallback).on("resize",t.resizePlaceholderCallback).on("resizestop",t.resizePlaceholderCallback),this.update_size_hint()},resizePlaceholder:function(t){this.placeholder.height(this.moduleView.height());var n=e(".upfront-resize").height();t&&t.type=="resizestop"&&(this.model.set_property("height",n,!0),this.model.set_property("attributes",{style:"max-height: "+n+"px"}),this.partOptions.height=n),this.update_size_hint(n)},update_size_hint:function(t){t=typeof t=="undefined"?this.property("height"):t;var n=this.$(".upfront-editable_entity").width()?this.$(".upfront-editable_entity").width():"100%";n=n!=="100%"?Upfront.Util.grid.normalize_width(n):n;var r=e("<div>").addClass("upfront-ui uimage-resize-hint sizehint-top featured-image-sizehint").html(this.sizehintTpl({width:n,height:t}));this.placeholder.closest(".upfront-object-view").append(r)}}),m=o.extend({init:function(e){this.partOptions=this.postView.partOptions.date||{}},on_render:function(){var e=this,t=this.moduleId||this.parent_module_view.model.get_property_value_by_name("element_id"),n=this.partOptions.height||30,r=this.parent_module_view;this.moduleId=t,this.moduleView=r.$("#"+t),this.moduleView.height(n),this.update_attributes_callback||(this.update_attributes_callback=_.bind(this.update_attributes,this)),this.moduleView.off("resizestop",e.update_attributes_callback).off("resize",e.update_attributes_callback).on("resize",e.update_attributes_callback).on("resizestop",e.update_attributes_callback)},update_attributes:function(t){if(t&&t.type=="resizestop"){var n=e(".upfront-resize").height();this.model.set_property("height",n,!0),this.model.set_property("attributes",{style:"min-height: "+n+"px"}),this.partOptions.height=n}}}),g={contents:d,featured_image:v,date:m},y=Upfront.Views.Editor.Field.Field.extend({events:{"click .upfront-template-edit":"prepareTemplateEditor"},render:function(){return this.$el.html('<a href="#" title="Edit template" class="upfront-css-edit upfront-template-edit">'+Upfront.Settings.l10n.global.content.edit_html_tpl+"</a>"),this},prepareTemplateEditor:function(e){e.preventDefault(),Upfront.Events.trigger("post:edit:templatepart",this.model.tpl,this.model.get_property_value_by_name("postPart"))}}),b=Backbone.View.extend({events:{"click button":"save","click .upfront-css-close":"cancel"},initialize:function(){var t=e("#upfront_code-editor"),n=e.Deferred();t.length||(t=e('<section id="upfront_code-editor" class="upfront-ui upfront_code-editor upfront_code-editor-complex upfront-css-no-sidebar"></section>')),this.setElement(t),this.prepareAce=n.promise(),require([Upfront.Settings.ace_url],function(){n.resolve()}),this.editor=t},open:function(e){var t=this;t.tpl=e.tpl,t.postPart=e.postPart,this.prepareAce.then(function(){t.ace?(t.ace.getSession().setValue(t.tpl),t.$el.show()):t.render()})},render:function(){var t=this,n=e('<div class="upfront-css-resizable"></div>'),r=this.editor;r.detach(),n.html('<div class="upfront-css-top"><span class="upfront-css-type">'+this.postPart+' Part Template</span><a class="upfront-css-close" href="#">close</a></div>'),n.append('<div class="upfront-css-body"><div class="upfront_code-editor-section upfront_code-markup active"><div class="upfront-css-ace"></div></div><button>'+Upfront.Settings.l10n.global.content.save+"</button></div>"),this.resizeHandler=this.resizeHandler||function(){r.width(e(window).width()-e("#sidebar-ui").width()-1)},e(window).on("resize",this.resizeHandler),this.resizeHandler(),e("body").append(r.append(n).show());var i=r.height()-r.find(".upfront-css-top").outerHeight();r.find(".upfront-css-body").height(i);var s=ace.edit(r.find(".upfront-css-ace")[0]),o=s.getSession();o.setUseWorker(!1),s.setShowPrintMargin(!1),o.setMode("ace/mode/html"),s.setTheme("ace/theme/monokai"),s.setShowPrintMargin(!1),o.setValue(this.tpl),s.on("change",function(e){t.timer&&clearTimeout(t.timer),t.timer=setTimeout(function(){console.log("esso")},1e3),t.trigger("change",s)}),s.focus(),this.ace=s,this.startResizable()},startResizable:function(){var t=this.editor,n=this,r=t.find(".upfront-css-body"),i=t.find(".upfront-css-top").outerHeight(),s=t.find(".upfront-css-selectors"),o=t.find(".upfront-css-save-form"),u=function(u,a){var f=a?a.size.height:t.find(".upfront-css-resizable").height(),l=f-i;r.height(l),n.ace&&n.ace.resize(),s.height(l-o.outerHeight()),e("#page").css("padding-bottom",f)};u(),t.find(".upfront-css-resizable").resizable({handles:{n:".upfront-css-top"},resize:u,minHeight:200,delay:100})},save:function(){this.trigger("save",this.ace.getSession().getValue(),this.postPart)},cancel:function(e){e.preventDefault(),this.trigger("cancel")},close:function(){this.postPart=!1,this.tpl=!1,this.$el.hide()},destroy:function(){this.ace.destroy(),this.remove()}}),w=Upfront.Models.ObjectModel.extend({initialize:function(e){var t=e.properties;t.element_id||(t.element_id=Upfront.Util.get_unique_id(t.id_slug+"-object")),this.set("properties",new Upfront.Collections.Properties({})),this.init_properties(t),typeof this.init=="function"&&this.init.apply(this,arguments)}}),E=Backbone.View.extend({tpl:_.template(e(n).find("#save-dialog-tpl").html()),attributes:{id:"upfront-save-dialog-background"},events:{"click #upfront-save-dialog":"save",click:"close"},initialize:function(e){this.options=e},render:function(){if(e("#upfront-save-dialog-background").length)return;return this.$el.html(this.tpl(this.options)),e("body").append(this.$el),this.$el.width(e(window).width()).height(e(document).height()),this},save:function(t){t.preventDefault();var n=e(t.target),r;if(!n.hasClass("upfront-save-button"))return;this.trigger("save",n.data("save-as"))},close:function(e){if(e&&e.isDefaultPrevented())return;var t=this;this.$el.fadeOut("fast",function(){t.$el.detach(),t.trigger("closed")})},save_dialog:function(t,n){e("body").append("<div id='upfront-save-dialog-background' />"),e("body").append("<div id='upfront-save-dialog' />");var r=e("#upfront-save-dialog"),i=e("#upfront-save-dialog-background"),s=Upfront.Application.layout.get("current_layout"),o="";i.width(e(window).width()).height(e(document).height()),o+="<p>"+Upfront.Settings.l10n.global.content.save_layout_nag+"</p>",e.each(_upfront_post_data.layout,function(e,t){if(e=="type")return;o+='<span class="upfront-save-button" data-save-as="'+t+'">'+Upfront.Settings.LayoutEditor.Specificity[e]+"</span>"}),r.html(o),e("#upfront-save-dialog").on("click",".upfront-save-button",function(){var s=e(this).attr("data-save-as");return i.remove(),r.remove(),t.apply(n,[s]),!1}),e("#upfront-save-dialog-background").on("click",function(){return i.remove(),r.remove(),!1})}});Upfront.Views.Editor.SaveDialog=E;var S=new Upfront.Collections.ImageVariants(Upfront.mainData.postImageVariants);return Upfront.Content||(Upfront.Content={}),_.extend(Upfront.Content,{PostElement:u,TemplateEditor:b,PostPart:w,ImageVariants:S}),{}})})(jQuery);