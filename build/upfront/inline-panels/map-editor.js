!function(t){var e=Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.views:Upfront.mainData.l10n.global.views;define(["text!scripts/upfront/templates/map-editor.html"],function(i){var r=Upfront.Views.ObjectView.extend({is_editing:!1,script_error:!1,SYNTAX_TYPES:{script:"json"},MIN_HEIGHT:200,editorTpl:_.template(i),content_editable_selector:".editable",initialize:function(){var t=this.fallback("script");this.checkJSon(t)},on_render:function(){this.start_json_editor()},start_json_editor:function(){if(this.is_editing)return!1;this.is_editing=!0;var e=t("#upfront_map-editor"),i=this;e.length||(e=t('<section id="upfront_map-editor" class="upfront-ui upfront_map-editor upfront_map-editor-complex"></section>'),t("body").append(e)),require([Upfront.Settings.ace_url],function(){i.createEditor(e)})},on_edit:function(){if(this.is_editing)return!1;var e=this.$el.find(".upfront_map-element "+this.content_editable_selector);if(e.length)return this.bootContentEditors(e);this.is_editing=!0;var i=t("#upfront_map-editor");i.length||(i=t('<section id="upfront_map-editor" class="upfront-ui upfront_map-editor upfront_map-editor-complex"></section>'),t("body").append(i)),this.createEditor(i)},bootContentEditors:function(e){if(!e||!e.length)return!1;var i=t(this.fallback("markup")),r=this;e.each(function(e){var n=t(this),o=0>=e;return n.data("ueditor")?!0:void n.ueditor({autostart:o,placeholder:"",disableLineBreak:!0}).on("start",function(){r.is_editing=!0}).on("stop",function(){r.is_editing=!1}).on("syncAfter",function(){var o=t(i.find(r.content_editable_selector)[e]);return o.length?(o.html(n.html()),void r.property("markup",t("<div />").append(i).html())):!1})})},startResizable:function(t){var e=this,i=t.find(".upfront-css-body"),r=0,n=t.find(".upfront_map-editor-complex-wrapper"),o=function(o,s){var a=s?s.size.height:t.find(".upfront_map-editor-complex-wrapper").height(),d=a-r;i.height(d),_.each(e.editors,function(t){t.resize()}),n.css({width:"",height:"",left:"",top:""})};n.find(".upfront-css-top").removeClass("ui-resizable-handle").addClass("ui-resizable-handle").removeClass("ui-resizable-n").addClass("ui-resizable-n"),r=t.find(".upfront-css-top").outerHeight(),o(),n.resizable({handles:{n:".upfront-css-top"},resize:o,minHeight:200,delay:100})},createEditor:function(i){var r=this;i.html(this.editorTpl({markup:this.fallback("markup"),style:this.fallback("style"),script:this.fallback("script"),l10n:e.template})),t("#page").css("padding-bottom","200px"),i.show(),this.resizeHandler=this.resizeHandler||function(){i.width(t(window).width()-t("#sidebar-ui").width()-1)},t(window).on("resize",this.resizeHandler),this.resizeHandler(),this.editors={},this.timers={},i.find(".upfront_map-ace").each(function(){var n=t(this),o=n.html(),s=ace.edit(this),a=n.data("type");s.getSession().setUseWorker(!1),s.setTheme("ace/theme/monokai"),s.getSession().setMode("ace/mode/"+r.SYNTAX_TYPES[a]),s.setShowPrintMargin(!1),"markup"===a&&o&&s.getSession().setValue(o),s.on("change",function(){r.timers[a]&&clearTimeout(r.timers[a]),r.timers[a]=setTimeout(function(){var t=s.getValue();"script"==a&&r.checkJSon(t),r.script_error?i.find(".upfront_map-jsalert").show().find("i").attr("title",e.create.js_error+" "+r.script_error):i.find(".upfront_map-jsalert").hide(),r.property(a,t,!1)},1e3)}),s.renderer.scrollBar.width=5,s.renderer.scroller.style.right="5px",r.editors[a]=s}),this.currentEditor=this.editors.markup;var n=i.find(".upfront-css-top"),o=i.find(".upfront-css-body");o.height(this.MIN_HEIGHT-n.outerHeight()),this.startResizable(i),i.find("button").on("click",function(t){_.each(r.editors,function(t,e){r.property(e,t.getValue())}),r.property("map_styles",r.fallback("script"),!1),r.is_editing=!1,r.destroyEditor()}),i.on("click",".upfront-css-type",function(t){r.hiliteElement(t)}).on("click",".upfront-css-close",function(e){e.preventDefault(),r.destroyEditor(),t("#page").css("padding-bottom",0)})},destroyEditor:function(){var e=this;this.editors&&this.editors.length&&(_.each(this.editors,function(t){t.destroy()}),e.editors=!1),this.currentEditor=!1,t("#upfront_map-editor").html("").hide(),t(window).off("resize",this.resizeHandler),this.is_editing=!1},hiliteElement:function(e){e.preventDefault();var i=this.$el.find(".upfront-object-content"),r=i.offset().top-50;t(document).scrollTop(r>0?r:0),this.blink(i,4)},blink:function(t,e){var i=this;t.css("outline","3px solid #3ea"),setTimeout(function(){t.css("outline","none"),e--,e>0&&setTimeout(function(){i.blink(t,e-1)},100)},100)},checkJSon:function(t){this.script_error=!1;try{JSON.parse(t)}catch(e){this.script_error=e.message}},fallback:function(t){return this.model.get_property_value_by_name(t)||Upfront.data.upfront_code.defaults.fallbacks[t]},property:function(t,e,i){return"undefined"!=typeof e?("undefined"==typeof i&&(i=!0),this.model.set_property(t,e,i)):this.model.get_property_value_by_name(t)}});return r})}(jQuery);