(function(e){define(["scripts/upfront/behaviors/dragdrop","scripts/upfront/behaviors/resize"],function(t,n){var r={lightbox_cols:!1,main:{$el:null,top:0,left:0,right:0},grid_layout:{top:0,left:0,right:0},containment:{$el:null,top:0,left:0,right:0,col:0,grid:{top:0,left:0,right:0}},min_col:1,max_row:0,compare_col:2,compare_row:10,focus_compare_col:1,focus_compare_row:3,update_distance:10,timeout:0,focus_timeout:500,focus:!1,focus_out_distance:50,focus_coord:{x:0,y:0},_t:null,_t_focus:null,col_size:0,baseline:0,grid:null,region_type_priority:{wide:1,clip:1,full:1,fixed:2,lightbox:2},els:[],wraps:[],regions:[],drops:[],drop:null,el_selector:"",el_selector_direct:"",module_selector:".upfront-module-view > .upfront-module, .upfront-module-group",module_selector_direct:"> .upfront-module-view > .upfront-module, > .upfront-module-group",object_selector:".upfront-object-view > .upfront-object",object_selector_direct:"> .upfront-object-view > .upfront-object",_id:0,drag_instances:{},resize_instances:{},wrapper_resize_instances:{},show_debug_element:!1,resizing:!1,_new_id:function(){var e=Upfront.Behaviors.GridEditor;return e._id++,e._id},get_grid:function(e,t){var n=Upfront.Behaviors.GridEditor,r=Upfront.Util.isRTL()?Math.round((n.grid_layout.right-e)/n.col_size)+1:Math.round((e-n.grid_layout.left)/n.col_size)+1,i=Math.ceil((t-n.grid_layout.top)/n.baseline)+1;return{x:r,y:i}},get_position:function(t){var n=Upfront.Behaviors.GridEditor,r=e(t),i=parseFloat(r.css("width")),s=parseFloat(r.css("height")),o=r.offset(),u=o.top,a=u+s,f=Upfront.Util.isRTL()?o.left+i:o.left,l=Upfront.Util.isRTL()?f-i:f+i,c=n.get_grid(f,u),h=r.data("current_col")?r.data("current_col"):Math.round(i/n.col_size),p=Math.floor(s/n.baseline),d={top:Math.round(u),left:Math.round(f),bottom:Math.round(a),right:Math.round(l)},v={top:c.y,left:c.x,right:c.x+h-1,bottom:c.y+p-1};return{$el:r,_id:n._new_id(),position:d,outer_position:d,width:i,height:s,center:{y:Math.round(u+s/2),x:Upfront.Util.isRTL()?Math.round(f-i/2):Math.round(f+i/2)},col:h,row:p,grid:v,outer_grid:v,grid_center:{y:c.y+p/2-1,x:c.x+h/2-1}}},get_region_position:function(t){var n=Upfront.Behaviors.GridEditor,r=e(t),i=r.find(".upfront-modules_container"),s=n.get_position(i);return s.$el=r,s},init_margin:function(e){var t=Upfront.Behaviors.GridEditor,n=Math.round(parseFloat(e.$el.css("margin-left"))/t.col_size),r=Math.round(parseFloat(e.$el.css("margin-top"))/t.baseline);e.$el.data("margin",{original:{left:n,top:r},current:{left:n,top:r}})},get_affected_els:function(e,t,n,r){var i={top:[],left:[],bottom:[],right:[]},s=e.outer_grid;Array.isArray(n)?n.push(e):n=[e],r=r?!0:!1,_.each(_.reject(t,function(e){var t=_.find(n,function(t){return t.$el.get(0)==e.$el.get(0)});return t?!0:!1}),function(t){if(e.region!=t.region)return;if(e.group!=t.group)return;if(t.outer_grid.top>=s.top&&t.outer_grid.top<s.bottom||t.outer_grid.bottom>=s.top&&t.outer_grid.bottom<=s.bottom||s.top>=t.outer_grid.top&&s.top<t.outer_grid.bottom||s.bottom>=t.outer_grid.top&&s.bottom<=t.outer_grid.bottom)s.left>t.outer_grid.right&&i.left.push(t),s.right<t.outer_grid.left&&i.right.push(t);s.top>t.outer_grid.bottom&&i.top.push(t),s.bottom<t.outer_grid.top&&i.bottom.push(t)});if(r){var o=_.max(i.left,function(e){return e.outer_grid.right});i.left=_.filter(i.left,function(e){return e.outer_grid.right==o.outer_grid.right});var u=_.min(i.right,function(e){return e.outer_grid.left});i.right=_.filter(i.right,function(e){return e.outer_grid.left==u.outer_grid.left});var a=_.max(i.top,function(e){return e.outer_grid.top});i.top=_.filter(i.top,function(e){return e.outer_grid.top==a.outer_grid.top});var f=_.min(i.bottom,function(e){return e.outer_grid.top});i.bottom=_.filter(i.bottom,function(e){return e.outer_grid.top==f.outer_grid.top})}return i},get_affected_wrapper_els:function(e,t,n,r){var i=Upfront.Behaviors.GridEditor,s=i.get_affected_els(e,t,n,r),o={top:_.flatten(_.map(s.top,function(e){var t=_.reject(i.get_wrap_els(e),function(e){return n?_.find(n,function(t){return t.$el.get(0)==e.$el.get(0)}):!1}),r=i.get_wrap_el_max(e,n,!0);return _.filter(t,function(e){return e.outer_grid.bottom==r.outer_grid.bottom})})),bottom:_.flatten(_.map(s.bottom,function(e){var t=_.reject(i.get_wrap_els(e),function(e){return n?_.find(n,function(t){return t.$el.get(0)==e.$el.get(0)}):!1}),r=i.get_wrap_el_min(e,n,!0);return _.filter(t,function(e){return e.outer_grid.top==r.outer_grid.top})})),left:_.flatten(_.map(s.left,function(e){var t=_.reject(i.get_wrap_els(e),function(e){return n?_.find(n,function(t){return t.$el.get(0)==e.$el.get(0)}):!1}),r=i.get_wrap_el_max(e,n,!1);return _.filter(t,function(e){return e.outer_grid.right==r.outer_grid.right})})),right:_.flatten(_.map(s.right,function(e){var t=_.reject(i.get_wrap_els(e),function(e){return n?_.find(n,function(t){return t.$el.get(0)==e.$el.get(0)}):!1}),r=i.get_wrap_el_min(e,n,!1);return _.filter(t,function(e){return e.outer_grid.left==r.outer_grid.left})}))};return o},get_move_limit:function(e,t){var n=[t.grid.left,t.grid.right];return _.each(e.left,function(e){e.grid.right>n[0]&&(n[0]=e.grid.right+1)}),_.each(e.right,function(e){e.grid.left<n[1]&&(n[1]=e.grid.left-1)}),n},get_resize_limit:function(e,t){var n=[t.grid.left,t.grid.right];return _.each(e.left,function(e){e.grid.left>n[0]&&(n[0]=e.grid.left)}),_.each(e.right,function(e){e.grid.right<n[1]&&(n[1]=e.grid.right)}),n},get_max_size:function(e,t,n,r){var i=Upfront.Behaviors.GridEditor,s=i.get_class_num(e.$el,i.grid.class),r=/all|nw|se/.test(r)?r:"all",o=e.$el.data("margin"),u=i.get_affected_els(e,t,[],!0),a=i.get_move_limit(u,i.containment),f=r=="nw"?s+e.grid.left-a[0]:r=="se"?s+a[1]-e.grid.right:a[1]-a[0]+1,l=n.$el.hasClass("upfront-region-expand-lock"),c=u.bottom.length?_.min(u.bottom,function(e){return e.grid.top}):!1,h=c?c.grid.top-e.grid.top:n.grid.bottom-e.grid.top,p=r=="nw"?o.original.top+e.row:r=="se"?h:h+o.original.top;return{col:f,row:l||r=="nw"?p:!1}},get_wrap_els:function(t){var n=Upfront.Behaviors.GridEditor,r=t.$el.find(n.el_selector_direct);return _.map(r,function(t){var t=n.get_el(e(t));return _.find(n.els,function(e){return e._id==t._id})})},get_wrap_el_min:function(e,t,n){var r=Upfront.Behaviors.GridEditor,i=r.get_wrap_els(e),s=_.min(_.reject(i,function(e){return t?_.find(t,function(t){return t.$el.get(0)==e.$el.get(0)}):!1}),function(e){return n?e.grid.top:e.grid.left});return _.isObject(s)?s:!1},get_wrap_el_max:function(e,t,n){var r=Upfront.Behaviors.GridEditor,i=r.get_wrap_els(e),s=_.max(_.reject(i,function(e){return t?_.find(t,function(t){return t.$el.get(0)==e.$el.get(0)}):!1}),function(e){return n?e.grid.bottom:e.grid.right});return _.isObject(s)?s:!1},get_el:function(e){var t=Upfront.Behaviors.GridEditor;return _.find(t.els,function(t){return e.get(0)==t.$el.get(0)})},get_wrap:function(e){var t=Upfront.Behaviors.GridEditor;return _.find(t.wraps,function(t){return e.get(0)==t.$el.get(0)})},get_region:function(e){var t=Upfront.Behaviors.GridEditor;return _.find(t.regions,function(t){return e.get(0)==t.$el.get(0)})},get_drop:function(e){var t=Upfront.Behaviors.GridEditor;return _.find(t.drops,function(t){return e.get(0)==t.$el.get(0)})},get_class_num:function(e,t){var n=_.isString(e)?e:e.attr("class"),r=new RegExp("\\b"+t+"(\\d+)"),i=n.match(r);return i&&i[1]?parseInt(i[1]):0},get_el_model:function(e){var t=Upfront.Application,n=Upfront.Behaviors.GridEditor,r=t.layout.get("regions"),i=e.attr("id"),s=function(e){if(!e)return!1;var t=e.get_by_element_id(i),n;return t?t:(e.find(function(e){if(e.get("modules"))return n=s(e.get("modules")),n?!0:!1;if(e.get("objects"))return n=o(e.get("objects")),n?!0:!1}),n)},o=function(e){if(!e)return!1;var t=e.get_by_element_id(i),n;return t?t:(e.find(function(e){if(e.get("objects"))return n=o(e.get("objects")),n?!0:!1}),n)},u;return r.find(function(e){return u=s(e.get("modules")),u?!0:!1}),u?u:!1},update_class:function(e,t,n){var r=Upfront.Settings.LayoutEditor.CurrentBreakpoint,i=new RegExp("\\b"+t+"\\d+"),s,o;!r||r.default?e.hasClass(t+n)||(e.attr("class").match(i)?e.attr("class",e.attr("class").replace(i,t+n)):e.addClass(t+n)):(s=e.parent(),o=Math.round(s.width()/this.col_size),t=="c"?e.css("width",n/o*100+"%"):t=="ml"?e.css("margin-left",n/o*100+"%"):t=="mt"&&e.css("margin-top",n*this.baseline+"px"))},update_margin_classes:function(e){this.time_start("fn update_margin_classes");var t=e.data("margin"),n=Upfront.Behaviors.GridEditor;t.current!=t.original&&(n.update_class(e,n.grid.left_margin_class,t.current.left),n.update_class(e,n.grid.top_margin_class,t.current.top)),this.time_end("fn update_margin_classes")},update_model_classes:function(e,t){this.time_start("fn update_model_classes");var n=Upfront.Settings.LayoutEditor.CurrentBreakpoint,r=this.get_el_model(e);r&&(!n||n.default)&&r.replace_class(t.join(" ")),this.time_end("fn update_model_classes")},update_model_breakpoint:function(e,t){var n=Upfront.Settings.LayoutEditor.CurrentBreakpoint,r=this.get_el_model(e),i;r&&n&&!n.default&&(i=Upfront.Util.clone(r.get_property_value_by_name("breakpoint")||{}),_.isObject(i[n.id])||(i[n.id]={}),i[n.id]=_.extend(i[n.id],t),i[n.id].edited=!0,r.set_property("breakpoint",i))},update_model_margin_classes:function(t,n){var r=Upfront.Settings.LayoutEditor.CurrentBreakpoint,i=Upfront.Behaviors.GridEditor;t.each(function(){var t=e(this),s=t.data("margin"),o,u,a,f;if(s&&(s.original.left!=s.current.left||s.original.top!=s.current.top)||n)a=s?s.current.top:0,f=s?s.current.left:0,!r||r.default?(o=[i.grid.left_margin_class+f,i.grid.top_margin_class+a],n&&(o=_.union(o,n)),i.update_model_classes(t,o)):(u={left:f,top:a},n&&_.each(n,function(e){var t=e.match(/^([A-Za-z])(\d+)$/);t&&t[1]==i.grid.class&&(u.col=parseInt(t[2]))}),i.update_model_breakpoint(t,u))})},adjust_els_right:function(e,t,n){this.time_start("fn adjust_els_right");var r=Upfront.Behaviors.GridEditor;_.each(e,function(e){var i=e.$el.data("margin"),s=e.grid.left>t?e.grid.left-t-1:i.current.left;i.current.left!=s&&(i.current.left=s,n&&r.update_margin_classes(e.$el),e.$el.data("margin",i))}),this.time_end("fn adjust_els_right")},adjust_affected_right:function(e,t,n,r,i){this.time_start("fn adjust_affected_right");var s=Upfront.Behaviors.GridEditor,o=s.get_wrap_el_max(e,n),u=o?r&&r>o.grid.right?r:o.grid.right:r?r:e.grid.left-1;t=_.reject(t,function(e){return n?_.find(n,function(t){return t.$el.get(0)==e.$el.get(0)}):!1}),s.adjust_els_right(t,u,i),r+1==s.containment.grid.left&&s.get_wrap_els(e).length==0&&e.$el.nextAll(".upfront-wrapper:eq(0)").data("clear","clear"),this.time_end("fn adjust_affected_right")},adjust_els_bottom:function(e,t,n){this.time_start("fn adjust_els_bottom");var r=Upfront.Behaviors.GridEditor;_.each(e,function(e){var i=e.$el.data("margin"),s=e.grid.top>t?e.grid.top-t-1:0;i.current.top!=s&&(i.current.top=s,n&&r.update_margin_classes(e.$el),e.$el.data("margin",i))}),this.time_end("fn adjust_els_bottom")},adjust_affected_bottom:function(e,t,n,r,i){this.time_start("fn adjust_affected_bottom");var s=Upfront.Behaviors.GridEditor,o=s.get_wrap_el_max(e,n,!0),u=o?r&&r>o.grid.bottom?r:o.grid.bottom:r?r:e.grid.bottom-1;t=_.reject(t,function(e){return n?_.find(n,function(t){return t.$el.get(0)==e.$el.get(0)}):!1}),s.adjust_els_bottom(t,u,i),this.time_end("fn adjust_affected_bottom")},normalize:function(t,n){this.time_start("fn normalize");var r=Upfront.Application,i=Upfront.Behaviors.GridEditor,s=Upfront.Settings.LayoutEditor.CurrentBreakpoint,o=r.layout.get("regions"),u=[],a=[],f=[],l=[],c=s&&!s.default;n=_.filter(n,function(e){return e.$el.is(":visible")||e.height>0}),_.each(n,function(t){var r=t.$el.find(i.module_selector_direct+", "+i.object_selector_direct),h=i.get_region(t.$el.closest(".upfront-region")),p=t.$el.closest(".upfront-objects_container").length==0?t.$el.closest(".upfront-module-group"):!1,d=p!==!1&&p.length>0,v=d?i.get_el(p):!1,m=d?!1:t.$el.closest(".upfront-object-group"),g=m!==!1&&m.length>0,y=g?i.get_el(m):!1,b=c?t.$el.data("breakpoint_order"):t.$el.index(".upfront-wrapper"),w=!1,E=!1,S=!1,x=!1;r.each(function(t){if(this.offsetWidth<=0)return;var n=i.get_el(e(this)),r=!s||s.default?i.get_class_num(n.$el,i.grid.class):n.$el.data("breakpoint_col");n.col<r&&n.col>0&&i.update_model_margin_classes(n.$el,[i.grid.class+n.col])}),r.each(function(r){var s=i.get_el(e(this)),v=i.get_affected_els(s,n,[],!1),y=s.$el.data("margin");if(r==0&&(v.left.length>0||v.right.length>0)){var T=_.max(_.union(v.left,v.right),function(e){return e.outer_grid.bottom});if(T.outer_grid.bottom<s.grid.top){var N=i.get_el_model(s.$el),C=N.collection,k=C.indexOf(N),L=_.max(_.union(v.left,v.right),function(e){return e.outer_grid.left}),A=c?L.$el.data("breakpoint_order"):L.$el.index(".upfront-wrapper"),O=_.last(i.get_wrap_els(L)),M=i.get_el_model(O.$el),D=C.indexOf(M),P=s.grid.top-T.outer_grid.bottom;E=s.grid.top-P+1,S=h.grid.left,w=!0,s.outer_grid.top=E;if(!c&&D>k||c&&A>b)if(!c)x=D,t.$el.insertAfter(L.$el),l.push({collection:C,model:N,index:x});else{var H=d?i.get_el_model(p).get("wrappers"):o.get_by_name(s.region).get("wrappers"),B=t.$el.parent().find("> .upfront-wrapper").each(Upfront.Util.normalize_sort_elements_cb).sort(Upfront.Util.sort_elements_cb),j=!1;B.each(function(n){var r=H.get_by_wrapper_id(e(this).attr("id"));this==t.$el.get(0)?(j=!0,r.set_breakpoint_property("order",A)):(r.set_breakpoint_property("order",n-1),this==L.$el.get(0)&&(j=!1))})}d?a.push(p):g?f.push(m):u.push(s.region)}}else if(w&&!c&&x!==!1){var N=i.get_el_model(s.$el),C=N.collection;l.push({collection:C,model:N,index:x})}}),w&&(t.outer_grid.top=E,t.grid.top=E,t.outer_grid.left=S,t.$el.data("clear","clear"));if(c)return;r.size()>1&&r.each(function(){var r=i.get_el(e(this)),s=i.get_affected_els(t,n,[],!1);if(s.left.length==0&&s.right.length==0){var o=i.get_el_model(r.$el),l=g?Upfront.data.object_views[o.cid]:Upfront.data.module_views[o.cid],c=d&&l.group_view?l.group_view:g&&l.object_group_view?l.object_group_view:l.region_view,b=d&&v?v:g&&y?y:h,w=c.model.get("wrappers"),E=Upfront.Util.get_unique_id("wrapper"),S=new Upfront.Models.Wrapper({name:"",properties:[{name:"wrapper_id",value:E},{name:"class",value:i.grid.class+(r.grid.left+r.col-b.grid.left)}]}),x=new Upfront.Views.Wrapper({model:S});w.add(S),S.add_class("clr"),x.parent_view=l.parent_view,x.render(),r.$el.closest(".upfront-wrapper").before(x.$el),x.$el.append(l.$el),o.set_property("wrapper_id",E,!0),Upfront.data.wrapper_views[S.cid]=x,i.init_margin(r),d?a.push(p):g?f.push(m):u.push(r.region)}})}),_.each(n,function(e){var t=i.get_region(e.$el.closest(".upfront-region"));if(!t)return;!c&&e.outer_grid.left==t.grid.left&&!e.$el.hasClass("clr")&&e.$el.addClass("clr")}),_.each(_.uniq(u),function(e){var t=o.get_by_name(e),n=Upfront.data.region_views[t.cid];i.update_wrappers(t,n.$el)}),_.each(_.uniq(a),function(e){var t=i.get_el_model(e),n=Upfront.data.module_views[t.cid];i.update_wrappers(t,n.$el)}),_.each(_.uniq(f),function(e){var t=i.get_el_model(e),n=Upfront.data.object_views[t.cid];i.update_wrappers(t,n.$el)}),c||_.each(l,function(e){e.collection.remove(e.model,{silent:!0}),e.model.add_to(e.collection,e.index)}),_.each(n,function(e){e.$el.removeData("clear")}),this.time_end("fn normalize")},init:function(){var t=Upfront.Application,n=Upfront.Behaviors.GridEditor,r=e(Upfront.Settings.LayoutEditor.Selectors.main),i=r.offset(),s=r.find(".upfront-layout");n.baseline=Upfront.Settings.LayoutEditor.Grid.baseline,n.grid=Upfront.Settings.LayoutEditor.Grid,n.col_size=n.grid.column_width,n.max_row=Math.floor(e(window).height()*.5/n.baseline),n.main={$el:r,top:i.top,bottom:i.top+r.outerHeight(),left:i.left,right:i.left+r.outerWidth()};var o=15;e(document).on("scroll",function(e){if(n.resizing===!1||n.resizing==window.scrollY)return;window.scrollY>n.resizing?n.resizing+=o:n.resizing-=o,window.scrollTo(window.scrollX,n.resizing)})},start:function(e,t,n){this.time_start("fn start");var r=Upfront.Application,i=Upfront.Behaviors.GridEditor,s=i.main.$el.offset(),o=i.main.$el.find(".upfront-layout"),u=o.offset(),a=e.$el.find(".upfront-editable_entity").eq(0).is(".upfront-object"),f=n||e.$el.closest(".upfront-editable_entities_container"),l=f.offset();i.col_size=i.grid.column_width,i.el_selector=a?i.object_selector:i.module_selector,i.el_selector_direct=a?i.object_selector_direct:i.module_selector_direct,i.main.top=s.top,i.main.bottom=s.top+i.main.$el.outerHeight(),i.main.left=s.left,i.main.right=s.left+i.main.$el.outerWidth();var c=u.left+(o.outerWidth()-i.grid.size*i.col_size)/2;i.grid_layout={top:u.top,bottom:u.top+o.outerHeight(),left:c,right:c+i.grid.size*i.col_size,layout_left:u.left,layout_right:u.left+o.outerWidth()};var h=f.outerWidth(),p=f.outerHeight(),d=Math.round(h/i.col_size),v=Math.round(p/i.baseline),m=i.get_grid(l.left,l.top);i.containment={$el:f,top:l.top,bottom:l.top+p,left:l.left,right:l.left+h,col:d,grid:{top:m.y,bottom:m.y+v-1,left:m.x,right:m.x+d-1}},i.update_position_data(f),this.time_end("fn start")},update_position_data:function(e,t){this.time_start("fn update_position_data");var n=Upfront.Application,r=Upfront.Behaviors.GridEditor,i=r.main.$el.find(".upfront-layout"),s=r.el_selector==r.object_selector,o=!1,u=e.find("> .upfront-wrapper"),a=i.find(".upfront-region").not(".upfront-region-locked"),f=e.closest(".upfront-region"),l=f.data("name"),c=e.closest(".upfront-module-group"),h=c.length>0?c.attr("id"):!1;l!=="shadow"?(u=u.filter(":visible"),o=u.find(r.el_selector_direct)):o=e.find("> .upfront-module-view > .upfront-module"),r.els=_.map(o,r.get_position),_.each(r.els,function(e){e.region=l,e.group=h,r.init_margin(e)}),r.wraps=_.map(u,r.get_position),_.each(r.wraps,function(e){e.region=l,e.group=h}),!1!==t&&(r.regions=_.map(a,r.get_region_position),_.each(r.regions,function(e){e.region=e.$el.closest(".upfront-region").data("name"),e.group=!1})),this.time_end("fn update_position_data")},update_wrappers:function(t,n){this.time_start("fn update_wrappers");var r=Upfront.Application,i=Upfront.Behaviors.GridEditor,s=Upfront.Settings.LayoutEditor.CurrentBreakpoint,o=i.el_selector==i.object_selector,u=e(Upfront.Settings.LayoutEditor.Selectors.main),a=u.find(".upfront-layout"),f=t.get("wrappers");(n?n:a).find(".upfront-wrapper:visible").each(function(){var t=e(this),n=t.attr("id"),r=f.get_by_wrapper_id(n),o=t.data("clear"),u=_.map(t.find(i.el_selector_direct),function(t){var n=e(t);return!n||!n.length?!1:n}).filter(function(e){return e!==!1});if(u.length==0){r&&f.remove(r);return}if(t.hasClass("upfront-wrapper-preview"))return;if(t.height()<=0)return;if(!r)return;var a=!s||s.default?i.get_class_num(t,i.grid.class):t.data("breakpoint_col"),l=_.map(u,function(e){return{$el:e,col:!s||s.default?i.get_class_num(e,i.grid.class):e.data("breakpoint_col")}}),c=_.max(l,function(e){if(!e)return;return e.col}),h=c.col,p,d;i.update_class(t,i.grid.class,h),!s||s.default?(a!=h&&r.replace_class(i.grid.class+h),o&&o=="clear"||!o&&t.hasClass("clr")?r.add_class("clr"):r.remove_class("clr")):(p=Upfront.Util.clone(r.get_property_value_by_name("breakpoint")||{}),_.isObject(p[s.id])||(p[s.id]={}),p[s.id].col=h,o&&(p[s.id].clear=o=="clear"),r.set_property("breakpoint",p))}),f.each(function(t){e("#"+t.get_wrapper_id()).size()==0&&f.remove(t)}),Upfront.Events.trigger("entity:wrappers:update",t),this.time_end("fn update_wrappers")},create_resizable:function(t,n){var r=this,i=Upfront.Behaviors.GridEditor,s=t.$el.hasClass("upfront-module-group"),o=t.$el.hasClass("upfront-object-view"),u=s?t.$el:t.$el.find(">.upfront-editable_entity"),a=typeof t.group_view!="undefined",f=e(Upfront.Settings.LayoutEditor.Selectors.main),l=f.find(".upfront-layout"),c,h,p;if(Upfront.Application.mode.current!==Upfront.Application.MODE.THEME&&n.get_property_value_by_name("disable_resize"))return!1;if(u.hasClass("upfront-module-spacer")||u.hasClass("upfront-object-spacer"))return!1;if(o&&typeof t.object_group_view=="undefined")return!1;if(u.data("ui-resizable"))return u.resizable("option","disabled",!1),!1;u.append('<span class="upfront-icon-control upfront-icon-control-resize-s upfront-resize-handle-s ui-resizable-handle ui-resizable-s"></span>'),u.resizable({containment:"document",autoHide:!1,delay:50,handles:{s:".upfront-resize-handle-s"},start:function(r,s){i.start(t,n),i.resizing=window.scrollY;var o=i.get_el(u),a=u.data("margin"),f=e(this).data("ui-resizable");p=f.axis?f.axis:"se",h=e('<div class="upfront-resize-placeholder"></div>'),h.css({marginLeft:a.original.left/(o.col+a.original.left)*100+"%",marginTop:a.original.top*i.baseline,width:o.col/(o.col+a.original.left)*100+"%",height:s.originalSize.height}),c=e('<div class="upfront-resize" style="height:'+o.height+'px;"></div>'),c.css({height:o.height,width:o.width,minWidth:o.width,maxWidth:o.width,position:"absolute"}),p=="nw"?c.css({top:o.position.top,right:e("body").width()-o.position.right}):c.css({top:o.position.top,left:o.position.left}),e("body").append(c),_.each(i.els,function(e,t){i.els[t]=i.get_position(e.$el)}),_.each(i.wraps,function(e,t){i.wraps[t]=i.get_position(e.$el)}),i.normalize(i.els,i.wraps),i.update_position_data(i.containment.$el);var l=u.position(),d={left:l.left+a.original.left*i.col_size,top:l.top+a.original.top*i.baseline};u.css({marginLeft:0,marginTop:0,position:"absolute",left:d.left,top:d.top,minHeight:""}),f.originalPosition.left=d.left,f.originalPosition.top=d.top,f._updateCache({left:d.left,top:d.top}),h.insertBefore(u),t.trigger("entity:resize_start",{row:o.row,col:o.col,height:o.height,width:o.width},t,t.model),Upfront.Events.trigger("entity:resize_start",t,t.model)},resize:function(n,r){var s=u.closest(".upfront-wrapper"),o=u.closest(".upfront-region"),a=i.get_el(u),f=i.get_wrap(s),l=i.get_region(o),d=o.hasClass("upfront-region-expand-lock"),v=a.col,m=f?i.get_affected_wrapper_els(f,i.wraps,[],!0):i.get_affected_els(a,i.els,[],!0),g=i.get_move_limit(m,i.containment),y=v+(p=="nw"?a.grid.left-g[0]:g[1]-a.grid.right),b=m.bottom.length?_.min(m.bottom,function(e){return e.grid.top}):!1,w=b?b.grid.top-a.grid.top:l.grid.bottom-a.grid.top+1,E=Math.ceil(r.size.width/i.col_size),S=E>y?Math.round(y*i.col_size):r.size.width,x=(r.size.height>15?r.size.height:0)||r.originalSize.height,T=Math.ceil(x/i.baseline),N=E>y?y:E,C=d&&T>w&&w>0?w:T;Math.abs(e(window).height()-n.clientY)<50&&(x+=i.baseline*10,e(window).scrollTop(e(window).scrollTop()+i.baseline*10)),u.css({height:C*i.baseline,width:S,minWidth:S,maxWidth:S}),u.data("resize-col",N),u.data("resize-row",C),c.css({height:C*i.baseline,width:N*i.col_size,minWidth:N*i.col_size,maxWidth:N*i.col_size}),p=="nw"&&c.css({top:a.$el.find(">.upfront-resize-handle-nw").offset().top,marginTop:a.$el.find(">.upfront-resize-handle-se").offset().top+a.$el.find(">.upfront-resize-handle-se").height()-a.$el.find(">.upfront-resize-handle-nw").offset().top-C*i.baseline}),!d&&p!="nw"&&h.css("height",C*i.baseline),t.update_size_hint(N*i.col_size,C*i.baseline),t.trigger("entity:resizing",{row:C,col:N,height:C*i.baseline,width:N*i.col_size},t,t.model)},stop:function(e,f){Upfront.Events.trigger("entity:pre_resize_stop",t,t.model,f);var l=Upfront.Settings.LayoutEditor.CurrentBreakpoint,p=u.closest(".upfront-wrapper"),d=u.closest(".upfront-region"),v=i.get_el(u),m=u.data("margin"),g=i.get_wrap(p),y=d.hasClass("upfront-region-expand-lock"),b=g?i.get_affected_wrapper_els(g,i.wraps,[],!0):i.get_affected_els(v,i.els,[],!0),w=i.get_move_limit(b,i.containment),E=Math.ceil(f.originalSize.width/i.col_size),S=Math.ceil(f.originalSize.height/i.baseline),x=u.data("resize-col"),T=u.data("resize-row"),N=r.layout.get("regions"),C=N.get_by_name(d.data("name")),k=o?i.containment.$el:a?t.group_view.$el.find(".upfront-editable_entities_container:first"):d.find(".upfront-modules_container > .upfront-editable_entities_container:first"),L=o?".upfront-wrapper > .upfront-object-view > .upfront-object":".upfront-wrapper > .upfront-module-view > .upfront-module, .upfront-wrapper > .upfront-module-group",A,O,M,D;if(!o&&!s){var P=n.get("objects"),H=P.first();M=H.get_breakpoint_property_value("top_padding_use")?H.get_breakpoint_property_value("top_padding_num")/i.baseline:0,D=H.get_breakpoint_property_value("bottom_padding_use")?H.get_breakpoint_property_value("bottom_padding_num")/i.baseline:0}else M=n.get_breakpoint_property_value("top_padding_use")?n.get_breakpoint_property_value("top_padding_num")/i.baseline:0,D=n.get_breakpoint_property_value("bottom_padding_use")?n.get_breakpoint_property_value("bottom_padding_num")/i.baseline:0;T=T-M-D,i.resizing=!1,h.remove(),c.remove(),u.css({width:"",minWidth:"",maxWidth:"",height:"",position:"",top:"",left:"",marginLeft:"",marginTop:""});if(!l||l.default){n.set_property("row",T);var P=n.get("objects");P&&P.length==1&&P.each(function(e){e.set_property("row",T)})}else{A=Upfront.Util.clone(n.get_property_value_by_name("breakpoint")||{}),_.isObject(A[l.id])||(A[l.id]={}),O=A[l.id],O.edited=!0,O.row=T,n.set_property("breakpoint",A);var P=n.get("objects");P&&P.length==1&&P.each(function(e){var t=Upfront.Util.clone(e.get_property_value_by_name("breakpoint")||{});_.isObject(t[l.id])||(t[l.id]={}),t[l.id].row=T,e.set_property("breakpoint",t)})}i.update_position_data(i.containment.$el),i.normalize(i.els,i.wraps),u.removeData("resize-col"),u.removeData("resize-row"),t.trigger("entity:resize_stop",{row:T,col:x,height:T*i.baseline,width:x*i.col_size},t,t.model),Upfront.Events.trigger("entity:resize_stop",t,t.model,f),Upfront.Events.trigger("entity:resized",t,t.model)}})},toggle_resizables:function(t){e(".upfront-editable_entity.ui-resizable").resizable("option","disabled",!t)},resize:function(t,n,r,i,s,o){var u=Upfront.Application,a=Upfront.Behaviors.GridEditor,s=/all|nw|se/.test(s)?s:"all",f=e(Upfront.Settings.LayoutEditor.Selectors.main),l=f.find(".upfront-layout");a.start(t,n);var c=t.$el.find(".upfront-editable_entity:first"),h=c.find(".upfront-editable_entity"),p=c.closest(".upfront-wrapper"),d=c.closest(".upfront-region"),v=c.data("margin"),m=a.get_el(c),g=a.get_wrap(p),y=a.get_region(d),b=d.hasClass("upfront-region-expand-lock"),w=g?a.get_affected_wrapper_els(g,a.wraps,[],!0):a.get_affected_els(m,a.els,[],!0),E=a.get_max_size(m,a.els,y,s),S=typeof t.group_view!="undefined",x=S?t.group_view.model:!1,T=u.layout.get("regions"),N=T.get_by_name(d.data("name")),C=(S?x:N).get("wrappers"),k=C.get_by_wrapper_id(p.attr("id")),L=Upfront.data.wrapper_views[k.cid];if(r<1||i<1)return!1;if(!o){c.css("min-height",""),h.css("min-height","");var A=Math.ceil(c.outerHeight()/a.baseline);i=i>A?i:A,c.css("min-height",i*a.baseline),h.css("min-height",(i-2)*a.baseline)}r=r?r>E.col?E.col:r:m.col,i=i?E.row&&i>E.row?E.row:i:m.row,a.normalize(a.els,a.wraps),a.update_position_data(a.containment.$el),a.update_class(c,a.grid.class,r),n.set_property("row",i);var O=n.get("objects");return O&&O.length==1&&O.each(function(e){e.set_property("row",i)}),s!="se"?n.replace_class([a.grid.class+r].join(" ")):n.replace_class(a.grid.class+r),typeof t.group_view!="undefined"?a.update_wrappers(t.group_view.model,t.group_view.$el):a.update_wrappers(N,y.$el),t.trigger("entity:resize_stop",{row:i,col:r},t,t.model),Upfront.Events.trigger("entity:resized",t,t.model),!0},create_wrapper_resizable:function(t,n){var r=this,i=Upfront.Behaviors.GridEditor,s=t.$el,o=e(Upfront.Settings.LayoutEditor.Selectors.main),u=o.find(".upfront-layout"),a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,D;if(Upfront.Application.mode.current!==Upfront.Application.MODE.THEME&&n.get_property_value_by_name("disable_resize"))return!1;if(s.data("ui-resizable"))return s.resizable("option","disabled",!1),!1;s.resizable({containment:"document",autoHide:!1,delay:50,handles:{w:".upfront-resize-handle-wrapper-w",e:".upfront-resize-handle-wrapper-e"},start:function(r,o){i.time_start("fn wrapper_resize_start"),i.start(t,n),i.resizing=window.scrollY,f=Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),c=!_.isUndefined(t.parent_view.object_group_view),c?(p=t.parent_view.object_group_view,d=i.get_position(p.$el)):(h=!_.isUndefined(t.parent_view.group_view),p=h?t.parent_view.group_view:t.parent_view.region_view,d=h?i.get_position(p.$el):i.get_region(p.$el));var u=i.get_wrap(s),l=e(this).data("ui-resizable"),P=Upfront.Util.find_sorted(s.parent(),"> .upfront-wrapper"),H=i.get_affected_els(u,i.wraps,[],!0),B=p.model.get("wrappers"),j=c?p.model.get("objects"):p.model.get("modules"),F=i.parse_modules_to_lines(j,B,f.id,d.col),I;a=s.closest(".upfront-region"),N=l.axis?l.axis:"e",b=!1,I=!1,w=!1,E=!1,T=!1,v=s.find("> .upfront-module-group").length>0,L=u.col,C=i.min_col,k=i.min_col,_.each(F,function(e){_.each(e.wrappers,function(t,r){var s=!1;if(t.model!=n)return;M=r===0,D=r===e.wrappers.length-1,x=t.spacer,!M&&N=="w"?s=e.wrappers[r-1]:!D&&N=="e"&&(s=e.wrappers[r+1]),s!==!1&&(w=s.model,E=Upfront.data.wrapper_views[w.cid],b=E.$el,I=i.get_wrap(b),T=s.spacer)})}),A=[],s.find(i.el_selector_direct).each(function(){var t=i.get_el_model(e(this)),n=c?Upfront.data.object_views[t.cid]:Upfront.data.module_views[t.cid];if(!n)return;A.push({view:n,is_group:c?!1:e(this).hasClass("upfront-module-group"),el:i.get_el(e(this))})}),v&&_.each(A,function(e){if(!e.is_group)return;var t=i.get_group_min_col(e.view);C=t>C?t:C}),g=e('<div class="upfront-resize" style="height:'+u.height+'px;"></div>'),g.css({height:u.height,width:u.width,minWidth:u.width,maxWidth:u.width,position:"absolute"}),N=="w"?g.css({top:u.position.top,right:e("body").width()-u.position.right}):g.css({top:u.position.top,left:u.position.left}),e("body").append(g),O=[],b&&b.length&&(m=b.find("> .upfront-module-group").length>0,b.find(i.el_selector_direct).each(function(){var t=i.get_el_model(e(this)),n=c?Upfront.data.object_views[t.cid]:Upfront.data.module_views[t.cid];if(!n)return;O.push({view:n,is_group:c?!1:e(this).hasClass("upfront-module-group"),el:i.get_el(e(this))})}),m&&_.each(O,function(e){if(!e.is_group)return;var t=i.get_group_min_col(e.view);k=t>k?t:k}),L=u.col+I.col,!x&&!T?L-=k:x&&(L-=k,C=0),T&&(k=0)),y=e('<div class="upfront-resize-placeholder"></div>'),y.css({width:(I?I.col+u.col:u.col)/d.col*100+"%",height:o.originalSize.height,position:"relative"}),f&&!f.default&&y.css("order",s.css("order"));if(x||T)S=e('<div class="upfront-spacer-feed"></div>'),S.css({width:i.col_size,height:"auto",top:0,bottom:0,position:"absolute"}),y.append(S);_.each(i.els,function(e,t){i.els[t]=i.get_position(e.$el)}),_.each(i.wraps,function(e,t){i.wraps[t]=i.get_position(e.$el)}),i.normalize(i.els,i.wraps),i.update_position_data(i.containment.$el);var q=s.position(),R=b?b.position():!1;s.css({marginLeft:0,marginTop:0,position:"absolute",left:q.left,top:q.top,minHeight:""}),b&&b.css({marginLeft:0,marginTop:0,position:"absolute",top:R.top,left:R.left}),l.originalPosition.left=q.left,l.originalPosition.top=q.top,l._updateCache({left:q.left,top:q.top}),y.insertBefore(s),_.each(A,function(e){e.view.trigger("entity:resize_start",{row:e.el.row,col:e.el.col,height:e.el.height,width:e.el.width},e.view,e.view.model)}),_.each(O,function(e){e.view.trigger("entity:resize_start",{row:e.el.row,col:e.el.col,height:e.el.height,width:e.el.width},e.view,e.view.model)}),t.trigger("entity:wrapper:resize_start",{row:u.row,col:u.col,height:u.height,width:u.width},t,t.model),E&&E.trigger("entity:wrapper:resize_start",{row:I.row,col:I.col,height:I.height,width:I.width},E,E.model),Upfront.Events.trigger("entity:wrapper:resize_start",t,t.model,E,E.model),i.time_end("fn wrapper_resize_start")},resize:function(e,n){i.time_start("fn wrapper_resize_resizing");var r=i.get_wrap(s),o=b?i.get_wrap(b):!1,u=i.get_region(a),f=C*i.col_size,l=c>L?Math.round(L*i.col_size):f>n.size.width?f:n.size.width,c=Math.round(l/i.col_size),h=(n.size.height>15?n.size.height:0)||n.originalSize.height,p=N=="w"?n.originalPosition.left+n.originalSize.width-l:n.position.left,d=c>L?L:c,v=L-d+k,m=(L+k)*i.col_size-l;s.css({left:p,height:h,width:l,minWidth:l,maxWidth:l}),s.data("resize-col",d);if(x&&l<i.col_size){var y=.5*Math.round((i.col_size-l)/i.col_size*100)/100;S.css({left:N=="e"?0:"auto",right:N=="e"?"auto":0,backgroundColor:"rgba(200, 0, 0, "+y+")"})}if(b){b.css({width:m,minWidth:m,maxWidth:m}),N=="e"&&b.css("margin-left",o.width-m),b.data("resize-col",v);if(T&&m<i.col_size){var y=.5*Math.round((i.col_size-m)/i.col_size*100)/100;S.css({left:N=="w"?0:"auto",right:N=="w"?"auto":0,backgroundColor:"rgba(200, 0, 0, "+y+")"})}}g.css({height:h,width:d*i.col_size,minWidth:d*i.col_size,maxWidth:d*i.col_size}),_.each(A,function(e){e.view.trigger("entity:resizing",{row:e.el.row,col:d,height:e.el.height,width:d*i.col_size},e.view,e.view.model)}),_.each(O,function(e){e.view.trigger("entity:resizing",{row:e.el.row,col:v,height:e.el.height,width:v*i.col_size},e.view,e.view.model)}),t.trigger("entity:wrapper:resizing",{row:r.row,col:d,height:r.height,width:d*i.col_size},t,t.model),E&&E.trigger("entity:wrapper:resizing",{row:o.row,col:v,height:o.height,width:v*i.col_size},E,E.model),i.time_end("fn wrapper_resize_resizing")},stop:function(e,o){i.time_start("fn wrapper_resize_stop"),Upfront.Events.trigger("entity:wrapper:pre_resize_stop",t,t.model,o);var u=i.get_wrap(s),l=b?i.get_wrap(b):!1,h=Math.ceil(o.originalSize.width/i.col_size),d=s.data("resize-col"),v=b?b.data("resize-col"):0,m=r.layout.get("regions"),S=m.get_by_name(a.data("name")),C=N=="w"&&M,k=N=="e"&&D;i.resizing=!1,y.remove(),g.remove(),s.css({width:"",minWidth:"",maxWidth:"",height:"",position:"",top:"",left:"",marginLeft:"",marginTop:""}),b&&b.css({width:"",minWidth:"",maxWidth:"",height:"",position:"",top:"",left:"",marginLeft:"",marginTop:""}),!w&&(C||k)&&L-d>0?t.add_spacer(C?"left":"right",L-d,L,c):(d>0?f&&!f.default?(n.set_breakpoint_property("edited",!0,!0),n.set_breakpoint_property("col",d),_.each(A,function(e){e.view.model.set_breakpoint_property("edited",!0,!0),e.view.model.set_breakpoint_property("col",d)})):(n.replace_class(i.grid.class+d),_.each(A,function(e){e.view.model.replace_class(i.grid.class+d)})):x&&(n.collection.remove(n),_.each(A,function(e){e.view.model.collection.remove(e.view.model)})),w&&(v>0?f&&!f.default?(w.set_breakpoint_property("edited",!0,!0),w.set_breakpoint_property("col",v),_.each(O,function(e){e.view.model.set_breakpoint_property("edited",!0,!0),e.view.model.set_breakpoint_property("col",v)})):(w.replace_class(i.grid.class+v),_.each(O,function(e){e.view.model.replace_class(i.grid.class+v)})):T&&(w.collection.remove(w),_.each(O,function(e){e.view.model.collection.remove(e.view.model)})))),c?p.model.get("objects").each(function(e){e.set_breakpoint_property("edited",!0,!0)}):p.model.get("modules").each(function(e){e.set_breakpoint_property("edited",!0,!0)}),p.model.get("wrappers").each(function(e){e.set_breakpoint_property("edited",!0,!0)}),i.update_position_data(i.containment.$el),i.normalize(i.els,i.wraps),s.removeData("resize-col"),b&&b.removeData("resize-col"),_.each(A,function(e){e.view.trigger("entity:resize_stop",{row:e.el.row,col:d,height:e.el.height,width:d*i.col_size},e.view,e.view.model)}),_.each(O,function(e){e.view.trigger("entity:resize_stop",{row:e.el.row,col:v,height:e.el.height,width:v*i.col_size},e.view,e.view.model)}),t.trigger("entity:wrapper:resize_stop",{row:u.row,col:d,height:u.height,width:d*i.col_size},t,t.model),t.trigger("entity:wrapper:resize",{col:d},t,t.model),E&&(E.trigger("entity:wrapper:resize_stop",{row:l.row,col:v,height:l.height,width:d*i.col_size},E,E.model),E.trigger("entity:wrapper:resize",{col:v},E,E.model)),Upfront.Events.trigger("entity:wrapper:resize_stop",t,t.model,E,E.model,o),Upfront.Events.trigger("entity:wrapper:resized",t,t.model,E,E.model),i.time_end("fn wrapper_resize_stop")}})},get_group_min_col:function(e){var t=Upfront.Settings.LayoutEditor.CurrentBreakpoint,n=Upfront.Behaviors.GridEditor,r=e.model.get("modules"),i=e.model.get("wrappers"),s=!t||t.default?n.get_class_num(e.$el,n.grid.class):e.$el.data("breakpoint_col"),o=n.parse_modules_to_lines(r,i,t?t.id:"desktop",s),u=n.min_col;return _.each(o,function(e){var t=0;_.each(e.wrappers,function(e){e.spacer?t+=1:t+=n.min_col}),t>u&&(u=t)}),u},create_draggable:function(e,n){var r=Upfront.Behaviors.GridEditor;r.drag_instances[e.cid]?r.drag_instances[e.cid].setup():(r.drag_instances[e.cid]=new t(e,n),n.on("remove",function(){delete r.drag_instances[e.cid]}))},toggle_draggables:function(t){e(".upfront-editable_entity.ui-draggable").draggable("option","disabled",!t)},parse_modules_to_lines:function(e,t,n,r){var i=Upfront.Behaviors.GridEditor,s={},o=[],u=[],a=0,f=0;return e.each(function(e,o){var u=e.get_wrapper_id(),a=t.get_by_wrapper_id(u),f=a?a.get_property_value_by_name("breakpoint"):!1,l=f&&n in f?f[n]:{},c=a?a.get_property_value_by_name("class"):"",h=i.get_class_num(c,i.grid.class),p=!!c.match(/clr/),d=e.get_property_value_by_name("breakpoint"),v=d&&n in d?d[n]:{},m=e.get_property_value_by_name("default_hide"),g=e.get_property_value_by_name("hide"),y=e.get_property_value_by_name("class"),b=i.get_class_num(y,i.grid.class),w=!!y.match(/(upfront-module-spacer|upfront-object-spacer)/),E=o,S=o,x={};if(!a)return;n!="desktop"&&(g="hide"in v?v.hide:m,b="col"in v?parseInt(v.col,10):b,E="order"in v?parseInt(v.order,10)*1e4+E:E,h="col"in l?parseInt(l.col,10):h,S="order"in l?parseInt(l.order,10)*1e4+S:S,p="clear"in l?l.clear:p),g===!1&&(g=m);if(g&&w)return;x={model:e,col:b,order:E,spacer:w,hide:g},b>h&&(h=b),h>r&&(h=r),u in s?(s[u].modules.push(x),s[u].col=h):s[u]={model:a,modules:[x],order:S,col:h,clear:p,spacer:w}}),o=_.sortBy(s,function(e,t){return e.order}),_.each(o,function(e,t){if(t>0&&e.clear||a>0&&a+e.col>r)u[f].col=a,f++,a=0;_.isUndefined(u[f])&&(u[f]={wrappers:[],col:0}),a+=e.col,u[f].wrappers.push(e),u[f].col=a}),u},get_container_col:function(e,t){var n=Upfront.Behaviors.GridEditor,r=!_.isUndefined(e.group_view),i=!_.isUndefined(e.object_group_view),s=(r?e.group_view:i?e.object_group_view.parent_module_view:e.region_view).model.get_property_value_by_name("breakpoint"),o=s&&t.id in s?s[t.id]:{},u=i?e.object_group_view.parent_module_view.$el.find("> .upfront-module"):(r?e.group_view:e.region_view).$el,a=t.default?n.get_class_num(u,n.grid.class):_.isNumber(o.col)?o.col:t.columns;return a>t.columns?t.columns:a},normalize_module_remove:function(e,t,n,r,i){var s=Upfront.Application,o=Upfront.Behaviors.GridEditor,u=n.indexOf(t),a=Upfront.Views.breakpoints_storage.get_breakpoints().get_enabled(),f=!_.isUndefined(e.group_view),l=!_.isUndefined(e.object_group_view);_.each(a,function(r){var s=r.toJSON(),u=o.get_container_col(e,s),a=o.parse_modules_to_lines(n,i,s.id,u),f=!1,l=!1,c=[],h=[],p,d,v,m,g,y;_.each(a,function(e){if(p)return;v=!1,m=!1,_.each(e.wrappers,function(n){d&&!m&&(m=n),_.each(n.modules,function(r){t==r.model&&(d=n,p=e)}),d||(v=n)})});if(!p)return;m&&(y=m.model.get_property_value_by_name("class"),y.match(/clr/g)||(l=!0)),v&&(g=v.model.get_property_value_by_name("class"),g.match(/clr/g)&&!l&&(f=!0)),_.each(p.wrappers,function(e){if(e==d)return;c.push(e),e.spacer&&h.push(e)}),c.length>=2&&(l=!1);if(d.modules.length==1){var b=u,w=0,E=0;_.each(h,function(e){b-=e.col}),c.length==h.length?_.each(c,function(e,t){_.each(e.modules,function(e){n.remove(e.model)}),i.remove(e.model)}):(w=Math.floor(b/(c.length-h.length)),E=b-(c.length-h.length)*w,_.each(c,function(e,t){if(_.contains(h,e))return;var n=e.model.get_property_value_by_name("class"),r=e.model.get_property_value_by_name("breakpoint"),i=r&&s.id in r?r[s.id]:{},u=w;E>0&&(u+=1,E-=1),s.default?(e.model.replace_class(o.grid.class+u+(t==0&&!n.match(/clr/g)?" clr":"")),_.each(e.modules,function(e){e.model.replace_class(o.grid.class+u)})):(i.col=u,t==0&&!i.clear&&(i.clear=!0),e.model.set_property("breakpoint",Upfront.Util.clone(r)),_.each(e.modules,function(e){var t=e.model.get_property_value_by_name("breakpoint"),n=t&&s.id in t?t[s.id]:{};n.col=u,e.model.set_property("breakpoint",Upfront.Util.clone(t))}))}))}if(!s.default)return;if(f||l){var S=!1;_.each(f?v.modules:m.modules,function(e,t){var n=e.model.get_property_value_by_name("class"),r=o.get_class_num(n,o.grid.class),s=Upfront.data.module_views[e.model.cid],u=f?v:m,a=Upfront.data.wrapper_views[u.model.cid],l=S?Upfront.data.wrapper_views[S.cid]:a;if(t>0){var c=Upfront.Util.get_unique_id("wrapper");wrap_model=new Upfront.Models.Wrapper({name:"",properties:[{name:"wrapper_id",value:c},{name:"class",value:o.grid.class+r+" clr"}]}),wrap_view=new Upfront.Views.Wrapper({model:wrap_model}),i.add(wrap_model),wrap_view.parent_view=s.parent_view,wrap_view.render(),wrap_view.$el.append(s.$el),l.$el.after(wrap_view.$el),Upfront.data.wrapper_views[wrap_model.cid]=wrap_view,e.model.set_property("wrapper_id",c,!0),S=wrap_model}})}})},adapt_to_breakpoint:function(e,t,n,r,i){var s=Upfront.Application,o=Upfront.Behaviors.GridEditor,u=0,a=-1,f=[],l=[],c={},i=i===!0?!0:!1,h=0,p=0;e.each(function(e){var i=e.get_property_value_by_name("breakpoint")||{},s=e.get_property_value_by_name("class"),l=e.get_property_value_by_name("default_hide"),c=i[n]&&"hide"in i[n]?i[n].hide:l,h=o.get_class_num(s,o.grid.class),d=t.get_by_wrapper_id(e.get_wrapper_id()),v=d&&d.get_property_value_by_name("breakpoint")||{},m=d&&d.get_property_value_by_name("class"),g=d&&(!!m.match(/clr/)||u===0);if(!d)return;if(v&&v[n]&&v[n].edited||i&&i[n]&&i[n].edited){p++;return}if(c)return;u+=h,u>r&&(g=!0),g&&(u=h,a++,f[a]=[]),h=h>r?r:h,f[a].push({clear:g,spacer:!!s.match(/(upfront-module-spacer|upfront-object-spacer)/),module:e,col:h,left:0,wrapper:d,breakpoint:Upfront.Util.clone(i),wrapper_breakpoint:Upfront.Util.clone(v)})}),_.each(f,function(e){var t=_.map(e,function(e){return e.col}).reduce(function(e,t){return e+t}),s=_.map(e,function(e){return e.spacer?e.col:0}).reduce(function(e,t){return e+t});_.each(e,function(s,o){var u=0,a=0;_.isObject(s.breakpoint[n])||(s.breakpoint[n]={edited:!1}),_.isObject(s.wrapper_breakpoint[n])||(s.wrapper_breakpoint[n]={edited:!1}),s.breakpoint[n].edited?u=typeof s.breakpoint[n].col=="number"?s.breakpoint[n].col:s.col:(u=t===r?s.col:r/e.length,s.wrapper_breakpoint[n].edited&&_.isNumber(s.wrapper_breakpoint[n].col)&&(u=u>s.wrapper_breakpoint[n].col?s.wrapper_breakpoint[n].col:u),s.breakpoint[n].left=0,s.breakpoint[n].col=u,s.breakpoint[n].order=o,s.module.set_property("breakpoint",s.breakpoint,i)),_.isUndefined(c[s.wrapper.get_wrapper_id()])?h++:a=c[s.wrapper.get_wrapper_id()],a<u&&(a=u,s.wrapper_breakpoint[n].col=a,c[s.wrapper.get_wrapper_id()]=a,s.wrapper_breakpoint[n].edited||(s.wrapper_breakpoint[n].order=p+h,s.wrapper_breakpoint[n].clear=o===0),s.wrapper.set_property("breakpoint",s.wrapper_breakpoint,i))})})},adapt_region_to_breakpoint:function(e,t,n,r){var i=Upfront.Application,s=Upfront.Behaviors.GridEditor,o=Upfront.Views.breakpoints_storage.get_breakpoints().get_default().toJSON();line_col=0,r=r===!0?!0:!1,e.each(function(e){var i=Upfront.Util.clone(e.get_property_value_by_name("breakpoint")||{}),s=e.get_property_value_by_name("col"),u=e.get("sub");_.isObject(i[t])||(i[t]={edited:!1}),i[t].edited||(e.is_main()||!u||u.match(/^(left|right)$/)?i[t].col=o.columns:u.match(/^lightbox$/)&&s>n&&(i[t].col=n)),e.set_property("breakpoint",i,r)})},create_region_resizable:function(t,n){var r=this,i=Upfront.Behaviors.GridEditor,s=t.$el,o=e(Upfront.Settings.LayoutEditor.Selectors.main),u=o.find(".upfront-layout"),a=n.collection,f=a.indexOf(n),l=a.size()-1,c=n.get("sub"),h=n.get("container"),p,d,v,m={},g=function(){var e={top:n.get_property_value_by_name("top"),left:n.get_property_value_by_name("left"),bottom:n.get_property_value_by_name("bottom"),right:n.get_property_value_by_name("right"),width:n.get_property_value_by_name("width"),height:n.get_property_value_by_name("height")};return e.is_top=typeof e.top=="number",e.is_left=typeof e.left=="number",e.is_bottom=typeof e.bottom=="number",e.is_right=typeof e.right=="number",e};if(s.data("ui-resizable"))return!1;if(!n.is_main()&&c&&!c.match(/^(fixed|left|right)$/))return;n.is_main()?(p=["s"],d={s:".upfront-region-resize-handle-s"}):c=="left"?(p=["e","s"],d={e:".upfront-region-resize-handle-e",s:".upfront-region-resize-handle-s"}):c=="right"?(p=["w","s"],d={w:".upfront-region-resize-handle-w",s:".upfront-region-resize-handle-s"}):c=="fixed"&&(m=g(),m.is_top&&m.is_left||m.is_bottom&&m.is_right?(p=["nw","se"],d={nw:".upfront-region-resize-handle-nw",se:".upfront-region-resize-handle-se"}):(p=["ne","sw"],d={ne:".upfront-region-resize-handle-ne",sw:".upfront-region-resize-handle-sw"})),_.each(p,function(e){var t=e.match(/^(e|w|s|n)$/)?"upfront-icon-control-region upfront-icon-control-region-resize upfront-icon-control-region-resize-"+e:"upfront-icon-control upfront-icon-control-resize upfront-icon-control-resize-"+e;s.append('<div class="'+t+" upfront-region-resize-handle upfront-region-resize-handle-"+e+" ui-resizable-handle ui-resizable-"+e+'"></div>')}),s.resizable({containment:"document",handles:d,helper:"region-resizable-helper",disabled:!0,zIndex:9999999,start:function(n,r){var o=i.get_class_num(s,i.grid.class),u=e(this).data("ui-resizable"),a=r.helper;v=u.axis?u.axis:"se",i.resizing=window.scrollY,e(this).resizable("option","minWidth",i.col_size*3);if(c!="fixed")e(this).resizable("option","maxWidth",i.col_size*10);else{e(this).resizable("option","minHeight",i.baseline*3),s.css("position",""),t.update_region_position(),m=g();var f=s.position();u.originalPosition.left=f.left,u.originalPosition.top=f.top,u.originalSize.width=m.width,u.originalSize.height=m.height,u._updateCache({left:f.left,top:f.top}),a.css({marginLeft:0,marginTop:0,left:f.left,top:f.top,position:"fixed"})}Upfront.Events.trigger("entity:region:resize_start",t,t.model)},resize:function(e,n){var r=n.helper;if(c!="fixed")if(v=="s"){var u=Math.abs(Math.ceil(n.size.height/i.baseline)),a=Math.round(u*i.baseline);r.css({height:a,width:n.originalSize.width,minWidth:n.originalSize.width,maxWidth:n.originalSize.width}),t.update_size_hint(n.originalSize.width,a),s.data("resize-row",u)}else{var f=i.get_class_num(s,i.grid.class),l=s.prevAll(".upfront-region:first"),h=s.nextAll(".upfront-region:first"),p=l.size()>0?i.get_class_num(l,i.grid.class):0,d=h.size()>0?i.get_class_num(h,i.grid.class):0,g=f+(d>p?d:p),y=Math.abs(Math.ceil(n.size.width/i.col_size)),b=y>g?g:y,w=Math.round(b*i.col_size);r.css({height:n.originalSize.height,width:w,minWidth:w,maxWidth:w,marginLeft:v=="w"?n.size.width-w:0}),t.update_size_hint(w,n.originalSize.height),s.data("resize-col",b)}else{var E=s.offset(),S=o.offset(),x=s.height(),T=s.width(),N=max_width=!1,C,k;m.is_top&&(N=v=="nw"||v=="ne"?m.top+x:!1),!m.is_top&&m.is_bottom&&(N=v=="se"||v=="sw"?m.bottom+x:!1),m.is_left&&(max_width=v=="nw"||v=="sw"?m.left+T:!1),!m.is_left&&m.is_right&&(max_width=v=="se"||v=="ne"?m.right+T:!1),k=Math.round(N&&n.size.height>N?N:n.size.height),C=Math.round(max_width&&n.size.width>max_width?max_width:n.size.width),r.css({height:k,width:C}),t.update_size_hint(C,k,r),s.data("resize-height",k),s.data("resize-width",C)}},stop:function(e,r){var o=Upfront.Settings.LayoutEditor.CurrentBreakpoint,u,a;i.resizing=!1,s.css({width:"",minWidth:"",maxWidth:"",height:"",position:"",top:"",left:"",right:"",bottom:""});if(c!="fixed"){var f=s.data("resize-col"),l=s.data("resize-row");if(!o||o.default)f&&n.set_property("col",f),l&&n.set_property("row",l);else if(f||l)u=Upfront.Util.clone(n.get_property_value_by_name("breakpoint")||{}),_.isObject(u[o.id])||(u[o.id]={}),a=u[o.id],a.edited=!0,f&&(a.col=f),l&&(a.row=l),n.set_property("breakpoint",u);s.removeData("resize-col"),s.removeData("resize-row")}else{var h=s.data("resize-width"),p=s.data("resize-height"),f=Math.floor(h/i.col_size);(v=="nw"||v=="ne")&&m.is_top&&n.set_property("top",m.top+m.height-p),(v=="se"||v=="sw")&&!m.is_top&&m.is_bottom&&n.set_property("bottom",m.bottom+m.height-p),(v=="nw"||v=="sw")&&m.is_left&&n.set_property("left",m.left+m.width-h),(v=="se"||v=="ne")&&!m.is_left&&m.is_right&&n.set_property("right",m.right+m.width-h),n.set_property("width",h,!0),n.set_property("height",p,!0),n.set_property("col",f,!0),n.get("properties").trigger("change"),s.removeData("resize-width"),s.removeData("resize-height")}Upfront.Events.trigger("entity:region:resize_stop",t,t.model)}})},create_region_draggable:function(t,n){if(!n.get("container")||n.get("container")==n.get("name"))return;var r=this,i=Upfront.Behaviors.GridEditor,s=t.$el,o=e(Upfront.Settings.LayoutEditor.Selectors.main),u=o.find(".upfront-layout"),a=t.parent_view.get_container_view(n),f=n.get("sub"),l={},c=!1,h=function(){var e={top:n.get_property_value_by_name("top"),left:n.get_property_value_by_name("left"),bottom:n.get_property_value_by_name("bottom"),right:n.get_property_value_by_name("right"),width:n.get_property_value_by_name("width"),height:n.get_property_value_by_name("height")};return e.is_top=typeof e.top=="number",e.is_left=typeof e.left=="number",e.is_bottom=typeof e.bottom=="number",e.is_right=typeof e.right=="number",e},p={},d="";if(f!="fixed")return!1;if(s.data("ui-draggable"))return!1;s.draggable({disabled:!0,revert:!0,revertDuration:0,zIndex:100,helper:"clone",delay:15,scroll:!1,iframeFix:!0,start:function(e,t){var r=t.helper,i=s.width(),o=s.height();r.css("width",i),r.css("height",o),s.hide(),l=h(),c=n.get("restrict_to_container"),d=r.css("position")},drag:function(n,r){var i=r.helper,s=o.offset(),u=o.width(),f=a.$el.offset(),l=a.$el.height(),c=f.top+l,h=e(window).scrollTop(),v=e(window).height(),m=h+v,g=u/2+s.left,y=d=="fixed"||l>v?v/2:l/2,b=r.position.left,w=r.position.top,E=i.width(),S=i.height(),x=E/2+b,T=S/2+w,N,C,k,L;p={},d=="absolute"&&l>v&&c<=m&&(y=l-v/2),T<=y?(d=="fixed"||l<v||c>=m?N=0:N=l-v,k=w<N?N:w,p.top=k-N):(d=="fixed"||l>v&&f.top>=h?N=v-S:N=l-S,k=w>N?N:w,p.bottom=N-k),x<=g?(C=s.left,L=b<C?C:b,p.left=L-C):(C=u-E+s.left,L=b>C?C:b,p.right=C-L),t.update_position_hint(p,i),r.position.top=k,r.position.left=L},stop:function(e,t){s.show(),typeof p.top=="number"?(n.set_property("top",p.top,!0),n.remove_property("bottom",!0)):typeof p.bottom=="number"&&(n.set_property("bottom",p.bottom,!0),n.remove_property("top",!0)),typeof p.left=="number"?(n.set_property("left",p.left,!0),n.remove_property("right",!0)):typeof p.right=="number"&&(n.set_property("right",p.right,!0),n.remove_property("left",!0)),n.get("properties").trigger("change")}})},create_region_container_resizable:function(t,n){var r=this,i=Upfront.Behaviors.GridEditor,s=t.$el,o=e(Upfront.Settings.LayoutEditor.Selectors.main),u=n.get("sub"),a="s",f={},l=o.find(".upfront-layout");if(s.data("ui-resizable"))return!1;!n.is_main()&&u=="bottom"&&(a="n"),s.append('<div class="upfront-icon-control-region upfront-icon-control-region-resize upfront-icon-control-region-resize-'+a+" upfront-region-resize-handle upfront-region-resize-handle-"+a+" ui-resizable-handle ui-resizable-"+a+'"></div>'),f[a]=".upfront-region-resize-handle-"+a,s.resizable({containment:"document",handles:f,helper:"region-resizable-helper",disabled:!0,zIndex:9999999,start:function(e,n){Upfront.Events.trigger("entity:region_container:resize_start",t,t.model),Upfront.Events.trigger("command:region:edit_toggle",!1),i._prepare_resize_auto_scroll(n,l.find("> .upfront-regions"))},resize:function(r,o){var u=o.helper,a=(o.size.height>15?o.size.height:0)||o.originalSize.height,f=Math.ceil(a/i.baseline),l=e(this).data("ui-resizable");u.css({width:s.width(),height:f*i.baseline}),s.data("resize-row",f);var c=Upfront.data.region_views[n.cid];c&&c.update_size_hint(c.$el.width(),f*i.baseline),_.each(t.sub_model,function(e){var t=Upfront.data.region_views[e.cid];t&&(t.$el.hasClass("upfront-region-side-left")||t.$el.hasClass("upfront-region-side-right"))&&t.update_size_hint(t.$el.width(),f*i.baseline)}),i._start_resize_auto_scroll(r,o,a,l)},stop:function(e,r){var o=Upfront.Settings.LayoutEditor.CurrentBreakpoint,u=s.data("resize-row"),a,f;s.css({width:"",minHeight:"",height:"",maxHeight:"",position:"",top:"",left:""}),i._clear_resize_auto_scroll(),!o||o.default?n.set_property("row",u):(a=Upfront.Util.clone(n.get_property_value_by_name("breakpoint")||{}),_.isObject(a[o.id])||(a[o.id]={}),f=a[o.id],f.edited=!0,f.row=u,n.set_property("breakpoint",a)),s.removeData("resize-row"),Upfront.Events.trigger("entity:region_container:resize_stop",t,t.model),Upfront.Events.trigger("command:region:edit_toggle",!0),i.resizing=!1}})},_auto_scroll_t:!1,_auto_scroll_data:{},_auto_scroll_step:3,_auto_scroll_timeout:100,_prepare_resize_auto_scroll:function(t,n){var r=e(document).height(),i=e('<div class="upfront-auto-scroller"></div>');i.css({width:1,height:0,visibility:"hidden"}).appendTo(n?n:"body"),this._auto_scroll_data={document_height:r,position_top:t.originalPosition.top,position_height:t.originalSize.height,position_rest:r-(t.originalPosition.top+t.originalSize.height),$scroller:i}},_start_resize_auto_scroll:function(t,n,r,i){var s=this,o=e(window).height(),u=Math.abs(o-t.clientY),a=r-this._auto_scroll_data.position_height,f=a-this._auto_scroll_data.position_rest,l=0,c=this._auto_scroll_step*this.baseline,h=n.helper;clearTimeout(this._auto_scroll_t);if(u>50)return;this._auto_scroll_t=setTimeout(function(){l+=c,f+l>0&&s._auto_scroll_data.$scroller.height(f+l+u),i.size.height=r+l,i.parentData.height=e(document).height(),h.css("height",i.size.height),e(window).scrollTop(e(window).scrollTop()+c),i._trigger("resize",t,n)},this._auto_scroll_timeout)},_clear_resize_auto_scroll:function(){this._auto_scroll_data.$scroller.remove(),clearTimeout(this._auto_scroll_t)},toggle_region_resizable:function(t){var n=e(Upfront.Settings.LayoutEditor.Selectors.main),r;t?(n.hasClass("upfront-region-fixed-editing")?r=e(".upfront-region-side-fixed"):r=e(".upfront-region-center, .upfront-region-side-left, .upfront-region-side-right, .upfront-region-container-wide, .upfront-region-container-clip, .upfront-region-sub-container"),r.each(function(){e(this).data("ui-resizable")&&e(this).resizable("option","disabled",!1)})):e(".upfront-region, .upfront-region-container").each(function(){e(this).data("ui-resizable")&&e(this).resizable("option","disabled",!0)})},toggle_region_draggable:function(t){var n=e(Upfront.Settings.LayoutEditor.Selectors.main),r;t?(n.hasClass("upfront-region-fixed-editing")?r=e(".upfront-region-side-fixed"):r=e(".upfront-region-side-left, .upfront-region-side-right, .upfront-region-container-wide, .upfront-region-container-clip"),r.each(function(){e(this).data("ui-draggable")&&e(this).draggable("option","disabled",!1)})):e(".upfront-region, .upfront-region-container").each(function(){e(this).data("ui-draggable")&&e(this).draggable("option","disabled",!0)})},edit_structure:function(){var t=Upfront.Behaviors.GridEditor,n=Upfront.Application,r=Upfront.Settings.LayoutEditor.Grid,i=e('<div class="upfront-edit-grid-wrap clearfix" />'),s=e('<div class="upfront-edit-grid upfront-edit-grid-recommended" />'),o=e('<div class="upfront-edit-grid upfront-edit-grid-custom" />'),u=e('<div class="upfront-edit-page-color" />'),a=e('<div class="upfront-grid-width-preview">Grid width: <span class="upfront-grid-width" /></div>'),f=e('<div class="upfront-grid-width-preview">( Grid width: <span class="upfront-grid-width" /> )</div>'),l=r.column_width!=r.column_widths[r.size_name]||r.type_padding!=r.type_paddings[r.size_name]||r.baseline!=r.baselines[r.size_name]||!/^(0|5|10|15)$/.test(r.column_padding),c=function(){var e=p.grid.get_value()=="custom",n={column_width:e?p.custom_width.get_value():r.column_widths[r.size_name],column_padding:e?p.custom_padding.get_value():p.recommended_padding.get_value(),baseline:e?p.custom_baseline.get_value():r.baselines[r.size_name],type_padding:e?p.custom_type_padding.get_value():r.type_paddings[r.size_name]},i=n.column_width*r.size;a.find(".upfront-grid-width").text(i+"px"),f.find(".upfront-grid-width").text(i+"px"),t.update_grid(n)},h=new Upfront.Views.Editor.Command_ToggleGrid,p={structure:new Upfront.Views.Editor.Field.Radios({label:Upfront.Settings.l10n.global.behaviors.structure,layout:"vertical",default_value:n.layout.get("layout_slug")||"blank",icon_class:"upfront-structure-field-icon",values:[{label:"",value:"blank",icon:"blank"},{label:"",value:"wide",icon:"wide-no-sidebar"},{label:"",value:"wide-right-sidebar",icon:"wide-right-sidebar"},{label:"",value:"wide-left-sidebar",icon:"wide-left-sidebar"},{label:"",value:"clip",icon:"clip-no-sidebar"},{label:"",value:"clip-right-sidebar",icon:"clip-right-sidebar"},{label:"",value:"clip-left-sidebar",icon:"clip-left-sidebar"},{label:"",value:"full",icon:"full"},{label:"",value:"full-extended",icon:"full-extended"}],change:function(){if(Upfront.themeExporter.currentTheme==="upfront"){var e=p.structure.get_value(),t=n.layout.get("layout_slug");if(t&&t!=e||!t&&e!="blank")n.layout.set("layout_slug",e),Upfront.Application.get_gridstate()&&h.on_click(),n.create_layout(_upfront_post_data.layout,{layout_slug:e}),Upfront.Events.once("layout:render",function(){Upfront.Application.get_gridstate()||h.on_click()})}}}),grid:new Upfront.Views.Editor.Field.Radios({label:Upfront.Settings.l10n.global.behaviors.grid_settings,layout:"horizontal-inline",default_value:l?"custom":"recommended",values:[{label:Upfront.Settings.l10n.global.behaviors.recommended_settings,value:"recommended"},{label:Upfront.Settings.l10n.global.behaviors.custom_settings,value:"custom"}],change:function(){var e=this.get_value();e=="custom"?(o.show(),s.hide()):(s.show(),o.hide()),c()}}),recommended_padding:new Upfront.Views.Editor.Field.Select({default_value:r.column_padding,values:[{label:Upfront.Settings.l10n.global.behaviors.padding_large,value:"15"},{label:Upfront.Settings.l10n.global.behaviors.padding_medium,value:"10"},{label:Upfront.Settings.l10n.global.behaviors.padding_small,value:"5"},{label:Upfront.Settings.l10n.global.behaviors.no_padding,value:"0"}],change:c}),bg_color:new Upfront.Views.Editor.Field.Color({model:n.layout,label:Upfront.Settings.l10n.global.behaviors.page_bg_color,label_style:"inline",property:"background_color",spectrum:{move:function(e){var t=e.toRgb(),r="rgba("+t.r+","+t.g+","+t.b+","+e.alpha+")";n.layout.set_property("background_color",r)}}}),custom_width:new Upfront.Views.Editor.Field.Number({label:Upfront.Settings.l10n.global.behaviors.column_width,label_style:"inline",min:40,max:100,default_value:r.column_width,change:c}),custom_padding:new Upfront.Views.Editor.Field.Number({label:Upfront.Settings.l10n.global.behaviors.column_padding,label_style:"inline",min:0,max:100,default_value:r.column_padding,change:c}),custom_baseline:new Upfront.Views.Editor.Field.Number({label:Upfront.Settings.l10n.global.behaviors.baseline_grid,label_style:"inline",min:5,max:100,default_value:r.baseline,change:c}),custom_type_padding:new Upfront.Views.Editor.Field.Number({label:Upfront.Settings.l10n.global.behaviors.additional_type_padding,label_style:"inline",min:0,max:100,default_value:r.type_padding,change:c}),floated:new Upfront.Views.Editor.Field.Checkboxes({multiple:!1,default_value:!0,values:[{label:Upfront.Settings.l10n.global.behaviors.allow_floats_outside_main_grid,value:!0}]})};t.structure_modal||(t.structure_modal=new Upfront.Views.Editor.Modal({to:e("body"),button:!0,top:120,width:540}),t.structure_modal.render(),e("body").append(t.structure_modal.el)),Upfront.Application.get_gridstate()||h.on_click(),t.structure_modal.open(function(e,t){t.addClass("upfront-structure-modal"),_.each(p,function(e){e.render(),e.delegateEvents()}),e.html(""),Upfront.themeExporter.currentTheme==="upfront"&&e.append(p.structure.el),e.append(p.grid.el),s.append(p.recommended_padding.el),s.append(a),i.append(s),o.append(p.custom_width.el),o.append(f),o.append(p.custom_padding.el),o.append(p.custom_baseline.el),o.append(p.custom_type_padding.el),u.append(p.bg_color.el),i.append(o),i.append(u),e.append(i),e.append(p.floated.el),p.grid.trigger("changed")},t).always(function(){Upfront.Application.get_gridstate()&&h.on_click()})},update_grid:function(t){var n=Upfront.Application,r=[],i=Upfront.Settings.LayoutEditor.Grid,s="#page",o=n.layout.get_property_value_by_name("grid")||{column_widths:{},column_paddings:{},baselines:{},type_paddings:{}},u=Upfront.Settings.LayoutEditor.CurrentBreakpoint||Upfront.Settings.LayoutEditor.Grid.size_name,a=Upfront.Views.breakpoints_storage.get_breakpoints().findWhere({id:_.isObject(u)?u.id:u}),f=!1;t.column_width&&(o.column_widths[i.size_name]=t.column_width,a.get_property_value_by_name("column_width")!=t.column_width&&(a.set_property("column_width",t.column_width),f=!0)),"column_padding"in t&&(o.column_paddings[i.size_name]=t.column_padding,a.get_property_value_by_name("column_padding")!=t.column_padding&&(a.set_property("column_padding",t.column_padding),f=!0)),t.baseline&&(t.baseline!=i.baseline&&(clearTimeout(this._load_editor_css),this._load_editor_css=setTimeout(function(){Upfront.Util.post({action:"upfront_load_editor_grid",baseline:t.baseline},"text").success(function(t){e("#upfront-editor-grid-inline").length?e("#upfront-editor-grid-inline").html(t):e("head").append('<style id="upfront-editor-grid-inline">'+t+"</style>")})},1e3)),o.baselines[i.size_name]=t.baseline,a.get_property_value_by_name("baseline")!=t.baseline&&(a.set_property("baseline",t.baseline),f=!0)),t.type_padding&&(o.type_paddings[i.size_name]=t.type_padding,a.get_property_value_by_name("type_padding")!=t.type_padding&&(a.set_property("type_padding",t.type_padding),f=!0)),Upfront.Settings.LayoutEditor.Grid=_.extend(i,t),n.layout.set_property("grid",o),n.layout_view.update_grid_css(),this.init(),f&&Upfront.Application.get_current()==Upfront.Settings.Application.MODE.THEME&&a.trigger("change:enabled",a)},apply_grid:function(){var e=Upfront.Behaviors.GridEditor,t=Upfront.Application,n=Upfront.Settings.LayoutEditor.Grid,r=t.layout.get_property_value_by_name("grid");if(!r||!r.column_widths||!r.column_widths[n.size_name])return;return e.update_grid({column_width:r.column_widths[n.size_name],column_padding:r.column_paddings[n.size_name],baseline:r.baselines[n.size_name],type_padding:r.type_paddings[n.size_name]})},time_start:function(e){this.show_debug_element&&console.time(e)},time_end:function(e){this.show_debug_element&&console.timeEnd(e)},set_timeout:function(e){this.timeout=e},set_compare_size:function(e,t){this.compare_col=e,this.compare_row=t},toggle_debug:function(){this.show_debug_element=!this.show_debug_element,this.show_debug_element?this.render_debug():this.delete_debug()},render_debug:function(){var t=this,n=e(Upfront.Settings.LayoutEditor.Selectors.main);$modal=e('<div id="behavior-debug" class="upfront-inline-modal"></div>'),$wrap=e('<div class="upfront-inline-modal-wrap"></div>'),field_delay=new Upfront.Views.Editor.Field.Number({name:"delay",label:Upfront.Settings.l10n.global.behaviors.delay_before_drag,label_style:"inline",min:0,max:2e3,step:1,default_value:300,change:function(){e(".upfront-module.ui-draggable, .upfront-module-group.ui-draggable, .upfront-object.ui-draggable").draggable("option","delay",this.get_value())}}),field_timeout=new Upfront.Views.Editor.Field.Number({name:"timeout",label:Upfront.Settings.l10n.global.behaviors.delay_before_changing_position,label_style:"inline",min:0,max:2e3,step:1,default_value:t.timeout,change:function(){t.timeout=parseInt(this.get_value())}}),field_debug=new Upfront.Views.Editor.Field.Checkboxes({name:"debug",multiple:!1,default_value:!0,values:[{label:Upfront.Settings.l10n.global.behaviors.show_debug_info,value:!0}],change:function(){t.show_debug_element=this.get_value()?!0:!1}}),$close=e('<a href="#" class="upfront-close-debug">'+Upfront.Settings.l10n.global.behaviors.close+"</a>"),n.addClass("show-debug"),field_delay.render(),$wrap.append(field_delay.$el),field_timeout.render(),$wrap.append(field_timeout.$el),field_debug.render(),$wrap.append(field_debug.$el),$wrap.append($close),$modal.append($wrap),e("body").append($modal),$modal.css({top:"auto",left:"auto",bottom:0,right:0,position:"fixed"}),$wrap.css({width:360,top:0,padding:"10px",position:"relative"}),$close.on("click",function(){t.show_debug_element=!1,t.delete_debug()})},delete_debug:function(){var t=e(Upfront.Settings.LayoutEditor.Selectors.main);t.removeClass("show-debug"),e("#behavior-debug").remove()}};return r})})(jQuery);